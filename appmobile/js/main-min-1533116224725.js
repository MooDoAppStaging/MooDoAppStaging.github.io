!function(e){function t(t){for(var a,r,o=t[0],l=t[1],d=t[2],c=0,h=[];c<o.length;c++)r=o[c],n[r]&&h.push(n[r][0]),n[r]=0;for(a in l)Object.prototype.hasOwnProperty.call(l,a)&&(e[a]=l[a]);for(u&&u(t);h.length;)h.shift()();return s.push.apply(s,d||[]),i()}function i(){for(var e,t=0;t<s.length;t++){for(var i=s[t],a=!0,o=1;o<i.length;o++){var l=i[o];0!==n[l]&&(a=!1)}a&&(s.splice(t--,1),e=r(r.s=i[0]))}return e}var a={},n={0:0},s=[];function r(t){if(a[t])return a[t].exports;var i=a[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.e=function(e){var t=[],i=n[e];if(0!==i)if(i)t.push(i[2]);else{var a=new Promise(function(t,a){i=n[e]=[t,a]});t.push(i[2]=a);var s,o=document.getElementsByTagName("head")[0],l=document.createElement("script");l.charset="utf-8",l.timeout=120,r.nc&&l.setAttribute("nonce",r.nc),l.src=function(e){return r.p+""+({1:"delayedUI"}[e]||e)+"-1533116224725.js"}(e),s=function(t){l.onerror=l.onload=null,clearTimeout(d);var i=n[e];if(0!==i){if(i){var a=t&&("load"===t.type?"missing":t.type),s=t&&t.target&&t.target.src,r=new Error("Loading chunk "+e+" failed.\n("+a+": "+s+")");r.type=a,r.request=s,i[1](r)}n[e]=void 0}};var d=setTimeout(function(){s({type:"timeout",target:l})},12e4);l.onerror=l.onload=s,o.appendChild(l)}return Promise.all(t)},r.m=e,r.c=a,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(i,a,function(t){return e[t]}.bind(null,a));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="js/",r.oe=function(e){throw console.error(e),e};var o=window.webpackJsonp=window.webpackJsonp||[],l=o.push.bind(o);o.push=t,o=o.slice();for(var d=0;d<o.length;d++)t(o[d]);var u=l;s.push([78,2]),i()}([function(e,t,i){"use strict";i.r(t);var a=i(5),n=i(4),s=i(1),r=i(47);function o(e){this.str=(e||"").toString(),this.operatorCurrent="",this.operatorExpecting="",this.node=null,this.escaped=!1,this.list=[],this.operators={'"':'"',"(":")","<":">",",":"",":":";",";":""}}function l(){}o.prototype={tokenize:function(){for(var e,t=0,i=[],a=0,n=this.str.length;a<n;a++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;e=this.str.charAt(a),this.checkChar(e)}return this.list.forEach(function(e){e.value=(e.value||"").toString().trim(),e.value&&i.push(e)}),i},checkChar:function(e){if((e in this.operators||"\\"===e)&&this.escaped)this.escaped=!1;else{if(this.operatorExpecting&&e===this.operatorExpecting)return this.node={type:"operator",value:e},this.list.push(this.node),this.node=null,this.operatorExpecting="",void(this.escaped=!1);if(!this.operatorExpecting&&e in this.operators)return this.node={type:"operator",value:e},this.list.push(this.node),this.node=null,this.operatorExpecting=this.operators[e],void(this.escaped=!1)}this.escaped||"\\"!==e?(this.node||(this.node={type:"text",value:""},this.list.push(this.node)),this.escaped&&"\\"!==e&&(this.node.value+="\\"),this.node.value+=e,this.escaped=!1):this.escaped=!0}},l.prototype={_handleAddress:function(e){var t,i,a,n,s=0,r=!1,o="text",l=[],d={address:[],comment:[],group:[],text:[]};for(a=0,n=e.length;a<n;a++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;if("operator"===(t=e[a]).type)switch(t.value){case"<":o="address";break;case"(":o="comment";break;case":":o="group",r=!0;break;default:o="text"}else t.value&&("address"===o&&(t.value=t.value.replace(/^[^<]*<\s*/,"")),d[o].push(t.value))}if(!d.text.length&&d.comment.length&&(d.text=d.comment,d.comment=[]),r)d.text=d.text.join(" "),l.push({name:d.text||i&&i.name,group:d.group.length?this.parse(d.group.join(",")):[]});else{if(!d.address.length&&d.text.length){var u=0;for(a=d.text.length-1;a>=0;a--){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;if(d.text[a].match(/^[^@\s]+@[^@\s]+$/)){d.address=d.text.splice(a,1);break}}var c=function(e){return d.address.length?e:(d.address=[e.trim()]," ")};if(!d.address.length){var h=0;for(a=d.text.length-1;a>=0;a--){if(h++>5e3&&__infLoop&&__infLoop(h))throw new RangeError;if(d.text[a]=d.text[a].replace(/\s*\b[^@\s]+@[^\s]+\b\s*/,c).trim(),d.address.length)break}}}if(!d.text.length&&d.comment.length&&(d.text=d.comment,d.comment=[]),d.address.length>1&&(d.text=d.text.concat(d.address.splice(1))),d.text=d.text.join(" "),d.address=d.address.join(" "),!d.address&&r)return[];(i={address:d.address||d.text||"",name:d.text||d.address||""}).address===i.name&&((i.address||"").match(/@/)?i.name="":i.address=""),l.push(i)}return l},parse:function(e){var t=this,i=0,a=[],n=[],s=[];new o(e).tokenize().forEach(function(e){"operator"!==e.type||","!==e.value&&";"!==e.value?n.push(e):(n.length&&a.push(n),n=[])}),n.length&&a.push(n),a.forEach(function(e){var i=t._handleAddress(e);i.length&&(s=s.concat(i))});for(var r=[],l=0;l<s.length;++l){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;r.push({type:"contact",text:s[l].name||s[l].address,email:s[l].address})}return r}};var d=new l,u=i(8),c=i(46),h=i.n(c),f=i(13),p=i(71),g=(i(75),"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e});t.default=function(){var e={vmMain:void 0,isShowingLogin:new u.a(!1),topBarHeight:n.a.android?56:44,archivedPadding:34,itemTransitionTime:100,iOSDragTime:400,iOSDragTimeKeyboardOpen:200,scrollbarWidth:12,hasFocus:!0,zoomTime:0,demoMode:!1,intro:void 0,focusedPane:void 0,focusedItem:void 0,ClickThreshold:5,isFirstRun:!1,isReconnected:!1,isBlocked:!1,blockedMessage:"",authImmediateFailed:!1,authUserLoggedIn:!1,noLocalWrites:!1,noLocalWritesReason:s.a.LocalWriteReason.Enabled,isLoadingRemote:!1,isSendingEmail:!1,isSavingDrafts:!1,isKeyboardOpen:!1,itemMenuOpenedOn:void 0,errorPlatformInfo:void 0,nativeBacklog:[],nativeBridge:{sendToApp:function(t,i){e.nativeBacklog.push({method:t,data:i})}},elements:{},SPThresholdLeft:8,SPThresholdRight:42,MobileSideTapThreshold:40,MobileSideTapThresholdKeyboardOpen:15,colorBlue:"#09d",colorLightBlue:"#02b1ff",colorRed:"#d43",colorLightRed:"#f34433",MinItemWidth:50};e.paneTop=e.topBarHeight,e.overviewPaddingStart=32,e.overviewPaddingIncrement=18,window.ScrollDuration={Snap:0,Default:200,Slow:500},window.ButtonCode={None:-1,Left:0,Middle:1,Right:2},window.Direction={Up:-1,None:0,Down:1},window.TextSpace="\ufeff",window.AttachChar=" ",window.EmbedAttachChar=" ",window.DriveStatus={Offline:0,Connecting:1,Saving:2,Saved:3,Reconnecting:4},window.PaneMode={Task:"PaneTask",Archived:"PaneArchived",Drive:"PaneDrive",Gmail:"PaneGmail"},window.MessageAction={Default:0,Reload:1,LoginScreen:2,Demo:3,ResetClient:4,None:5,SyncContacts:6,OpenURL:7,Okay:8,Blog:9,Undo:10,Contact:11,OpenSettings:12,OpenAccountSettings:13,OpenGoogleDrive:14,OpenDisplaySettings:15,StartDemo:16,OpenLinkedSettings:17,OpenGeneralSettings:18,OpenCalendarSettings:19},window.MessageType={Info:0,Warning:1,Error:2,Fatal:3,Subtitle:4,Intro:5,RequiredUpdate:6,InfoGray:7},window.MessageID={Undefined:0,ConnectionError:1,OfflineUndo:2,FatalError:3,DocChange:4,OfflineWarn:5,OnlineInfo:6,CacheReset:7,RequiredUpdate:8,Updated:9,SyncContacts:10,ExitDemo:11,Reauthorize:12,ShareFailure:13,ThisIsDemo:14,MailbirdClick:15,InviteFailure:16,InviteSuccess:17,PremiumRequired:18,TrialOver:19,TrialEndSoon:20,DisabledFolderDrop:21,WarnLargeFile:22,InviteInvalid:23,NoSharingWarning:24,LostPermission:25,CalendarSync:26,EmailSendFail:28,EmailUpdateFail:29,EmailLabelFail:30,EmailSyncFail:31,OldUserNewTrial:32,DemoPluginClick:33,PromptScriptStart:34,SnoozeOffline:35,NeedDrivePermission:36,NeedGmailPermission:37,LostLinked:38,GmailDisabled:39,LocalWritesDisabled:40,MissingOffline:41,MissingOfflineMobile:42,FlatSearchMultiSelect:43,FlatSearchEnter:44,FlatSearchTab:45,ReadOnlyCalendar:46,CalendarSaveFail:47,QuotaError:48,ReselectEmail:49,ReactError:50},window.VMLIFlag={None:0,Header:1,Collapsed:2,Selected:4,Highlighted:8,NumList:16,Note:32,Multiline:64,Archived:128,Complete:4096,P2:8192,P1:16384,P0:32768,Starred:65536,HasPageToken:131072,DisplayComplete:262144},window.UninitializedVersion=-1,window.VersionType={Structure:1,Text:2},window.SaveFlag={None:0,Prop:1,Text:2,All:3},window.RepeatFreq={Once:0,Daily:1,Weekly:2,Monthly:3,DayOfMonth:4,Yearly:5,EndOfMonthOffset:6,NthMonthInst:7},window.DateType={Once:1,Repeat:2},window.ChangeType={None:0,Local:1,Remote:2,Auto:4,Structure:33554432,Text:67108864,Property:134217728,Rollover:1048576,UndoRedo:2097152,PluginLoad:4194304,ItemLoad:8388608,DocLoad:65536,Locations:7,All:234881024,AllLocal:234881025,AllRemote:234881026,Valid:250675207},window.StorageType={InMemory:1,LocalStorage:2,IndexedDB:3},window.LoginState={NONE:0,LOGGED_OUT:1,LOGGED_IN:2},window.ReturnValue={Success:0,Error:1,FatalError:2},window.OAuthSchemeType={Invalid:-1,None:0,Web:1,Native:2,Count:2},window.ACProvider={None:0,Contact:1,DatePicker:2,DateList:3,Tag:4,Search:5},window.DataSource={Paste:1,Drop:2,Plugin:3},window.PluginID={Moodo:"Moodo",Contacts:"Contacts",Drive:"Drive",Mailbird:"Mailbird",Gmail:"Gmail",GCalendar:"GCalendar"},window.PluginSettingsID={},window.PluginLoad={None:0,Preview:1,Full:2,Runtime:4,Autocomplete:8,Inline:16},window.PluginDependency={DemoMode:"DemoMode",GoogleLogin:"GoogleLogin",PremiumSub:"PremiumSub",EarlyAccess:"EarlyAccess",LocalLoaded:"LocalLoaded"},window.PluginRenderTypes={Generic:0,StyledText:1,UnstyledText:2,Measure:3},window.PluginRenderers={Unknown:-1,DriveFile:0,EmailThread:1,CalendarEvent:2},window.Modals={ReportBug:"reportBug",ImportData:"importData",ExportData:"exportData",RevisionHistory:"revisionHistory",ShareDoc:"shareDoc",MobileSettings:"mobileSettings",Settings:"settings",Confirm:"confirm",Alert:"alert",Options:"options",Billing:"billing",DeleteAccount:"deleteAccount",EmailPreview:"emailPreview",ReportProblem:"reportProblem",Welcome:"welcome",EmailCompose:"emailCompose",EmailReply:"emailReply",Invoices:"invoices",Prompt:"prompt",Lightbox:"lightbox",EnterCode:"enterCode"},window.PremiumStatus={Unknown:0,Never:1,Trial:2,TrialOver:3,Active:4,PastDue:5,CanceledUser:6,CanceledPastDue:7},window.DataChangeType={Add:1,Remove:2,Change:3},window.SearchResultStatus={Done:1,TooMany:2,None:3,Error:4},window.Settings={theme:"theme",syncContacts:"syncContacts",lastContactSync:"lastContactSync",lastTaskSync:"lastTaskSync",lastQuickAddSync:"lastQuickAddSync",disableNotifications:"disableNotifications",notificationDelay:"notificationTime",rootFolderId:"rootFolderId",attachFolderId:"attachFolderId",backupFolderId:"backupFolderId",authScopes:"authScopes",localIntegrity:"localIntegrity",localDataVersion:"localDataVersion",localRecoverVersion:"localRecoverVersion",shownTutorial:"shownTutorial",gdocId:"gdocId",gdocTitle:"gdocTitle",activeUser:"activeUser",userId:"userId",displayName:"displayName",lastServerVersion:"lastServerVersion",helpPaneState:"helpPaneState",closedImport:"closedImport",closedHelps:"closedHelps",oauthScheme:"oauthScheme",premiumStatus:"zzp",enableOfflineAuth:"enableOfflineAuth",trialStart:"pzs",trialDuration:"pzd",trialExtended:"pze",premiumEndDate:"ped",notifiedTrialOver:"notifiedTrialOver",notifiedTrialEndSoon:"notifiedTrialEndSoon",inTooltipIntro:"inTooltipIntro",keyboardToolbarScroll:"keyboardToolbarScroll",defaultItemPrefix:"defaultItemPrefix",showMarkdown:"showMarkdown",calendarCustomDays:"calendarCustomDays",showBullets:"showBullets",selectFullItems:"selectFullItems",showFormattingToolbar:"showFormattingToolbar",showImagesInline:"showImagesInline",dayWeekStart:"dayWeekStart",trialOverHidden:"trialOverHidden",bulletOpacity:"bulletOpacity",projectOpacity:"projectOpacity",checkboxOpacity:"checkboxOpacity",checkboxBackgroundOpacity:"checkboxBackgroundOpacity",showVerticalLines:"showVerticalLines",verticalLinesOpacity:"verticalLinesOpacity",boldHeaders:"boldHeaders",itemPadding:"itemPadding",notePadding:"notePadding",itemLineHeight:"itemLineHeight",noteLineHeight:"noteLineHeight",itemIndentSize:"itemIndentSize",fontSize:"fontSize",fontSizeHeader:"fontSizeHeader",fontSizeHeaderTopLevel:"fontSizeHeaderTopLevel",noteFontSize:"noteFontSize",tagColor:"tagColor",dateColor:"dateColor",contactColor:"contactColor",linkColor:"linkColor",underlineP:"underlineP",displaySpacing:"displaySpacing",displayPrefixes:"displayPrefixes",grayscale:"grayscale",helpState:"helpState",localPaneState:"localPaneState",workspaces:"workspaces",selectedWorkspace:"selectedWorkspace",paneHistoryMobile:"paneHistoryMobile",cacheSizeRatio:"cacheSizeRatio",monthlyInvoice:"monthlyInvoice",invoiceEmail:"invoiceEmail",invoiceCompany:"invoiceCompany",invoiceAddress:"invoiceAddress",isUnsubscribed:"isUnsubscribed",showSidebar:"showSidebar",sidebarWidth:"sidebarWidth",openEvernoteApp:"openEvernoteApp",closedVideo:"closedVideo",agendaSort:"agendaSort",dateFormat:"dateFormat",lastBackup:"lastBackup",needsBackup:"needsBackup",backupFrequency:"backupFrequency"},window.__TEXT_CHANGED_UPDATES={NoUpdate:0,PaneSkipped:0,CausedUpdate:0},e.inMaskOnly=function(e,t){return 0==(~t&e)},e.isFlagSet=function(e,t){return(e&t)===t},e.isOneFlagSet=function(e,t){var i=e&t;return 0!==i&&0==(i&i-1)},e.isAtLeastOneFlagSet=function(e,t){return 0!=(e&t)},e.forEachFlagSet=function(e,t){for(var i=0;0!==e;){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;t(Math.abs(e&-e)),e&=e-1}},e.PCMask=VMLIFlag.P0|VMLIFlag.P1|VMLIFlag.P2|VMLIFlag.Complete,e.PMask=VMLIFlag.P0|VMLIFlag.P1|VMLIFlag.P2,e.fieldMapIn={isArchived:"a",dateCreated:"c",date:"d",duration:"e",formats:"f",durationText:"g",favorites:"h",items:"i",isNote:"k",modifiedOffline:"l",isCollapsed:"m",note:"n",modifiedOfflineText:"o",priority:"p",dateFormat:"q",repeatDate:"r",dateText:"s",text:"t",versionText:"u",version:"v",isDeleted:"x",isComplete:"z",archivedItems:"ai",allDayDate:"ad",id:"id",isStarred:"*",dateCompleted:"^"},e.priorityMapOut={},e.priorityMapOut[VMLIFlag.None]=" ",e.priorityMapOut[VMLIFlag.P0]=" p0",e.priorityMapOut[VMLIFlag.P1]=" p1",e.priorityMapOut[VMLIFlag.P2]=" p2";var t={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"};e.escape=function(e){return String(e).replace(/[&\"<>]/g,function(e){return t[e]})},e.unescape=function(i){return String(i).replace(/&lt;|&gt;|&amp;|&quot;/g,function(i){for(var a in t)if(t.hasOwnProperty(a)&&t[a]===i)return a;return e.Assert(!1,"Should have found a character to replace"),i})},e.escapeRegExp=function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},e.stripTagsBasic=function(e){return e.replace(/<.*>/g,"")},e.stripFormattingTags=function(e){return e.replace(/<\/?[biu]>/g,"")},e.trimPunc=function(e){return e.replace(/[:,\.\'\"\)\]]$/g,"")},e.getTransitionClass=function(e){var t;switch(e){case 50:t="trans05";break;case 100:t="trans1";break;case 200:t="trans2";break;case 300:t="trans3";break;case 400:t="trans4";break;case 500:t="trans5";break;case 1e3:t="trans10";break;default:console.log("ERROR: no time for ",e)}return t},e.setTransformStyle=function(t,i,a){e.Assert(t,"Must provide a valid element"),t&&(e.Assert(void 0!==i,"Must supply a valid X offset"),e.Assert(void 0!==a,"Must supply a valid Y offset"),n.a.ie?t.style[n.a.transform.style]="translate("+i+"px, "+a+"px)":t.style[n.a.transform.style]="translate3d("+i+"px, "+a+"px, 0px)")},e.setTransitionStyle=function(t,i,a,s){e.Assert(t,"Must provide a valid element"),t&&(s=s||"ease",t.style[n.a.transition.style]=i+" "+a+"ms "+s,setTimeout(function(){t.style[n.a.transition.style]=""},a))},e.setTransform=function(t,i,a,s,r){s>0?(e.setTransitionStyle(t,n.a.transform.prop,s,r),e.setTransformStyle(t,i,a)):i||a?e.setTransformStyle(t,i,a):t.style[n.a.transform.style]="none"},e.openMainPage=function(){e.isShowingLogin.set(!1)},e.openSetupPage=function(){e.isShowingLogin.set(!0)},e.wasAppCacheUpdated=!1;var i=!1;e.setAppCacheUpdateState=function(t){i=t,t&&(e.wasAppCacheUpdated=!0)},e.reload=function(t){e.Assert(!i,"Page should not be reloaded while waiting for an appcache update to finish."),i&&e.reportError(new Error("Page requesting reload while waiting for AppCache update.")),window.location.reload(t)},e.isEmpty=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},e.isEmail=function(e){var t=!1;return e&&(t=!!new RegExp(/\S+@\S+\.\S+/i).exec(e))&&(t=e.indexOf('"')<0),t},e.parseTokensFromText=function(e){for(var t,i=0,a=[],n=/(?:(?:[\"]([^\"<>]*)[\"]\s))|(?:([^\",<>]*)\s)<([^<>,\s]+@[^<>,\s]+\.[^<>,\s]+)>,?|(^|[\s,])<?([^<>,\s]+@[^<>,\s]+\.[^<>,\s]+)>?,?/g,s=0;null!==(t=n.exec(e));){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=e.substring(s,t.index),o=t[1]||t[2],l=t[3]||t[5];s=n.lastIndex,r&&r.trim().length>0&&a.push({text:r,type:"text"}),a.push({text:o||l,email:l,type:"contact"})}var d=e.substring(s,e.length);return d&&d.length>0&&a.push({text:d,type:"text"}),a},e.parseEmailAddresses=function(e){return d.parse(e)},e.isWhiteSpace=function(e){return/^\s*$/.test(e)},e.removeDOM=function(t){e.Assert(t,"Must specify a valid DOM id to remove");var i=document.getElementById(t);e.Assert(i,"DOM Element must exist to remove it"),i&&i.parentNode.removeChild(i)},e.isRunningScript=function(){return e.AScript&&e.AScript.isRunning};var o,l=!1;e.goOnline=function(){l=!1},e.goOffline=function(){l=!0},e.isOffline=function(){return l},e.preventLocalWrites=function(t){e.Assert(!e.noLocalWrites,"Should only disable local writes once"),e.Assert(t>=0,"Must provide a valid reason for disabling local writes"),e.isDemoMode()||ShouldLog(LogLevels.Warning)&&log("---- WARNING: Local Writes Disabled ----"),e.noLocalWrites=!0,e.noLocalWritesReason=t},e.shouldWriteLocal=function(){return!e.noLocalWrites},e.isLocalWriteReason=function(t){return e.noLocalWritesReason===t},e.enableDemoMode=function(){e.demoMode=!0;var t=a.a.getURLParam("dmode");t&&e.runOnLoad(function(){e.enableMinMode(t)}),e.preventLocalWrites(s.a.LocalWriteReason.DemoMode)},e.isDemoMode=function(){return e.demoMode},window.DisplayMode={Default:0,InIframe:1,NoPaneHeaders:2,Invisible:4,NoScrollbars:8,NoBackground:16,NoPaneTop:32,NoInteraction:64,NoPanePadding:128,NoPaneStyle:256,NoRightClick:512,ShowDemoExit:1024,NoMinPaneSize:2048,PromptStart:4096,FullMin:8191},e.activeDisplayMode=DisplayMode.Default,e.isDisplayModeActive=function(t){return(e.activeDisplayMode&t)===t},e.isDemoInIframe=function(){return this.isDisplayModeActive(DisplayMode.InIframe)},e.enableMinMode=function(t){try{if(e.addClass(document.body,"minMode"),e.isMinMode=!0,t=e.parseInt(t),n.a.touch||(t&DisplayMode.InIframe&&e.addClass(document.documentElement,"inIframe"),t&DisplayMode.Invisible&&e.addClass(document.documentElement,"invisible"),t&DisplayMode.NoPaneHeaders&&e.addClass(document.body,"noPaneHeaders"),t&DisplayMode.NoMinPaneSize&&(e.minPaneWidth=0),t&DisplayMode.NoPaneStyle&&e.addClass(document.body,"noPaneStyle")),t&DisplayMode.NoPanePadding&&(e.addClass(document.body,"noPanePadding"),e.noPanePadding=!0),t&DisplayMode.NoScrollbars&&(e.noScrollbars=!0),t&DisplayMode.NoBackground&&e.addClass(document.documentElement,"noBackground"),t&DisplayMode.NoInteraction){var i=document.getElementById("outerWrapper"),a=document.createElement("div");a.id="preventInteraction",i.appendChild(a),t&DisplayMode.PromptStart&&e.setupClick(a,a,function(){var t=e.toasts.getMessageById(MessageID.PromptScriptStart);t&&(t.doAction(),t.hide())})}t&DisplayMode.ShowDemoExit&&setTimeout(function(){e.toasts.pushMessage(MessageID.ExitDemo)},0),t&DisplayMode.PromptStart&&setTimeout(function(){e.toasts.pushMessage(MessageID.PromptScriptStart)},0),e.activeDisplayMode=t}catch(t){e.reportError(t)}},e.setDimension=function(t,i){window.ga&&!e.isDemoMode()&&ga("set",t,i)},e.sendEvent=function(t,i,a){if(e.Assert(void 0===a||e.isNumber(a),"Values must be numeric"),window.ga&&!e.isDemoMode())try{ga("send","event",t,i,e.getAnonUserIdentifier(),a)}catch(n){e.reportError(n,"Category: "+t+" Action: "+i+" Value: "+a)}},e.sendTimeEvent=function(t,i,a){if(e.Assert(e.isNumber(a),"Values must be numeric"),window.ga&&!e.isDemoMode())try{ga("send","timing",t,i,a,e.getAnonUserIdentifier())}catch(n){e.reportError(n,"Category: "+t+" Variable: "+i+" Value: "+a)}},e.startTimeEvent=function(t,i){window.log&&window.log.now&&(e.Assert(void 0===o,"This function needs to be updated to allow nested timing events"),o={startTime:log.now(),category:t,variable:i})},e.endTimeEvent=function(){if(window.log&&window.log.now&&(e.Assert(void 0!==o,"Must have started a timing event"),o)){var t=log.now()-o.startTime;e.sendTimeEvent(o.category,o.variable,t),o=void 0}};var c={};e.registerEvent=function(t,i,a){e.Assert(!c.hasOwnProperty(t),"Should only register an event once"),e.Assert(void 0!==t,"Must specify a name for the event"),e.Assert(void 0!==i,"Must specify a category for the event"),e.Assert(void 0!==a,"Must specify an action for the event");var n={category:i,action:a,label:e.getAnonUserIdentifier(),count:0};c[t]=n},e.aggregateEvent=function(t,i){e.Assert(c.hasOwnProperty(t),"Must register an event before using it"),void 0===i&&(i=1),c[t]&&(c[t].count+=i)},e.UIAction=function(t){e.sendEvent("UIAction",t)},e.getAggregateEvents=function(){return c};var m=976910954,v=0x6bf609b2d12c;e.reportAdConversion=function(t,i){try{!function(e,t){var i=new Image(1,1),a="//www.googleadservices.com/pagead/conversion/"+m+"/?label="+e+"&guid=ON";t&&(a+="&value="+t+"&currency_code=USD"),i.src=a}(t,i)}catch(t){e.reportError(t)}try{a=new Image(1,1),n="//www.facebook.com/tr?id="+v+"&ev=PageView",a.src=n}catch(t){e.reportError(t)}var a,n};var _=!1;e.pageDataCleared=function(){_=!0},e.hasPageDataBeenCleared=function(){return _};var y=LoginState.LOGGED_OUT;e.getLoginState=function(){var t=y;if(e.shouldWriteLocal())try{var i=a.a.storage.getItem("loginState");null!==i&&void 0!==i&&(t=e.parseInt(i))}catch(t){e.reportError(t)}return e.Assert(t===LoginState.NONE||t===LoginState.LOGGED_OUT||t===LoginState.LOGGED_IN,"Invalid login state set"),t},e.setLoginState=function(t){if(e.Assert(null!==t&&void 0!==t&&!isNaN(t),"Should always be a valid LoginState enum value"),y=t,e.shouldWriteLocal())try{(isNaN(t)||null===t||void 0===t)&&(t=LoginState.LOGGED_OUT),e.Assert(t===LoginState.NONE||t===LoginState.LOGGED_OUT||t===LoginState.LOGGED_IN,"Invalid login state set"),a.a.storage.setItem("loginState",t)}catch(t){e.reportError(t)}},"function"!=typeof String.prototype.startsWith&&(Object.defineProperty?Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(e,t){return t=t||0,this.lastIndexOf(e,t)===t}}):String.prototype.startsWith=function(e){return 0===this.lastIndexOf(e,0)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)}),"function"!=typeof String.prototype.prevIndexOf&&(String.prototype.prevIndexOf=function(e,t){for(var i=0,a=-1,n=t-1;n>=0;--n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(this[n]===e){a=n;break}}return a}),"function"!=typeof String.prototype.capitalize&&(String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)}),e.findFirstDiff=function(e,t,i,a){var n=0;if(!e)return a?0:t.length;if(!t)return a?e.length:0;for(var s=Math.min(e.length,t.length),r=0;r<s;++r){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(i){if(e.charAt(r).toLowerCase()!==t.charAt(r).toLowerCase())return r}else if(e.charAt(r)!==t.charAt(r))return r}return a?e.length:t.length},e.findMatchingLength=function(e,t,i){var a=0;if(!e||!t)return 0;for(var n=Math.min(e.length,t.length),s=0;s<n;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(i){if(e.charAt(s).toLowerCase()!==t.charAt(s).toLowerCase())return s}else if(e.charAt(s)!==t.charAt(s))return s}return n},e.lerp=function(e,t,i){return e+(t-e)*i},e.TEMP_PREFIX="~T^";var S,w=0;function I(e,t){var i,a,n,s,r,o,l,d,u=0;for(i=3&e.length,a=e.length-i,n=t,r=3432918353,o=461845907,d=0;d<a;){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;l=255&e.charCodeAt(d)|(255&e.charCodeAt(++d))<<8|(255&e.charCodeAt(++d))<<16|(255&e.charCodeAt(++d))<<24,++d,n=27492+(65535&(s=5*(65535&(n=(n^=l=(65535&(l=(l=(65535&l)*r+(((l>>>16)*r&65535)<<16)&4294967295)<<15|l>>>17))*o+(((l>>>16)*o&65535)<<16)&4294967295)<<13|n>>>19))+((5*(n>>>16)&65535)<<16)&4294967295))+((58964+(s>>>16)&65535)<<16)}switch(l=0,i){case 3:l^=(255&e.charCodeAt(d+2))<<16;case 2:l^=(255&e.charCodeAt(d+1))<<8;case 1:n^=l=(65535&(l=(l=(65535&(l^=255&e.charCodeAt(d)))*r+(((l>>>16)*r&65535)<<16)&4294967295)<<15|l>>>17))*o+(((l>>>16)*o&65535)<<16)&4294967295}return n^=e.length,n=2246822507*(65535&(n^=n>>>16))+((2246822507*(n>>>16)&65535)<<16)&4294967295,n=3266489909*(65535&(n^=n>>>13))+((3266489909*(n>>>16)&65535)<<16)&4294967295,(n^=n>>>16)>>>0}function b(e){switch(e){case KeyCode.Backspace:return"BACKSPACE";case KeyCode.Delete:return"DELETE";case KeyCode.Enter:return"ENTER";case KeyCode.Escape:return"ESCAPE";default:return"CHAR"}}e.generateTempId=function(){return e.TEMP_PREFIX+Date.now()+ ++w},e.isTempId=function(t){return t&&t[0]===e.TEMP_PREFIX[0]&&t[1]===e.TEMP_PREFIX[1]&&t[2]===e.TEMP_PREFIX[2]},e.isLocalItem=function(t){return e.Assert(t.id,"All items should have an ID even if it is a temp one"),e.isTempId(t.id)},e.requestNotification=function(t){var i=document.forms.requestNotification,a=document.getElementById("notificationResult"),n=i.email.value;return void 0===n||null===n||n.length<5?a.innerText="Please enter a valid email address.":e.XHR_PrivateAPI({type:"POST",path:"/feedback/notification",data:{email:n,platform:t},cb:function(e){200===e.status?(i.email.value="",a.innerText="Thanks for your interest!"):a.innerText="There was an error processing your request, please try again in a few minutes."}}),!1},e.getUserIdentifier=function(){return e.getActiveUser()||e.vmMain&&e.vmMain.getUserEmail()||"me"},e.setActiveUser=function(t){e.Assert(t,"Must provide an email"),e.Assert("me"!==t,'Active user must never be "me"'),"me"!==t&&e.settings.set(Settings.activeUser,t)},e.getActiveUser=function(){var t=e.settings.get(Settings.activeUser);return"me"!==t?t:void 0},e.hashCode=function(e){var t,i=0,a=0;if(0===e.length)return a;for(t=0;t<e.length;t++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;a=(a<<5)-a+e.charCodeAt(t),a|=0}return a},e.getAnonUserIdentifier=function(){if(!S){var t=e.getUserIdentifier();S=t[0]+t[1]+t[2]+I(t,17124123)}return S},e.hashString=function(t){return e.Assert(e.isString(t),"Must always be passing a string to hash"),I(t,129831293)},e.sanitizePaneState=function(e){try{for(var t=0,i=JSON.parse(JSON.stringify(e)),a=0;a<i.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;""!==i[a].search&&(i[a].search="HasSearch")}return JSON.stringify(i)}catch(e){return"Failed to sanitize pane state"}},e.sanitizeLocalSettings=function(e){try{var t=JSON.parse(e);delete t.values.Default.paneState,delete t.values.Default.localPaneState,delete t.values.Default.gdocTitle;var i=t.values.Default.workspaces;return i&&(i=JSON.parse(i))&&Object.keys(i).forEach(function(e){i[e].workspaces.forEach(function(e){delete e.name,e.panes.forEach(function(e){delete e.name})})}),t}catch(e){return"Failed to parse settings"}},e.sanitizeURL=function(e){return e.replace(/&?access_token=[^&]*/g,"")},e.getLoadedScripts=function(e){try{for(var t=0,i=document.getElementsByTagName("script"),a=[],n=0;n<i.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=i[n];s.src&&a.push(s.src)}e.loadedScripts=a}catch(t){e.loadedScripts="ERROR: "+t.message}},e.reportSignup=function(t,i,a){e.Assert(t,"Must specify a valid email address to signup with"),e.Assert(i,"Must provide valid signup info in addition to an email address"),t&&i&&(e.sendEvent("Subscribe","NewUser"),i.email=t,function(e){e.platformConfig=n.a.getUserPlatformConfig()}(i),e.XHR_PrivateAPI({type:"POST",path:"/tracking/signup",data:i,requireAuth:!0,cb:function(e){200!==e.status?(ShouldLog(LogLevels.Error)&&log("Failed to report signup",e.responseText,e),a&&a(!1)):a&&a(!0)}}),e.reportAdConversion(s.a.ConversionID.Signup))};var A=!1;e.criticalErrorReported=function(){return A},e.handleCriticalError=function(){A=!0;try{if(e.isDemoMode())e.reload();else{var t=document.createElement("div");t.id="criticalError",t.textContent="There was a critical error while loading the app, "+n.a.actionVerb()+" to reload.",n.a.isTouchDevice?t.addEventListener(n.a.touchStartEvent,function(){e.reload()},!0):t.addEventListener(n.a.upEvent,function(){e.reload()},!0),e.prependChild(document.body,t),e.removeDOM("outerWrapper")}}catch(t){e.reportError(t)}},e.hasOnlineBlockingError=function(){return e.isBlocked||navigator.onLine&&e.failedGapiLoad&&!window.gapiCalled||window.gapiTimeout&&!window.gapiCalled},e.hasCookieBlockingError=function(){return e.authImmediateFailed&&e.vmSetup&&e.vmSetup.getPageLoadLoginState()===LoginState.LOGGED_IN},e.safeStringify=function(e){try{return JSON.stringify(e)}catch(e){}},e.reportEvent=function(t){if(!e.isDemoMode()){var i=e.parseExtra(t);i&&e.eventStream.push(i)}},e.getEventStream=function(){return e.eventStream.ordered()},window.__getEventStream=e.getEventStream,e.parseExtra=function(t){var i;if(t)try{var a;if(t instanceof window.KeyboardEvent){var n=e.elementToString(t.target);["[INPUT#importPW]","[INPUT#importEmail]","[TEXTAREA#bugDescription.bugDescription editable]"].indexOf(n)<0&&(a={type:t.type,currentTarget:e.elementToString(t.currentTarget),target:n,keyCode:b(t.keyCode),normCode:b(t.normCode),ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,metaKey:t.metaKey,altKey:t.altKey,tstamp:Date.now()})}else if(t instanceof window.MouseEvent)a={type:t.type,currentTarget:e.elementToString(t.currentTarget),relatedTarget:e.elementToString(t.relatedTarget),target:e.elementToString(t.target),clientX:t.clientX,clientY:t.clientY,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,metaKey:t.metaKey,altKey:t.altKey,which:t.which,button:t.button,tstamp:Date.now()};else if(window.TouchEvent&&t instanceof window.TouchEvent){a={type:t.type,currentTarget:e.elementToString(t.currentTarget),relatedTarget:e.elementToString(t.relatedTarget),target:e.elementToString(t.target),tstamp:Date.now()};var s=t.touches[0];s&&(a.clientX=s.clientX,a.clientY=s.clientY)}else if(window.PointerEvent&&t instanceof window.PointerEvent)a={type:t.type,currentTarget:e.elementToString(t.currentTarget),relatedTarget:e.elementToString(t.relatedTarget),target:e.elementToString(t.target),clientX:t.clientX,clientY:t.clientY,tstamp:Date.now()};else if(t instanceof window.Event)a={type:t.type,name:t.name,code:t.code,message:t.message,currentTarget:e.elementToString(t.currentTarget),relatedTarget:e.elementToString(t.relatedTarget),target:e.elementToString(t.target),tstamp:Date.now()};else if(t instanceof window.Selection)if(0===t.rangeCount)a={rangeCount:0};else{var r=t.getRangeAt(0),o=r.startContainer,l=!1,d=r.endContainer,u=!1;o.nodeType===Node.TEXT_NODE&&(o=o.parentNode,l=!0),d.nodeType===Node.TEXT_NODE&&(d=d.parentNode,u=!0),a={rangeCount:t.rangeCount,startContainer:e.getElementPath(o),startWasTextNode:l,startOffset:r.startOffset,endContainer:e.getElementPath(d),endWasTextNode:u,endOffset:r.endOffset}}else a=t;i=a?e.safeStringify(a):void 0}catch(e){log("Error parsing extra "+e.message)}return i},window.__jsVersion="1533116224725",window.__devServerURL="##DEV_SERVER_URL##";var D=["http://a.visadd.com/script/layer","https://gc.kis.v2.scr.kaspersky-labs.com"];e.rollbarIgnoreFn=function(e,t,i){return!!(i&&i.body&&i.body.trace&&i.body.trace.frames&&i.body.trace.frames[0]&&D.indexOf(i.body.trace.frames[0].filename)>=0)},window.__MAX_ERRORS_REPORTED=50;var T=0,M=!1,C=!1,L={};function P(){var t=e.settings.get(Settings.activeUser);return t?"MooDoRDebug"+(new Date).getTime()+"_"+t:"Unknown"}e.handleJSError=function(t,i,a,n,s){if(n||window.__error("JS Error: "+t,"  Stack: ",i,"  Extra: ",a),t||i){s||(s=LogLevels.Error);try{var r=L[i];if(!r||r<Date.now()-5e3){var o=window.__LOG_BUFFER.ordered().join("\r\n"),l=e.getUserIdentifier();C||("me"!==l&&(C=!0),Rollbar.configure({payload:{person:{id:l}},maxItems:__MAX_ERRORS_REPORTED,checkIgnore:e.rollbarIgnoreFn}));var d=e.parseExtra(a);if(++T<=window.__MAX_ERRORS_REPORTED){var u={};if(!M){if(M=!0,e.vmMain)try{e.vmMain.getAppInfo(u)}catch(e){Rollbar.error(e)}M=!1}u.numReported=T;var c={url:e.sanitizeURL(window.location.href),logs:o,info:u,user:l,extra:d,jsVersion:window.__jsVersion,htmlVersion:document&&document.body?document.body.getAttribute("ver"):"UNKNOWN"};if(window.Rollbar){var h={message:t,stack:i};s===LogLevels.Error?(Rollbar.error(h,c),e.sendEvent("ErrorReport","Error")):s===LogLevels.Warning?(Rollbar.warning(h,c),e.sendEvent("ErrorReport","Warning")):(Rollbar.error(h,c),e.sendEvent("ErrorReport","Unknown"))}else c.msg=t,c.stack=i,e.XHR_PrivateAPI({type:"POST",path:"/feedback/error",data:c,cb:function(e){200!==e.status?log("Failed to report remote error",e.responseText,e):log("Reported Remote Error: ",e.responseText)}})}}L[i]=Date.now()}catch(e){log("Badness happened reporting errors to server: ",e);try{Rollbar.error({message:t,stack:i}),Rollbar.error(e)}catch(e){log("More badness happened reporting errors to rollbar: ",e)}}}},window.onerror=function(t,i,a,n,s){s?(log("Reported Global OnError: "+t+" Script: "+i+" Line: "+a+" Column: "+n),e.reportError(s)):(log("Unreported Global OnError: "+t+" Script: "+i+" Line: "+a+" Column: "+n),e.reportError(t))},e.reportError=function(t,i,a,n){!t||i||t.message||t.stack?t&&t.e&&e.isString(t.e)&&(t={message:t.e,stack:e.getCurrentStack("")}):(i=t,t=void 0),t||(t={message:"Undefined error passed to reporter",stack:e.getCurrentStack("")}),e.handleJSError((n||"")+t.message,t.stack,i,!1,a)},window.__SendInfo=function(t){return e.handleJSError("Remote Client Info",void 0,t,!0),"Thank you for providing your client info!"},window.__CreateDebugSession=function(t){if(window.remote)return"Debug session already started";var i=t||P();window.rcon=window.console,e.handleJSError("Remote Debug Session",void 0,i,!0),e.addScript("http://jsconsole.com/remote.js?"+i,"rDebugScript");var a=!1,n=0,s="";return window.rdbg={startProfile:function(e){try{return a?"Profiler already running":(s=e||"RDBGProfile_"+n,window.rcon.profile(s),a=!0,"Profiler Started: "+s)}catch(e){return"Error starting profile: "+e.message}},stopProfile:function(){try{if(a){window.rcon.profileEnd(s),a=!1;var e="Profile Completed: "+s;return s="",n++,e}return"Profiler not running, use startProfile()"}catch(e){return"Error stopping profile: "+e.message}}},"Your remote debug session has started: "+i},(a.a.hasURLParam("rsession")||a.a.hasURLParam("rdebug","true"))&&setTimeout(function(){var e=a.a.getURLParam("rsession")||P();window.__CreateDebugSession(e),log("%c---- REMOTE DEBUGGING ENABLED: "+e+" ----","color: green")},2e3),window.Checkpoint={MainRun:1,RequireLoaded:2,PageLoad:4,LocalDocLoad:8,InitData:16,DBLoaded:32,OnInitializedData:64,InitializeMain:128,LoadDefaultFile:256,DocLoadRequested:512,DocLoaded:1024,MaskRequired:2047},e.checkpoint=function(e){window.__checkpoints|=e},e.hasSentLowMemoryWarning=!1,e.handleLowMemory=function(t){e.hasSentLowMemoryWarning||(e.hasSentLowMemoryWarning=!0,log("Low Memory Event: ",t),e.isNumber(t)&&(t=Math.round(t/1024/1024)+"MB"))};var E=/function\s+([^(]*?)\s*\(([^)]*)\)/,k=!0;e.getCurrentStack=function(e){var t;if(k||n.a.noErrorStacks)try{t=JSON.stringify(e)}catch(i){log("Error stringifying stack message",i,e)}if(k){var i=new Error(t||e);if(i.stack)return i.stack}k=!1;try{for(var a=0,s=["GenError: "+(t||e)],r=arguments.callee.caller,o=0;r&&o++<75;){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var l,d=r.toString(),u=E.exec(d);l=u&&3===u.length&&""!==u[1]&&void 0!==u[1]?"at "+u[1]+"("+u[2].replace(/[\r\n]/g,"")+")":u&&3===u.length?"at <anonymous> ("+u[2].replace(/[\r\n]/g,"")+")":"at <anonymous> (<unknown>)",s.push(l),r=r.caller}return s.join("\n")}catch(e){log("Error generating stack trace",e)}return""};var x,R=0;function O(t,i){return function(){try{return t.apply(this,arguments)}catch(t){e.reportError(t),i&&i(t)}}}function F(t){return e.Assert(t,"Must specify a callback"),function(){try{if(t)return t.apply(void 0,arguments)}catch(t){e.reportError(t,arguments)}}}if(e.checkForRemoteChanges=function(){var t=Date.now();if(R-t>=12e5)try{e.AppCache&&e.AppCache.checkForUpdate(),e.vmMain&&e.vmMain.vmPicker&&e.vmMain.vmPicker.refreshFiles()}catch(t){e.reportError(t)}finally{R=t}},e.protectFn=O,(x=function(e){var t=window[e];window[e]=function(){var e=Array.prototype.slice.call(arguments),i=e[0];return"function"==typeof i&&(e[0]=O(i)),t.apply?t.apply(this,e):t(e[0],e[1])}})("setTimeout"),x("setInterval"),function(){window.__LOG_BUFFER=new r.a(30);var t=window.log;e.isDemoMode()||(window.log=function(){try{window.__LOG_BUFFER.push(Date.now()+": "+Array.prototype.join.call(arguments," "))}catch(e){window.__LOG_BUFFER.push(Date.now()+": Invalid Log Arguments")}console.log.apply(console,arguments)},window.__log=function(){try{window.__LOG_BUFFER.push(Date.now()+": "+Array.prototype.join.call(arguments," "))}catch(e){window.__LOG_BUFFER.push(Date.now()+": Invalid Log Arguments")}});try{window.console.error=function(){try{var t=arguments[0],i=arguments[1];2===arguments.length&&e.isString(t)&&e.isString(i)?e.reportError({message:t,stack:i}):window.__error.apply(window,arguments)}catch(t){window.__error.apply(window,arguments),e.reportError(t)}}}catch(t){e.reportError(t),log("Unable to override console.error")}for(var i in t)t.hasOwnProperty(i)&&(window.log[i]=t[i])}(),e.getObjectInfo=function(t){try{if(t&&t.constructor)return t.constructor.name}catch(t){e.reportError(t)}return void 0===t?"undefined":g(t)},e.packedFnToString=function(e){for(var t=0,i="",a=0;a<e.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;i+=e[a]+"."}return i},e.unpackFn=function(t,i){e.Assert(e.isFunction(t)||e.isArray(t),"Must supply either a valid function or packed function");var a=NaN;if(e.isFunction(t))a=t;else if(t)try{var n=0;a=i||window;for(var s=0;s<t.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(e.Assert(e.isString(t[s]),"Packed fns must only contain strings: "+s),e.Assert(a,"Must be able to unpack each step in object chain: "+t[s]+" in "+e.packedFnToString(t)),!a){a=NaN;break}a=a[t[s]]}}catch(t){e.reportError(t),a=NaN}return a},e.isFunction=function(e){return!!(e&&e.constructor&&e.call&&e.apply)},e.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},e.isString=function(e){return"string"==typeof e},e.isObject=function(t){return"object"===(void 0===t?"undefined":g(t))&&null!==t&&!e.isArray(t)},e.isNumber=function(e){return"number"==typeof e&&!isNaN(e)},e.isBoolean=function(e){return!0===e||!1===e},e.isAnything=function(){return!0},e.isValidColor=function(t){return e.isString(t)&&null!==/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.exec(t)},e.parseInt=function(e){return parseInt(e,10)},e.parseBoolean=function(e){return!0===e||"true"===e},e.parseDate=function(t){var i=new Date(t);return e.isDateValid(i)?i:void 0},e.isValidChangeType=function(t){if(void 0!==t&&null!==t){var i=t&~ChangeType.All;if(e.inMaskOnly(t,ChangeType.Valid))return(i&ChangeType.Locations)===ChangeType.None||e.isOneFlagSet(i,ChangeType.Local|ChangeType.Remote|ChangeType.Auto)}return!1},e.isRemoteChange=function(t){e.Assert(e.isValidChangeType(t),"Must supply a valid changeType");var i=t&~ChangeType.All;return e.isValidChangeType(t)&&e.isFlagSet(i,ChangeType.Remote)},e.isUndoRedoChange=function(t){e.Assert(e.isValidChangeType(t),"Must supply a valid changeType");var i=t&~ChangeType.All;return e.isValidChangeType(t)&&e.isFlagSet(i,ChangeType.UndoRedo)},e.isLocalChange=function(t){e.Assert(e.isValidChangeType(t),"Must supply a valid changeType");var i=t&~ChangeType.All;return e.isValidChangeType(t)&&e.isFlagSet(i,ChangeType.Local)},e.isAutoChange=function(t){e.Assert(e.isValidChangeType(t),"Must supply a valid changeType");var i=t&~ChangeType.All;return e.isValidChangeType(t)&&e.isFlagSet(i,ChangeType.Auto)},e.changeToString=function(t){e.Assert(void 0!==t,"Must supply a valid changeType");var i=[];return e.forEachFlagSet(t,function(e){switch(e){case ChangeType.Local:i.push("Local");break;case ChangeType.Remote:i.push("Remote");break;case ChangeType.Auto:i.push("Auto");break;case ChangeType.Structure:i.push("Structure");break;case ChangeType.Text:i.push("Text");break;case ChangeType.Property:i.push("Property");break;case ChangeType.Rollover:i.push("Rollover");break;case ChangeType.DocLoad:i.push("DocLoad");break;case ChangeType.ItemLoad:i.push("ItemLoad");break;case ChangeType.UndoRedo:i.push("UndoRedo");break;case ChangeType.PluginLoad:i.push("PluginLoad");break;default:i.push("Unknown:"+e)}}),"[ "+(0===i.length?"None":i.join(" "))+" ]"},e.isDOMNode=function(e){return window.HTMLElement?e instanceof HTMLElement:e&&e.tagName&&e.nodeType===Node.ELEMENT_NODE},e.isTextNode=function(e){return e&&e.nodeType===Node.TEXT_NODE},e.ensureDOMNode=function(t){var i;return e.isDOMNode(t)?i=t:e.isTextNode(t)&&(i=t.parentElement),i},e.enumToString=function(e,t){for(var i in e)if(e[i]===t)return i;return null},e.elementToString=function(e,t){if(e){var i=e.nodeName;return e.id&&(i+="#"+e.id),e.className&&(i+="."+e.className.replace(/ /g,".")),t&&e.innerText&&(i+=":"+e.innerText.length),i}return"UNDEFINED"},e.getElementPath=function(t,i){var a=!0,n="";try{for(var s=0;t&&"container"!==t.id&&t!==document.documentElement&&t!==document.body;){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;n+=a?e.elementToString(t,i)+" ":e.elementToString(t)+" ",a=!1,t=t.nodeType===Node.TEXT_NODE?t.parentNode:t.parentElement}}catch(e){n+=e.message}return n},e.setupClick=function(t,i,a){e.Assert(t,"Expecting an object to bind the click handlers to."),e.Assert(i,"Must specify a valid owner for click handlers"),i||(i=t);var r=!1;function o(t,n){return e.Assert(!i.isDestroyed||!i.isDestroyed()||"onMove"===t||"onEnd"===t,"Owner must not be destroyed to handle a click"),a[t].call(i,n)}function l(t){var i=t.eventX-this.lastX,n=t.eventY-this.lastY;if(0!==i||0!==n){var s=!this.moved;this.lastX=t.eventX,this.lastY=t.eventY,t.distanceX=this.distanceX=this.distanceX+Math.abs(i),t.distanceY=this.distanceY=this.distanceY+Math.abs(n),(this.moved||t.distanceX>e.ClickThreshold||t.distanceY>e.ClickThreshold)&&(this.moved=!0,t.moved=this.moved),(a.onMove||a.onFirstMove)&&(t.diffX=t.eventX-this.startX,t.diffY=t.eventY-this.startY,t.xThisFrame=i,t.yThisFrame=n,t.startX=this.startX,t.startY=this.startY,t.startClientX=this.startClientX,t.startClientY=this.startClientY,t.startSrc=this.startSrc,s&&a.onFirstMove&&o("onFirstMove",t),a.onMove&&o("onMove",t)&&t.stopImmediatePropagation())}}function d(e){var t=Date.now(),i=this.lastTouch||t,r=Math.max(0,t-i);this.numClicks?this.numClicks++:this.numClicks=1,e.moved=this.moved,e.timeDelta=r,e.diffX=this.lastX-this.startX,e.diffY=this.lastY-this.startY,e.startX=this.startX,e.startY=this.startY,e.startSrc=this.startSrc,this.startSrc=void 0,r<s.a.DoubleClickTime&&r>0&&a.onDoubleClick&&!this.moved&&o("onDoubleClick",e),isNaN(e.button)||e.button===ButtonCode.Left?(this.lastTouch=t,!a.onClick||this.moved||n.a.mac&&e.ctrlKey||o("onClick",e),a.onEnd&&o("onEnd",e)):e.button===ButtonCode.Middle&&a.onMiddleClick&&!this.moved&&o("onMiddleClick",e),setTimeout(function(){this.lastTouch=void 0,this.numClicks=void 0}.bind(this),s.a.DoubleClickTime)}function u(e){e.timeStart=this.timeStart=Date.now(),this.startSrc=e.target,e.startSrc=e.target,this.moved=!1,e.startX=this.startX=e.eventX,e.startY=this.startY=e.eventY,e.startClientX=this.startClientX=e.clientX,e.startClientY=this.startClientY=e.clientY,this.lastX=e.eventX,this.lastY=e.eventY,this.distanceX=0,this.distanceY=0,(isNaN(e.button)||e.button===ButtonCode.Left||e.button===ButtonCode.Right)&&((isNaN(e.button)||e.button===ButtonCode.Left)&&a.onStart?o("onStart",e):e.button===ButtonCode.Right&&a.onRightStart&&o("onRightStart",e)),isNaN(e.changeLastY)||(this.lastY+=e.changeLastY)}e.isFunction(a)?a={onClick:a}:a&&a.useCapture&&(r=a.useCapture);var c=F(function(i){if(!i.handled){e.lastInputTouch=!0;var a=n.a.ie?i:i.touches[0];return i.eventX=a.pageX,i.eventY=a.pageY,i.clientX=a.clientX,i.clientY=a.clientY,u.call(t,i),i.ignore||(document.addEventListener(n.a.touchMoveEvent,h,r),document.addEventListener(n.a.touchEndEvent,f,r),document.addEventListener(n.a.touchCancelEvent,p,r)),!i.returnFalse&&void 0}}),h=F(function(e){var i=n.a.ie?e:e.touches[0];if(e.eventX=i.pageX,e.eventY=i.pageY,e.clientX=i.clientX,e.clientY=i.clientY,l.call(t,e),e.returnFalse)return!1}),f=F(function(e){document.removeEventListener(n.a.touchMoveEvent,h,r),document.removeEventListener(n.a.touchEndEvent,f,r),document.removeEventListener(n.a.touchCancelEvent,p,r);var i=n.a.ie?e:e.changedTouches[0];if(e.eventX=i.pageX,e.eventY=i.pageY,e.clientX=i.clientX,e.clientY=i.clientY,d.call(t,e),e.returnFalse)return!1}),p=F(function(e){if(document.removeEventListener(n.a.touchMoveEvent,h,r),document.removeEventListener(n.a.touchEndEvent,f,r),document.removeEventListener(n.a.touchCancelEvent,p,r),function(e){a.onCancel&&o("onCancel",e)}.call(t,e),e.returnFalse)return!1}),g=F(function(i){if(!i.handled&&!e.lastInputTouch)return e.lastInputTouch=!1,i.eventX=i.pageX,i.eventY=i.pageY,u.call(t,i),i.ignore||(i.button===ButtonCode.Left&&document.addEventListener(n.a.moveEvent,m,r),document.addEventListener(n.a.upEvent,v,r)),!i.returnFalse&&void 0}),m=F(function(i){if(!e.lastInputTouch)return i.eventX=i.pageX,i.eventY=i.pageY,l.call(t,i),!i.returnFalse&&void 0}),v=F(function(i){if(!i.handled&&!e.lastInputTouch)return document.removeEventListener(n.a.moveEvent,m,r),document.removeEventListener(n.a.upEvent,v,r),i.button===ButtonCode.Left&&d.call(t,i),!i.returnFalse&&void 0});return F(function(t){t.handled||e.lastInputTouch||a.onRightClick&&o("onRightClick",t)}),n.a.isTouchDevice&&n.a.isMobileBrowser?t.addEventListener(n.a.touchStartEvent,c,r):t.addEventListener(n.a.downEvent,g,r),n.a.usePointerEvents&&t.addEventListener("mousedown",function(e){return e.preventDefault(),e.stopImmediatePropagation(),!1},r),a.onRightClick,this},"function"!=typeof Array.prototype.pushOnlyUniques&&(Array.prototype.pushOnlyUniques=function(e,t){var i=0;if(!e)return this;for(var a=0,n=e.length;a<n;++a){var s=0;if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;for(var r=!0,o=0,l=this.length;o<l;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;if(t&&t(e[a],this[o])||!t&&e[a]===this[o]){r=!1;break}}r&&this.push(e[a])}return this}),"function"!=typeof Array.prototype.pushUnique&&(Array.prototype.pushUnique=function(e){return this.indexOf(e)<0&&this.push(e),this.length}),"function"!=typeof Array.prototype.pushArray&&(Array.prototype.pushArray=function(t){return e.Assert(e.isArray(t),"Must only supply array to pushArray"),this.push.apply(this,t)}),"function"!=typeof Array.prototype.removeArray&&(Array.prototype.removeArray=function(t){return e.Assert(e.isArray(t),"Must only supply array to removeArray"),this.filter(function(e){return!t||t.indexOf(e)<0})}),"function"!=typeof Array.prototype.removeAt&&(Array.prototype.removeAt=function(e){return this.splice(e,1)[0]}),"function"!=typeof Array.prototype.remove&&(Array.prototype.remove=function(e,t){var i=this.indexOf(e,t);return i>=0&&this.removeAt.call(this,i),i}),"function"!=typeof Array.prototype.equals){var N=function(e,t){return e&&t&&"object"===(void 0===e?"undefined":g(e))&&"object"===(void 0===t?"undefined":g(t))?Object.keys(e).length===Object.keys(t).length&&Object.keys(e).reduce(function(i,a){return i&&e[a]===t[a]},!0):e===t};Array.prototype.equals=function(e){var t=0;if(!e)return!1;if(this.length!==e.length)return!1;for(var i=0,a=this.length;i<a;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(this[i]instanceof Array&&e[i]instanceof Array){if(!this[i].equals(e[i]))return!1}else if(this[i]!==e[i]&&!N(this[i],e[i]))return!1}return!0}}function B(t,i){if(e.Assert(!1===t.isLoaded,"Must not be loading the same API multiple times"),i&&i.error){if(2===t.numRetries)for(var a=0,n=0;n<t.timeoutCBs.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;try{t.timeoutCBs[n]()}catch(t){e.reportError(t)}}t.numRetries++,t.lastTimeout=le[t.numRetries]||3e3,t.timer=setTimeout(function(){t.timer=void 0,window.gapi.client.load(t.api,t.version,B.bind(window,t))},1e3*t.lastTimeout)}else{var s=0;for(n=0;n<t.successCBs.length;++n){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;try{t.successCBs[n]()}catch(t){e.reportError(t)}}t.successCBs=[],t.timeoutCBs=[],t.isLoaded=!0}}"function"!=typeof Array.prototype.indexOfWithProperty&&(Array.prototype.indexOfWithProperty=function(e,t){for(var i=0,a=0;a<this.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(this[a][e]===t)return a}return-1}),"function"!=typeof Array.prototype.findInsertIndex&&(Array.prototype.findInsertIndex=function(t,i){var a=0;e.Assert(void 0!==t&&null!==t,"Require a valid element to insert"),e.Assert(i,"Require a valid comparison function");for(var n=0,s=this.length-1;n<=s;){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var r=n+s>>1,o=i(this[r],t);if(o<0)n=r+1;else{if(!(o>0))return r;s=r-1}}return n}),e.toLowerCase=function(e){return e.toLowerCase()},e.numberComparator=function(e,t){return e-t},"function"!=typeof Array.prototype.findSorted&&(Array.prototype.findSorted=function(e,t){var i=this.findInsertIndex(e,t);if(0===t(this[i],e))return this[i]}),"function"!=typeof Array.prototype.insertSorted&&(Array.prototype.insertSorted=function(e,t){var i=this.findInsertIndex(e,t);return this.splice.apply(this,[i,0,e]),i}),e.insertIntoText=function(t,i,a){return e.Assert(a<=t.length),t.substr(0,a)+i+t.substr(a,t.length-a)},e.arrayUnion=function(e,t){for(var i=0,a=0,n=[],s=0;s<e.length;s++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;n.indexOf(e[s])<0&&n.push(e[s])}for(s=0;s<t.length;s++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;n.indexOf(t[s])<0&&n.push(t[s])}return n},e.arrayDiff=function(e,t){for(var i=0,a=0,n=[],s=0;s<e.length;s++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;t.indexOf(e[s])<0&&n.push(e[s])}for(s=0;s<t.length;s++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;e.indexOf(t[s])<0&&n.push(t[s])}return n},e.arrayIntersection=function(e,t){for(var i=0,a=[],n=0;n<e.length;n++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;t.indexOf(e[n])>=0&&a.push(e[n])}return a},e.arrayUniques=function(e,t){e=e||[];var i=[];if(t){var a=0;for(l=0;l<e.length;++l){var n=0;if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=!0,r=e[l];for(d=0;d<i.length;++d){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(t(r,i[d])){s=!1;break}}s&&i.push(r)}}else for(var o=0,l=0,d=e.length;l<d;l++){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;i.indexOf(e[l])<0&&i.push(e[l])}return i},e.mergeObjects=function(t,i){var a=Array.isArray(i),n=a&&[]||{};return a?(t=t||[],n=n.concat(t),i.forEach(function(i,a){void 0===n[a]?n[a]=i:"object"===(void 0===i?"undefined":g(i))?n[a]=e.mergeObjects(t[a],i):-1===t.indexOf(i)&&n.push(i)})):(t&&"object"===(void 0===t?"undefined":g(t))&&Object.keys(t).forEach(function(e){n[e]=t[e]}),Object.keys(i).forEach(function(a){"object"===g(i[a])&&i[a]&&t[a]?n[a]=e.mergeObjects(t[a],i[a]):n[a]=i[a]})),n};var U={};function V(e,t,i){e.onloadDone=!1,e.onload=function(){e.onloadDone=!0,t&&t()},e.onreadystatechange=function(){"loaded"!==e.readyState||e.onloadDone||(e.onloadDone=!0,t&&t())},i&&(e.onerror=i)}e.loadGoogleAPI=function(t,i,a,n){if(e.Assert(t,"Must supply a valid API name"),e.Assert(i,"Must supply a valid API version"),e.Assert(a,"Must supply a valid cb"),window.gapi&&window.gapi.client){var s=U[t];s?(e.Assert(s.version===i,"Must only load a single version of an API"),s.isLoaded?a():(s.successCBs.push(a),n&&s.timeoutCBs.push(n))):(U[t]=s={api:t,version:i,isLoaded:!1,numRetries:0,lastTimeout:0,timer:void 0,successCBs:[a],timeoutCBs:[]},n&&s.timeoutCBs.push(n),window.gapi.client.load(t,i,B.bind(window,s)))}else e.addCustomEventListener("gapiLoaded",function s(){e.Assert(window.gapi&&window.gapi.client,"Must have properly loaded the gapi client lib"),e.removeCustomEventListener("gapiLoaded",s),e.loadGoogleAPI(t,i,a,n)})},e.setupGoogleAPIListener=function(){window.addEventListener("online",function(){for(var e in U){var t=U[e];!t.isLoaded&&t.timer&&(clearTimeout(t.timer),t.timer=setTimeout(function(){window.gapi.client.load(t.api,t.version,B.bind(window,t))},1e3*le[1]))}})},e.getGoogleAPIStats=function(){var e={};if(window.gapi&&window.gapi.client)for(var t in U){var i=U[t],a={api:i.api,version:i.version,isLoaded:i.isLoaded,numRetries:i.numRetries,lastTimeout:i.lastTimeout,hasTimeout:!!i.timer};if(i.isLoaded)try{a.isAccessible=!!window.gapi.client[t]}catch(e){a.isAccessible=!1}else a.isAccessible=!1;e[t]=a}else e.error="GAPI Client not loaded";return e},e.clamp=function(e,t,i){return Math.max(t,Math.min(i,e))},e.pad2=function(e){return 1===(e=""+e).length?"0"+e:""+e},e.randParam=function(){return"?t="+Date.now()},e.createPath=function(e){return window.location.protocol+"//"+window.location.host+"/"+e},e.addScript=function(t,i,a,n){e.Assert(!i||null===document.getElementById(i),"Should never include the same script ID multiple times");var s=document.createElement("script");s.src=t,i&&(s.id=i),a&&V(s,a,n),e.Assert(void 0!==s,"Should always be able to create a valid script object"),void 0!==s&&document.getElementsByTagName("head")[0].appendChild(s)},e.addScriptHack=function(t,i,a,n){window.define||(window.define={}),e.addScript(t,i,function(){window.define.amd={jQuery:!0},a&&a()},function(){window.define.amd={jQuery:!0},n&&n()})},e.addStylesheet=function(e,t,i){var a=document.createElement("link");a.type="text/css",a.rel="stylesheet",a.href=e,t&&V(a,t,i),void 0!==a&&document.getElementsByTagName("head")[0].appendChild(a)},e.reportGapiScriptError=function(t,i){log("Failed to load GAPI!",i),e.failedGapiLoad=!0,e.blockedMessage="An extension has blocked apis.google.com from loading.",e.vmMain?e.vmMain.handleGapiLoadError():f.a.listen("VMMainLoaded",function(){e.vmMain.handleGapiLoadError()})},e.reportGapiScriptLoad=function(e,t){},e.DAssert=function(){},e.PAssert=function(t,i){if(!i){var a={isAssert:!0,tag:t};try{var n=function(t){for(var i=0,a="",n=0;n<t.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;a+=" "+e.safeStringify(t[n])}return a}(Array.prototype.slice.call(arguments,2).map(function(t){return e.isFunction(t)?t():t}));arguments.length>2?log("Assert Failure "+t+": "+n):log("Assert Failure "+t),e.reportError(new Error("Assert Failure: "+n),a,LogLevels.Warning)}catch(i){log("Exception in PAssert "+t+": ",i),e.reportError(i,a)}}},e.getElementParent=function(t){for(var i=0;t;){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(e.hasClass(t,"item")||e.hasClass(t,"paneHiddenInput"))return t;t=t.parentNode}};var H=0;function q(t,i){if(t){var a=function(e,t){return!!e&&(t?e.lastFindPass===H:e.lastFindPass<H)}(t,i);return e.Assert(a,"Item should always be valid"),t.lastFindPass=H,a}return!1}function z(t,i,a){var n,s=a&&a.isTest,r=a&&a.ignoreSearch,o=a&&a.sameLevel,l=a&&a.includeNotes;if(q(t,s)){var d=t.parent();if(d){if(t.isNote())return t.parent();var u=d.getChildIndex(t);if(u>0)for(var c=0;!n;){var h=0;if(c++>5e3&&__infLoop&&__infLoop(c))throw new RangeError;for(var f=!1,p=u-1;p>=0;p--){if(h++>5e3&&__infLoop&&__infLoop(h))throw new RangeError;var g=d.getChild(p);if(!q(g,s))return void e.Assert(!1,"Invalid child found during findPreviousItem");if(o||!g.hasChildren()||i&&g.isCollapsed(i,!1)){if(r||!i||!g.isHidden(i,!1)){n=g,f=!0;break}}else if(r||!i||!g.isHidden(i,!1)){d=g,u=g.numChildren(),f=!0;break}}if(o)break;f||(n=d)}else o||(n=t.parent());return l&&n&&n.hasNote()&&(n=n.getNote()),e.Assert(!o||!n||n.parent()===t.parent(),"Previous item must share the same parent"),e.Assert(s||!n||i&&n.isCollapsed(i,!1)||t===W(n,i,{isTest:!0,ignoreSearch:r,sameLevel:o}),"Previous/Next should always match"),n}}}function W(t,i,a){var n,s=0,r=a&&a.isTest,o=a&&a.ignoreSearch,l=a&&a.sameLevel,d=a&&a.includeNotes;if(t){if(d&&t.hasNote())return t.getNote();if(t.isNote()&&(t=t.parent()),!l&&t.hasChildren()&&(!i||!t.isCollapsed(i,!1)))for(var u=0,c=t.numChildren(),h=0;h<c;++h){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;if(!q(v=t.getChild(h),r))return void e.Assert(!1,"Invalid child found during findNextItem A");if(o||!i||!v.isHidden(i,!1)){n=v,a&&a.numLevels++;break}}for(var f=t;!n;){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;if(!q(f,r)){e.Assert(!1,"Invalid parent found during findNextItem B");break}var p=f.parent();if(!p)break;var g=p.getChildIndex(f);if(c=p.numChildren(),!i||!p.isCollapsed(i,!1)){var m=0;for(h=g+1;h<c;++h){if(m++>5e3&&__infLoop&&__infLoop(m))throw new RangeError;var v;if(!q(v=p.getChild(h),r))return void e.Assert(!1,"Invalid child found during findNextItem C");if(o||!i||!v.isHidden(i,!1)){n=v;break}}}if(f=p,a&&!n&&a.numLevels--,l||i&&f===i.getItem())break}return e.Assert(!l||!n||n.parent()===t.parent(),"Next item must share the same parent"),e.Assert(r||!n||t===z(n,i,{isTest:!0,ignoreSearch:o,sameLevel:l}),"Previous/Next should always match"),n}}e.getPreviousItem=function(e,t,i){return H++,z(e,t,i)},e.getNextItem=function(e,t,i){return H++,W(e,t,i)},e.getFirstItem=function(t,i){var a=0;if(e.Assert(t.belongsToSameItemStore(i),"Must match item stores"),t.id===i.id||i.parent().id===t.id)return t;if(t.parent().id===i.id)return i;var n,s,r=t,o=void 0;do{var l=0;if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;n=i,s=void 0;do{if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;if(r.id===n.id)return void 0===o?t:void 0===s?i:(e.Assert(r.id===s.parent().id,"Must share a common parent"),e.Assert(r.id===o.parent().id,"Must share a common parent"),e.Assert(o.id!==s.id,"If both previous items match, they should have been the common ancestor"),o.getIndex()<s.getIndex()?t:i);s=n}while(void 0!==(n=n.parent()));o=r}while(void 0!==(r=r.parent()));e.Assert(!1,"One item must appear first in the tree")},e.animateTransform=function(t,i){if(e.Assert(t,"Must supply a valid element to transform"),e.Assert(i,"Options must always be defined"),t){var a=function(){i.clearTransform&&(t.style[n.a.transform.style]="",t.style[n.a.transformOrigin.style]=""),i.onComplete&&i.onComplete()},s=i.transform;if(!isNaN(i.delay)){var r=i.delay;return i.delay=void 0,void setTimeout(e.animateTransform,r,t,i)}if(i.time){var o=e.getTransitionClass(i.time);e.addClass(t,o),setTimeout(function(){e.removeClass(t,o),a()},i.time)}else a();isNaN(i.opacity)||(t.style.opacity=i.opacity),s||isNaN(i.left)||isNaN(i.top)||(s="translate3d("+i.left+"px, "+i.top+"px, 0)"),i.origin&&(t.style[n.a.transformOrigin.style]=i.origin),t.style[n.a.transform.style]=s}},e.easeOut=function(e,t,i){return-i*e*(e-2)+t};var G={};e.scrollTo=function(t,i,a,n,s){e.Assert(void 0!==t||void 0!==i,"Must be scrolling something"),e.Assert(void 0===t||e.isNumber(t),"Must provide a valid scrollPosX"),e.Assert(void 0===i||e.isNumber(i),"Must provide a valid scrollPosY"),e.Assert(e.isNumber(a),"Must provide a valid duration"),e.Assert(e.isDOMNode(n),"Must provide a valid element to scroll"),e.Assert(!s||e.isFunction(s),"Must provide a valid scrollDone callback");var r=n.getAttribute("data-moo-id")||n.id;if(e.Assert(r,"Should only scroll elements with ids"),G[r]&&(cancelAnimationFrame(G[r]),delete G[r]),n)if(a>0){if(void 0!==t)var o=n.scrollLeft,l=t-o;if(void 0!==i)var d=n.scrollTop,u=i-d;var c;(Math.abs(l)>0||Math.abs(u)>0)&&(G[r]=requestAnimationFrame(function h(f){c||(c=f-20);var p=Math.min((f-c)/a,1);if(void 0!==t){var g=e.easeOut(p,o,l);n.scrollLeft=g}if(void 0!==i){var m=e.easeOut(p,d,u);n.scrollTop=m}1===p?(delete G[r],s&&s()):G[r]=requestAnimationFrame(h)}))}else n&&(void 0!==t&&(n.scrollLeft=t),void 0!==i&&(n.scrollTop=i)),s&&s();else e.reportError(new Error("Must specify an element to scroll to"))},e.computeScrollSpeed=function(t,i,a,n,s){var r=(i-t-(i-(a=e.clamp(a,t,i))))/(i-t);return s<0&&(r-=1),r*n};var j={speedPane:0,pane:void 0,speedPanes:0,panes:!1};function K(){if(j.pane||j.panes){var t;if(j.pane){var i=6*j.speedPane;t=j.pane.addScrollDelta(i)}else{var a=6*j.speedPanes,n=e.element("panes"),s=n.scrollLeft;n.scrollLeft+=a,t=s!==n.scrollLeft}t?requestAnimationFrame(K):e.cancelRepeatScroll(j.pane?"pane":"panes")}}e.repeatScroll=function(t,i,a,n){e.Assert(n||a&&!e.isString(a),"Must pass a valid pane object to repeatScroll"),j["speed"+(a?"Pane":"Panes")]=i,(j.pane||j.panes)&&a===j.pane||(j.pane=a,j.panes=n,requestAnimationFrame(K))},e.cancelRepeatScroll=function(e){j[e]=void 0},e.elementInPane=function(t){if(t){var i=0;for(t.nodeType===Node.TEXT_NODE&&(t=t.parentNode);t;){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(e.hasClass(t,"pane")||e.hasClass(t,"paneOverview"))return!!t;t=t.parentElement}}return!1},e.elementInPaneEdit=function(t){var i=!1,a=e.getPaneForElement(t);return a&&e.isAncestor(t,a.getContentElement())&&(i=!0),i},e.elementInNonPaneEdit=function(t){var i=!1;if(t&&(t.nodeType===Node.TEXT_NODE&&(t=t.parentNode),!e.elementInPaneEdit(t)))for(var a=0;t;){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(e.isKeyboardInputElement(t)){i=!0;break}t=t.parentElement}return i},e.isNonPaneDropTarget=function(t){var i=!1;return e.elementInNonPaneEdit(t)?i=!0:e.findParent(t,"validDropTarget")&&(i=!0),i},e.scrollIntoView=function(t,i,a){e.Assert(e.isDOMNode(t),"Must supply a valid DOM node to scroll into view"),e.Assert(e.isNumber(i)&&i>=0,"Must supply a valid scroll duration"),e.Assert(!a||e.isFunction(a),"Callback must be a function"),e.Assert(!e.getListCellForElement(t),"Use methods on VMPane to scroll VMLIs");var s=!1;if(t){var r=e.findParent(t,"scroller")||e.findParent(t,"fancyScrollContent")||e.findParent(t,"fancyScroller");if(e.Assert(r,"Every element must be a child of a scroller to be able to scroll it into view"),e.Assert(!e.hasClass(r,"customScroller"),"Must not be scrolling this way, use methods on VMPane instead"),r){var o,l=r.getBoundingClientRect(),d=l.bottom,u=t.getBoundingClientRect(),c=Math.min(u.bottom,u.top+80),h=r.scrollTop,f=n.a.orientation===Orientation.Landscape?e.topBarHeight:120;d=Math.max(l.top+f,d-400),u.top<l.top?o=h+u.top-l.top:c>d&&u.top>l.top&&(o=h+c-d),void 0!==o&&(e.scrollTo(void 0,o,i,r,a),s=!0)}}return s},e.isKeyboardInputElement=function(t){if(t){if("checkbox"===t.type)return!1;if("INPUT"===t.nodeName||"textarea"===t.type||e.findParentAttr(t,"contenteditable","true"))return!0}return!1},e.openKeyboardOnIndex=function(t,i,a,n,s){e.batchRenderUpdates(function(){e._openKeyboardOnIndex(t,i,a,n,s)})},e._openKeyboardOnIndex=function(t,i,a,r,o){e.Assert(!0,"Should only be opening keyboard on mobile devices");var l=i.getScrollOffset(),d=!1;if(e.keyboardToolbar.preShow(),!e.isKeyboardOpen){var u=function(){r&&r(),n.a.iosui&&e.keyboardToolbar.show(s.a.KeyboardToolbarMode.Item),e.enforceScroll()};i.addPadding(),n.a.app||n.a.android||n.a.mobileie?d=i.scrollIndexIntoView(a,n.a.keyboardOpenTime,u):(d=i.scrollIndexIntoView(a,n.a.keyboardOpenTime),u()),e.keyboardToolbar.hideTopBarIfLandscape()}return d&&n.a.app&&!n.a.android&&!n.a.ioswk||(r&&r(),e.keyboardToolbar.show(s.a.KeyboardToolbarMode.Item)),Q=i,J=o,Z=l,X=Y.Item,n.a.ios&&e.preventClick(),t&&(e.preventAndStop(t),t.returnFalse=!0),e.enforceScroll(),d},e.openKeyboardOnElement=function(t,i,a,r){var o,l;e.Assert(!0,"Should only be opening keyboard on mobile devices"),e.Assert(e.isDOMNode(i),"Must supply a valid element"),i&&(o=e.findParent(i,"scroller"),e.Assert(!e.hasClass(i,"paneScroller"),"Must never scroll a custom scroller this way"),l=o?o.scrollTop:0);var d=!1;if(e.keyboardToolbar.preShow(),!e.isKeyboardOpen){var u=function(){e.keyboardToolbar.show(s.a.KeyboardToolbarMode.Modal),a&&a(),e.enforceScroll()};!function(t){if(t){var i=e.getItemForElement(t);i&&i.addPadding&&i.addPadding()}}(o),n.a.app&&!n.a.ioswk||n.a.android||n.a.mobileie?d=e.scrollIntoView(i,n.a.keyboardOpenTime,u):(d=e.scrollIntoView(i,n.a.keyboardOpenTime),u()),e.keyboardToolbar.hideTopBarIfLandscape()}return d&&n.a.app&&!n.a.android||(a&&a(),e.keyboardToolbar.show(s.a.KeyboardToolbarMode.Modal)),Q=o,J=r,Z=l,X=Y.Element,n.a.ios&&e.preventClick(),t.stopImmediatePropagation(),t.returnFalse=!0,e.enforceScroll(),d};var Y={None:0,Item:1,Element:2},X=Y.None,Q=void 0,J=void 0,Z=0;function $(e,t,i){for(var a=0,n=0;n<t.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=t[n];if(!e.headers||s.showInOverview(e.includeArchived)){if((!e.comparator||e.comparator(s,e))&&e.each&&!1===e.each(s,e))return!1;ee(s,e,i+1)}}}function ee(e,t,i){i=i||0;var a,n=t.noCollapsed,s=t.pane,r=t.overview;t.includeNotes&&!t.headers&&e.hasNote()&&(t.comparator&&!t.comparator(e.getNote(),t)||t.each&&(a=t.each(e.getNote(),t))),!1!==a&&(!n||0===i||e.items.length()>0&&!e.isCollapsed(s,r))&&!1!==(a=$(t,e.items.get(),i))&&t.includeArchived&&e.hasArchivedChildren()&&$(t,e.archivedItems(!0),i)}function te(t,i){e.Assert("string"!=typeof t,"Should only pass objects to the obj mapping function",t);var a={};for(var n in t)if(e.Assert(t.hasOwnProperty(n),"This should always be the case, the prototype shouldn't be extended"),void 0!==t[n]&&null!==t[n]){var s=i[n];s?a[s]=t[n]:(e.Assert(!1,"Incoming field should be added to the field map",n),a[n]=t[n])}return a}e.onCloseKeyboardItem=function(){e.isKeyboardOpen&&(Q.addPadding(),Q.setScrollOffset(Z,n.a.keyboardOpenTime),e.isKeyboardOpen=!1,J&&J())},e.onCloseKeyboardElement=function(){e.isKeyboardOpen&&(e.Assert(Q,"Must have a valid scroller"),e.scrollTo(void 0,Z,n.a.keyboardOpenTime,Q),e.isKeyboardOpen=!1,J&&J())},e.onCloseKeyboard=function(){X===Y.Item?e.onCloseKeyboardItem():X===Y.Element&&e.onCloseKeyboardElement()},e.blurActiveElement=function(t){e.ignoreSelectionChange=!!t,document.activeElement&&document.activeElement.blur(),setTimeout(function(){e.ignoreSelectionChange=!1},100)},e.preventScrollPropagation=function(t){return e.Assert(e.isDOMNode(t),"Must pass in a valid element"),e.Assert(!e.hasClass(t,"customScroller"),"Should not prevent scroll prop on pane"),t.scrollHeight!==t.clientHeight&&(0===t.scrollTop?t.scrollTop=1:t.scrollTop+t.offsetHeight>=t.scrollHeight&&(t.scrollTop=t.scrollHeight-t.offsetHeight-1),!0)},e.trimString=function(e){for(var t=0,i=/\s/,a=(e=e.replace(/^\s\s*/,"")).length;i.test(e.charAt(--a));)if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;return e.slice(0,a+1)},e.enforceScroll=function(e,t){(e||(n.a.ios||n.a.android)&&(!n.a.app||n.a.ios71))&&(setTimeout(function(){window.scrollTo(0,t||0)},0),requestAnimationFrame(function(){window.scrollTo(0,t||0)}),window.scrollTo(0,t||0),document.body.scrollTop=0)},e.preventAndStop=function(t){e.preventDefault(t),e.stopPropagation(t)},e.preventDefault=function(t){t&&t.preventDefault?t.preventDefault():e.Assert(!1,"Invalid event object: "+t)},e.stopPropagation=function(t){t&&t.stopPropagation?t.stopPropagation():e.Assert(!1,"Invalid event object: "+t)},e.preventClick=function(){e.addClass(e.element("outerWrapper"),"noClick"),window.ontouchstart=e.preventDefault,requestAnimationFrame(function(){window.ontouchstart=void 0,e.removeClass(e.element("outerWrapper"),"noClick")})},e.searchVMLIs=function(t){e.Assert(t,"Must supply a valid options param"),e.vmMain.notifySearchStart();try{t.itemStoreFilter?e.vmMain.itemStoreManager.runForEachStore(function(e){var i=t.item;ee(i&&i.belongsToItemStore(e)?i:e.getRoot(),t)},t.itemStoreFilter):t.item?(e.Assert(!t.itemStore&&!t.itemStoreFilter,"Should only specify one of item/itemStore/itemStoreFilter"),ee(t.item,t)):t.itemStore?(e.Assert(!t.itemStoreFilter,"Should only specify one of item/itemStore/itemStoreFilter"),ee(t.itemStore.getRoot(),t)):(e.Assert(!1,"Must specify a valid search root, using the default root is deprecated"),e.vmMain.itemStoreManager.getDefaultItemStore().getRoot())}catch(t){e.reportError(t)}e.vmMain.notifySearchEnd()},e.searchVMLIsAsArray=function(t){var i=[];return t.each=function(e){i.push(e)},e.searchVMLIs(t),i},e.getActiveSearch=function(){return e.focusedPane.search},e.invertObject=function(e){var t={};for(var i in e)e.hasOwnProperty(i)&&(t[e[i]]=i);return t},e.fieldMapOut=e.invertObject(e.fieldMapIn),e.translateFieldIn=function(t){return e.Assert(e.fieldMapIn[t],"Incoming field should be added to the field map",t),e.Assert("string"==typeof t,"Should only pass strings to the field mapping function",t),e.fieldMapIn[t]||t},e.translateFieldOut=function(t){return e.Assert(e.fieldMapOut[t],"Incoming field should be added to the field map",t),e.Assert("string"==typeof t,"Should only pass strings to the field mapping function",t),e.fieldMapOut[t]||t},e.translateObjIn=function(t){return te(t,e.fieldMapIn)},e.translateObjOut=function(t){return te(t,e.fieldMapOut)};var ie,ae={};function ne(){var e=0;document.removeEventListener("DOMContentLoaded",ne,!1),window.removeEventListener("load",ne,!1);for(var t=0;t<ie.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;ie[t]()}ie=void 0}e.addCustomEventListener=function(t,i,a){if(e.Assert(t,"Must provide a valid event name"),e.Assert(i,"Must provide a valid event handler to add"),void 0!==a){var n={fn:i,pri:a};ae[t]?ae[t].insertSorted(n,function(e,t){return e<t?1:-1}):(ae[t]=[n],window.addEventListener(t,function(e){for(var i=0,a=0;a<ae[t].length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(!1===ae[t][a].fn(e))break}}))}else window.addEventListener(t,i)},e.removeCustomEventListener=function(t,i,a){if(e.Assert(t,"Must provide a valid event name"),e.Assert(i,"Must provide a valid event handler to remove"),a){for(var n=0,s=ae[t],r=!1,o=0;o<s.length;++o){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(s[o].fn===i){r=!0,s.removeAt(o);break}}s.length,e.Assert(r,"Event listener should always be found when removing")}else window.removeEventListener(t,i)},e.fireCustomEvent=function(t,i,a){if(document.createEvent){var n=document.createEvent("Event");return i&&(n.data=i),n.initEvent(t,!0,!0),(a||window).dispatchEvent(n)}e.Assert(!1,"Unable to fire custom event")},e.clone=function(t,i){var a=void 0;if(e.isArray(t))a=JSON.parse(JSON.stringify(t));else for(var n in a={},t)t.hasOwnProperty(n)&&(i&&e.isFunction(t[n])||(a[n]=t[n]));return a},e.cloneMouseEvent=function(e){return{altKey:e.altKey,button:e.button,buttons:e.buttons,clientX:e.clientX,clientY:e.clientY,ctrlKey:e.ctrlKey,currentTarget:e.currentTarget,fromElement:e.fromElement,metaKey:e.metaKey,pageX:e.pageX,pageY:e.pageY,relatedTarget:e.relatedTarget,shiftKey:e.shiftKey,target:e.target,timestamp:e.timestamp,toElement:e.toElement,type:e.type,view:e.view,which:e.which,x:e.x,y:e.y,preventDefault:e.preventDefault.bind(e),stopPropagation:e.stopPropagation.bind(e),stopImmediatePropagation:e.stopImmediatePropagation.bind(e)}},e.loadXML=function(t){try{if(void 0!==window.DOMParser)return(new window.DOMParser).parseFromString(t,"text/xml");if(void 0!==window.ActiveXObject&&new window.ActiveXObject("Microsoft.XMLDOM")){var i=new window.ActiveXObject("Microsoft.XMLDOM");return i.async="false",i.loadXML(t),i}return void e.Assert(!1,"No XML parser found")}catch(t){return void e.reportError(t)}},e.adjustOriginToBeInsideBounds=function(e,t,i,a,n,s){var r={x:t.left,y:t.top};return i=i||0,a=a||0,n=n||0,s=s||0,t.bottom+s>e.bottom&&(r.y=Math.max(a,t.top-(t.bottom+s-e.bottom))),t.top-s<e.top&&(r.y=Math.max(a,t.top)),t.right+n>e.right&&(r.x=Math.max(i,t.left-(t.right+n-e.right))),r},e.adjustLeftToBeInsideBounds=function(e,t,i,a){return t+i+a>e.right&&(t=e.right-a-i),t},e.adjustHeightToBeInsideBounds=function(e,t,i,a,n){if(t.bottom+n>e.bottom&&(t.bottom=e.bottom-n,t.bottom-t.top<i)){var s=Math.max(0,t.bottom-i);t.top=s}return Math.min(a,t.bottom-t.top)},e.setOrigin=function(e,t,i){var a=e.left-t,n=e.top-i;e.left-=a,e.right-=a,e.top-=n,e.bottom-=n},e.copyStyles=function(t,i,a){e.Assert(t,"Must have a valid source element"),e.Assert(i,"Must have a valid dest element"),e.Assert(a,"Must have a valid list of styles to copy");var n=window.getComputedStyle(t);if(n){for(var s=0,r=0,o=[],l=0;l<a.length;++l){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;o[l]=n[a[l]]}for(l=0;l<o.length;++l){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;i.style[a[l]]=o[l]}}},e.hasClass=function(t,i){if(e.Assert(t,"Must pass in a valid element"),t.classList)for(var a=0,n=Array.prototype.slice.call(arguments,1),s=0;s<n.length;s++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(t.classList.contains(n[s]))return!0}return!1},e.removeClass=function(t,i){e.Assert(t,"Must pass in a valid element"),t&&t.classList&&t.classList.remove(i)},e.addClass=function(t,i){e.Assert(t,"Must pass in a valid element"),t&&t.classList&&t.classList.add(i)},e.toggleClass=function(t,i){e.Assert(t,"Must pass in a valid element"),t&&t.classList&&t.classList.toggle(i)},e.css=function(t,i){if(e.Assert(t,"Must pass in a valid element"),t)for(var a in i)if(i.hasOwnProperty(a)){var n=i[a];"number"==typeof n&&(n+="px"),t.style[a]=n}},e.findChild=function(t,i){if(e.Assert(t,"Must pass in a valid element"),t)for(var a=0,n=0;n<t.childElementCount;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=t.children[n];if(e.hasClass(s,i))return s;var r=e.findChild(s,i);if(r)return r}},e.getPluginForElement=function(t){return e.findParent(t,"plugin",4)},e.findParentInItem=function(t,i){for(var a=0;t&&!e.hasClass(t,"item");){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(e.hasClass(t,i))return t;t=t.parentNode}},e.findParent=function(t,i,a){if(e.Assert(t,"Must pass in a valid element"),a||(a=1e3),t)for(var n=0,s=t,r=0;r<a&&s;++r,s=s.parentNode){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(e.hasClass(s,i))return s}},e.findParentID=function(t,i,a){if(e.Assert(t,"Must pass in a valid element"),a||(a=1e4),t)for(var n=0,s=t,r=0;r<a&&s;++r,s=s.parentNode){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(s.id===i)return s}},e.findParentAttr=function(t,i,a){if(e.Assert(t,"Must pass in a valid element"),t)for(var n=0,s=t;s&&s.getAttribute;s=s.parentNode){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(s.getAttribute(i)===a)return s}},e.isAncestor=function(t,i){var a=0;for(e.Assert(t,"Must have a valid element"),e.Assert(i,"Must have a valid candidate");t&&t!==i;){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;t=t.parentNode}return!!t},e.firstChildTag=function(t,i){if(e.Assert(t,"Must pass in a valid element"),e.Assert(i,"Must pass in a valid tag to check"),t)for(var a=0,n=i.toUpperCase(),s=0;s<t.childElementCount;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(t.children[s].tagName===n)return t.children[s]}},e.insertAfter=function(t,i){e.Assert(t,"Must pass in a valid element"),e.Assert(i,"Must pass in a valid element"),t.parentNode.insertBefore(i,t.nextSibling)},e.prependChild=function(t,i){e.Assert(t,"Must pass in a valid element"),e.Assert(i,"Must pass in a valid element"),t.insertBefore(i,t.firstChild)},e.getAncestorChain=function(e){for(var t=0,i=e;i;){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;i.push(i),i=i.parentNode}return[]},e.findCommonAncestor=function(t){for(var i=0,a=e.getAncestorChain(t),n=0,s=1;s<t.length&&n+1<a.length;++s){var r=0;if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;for(var o=t[s];o;){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;o=o.parentNode;var l=a.indexOf(o,n);if(l>=0){n=l;break}}}return a[n]},e.isAttachedToDoc=function(t){return e.Assert(t,"Must supply a valid element to check"),e.Assert(t.ownerDocument,"Checked element must have a valid owner document"),!!t.ownerDocument&&(t.ownerDocument.body.contains(t)||t.ownerDocument.documentElement===t)},e.offset=function(t){e.Assert(t,"Must pass in a valid element");var i=t.getBoundingClientRect(),a=t.ownerDocument,n=t.ownerDocument.documentElement,s=a.defaultView;return{top:i.top+s.pageYOffset-n.clientTop,left:i.left+s.pageXOffset-n.clientLeft}},e.position=function(e){var t=e.offsetParent,i=e.getBoundingClientRect(),a=t.getBoundingClientRect();return{left:i.left-a.left,top:i.top-a.top}},e.height=function(t){e.Assert(t,"Must pass in a valid element");var i=t.offsetHeight,a=window.getComputedStyle(t);return a?("border-box"!==a.boxSizing&&(i-=parseFloat(a.paddingTop)+parseFloat(a.paddingBottom)),i-=parseFloat(a.borderTopWidth)+parseFloat(a.borderBottomWidth)):ShouldLog(LogLevels.Error)&&log("GetComputedStyle failed in globals::height"),i},e.width=function(t){e.Assert(t,"Must pass in a valid element");var i=t.offsetWidth,a=window.getComputedStyle(t);return a?("border-box"!==a.boxSizing&&(i-=parseFloat(a.paddingLeft)+parseFloat(a.paddingRight)),i-=parseFloat(a.borderLeftWidth)+parseFloat(a.borderRightWidth)):ShouldLog(LogLevels.Error)&&log("GetComputedStyle failed in globals::width"),i},e.runOnLoad=function(e){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(e):(ie||(ie=[],document.addEventListener("DOMContentLoaded",ne,!1),window.addEventListener("load",ne,!1)),ie[ie.length]=e)},e.sendFeedback=function(t,i,a){var n={};e.vmMain.getAppInfo(n),n.eventStream=void 0;var s={name:t,notes:i+"\r\n\r\n\r\n"+JSON.stringify(n,void 0,3)};s.email=e.getUserIdentifier(),s.premiumStatus=e.billingManager.getPremiumStatus(),e.XHR_PrivateAPI({type:"POST",path:"/feedback/suggestion",data:s,cb:function(e){log("XHR Response: ",e.status,e),a&&a()}})};var se={};function re(t){var i=e.sanitizeURL(t).split("?")[0];return se[i]||(se[i]={requests:0,successes:0,retries:0,failures:0}),se[i]}function oe(e){re(e).failures++}e.getXHRStats=function(){return se};var le=[0,5,15,35,80,170,400,1200],de=[0,408,429,500,502,503,504];e.XHR=function(t){e.Assert(t.url,"Must specify a valid URL to use"),e.Assert(t.type,"Must specify a valid request type");var i=t.url,a=t.type,n=t.cb,s=t.data,r=t.headers,o=t.autoRetry,l=t.timeout,d=Math.min(t.maxRetries||2,6),u=0,c=t.username,h=t.password;function f(){e.Assert(u<d,"Should not be calling retry once retries have been exhausted"),u<d?(u++,function(e){re(e).retries++}(i),setTimeout(p,1e3*le[u])):(oe(i),e.reportError(new Error("XHR Failed: "+i)))}function p(){var t,p=new XMLHttpRequest;if(p.timeout=l,p.onreadystatechange=function(){4===p.readyState&&(200!==p.status?u<d?(p.retry=f,o&&de.indexOf(p.status)>=0?p.retry():n(p)):(oe(i),n(p)):(function(e){re(e).successes++}(i),n(p)))},c&&h?p.open(a.toUpperCase(),i,!0,c,h):p.open(a.toUpperCase(),i,!0),r)for(var m in r)p.setRequestHeader(m,r[m]);s?(p.setRequestHeader("Accept","*/*"),r&&r["Content-Type"]||p.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),t=s instanceof Blob?s:function(t){var i="";if("object"===(void 0===t?"undefined":g(t))){var a=[];for(var n in t)a[a.length]=encodeURIComponent(n)+"="+encodeURIComponent(t[n]);i=a.join("&").replace(/%20/g,"+")}else e.Assert("string"==typeof t,"Only Objects or Strings are currently supported"),i=t;return i}(s),p.send(t)):p.send()}!function(e){re(e).requests++}(i),p()},e.XHR_PrivateAPI=function(t){e.vmMain.XHR_PrivateAPI(t)};var ue=!1,ce=1,he={};function fe(e){var t,i;if(i=e.url,t=!!i&&he[i.split("?")[0]]){e.iid=ce++;var a=e.onreadystatechange;e.onreadystatechange=function(){a&&a.apply(e,arguments),t(e)}}}e.registerURLForNotifyXHR=function(e,t){return he[e]||(he[e]=t),ue};var pe,ge=["https://drive.google.com/otservice/save","https://drive.google.com/otservice/bind"];e.wrapXHR=function(){try{var t=window.XMLHttpRequest.prototype.open,i=window.XMLHttpRequest.prototype.send;window.XMLHttpRequest.prototype.open=function(i,a,n,s,r){this.url=a,void 0===n&&(n=!0);try{t.call(this,i,a,n,s,r)}catch(t){throw e.reportError(t),t}},window.XMLHttpRequest.prototype.send=function(t){fe(this),!this.timeout&&function(e){var t=!1;if(e&&e.url){var i=e.url.split("?")[0];ge.indexOf(i)>=0&&(t=!0)}return t}(this)&&(this.timeout=e.seconds(70));try{this.url&&!this.url.startsWith("https://nikkomsgchannel")&&i.call(this,t)}catch(t){throw e.reportError(t),t}}}catch(t){return void e.reportError(t)}ue=!0},e.wrapXHR(),e.areObjectsEqual=function(e,t){return JSON.stringify(e)===JSON.stringify(t)},e.JSONP=function(t){e.Assert(t.url,"Must supply a valid URL to fetch"),e.Assert(t.cb,"Must supply a valid callback");var i=t.url,a=t.data,n=t.cb;if(a){for(var s=0,r="",o=Object.keys(a),l=0;l<o.length;l++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;r+=encodeURIComponent(o[l])+"="+encodeURIComponent(a[o[l]]),l!==o.length-1&&(r+="&")}i+="?"+r}var d=Date.now(),u="jsonp"+Math.round(d+10001*Math.random());window[u]=function(e){n(e),delete window[u]},-1===i.indexOf("?")?i+="?":i+="&";var c=document.createElement("script");c.id=u,c.setAttribute("src",i+"callback="+u),document.getElementsByTagName("head")[0].appendChild(c)},e.element=function(t,i){return e.Assert(t,"Tried to get an element without an id"),e.elements[t]&&!i||(e.elements[t]=document.getElementById(t)),e.Assert(e.elements[t],"Tried to get an element that doesn't exist",t),e.elements[t]},e.openUrl=function(t,i,a){if(e.Assert(t,"Must always provide a valid URL to open"),!t)return!1;var s=e.parseEvernoteLink(t);if(s){var r=e.settings.get(Settings.openEvernoteApp);if(void 0===r)return void e.menus.confirm("Open Evernote links in Evernote app?",function(n){e.settings.set(Settings.openEvernoteApp,n),e.openUrl(t,i,a)});r&&(s.viewUrl?t=s.viewUrl:(t="evernote:///view/"+s.userId+"/"+s.shardId+"/"+s.noteGuid+"/"+s.noteGuid+"/",console.log(t)))}if(n.a.standalone){var o=document.createElement("a");o.setAttribute("href",t),o.setAttribute("target","_blank"),o.setAttribute("rel","noopener noreferrer");var l=document.createEvent("HTMLEvents");l.initEvent("click",!0,!0),o.dispatchEvent(l)}else n.a.app?(n.a.ios&&n.a.appv>=5||n.a.android&&n.a.appv>=5||n.a.isChrome||!t.startsWith("http://")&&!t.startsWith("https://")?t.startsWith("/")&&(t=window.location.host+t):t=t.replace("http://","").replace("https://",""),t.startsWith("callto:")&&(t=t.replace("callto:","tel:")),n.a.ios&&t.startsWith("tel:")?(t.indexOf("://")<0&&(t=t.replace("tel:","tel://")),e.nativeBridge.sendToApp("openURL",t)):n.a.ios&&t.startsWith("mailto:")?open(t):e.nativeBridge.sendToApp("openURL",t),i&&(e.preventAndStop(i),i.returnFalse=!0)):(a=a||t.startsWith("evernote:///")||t.startsWith("onenote:")||t.startsWith("bear:"))?open(t,"_self"):open(t,"_blank");return!0},e.isUrlImage=function(e){return(e=e.toLowerCase()).endsWith(".png")||e.endsWith(".jpg")||e.endsWith(".gif")},e.isDateSoft=function(e){if(e)switch(e.toUpperCase()){case"NEXT":case"SOON":case"LATER":case"SOMEDAY":case"NOW":return!0}return!1},e.isDateValid=function(e){return e&&e instanceof Date&&!isNaN(e.getTime())},e.getLocationOrigin=function(){return window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")},e.isSpellcheckEnabled=function(){return pe},e.fFalse=function(){return!1},e.fTrue=function(){return!0},e.emptyFn=function(){},e.newEmptyFn=function(){return function(){}},e.weeks=function(e){return 6048e5*e},e.days=function(e){return 864e5*e},e.hours=function(e){return 36e5*e},e.minutes=function(e){return 6e4*e},e.seconds=function(e){return 1e3*e},e.round=function(e,t){return t=t||2,Number(Math.round(e+"e"+t)+"e-"+t)},e.toFileSize=function(e){if(e){var t=Math.log(e)/Math.log(1024)|0;return(e/Math.pow(1024,t)).toFixed(2)+" "+(0===t?"bytes":"KMGTPEZY"[t-1]+"B")}return null},e.curry=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(this,t.concat(Array.prototype.slice.call(arguments,0)))}},e.saveFile=function(t,i){if(n.a.appPlatform===AppPlatform.Chrome)try{e.nativeBridge.sendToApp("exportData",{content:t,filename:i})}catch(t){e.reportError(t)}else{var a=new Blob([t],{type:"text/plain;charset=utf-8"});Object(p.a)(a,i)}};var me=[];e.downloadFile=function(t,i){if(n.a.supportsNativeDownload())e.Assert(!me[t],"Should not double create a download for the same file"),me[t]=e.toasts.pushMessage({text:"Downloading "+i+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0%",hold:!0,actionText:""}),e.nativeBridge.sendToApp("downloadURL",{url:t,name:i});else if(document.createEvent){var a=document.createElement("a");a.href=t;var s=document.createEvent("MouseEvents");s.initEvent("click",!0,!0),a.dispatchEvent(s)}else window.open(t,"_self")},e.handleNativeDownloadProgress=function(e){var t=e.url,i=e.name,a=e.progress,n=me[t];if(n)if(1===a)n.hide(),delete me[t];else{var s=isNaN(a)?"...":Math.round(100*a)+"%";n.setText("Downloading "+i+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+s)}},e.printPage=function(e){n.a.app||window.open(e).print()},a.a.hasURLParam("nolocal","true")&&(e.noLocalWrites=!0,e.noLocalWritesReason=s.a.LocalWriteReason.NoLocal),e.eventStream=new r.a(25),window.__CHECK_OAUTH=function(){e.XHR({type:"GET",url:"https://accounts.google.com/o/oauth2/auth?scope=email&redirect_uri=http://moo.do&response_type=token&client_id=597847337936.apps.googleusercontent.com",cb:function(e){log("XHR OAuth: ",e)}})},e.reactNodeForElement=function(t){var i=t;if(i.nodeType===Node.TEXT_NODE&&(i=i.parentNode),i=e.getParentWithMooKey(i))for(var a in i)if(a.startsWith("__reactInternalInstance$")){var n=i[a],s=n&&n.return&&n.return.stateNode;if(s&&s.props)return s}},e.getParentWithMooKey=function(e){for(var t=0;e&&e!==document;){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(e.getAttribute("data-moo-id"))return e;e=e.parentNode}},e.getItemForElement=function(t){var i=e.reactNodeForElement(t),a=i&&i.getPaneObject&&i.getPaneObject(),n=a&&(e.isVMLI(a)?a:a.item);if(e.Assert(!n||e.isVMLI(n),"Must always find a valid VMLI for a given element: "+e.elementToString(t)),n)return n},e.getIndexForElement=function(t){var i=-1,a=e.findParent(t,"item");if(a){var n=e.reactNodeForElement(a);n&&(i=n.getIndex())}return i},e.getPaneForElement=function(t){var i=e.findParent(t,"pane")||e.findParent(t,"paneOverviewWrapper");if(i){var a=e.reactNodeForElement(i);return a&&a.getPane&&a.getPane()}if(e.findParent(t,"mobileUIBottom"))return e.focusedPane},e.getPaneObjectForElement=function(t){var i=e.reactNodeForElement(t);if(i&&i.getPaneObject)return i.getPaneObject()},e.getCellForElement=function(t){var i=e.reactNodeForElement(t);if(i&&i.getCell)return i.getCell()},e.getListCellForElement=function(t){var i=e.reactNodeForElement(t);if(i&&i.getCell)return i},e.classNames=function(){for(var t=0,i=arguments,a=[],n=0;n<i.length;n++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=i[n];if(s)if(e.isString(s)||e.isNumber(s))a.push(s);else if("object"===(void 0===s?"undefined":g(s)))for(var r in s)s.hasOwnProperty(r)&&s[r]&&a.push(r)}return a.join(" ")},e.extend=function(e,t){if(t)for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},e.isVMLI=function(e){return e&&e.__ISVMLI},e.isPane=function(e){return e&&e.__ISPANE},e.decodeURLObject=function(t){var i;if(t){var a=e.b64_to_utf8(t);try{i=JSON.parse(a)}catch(t){e.reportError(t)}}return i},e.encodeMIMEHeader=function(e){return"=?UTF-8?B?"+window.btoa(unescape(encodeURIComponent(e)))+"?="},e.utf8_to_b64=function(t){var i;try{i=window.btoa(unescape(encodeURIComponent(t))).replace(/\+/g,"-").replace(/\//g,"_")}catch(i){e.reportError(i,t)}return i},e.b64_to_utf8=function(t){var i;try{i=decodeURIComponent(escape(window.atob(t.replace(/-/g,"+").replace(/_/g,"/"))))}catch(i){e.reportError(i,t)}return i},e.qp_to_utf8=function(t){var i;try{i=t.replace(/[\t\x20]$/gm,"").replace(/=(?:\r\n?|\n|$)/g,"").replace(/=([a-fA-F0-9]{2})/g,function(e,t){var i=parseInt(t,16);return String.fromCharCode(i)})}catch(i){e.reportError(i,t)}return i},e.isHTTPStatusCode=function(e,t){return e&&e.error&&e.error.code===t},e.hasGoogleError=function(t,i,a){e.Assert(t,"Must specify a valid result object"),e.Assert(i,"Must specify a valid error domain"),e.Assert(a,"Must specify a valid error reason");var n=!1;if(t&&t.error&&t.errors)for(var s=0,r=t.error.errors,o=0;o<r.length;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var l=r[o];if(l.domain===i&&l.reason===a){n=!0;break}}return n},e.timeouts={},e.hasTimeoutOnce=function(t){return!!e.timeouts[t]},e.timeoutOnce=function(t,i,a,n,s,r,o,l){e.Assert(t,"Must supply a valid name"),e.Assert(e.isFunction(i),"must supply a valid cb fn"),e.Assert(arguments.length<=8,"Too many args passed in");var d=e.timeouts[t];d&&clearTimeout(d),e.timeouts[t]=setTimeout(function(){delete e.timeouts[t],i(n,s,r,o,l)},a)},e.clearTimeoutOnce=function(t){var i=e.timeouts[t];i&&(clearTimeout(i),delete e.timeouts[t])},e.animFrameOnce=function(t,i){var a=e.timeouts[t];a&&cancelAnimationFrame(a),e.timeouts[t]=requestAnimationFrame(i)},e.contentSetAuto=void 0,e.reEnableNone=function(t){e.Assert(t,"Must have a valid element to set pointer-events on"),t.style["pointer-events"]=""},e.elementFromPoint=function(e,t){return document.elementFromPoint(e,t)},e.parentTextForItem=function(e){for(var t=0,i=e.parents(),a="",n=1;n<i.length;n++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;n>1&&(a+="  |  "),a+=i[n].generateTitleText()}return a},e.scrollToAndHighlightItem=function(t,i){t.highlight(),e.vmMain.paneManager.runForEachPane(function(a){if(a!==i){var n=a.indexOfItem(t);if(n<0&&a.type===PaneMode.Task&&a.isViewOutline()&&t.isDescendantOf(a.item.get())&&a.search.isMatched(t)){var s=0;e.vmMain.beginUpdateItems();for(var r=t.parent();r&&r!==a.item.get();){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;r.isCollapsed(a,!1)&&(a.setIgnoreRestoreScroll(),r.setCollapsed(!1,a,!1)),r=r.parent()}e.vmMain.commitUpdateItems(),n=a.indexOfItem(t)}n>=0&&a.scrollIndexToMiddle(n,ScrollDuration.Default)}})},e.batchRenderUpdates=function(e,t,i,a,n,s){return h.a.unstable_batchedUpdates(e,t,i,a,n,s)},e.hexToRgb=function(e){return{r:parseInt(e.substr(1,2),16),g:parseInt(e.substr(3,2),16),b:parseInt(e.substr(5,2),16)}},e.hexToRgbStr=function(e){return parseInt(e.substr(1,2),16)+","+parseInt(e.substr(3,2),16)+","+parseInt(e.substr(5,2),16)},e.rgbToHex=function(t,i,a){return[e.pad2(Math.round(t).toString(16)),e.pad2(Math.round(i).toString(16)),e.pad2(Math.round(a).toString(16))].join("")},n.a.demo&&e.enableDemoMode(),e.setupGoogleAPIListener(),e.fieldMapValidators={isArchived:e.isBoolean,dateCreated:e.isNumber,date:e.isNumber,duration:e.isNumber,formats:e.isAnything,durationText:e.isString,favorites:e.isAnything,items:e.isArray,isNote:e.isBoolean,modifiedOffline:e.isBoolean,isCollapsed:e.isBoolean,note:e.isString,modifiedOfflineText:e.isBoolean,priority:e.isNumber,repeatDate:e.isAnything,dateText:e.isString,text:e.isString,versionText:e.isNumber,version:e.isNumber,isDeleted:e.isBoolean,isComplete:e.isBoolean,archivedItems:e.isArray,allDayDate:e.isBoolean,id:e.isString,isStarred:e.isBoolean,dateCompleted:e.isNumber,dateFormat:e.isString},e.fixFieldDate=function(t){var i;if(e.isString(t)){var a=new Date(t);a&&(i=a.getTime())}else t instanceof Date?i=t.getTime():e.isNumber(t)&&(i=t);return i},e.fieldMapFixer={date:e.fixFieldDate,dateCompleted:e.fixFieldDate};var ve=/https:\/\/www.evernote.com\/shard\/([a-z0-9.\-]+)\/nl\/([a-z0-9.\-]+)\/([a-z0-9.\-]+)/g;e.parseEvernoteLink=function(e){return e.startsWith("evernote:///view/")?{viewUrl:e}:(ve.lastIndex=0,null!==(t=ve.exec(e))?{shardId:t[1],userId:t[2],noteGuid:t[3]}:void 0);var t},e.isOneNoteLink=function(e){return e.startsWith("onenote:https://")},e.isBearLink=function(e){return e.startsWith("bear://x-callback-url/")},e.getDefaultItemText=function(t){return(t=t||e.settings.get(Settings.defaultItemPrefix))?t+" ":""},e.isPrefixTask=function(e){return e&&(e===s.a.Prefix.Task||e===s.a.Prefix.Task2||e===s.a.Prefix.Task3||e===s.a.Prefix.Task4||e===s.a.Prefix.Task5||e===s.a.Prefix.Task6||e===s.a.Prefix.Task7||e===s.a.Prefix.Task8)},e.showMarkdown=function(){return e.settings.get(Settings.showMarkdown)};var _e,ye=-1;return window.__infLoop=function(t){if(!_e||t<ye)_e=Date.now();else if(t>ye&&t>3e4&&t%200==0&&Date.now()-_e>1e4)return e.Assert(!1,"Infinite loop!",t),e.toasts&&e.toasts.pushMessage(MessageID.ReactError),!0;ye=t},e}()},function(e,t,i){"use strict";var a=window.KeyCode={Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Escape:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,LeftArrow:37,UpArrow:38,RightArrow:39,DownArrow:40,Delete:46,D0:48,D1:49,D2:50,D3:51,D4:52,D5:53,D6:54,D7:55,D8:56,D9:57,Colon:58,LAngle:60,RAngle:62,At:64,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,LeftMeta:91,RightMeta:93,NumPlus:107,Minus:109,F1:112,F4:115,F12:123,Equals:187,Plus:187,Comma:188,Dash:189,Period:190,Slash:191,Tilde:192,LBracket:219,RBracket:221,Apos:222},n={EmailOpenTime:250,ItemTransitionTime:150,DoubleClickTime:500,EmailPreviewSizeMin:600,EmailPreviewSizeMaxFlex:800,EmailPreviewSizeMax:1200,PremiumMaxBoards:5,PremiumMaxPanes:3,ExpandedPaneWidth:400,HelpWidth:360,StdPaneWidthMin:400,StdPaneWidthMax:900,PaneWidthMax:1400,EmailOpenTimeMobile:150,OverviewWidth:260,OverviewItemHeightDesktop:26,OverviewItemHeightMobile:36,EmailItemHeight:80,RightMenuWidth:100,TrialDuration:14,PaneSpaceSize:0,MSPerMinute:6e4,MSPerHour:36e5,MSPerDay:864e5,MaxBatchSize:45,TooltipDelay:400,MobileBottomHeight:50,HorizScrollbarHeight:18,PaneHeaderButtonWidth:32,PaneHeaderButtonHeight:36,PaneHeaderRow2ButtonHeight:30,PaneHeaderRow2Height:36,MobileHeaderRow2Height:36,CalendarResizeHandleHeight:8,DesktopMenuWidthDefault:120,DesktopMenuWidthMax:240,DesktopMenuWidthMinBig:66,DesktopMenuWidthSmall:36,RootItemName:"Home",MinEmailScale:.25,SidebarDragHandleSize:16,SearchHeight:22,PaneAddItemBoxHeight:36,DateFormat:{DMY:"dmy",MDY:"mdy",YMD:"ymd"},SettingsSections:{General:"General",Dates:"Dates",Plugins:"Enable Plugins",Account:"Moo.do Account",EarlyAccess:"Send Feedback",Linked:"Email Accounts",Invite:"Invite Friends",GoogleCalendar:"Google Calendar",Contacts:"Contacts",Gmail:"Gmail",Agenda:"Agenda",Backups:"Backups"},ItemAnimationMode:{None:0,Normal:1,Move:2,Search:3},MatchState:{Unknown:void 0,No:0,Yes:1,Negated:2,ChildYes:3},EmailResponseMode:{None:0,Reply:1,ReplyAll:2,Forward:3,Other:4},PluginType:{Unknown:0,Storage:1,Calendar:2,Email:3},SyncResult:{Success:0,FailureOAuth:1,FailureNoWrite:2,FailureNoRead:3,FailureNetwork:4,FailureUnknown:5},Primary:{No:0,Yes:1,Either:2,Both:3,Never:4,Only:5},Shift:{No:0,Yes:1,Either:2},FavoriteGroup:{EmailRoot:1},DropEffect:{Copy:"copy",Move:"move"},HoveredID:{Plugin:"plugin",Collapser:"collapser",Checkbox:"checkbox",Bullet:"bullet"},TaskViewMode:{Outline:"Outline",List_Flat:"List_Flat",Groups_Project:"Groups_Project",Groups_Tag:"Groups_Tag",Groups_Contact:"Groups_Contact",Groups_Priority:"Groups_Priority",Agenda_Today:"Agenda_Today",Agenda_Week:"Agenda_Week",Agenda_All:"Agenda_All",Calendar_Day:"Calendar_Day",Calendar_Custom:"Calendar_Custom",Calendar_Week:"Calendar_Week",Calendar_Month:"Calendar_Month"},TaskViewModesPremium:{Groups_Tag:!0,Groups_Contact:!0,Groups_Priority:!0},TaskViewModeText:{Outline:"Outline",List_Flat:"Flat List",Groups_Project:"Project",Groups_Tag:"Tag",Groups_Contact:"Contact",Groups_Priority:"Priority",Agenda_Today:"Today",Agenda_Week:"Week",Agenda_All:"All",Calendar_Day:"Day",Calendar_Custom:"# Days",Calendar_Week:"Week",Calendar_Month:"Month"},TaskViewModeTextSimple:{Outline:"Outline",List_Flat:"Flat List",Groups_Project:"Projects",Groups_Tag:"Tags",Groups_Contact:"Contacts",Groups_Priority:"Priorities",Agenda_Today:"Agenda",Agenda_Week:"Agenda",Agenda_All:"Agenda",Calendar_Day:"Calendar",Calendar_Custom:"Calendar",Calendar_Week:"Calendar",Calendar_Month:"Calendar"},TaskViewModeIcon:{Outline:"icon-format_list_bulleted",List_Flat:"icon-reorder",Groups_Project:"icon-project",Groups_Tag:"icon-hash",Groups_Contact:"icon-user",Groups_Priority:"icon-exclamation",Agenda_Today:"icon-today",Agenda_Week:"icon-view-groups",Agenda_All:"icon-format_align_justify",Calendar_Day:"icon-view_carousel",Calendar_Custom:"icon-view_week",Calendar_Week:"icon-cal-week",Calendar_Month:"icon-view_comfy"},TaskSortMode:{None:"None",Alphabetical:"Alphabetical",NumItems:"NumItems",Priority:"Priority",Date:"Date",Created:"Created",Completed:"Completed"},TaskSortModeText:{None:"None",Alphabetical:"A-Z",NumItems:"# Items",Priority:"!!!",Date:"Date",Created:"Created",Completed:"Completed"},CalendarMonthViewWeekHeight:150,CalendarMonthViewMonthTitleHeight:50,CalendarMonthViewNumWeeksPad:52,CalendarDayViewNumDaysPad:168,CalendarDayViewMaxAllDayHeight:164,CalendarDayViewBlockHeight:50,CalendarMaxSyncWeeks:52,CalendarMinSyncWeeks:-52,HTTPStatusCode:{Network:0,Success:200,Created:201,PermRedirect:308,BadRequest:400,Unauthorized:401,Forbidden:403,NotFound:404,Timeout:408,Conflict:409,Gone:410,TooMany:429,ServerError:500,BadGateway:502,Unavailable:503,GatewayTimeout:504},PluginAction:{Gmail:{Archive:1,Unarchive:2,Trash:3,Untrash:4,AddLabel:5,RemoveLabel:6,Star:7,Unstar:8,MarkRead:9,MarkUnread:10,SetPriority:11,Move:12,Snooze:13,ScheduleSend:14,DiscardDraft:15}},HelpMode:{None:0,Normal:1,Hotkeys:3},Pricing:{None:-1,EarlyMonthly:0,EarlyYearly:1,RegMonthly:2,RegYearly:3},LoginFlags:{None:0,NewUser:1,OldUserNewTrial:2,TrialOver:4,TrialAutoReset:8},Analytics:{Dimensions:{PremiumStatus:"dimension1"}},Feature:{ClonePane:"clonePane",OAuth:"oauth"},GmailViewMode:{Date:"Date",Priority:"Priority"},MaxGmailSyncTime:{Premium:30,Free:5},MessageListVisibility:{Hide:"hide",Show:"show"},LabelListVisibility:{Hide:"labelHide",Show:"labelShow",ShowIfUnread:"labelShowIfUnread"},GoogleError:{FailedPrecondition:"failedPrecondition",InsufficientPermissions:"insufficientPermissions",Forbidden:"forbidden",DailyLimitExceeded:"dailyLimitExceeded",UserRateLimitExceeded:"userRateLimitExceeded",RateLimitExceeded:"rateLimitExceeded",SharingRateLimitExceeded:"sharingRateLimitExceeded",QuotaExceeded:"quotaExceeded"},GoogleErrorDomain:{UsageLimits:"usageLimits"},KeyboardToolbarHeight:44,KeyboardToolbarMode:{Item:0,Search:1,Modal:2},DocLoadSkipReason:{None:"None",Already:"Already Loading",Main:"Main Not Loaded",Drive:"Drive Not Loaded",NotAuth:"Not Authorized",LoginState:"Not Logged In"},TopBarMode:{Normal:"Normal",Multiselect:"Selected",Contact:"Contacts",Date:"Date",Tag:"Tag",Note:"Note"},AutocompleteMode:{All:"all",Move:"move",Jump:"jump",Item:"item",Email:"email",Contact:"contact",Tag:"tag",Date:"date",Snooze:"snooze",GmailLabel:"gmailLabel"},ContextMenuMode:{Default:0,Archived:1,Drive:2,Gmail:3},ComponentDisplay:{Desktop:1,Mobile:2,Everywhere:3},RequestPriority:{Low:0,Default:50,UserBlocking:100},Orientation:{Vertical:0,Horizontal:1},DragDropPosition:{Above:-1,On:0,Below:1},SetMode:{Toggle:-1,No:0,Yes:1},SelectOption:{Delay:1,DoNothing:2,AllowPrefix:3},DisplayTheme:{Simple:"Classic",OutlineLight:"Light",OutlineHeavy:"Outliner",Markdown:"Markdown",SpacingCompact:"SpacingCompact",SpacingComfortable:"SpacingComfortable",PrefixesFaded:"PrefixesFaded",PrefixesStrong:"PrefixesStrong"},ColorTheme:{Light:"light",Dark:"dark"},LocalWriteReason:{Enabled:-1,DemoMode:1,QuotaError:2,NoLocal:3,NoPermission:4,Generic:5},ConversionID:{Purchase:"ha4uCMXduXUQ6vTp0QM",Signup:"LAulCIvcuXUQ6vTp0QM"},IntroVideoID:"qE14CrQiXwc",Prefix:{Header:"#",Header2:"^",Bullet:"*",Bullet2:"-",Bullet3:"+",Task:"[",Task2:"[]",Task3:"]",Task4:"[ ]",Task5:"(",Task6:"()",Task7:")",Task8:"( )",NumList:"1."},MinimumTokenExpireTime:60,ToastTimeoutDefault:5e3,PrefixWidth:20,PaddingAgendaTime:30,HeightAgendaParents:18,LineLeftPad:5,PrefixItemAutocomplete:"$",TextSpace:"\ufeff",AttachChar:" ",EmbedAttachChar:" ",PerPaneStateField:{Element:"element",OverviewElement:"oelement",Collapsed:"collapsed",CollapsedOverview:"collapsedOverview",CollapsedSearch:"collapsedSearch"},ItemStoreFilter:{None:0,Dates:1,Contacts:2,Priority:4},NumKeys:[a.D1,a.D2,a.D3,a.D4,a.D5,a.D6,a.D7,a.D8,a.D9,a.D0],DatePrefix:"@",ContactPrefix:"+",TagPrefix:"#",TextMDHR:"---",KeyCode:window.KeyCode,KeyCodesModifiers:[a.LeftMeta,a.RightMeta,a.Ctrl,a.Alt,a.Shift],KeyCodesArrows:[a.UpArrow,a.DownArrow,a.LeftArrow,a.RightArrow],PrivateAPIErrorCodes:{Success:0,UnknownFailure:1,Unexpected:2,DatabaseReadError:3,DatabaseWriteError:4,MissingParameter:5,InvalidParameter:6,UnauthorizedUser:7,ErrorSendingEmail:8,AlreadyReferred:9,ErrorContactingRemote:10,BraintreeUnknown:11,InvalidToken:12,InvalidReferralCode:13,NoSignupFound:14,TrialOver:15,RemoteServerError:16,TokenMissing:17,BraintreePaypalBlock:18,BraintreeInvalidCCN:19,AlreadyExists:20,DomainPolicy:21,InvalidCode:22},DocType:{GRealtime:0,GAppData:1},SearchDates:{Overdue:"@overdue",Before:"before:",After:"after:"},Regexp:{Link:/\b((?:(https?|evernote|onenote|bear):\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\))+)*\))(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/g,LinkExc:/(!?)\b((?:(https?|evernote|onenote|bear):\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\))+)*\))(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/g,MDLink:/(!?)\[([^\[]*)\]\((\S+)(\s=\d{0,3}x)?(?=\))\)/g,Prefix:/^(\#+|\^|\-|\*|\[(?: ?\])?|\]|\((?: ?\))?|\)|\+|[0-9]+\.) /gi},ItemProp:{Date:"date",Items:"items",Tags:"tags",Text:"text",Font:"font",Search:"search"},APIKey:"AIzaSyCgYrT1vXClB5Y9lRl0iOTtM4W4aBvLn50",ClientID:"597847337936.apps.googleusercontent.com",DriveFolder:{Root:"root",Attach:"attach",Backup:"backup"},DefaultBackupFrequency:216e5};window.DocType=n.DocType,window.PrivateAPIErrorCodes=n.PrivateAPIErrorCodes,t.a=n},,function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(4),r=i(5),o=i(13),l=i(8),d=i(15),u=i(28),c=i(17),h=(i(32),"start"),f="end";function p(){this._isValid=!1,this._isInRightClick=!1,this._isDirty=!1,this._isWatchingChange=!0,this._isMouseDown=!1,this.isWindowFocused=new l.a(!0),this.hoveredItem=void 0,this.hoveredReactCell=void 0,this._previousSelectedIndex=void 0,this._previousIsValid=void 0,this._selectedMap=[],this.mousePos={x:-1,y:-1},this.mouseDownPos={x:-1,y:-1},this._lastClickTime=0,this._numClicks=0,this._savedPaneSels={},this._itemHighlightPosition=void 0,this.itemHighlightPosition=new l.a,this.pane=new l.a,this.init()}p.prototype={init:function(){this.reset();var e={};e.onMove=this.onMouseMoveMobile.bind(this),document.addEventListener("selectstart",this._onSelectStart.bind(this)),document.addEventListener("selectionchange",this._onSelectionChange.bind(this)),a.default.setupClick(document,this,e),o.a.listen("paneAdded",this.onPaneAdded.bind(this)),o.a.listen("paneRemoved",this.onPaneRemoved.bind(this)),r.a.forceBind("restore",this),r.a.forceBind("onScroll",this),r.a.forceBind("closeKeyboardIfNoSelection",this),r.a.forceBind("_closeKeyboard",this)},reset:function(e,t){if(this._isValid){0;var n=!t&&this.save();n&&(this._previousSelection=n),this._setIndexSide(h,void 0),this._setIndexSide(f,void 0),this._setOffsetSide(h,void 0),this._setOffsetSide(f,void 0),this._dblClickOffsets=void 0,this.preferLineStart=!1,this._mouseOffset=-1,this._mouseMoved=!1,this._isValid=!1,this._isArrowSelectInverted=!1,this._itemHighlightPosition=void 0;var s=this.getPane();!s||s.isUnloaded()||s.isDestroyed()||(s.caretPosition.set(void 0),this._updateSelection()),a.default.keyboardToolbar&&(c.a.reset(),e||i(33).default.isTyping||o.a.fireEvent("closeKeyboard",[]))}},getPreviousSelection:function(){return this._previousSelection},dumpState:function(){var e={isValid:this._isValid,isDirty:this._isDirty,isWatchingChange:this._isWatchingChange,isMouseDown:this._isMouseDown,isWindowFocused:this.isWindowFocused.get(),numClicks:this._numClicks,start:{index:this.startIndex,offset:this.startOffset},end:{index:this.endIndex,offset:this.endOffset}};try{var t=!!this.pane.get();e.paneInfo=t?{hasPane:t,id:this.pane.get().id,numItems:this.pane.get().items.get().length,displayTop:this.pane.get().indexOfTop(),displayCount:this.pane.get().inViewCount()}:"No Pane Set"}catch(t){e.paneInfo="Invalid Pane"}try{void 0!==this.startIndex&&(e.start.item=this.pane.get().items.get()[this.startIndex].id)}catch(t){e.start.item="Invalid Item"}try{void 0!==this.endIndex&&(e.end.item=this.pane.get().items.get()[this.endIndex].id)}catch(t){e.end.item="Invalid Item"}return e},setValid:function(e){if(e){a.default.Assert(!isNaN(this.getStartIndex())&&this.getStartIndex()>=0,"Must have a valid start index when sel is valid: ",this.getStartIndex()),a.default.Assert(!isNaN(this.getEndIndex())&&this.getEndIndex()>=0,"Must have a valid end index when sel is valid: ",this.getEndIndex());try{var t=this.pane.get().items.get()[this.startIndex];a.default.Assert(t&&(a.default.isVMLI(t)||a.default.isVMLI(t.item)),"Valid selection must always be into a VMLI for start item");var i=this.pane.get().items.get()[this.endIndex];a.default.Assert(i&&(a.default.isVMLI(i)||a.default.isVMLI(i.item)),"Valid selection must always be into a VMLI for end item")}catch(e){a.default.reportError(e)}}else this.reset();this._isValid=e},isArrowSelectInverted:function(){return this._isArrowSelectInverted},setArrowSelectInverted:function(e){this._isArrowSelectInverted=e},getStartItem:function(){return this.getPane().itemAtIndex(this.startIndex)},getStartObject:function(){return this.getPane().objectAtIndex(this.startIndex)},getStartOffset:function(){var e;return-1===this.startOffset?(e=this.getStartTotal(),this.startOffset=e):e=this.startOffset,e},getStartIndex:function(){return this.startIndex},getStartTotal:function(){return this.getStartItem().getParsedText().length},getEndItem:function(){return this.getPane().itemAtIndex(this.endIndex)},getEndObject:function(){return this.getPane().objectAtIndex(this.endIndex)},getEndOffset:function(){var e;return-1===this.endOffset?(e=this.getEndTotal(),this.endOffset=e):e=this.endOffset,e},getEndIndex:function(){return this.endIndex},getEndTotal:function(){return this.getEndItem().getParsedText().length},isMouseDown:function(){return this._isMouseDown},_mutateProperty:function(e,t){var i=this[e];this[e]=t,i!==t&&(this._isDirty=!0)},_setIndexSide:function(e,t){this._mutateProperty(e+"Index",t)},_setOffsetSide:function(e,t){if(a.default.settings.selectFullItems()&&this.getStartIndex()!==this.getEndIndex()){var i=e===h?this.getStartIndex():this.getEndIndex(),n=this.getPane().itemAtIndex(i);t=e===h?0:n.getParsedText().length}this._mutateProperty(e+"Offset",t)},setSelection:function(e,t,i,a){this._setIndexSide(h,e),this._setIndexSide(f,i),this._setOffsetSide(h,t),this._setOffsetSide(f,a),this._downIndex=e,this._downOffset={start:t,end:a}},isValid:function(){return this._isValid},checkValid:function(){var e=!1,t=this.getPane();if(t&&this.startIndex>=0&&this.startIndex<t.numItems()&&this.endIndex>=0&&this.endIndex<t.numItems())if(this.getStartItem()&&this.getEndItem()){var i=this.getStartItem().getParsedText(),a=this.getEndItem().getParsedText();this.startOffset>=0&&this.startOffset<=i.length&&this.endOffset>=0&&this.endOffset<=a.length&&(e=!0)}else e=!1;return!e&&this.isValid()&&(log("Sel is now invalid"),this.reset(void 0,!0)),e},getPane:function(){return a.default.Assert(this.pane.get()===a.default.focusedPane,"Should these always match?"),this.pane.get()},clearSelection:function(e){this.reset(e)},onPaneAdded:function(e){e.useCustomScroller,0},onPaneRemoved:function(e){e.useCustomScroller,this.getPane()===e&&this.setFocusedPane(void 0)},onScroll:function(e){var t=a.default.getPaneForElement(e.target);if(this._isMouseDown&&t===this.getPane()&&t.isWriteable&&!i(14).default.isDragging){var n=this.getMousePos();this._mouseOffset=n.y+t.getScrollTop();var s=document.elementFromPoint(n.x,n.y),r={clientX:n.x,clientY:n.y,target:s};this._updateFromMouse(r),this._updateSelection()}},onRightMouseDown:function(e){var t=!a.default.hasClass(e.target,"mdImage"),i=a.default.findParent(e.target,"item")&&a.default.getElementParent(e.target);if(i&&!a.default.findParent(i,"autocompleteItem",2)&&!a.default.hasClass(i,"itemNotInPane")){var n=a.default.getPaneObjectForElement(i);if(n){var s=a.default.getPaneForElement(i),r=n.index;this.isSelected(r,s)&&(t=!1)}}t&&(this._isInRightClick=!0,this.onMouseDown(e,!0),this._isInRightClick=!1)},checkDoubleClick:function(){this._isValid&&this.getStartIndex()===this.getEndIndex()&&this.getStartOffset()!==this.getEndOffset()&&(this._dblClickOffsets={index:this.getStartIndex(),start:this.getStartOffset(),end:this.getEndOffset()}),this._dblClickTimeout=void 0},onMouseDown:function(e,t){var i=a.default.getPaneForElement(e.target);if(this.isWindowFocused.set(!0),a.default.findParent(e.target,"formattingToolbar")||(this._itemHighlightPosition=void 0,this.itemHighlightPosition.set(void 0)),i){this.setFocusedPane(i);var r=e.target,o=i.getInfiniteList();if(!(!i.supportSel||a.default.hasClass(r,"mdImageResizer")||a.default.hasClass(r,"emptyItemAddButton")||a.default.findParent(r,"itemNotInPane")||a.default.hasClass(r,"itemCheckbox")||a.default.hasClass(r,"itemPrefix")||a.default.findParent(r,"searchWrap")||!t&&a.default.hasClass(r,"collapser")||!t&&a.default.hasClass(r,"itemMenuIcon")||!t&&a.default.hasClass(r,"itemEditButton")||a.default.findParent(r,"formattingToolbar"))){t||(this._isMouseDown=!0),this._selectionBeforeBlur=void 0,this.preferLineStart=!1;var l,c=this.mouseDownPos.x,p=this.mouseDownPos.y,g=!1,m=a.default.getElementParent(e.target),v=a.default.findParent(e.target,"line");if(this.mouseDownPos.x=e.pageX,this.mouseDownPos.y=e.pageY,!v&&(v=m&&a.default.findChild(m,"line"))){var _=a.default.offset(v);l=e.clientX>_.left+50||e.clientY>_.top+10?"end":"start"}if(a.default.findParent(r,"paneContent")){if(i&&i.isWriteable&&i.isEditable){if(m&&v){if(t)this._numClicks=1,this._lastClickTime=0,this._dblClickOffsets=void 0;else{var y=Date.now();y-this._lastClickTime<n.a.DoubleClickTime&&Math.abs(e.pageX-this.mouseDownPos.x)<2&&Math.abs(e.pageY-this.mouseDownPos.y)<2&&Math.abs(e.pageX-c)<2&&Math.abs(e.pageY-p)<2?this._numClicks++:(this._numClicks=1,this._dblClickOffsets=void 0),this._lastClickTime=y}var S=d.default.getCursorSelectionRange(e);if(S){0;var w=a.default.getListCellForElement(e.target);if(w&&!w.props.overview){if(this.preferLineStart=e.clientX-a.default.offset(v).left<30,e.shiftKey&&!(s.a.mac&&e.metaKey||!s.a.mac&&e.ctrlKey))this._mouseMoved=!0,this._mouseOffset=e.eventY+i.getScrollTop(),this._updateFromMouse(e);else if(1===this._numClicks||this._numClicks>3){this._downIndex=w.getIndex(),a.default.Assert(this._downIndex>=0,"Must have a valid index in react item"),this._downIndex<0&&a.default.Assert(this._downIndex>=0,"Dead cell error",a.default.getElementPath(S.getStartElement()),a.default.getElementPath(e.target)),this._downItem=w.getItem(),a.default.Assert(this._downItem,"Must have a valid item in react item");var I=S.getSelectOffsetsInElement(m);if(l){var b="start"===l?this._downItem.getPrefixLength():this._downItem.getTextLength();I.start=b,I.end=b}if(0===this._downItem.getParsedTextWithoutPrefix().length?this._downOffset={start:I.total,end:I.total}:this._downOffset={start:I.start,end:I.start},a.default.showMarkdown()&&!this.isSelected(this._downIndex,i)){var A=a.default.findParent(S.getStartContainer(),"mdSpan",2);if(A&&S.getStartOffset()===A.innerHTML.length){for(var D=0,T=A.nextElementSibling,M=0;T&&a.default.hasClass(T,"mdMarkup");){if(D++>5e3&&__infLoop&&__infLoop(D))throw new RangeError;M+=T.innerHTML.length,T=T.nextElementSibling}if(!T){var C=Math.min(this._downOffset.start+M,I.total);this._downOffset={start:C,end:C}}}}this.setSelection(this._downIndex,this._downOffset.start,this._downIndex,this._downOffset.end)}else if(2===this._numClicks){var L=this._downItem.getParsedText(),P=u.a.getPreviousWord(this._downItem,L,this._downOffset.start)+1,E=u.a.getNextWord(this._downItem,L,this._downOffset.end);this._setOffsetSide(h,P),this._setOffsetSide(f,E),this._downOffset={start:P,end:E}}else 3===this._numClicks&&(this._setOffsetSide(h,0),this._setOffsetSide(f,this._downItem.getParsedText().length),this._downOffset={start:0,end:this._downItem.getParsedText().length});g=!0}}}else if(!a.default.findParent(e.target,"paneContent")||a.default.findParent(e.target,"addItemButton")||o.disablePointerEvents.get())0;else{var k=i.indexOfLastItem();k>=0&&(e.shiftKey&&this.isValid()&&!t?this.selectIndices(this.getStartIndex(),this.getStartOffset(),k,-1):this.selectIndex(k,-1),g=!0),e.preventDefault()}this._dblClickTimeout=setTimeout(this.checkDoubleClick.bind(this),0)}}else 0;this.setValid(g&&this.checkValid()),this.isValid()&&(a.default.vmMain.setItemAnimationMode(n.a.ItemAnimationMode.None),this._updateSelection(),a.default.vmMain.resetItemAnimationMode()),o&&o.flushTimeoutPointerEvents()}}},getMousePos:function(){return this.mousePos},onMouseMoveDocument:function(e){this.mousePos.x=e.pageX,this.mousePos.y=e.pageY},onMouseMove:function(e){if(a.default.Assert(!1,"Should not be called on mobile"),this._dblClickTimeout&&(clearTimeout(this._dblClickTimeout),this._dblClickTimeout=void 0),e.target!==document.documentElement&&e.target.parentElement&&!a.default.isDraggingImage){var t=a.default.getPaneForElement(e.target);if(this._isValid&&this._isMouseDown&&t===this.getPane()&&t.supportSel&&t.isWriteable&&!i(14).default.isDragging)return this._mouseMoved=!0,a.default.vmMain.setItemAnimationMode(n.a.ItemAnimationMode.None),this._mouseOffset=e.eventY+t.getScrollTop(),this._updateFromMouse(e),this._updateSelection(),e.preventDefault(),!1}},onMouseMoveMobile:function(e){this.mousePos.x=e.pageX||e.clientX,this.mousePos.y=e.pageY||e.clientY},onMouseUp:function(e){this._isMouseDown=!1,a.default.vmMain&&a.default.vmMain.resetItemAnimationMode();var t=a.default.isAttachedToDoc(e.target)&&a.default.getPaneForElement(e.target)&&a.default.getElementParent(e.target);!t||a.default.hasClass(e.target,"contact")||a.default.hasClass(t,"itemNotInPane")||this.updateCaret(),this._itemHighlightPosition&&this.itemHighlightPosition.set(this._itemHighlightPosition),a.default.cancelRepeatScroll()},focusPane:function(e){this.setFocusedPane(e),this.updateCaret()},setFocusedPane:function(e){if(a.default.Assert(e,"Should not be focusing no pane on mobile"),!e||!a.default.focusedPane||a.default.focusedPane.id!==e.id){var t=a.default.focusedPane;t&&!t.isUnloaded()&&(t.setFocused(!1),t.isEditable&&this.isValid()&&(this._savedPaneSels[t.id]=this.save())),a.default.vmMain.beginUpdateItems(),this.reset(),c.a.reset(t),a.default.focusedPane=e,a.default.focusedItem=e?e.getItem():void 0,this.pane.set(e),t&&t.deactivate(),e&&e.activate(),a.default.vmMain.commitUpdateItems()}},_updateWith:function(e,t,i){var n=t===h?i.getStartElement():i.getEndElement();if(a.default.Assert(n,"Trying to select in invalid container"),n){var s=a.default.getListCellForElement(n),r=a.default.getElementParent(n),o=a.default.getItemForElement(r),l=i.getSelectOffsetsInElement(r),d=t===h?l.start:l.end;a.default.Assert(s.getItem(),"Should not be updating ReactCells without VMLIs"),this._setIndexSide(e,s.getIndex()),this._dblClickOffsets&&s.getIndex()===this._dblClickOffsets.index&&(e===h?d=Math.min(d,this._dblClickOffsets.start):e===f?d=Math.max(d,this._dblClickOffsets.end):a.default.Assert(!1,"Invalid toUpdate value")),this._downOffset.start!==this._downOffset.end&&(d=e===h?u.a.getPreviousWord(o,o.getParsedText(),d)+1:u.a.getNextWord(o,o.getParsedText(),d-1)),this._setOffsetSide(e,d),a.default.Assert(!isNaN(d),"Selection offsets should not be undefined")}},_setSelectionOnSide:function(e,t,i){var a=e===h?f:h;this._setIndexSide(e,t),this._setIndexSide(a,this._downIndex),this._setOffsetSide(e,i),this._setOffsetSide(a,e===h?this._downOffset.start:this._downOffset.end),this.setArrowSelectInverted(t<this._downIndex||t===this._downIndex&&i<this._downOffset.start)},_updateFromMouse:function(e){a.default.Assert(!1,"Should never be reading selection values from mouse on mobile, only accept taps");var t=e.target;if(t){var i=a.default.focusedPane;if(!a.default.getElementParent(t)&&e.clientY<i.contentTop()){if(t=a.default.elementFromPoint(e.clientX,i.contentTop()+1,t),a.default.getElementParent(t)){var n=a.default.getListCellForElement(t),s=a.default.getItemForElement(t);a.default.Assert(s,"If it is an LI it should be an item",t),this._setIndexSide(h,n.getIndex()),this._setOffsetSide(h,0)}}else{var r=a.default.getElementParent(t),o=void 0,l=void 0,u=void 0;if(r){if(a.default.findParent(t,"line")||(t=r.firstElementChild),(u=d.default.getCursorSelectionRange(e))&&u.getStartElement()){var c=a.default.getListCellForElement(t);if(a.default.Assert(c,"Must be able to find a valid reactCell for the start element"),c)if((o=c.getIndex())<0&&a.default.Assert(o>=0,"Dead cell error",a.default.getElementPath(u.getStartElement()),a.default.getElementPath(t)),a.default.findParent(u.getStartContainer(),"line")&&a.default.findParent(u.getEndContainer(),"line"))l=u.getSelectOffsetsInElement(r).start;else o<=this._downIndex?this._setSelectionOnSide(h,o,0):this._setSelectionOnSide(f,o,0)}}else if(i.hasNonVMLIs){var p=a.default.getPaneObjectForElement(t);if(p){var g=p.index;if(g>=0)if(!i.itemAtIndex(g))if(g<this._downIndex){var m=i.indexOfNextVMLI(g);m>=0&&this._setSelectionOnSide(h,m,0)}else{var v=i.indexOfPrevVMLI(g);if(v>=0){var _=i.itemAtIndex(v);this._setSelectionOnSide(f,v,_.getParsedText().length)}}}}else if(a.default.hasClass(t,"paneContent")){0;var y=i.getLastItem();this._setIndexSide(f,i.numItems()-1),this._setOffsetSide(f,y?y.getParsedText().length:0)}if(!isNaN(o)&&!isNaN(l)&&u){var S,w=a.default.findParent(t,"line");if(w)this.preferLineStart=e.clientX-a.default.offset(w).left<30,o<this._downIndex||o===this._downIndex&&l<this._downOffset.start?(S=f,this._updateWith(h,h,u),this.setArrowSelectInverted(!0)):(o>this._downIndex||o===this._downIndex&&l>=this._downOffset.start)&&(S=h,this._updateWith(f,f,u),this.setArrowSelectInverted(!1),l===this._downOffset.start&&(this._isDirty=!0)),void 0!==S&&(this._setIndexSide(S,this._downIndex),this._dblClickOffsets?this._setOffsetSide(S,this._dblClickOffsets[S]):this._setOffsetSide(S,S===h?this._downOffset.start:this._downOffset.end),this.setValid(!0))}}}},setSelectionFromNativeRange:function(e){this._updateWith(h,h,e),this._updateWith(f,f,e),this.setValid(!isNaN(this.getStartIndex())&&!isNaN(this.getEndIndex()))},_updateSelection:function(){var e=this;if(this._isDirty){var t=this.getPane(),i=this.save(),s=this._selectedMap;this.getStartIndex()!==this.getEndIndex()||(this.getStartOffset(),this.getEndOffset());if(this._selectedMap=[],this.setValid(!isNaN(this.getStartIndex())&&!isNaN(this.getEndIndex())),this.getStartIndex()===this.getEndIndex()&&void 0!==this.getStartIndex())a.default.Assert(!isNaN(this.getStartOffset())&&!isNaN(this.getEndOffset()),"Selection offsets should not be undefined"),c.a.setSelected([this.getStartIndex()],t),this._selectedMap[this.getStartIndex()]={start:this.getStartOffset(),end:this.getEndOffset()};else for(var r=0,l=this.getStartIndex();l<=this.getEndIndex();++l){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;var d=!0;a.default.settings.selectFullItems()||(l===this.getStartIndex()?d={start:this.getStartOffset(),end:-1}:l===this.getEndIndex()&&(a.default.Assert(this.getEndOffset()<=this.getEndItem().getParsedText().length,"Selection is past end of text string"),d={start:0,end:this.getEndOffset()})),this._selectedMap[l]=d}if(t){var u=!1;s.forEach(function(i,a){if(void 0===e._selectedMap[a]&&a<t.numItems()){var n=t.itemAtIndex(a);n&&(n.itemChanged.notify(),u=u||t.checkHeightChanged(n,a),0)}}),this._selectedMap.forEach(function(i,n){var r=s[n],o=e._selectedMap[n];if(void 0===r||r.start!==o.start||r.end!==o.end){var l=t.itemAtIndex(n);l&&((!r||o.start!==o.end||r&&r.start!==r.end||a.default.isObject(r)!==a.default.isObject(o))&&l.itemChanged.notify(),u=u||t.checkHeightChanged(l,n),0)}}),u&&(a.default.vmMain.setItemAnimationMode(n.a.ItemAnimationMode.Move),t.updateItems(!1,!0),a.default.vmMain.resetItemAnimationMode())}this.updateCaret(),this._isDirty=!1,o.a.fireEvent("selectionChanged",[i]);var h=this.getStartIndex(),f=this.isValid();if(h===this.getEndIndex()||!f){if(h!==this._previousSelectedIndex||f!==this._previousIsValid){var p=f?this.getStartItem():void 0;o.a.fireEvent("selectedIndexChanged",[h,t,p])}this._previousSelectedIndex=h,this._previousIsValid=f}}},_onSelectStart:function(e){return!i(14).default.isDragging||(e.preventDefault(),!1)},_onSelectionChange:function(e){if(d.default.hasSelection()){if(s.a.android&&i(14).default.isDragging)return void d.default.clearSelection();if(this.getPane().isWriteable)if(s.a.android){if(this.isValid()){var t=this.getStartElement();t===document.activeElement&&this.setSelection(this.getStartIndex(),t.selectionStart,this.getEndIndex(),t.selectionEnd)}}else{var n=d.default.getSelectionRange(),r=n.getStartElement(),o=n.getEndElement();if(r&&o){var l=a.default.findParent(r,"item"),u=a.default.findParent(o,"item");l&&u&&!a.default.hasClass(l,"dead")&&!a.default.hasClass(u,"dead")&&this.setSelectionFromNativeRange(n)}}else this.reset()}a.default.timeoutOnce("closeKeyboardIfNoSelection",this.closeKeyboardIfNoSelection,100)},closeKeyboardIfNoSelection:function(){d.default.hasValidSelection()||this.closeKeyboard()},updateCaret:function(){var e=this.getPane();e&&e.isWriteable&&(this.isValid()&&(!this._isInRightClick&&this.getStartItem()===this.getEndItem()&&this.getStartItem()&&this.getStartItem().isNote()?e.openNoteContextMenu():!a.default.menus.isAutocompleteOpen()&&a.default.menus.isContextMenuOpen()&&a.default.menus.closeContextMenu()))},focusHiddenInput:function(){var e=this.getPane();if(e&&e.isEditable&&e.hiddenInput){var t=d.default.createSelectionRange(),i=e.hiddenInput,n=0,s=1,r=e.scrollElement,o=r.scrollLeft,l=r.scrollTop;if(this.isValid()){var u=this.getStartItem().getParsedText();i.innerHTML=a.default.escape(u),n=this.getStartOffset(),s=this.getStartItem()===this.getEndItem()?this.getEndOffset():this.getStartOffset()}i.firstChild&&0!==i.firstChild.length||(i.innerHTML=TextSpace);var c=i.firstChild;a.default.Assert(c,"Empty element must have a valid child");try{i.focus(),t.setStart(c,n),t.setEnd(c,s),d.default.setSelectionRange(t)}catch(e){a.default.reportError(e)}r.scrollLeft=o,r.scrollTop=l}},isSelected:function(e,t){return t===this.getPane()&&!!this._selectedMap[e]},getSelectionAtIndex:function(e){return this._selectedMap[e]},selectIndex:function(e,t,i,a){return void 0===i&&(i=t),this.selectIndices(e,t,e,i,a)},selectIndices:function(e,t,i,r,o){if(a.default.Assert(e>=0,"Must supply a valid start index"),a.default.Assert(i>=0,"Must supply a valid end index"),a.default.Assert(i>e||i===e&&(r>=t||-1===r),"Must not pass reversed selection"),!(e<0||i<0)){var l,d,u=!1,h=this.getPane();if(h&&h.isWriteable&&(l=h.itemAtIndex(e),d=h.itemAtIndex(i),a.default.Assert(l,"Trying to select invalid start index"),a.default.Assert(d,"Trying to select invalid end index"),l&&d&&o!==n.a.SelectOption.AllowPrefix)){var f=l.getPrefixLength(),p=d.getPrefixLength();t>=0&&t<f&&(t=f),r>=0&&r<p&&(r=p)}if(l&&d&&(this.isValid(),1)){if(this.setSelection(e,t,i,r),a.default.Assert(!isNaN(this.getStartOffset())&&!isNaN(this.getEndOffset()),"Selection offsets should not be undefined"),!isNaN(this.getStartOffset())&&this.getStartOffset()>=0&&!isNaN(this.getEndOffset())&&this.getEndOffset()<=this.getEndTotal()&&(s.a.android&&o===n.a.SelectOption.Delay||this._updateSelection()),o!==n.a.SelectOption.DoNothing)if(s.a.android&&o===n.a.SelectOption.Delay)c.a.setSelected([e],h,!0),a.default.timeoutOnce("selectAfterEnter",function(){var a=h.elementAtIndex(e),n=h.elementAtIndex(i);this.selectElements(a,t,n,r),c.a.clearEditables(h),this._updateSelection()}.bind(this),0);else{var g=h.elementAtIndex(e),m=h.elementAtIndex(i);g&&m&&(a.default.clearTimeoutOnce("selectAfterEnter"),this.selectElements(g,t,m,r))}u=!0}else this.updateCaret();return u}},selectItem:function(e,t,i){return a.default.Assert(a.default.isNumber(t),"Must pass a valid start offset"),a.default.Assert(a.default.isNumber(i)||void 0===i,"Must pass a valid end offset"),void 0===i&&(i=t),this.selectItems(e,t,e,i)},selectItems:function(e,t,i,n){a.default.Assert(a.default.isVMLI(e),"Should only be passing VMLIs to start this fn"),a.default.Assert(a.default.isVMLI(i),"Should only be passing VMLIs to end this fn");var s=this.getPane();if(s){var r=s.indexOfItem(e);a.default.Assert(r>=0,"Must be able to find the start item in the pane");var o=s.indexOfItem(i);return a.default.Assert(o>=0,"Must be able to find the end item in the pane"),this.selectIndices(r,t,o,n)}},selectElements:function(e,t,i,n){a.default.Assert(!a.default.isVMLI(e),"Should not be passing VMLIs to start this fn"),a.default.Assert(!a.default.isVMLI(i),"Should not be passing VMLIs to end this fn"),this._isWatchingChange=!1,s.a.android&&(e=e.firstElementChild,i=i.firstElementChild);var r=!1,o=d.default.getOffsetChildElement(e,t),l=d.default.getOffsetChildElement(i,n);return a.default.Assert(o&&o.element&&!isNaN(o.offset),"Start element is invalid"),a.default.Assert(l&&l.element&&!isNaN(l.offset),"End element is invalid"),o&&o.element&&l&&l.element&&(d.default.setSelection(o.element,o.offset,l.element,l.offset),r=!0),this._isWatchingChange=!0,r},save:function(){if(this._isValid){var e=this.getPane();if(!e.isDestroyed()&&!e.isUnloaded())return a.default.Assert(!isNaN(this.getStartIndex()),"Start index must be valid"),a.default.Assert(!isNaN(this.getEndIndex()),"End index must be valid"),{pane:e,startIndex:this.getStartIndex(),startItem:this.getStartItem(),startObject:this.getStartObject(),startOffset:this.getStartOffset(),endIndex:this.getEndIndex(),endItem:this.getEndItem(),endObject:this.getEndObject(),endOffset:this.getEndOffset()}}},restore:function(e){var t=!1;return e&&!e.pane.isDestroyed()&&(a.default.Assert(e.pane,"Must have a valid pane to restore selection to"),a.default.focusedPane=e.pane,a.default.focusedItem=e.pane.getItem(),this.pane.set(e.pane),e=e.pane.adjustSelectionFromPaneObject(e)),e&&e.startItem&&e.endItem?(this.selectIndices(e.startIndex,e.startOffset,e.endIndex,e.endOffset),t=!0):this.reset(),t},scrollStartIntoView:function(e){this._isValid&&(a.default.Assert(!isNaN(this.getStartIndex()),"Start index must be valid"),a.default.Assert(!isNaN(this.getEndIndex()),"End index must be valid"),a.default.focusedPane.scrollIndexIntoView(this.getStartIndex(),e?ScrollDuration.Snap:ScrollDuration.Default))},scrollEndIntoView:function(){this._isValid&&(a.default.Assert(!isNaN(this.getStartIndex()),"Start index must be valid"),a.default.Assert(!isNaN(this.getEndIndex()),"End index must be valid"),a.default.focusedPane.scrollIndexIntoView(this.getEndIndex(),ScrollDuration.Default))},onWindowBlur:function(e){this.isWindowFocused.set(!1)},onWindowFocus:function(e){this.isWindowFocused.set(!0)},getSelectedObjects:function(e){var t=0;if(!this._isValid)return[];for(var i=[],a=this.getPane(),n=this.getStartIndex();n<=this.getEndIndex();++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=a.objectAtIndex(n),r=s.item;!r||!e&&r.isNote()||i.push(s)}return i},getSelectedItems:function(e){var t=0;if(!this._isValid)return[];for(var i=[],a=this.getPane(),n=this.getStartIndex();n<=this.getEndIndex();++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=a.itemAtIndex(n);!s||!e&&s.isNote()||i.push(s)}return i},getStartElement:function(){if(this._isValid&&!isNaN(this.getStartIndex()))return this.getPane().elementAtIndex(this.getStartIndex())},getEndElement:function(){if(this._isValid&&!isNaN(this.getEndIndex()))return this.getPane().elementAtIndex(this.getEndIndex())},setHovered:function(e,t,i){if(this.hoveredReactCell!==i){var a=this.hoveredItem;this.hoveredItem=t,this.hoveredReactCell=i,a&&a.itemChanged.notify(),t&&t.itemChanged.notify()}},isReactCellHovered:function(e){return this.hoveredReactCell===e},isItemHovered:function(e){return this.hoveredItem===e},insertTextAtCaret:function(e,t){this.pane.get().updateSelectionAndroid({target:this.getStartElement()}),a.default.Assert(this.getStartIndex()===this.getEndIndex(),"Cannot insert text in multiselect");var i=this.getStartIndex(),n=this.getStartItem(),s=this.getStartOffset(),r=this.getEndOffset(),o=n.getRawText();s!==r&&(o=o.substr(0,s)+o.substr(r,o.length-r)),t&&s>0&&" "!==o[s-1]&&(o=a.default.insertIntoText(o," ",s),s++),o=a.default.insertIntoText(o,e,s),s+=e.length,n.setText(o,!0,ChangeType.Local),this.selectIndex(i,s)},closeKeyboard:function(){a.default.batchRenderUpdates(this._closeKeyboard)},_closeKeyboard:function(){this.reset(),a.default.blurActiveElement()},fireKeyEvent:function(e,t,i){this.fireKeyEventInternal(e,"keydown",t),this.fireKeyEventInternal(e,"keypress",i||t),this.fireKeyEventInternal(e,"keyup",t)},fireKeyEventInternal:function(e,t,i){if(a.default.Assert(void 0!==i,"Must pass in valid key data to type"),e||(e=this.getStartElement()),document.createEvent&&e){var n=document.createEvent("Event");n.normCode=i.normCode,n.shiftKey=!!i.shiftKey,n.altKey=!!i.altKey,n.ctrlKey=!!i.ctrlKey,n.metaKey=!!i.metaKey,n.synthetic=!0,n.initEvent(t,!0,!0),e.dispatchEvent(n)}else e?a.default.Assert(!1,"Unable to fire key event"):a.default.Assert(!1,"No element available to fire key event on")},fireClickEvent:function(e,t){this.fireClickEventInternal(e,"mousedown",t),this.fireClickEventInternal(e,"mouseup",t),this.fireClickEventInternal(e,"mouseclick",t)},fireClickEventInternal:function(e,t,i,n){if(a.default.Assert(void 0!==i,"Must pass in a valid button to click with"),e||(e=d.default.getSelectionNode()),document.createEvent&&e){var s=document.createEvent("Event");if(s.button=i,s.synthetic=!0,n)for(var r in n)n.hasOwnProperty(r)&&(s[r]=n[r]);s.initEvent(t,!0,!0),e.dispatchEvent(s)}else e?a.default.Assert(!1,"Unable to fire click event"):a.default.Assert(!1,"No element available to fire click event on")},fireMouseUp:function(e,t){this.fireClickEventInternal(e,"mouseclick",t)}},t.a=new p},function(e,t,i){"use strict";var a=i(5),n=i(35),s=i(1),r=i(8);function o(){a.a.forceBind("normalizeKeys",this),a.a.forceBind("getKeyCode",this),this.versionRequired=[],this.versionAvailable=[],this.versionRequired[AppPlatform.iOS]=4,this.versionAvailable[AppPlatform.iOS]=6,this.versionRequired[AppPlatform.Android]=4,this.versionAvailable[AppPlatform.Android]=5,this.versionRequired[AppPlatform.WinPhone]=1,this.versionAvailable[AppPlatform.WinPhone]=1,this.versionRequired[AppPlatform.Chrome]=1,this.versionAvailable[AppPlatform.Chrome]=2,this.versionRequired[AppPlatform.Electron]=1,this.versionAvailable[AppPlatform.Electron]=2,this.versionMobile=2,this.versionDesktop=13,this.versionMobileMessages={},this.versionDesktopMessages={},this.appSubVersion=void 0,this.setDeployEnvironments(),this.appStoreLinks=[],this.appStoreLinks[AppPlatform.iOS]="https://itunes.apple.com/us/app/moo.do-organize-your-way/id889830074?ls=1&mt=8",this.appStoreLinks[AppPlatform.Android]="https://play.google.com/store/apps/details?id=moo.do",this.appStoreLinks[AppPlatform.WinPhone]=void 0,this.appStoreLinks[AppPlatform.Chrome]="https://chrome.google.com/webstore/detail/moodo/iffimmolghilclfndeiebgppddmagofk",this.appStoreLinks[AppPlatform.Electron]="https://github.com/MooDoApp/MooDoApp.github.io/releases/latest",this.appReviewLinks=[],this.appReviewLinks[AppPlatform.iOS]=void 0,this.appReviewLinks[AppPlatform.Android]=void 0,this.appReviewLinks[AppPlatform.WinPhone]=void 0,this.appReviewLinks[AppPlatform.Chrome]=void 0,this.appReviewLinks[AppPlatform.Electron]=void 0,this.appPlatform=void 0,this.appStoreLink=void 0,this.appReviewLink=void 0,this.requireCustomRedirect=!1,this.requireCustomPurchase=!1,this.requireCustomPaypal=!1,this.bodyClass=void 0,this.b=document.documentElement,this.orientation=Orientation.Portrait,this.onResize=new n.a,this.kbsizePortrait=Math.ceil(this.getActualWindowHeight()/2),this.kbsizeLandscape=void 0,this.kbsize=new r.a(this.kbsizePortrait),this.appState=void 0,this.isHosted=!1,this.hostedBy=void 0,this.initStorageQuota={quota:NaN,usage:NaN},this.isNearStorageQuota=!1,this.pageVisibilityHidden=void 0,this.pageVisibilityChange=void 0,this._allowNativeNotifications=!0,this.isPhantom=!1,this.isDevURL="localhost"===window.location.hostname||"dev.moo.do"===window.location.hostname||"beta.moo.do"===window.location.hostname,this.isBeta="beta.moo.do"===window.location.hostname,this._features={},this.init(),this._windowWidth=new r.a(this.getActualWindowWidth()),this._windowHeight=new r.a(this.getActualWindowHeight()),this.app&&(this.customRedirectState={app:!0,appv:this.appv,webview:this.getAppState("webview")}),this.app||this.android?this.keyboardOpenTime=200:this.winphone?this.keyboardOpenTime=200:this.mobileie?this.keyboardOpenTime=600:this.keyboardOpenTime=0}window.Orientation={Portrait:0,Landscape:1},window.PlatformConfig={DesktopWindows:0,DesktopMac:1,DesktopOther:2,ChromeApp:3,AndroidBrowser:4,AndroidApp:5,iOSBrowser:6,iOSApp:7,WinPhoneBrowser:8,WinPhoneApp:9,MobileOther:10,Unknown:11,EmbedDesktopApp:12,EmbedMobileApp:13,ElectronMac:14,ElectronWindows:15,ElectronUnknown:16},window.AppPlatform={iOS:0,Android:1,WinPhone:2,Chrome:3,Embed:4,Electron:5},window.EmbedApps={Mailbird:"mailbird"},window.DeployVariable={Environment:"Environment",APIHost:"APIHost",APIProtocol:"APIProtocol"},o.prototype={getDeployVar:function(e){return this.deployEnvironment[e]},setDeployEnvironments:function(){this.deployEnvironment={},"dev.moo.do"===window.location.hostname?(this.deployEnvironment[DeployVariable.Environment]="dev",this.deployEnvironment[DeployVariable.APIProtocol]="https:",this.deployEnvironment[DeployVariable.APIHost]="//api-dev.moo.do"):"beta.moo.do"===window.location.hostname?(this.deployEnvironment[DeployVariable.Environment]="beta",this.deployEnvironment[DeployVariable.APIProtocol]="https:",this.deployEnvironment[DeployVariable.APIHost]="//api-beta.moo.do"):"localhost"===window.location.hostname?(this.deployEnvironment[DeployVariable.Environment]="local",this.deployEnvironment[DeployVariable.APIProtocol]="https:",this.deployEnvironment[DeployVariable.APIHost]="//api-dev.moo.do"):(this.deployEnvironment[DeployVariable.Environment]="mobile",this.deployEnvironment[DeployVariable.APIProtocol]="https:",this.deployEnvironment[DeployVariable.APIHost]="//api.moo.do")},getKBSize:function(){var e=this.kbsize.get();return!e||isNaN(e)||e<100?400:e},setKBSize:function(e){this.kbsize.set(parseInt(e))},windowWidth:function(e){if(!this._windowWidth.get()&&!e){var t=i(0).default;t&&t.Assert&&t.Assert(!1,"Window width was not set",this._windowWidth.get(),this._windowHeight.get()),this._windowWidth.set(this.getActualWindowWidth())}return this._windowWidth.get()},windowHeight:function(e){if(!this._windowHeight.get()&&!e){var t=i(0).default;t&&t.Assert&&t.Assert(!1,"Window height was not set",this._windowWidth.get(),this._windowHeight.get()),this._windowHeight.set(this.getActualWindowHeight())}return this._windowHeight.get()},setWindowSize:function(e,t){this._windowWidth.set(e),this._windowHeight.set(t)},getLocaleInfo:function(e){try{e.lang=navigator.language||navigator.userLanguage}catch(t){e.lang="EXCEPTION"}},getPlatformInfo:function(e){e.os=this.OSName,e.browser=this.browser,e.majorVersion=this.majorVersion,e.minorVersion=this.minorVersion,e.appVersionRequired=this.versionRequired[this.appPlatform],e.app=this.app,e.appPlatform=this.appPlatform,e.standalone=this.standalone,e.packagedApp=this.packagedApp,e.requireCustomRedirect=this.requireCustomRedirect,e.requireCustomPurchase=this.requireCustomPurchase,e.requireCustomPaypal=this.requireCustomPaypal,e.isMobile=this.mobile,e.isMobileBrowser=this.isMobileBrowser,e.isPhone=this.phone,e.isTouch=this.touch,e.isTouchDevice=this.isTouchDevice,e.usePointerEvents=this.usePointerEvents,e.kbsize=this.kbsize.get(),e.appState=this.appState,e.isHosted=this.isHosted,e.hostedBy=this.hostedBy,e.embed=this.embed,e.bodyClass=this.b.className,e.rawUA=navigator.userAgent,e.referrer=document.referrer,e.devicePixelRatio=window.devicePixelRatio,e.pageVisibilityChange=!!this.pageVisibilityChange,e.appSubVersion=this.appSubVersion,e.initStorageQuota=this.initStorageQuota,e.isNearStorageQuota=this.isNearStorageQuota,this.getLocaleInfo(e)},getUserPlatformConfig:function(){var e=PlatformConfig.Unknown,t=location.pathname.replace(/\//g,"")+(this.isBeta?",beta":"");if(this.app)switch(this.appPlatform){case AppPlatform.iOS:e=PlatformConfig.iOSApp;break;case AppPlatform.Android:e=PlatformConfig.AndroidApp;break;case AppPlatform.WinPhone:e=PlatformConfig.WinPhoneApp;break;case AppPlatform.Chrome:e=PlatformConfig.ChromeApp;break;case AppPlatform.Electron:e="Windows"===this.OSName?PlatformConfig.ElectronWindows:"MacOS"===this.OSName?PlatformConfig.ElectronMac:PlatformConfig.ElectronUnknown;break;case AppPlatform.Embed:e=this.mobile?PlatformConfig.EmbedMobileApp:PlatformConfig.EmbedDesktopApp}else switch(this.OSName){case"Windows":e=this.phone?PlatformConfig.WinPhoneBrowser:PlatformConfig.DesktopWindows;break;case"iPad":case"iPod":case"iPhone":e=PlatformConfig.iOSBrowser;break;case"MacOS":e=PlatformConfig.DesktopMac;break;case"Android":e=PlatformConfig.AndroidBrowser;break;case"ChromeOS":case"Linux":default:e=this.phone?PlatformConfig.MobileOther:PlatformConfig.DesktopOther}return e+=","+t},getAppDownloadURL:function(){return this.appDownloadUrl||(this.ios?this.appDownloadUrl=this.appStoreLinks[AppPlatform.iOS]:this.android?this.appDownloadUrl=this.appStoreLinks[AppPlatform.Android]:this.appDownloadUrl="https://www.moo.do/download/"),this.appDownloadUrl||"https://github.com/MooDoApp/MooDoApp.github.io/releases/latest"},supportsNativeApp:function(){switch(this.OSName){case"Windows":case"MacOS":return!this.mobile;default:return!1}},isNativeApp:function(){return this.appPlatform===AppPlatform.Electron},isNativeMac:function(){return this.isNativeApp()&&this.mac},isNativeMacFullscreen:function(){return this.isNativeApp()&&this.mac&&!window.screenTop&&!window.screenY},canDownloadNativeApp:function(){return this.supportsNativeApp()&&!this.isNativeApp()},isChromeApp:function(){return this.appPlatform===AppPlatform.Chrome},canDownloadChromeApp:function(){return!(this.mobile||this.supportsNativeApp()||this.isChromeApp()||this.isNativeApp())},init:function(){var e=this;this.initAppState(),this.initHostState(),this.initFeatures();var t,n,r=navigator.userAgent,o="";if(this.OSName="Unknown OS",this.app&&(o+=" app"),-1!==r.indexOf("Win")?(this.OSName="Windows",this.windows=!0,-1!==r.indexOf("Windows Phone")?(this.phone=!0,this.touch=!0,this.mobile=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.WinPhone],this.app&&(this.appPlatform=AppPlatform.WinPhone)):this.appStoreLink=this.appStoreLinks[AppPlatform.Electron]):-1!==r.indexOf("iPad")?(this.OSName="iPad",this.ios=!0,this.ipad=!0,this.phone=!0,this.touch=!0,this.mobile=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.iOS],this.app&&(this.appPlatform=AppPlatform.iOS)):-1!==r.indexOf("iPhone")?(this.OSName="iPhone",this.ios=!0,this.iphone=!0,this.phone=!0,this.mobile=!0,this.touch=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.iOS],this.app&&(this.appPlatform=AppPlatform.iOS)):-1!==r.indexOf("iPod")?(this.OSName="iPod",this.ios=!0,this.ipod=!0,this.phone=!0,this.mobile=!0,this.touch=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.iOS],this.app&&(this.appPlatform=AppPlatform.iOS)):-1!==r.indexOf("Mac")?(this.OSName="MacOS",this.mac=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.Electron]):-1!==r.indexOf("X11")?-1!==r.indexOf("CrOS")?(this.OSName="ChromeOS",this.chromeOS=!0):(this.OSName="UNIX",this.unix=!0):-1!==r.indexOf("Android")?(this.OSName="Android",this.android=!0,this.touch=!0,this.mobile=!0,this.phone=!0,this.appStoreLink=this.appStoreLinks[AppPlatform.Android],this.app&&(this.appPlatform=AppPlatform.Android),o+=" android"):-1!==r.indexOf("Linux")&&(this.OSName="Linux",this.linux=!0),this.ios){if(this.ios7=-1!==r.indexOf("OS 7"),this.ios70=-1!==r.indexOf("OS 7_0"),this.ios71=-1!==r.indexOf("OS 7_1"),this.ios10=-1!==r.indexOf("OS 10"),this.ios11=-1!==r.indexOf("OS 11"),this.appState)"ioswk"===this.appState.webview?this.ioswk=!0:this.iosui=!0,this.appState.oauth&&this._enableFeature(s.a.Feature.OAuth);this.ios7&&(o+=" ios7")}if(this.majorVersion=1e3,this.minorVersion=1e3,-1!==r.indexOf("MSIE")||-1!==r.indexOf("Trident"))this.browser="Trident",this.ie=!0,this.winphone=!!r.match(/IEMobile/i),null!==(this.winphone||"Microsoft Internet Explorer"===navigator.appName?new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})"):new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})")).exec(r)?this.majorVersion=parseFloat(RegExp.$1):null!==new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(r)&&(this.majorVersion=parseFloat(RegExp.$1));else if(-1!==r.indexOf("Chrome")||-1!==r.indexOf("CriOS")){this.browser="Chrome",this.isChrome=!0,null!==new RegExp("Chrome/([0-9]{1,}).").exec(r)&&(this.majorVersion=parseFloat(RegExp.$1)),-1!==r.indexOf("Edge")&&(this.ieEdge=!0),this.app&&this.appPlatform!==AppPlatform.Android&&(this.appPlatform=AppPlatform.Chrome,this.requireCustomPaypal=!0)}else if(-1!==r.indexOf("Android")){this.browser="Native Android",null!==new RegExp("Linux; Android ([0-9]{1,}).([0-9]{1,}).").exec(r)&&(this.majorVersion=parseFloat(RegExp.$1),this.minorVersion=parseFloat(RegExp.$2))}else if(-1!==r.indexOf("Firefox")){this.browser="Firefox",this.isFirefox=!0,null!==new RegExp("Firefox/([0-9]{1,}).").exec(r)&&(this.majorVersion=parseFloat(RegExp.$1))}else if(-1!==r.indexOf("Safari")||"iPad"===this.OSName||"iPhone"===this.OSName||"iPod"===this.OSName){this.browser="Safari",this.safari=!0,null!==(this.mobile?new RegExp("OS ([0-9]{1,})_([0-9]{1,})"):new RegExp("Version/([0-9]{1,}).([0-9]{1,}).")).exec(r)&&(this.majorVersion=parseFloat(RegExp.$1),this.minorVersion=parseFloat(RegExp.$2))}else-1!==r.indexOf("Opera")&&(this.browser="Opera");if(r.indexOf("Electron")>=0&&r.indexOf("Moo.do")>=0){if(this.app=!0,this.appPlatform=AppPlatform.Electron,o+=" electron",null!==new RegExp("Moo\\.do/([^\\s]+)\\s").exec(navigator.userAgent)){var l,d=function(e,t){for(var i=0,a=e.split("."),n=t.split("."),s=0;s<3;s++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=+a[s],o=+n[s];if(r>o)return 1;if(o>r)return-1;if(!isNaN(r)&&isNaN(o))return 1;if(isNaN(r)&&!isNaN(o))return-1}return 0},u=RegExp.$1;d(u,"1.1.3")<=0&&setTimeout(function(){var t=i(0).default;t.toasts.pushMessage({text:"A new version of this app is available with important fixes. Future versions will update themselves, but please download this one manually.",hold:!0,holdOnAction:!0,actionText:"DOWNLOAD",action:function(){t.openUrl(e.getAppDownloadURL())}})},2e3),l=d(u,"1.1.0")>=0?2:1,this.appv=l}this.mac&&(o+=" electronMac"),this.appState||(this.appState={}),this.appState.appType||(this.appState.appType="electron"),this.appStoreLink=this.appStoreLinks[AppPlatform.Electron],this.requireCustomPurchase=!0,this._enableFeature(s.a.Feature.OAuth)}if(this.appReviewLink=this.appReviewLinks[this.appPlatform],this.isTouchDevice=!!("ontouchstart"in window||window.navigator.msMaxTouchPoints),this.isMobileBrowser=this.checkMobileBrowser(),this.usePointerEvents=!!window.navigator.msPointerEnabled,this.useCustomScroller=!!this.iosui,this.isTouchDevice&&this.isMobileBrowser&&(this.usePointerEvents?(this.touchStartEvent="MSPointerDown",this.touchMoveEvent="MSPointerMove",this.touchEndEvent="MSPointerUp",this.touchCancelEvent="MSPointerCancel"):(this.touchStartEvent="touchstart",this.touchMoveEvent="touchmove",this.touchEndEvent="touchend",this.touchCancelEvent="touchcancel")),this.usePointerEvents?(this.downEvent="MSPointerDown",this.moveEvent="MSPointerMove",this.upEvent="MSPointerUp"):(this.downEvent="mousedown",this.moveEvent="mousemove",this.upEvent="mouseup"),a.a.hasURLParam("touch","false")?(this.touch=!1,this.phone=!1,this.mobile=!1,this.ios=!1,this.android=!1):(this.isTouchDevice&&this.isMobileBrowser||a.a.hasURLParam("touch","true"))&&(this.touch=!0,this.phone=!0,this.mobile=!0),this.windows&&(o+=" windows",this.ie&&(o+=" ie",this.demo||(this.mobro=this.isMobro()))),"Firefox"===this.browser&&(o+=" firefox"),this.safari&&(o+=" safari"),this.phone&&(o+=" phone"),this.ipad&&(o+=" ipad"),this.embed===EmbedApps.Mailbird&&(o+=" mailbird",this.isMailbirdSidebar()&&(o+=" mailbirdSidebar")),this.demo&&(o+=" demoMode"),this.mobileie=this.ie&&this.mobile,this.isChrome&&this.app&&(this.isPackagedApp=!0),this.cmdChar=this.mac?"⌘":"ctrl",this.priModKey=this.mac?"⌘":"Ctrl",this.secModKeyForce=this.mac?"⌃":"Alt",this.secModKey=this.app?this.priModKey:this.secModKeyForce,this.noErrorStacks="iPad"===this.OSName||"iPhone"===this.OSName||"iPod"===this.OSName,this.standalone=!!window.navigator.standalone||window.navigator.userAgent.indexOf("FluidApp")>=0,(this.standalone||this.app||this.mobro)&&(this.requireCustomRedirect=!0),o&&o.length>0&&(this.bodyClass=o,this.b.className+=o),this.URL=window.URL||window.webkitURL,this.supportBlobURLIFrame=!(this.ie||this.ieEdge||this.ios10||this.ios11),this.transition=this.addPrefix("transition"),this.animation=this.addPrefix("animation"),this.transform=this.addPrefix("transform"),this.transformOrigin=this.addPrefix("transformOrigin","transform-origin"),this.userSelect=this.addPrefix("userSelect","user-select"),window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame||function(e){clearTimeout(e)},this.ie&&(document.documentElement.addEventListener("MSHoldVisual",function(e){e.preventDefault()},!1),document.documentElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1)),document.documentElement.addEventListener("keydown",this.normalizeKeys,!0),document.documentElement.addEventListener("keypress",this.normalizeKeys,!0),document.documentElement.addEventListener("keyup",this.normalizeKeys,!0),void 0!==document.hidden?(t="hidden",n="visibilitychange"):["moz","ms","webkit"].forEach(function(e){if("undefined"!==document[e+"Hidden"])return t=e+"Hidden",n=e+"visibilitychange",!1}),void 0!==t&&(this.pageVisibilityHidden=t,this.pageVisibilityChange=n),this.initRedirectString(),this.supportsEstimatedStorage()){this.estimateAvailableStorage(function(e){this.initStorageQuota=e,e.usage/e.quota>.9&&(this.isNearStorageQuota=!0)}.bind(this),function(){})}},updateBodyClass:function(){this.bodyClass&&(document.body.className+=this.bodyClass)},supportsNotifications:function(){return this.supportsNativeNotifications()||this.supportsHTML5Notifications()},supportsNativeNotifications:function(){var e=!1;return this._allowNativeNotifications&&(this.app&&this.appPlatform!==AppPlatform.Electron?(this.ios||this.android||this.isChrome)&&(e=!0):this.embed===EmbedApps.Mailbird&&(e=!0)),e},supportsHTML5Notifications:function(){return"Notification"in window},usesHTML5Notifications:function(){return!this.supportsNativeNotifications()&&this.supportsHTML5Notifications()},hasNotificationPermission:function(){return!this.usesHTML5Notifications()||"granted"===Notification.permission},disallowNativeNotifications:function(){this._allowNativeNotifications=!1},supportsPersistedStorage:function(){var e=!1;return"storage"in navigator&&"persist"in navigator.storage&&(e=!0),e},requestStoragePersistence:function(e,t){navigator.storage.persisted().then(function(i){i?e():navigator.storage.persist().then(e,t)})},isStoragePersisted:function(e){this.supportsPersistedStorage()?navigator.storage.persisted().then(e):setTimeout(e,0,!1)},supportsNativePromises:function(){return!!window.Promise},supportsEstimatedStorage:function(){var e=!1;return"storage"in navigator&&"estimate"in navigator.storage?e=!0:"webkitTemporaryStorage"in navigator&&"queryUsageAndQuota"in navigator.webkitTemporaryStorage&&(e=!0),e&&this.supportsNativePromises()},estimateAvailableStorage:function(e,t){this.supportsEstimatedStorage()?this._estimateAvailableStorage().then(e,t):setTimeout(t,0)},_estimateAvailableStorage:function(){return"storage"in navigator&&"estimate"in navigator.storage?navigator.storage.estimate():"webkitTemporaryStorage"in navigator&&"queryUsageAndQuota"in navigator.webkitTemporaryStorage?new Promise(function(e,t){navigator.webkitTemporaryStorage.queryUsageAndQuota(function(t,i){e({usage:t,quota:i})},t)}):Promise.resolve({usage:NaN,quota:NaN})},supportsWebworkers:function(){var e=!1;return window.Worker&&(e=!0),e},supportsNativeDownload:function(){return this.isNativeApp()&&this.appv>=2},supportsIDBWebworkers:function(){var e=!1;if(this.supportsWebworkers())switch(this.browser){case"Firefox":e=this.majorVersion>=37;break;case"Chrome":e=this.majorVersion>=24}return e},supportsPassiveListeners:function(){if(void 0===this._supportsPassiveListeners){var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){e=!0}});window.addEventListener("test",null,t)}catch(e){}this._supportsPassiveListeners=e}return this._supportsPassiveListeners},addPassiveListener:function(e,t,i){this.supportsPassiveListeners()?e.addEventListener(t,i,{passive:!0}):e.addEventListener(t,i)},isMobro:function(){var e,t=null;try{new ActiveXObject("")}catch(t){e=t.name}try{t=!!new ActiveXObject("htmlfile")}catch(e){t=!1}return!(t="ReferenceError"===e||!1!==t)},normalizeKeys:function(e){void 0!==e.normCode&&(e.synthetic||e instanceof KeyboardEvent)||(e.normCode=this.getKeyCode(e))},getKeyCode:function(e){var t;return 46===(t=null===e.keyCode||0===e.keyCode?null!==e.charCode?e.charCode:e.which:e.keyCode)&&"keypress"===e.type&&(t=190),t},initAppState:function(){var e=location.hash.substring(1);if(e)for(var t,n=0,s=/([^&=]+)=([^&]*)/g;null!==(t=s.exec(e));){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if("state"===decodeURIComponent(t[1])){var r=decodeURIComponent(t[2]);if(r){try{e=JSON.parse(r)}catch(t){log("Error parsing AppState: ",r),i(0).default.reportError(t),e=void 0}e&&(this.app=!0===e.app,this.appv=e.appv,this.debugApp=e.debug,this.live=e.live,this.offline=e.offline,this.syncContacts=e.syncContacts,this.test=e.test,this.embed=e.embed,this.appState=e)}break}}this.live=this.live||a.a.hasURLParam("live","true"),this.test=!1,this.offline=this.offline||this.test||a.a.hasURLParam("offline","true")||!1,this.demo=a.a.hasURLParam("demo","true")||!1,this.script=a.a.hasURLParam("script"),this.app=this.app||!1},getAppState:function(e){return this.appState?this.appState[e]:void 0},_enableFeature:function(e){this._features[e]=!0},_disableFeature:function(e){this._features[e]=!1},initFeatures:function(){this._enableFeature(s.a.Feature.ClonePane)},isMailbirdSidebar:function(){return this.embed===EmbedApps.Mailbird&&"true"===this.getAppState("sidebar")},checkMobileBrowser:function(){var e,t=!1;if(this.android&&this.app)t=!0;else if(!this.embed&&(e=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od|ad)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0),!t)){window.matchMedia&&window.matchMedia("(max-device-width: 620px)").matches&&(t=!0)}return t},initHostState:function(){try{this.isHosted=window.self!==window.top}catch(e){this.isHosted=!0}this.isHosted&&(this.hostedBy=document.referrer)},initRedirectString:function(){var e,t;e=this.isDevURL||this.app&&this.debugApp||!this.app&&this.standalone?window.location.host:"www.moo.do",t=!this.app||this.appPlatform!==AppPlatform.Chrome&&this.appPlatform!==AppPlatform.Electron?"app/":"oauthRelay.html",this.customRedirectString=window.location.protocol+"//"+e+"/"+t},addPrefix:function(e,t){var i="",a=["ms","webkit","moz","o"],n=this.b.style;if(t||(t=e),"string"==typeof n[e])i="";else for(var s=0,r=0;r<a.length;r++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;if("string"==typeof n["-"+a[r]+"-"+t]){i=a[r];break}}var o=i.length>0?e.charAt(0).toUpperCase()+e.slice(1):e;return i?{prop:"-"+i+"-"+t,style:i+o,react:(i.length>0?i.charAt(0).toUpperCase()+i.slice(1):e)+o}:{prop:e,style:o,react:o}},blockClient:function(){if(!this.app)return{needsApp:!0};switch(this.browser){case"Firefox":if(this.majorVersion<16)return{platform:"Firefox",browser:this.browser,update:!0};break;case"Chrome":if(this.majorVersion<26)return{platform:"Chrome",browser:this.browser,update:!0};break;case"Native Android":if(this.majorVersion<4)return{platform:"Native Android",browser:"NativeAndroid",update:!0};break;case"Opera":return{platform:this.browser,browser:this.browser,update:!1};case"Trident":if(this.majorVersion<10)return{platform:"Internet Explorer",browser:this.browser,update:!0};break;case"Safari":if(this.mobile&&this.majorVersion<6)return{platform:"Safari",browser:this.browser,update:!0};if(!this.mobile&&(6===this.majorVersion&&this.minorVersion<1||this.majorVersion<6))return{platform:"Safari",browser:this.browser,update:!0}}if(this.app){if(this.appv<this.versionRequired[this.appPlatform]){log("App Version out of date.");var e={version:this.versionRequired[this.appPlatform]};return this.ios?(e.update=!0,e.platform="iOS App"):this.android?(e.update=!0,e.platform="Android App"):i(0).default.nativeBridge.sendToApp("updateRequired"),e}if(this.appv>this.versionAvailable[this.appPlatform])return log("App is newer than the javascript, forcing an app cache update: "+this.appv+" vs. "+this.versionAvailable[this.appPlatform]),{cacheUpdate:!0}}},actionVerb:function(){return this.touch?"tap":"click"},actionVerbCaps:function(){return this.touch?"Tap":"Click"},updateOrientation:function(){return this.orientation=90===Math.abs(window.orientation)?Orientation.Landscape:Orientation.Portrait,this.app||this.kbsize.set(this.orientation===Orientation.Portrait?this.kbsizePortrait:this.kbsizeLandscape),this.orientation},isPageVisible:function(){return!this.pageVisibilityHidden||!document[this.pageVisibilityHidden]},getUpdateMessages:function(e){for(var t=0,i=[],a=this.mobile?"versionMobile":"versionDesktop",n=(e||0)+1;n<=this[a];n++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=this[a+"Messages"][n];s&&i.push(s)}return i},isFeatureEnabled:function(e){return this._features[e]},recordAppSubVersion:function(e){this.appSubVersion=e},getPlatformName:function(){return this.mac?"Mac":this.windows?"Windows":this.iphone?"iPhone":this.ipad?"iPad":this.android?"Android":"Chrome"},getPlatformIcon:function(){return this.mac||this.iphone||this.ipad?"icon-apple":this.windows?"icon-windows":this.android?"icon-android":"icon-chrome"},getActualWindowWidth:function(){return document.body&&document.body.clientWidth||this.android&&window.screen&&window.screen.width||0},getActualWindowHeight:function(){return document.body&&document.body.clientHeight||this.android&&window.screen&&window.screen.height||0},displayRepeatedOptionalUpdateMessage:function(){if(this.appPlatform===AppPlatform.Chrome){var e,t=this.appv<this.versionAvailable[AppPlatform.Chrome],a=i(0).default.vmMain,n="DOWNLOAD";"ChromeOS"===this.OSName?t&&(e="The Moo.do app is out of date. Please update it in the Chrome Web Store.",n="UPDATE"):this.supportsNativeApp()&&(a.shouldShowHelp("getNativeApp")?(a.closeHelp("getNativeApp"),e="You might like to use the new Moo.do native application. Download it now!."):t&&(e="The Moo.do app is out of date. You might like to use the new Moo.do native application, or please update in the Chrome Web Store.")),e&&a.toasts.pushMessage({text:e,action:MessageAction.OpenURL,actionText:n,data:{url:this.getAppDownloadURL()}})}},hasBetaFeatures:function(){return this.isDevURL}},t.a=new o},function(e,t,i){"use strict";window.URLPart={Search:1,Hash:2};var a,n={demo:URLPart.Hash,login:URLPart.Hash,user:URLPart.Hash,premium:URLPart.Hash,ispremium:URLPart.Hash,access_token:URLPart.Hash,error:URLPart.Hash,expires_in:URLPart.Hash,expires_at:URLPart.Hash,issued_at:URLPart.Hash,scope:URLPart.Hash,token_type:URLPart.Hash,id_token:URLPart.Hash,data:URLPart.Hash,script:URLPart.Hash,dmode:URLPart.Hash,jasmine:URLPart.Hash,touch:URLPart.Hash,noverify:URLPart.Hash,file:URLPart.Hash,sinfo:URLPart.Hash,panes:URLPart.Hash,offline:URLPart.Hash,live:URLPart.Hash,test:URLPart.Hash,nolocal:URLPart.Hash,nosync:URLPart.Hash,rdebug:URLPart.Hash,rsession:URLPart.Hash,versionError:URLPart.Hash,invite:URLPart.Hash,state:URLPart.Search,swupdate:URLPart.Hash},s={getItem:function(){},setItem:function(){},removeItem:function(){},clear:function(){}};try{a=window.localStorage||s}catch(e){a=s}function r(){}function o(e,t){e===URLPart.Search?window.location.search=t:e===URLPart.Hash&&(window.location.hash=t)}function l(e){return e===URLPart.Search?window.location.search:e===URLPart.Hash?self.overrideHash||window.location.hash:void 0}function d(e){return n[e]}function u(){}r.prototype={hasURLParam:function(e,t){var i=e+"=";t&&(i+=t);var a=d(e);return a||log("Invalid URL Part"),l(a).indexOf(i)>=0},getURLParam:function(e,t){var i=t||d(e);if(i===URLPart.Search){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a=new RegExp('[\\?&]" + key + "=([^&#]*)').exec(window.location.href);return null===a?void 0:decodeURIComponent(a[1].replace(/\+/g," "))}if(i!==URLPart.Hash)log("Invalid URL part");else for(var n,s=0,r=l(URLPart.Hash).substring(1),o=/([^&=]+)=([^&]*)/g;n=o.exec(r);){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;if(decodeURIComponent(n[1])===e)return decodeURIComponent(n[2])}},insertURLParam:function(e,t,i){var a=0;e=encodeURIComponent(e),t=encodeURIComponent(t);for(var n=d(e),s=l(n).substr(1).split("&"),r=s.length-1;r>=0;r--){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var u=s[r].split("=");if(u[0]==e){u[1]=t,s[r]=u.join("=");break}}r<0&&(s[s.length]=[e,t].join("=")),o(n,s.join("&")),n!==URLPart.Hash||i||window.location.reload()},removeURLParam:function(e,t){for(var i=0,a=d(e=encodeURIComponent(e)),n=l(a).substr(1).split("&"),s=n.length-1;s>=0;s--){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(n[s].split("=")[0]==e){n.splice(s,1),o(a,n.join("&")),a!==URLPart.Hash||t||window.location.reload();break}}},forceBind:function(e,t){var i=t[e].bind(t);return t[e]=i,i},binder:function(e){var t=0;for(var i=1;i<arguments.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=arguments[i];e[a]=e[a].bind(e)}},destroy:function(e){0},extend:function(e,t){if(t)for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},inherit:function(e,t){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype._super=e.prototype},defineBase:function(e){e.prototype.constructor=e},genPromise:function(e){e.then=function(e,t,i){},e.execute=function(e,t,i){}},storage:{getItem:(a.getItem||function(e,t){return this.get(e,t||u)}).bind(a),setItem:(a.setItem||function(e,t){var a={};a[e]=t;try{this.set(a)}catch(e){log("LocalStorageError: ",e),i(0).default.reportError(e)}}).bind(a),removeItem:(a.removeItem||function(e,t){this.remove(e,t)}).bind(a),clear:(a.clear||function(e){this.clear(e)}).bind(a)}};var c=new r;t.a=c},function(e,t,i){"use strict";i.r(t);var a=i(0),n=i(5),s=i(1),r=i(9),o=i(58),l=i.n(o),d=i(4);function u(e){a.default.Assert(a.default.isObject(e),"Should always supply a valid object to init a contact"),this.id=e.id,this.type="contact",this.text=e.text||"",this.phoneNumbers=e.phoneNumbers||[],this.emails=e.emails||[],this.init()}u.prototype={init:function(){for(var e=0,t=0,i=0;i<this.phoneNumbers.length;i++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;this.phoneNumbers[i].link=this.formatPhone(this.phoneNumbers[i].number),this.phoneNumbers[i].type=this.phoneNumbers[i].type[0]}for(i=0;i<this.emails.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this.emails[i].link="mailto:"+this.emails[i].address}},_phoneRegex:/^(?:\+?1[-. ]?)?(?:\(?([0-9]{3})\)?[-. ]?)?([0-9]{3})[-. ]?([0-9]{4})$/,formatPhone:function(e){if(this._phoneRegex.test(e)){var t=e.match(this._phoneRegex),i="";return t[1]&&(i+="+1-"+t[1]+"-"),"tel:"+(i+=t[2]+"-"+t[3])}var n=e.replace(/\D+/g,"");return a.default.Assert(n&&""!==n,"Invalid phone number format: "+e),e.startsWith("+")&&(n="+"+n),"tel:"+n}};var c=u,h=(i(8),i(23));function f(){this._contactCache={},this._contacts=new h.a,this._contactsByName={},this._contactNames={___info___:{count:0}},this.init()}f.prototype={init:function(){},loadContacts:function(e,t){a.default.Assert(0===this._contacts.get().length,"Should only load contacts once");var i=!1;if(e){for(var n=0,s=[],r=0;r<e.length;++r){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var o=e[r];if(o.name&&(o.text=o.name,e[r].text=o.name,delete e[r].name,i=!0),!t&&o.isDemo||o.text&&!o.phoneNumbers&&!o.emails)i=!0;else{if(o.text){var l=a.default.escape(o.text);this._contactNames[l]="",this._contactsByName[o.text]=o,s.push(o)}a.default.Assert(o.id,"Each contact must have a valid id")}}s.sort(this.contactComparator),this._contactNames.___info___.count=s.length,this._contacts.set(s)}else this.clearContacts();return i},addContact:function(e){a.default.Assert(e.id,"Incoming contacts must have a valid id"),a.default.Assert(e.text,"All contacts are expected to have a text");var t=this._contactsByName[e.text];if(e.emails){for(var i=0,n=[],s=0;s<e.emails.length;s++){var r=0;if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;for(var o=e.emails[s],l=!1,d=0;d<n.length;d++){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;if(n[d].address.toLowerCase()===o.address.toLowerCase()){l=!0;break}}l||n.push(o)}e.emails=n}if(t)e.emails&&(t.emails||(t.emails=[]),t.emails.pushOnlyUniques(e.emails,this.emailComparator)),e.phoneNumbers&&(t.phoneNumbers||(t.phoneNumbers=[]),t.phoneNumbers.pushOnlyUniques(e.phoneNumbers,this.phoneComparator));else{if(this._contacts.insertSorted(e,this.contactComparator),e.text){var u=a.default.escape(e.text);this._contactNames[u]="",this._contactsByName[e.text]=e}this._contactNames.___info___.count=this._contacts.get().length}this._contactCache[e.id]&&(this._contactCache[e.id]=new c(e))},updateContact:function(e){var t=0;a.default.Assert(e.id,"Incoming contacts must have a valid id"),a.default.Assert(e.text,"All contacts are expected to have a text");for(var i=!1,n=0;n<this._contacts.get().length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=this._contacts.get()[n];if(s.id===e.id){s.text=e.text,s.emails=s.phoneNumbers=void 0,this.addContact(e),i=!0;break}}if(!i)return this.addContact(e),!0},clearContacts:function(){this._contactCache={},this._contacts.clear(),this._contactsByName={},this._contactNames={___info___:{count:0}}},numContacts:function(){var e=this._contacts.get().length;return a.default.Assert(e===this._contactNames.___info___.count,"Contact names count should match contacts value"),e},getContacts:function(){return this._contactNames},getAll:function(){return this._contacts.get()},contactComparator:function(e,t){return e.text&&t.text?e.text.localeCompare(t.text):e.text&&!t.text?1:!e.text&&t.text?-1:void 0},emailComparator:function(e,t){return e.address.toLowerCase()===t.address.toLowerCase()},emailComparatorSort:function(e,t){return e.address&&t.address?e.address.toLowerCase().localeCompare(t.address.toLowerCase()):e.address&&!t.address?1:!e.address&&t.address?-1:void 0},phoneComparator:function(e,t){return e===t||e.number===t.number},ensureCacheObject:function(e){if(a.default.Assert(e,"Must have valid data to store in cache"),this._contactCache[e.id])return this._contactCache[e.id];var t=new c(e);return this._contactCache[e.id]=t,t},findMatchExact:function(e){var t=this._contactsByName[e];if(t)return this.ensureCacheObject(t)},findMatchLike:function(e,t){var i=0;a.default.Assert(void 0!==e,"Must provide a valid contact part");for(var n=e.toUpperCase(),s=[],r=this._contacts.get(),o=0;o<r.length;++o){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var l=r[o],d=!1;if(l.text.toUpperCase().indexOf(n)>=0&&(d=!0),l.emails)for(var u=0,c=0;!d&&c<l.emails.length;++c){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;if(l.emails[c].address.toUpperCase().indexOf(n)>=0){d=!0;break}}if(l.phoneNumbers){var h=0;for(c=0;!d&&c<l.phoneNumbers.length;++c){if(h++>5e3&&__infLoop&&__infLoop(h))throw new RangeError;if(l.phoneNumbers[c].number.indexOf(n)>=0){d=!0;break}}}if(d&&(s.push(this.ensureCacheObject(l)),s.length>=t))break}return s.sort(this.contactComparator),s},findContactByEmail:function(e){for(var t=0,i=0;i<this._contacts.get().length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=this._contacts.get()[i];if(a.emails)for(var n=0,s=0;s<a.emails.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(a.emails[s].address===e)return a}}},findEmailsLike:function(e,t){var i=0;a.default.Assert(void 0!==e,"Must provide a valid email part"),t=t||20;for(var n=[],s=e.toUpperCase(),r=0;r<this._contacts.get().length;++r){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var o=this._contacts.get()[r];if(o&&o.emails){var l=0,d=!1;o.text&&o.text.toUpperCase().indexOf(s)>=0&&(d=!0);for(var u=0;u<o.emails.length;++u){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;var c=o.emails[u].address;(d||c.toUpperCase().indexOf(s)>=0)&&n.push({type:"contact",text:o.text,email:c})}}if(n.length>=t)break}return n.sort(this.emailComparatorSort),n}};var p=f,g=i(21),m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},v={pendingRemoteUpdates:{},itemCache:{},dbDataCache:{},loadedItemCount:0,hasLocalData:!1,freezeUpdates:!1,hasMadeInMemoryOnlyUpdate:!1,dbClosed:!1,overQuota:!1,dbi:void 0,contactManager:new p};function _(e,t){var i=a.default.fieldMapValidators[e];return i&&i(t)||void 0===t||null===t}v.forEachModel=function(e){for(var t in a.default.Assert(e,"Must pass a valid function to iterate on"),v.itemCache)v.itemCache[t]&&e(v.itemCache[t])},v.getModel=function(e){return a.default.Assert(a.default.isString(e),function(){return"ID must be a valid string: "+a.default.getObjectInfo(e)}),a.default.Assert(e,"Tried to get a model with an invalid id"),v.itemCache[e]},v.setModel=function(e){a.default.Assert(e,"Tried to set an invalid model"),a.default.Assert(e.id,"Tried to set a model with an invalid id"),a.default.Assert(a.default.isString(e.id),function(){return"ID must be a valid string: "+a.default.getObjectInfo(e.id)}),a.default.Assert(void 0===v.itemCache[e.id],"Must not be replacing a model with another copy"),v.itemCache[e.id]=e},v.clearModel=function(e){a.default.Assert(a.default.isString(e),function(){return a.default.getObjectInfo(e)}),a.default.Assert(void 0!==v.itemCache[e],"Must not clear a model that does not exist"),v.itemCache[e]=void 0},v.getItem=function(e){return a.default.Assert(a.default.isString(e),function(){return"ID must be a valid string:"+a.default.getObjectInfo(e)}),a.default.Assert(e,"Tried to get an item that doesn't exist"),v.dbDataCache[e]},v.setItem=function(e,t){a.default.Assert(a.default.isString(e),function(){return"ID must be a valid string: "+a.default.getObjectInfo(e)}),a.default.Assert(e,"Tried to set an item with an invalid id"),a.default.Assert(void 0===v.dbDataCache[e]||void 0===t,"Must not be replacing an item with another copy"),v.dbDataCache[e]=t},v.validateItemData=function(e){try{for(var t in e){var i=_(t,e[t])||!1;a.default.Assert(i,"Invalid data set in item: ",t,"=",e[t],m(e[t])),i||v.fixItemData(e,t)}}catch(e){v.reportError(e)}},v.fixItemData=function(e,t){var i=!1,n=a.default.fieldMapFixer[t];if(n){var s=n(e[t]);log("Value Fixed: ",e[t],"->",s),e[t]=s,a.default.Assert(_(t,s),"Fixed field must always be valid"),i=!0}return i},v.clearItems=function(){v.dbDataCache={},v.itemCache={}},v.clearPlugins=function(){a.default.vmMain.pluginManager.onClearData()},v.getRootItem=function(){return v.rootId?v.getItem(v.rootId):void 0},v.getRootModel=function(){return v.rootId?v.getModel(v.rootId):void 0},v.createVMLI=function(e,t){return a.default.vmMain.itemStoreManager.getDefaultItemStore().createItemRaw(e,t)},v.createTempVMLI=function(e,t){return t.noSave=!0,t.canDestroy=!0,a.default.vmMain.itemStoreManager.getTempItemStore().createItemRaw(e,t)},v.destroyTempVMLI=function(e){a.default.vmMain.itemStoreManager.getTempItemStore().destroyItem(e)},v.initializeIndexedDB=function(e){var t=3;function i(i){i&&l.a?l.a.open({server:"duchess",version:t,schema:{items:{key:{keyPath:"id"}},settings:{},caches:{key:{keyPath:"cid"}}}}).done(function(t){v.dbi=t;try{t.handleDisconnect(function(e){log("DB Disconnect Event: ",e)})}catch(e){a.default.reportError(e)}for(var i=0;i<y.length;++i)y[i](!0);y=[],e()}).fail(function(t){try{log("Error loading local DB client - "+t.target.error.name+": "+t.target.error.message)}catch(e){log("Error loading local DB client - Invalid Error Message")}a.default.preventLocalWrites(s.a.LocalWriteReason.Generic),"Firefox"===d.a.browser?t.target&&t.target.error&&"InvalidStateError"===t.target.error.name||a.default.reportError(new Error("DB Load Failure"),t):"Safari"===d.a.browser&&t.target&&t.target.error&&"DBOpenError"===t.target.error.name||a.default.reportError(new Error("DB Load Failure"),t),"VersionError"===t.target.error.name&&(n.a.hasURLParam("versionError")||a.default.AppCache.runOnFinish(function(){n.a.insertURLParam("versionError",!0)},!0)),e()}):(a.default.preventLocalWrites(s.a.LocalWriteReason.Generic),e())}window.indexedDB&&void 0!==window.indexedDB.onIsReady&&null!==window.indexedDB.onIsReady?window.indexedDB.onIsReady(i):setTimeout(function(){i(!0)},0)},v.getDBState=function(e){e.dbClosedUnexpected=v.dbClosed,e.hasLocalData=v.hasLocalData,e.hasMadeInMemoryOnlyUpdate=v.hasMadeInMemoryOnlyUpdate};var y=[];v.onCachesAvailable=function(e){v.dbi?e(!0):a.default.shouldWriteLocal()?y.push(e):e(!1)},v.openCacheDatabase=function(e,t,i,a){var n=function(){l.a?l.a.open({server:e,version:t,schema:i}).done(function(e){a(e)}).fail(function(e){a(void 0)}):a(void 0)};window.indexedDB&&void 0!==window.indexedDB.onIsReady&&null!==window.indexedDB.onIsReady?n():setTimeout(n,0)};var S={};v.openCacheTable=function(e){if(v.dbi)return S[e]=void 0===S[e]?1:S[e]+1,v.dbi.caches},v.closeCacheTable=function(e){a.default.Assert(S[e]>0,"Must have previously opened the cache to close it"),S[e]--};var w,I=!1;function b(){}function A(e,t){if(t&&t.target){var i=t.target.error;if(i){log("Transaction Error Info: ",i.type,i.name,i.code,i.message);var n="QuotaExceededError"===i.name||4===i.code;"InvalidStateError"===i.name||n?v.notifyDBUnexpectedClose(n):a.default.reportError(new Error("IDB Transaction Error"),i)}else a.default.reportError(new Error("Unexpected transaction error A"),t)}else a.default.reportError(new Error("Unexpected transaction error B"),t)}v.localDataLoaded=function(){return I},v.loadFromIndexedDB=function(e){if(a.default.Assert(!I,"Should never load local data twice"),ShouldLog(LogLevels.Timing)&&log("Loading DB: ",log.now()),v.dbDataCache={},a.default.shouldWriteLocal())if(v.dbi&&v.dbi.items){var t,i,n=!1,r=!1,o=window.__preload,l=function(t){a.default.Assert(!r,"Should only process load results once"),r=!0,ShouldLog(LogLevels.Timing)&&log("Loaded DB: ",log.now()),v.loadedItemCount=0;for(var i=0;i<t.length;++i){var s=n?t[i]:a.default.translateObjOut(t[i]);t[i]&&t[i].id&&s&&(v.setItem(t[i].id,s),v.loadedItemCount++)}if(v.dbi.settings){var l=function(t){a.default.criticalErrorReported()||(I=!0,t&&(a.default.Assert(v.getItem(t.root),"If there is a root item defined there should be a corresponding local item"),v.rootId=t.root),e&&e())};o.settingsPreload&&o.settingsPreload.root?l(o.settingsPreload.root):v.dbi.settings.get("root").done(l).fail(e)}else log("Unable to load local settings DB"),e&&e()};o?o.mainLoaded=!0:o=window.__preload={mainLoaded:!0};var d=function(e){i=Date.now(),t&&log("Time preload blocked: ",i-t),clearTimeout(o.mainTimeout),o.mainTimeout=void 0,o.dataResults=void 0,e?l(e):(n=!1,o.onDataLoaded=void 0,v.dbi.items.query().all().fastExecute().done(l))};o.runDataLoad?(n=!0,o.dataResults?(console.log("Preload data available"),d(o.dataResults)):(console.log("Blocked on preload"),t=Date.now(),o.onDataLoaded=d,o.mainTimeout=setTimeout(function(){a.default.reportError(new Error("Preload timeout")),a.default.Assert(!o.dataResults,"Should not have results defined"),n=!1,o.onDataLoaded=void 0,v.dbi.items.query().all().fastExecute().done(l)},15e3))):(console.log("Preload skipped"),v.dbi.items.query().all().fastExecute().done(l))}else log("Unable to load local items DB - db not connected"),I=!0,a.default.preventLocalWrites(s.a.LocalWriteReason.Generic),e&&e();else log("Unable to load local items DB - already disabled"),I=!0,e&&e()},v.beginTransaction=function(){a.default.shouldWriteLocal()&&(w={})},v.transactionUpdate=function(e,t){if(a.default.Assert(a.default.shouldWriteLocal(),"Should never be writing during a transaction if local writes are disabled"),w[e])for(var i in t)w[e][i]=t[i];else w[e]=t},v.notifyDBUnexpectedClose=function(e){var t;e?(a.default.toasts.pushMessage(MessageID.QuotaError),v.overQuota=!0,t=s.a.LocalWriteReason.QuotaError):(a.default.toasts.pushMessage(MessageID.LocalWritesDisabled),t=s.a.LocalWriteReason.Generic),a.default.preventLocalWrites(t),v.dbClosed=!0,a.default.Assert(a.default.vmMain&&a.default.vmMain.pluginManager,"Should always have a plugin manager when reporting DB quota error"),a.default.vmMain&&a.default.vmMain.pluginManager&&e&&a.default.vmMain.pluginManager.onCacheLimitExceeded()},v.endTransaction=function(){if(a.default.shouldWriteLocal()&&v.dbi&&v.dbi.items){0;try{v.dbi.items.updateObject(w).done(b).fail(A)}catch(e){a.default.reportError(e),A()}}else void 0!==w&&a.default.reportError(new Error("Started a transaction and stopped writes halfway through"));w=void 0},v.hasPendingDBTransaction=function(){return!!w},v.dbUpdateItem=function(e){if(!v.freezeUpdates){v.hasLocalData||a.default.isLoadingRemote||e.skipLocalModification||(v.hasLocalData=!0);var t=e.changes||{},i=e.id?e.id:t.id,n=e.callback,s=e.saveFlags;a.default.Assert(s===SaveFlag.None||s===SaveFlag.Prop||s===SaveFlag.Text||s===SaveFlag.All);var r=v.getItem(i);if(a.default.shouldWriteLocal()){var o,l;if(a.default.Assert(!s||void 0===t.modifiedOffline&&void 0===t.modifiedOfflineText,"Shouldn't be setting a modified flag while passing them in with changes"),a.default.isFlagSet(s,SaveFlag.Prop))a.default.Assert(void 0===t.modifiedOffline,"Shouldnt be passing in a value and assigning "+t.modifiedOffline),t.modifiedOffline=!0,(l=v.getModel(i))&&(l.modifiedOffline=!0);if(a.default.isFlagSet(s,SaveFlag.Text))a.default.Assert(void 0===t.modifiedOfflineText,"Shouldnt be passing in a value and assigning "+t.modifiedOfflineText),t.modifiedOfflineText=!0,(l=v.getModel(i))&&(l.modifiedOfflineText=!0);if(r){for(var d in t){if(t.hasOwnProperty(d))r[d]=t[d]}v.validateItemData(r),o=a.default.translateObjIn(r)}else{a.default.Assert(t.id,"Item being modified does not already exist as expected",t),v.setItem(i,t),o=a.default.translateObjIn(t)}if(w)a.default.Assert(!n,"Callbacks not supported for updates inside of a transaction"),v.transactionUpdate(i,o);else try{n?v.dbi.items.update(o).done(n).fail(n):v.dbi.items.update(o)}catch(e){"InvalidStateError"===e.name?v.notifyDBUnexpectedClose(!1):a.default.reportError(e)}}else{if(r)for(var d in t)t.hasOwnProperty(d)&&(r[d]=t[d]);else v.setItem(i,t);v.hasMadeInMemoryOnlyUpdate=!0,n&&n()}}},v.dbDeleteItem=function(e,t){if(!v.freezeUpdates&&(v.setItem(e,void 0),a.default.shouldWriteLocal()))try{t?v.dbi.items.remove(e).done(t).fail(t):v.dbi.items.remove(e)}catch(e){a.default.reportError(e)}},v.setRoot=function(e){if(!v.freezeUpdates){if(a.default.shouldWriteLocal())try{v.dbi.settings.update({key:"root",item:{root:e}})}catch(e){a.default.reportError(e)}return v.rootId=e,v.getRootItem()}},v.setPluginData=function(e){var t=Object.keys(e),n=i(68).default;n.clearGapiData();for(var s=0;s<t.length;++s){var r=t[s],o=a.default.vmMain.pluginManager.getPlugin(r),l=e[r].data;l&&(n.setGapiData(r,l),o&&o.forceLoad())}};var D=0,T={};v.demoDataId=void 0,v.loadDemoData=function(e,t,n){var r=i(68).default;if(v.demoDataId=e,r.areRemoteFunctionsHooked()||r.hookRemoteFunctions(),t||void 0===e||""===e||void 0===T[e]){var o=function(i){var s,r;i&&(s=i[0],r=i[1]),r&&(t&&v.clearPlugins(),v.setPluginData(r)),s&&(t&&(a.default.vmMain.itemStoreManager.runForEachStore(function(e){e.clearStore()}),v.clearItems()),function e(t){t.id||(t.id="demo"+D++),v.setItem(t.id,t);var i=t.note;i&&(i.id||(i.id="demo"+D++),e(i),t.note=i.id);var a=t.items;if(a){for(var n=[],s=0;s<a.length;++s)a[s].id||(a[s].id="demo"+D++),n.push(a[s].id),e(a[s]);t.items=n}}(s),v.setRoot(s.id),T[e]={root:s,plugins:r},I=!0,n&&n(s.id))};e?r.loadRemoteData(e,o):(a.default.Assert(!1,"Test data must be defined using #data=XXX.YYY in URL"),o([{text:s.a.RootItemName,items:[]}]))}else{log("Use Preloaded demo data: ",e);var l=T[e];v.setRoot(l.root.id),l.plugins&&v.setPluginData(l.plugins),n&&n(l.root.id)}};var M=!1;function C(e){var t=v.getItem(e);if(t){var i=t.items;if(i)for(var a=0;a<i.length;++a)C(i[a]);v.dbDeleteItem(t.id)}}v.initData=function(e){if(M)return!1;M=!0,ShouldLog(LogLevels.Timing)&&log("Initializing User Item Data",log.now());try{a.default.isDemoMode()?setTimeout(function(){var t=n.a.getURLParam("data");v.loadDemoData(t,!1,e)},0):(a.default.checkpoint(Checkpoint.InitData),v.initializeIndexedDB(function(){v.loadFromIndexedDB(function(){a.default.checkpoint(Checkpoint.DBLoaded),v.checkLocalIntegrity(function(t){v.loadLocalContacts(),t&&t.error&&a.default.reportError(new Error("Error during local integrity check")),e()})})}))}catch(e){a.default.reportError(e)}return!0},v.initializeItem=function(e){a.default.Assert(e.shouldSave(),"Item must be marked as saveable");var t=e.id,i=!t||a.default.isLocalItem(e)||!e.data;if(i){var n=r.a.createNewItem(e,e.hasChildren(),e.hasArchivedChildren());0,t&&t!==n&&v.modifyItemId(t,n);for(var s=!1,o=e.numItems(),l=0;l<o;++l){var d=v.initializeItem(e.itemAtIndex(l));s=s||d}if(e.hasArchivedChildren()){var u=e.archivedItems(!0);for(l=0;l<u.length;++l){d=v.initializeItem(u[l]);s=s||d}}if(e.hasNote()){d=v.initializeItem(e.getNote());s=s||d}if(r.a.initializeNewItem(e),t&&t!==n){var c=e.parent();c&&g.a.saveItemLocal(c,null,SaveFlag.None)}}return i},v.checkLocalIntegrity=function(e){ShouldLog(LogLevels.Timing)&&log("Checking Local: ",log.now());var t=!1;v.ensureLocalCache(function(){ShouldLog(LogLevels.Timing)&&log("Verifying Local Data",log.now());var i=!1,n={};for(var s in v.dbDataCache)if(v.dbDataCache.hasOwnProperty(s)&&v.getItem(s)){((f=v.getItem(s)).i||f.t)&&(log("%cInvalid local properties on item: ","color: red",f),t=!0),n[f.id]?n[f.id].exist?(log(f.id,": Duplicated IDs in the local database",f),t=!0):(n[f.id].exist=!0,n[f.id].del=!!f.isDeleted):n[f.id]={exist:!0,ref:!1,del:!!f.isDeleted},f.id===v.rootId&&(i&&(log(f.id,": Multiple roots present locally",f),t=!0),i=!0,n[f.id].isRoot=!0),void 0===f.text&&(log("Found item with no text",f.id),f.text="",v.dbUpdateItem({id:s,changes:{text:""},saveFlags:SaveFlag.None})),f.note&&(n[f.note]?n[f.note].ref?(log(f.id,": Item note is used twice - ",f.note),t=!0):n[f.note].ref=f.id:n[f.note]={exist:!1,ref:f.id});for(var r=0;f.items&&r<f.items.length;++r){var o=-1;if(f.items[r]){var l=f.items[r],d=v.getItem(l);if(d){if(d.isArchived&&(o=r),o>=0&&!d.isArchived){log(l,": Unarchived child found after an archived one"),log("   ",f.id,": Parent with incorrectly ordered children"),t=!0;var u=f.items.removeAt(o);f.items.insert(r,u),o=r,v.dbUpdateItem({id:f.id,changes:{items:f.items},saveFlags:SaveFlag.None})}}else log(l,": Child does not have a valid reference on our local database"),t=!0;if(n[l])if(n[l].ref)log(l,": Item is referenced locally multiple times: ",d?v.getItem(l).id:"UNDEFINED"),log("   ",n[l].ref,": ",v.getItem(n[l].ref).id),log("   ",f.id,": <CLIENTDATA>"),t=!0,(p=f.items).removeAt(r),v.dbUpdateItem({id:s,changes:{items:p},saveFlags:SaveFlag.None});else n[l].ref=f.id;else n[l]={exist:!1,ref:f.id}}else log(f.id,": Invalid item in local items array"),t=!0}}for(var c in!i&&v.hasLocalData&&(log("No root present"),t=!0),n){var h=n[c];if(!h.exist){log(c,": Item is referenced locally as a child but does not exist in the database");var f=v.getItem(h.ref);if(a.default.Assert(f,"Parent of item must exist"),f)(p=f.items)?p.remove(c):p=[],v.dbUpdateItem({id:f.id,changes:{items:p},saveFlags:SaveFlag.None})}if(h.ref||h.isRoot||h.del||(log(c,": Item exists locally but is not referenced by a parent"),C(c)),h.ref&&h.del){log(c,": Item is referenced locally by a parent but has been deleted");var p;f=v.getItem(h.ref);a.default.Assert(f),(p=f.items)?p.remove(c):p=[],v.dbUpdateItem({id:f.id,changes:{items:p},saveFlags:SaveFlag.None})}if(h.isRoot&&h.ref&&(log(c,": Local root has a parent"),t=!0),h.del&&!h.ref){f=v.getItem(c);a.default.isLocalItem(f)&&(log("Deleting Unreferenced Local Item: ",c),v.dbDeleteItem(c))}}ShouldLog(LogLevels.Timing)&&log("Done Verifying Local Data",log.now()),e({error:t,local:!1})})},v.removeDeletedItems=function(e){for(var t in v.dbDataCache){var i=v.getItem(t);i&&i.isDeleted&&(e[t]||v.dbDeleteItem(t))}},v.defaultSkipSettings={Default:[Settings.authScopes,Settings.activeUser,Settings.userId,Settings.displayName,Settings.shownTutorial,Settings.helpPaneState,Settings.oauthScheme,Settings.enableOfflineAuth,Settings.premiumStatus,Settings.trialStart,Settings.trialDuration,Settings.trialExtended,Settings.theme,Settings.helpState,Settings.localPaneState,Settings.selectedWorkspace,Settings.notificationDelay]},v.addDefaultSkipSetting=function(e,t){v.defaultSkipSettings[t]||(v.defaultSkipSettings[t]=[]),v.defaultSkipSettings[t].push(e)},v.clearDataAndReload=function(e){n.a.hasURLParam("sinfo")&&n.a.removeURLParam("sinfo"),v.clearData(function(){setTimeout(a.default.reload,0)},v.defaultSkipSettings,e)},v.clearData=function(e,t,i){v.freezeUpdates=!0,a.default.shouldWriteLocal()||a.default.isLocalWriteReason(s.a.LocalWriteReason.QuotaError)?setTimeout(function(){if(a.default.pageDataCleared(),v.dbi)if(v.dbi.settings)try{v.dbi.settings.clear().done(function(){s()}).fail(function(){log("Failed to reset settings!"+arguments),s()})}catch(e){a.default.reportError(e),s()}else s();else v.initializeIndexedDB(function(){v.clearData(e,t)});function n(){var n;i||(v.clearContacts(),n=a.default.isArray(t)?{Default:t}:t,a.default.settings.resetAll(n),a.default.vmMain&&a.default.vmMain.pluginManager&&a.default.vmMain.pluginManager.onPurgeData());a.default.vmMain&&a.default.vmMain.cacheManager&&(i?a.default.vmMain.cacheManager.clearPerDocCaches(!0):a.default.vmMain.cacheManager.clearLocalCaches(!0)),setTimeout(function(){e&&e()},0)}function s(){if(v.dbi.items)try{v.dbi.items.clear().done(function(){r()}).fail(function(){log("Failed to reset items!"+arguments),r()})}catch(e){a.default.reportError(e),r()}else r()}function r(){if(v.dbi.caches)try{v.dbi.caches.clear().done(function(){n()}).fail(function(){log("Failed to reset items!"+arguments),n()})}catch(e){a.default.reportError(e),n()}else n()}},0):e&&setTimeout(e,0)};var L=!1;function P(e,t,i,n){a.default.Assert(e,"Must provide a valid item"),a.default.Assert(e.shouldSave(),"Item must be marked as saveable");var s=a.default.isLocalChange(n)?SaveFlag.Prop:SaveFlag.None;g.a.saveItemLocal(e,{items:e.getItemsArrayForSave()},s),g.a.saveItemLocal(t,{isArchived:i},s)}function E(e,t,i){var a=e[t];return a?',"'+t+'":'+(i?i(a):a):""}v.clearLocalContacts=function(){if(L=!1,a.default.shouldWriteLocal())try{n.a.storage.setItem("ctcs","[]")}catch(e){a.default.reportError(e)}v.contactManager.clearContacts(),a.default.settings.set(Settings.lastContactSync,void 0)},v.loadLocalContacts=function(){if(!L&&(L=!0,a.default.shouldWriteLocal()))try{var e=n.a.storage.getItem("ctcs"),t=e?JSON.parse(e):void 0;v.contactManager.loadContacts(t,!1)}catch(e){a.default.reportError(e)}},v.areLocalContactsLoaded=function(){return L},v.saveContacts=function(){a.default.shouldWriteLocal()&&n.a.storage.setItem("ctcs",JSON.stringify(v.contactManager._contacts.get()))},v.clearContacts=function(){a.default.settings.reset(Settings.lastContactSync),a.default.shouldWriteLocal()&&n.a.storage.removeItem("ctcs",void 0)},v.insertItem=function(e,t,i){a.default.Assert(a.default.isVMLI(e),"Must pass in a valid item"),a.default.Assert(a.default.isVMLI(t),"Must pass in a valid insert item"),a.default.Assert(e.shouldSave(),"Item must be marked as saveable"),a.default.Assert(void 0===i||i>=0,"Must pass in a valid index"),g.a.saveItemLocal(e,{items:e.getItemsArrayForSave()},SaveFlag.Prop),r.a.itemAdded({item:e,addedItem:t,index:i,isArchived:!1})},v.insertItems=function(e,t,i){a.default.Assert(e,"Must pass in a valid item"),a.default.Assert(e.shouldSave(),"Item must be marked as saveable"),a.default.Assert(void 0===i||i>=0,"Must pass in a valid index"),g.a.saveItemLocal(e,{items:e.getItemsArrayForSave()},SaveFlag.Prop),1===t.length?r.a.itemAdded({item:e,addedItem:t[0],index:i,isArchived:!1}):r.a.itemsAdded({item:e,addedItems:t,index:i,isArchived:!1})},v.removeItem=function(e,t,i,n,s){a.default.Assert(e,"Must pass in a valid item"),a.default.Assert(e.shouldSave(),"Item must be marked as saveable"),a.default.Assert(void 0===t||t>=0,"Must pass in a valid index");var o=a.default.isLocalChange(s)?SaveFlag.Prop:SaveFlag.None;g.a.saveItemLocal(e,{items:e.getItemsArrayForSave()},o),a.default.isLocalChange(s)&&r.a.itemRemoved({item:e,index:t,numToRemove:1,isArchived:n})},v.moveItem=function(e,t){var i=e.item,n=e.newInfo,s=e.oldParent,o=e.oldInfo,l=e.noVersion,d=a.default.isLocalChange(t)?SaveFlag.Prop:SaveFlag.None;a.default.Assert(void 0!==i&&void 0!==n&&void 0!==s&&void 0!==o,"moveItem is missing parameters"),a.default.Assert(i.shouldSave(),"Item must be marked as saveable"),a.default.Assert(s.shouldSave(),"Old parent must be marked as saveable"),a.default.Assert(i.parent().shouldSave(),"New parent must be marked as saveable"),g.a.saveItemLocal(s,{items:s.getItemsArrayForSave()},d),g.a.saveItemLocal(i.parent(),{items:i.parent().getItemsArrayForSave()},d),o.isArchived!==n.isArchived&&(i.isArchived(n.isArchived,t),g.a.saveItemLocal(i,{isArchived:n.isArchived},d)),a.default.isLocalChange(t)&&(v.saveChanges(i,{},d),r.a.itemMoved({item:i,newInfo:n,oldParent:s,oldInfo:o,noVersion:l}))},v.archiveItem=function(e,t,i,n){a.default.Assert(e,"Must provide a valid item"),a.default.Assert(e.shouldSave(),"Item must be marked as saveable"),a.default.Assert(t>=0,"Must have a valid index to remove from"),P(e,i,!0,n),a.default.isLocalChange(n)&&r.a.itemArchived(e,i,t)},v.unarchiveItem=function(e,t,i,n){a.default.Assert(e,"Must provide a valid item"),a.default.Assert(e.shouldSave(),"Item must be marked as saveable"),a.default.Assert(t>=0,"Must have a valid index to remove from"),P(e,i,!1,n),a.default.isLocalChange(n)&&r.a.itemUnarchived(e,i,t,e.numItems()-1)},v.modifyItemId=function(e,t,i){var n=v.getItem(e),s=v.getModel(e);if(a.default.Assert(s.shouldSave(),"Item must be marked as saveable"),a.default.vmMain.itemStoreManager.getDefaultItemStore().manualModifyItemID(e,t),n.id=t,s.id=t,v.pendingRemoteUpdates[e]&&(v.pendingRemoteUpdates[e]=void 0,v.pendingRemoteUpdates[t]=!0),n.version=-1,n.versionText=-1,"root"===e)for(var r=n.items.length-1;r>=0;r--){var o=v.getItem(n.items[r]);!a.default.isLocalItem(o)||o.modifiedOffline||o.modifiedOfflineText||(n.items.removeAt(r),a.default.Assert(s.itemAtIndex(r).id===o.id,"Item arrays should match"),s.getItems().removeAt(r))}a.default.Assert(!v.itemCache[t],"Should not be overwriting an item in the d.itemCache"),a.default.Assert(!v.dbDataCache[t],"Should not be overwriting an item in the d.dbDataCache"),v.itemCache[t]=v.itemCache[e],v.dbDataCache[t]=n,v.dbDeleteItem(e),v.dbUpdateItem({changes:n,callback:i,skipLocalModification:!0,saveFlags:SaveFlag.None}),v.dbDataCache[e]=void 0,delete v.dbDataCache[e],v.itemCache[e]=void 0,delete v.itemCache[e]},v.deleteItem=function(e,t){a.default.Assert(e,"Must provide a valid item"),a.default.Assert(e.shouldSave(),"Item must be marked as saveable"),a.default.Assert(!e.isDeleted(),"Should never try to delete an item that has already been deleted"),v.getItem(e.id)?(e.isDeleted(!0,t),v.dbUpdateItem({id:e.id,changes:{isDeleted:!0},saveFlags:SaveFlag.Prop})):a.default.Assert("Expected local item, didnt find one",e.id)},v.undeleteItem=function(e,t){v.getItem(e.id)?(e.isDeleted(!1,t),v.dbUpdateItem({id:e.id,changes:{isDeleted:void 0},saveFlags:SaveFlag.Prop})):a.default.Assert("Expected local item, didnt find one",e.id)},v.saveChanges=function(e,t,i){if(!e)return log("Incoming item to save has no item!",e,t),void a.default.Assert(!1,"Incoming item to save has no item!");a.default.Assert(e.shouldSave(),"Item must be marked as saveable"),t||(t={}),v.dbUpdateItem({id:e.id,changes:t,saveFlags:i})},v.addPendingUpdate=function(e){a.default.Assert(e,"Invalid ID"),a.default.Assert(a.default.isString(e),"Must provide a valid id string"),v.pendingRemoteUpdates[e]||(v.pendingRemoteUpdates[e]=!0)},v.clearPendingUpdate=function(e){delete v.pendingRemoteUpdates[e]},v.clearPendingUpdates=function(){for(var e in v.pendingRemoteUpdates){a.default.Assert(v.pendingRemoteUpdates.hasOwnProperty(e));var t=v.getModel(e),i=v.getItem(e);if(i&&i.isDeleted)v.dbDeleteItem(e);else if(t&&t.data){var n={id:e,modifiedOffline:!1};t.modifiedOffline=!1,r.a.hasDeferredAction(t.id)||(t.modifiedOfflineText=!1,n.modifiedOfflineText=!1);var s=r.a.getVersion(t.data,VersionType.Structure),o=r.a.getVersion(t.data,VersionType.Text);s!=t.getVersion(VersionType.Structure)&&(n.version=s,t.setVersion(VersionType.Structure,s)),o!=t.getVersion(VersionType.Text)&&(n.versionText=o,t.setVersion(VersionType.Text,o)),v.dbUpdateItem({id:e,changes:n,saveFlags:SaveFlag.None})}}v.pendingRemoteUpdates={},setTimeout(function(){!function e(t){a.default.Assert(t&&t.data,"Item must have valid remote data associated with it to be in the tree");if(!t||!t.data)return;if(!v.pendingRemoteUpdates[t.id]){var i=t.getVersion(VersionType.Structure)===r.a.getVersion(t.data,VersionType.Structure),n=t.getVersion(VersionType.Text)===r.a.getVersion(t.data,VersionType.Text),s={};i||(s.version=r.a.getVersion(t.data,VersionType.Structure),t.setVersion(VersionType.Structure,r.a.getVersion(t.data,VersionType.Structure))),n||(s.versionText=r.a.getVersion(t.data,VersionType.Text),t.setVersion(VersionType.Text,r.a.getVersion(t.data,VersionType.Text))),a.default.isEmpty(s)||(s.id=t.id,v.dbUpdateItem({id:t.id,changes:s,saveFlags:SaveFlag.None}))}var o=t.getItems();for(var l=0;l<o.length;++l)e(o[l]);if(t.hasArchivedChildren())for(var d=t.archivedItems(!0),l=0;l<d.length;++l)e(d[l])}(this.getRootModel())}.bind(this),0)},v.toDropHtml=function(e){var t="";if(!e.isArchived()&&(t+="<li>"+a.default.escape(e.getParsedText())+"</li>",e.hasChildren())){t+="<ul>";for(var i=0;i<e.numChildren();++i)t+=v.toDropHtml(e.getChild(i));t+="</ul>"}return t},v.toHtml=function(e,t,i,n){var s="<ul>";if(e.items)for(var r=0;r<e.items.length;r++){var o=v.getItem(e.items[r]),l=v.getModel(o.id),d=a.default.escape((n?l.getPrefix():"")+l.generateTitleText());if(!o.isArchived||o.isArchived&&t){if(s+="<li>"+d,o.note&&i){s+="<li>";var u=v.getModel(o.note);s+=a.default.escape(u.getParsedText()),s+="</li>"}o.items&&o.items.length>0&&(s+=v.toHtml(o,t,i,n)),s+="</li>"}}return s+="</ul>"},v.toPlainText=function(e,t,i,n,s){isNaN(t)&&(t=0);var r="";if(e.items)for(var o=0;o<e.items.length;o++){var l=v.getItem(e.items[o]),d=v.getModel(l.id);if(!l.isArchived||l.isArchived&&i){for(var u=0;u<t;u++)r+="\t";if(r+=a.default.escape((s?d.getPrefix():"")+d.generateTitleText())+"\n",l.note&&n)r+=v.getModel(l.note).getParsedText()+"\n";l.items&&l.items.length>0&&(r+=v.toPlainText(l,t+1,i,n,s))}}return r};var k=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,x={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function R(e){var t;try{var i=new Date(e);a.default.isDateValid(i)&&(t=i.getTime())}catch(e){a.default.reportError(e)}return t}function O(e,t,i,n,s){var r="";t&&(r+=",");var o=v.getModel(e.id);if(r+='{"text":"'+function(e){return k.lastIndex=0,k.test(e)?e.replace(k,function(e){var t=x[e];return a.default.isString(t)?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}):e}(o.generateExportText(s?o.getParsedText():o.getParsedTextWithoutPrefix()))+'"'+E(e,"date",R)+E(e,"dateCompleted")+E(e,"priority")+E(e,"isComplete")+E(e,"isStarred")+E(e,"isArchived")+E(e,"isNote"),(e=v.getItem(e.id)).note&&n&&(r+=',"note":'+O(v.getItem(e.note),!1,i,n,s)),e.items&&e.items.length>0){r+=',"items":[';for(var l=0;l<e.items.length;l++){var d=v.getItem(e.items[l]);(!d.isArchived||d.isArchived&&i)&&(r+=O(d,l>0,i,n,s))}r+="]"}return r+="}"}v.toJSON=function(e,t,i,n,s){var o=O(e,t,i,n,s),l='{"moodoVer":'+(a.default.settings.get(Settings.localDataVersion)||r.a.currentVersion())+',"moodoRoot":'+o+"}";try{var d=JSON.parse(l),u=JSON.stringify(d);a.default.Assert(u===l,l),l=JSON.stringify(d,null,2)}catch(e){a.default.reportError(e)}return l},v.createRootItem=function(e){v.setRoot(e),v.dbUpdateItem({changes:{id:e,text:s.a.RootItemName,items:[]},skipLocalModification:!0,saveFlags:SaveFlag.None,callback:function(){}})},v.ensureLocalCache=function(e){v.getRootItem()?(v.loadedItemCount>1&&(v.hasLocalData=!0),e()):e()},v.printIndexedDB=function(){};t.default=v},function(e,t,i){"use strict";var a=i(0),n=i(5),s=i(6),r=i(9),o=i(3),l=i(21);window.TrackerType={Insert:1,Remove:2,SetText:3,Create:4,Delete:5,Move:6,Update:7,Format:8,Zoom:9,UIAction:10,Misc:11,Mobile:12},window.TrackerMisc={ToggleOverview:1,RightClick:2,CloseMessage:3,ChangeDate:4,AddContact:5,DropItem:6,SyncContacts:7,OpenContact:8,SearchChanged:10,OpenDocumentsMenu:11,AddDocument:12,OpenDocument:13,OpenDocSharing:14,Copy:15,Paste:16,OpenImport:17,OpenExport:18,UndoRedo:19,AddToGCal:20,OpenEmail:21,ComposeEmail:22,DriveUpload:23,OpenDisplaySettings:24,DragItem:25,OpenAddPaneMenu:26,SetPrefix:27,OpenCalendarsMenu:28,OpenHelp:29},window.TrackerMiscMobile={OpenKeyboard:1,CloseKeyboard:2,PaneCalendar:3,PaneOutline:4,OpenAutocomplete:5,CloseAutocomplete:6,AtButton:7,OpenMultiselect:8,CloseMultiselect:9},window.TrackerUIAction={AddPane:1,RemovePane:2,SwitchPaneMode:3,OpenSettingsMenu:4,AddBoard:5};function d(){this.disabled=!1,this.allowOfflineUndo=!1,this.cursor=-1,this.groupID=0,this.groups=[],this.externalUndoRedo=!1,this.undoRedoActive=!1,this.canRedo=!1,this.canUndo=!1,this._performingActions=!1,this._currentAction=[],this._actionsPreventUndo=!1,this._aggregateActions=0,this._externalStateChanged=[],n.a.forceBind("stateChangeForUndoRedo",this),this.init()}function u(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.itemID);a.default.Assert(r,"Expected model to exist: ",n);var l=r.getParsedText(),d=0;"\ufeff"===l[0]&&(d=1);var u=l.slice(d,n.position)+l.slice(n.position+n.text.length);r.setText(u,!0,ChangeType.Local),o.a.selectItem(r,n.position)}}function c(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.itemID);a.default.Assert(r,"Expected model to exist: ",n);var l=r.getParsedText(),d=l.slice(0,n.position)+n.text+l.slice(n.position);0===d.length&&(d="\ufeff"),r.setText(d,!0,ChangeType.Local),o.a.selectItem(r,n.position,n.position+n.text.length)}}function h(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.itemID);a.default.Assert(r,"Expected model to exist: ",n);var l=r.getParsedText(),d=0;"\ufeff"===l[0]&&(d=1);var u=l.slice(d,n.position)+n.text+l.slice(n.position);r.setText(u,!0,ChangeType.Local),o.a.selectItem(r,n.position,n.position+n.text.length)}}function f(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.itemID);a.default.Assert(r,"Expected model to exist: ",n);var l=r.getParsedText(),d=l.slice(0,n.position)+l.slice(n.position+n.text.length);0===d.length&&(d="\ufeff"),r.setText(d,!0,ChangeType.Local),o.a.selectItem(r,n.position)}}function p(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.parent);a.default.Assert(r,"Expected model to exist: ",n);var d=r.removeChildAtIndex(n.position,ChangeType.Local);a.default.Assert(d.id===n.itemID,"Expected data to match removed child: ",d,n),d.parent(void 0),s.default.deleteItem(d,ChangeType.Local);var u=r;n.position>0&&(u=r.getChild(n.position-1)),a.default.focusedPane.indexOfItem(u)>=0&&o.a.selectItem(u,u.getParsedText().length),l.a.saveItemLocal(r,{items:r.getItemsArrayForSave()},SaveFlag.None)}}function g(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.parent);a.default.Assert(r,"Expected parent model to exist: ",n);var d=s.default.getModel(n.itemID);a.default.Assert(d,"Expected child model to exist: ",n),s.default.undeleteItem(d,ChangeType.Local),d.parent(r),r.items.splice(n.position,0,d),o.a.selectItem(d,0),l.a.saveItemLocal(r,{items:r.getItemsArrayForSave()},SaveFlag.None)}}function m(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.parent);a.default.Assert(r,"Expected model to exist: ",n);var o=s.default.getModel(n.itemID);a.default.Assert(o,"Expected model to exist: ",n),s.default.undeleteItem(o,ChangeType.Local),o.parent(r),r.items.splice(n.position,0,o),l.a.saveItemLocal(r,{items:r.getItemsArrayForSave()},SaveFlag.None)}}function v(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.parent);a.default.Assert(r,"Expected model to exist: ",n);var d=r.removeChildAtIndex(n.position,ChangeType.Local);a.default.Assert(d.id===n.itemID,"Expected data to match removed child: ",d,n),d.parent(void 0),s.default.deleteItem(d,ChangeType.Local);var u=r;n.position>0&&(u=r.getChild(n.position-1)),o.a.selectItem(u,u.getParsedText().length),l.a.saveItemLocal(r,{items:r.getItemsArrayForSave()},SaveFlag.None)}}function _(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.oldParent);a.default.Assert(r,"Expected oldParent model to exist: ",n);var d=s.default.getModel(n.newParent);a.default.Assert(d,"Expected newParent model to exist: ",n);var u=d.removeChildAtIndex(n.newPosition,ChangeType.Local);a.default.Assert(u.id===n.itemID,"Expected data to match child: ",u,n),u.parent(r),r.items.splice(n.oldPosition,0,u),o.a.selectItem(u,0),l.a.saveItemLocal(d,{items:d.getItemsArrayForSave()},SaveFlag.None),l.a.saveItemLocal(r,{items:r.getItemsArrayForSave()},SaveFlag.None)}}function y(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.oldParent);a.default.Assert(r,"Expected oldParent model to exist: ",n);var d=s.default.getModel(n.newParent);a.default.Assert(d,"Expected newParent model to exist: ",n);var u=r.removeChildAtIndex(n.oldPosition,ChangeType.Local);a.default.Assert(u.id===n.itemID),u.parent(d),d.items.splice(n.newPosition,0,u),o.a.selectItem(u,0),l.a.saveItemLocal(d,{items:d.getItemsArrayForSave()},SaveFlag.None),l.a.saveItemLocal(r,{items:r.getItemsArrayForSave()},SaveFlag.None)}}function S(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.itemID);a.default.Assert(r,"Expected model to exist: ",n),a.default.Assert(r[n.field],"Expected field to exist: ",n),r[n.field](n.oldValue,ChangeType.Local)}}function w(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.itemID);a.default.Assert(r,"Expected model to exist: ",n),a.default.Assert(r[n.field],"Expected field to exist: ",n),r[n.field](n.newValue)}}function I(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.itemID);a.default.Assert(r,"Expected model to exist: ",n)}}function b(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[i],r=s.default.getModel(n.itemID);a.default.Assert(r,"Expected model to exist: ",n)}}function A(e){var t=e[0],i=s.default.getModel(t.oldItemID);a.default.Assert(i,"Expected model to exist: ",t),t.zoomIn?a.default.vmMain.zoomout(i,!0):t.zoomOut?a.default.vmMain.zoomin(i,!0):a.default.Assert(!1,"Zoom action must define either zoomIn or zoomOut")}function D(e){var t=e[0],i=s.default.getModel(t.itemID);a.default.Assert(i,"Expected model to exist: ",t),t.zoomIn?a.default.vmMain.zoomout(i,!0):t.zoomOut?a.default.vmMain.zoomin(i,!0):a.default.Assert(!1,"Zoom action must define either zoomIn or zoomOut")}function T(e){switch(e[0].type){case TrackerUIAction.RemovePane:case TrackerUIAction.SwitchPaneMode:break;default:a.default.Assert(!1,"Invalid UIAction")}}function M(e){}d.prototype={init:function(){this.listeners=[],r.a.registerForUndoRedoStateChange(this)},addListener:function(e){this.listeners.push(e)},removeListener:function(e){this.listeners.remove(e)},_getNextGroupID:function(){return this.groupID+1},_useNextGroupID:function(){return++this.groupID},_getCurrentGroup:function(){return this.groups[this.cursor]},_getCurrentAction:function(){return this.groups[this.cursor].events[this.groups[this.cursor].events.length-1]},_pushGroup:function(){var e=this._useNextGroupID();return this.groups.push({id:e,events:[],persisted:!1}),this.cursor<74&&this.cursor++,this.groups.length>75&&this._handleGroupTrimmed(this.groups.shift()),e},_doAction:function(e,t){var i=this._getCurrentGroup();a.default.Assert(i,"Expected group to exist");var n={type:e,data:t};switch(e){case TrackerType.Insert:n.cb={undo:u,redo:c};break;case TrackerType.Remove:n.cb={undo:h,redo:f};break;case TrackerType.Create:n.cb={undo:p,redo:g};break;case TrackerType.Delete:n.cb={undo:m,redo:v};break;case TrackerType.Move:n.cb={undo:_,redo:y};break;case TrackerType.Update:n.cb={undo:S,redo:w};break;case TrackerType.Format:n.cb={undo:I,redo:b};break;case TrackerType.Zoom:n.cb={undo:A,redo:D};break;case TrackerType.UIAction:n.cb={undo:T,redo:M};break;default:a.default.Assert(!1,"Expected TrackerType, received: ",e)}i.events.push(n)},_handleGroupTrimmed:function(e){for(var t=0,i=0;i<e.events.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e.events[i];switch(n.type){case TrackerType.Insert:case TrackerType.Remove:case TrackerType.Create:case TrackerType.Delete:case TrackerType.Move:case TrackerType.Update:case TrackerType.Format:case TrackerType.Zoom:case TrackerType.UIAction:break;default:a.default.Assert(!1,"Expected TrackerType, received: ",n.type)}}},_mergeAction:function(e,t){log("Tracker Action Merged: ",e,t);var i=this._getCurrentAction();switch(a.default.Assert(i,"Expected action to exist"),e){case TrackerType.Insert:case TrackerType.Remove:case TrackerType.Create:case TrackerType.Delete:case TrackerType.Move:case TrackerType.Update:break;case TrackerType.Format:a.default.Assert(!1,"Formats cannot be merged");break;case TrackerType.Zoom:a.default.Assert(!1,"Zooms cannot be merged");break;case TrackerType.UIAction:a.default.Assert(!1,"UIActions cannot be merged");break;default:a.default.Assert(!1,"Expected TrackerType, received: ",e)}},_canMerge:function(e){var t=!1,i=this._getCurrentGroup();return i&&i.events.length>0&&(i.events[i.events.length-1].type===e?e===TrackerType.Insert&&(t=!0):t=!1),t},_canCombine:function(e,t){var i=this._getCurrentGroup();return i&&(i.id===t||0===i.events.length)},performActions:function(e){if(a.default.Assert(!this.disabled||a.default.intro,"Can only perform actions when enabled or during the intro"),a.default.Assert(!this._performingActions,"Can not nest performing actions"),this._performingActions=!0,e&&e.length>0){var t=0;if(!this.disabled){var i=void 0;this.cursor!=this.groups.length-1?(this.groups.splice(this.cursor+1,this.groups.length-(this.cursor+1)),i=this._pushGroup()):i=this._getNextGroupID()}for(var n=0;n<e.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=e[n];this.fireActionEvent(s),this.disabled||(this._canCombine(s.type,i)?this._canMerge(s.type)?this._mergeAction(s.type,s.data):this._doAction(s.type,s.data):(i=this._pushGroup(),this._doAction(s.type,s.data)))}}this._performingActions=!1},beginAction:function(e){a.default.Assert(!this._performingActions,"Should never begin an action while replaying old actions"),0===this._aggregateActions&&(this._actionsPreventUndo=!!e,r.a.beginAction(e),a.default.Assert(0===this._currentAction.length,"Current actions should always be empty when starting a new action")),this._aggregateActions++},performAction:function(e,t){a.default.Assert(!this._performingActions,"Should never perform an action while replaying old actions");var i=!a.default.vmMain.isLoaded||a.default.isLoadingRemote;this.disabled?a.default.intro&&(i||this.performActions([{type:e,data:[t]}])):this._aggregateActions?this._currentAction.push({type:e,data:[t]}):this.performActions([{type:e,data:[t]}])},endAction:function(){a.default.Assert(!this._performingActions,"Should never end an action while replaying old actions"),a.default.Assert(0!==this._aggregateActions,"Must have called beginAction before calling endAction"),1===this._aggregateActions&&(this.disabled&&!a.default.intro||this.performActions(this._currentAction),this._currentAction.length=0,r.a.endAction(),this._actionsPreventUndo=!1),this._aggregateActions=Math.max(0,this._aggregateActions-1)},resetAggregateActionCount:function(){this._aggregateActions=0},_processStateChangedSelection:function(e,t){var i;a.default.Assert(!this.undoRedoActive,"Must not currently be undoing/redoing an action when setting selection");var n=0,r=0;if(a.default.isKeyboardOPen||!a.default.keyboardToolbar){for(var l=0,d=0;d<e.length;++d){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;var u=e[d],c=u.data,h=s.default.getModel(c.itemID);switch(a.default.Assert(h,"Expected model to exist: ",c),u.type){case TrackerType.Insert:i=h,n=c.position,r=c.text.length;break;case TrackerType.Remove:i=h,n=c.position,r=0;break;case TrackerType.SetText:a.default.focusedPane.indexOfItem(h)>=0&&(i=h,n=c.position,r=0);break;case TrackerType.Create:i=h,n=0,r=0;break;case TrackerType.Delete:if(c.previous){var f=s.default.getModel(c.previous);f&&f.isDescendantOf(a.default.focusedPane.getItem())&&(i=f,n=f.getParsedText().length,r=0)}}}var p=-1;a.default.focusedPane&&(i?p=t&&t.item===i?a.default.focusedPane.closestIndexOfObject(t):a.default.focusedPane.indexOfItem(i):(n=o.a.getStartOffset()||0,p=t?a.default.focusedPane.closestIndexOfObject(t):-1,r=0)),p>=0?(o.a.selectIndex(p,n,n+r),i&&a.default.focusedPane.scrollItemIntoView(i,ScrollDuration.Default)):o.a.reset()}this._externalStateChanged=[]},notifyStateChangedFromUndoRedo:function(e,t){a.default.Assert(this.undoRedoActive),this._externalStateChanged.push({type:e,data:t})},undoAction:function(){a.default.vmMain.canRunUndoRedo()||a.default.toasts.pushMessage(MessageID.OfflineUndo),this.undoRedoActive=!0,a.default.Assert(!this._performingActions),this.beforeUndoRedo();var e=o.a.isValid()?o.a.getStartObject():void 0;if(!this.disabled&&this.allowOfflineUndo){if(this.cursor>=0)for(var t=0,i=this.groups[this.cursor--],n=i.events.length-1;n>=0;n--){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=i.events[n];s.cb.undo(s.data)}}else this.canUndo&&(a.default.Assert(this.externalUndoRedo),r.a.undoAction());this.afterUndoRedo(),this.undoRedoActive=!1,this._processStateChangedSelection(this._externalStateChanged,e),this.miscAction({type:TrackerType.Misc,misc:TrackerMisc.UndoRedo,data:[{undo:!0}]})},redoAction:function(){a.default.vmMain.canRunUndoRedo()||a.default.toasts.pushMessage(MessageID.OfflineUndo),this.undoRedoActive=!0,a.default.Assert(!this._performingActions),this.beforeUndoRedo();var e=o.a.isValid()?o.a.getStartObject():void 0;if(!this.disabled&&this.allowOfflineUndo){if(this.cursor>=-1&&this.cursor<this.groups.length-1)for(var t=0,i=this.groups[++this.cursor],n=0;n<i.events.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=i.events[n];s.cb.redo(s.data)}}else this.canRedo&&(a.default.Assert(this.externalUndoRedo),r.a.redoAction());this.afterUndoRedo(),this.undoRedoActive=!1,this._processStateChangedSelection(this._externalStateChanged,e),this.miscAction({type:TrackerType.Misc,misc:TrackerMisc.UndoRedo,data:[{redo:!0}]})},beforeUndoRedo:function(){a.default.vmMain.beginUpdateItems()},afterUndoRedo:function(){a.default.vmMain.commitUpdateItems()},miscAction:function(e){this.fireActionEvent(e)},resetState:function(){this._performingActions=!1,this._externalStateChanged=[],this._currentAction=[],this.undoRedoActive=!1,this.cursor=-1,this.groupID=0,this.groups=[]},_getOrderedGroups:function(){return this.groups.slice(this.cursor).concat(this.groups.slice(0,this.cursor))},stringifyGroups:function(){return"Tracker: "+this._getOrderedGroups().length},stateChangeForUndoRedo:function(e){this.externalUndoRedo=!0,this.disabled=!0,this.canRedo=e.canRedo,this.canUndo=e.canUndo},fireActionEvent:function(e){try{if(e.data||(e.data={}),this.listeners)for(var t=0,i=0;i<this.listeners.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this.listeners[i](e)}}catch(e){a.default.reportError(e)}}},t.a=new d},function(e,t,i){"use strict";var a=i(5),n=i(60);function s(e,t){this._value=e,this._listeners=void 0,t&&(this._listeners=[t])}s.prototype={get:function(){return this._value},set:function(e,t){var i=this._value;return this._value=e,!1!==t&&this.notify(e,i,t),e},dbgObserve:function(){this.listen(function(e,t){log("Value: ",t,"->",e)})},hasListeners:function(){return this._listeners&&this._listeners.length>0},listen:function(e){return this._listeners||(this._listeners=[]),this._listeners.push(e),new n.a(this,e)},unlisten:function(e){this._listeners&&this._listeners.remove(e)},notify:function(e,t,i){0===arguments.length&&(e=this._value,t=this._value,i=!0);var a=this._listeners;if(a&&a.length>0&&(e!==t||!0===i)){var n=0;0;for(var s=0;s<a.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;!1===(0===arguments.length?a[s](this._value,void 0,i):a[s](e,t,i))&&(a.splice(s,1),s--)}0}}},a.a.defineBase(s),t.a=s},function(e,t,i){"use strict";var a=i(5),n=i(0),s=i(1),r=(i(47),i(8)),o={isClosed:!0,initialized:!1,loadedOnce:!1,actionsPreventUndo:!1,wantCompoundOperation:!1,inCompoundOperation:!1,flushingDeferredActions:!1,deferredActionsCommitted:!1,hasPendingDeferredActions:!1,authenticatedUser:new r.a,numChanges:0,lastChangeTime:new r.a(n.default.parseInt(a.a.storage.getItem("lastDocSyncTime"))||0)};o.lastChangeTime.listen(function(e){n.default.Assert(n.default.isNumber(e),"Must always provide a valid timestamp for lastDocSyncTime"),a.a.storage.setItem("lastDocSyncTime",e)});o.offlineTimeoutMS=12e3;o.currentVersion=function(){return 6},o.isReadOnly=function(){var e=!1;return o.model&&(e=o.model.isReadOnly),e};var l,d={},u={};function c(){if(n.default.Assert(!o.inCompoundOperation,"Should never be in a compound operation after sync block finishes"),n.default.Assert(!o.wantCompoundOperation,"Should never want a compound operation after a sync block finishes"),o.inCompoundOperation){try{o.inCompoundOperation=!1,o.wantCompoundOperation=!1,n.default.vmMain.notifyDriveOperationError(),o.model.endCompoundOperation()}catch(e){n.default.reportError(e)}n.default.reportError(new Error("Compound operation open after sync block finished"))}l=void 0}o.cacheItem=function(e){n.default.Assert(void 0===u[e.id]||u[e.id]===e,"Should not be caching different items with the same ID"),u[e.id]=e,d[e.id]&&(n.default.Assert(d[e.id]===e,"Should not be caching different items with the same ID in deleted"),delete d[e.id])},o.getCacheItem=function(e){return u[e]},o.getDeletedCacheItem=function(e){return d[e]},o.removeItemFromCache=function(e){n.default.Assert(void 0!==u[e],"Item cache should contain a valid entry for item"),n.default.Assert(void 0===d[e],"Should never already have item in deleted cache"),d[e]=u[e],delete u[e]},o.restoreDeletedItem=function(e){n.default.Assert(void 0!==d[e],"Deleted item cache should contain a valid entry for item"),n.default.Assert(void 0===u[e],"Should never already have an item in the item cache"),u[e]=d[e],delete d[e]},o.getState=function(e){try{var t={};if(o.doc)try{var i=o.doc.getModel();t.isReadOnly=i.isReadOnly,t.serverVersion=i.serverVersion,t.size=i.bytesUsed,t.saveDelay=o.doc.saveDelay}catch(t){e.docAccessError=!0}t.lastPending=J,t.lastSaving=Z,t.isClosed=o.isClosed,t.initialized=o.initialized,t.numChanges=o.numChanges,t.lastChanged=o.lastChangeTime.get(),e.gState=t,e.gDocErrors=o.docErrors,e.gdataRealtimeStatus=o.getDriveRealtimeStatus()}catch(t){log("Error getting information in gdata::getState()"+t.message),e.gState="EXCEPTION"}},o.checkRemoteIntegrity=function(){var e=i(6).default;o.beginAction(),ShouldLog(LogLevels.Timing)&&log("Verifying Remote Data: ",log.now());var t={},a=!1;for(var s in u){var r=function(e,i){if(e)for(var a=0,n=0;n<e.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=e.get(n).id;s||(log(s,": Child does not have a valid reference in our remote database"),!0),t[s]?t[s].ref?(log(s,": Item is referenced remotely multiple times"),log("   ",t[s].ref),log("   ",l.id),!0,o.beginWriteAction(),o.setItemParent(e.get(n),o.getCacheItem(t[s.ref])),e.remove(n)):t[s].ref=l.id:t[s]={exist:!1,arch:i,ref:l.id}}},l=u[s];t[l.id]?t[l.id].exist?(log(l.id,": Duplicated IDs in the remote database",l),!0):t[l.id].exist=!0:t[l.id]={exist:!0,ref:!1},l.id===o.rootID&&(a&&(log(l.id,": Multiple roots present remotely",l),!0),a=!0,t[l.id].isRoot=!0),o.getItemParent(l)||t[l.id].isRoot||log(l.id,": Missing remote parent field",l),r(o.get(l,"items"),!1),r(o.get(l,"archivedItems"),!0);var d=o.get(l,"note");d&&(t[d.id]?t[d.id].ref?(log(d,": Note is referenced remotely multiple times: "),log("    ",t[d.id].ref),log("    ",l.id),!0,o.beginWriteAction(),o.set(l,"note",void 0)):t[d.id].ref=l.id:t[d.id]={exist:!1,isNote:!0,ref:l.id})}for(var c in a||(log("No root present"),!0),t){var h=t[c];if(!h.exist){n.default.Assert(!1,"This should never happen as the database is inline with the item tree now"),log(c,": Item is referenced remotely as a child but does not exist in the database");var f=u[h.ref];if(n.default.Assert(f,"Parent must exist otherwise it couldn't reference this item"),h.isNote)o.beginWriteAction(),o.set(f,"note",void 0);else{var p=o.getItemList(f,h.arch);if(n.default.Assert(p,"If the item has been seen here, we will always have a valid parent list"),p){var g=p.indexOf(c);g>=0?(o.beginWriteAction(),p.remove(g)):n.default.Assert(!1,"If we previously saw this item, we expect to be able to delete it from the parent list")}}}h.ref||h.isRoot||(log(c,": Item exists remotely but is not referenced by a parent"),log("   : ",o.get(u[c],"text")),o.removeItemFromCache(c)),h.isRoot&&h.ref&&(log(c,": Remote root has a parent"),!0)}e.removeDeletedItems(t),o.endAction(),ShouldLog(LogLevels.Timing)&&log("Done Verifying Remote Data: ",log.now())},o.migrateData=function(){var e=i(6).default,t=!1,a=!1,s=!1,r=!1,l=!1,d=o.root.get("dataVersion");if(n.default.Assert(n.default.isNumber(d),"Remote data version must always be numeric",d),d<6){o.beginAction(),log("Migrating to latest version: ",d);try{switch(d){case 0:case 1:case 2:case 3:case 4:r=!0,log("Remote Migration Completed");break;case 5:break;default:n.default.Assert(!1,"Unknown remoteVersion: ",d)}}catch(e){s=!0,n.default.reportError(e)}o.endAction(),o.model.getRoot().set("dataVersion",6),log("Done Migrating Remote Data!",6)}else d>6&&(a=!0,t=!0);if(e.hasLocalData){var u=n.default.settings.get(Settings.localDataVersion)||0;if(n.default.Assert(n.default.isNumber(u),"Local data version must be numeric",u),n.default.isNumber(u))if(u<6){try{switch(u){case 0:case 1:case 2:case 3:case 4:t=!0,l=!0,log("Local Migration Completed");break;case 5:n.default.vmMain.cacheManager.notifyMigrationRequired();break;default:n.default.Assert(!1,"Unknown localVersion",u)}}catch(e){a=!0,n.default.reportError(e)}n.default.settings.set(Settings.localDataVersion,6),log("Done Migrating Local Data!",6)}else u>6&&n.default.Assert(!1,"localVersion is greater than our CURRENT_VERSION",u,6);else t=!0,n.default.menus.alert({text:"There was an error loading your document, please try loading a different document and contact support@moo.do.",actionText:"OKAY"})}else n.default.settings.set(Settings.localDataVersion,d);if(r)!function(){var e=i(6).default;n.default.menus.alert({text:"You are using an out of date document - please contact support@moo.do for help.",actionText:"OKAY",callback:function(){n.default.vmMain.remoteAPI().driveTrash(n.default.settings.get(Settings.gdocId),function(){n.default.reportError(new Error("Successfully deleted out of date doc - "+n.default.settings.get(Settings.gdocId))),e.clearData(function(){n.default.reload()})},function(t){n.default.reportError(new Error("Error deleting out of date doc - "+t.error)),e.clearData(function(){n.default.reload()})})}})}();else if(l)n.default.AppCache.runOnFinish(function(){e.clearDataAndReload()},!0);else if(a||s)if(a&&!s)n.default.AppCache.runOnFinish(function(){n.default.reload()},!0);else if(s&&!a)o.registerSaveNotify(function(){n.default.reload()});else{var c=function(){2===++h&&n.default.reload()},h=0;n.default.AppCache.runOnFinish(c,!0),o.registerSaveNotify(c)}if(!t){var f=o.model.getRoot().get("recoverVersion")||0,p=n.default.settings.get(Settings.localRecoverVersion);void 0===p||!e.hasLocalData&&f>p?n.default.settings.set(Settings.localRecoverVersion,f):f>p&&e.hasLocalData&&(t=!0,e.addDefaultSkipSetting(Settings.gdocId,"Default"),e.addDefaultSkipSetting(Settings.gdocTitle,"Default"),n.default.AppCache.runOnFinish(function(){e.clearDataAndReload()},!0))}return t},o.beginAction=function(e){o.model&&!o.isReadOnly()&&(n.default.Assert(!o.flushingDeferredActions,"Should never begin a new action while flushing"),n.default.Assert(!o.inCompoundOperation,"Should not nest compound operations"),n.default.Assert(!o.wantCompoundOperation,"Should not nest compound operations"),n.default.Assert(!o.isClosed,"Document must be open to make changes"),o.wantCompoundOperation=!0,o.actionsPreventUndo=!!e)},o.beginWriteAction=function(e){if(o.model&&!o.isReadOnly()&&(n.default.Assert(void 0===e||o.actionsPreventUndo===!!e,"Compound operations prevent undo must match",o.actionsPreventUndo,e),!o.flushingDeferredActions))if(n.default.Assert(o.inCompoundOperation||o.wantCompoundOperation,"If performing an action, we should have already requested a compound operation"),!o.inCompoundOperation&&o.wantCompoundOperation)try{o.deferredActionsCommitted&&o.flushDeferredActions(),l=setTimeout(c,0);0,o.model.beginCompoundOperation(void 0,!o.actionsPreventUndo),o.inCompoundOperation=!0,o.wantCompoundOperation=!1,o.deferredActionsCommitted||o.executeDeferredActions()}catch(e){n.default.reportError(e)}else n.default.Assert(!o.wantCompoundOperation,"Should not nest compound operations")},o.endAction=function(){if(o.model&&!o.isReadOnly()){n.default.Assert(!o.flushingDeferredActions,"Should never end an action while flushing"),n.default.Assert(!o.isClosed,"Document must be open to make changes"),n.default.Assert(o.inCompoundOperation||o.wantCompoundOperation,"If ending an action, a beginning should have happened");try{o.hasPendingDeferredActions&&(o.deferredActionsCommitted=!0),o.inCompoundOperation&&o.model.endCompoundOperation()}catch(e){n.default.goog.recoverFromError(e)}finally{o.inCompoundOperation=!1,o.wantCompoundOperation=!1,o.actionsPreventUndo=!1,clearTimeout(l),l=void 0}}};var h,f,p={};function g(e){n.default.Assert(e,"Must have a valid local item to attach events to"),n.default.Assert(n.default.isVMLI(e),"Must pass in a valid instace of a local item"),n.default.Assert(e.shouldSave(),"Item must be marked as saveable"),n.default.Assert(e.data,"Must have a valid remote item to attach events to"),e.data.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,e.onObjectChanged.bind(e))}function m(e){o.beginWriteAction(),n.default.Assert(n.default.isVMLI(e)),n.default.Assert(e.shouldSave(),"Item must be marked as saveable"),n.default.Assert(e.data,"Must have valid remote item to attach events to and create");var t=o.get(e.data,"items");return t||(t=o.model.createList(),o.set(e.data,"items",t)),t}function v(e){o.beginWriteAction(),n.default.Assert(n.default.isVMLI(e)),n.default.Assert(e.shouldSave(),"Item must be marked as saveable"),n.default.Assert(e.data,"Must have valid remote item to attach events to and create");var t=o.get(e.data,"archivedItems");return t||(t=o.model.createList(),o.set(e.data,"archivedItems",t)),t}function _(e){o.beginWriteAction();var t=o.getVersion(e,VersionType.Structure);t=t?t+1:1,o.set(e,"version",t)}o.performDeferredAction=function(e,t){if(n.default.Assert(e,"Must supply a valid item to perform the action on"),n.default.Assert(t,"Must supply a valid action to be performed"),o.model&&!o.isReadOnly()){if(n.default.Assert(!o.inCompoundOperation,"Cannot perform deferred action after a compound operation has started"),p[e.id])for(var i in t)p[e.id].changes[i]=t[i];else p[e.id]={item:e,changes:t};o.hasPendingDeferredActions=!0,clearTimeout(h),h=setTimeout(o.flushDeferredActions,800)}},o.executeDeferredActions=function(){o.flushingDeferredActions=!0;try{for(var e in p)x(p[e].item,p[e].changes)}catch(e){n.default.reportError(e)}finally{o.flushingDeferredActions=!1,o.hasPendingDeferredActions=!1,p={},o.deferredActionsCommitted=!1}},o.flushDeferredActions=function(){if(o.model&&!o.isClosed&&(n.default.Assert(!o.flushingDeferredActions,"Should never recursively call flushDeferredActions"),n.default.Assert(!o.inCompoundOperation,"Must flush deferred actions before starting a compound operation"),o.hasPendingDeferredActions)){clearTimeout(h),h=void 0;try{0,o.model.beginCompoundOperation(void 0),o.executeDeferredActions(),o.model.endCompoundOperation()}catch(e){n.default.reportError(e)}}},o.hasPotentialUnsavedData=function(){var e=i(6).default;return!(!e||!e.hasMadeInMemoryOnlyUpdate||o.isConnected()&&!(o.doc.saveDelay>n.default.seconds(1)))},o.hasDeferredAction=function(e){return!!p[e]},o.createNewItem=function(e,t,i){n.default.Assert(!o.isReadOnly(),"Should never create a new item in a read-only doc"),o.beginWriteAction(),n.default.Assert(n.default.isVMLI(e),"Must pass in a valid instace of a local item"),n.default.Assert(e.shouldSave(),"Item must be marked as saveable"),n.default.Assert(o.inCompoundOperation,"Should always create an item inside of a compound operation"),n.default.Assert(!o.isClosed,"Document must be open to make changes"),n.default.Assert(o.model,"Need a valid model to create collaborative items"),n.default.Assert(!e.data,"When initializing a new item, it should have no gdata components already");var a=o.model.createMap();if(e.data=a,e.data.connectIdentifier=o.connectIdentifier(),n.default.Assert(e.getRawText().indexOf(window.AttachChar)<0,"Remote syncd changes should never contain AttachChar"),o.set(a,"text",e.getRawText()),t){var s=o.model.createList();o.set(a,"items",s)}if(i){var r=o.model.createList();o.set(a,"archivedItems",r)}return o.set(a,"dateCreated",e.dateCreated.getTime()),e.isNote()&&o.set(a,"isNote",!0),e.id=a.id,u[a.id]||(u[a.id]=a),a.id},o.initializeNewItem=function(e){if(n.default.Assert(!o.isReadOnly(),"Should never initialize a new item in a read-only doc"),o.beginWriteAction(),n.default.Assert(n.default.isVMLI(e),"Must pass in a valid instace of a local item"),n.default.Assert(e.shouldSave(),"Item must be marked as saveable"),n.default.Assert(!o.isClosed,"Document must be open to make changes"),n.default.Assert(o.inCompoundOperation,"Should always initialize an item inside of a compound operation"),e.hasChildren()){var t=0,i=e.getItems(),a=m(e);n.default.Assert(a,"Must have a valid collab list for normal init");for(var s=0;s<i.length;++s){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;n.default.Assert(i[s].data,"Item must have a valid remote to be added to a collab list"),o.setItemParent(i[s].data,e.data),a.push(i[s].data)}}if(e.hasArchivedChildren()){var r=0,l=e.archivedItems(!0),d=v(e);n.default.Assert(d,"Must have a valid collab list for archived init");for(s=0;s<l.length;++s){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;n.default.Assert(l[s].data,"Item must have a valid remote to be added to a collab list"),o.setItemParent(l[s].data,e.data),d.push(l[s].data)}}if(e.hasNote()){var u=e.getNote();n.default.Assert(u.data,"Note must have a valid remote to be added to an item"),o.setItemParent(u.data,e.data),o.set(e.data,"note",u.data)}e.isNote()&&o.set(e.data,"isNote",!0),e.parent()&&o.setItemParent(e.data,e.parent().data),g(e)},o.attachEventsToItem=function(e){n.default.Assert(n.default.isVMLI(e),"Must pass in a valid local item"),n.default.Assert(e.shouldSave(),"Item must be marked as saveable"),n.default.Assert(e.data,"Must have loaded data from gdrive before attaching events to item"),g(e)},o.registerForUndoRedoStateChange=function(e){o.model?(o.model.addEventListener(gapi.drive.realtime.EventType.UNDO_REDO_STATE_CHANGED,e.stateChangeForUndoRedo),e.stateChangeForUndoRedo({canUndo:o.model.canUndo,canRedo:o.model.canRedo})):f=e},o.registerForSaveStateChange=function(e){n.default.Assert(o.doc,"Must have a valid doc to connect to"),o.doc.addEventListener(gapi.drive.realtime.EventType.DOCUMENT_SAVE_STATE_CHANGED,e)},o.loadCollaborators=function(){for(var e,t=0,i=o.doc.getCollaborators(),a=0;a<i.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=i[a];s.isMe&&(e=s)}o.authenticatedUser.set(e),e&&n.default.settings.set(Settings.displayName,e.displayName)},o.undoAction=function(){o.flushDeferredActions(),n.default.Assert(!o.isClosed,"Document must be open to make changes"),n.default.Assert(o.model.canUndo,"Remote model must be able to undo");try{o.model.undo()}catch(e){n.default.reportError(e)}},o.redoAction=function(){o.flushDeferredActions(),n.default.Assert(!o.isClosed,"Document must be open to make changes"),n.default.Assert(o.model.canRedo,"Remote model must be able to redo"),n.default.vmMain.beginUpdateItems();try{o.model.redo()}catch(e){n.default.reportError(e)}n.default.vmMain.commitUpdateItems()},o.getItemParent=function(e){return e._mdParent},o.setItemParent=function(e,t){n.default.Assert(e,"Must provide a valid model when setting the item parent"),n.default.Assert(!n.default.isVMLI(e),"Must pass in a valid remote item for child"),n.default.Assert(!n.default.isVMLI(t),"Must pass in a valid remote item for parent"),n.default.Assert(!e||e.type===gapi.drive.realtime.CollaborativeTypes.COLLABORATIVE_MAP,"Model must be a valid Map"),n.default.Assert(!t||t.type===gapi.drive.realtime.CollaborativeTypes.COLLABORATIVE_MAP,"Parent must be a valid Map"),e&&!n.default.isString(e)&&(e._mdParent=t)},o.getItemList=function(e,t){return o.beginWriteAction(),n.default.Assert(!n.default.isVMLI(e),"Must pass in a valid remote item"),t?o.get(e,"archivedItems"):o.get(e,"items")},o.ensureItemList=function(e,t){return o.beginWriteAction(),n.default.Assert(n.default.isVMLI(e),"Must pass in a valid local item"),n.default.Assert(e.shouldSave(),"Item must be marked as saveable"),t?v(e):m(e)},o.canSave=function(e){if(o.initialized){var t=n.default.isVMLI(e)?e.data:e;return n.default.Assert(t,"Must have a valid remote item to make changes"),n.default.Assert(!o.isClosed,"Document must be open to make changes"),n.default.Assert(!t||t.connectIdentifier===o.connectIdentifier(),"Using remote item data that is out of date",t?t.connectIdentifier:-1,o.connectIdentifier()),!(!t||o.isClosed||t.connectIdentifier!==o.connectIdentifier())&&t}},o.deleteTree=function(e){var t=i(6).default;if(o.beginWriteAction(),n.default.Assert(e,"Must provide a valid item instance to deleteTree"),n.default.Assert(!n.default.isVMLI(e),"Must not be a VMLI, should be a remote item"),n.default.Assert(!n.default.isString(e),"Must pass in a valid remote item not an ID"),e){o.setItemParent(e,void 0);var a=t.getItem(e.id);a&&a.data&&a.data===e&&(a.data=void 0);var s=o.getItemList(e,!1);if(s)for(var r=0,l=0;l<s.length;++l){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;var d=s.get(l);o.deleteTree(d)}var u=o.getItemList(e,!0);if(u){var c=0;for(l=0;l<u.length;++l){if(c++>5e3&&__infLoop&&__infLoop(c))throw new RangeError;var h=u.get(l);o.deleteTree(h)}}o.removeItemFromCache(e.id)}};var y="noteSet",S="itemAdded",w="itemsAdded",I="itemRemoved",b="itemMoved",A="itemArchived",D="itemUnarchived",T="Exception",M="NoData",C="NoSrcList",L="NoDstList",P="InvalidSrcIndex",E="InvalidDstIndex";function k(e,t,i){i||(i=new Error("DocError: "+e+"."+t)),o.docErrors.push({fn:e,type:t,data:i}),n.default.reportError(i)}function x(e,t){n.default.Assert(e.shouldSave(),"Item must be marked as saveable");var a=o.canSave(e);if(a)if(n.default.isEmpty(t))ShouldLog(LogLevels.Warning)&&log("Skipped remote saving an empty object");else{var s=i(6).default;for(var r in o.beginWriteAction(),s.addPendingUpdate(e.id),t.hasOwnProperty("dateFormat")&&o.set(a,"dateFormat",t.dateFormat),t)if(n.default.Assert(t.hasOwnProperty(r),"Changes should only contain properties they own"),t.hasOwnProperty(r))switch(r){case"text":n.default.Assert(n.default.isString(t.text)),n.default.Assert(t.text.indexOf(window.AttachChar)<0,"Remote syncd changes should never contain AttachChar"),n.default.Assert(e.isNote()||t.text.indexOf("\n")<0,"Remote syncd changes should never contain newlines"),o.set(a,"text",t.text);break;case"date":n.default.Assert(!t.date||n.default.isNumber(t.date),"Invalid date type"),o.set(a,"date",t.date);break;case"dateFormat":break;case"repeatDate":n.default.Assert(!t.repeatDate||n.default.isString(t.repeatDate),"Invalid repeat date type"),o.set(a,"repeatDate",t.repeatDate);break;case"dateCreated":n.default.Assert(n.default.isNumber(t.dateCreated),"Invalid dateCreated type"),o.set(a,"dateCreated",t.dateCreated);break;case"dateCompleted":n.default.Assert(!t.dateCompleted||n.default.isNumber(t.dateCompleted),"Invalid dateCompleted type"),o.set(a,"dateCompleted",t.dateCompleted);break;case"allDayDate":case"priority":case"isComplete":case"isStarred":case"favorites":o.set(a,r,t[r]);break;case"isCollapsed":case"isArchived":case"isNote":case"note":n.default.Assert(!1,"These properties are not set this way"),o.set(a,r,t[r]);break;case"modifiedOfflineText":case"dateText":case"durationText":case"duration":break;default:n.default.Assert(!1,"Attempting to remotely save an unknown field: ",r)}!function(e){o.beginWriteAction();var t=o.getVersion(e,VersionType.Text);t=t?t+1:1,o.set(e,"versionText",t)}(a)}}o.docErrors=[],o.noteSet=function(e,t){if(!o.isConnected())return ReturnValue.Success;if(o.isReadOnly())return ReturnValue.Success;o.beginWriteAction(),n.default.Assert(e,"Must provide a valid item to set a note on"),n.default.Assert(!t||t.isNote(),"Must be removing a note or setting note with a valid note item");try{var i,a=o.canSave(e);if(!a)return k(y,M),ReturnValue.Error;if(t){if(!(i=o.canSave(t)))return k(y,M),ReturnValue.Error;o.set(i,"isNote",!0)}n.default.Assert(!t||!o.get(a,"note"),"Should not set a note on an item that already has a note"),o.set(a,"note",i)}catch(e){throw k(y,T,e),e}return ReturnValue.Success},o.itemAdded=function(e){if(!o.isConnected())return ReturnValue.Success;if(o.isReadOnly())return ReturnValue.Success;var t=i(6).default;o.beginWriteAction();var a=e.item,s=e.addedItem,r=e.index,l=e.isArchived,d=e.noVersion;n.default.Assert(void 0!==a&&void 0!==s&&void 0!==l,"itemAdded is missing parameters"),n.default.Assert(r>=-1||void 0===r,"Invalid index",r);try{var u=o.canSave(a);if(!u)return k(S,M),ReturnValue.Error;var c=o.canSave(s);if(!c)return k(S,M),ReturnValue.Error;t.addPendingUpdate(a.id),t.addPendingUpdate(s.id),n.default.Assert(!a.isNote(),"Should not add a child to a note");var h=o.ensureItemList(a,l);n.default.Assert(h,"Must have a valid remote list to add the item to"),n.default.Assert(isNaN(r)||r<=h.length,"Should not try to insert an item after the end of the array"),n.default.Assert(isNaN(r)||r>=0,"Should not try to insert an item at a negative index"),r<0||isNaN(r)||r>h.length?h.push(c):h.insert(r,c),d||_(c),o.setItemParent(c,u),o.cacheItem(c)}catch(e){throw k(S,T,e),e}return ReturnValue.Success},o.itemsAdded=function(e){if(!o.isConnected())return ReturnValue.Success;if(o.isReadOnly())return ReturnValue.Success;var t=i(6).default;o.beginWriteAction();var a=e.item;n.default.Assert(n.default.isVMLI(a),"Passed in item must be a VMLI");var s=e.addedItems,r=e.index,l=e.isArchived,d=e.noVersion;n.default.Assert(void 0!==a&&void 0!==s&&void 0!==l,"itemsAdded is missing parameters"),n.default.Assert(isNaN(r)||r>=0,"Must provide a valid item index when adding an item to a remote list");try{var u=0;if(!o.canSave(a))return k(w,M),ReturnValue.Error;var c=o.ensureItemList(a,l);n.default.Assert(c,"Must have a valid remote list to add the item to"),n.default.Assert(r<=c.length,"Should not insert items after the end of the remote list");for(var h=new Array(s.length),f=0;f<s.length;++f){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;n.default.Assert(!s[f].isNote(),"Should never be adding a note as a child"),h[f]=s[f].data,t.addPendingUpdate(s[f].id),!d&&h[f]&&_(h[f]),o.setItemParent(h[f],a),o.cacheItem(h[f])}t.addPendingUpdate(a.id),n.default.Assert(!a.isNote(),"Should never be adding a child to a note"),r<0||isNaN(r)?(n.default.Assert(l,"Only archived items should be inserted into a list by pushing"),c.pushAll(h)):c.insertAll(r,h)}catch(e){throw k(w,T,e),e}return ReturnValue.Success},o.itemRemoved=function(e){if(!o.isConnected())return ReturnValue.Success;if(o.isReadOnly())return ReturnValue.Success;var t=i(6).default;o.beginWriteAction();var a=e.item,s=e.index,r=e.numToRemove,l=e.isArchived,d=e.noDelete,u=e.noVersion;n.default.Assert(void 0!==a&&void 0!==s&&void 0!==r&&void 0!==l,"itemRemoved is missing parameters"),n.default.Assert(s>=0,"Must have a valid index to remove from");try{var c=0,h=o.canSave(a);if(!h)return k(I,M),ReturnValue.Error;isNaN(r)&&(r=1);var f=o.getItemList(h,l);if(!f)return k(I,C),ReturnValue.Error;n.default.Assert(s+r<=f.length,"Should not be removing items past the end of the remote list");for(var p=s;p<s+r;++p){if(c++>5e3&&__infLoop&&__infLoop(c))throw new RangeError;var g=f.get(p);t.addPendingUpdate(g.id),u||_(g),d||o.deleteTree(g)}t.addPendingUpdate(a.id),1===r?f.remove(s):f.removeRange(s,s+r)}catch(e){throw k(I,T,e),e}return ReturnValue.Success},o.itemMoved=function(e){if(!o.isConnected())return ReturnValue.Success;if(o.isReadOnly())return ReturnValue.Success;var t=i(6).default;o.beginWriteAction();var a=e.item,s=e.newInfo,r=e.oldParent,l=e.oldInfo,d=e.noVersion;n.default.Assert(void 0!==a&&void 0!==s&&void 0!==r&&void 0!==l,"itemMoved is missing parameters"),n.default.Assert(s&&s.index>=-1,"Must supply a valid new item index"),n.default.Assert(s&&void 0!==s.isArchived,"Must determine if this item is archived or not"),n.default.Assert(r,"Must specify a valid old parent"),n.default.Assert(l&&l.index>=0,"Must supply a valid old item index"),n.default.Assert(l&&void 0!==l.isArchived,"Must determine if this item was archived or not");try{var u=o.canSave(a);if(!u)return k(b,M),ReturnValue.Error;var c=o.canSave(r);if(!c)return k(b,M),ReturnValue.Error;var h=o.canSave(a.parent());if(!h)return k(b,M),ReturnValue.Error;var f=o.getItemList(c,l.isArchived);if(!f)return k(b,C),ReturnValue.Error;if(l.index>=f.length)return k(b,P),ReturnValue.Error;var p=o.ensureItemList(a.parent(),s.isArchived);if(!p)return k(b,L),ReturnValue.Error;if(s.index>p.length)return k(b,E),ReturnValue.Error;var g=s.index;(s.index<0||isNaN(s.index)||s.index>p.length)&&(g=p.length),f.moveToList(l.index,p,g),o.setItemParent(u,h),t.addPendingUpdate(a.id),t.addPendingUpdate(r.id),t.addPendingUpdate(a.parent().id),n.default.Assert(!a.isNote(),"Should never move a note as a child"),n.default.Assert(!a.parent().isNote(),"Notes should never have children"),d||_(u)}catch(e){throw k(b,T,e),e}return ReturnValue.Success},o.itemArchived=function(e,t,a){if(!o.isConnected())return ReturnValue.Success;if(o.isReadOnly())return ReturnValue.Success;var s=i(6).default;o.beginWriteAction(),n.default.Assert(a>=0,"Must have a valid index to remove from");try{var r=o.canSave(e);if(!r)return k(A,M),ReturnValue.Error;if(!o.canSave(t))return k(A,M),ReturnValue.Error;var l=o.getItemList(r,!1);if(!l)return k(A,C),ReturnValue.Error;var d=v(e);if(!d)return k(A,L),ReturnValue.Error;if(!(a<l.length))return k(A,P),ReturnValue.Error;l.moveToList(a,d,d.length),s.addPendingUpdate(e.id),s.addPendingUpdate(t.id),n.default.Assert(!e.isNote(),"Parents should never be archiving notes"),_(t.data)}catch(e){throw k(A,T,e),e}return ReturnValue.Success},o.itemUnarchived=function(e,t,a,s){if(!o.isConnected())return ReturnValue.Success;if(o.isReadOnly())return ReturnValue.Success;var r=i(6).default;o.beginWriteAction(),n.default.Assert(a>=0,"Must have a valid index to remove from");try{var l=o.canSave(e);if(n.default.Assert(l,"Must have valid item data when archiving an item"),!l)return k(D,M),ReturnValue.Error;if(!o.canSave(t))return k(D,M),ReturnValue.Error;var d=o.get(l,"items");n.default.Assert(d,"Must be an items array present");var u=o.get(l,"archivedItems");n.default.Assert(u,"Must be an archived items array present"),u.moveToList(a,d,s),r.addPendingUpdate(e.id),r.addPendingUpdate(t.id),_(t.data)}catch(e){throw k(D,T,e),e}return ReturnValue.Success},o.saveChanges=function(e,t){o.isConnected()&&(o.isReadOnly()||(t&&t.text&&(n.default.Assert(t.text.indexOf(window.AttachChar)<0,"Remote syncd changes should never contain AttachChar"),n.default.Assert(e.isNote()||t.text.indexOf("\n")<0,"Remove syncd changes should never contain newlines")),o.inCompoundOperation||o.actionsPreventUndo?x(e,t):o.performDeferredAction(e,t)))},o.resetDriveData=function(){u={},o.initialized=!1,o.doc=void 0,o.model=void 0,o.root=void 0,o.rootItem=void 0,o.rootID=void 0,window.__remoteDoc=void 0,o.cachesRemote=void 0,i(6).default.forEachModel(function(e){e.resetDriveData()}),n.default.vmMain.notifyDriveDisconnect(),o.inCompoundOperation=!1,o.wantCompoundOperation=!1,o.flushingDeferredActions=!1,o.deferredActionsCommitted=!1,clearTimeout(l),l=void 0,clearTimeout(h),h=void 0,o.hasPendingDeferredActions=!1,p={}},o.clearItemEventListeners=function(){i(6).default.forEachModel(function(e){e.data&&e.data.removeAllEventListeners()})},o.close=function(e){if(n.default.Assert(e||U===B.Error,"Invalid state for document close: ",U),n.default.Assert(!o.wantCompoundOperation,"Closing the doc with a deferred compound operation"),o.doc&&!o.isClosed){log("---- Closing Remote Document! ----"),o.isClosed=!0,n.default.vmMain.setGDriveStatus(DriveStatus.Offline);try{o.doc.close()}catch(e){log("Error Closing Doc: ",e)}o.resetDriveData()}else n.default.vmMain.isReconnecting()&&n.default.vmMain.setGDriveStatus(DriveStatus.Offline)};var R,O=0,F=[1e3,2e4,4e4,6e4,9e4];function N(){n.default.Assert(U===B.Error||U===B.XHRError,"Invalid state for request reconnect: ",U),clearTimeout(R),R=void 0,n.default.goog.reconnectToActiveDocument()}o.setupReconnect=function(){n.default.Assert(U===B.Error||U===B.XHRError,"Invalid state for setup reconnect: ",U),n.default.Assert(!R,"Reconnect timer already active");var e,t=(e=O++,F[Math.min(e,F.length-1)]);clearTimeout(R),R=setTimeout(N,t)},o.notifyReconnectFailure=function(){o.setupReconnect()},o.notifyReconnectSuccess=function(){O=0,clearTimeout(R),R=void 0};var B={Disconnected:0,Connecting:1,Connected:2,Reconnecting:3,Error:4,XHRError:5},U=B.Disconnected;function V(e){var t=U;if(U=e,log("Change Realtime Status: ",t," -> ",e),t!==e)switch(t){case B.Disconnected:n.default.Assert(e===B.Connecting,"Invalid state switch",t,e);break;case B.XHRError:case B.Error:n.default.Assert(e===B.Reconnecting||e===B.Connected,"Invalid state switch",t,e),e===B.Connected&&o.notifyReconnectSuccess();break;case B.Connected:n.default.Assert(e===B.Error,"Invalid state switch",t,e),e===B.Error&&(o.close(),o.setupReconnect());break;case B.Connecting:case B.Reconnecting:n.default.Assert(e===B.Error||e===B.Connected,"Invalid state switch",t,e),e===B.Error?(o.close(),o.setupReconnect()):e===B.XHRError?(o.close(),o.notifyReconnectFailure()):e===B.Connected&&t===B.Reconnecting&&o.notifyReconnectSuccess();break;default:n.default.Assert(!1,"Invalid status: ",t,e)}}o.getDriveRealtimeStatus=function(){return U};var H=1;function q(e){(!e||4===e.readyState&&200!==e.status)&&V(B.XHRError)}o.connectIdentifier=function(){return H};var z=!1;o.driveRealtimeLoad=function(e,t,i,a){n.default.Assert(U===B.Disconnected||U===B.Error,"Loading realtime document from invalid state");var s,r=U;U===B.Disconnected?V(B.Connecting):U!==B.Error&&U!==B.XHRError||V(B.Reconnecting),r!==B.Disconnected&&r!==B.Error&&r!==B.XHRError||(z=n.default.registerURLForNotifyXHR("https://drive.google.com/otservice/gs",q),n.default.Assert(z,"XHR must always be successfully wrapped"),n.default.checkpoint(Checkpoint.DocLoadRequested),gapi.drive.realtime.load(e,(s=t,n.default.Assert(s,"Must pass a valid CB for doc loaded"),function(e){n.default.batchRenderUpdates(function(){V(B.Connected),H++,s(e)})}),function(e){return n.default.Assert(e,"Must pass a valid CB for doc initialized"),function(t){V(B.Connected),e(t)}}(i),function(e){return n.default.Assert(e,"Must pass a valid CB for doc error"),function(t){e(t)&&V(B.Error)}}(a)))},o.onInitialized=function(e){log("Initializing",e);var t=e.createMap(),i=e.createList();o.set(t,"text",s.a.RootItemName),o.set(t,"items",i),o.set(t,"archivedItems",e.createList()),o.set(t,"dateCreated",Date.now());var a=e.getRoot();a.set("dataVersion",6),a.set("root",t);var r=n.default.vmMain.docManager.getOpenDoc();n.default.Assert(r,"Must have an open doc to be initializing a realtime doc"),r.getDocumentFolder(function(e){a.set("docFolderID",e)}),a.set("settings",e.createMap()),a.set("caches",e.createMap())},o.onFirstInitialized=function(e){var t=e.getRoot().get("root");function i(t,i){var a=e.createMap();o.set(a,"text",i),o.set(a,"dateCreated",(new Date).getTime());var n=o.get(t,"items");return n||(n=e.createList(),o.set(t,"items",n)),n.push(a),a}var a=i(t,"# Welcome to Moo.do");i(a,"Press **Tab** to indent and **Shift + Tab** to unindent"),i(a,"Use #tags and dates @today 4pm to get organized"),i(a,""),i(a=i(t,"# Start a line with # to create a project"),"[ Start a line with [ to create a task"),i(a=i(a,"# Use hierarchy to organize projects and sub-projects"),"Now delete this and add your own projects"),n.default.vmMain.runFirstRun()};var W={};o.maxCacheEntrySize=function(){return 300},o.cacheChanged=function(e,t){var i=0;if(t.ocHandled||t.isLocal)return!1;for(var a=0;a<t.events.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=t.events[a];switch(s.type){case gapi.drive.realtime.EventType.VALUES_ADDED:o.notifyListeners(e,DataChangeType.Add,s.property,s.newValue);break;case gapi.drive.realtime.EventType.VALUES_REMOVED:o.notifyListeners(e,DataChangeType.Remove,s.property,s.newValue);break;case gapi.drive.realtime.EventType.VALUE_CHANGED:o.notifyListeners(e,DataChangeType.Change,s.property,s.newValue);break;case gapi.drive.realtime.EventType.TEXT_DELETED:case gapi.drive.realtime.EventType.TEXT_INSERTED:case gapi.drive.realtime.EventType.VALUES_SET:default:n.default.Assert(!1,"Unexpected event type")}}};var G={};function j(e){return n.default.Assert(!e||n.default.isString(e),"Must always be saving a string to remote cache"),e?e.length:0}function K(e,t){for(var i=0,a=!0,s=t.get("data").items(),r=0;r<s.length;++r){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var o=s[r][0],l=s[r][1];try{var d=JSON.parse(l);e._isPreviewData(d)||(a=!1,e._displayMissingProperties(o,d,PluginLoad.Preview))}catch(e){n.default.reportError(e),a=!1}}return a}o.notifyListeners=function(e,t,i,a){var s=G[e];n.default.Assert(s&&s.length>0,"Should always have an interested party if we are receiving notifications");try{var r,o=0;a&&((r=JSON.parse(a)).id=i);for(var l=0;l<s.length;++l){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;try{s[l](t,i,r)}catch(e){n.default.reportError(e)}}}catch(e){n.default.reportError(e)}},o.hookCacheListeners=function(){for(var e in G)try{o.hookCacheListener(e)}catch(e){n.default.reportError(e)}},o.hookCacheListener=function(e){var t=o.cachesRemote.get(e);n.default.Assert(t,"If we are listening for a cache, it must have been ensured first");var i=!1;if(t){var a=t.get("data");n.default.Assert(a,"Malformed cache, must have a data entry present"),a&&(a.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,o.cacheChanged.bind(o,e)),i=!0)}return i},o.registerForCacheChanges=function(e,t){n.default.Assert(t,"Must provide a valid callback function for cache changes");var i=!1,a=G[e];return a?(n.default.Assert(a.indexOf(t)<0,"Should never double register a listener"),a.push(t)):G[e]=[t],o.isCacheAvailable(e)&&(i=o.hookCacheListener(e)),i},o.unregisterForCacheChanges=function(e,t){var i=G[e];n.default.Assert(i,"Must have previously registered with a cache");var a=i.remove(t);return n.default.Assert(a>=0,"Did not try to remove a valid listener"),a>=0},o.loadDataCaches=function(){o.cachesRemote=o.root.get("caches"),o.cachesRemote||(o.cachesRemote=o.model.createMap(),o.root.set("caches",o.cachesRemote));try{var e=o.verifyCaches();n.default.Assert(e,"Preview caches are not in a fully valid state")}catch(e){n.default.reportError(e)}o.writeMissedCacheEntries(),o.sendAvailableNotifications(),o.hookCacheListeners()},o.queryCache=function(e,t){n.default.Assert(o.cachesRemote,"Caches must have been initialized"),n.default.Assert(!n.default.isTempId(t),"Should not query remote cache for local only items");var i=o.ensureCache(e);if(i){var a=JSON.parse(i.get("data").get(t));if(a)return a.id=t,a}},o.hasCacheEntry=function(e,t){n.default.Assert(o.cachesRemote,"Caches must have been initialized"),n.default.Assert(!n.default.isTempId(t),"Should not query remote cache for local only items");var i=o.ensureCache(e);return!!i&&!!i.get("data").get(t)},o.updateCache=function(e,t,i){var a;n.default.Assert(!n.default.isTempId(t),"Should never save a local only item to the remote cache");var s=o.ensureCache(e),r=i;try{n.default.Assert(!n.default.isString(i),"Should only be saving objects rather than raw strings in cache"),i=JSON.stringify(i)}catch(e){n.default.reportError(e),i=void 0}if(s){var l=j(a=s.get("data").get(t)),d=j(i);if(d<o.maxCacheEntrySize())try{var u=function(e){n.default.Assert(!e||n.default.isObject(e),"Must always pass in a valid object");var t={};for(var i in e)if(e.hasOwnProperty(i)){var a;try{a=n.default.isString(e[i])?e[i].length:JSON.stringify(e[i])}catch(e){n.default.reportError(e)}t[i]=a}}(r);n.default.Assert(d<o.maxCacheEntrySize(),"New cache entry too large",d,u)}catch(e){n.default.reportError(e)}var c=d-l,h=s.get("info");a||h.set("entries",h.get("entries")+1),c>0&&h.set("size",h.get("size")+c),void 0!==i?s.get("data").set(t,i):(n.default.Assert(a,"Should never be setting undefined->undefined"),s.get("data").delete(t))}else o.notifyMissedCacheWrite(e,t,r);return a},o.ensureCache=function(e){var t;if(o.cachesRemote&&!(t=o.cachesRemote.get(e))){0,o.model.beginCompoundOperation(),t=o.model.createMap();var i=o.model.createMap();i.set("entries",0),i.set("size",0),t.set("info",i);var a=o.model.createMap();t.set("data",a),o.cachesRemote.set(e,t),o.model.endCompoundOperation()}return t},o.clearCache=function(e){if(n.default.Assert(o.cachesRemote,"Caches must have been initialized"),o.cachesRemote){var t=o.cachesRemote.get(e);if(t){t.get("data").clear();var i=t.get("info");n.default.Assert(i,"Malformed cache, every cache must have an info object"),i.set("entries",0),i.set("size",0)}}},o.clearCaches=function(){},o.getCacheSize=function(e){if(n.default.Assert(o.cachesRemote,"Caches must have been initialized to get cache size"),o.cachesRemote){var t=o.cachesRemote.get(e);if(t)return t.get("info").get("size")}return 0},o.verifyCaches=function(){n.default.Assert(o.cachesRemote,"Caches must have been initialized to verify"),n.default.Assert(n.default.vmMain&&n.default.vmMain.pluginManager,"Must have intiialized VMMain and PluginManager");var e=!0;if(o.cachesRemote)for(var t=0,i=o.cachesRemote.keys(),a=0;a<i.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=n.default.vmMain.pluginManager.getPluginFromPreviewCache(i[a]);if(s)K(s,o.cachesRemote.get(i[a]))||(e=!1);else n.default.Assert(!1,"Unknown plugin in preview cache: ",i[a])}return e},o.isCacheAvailable=function(e){return!(!o.cachesRemote||!o.cachesRemote.get(e))};var Y=[];o.requestNotifyWhenAvailable=function(e){n.default.Assert(Y.indexOf(e)<0,"Should not push same callback multiple times"),o.cachesRemote||n.default.isDemoMode()?e():Y.push(e)},o.sendAvailableNotifications=function(){for(var e=0,t=0;t<Y.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;Y[t]()}Y=[]},o.notifyMissedCacheWrite=function(e,t,i){W[e]||(W[e]={}),W[e][t]=i},o.writeMissedCacheEntries=function(){n.default.Assert(o.cachesRemote,"When flushing missed cache writes, must have access to remote doc cache");var e=0;for(var t in W){var i=W[t];for(var a in i){var s=i[a];o.updateCache(t,a,s),e++}}W={},e>0&&n.default.reportError(new Error("Writing missed cache entries: "+e))},o.poke=function(){if(o.root&&!o.isClosed&&!o.isReadOnly())try{var e=o.root.get("poke");0,o.model.beginCompoundOperation("poke",!1),e?o.root.set("poke",e+1):o.root.set("poke",1),o.model.endCompoundOperation()}catch(e){log("Exception during poke, reconnecting: ",e),o.close(),o.setupReconnect()}},window.__poke=o.poke,o.rootChanged=function(e){var t=0;if(e.ocHandled||e.isLocal||o.root&&o.root.id!==e.target.id)return!1;for(var a=i(6).default,s=0;s<e.events.length;++s){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var r=e.events[s];switch(r.type){case gapi.drive.realtime.EventType.VALUES_ADDED:case gapi.drive.realtime.EventType.VALUES_REMOVED:break;case gapi.drive.realtime.EventType.VALUE_CHANGED:if("dataVersion"===r.property)r.newValue>6?n.default.AppCache.checkForUpdate(!0):r.newVersion<6&&n.default.reportError(new Error("Remote setting dataVersion to invalid value"+r.newVersion));else if("recoverVersion"===r.property){o.clearItemEventListeners(),n.default.settings.get(Settings.localRecoverVersion)<r.newValue&&(n.default.settings.set(Settings.localRecoverVersion,r.newValue),a.addDefaultSkipSetting(Settings.gdocId,"Default"),a.addDefaultSkipSetting(Settings.gdocTitle,"Default"),o.close(!0),n.default.menus.alert({text:"A remote user has recovered this document. The app needs to restart to continue editing.",actionText:"OKAY",callback:a.clearDataAndReload}))}break;case gapi.drive.realtime.EventType.TEXT_DELETED:case gapi.drive.realtime.EventType.TEXT_INSERTED:case gapi.drive.realtime.EventType.VALUES_SET:default:n.default.Assert(!1,"Unexpected event type")}}},o.isConnected=function(){return o.initialized&&!o.isClosed&&!!o.model},o.onLoad=function(e){try{try{window.__LOAD_HANDLES.push(n.default.getCurrentStack("Document Opened Handled"))}catch(e){n.default.reportError(e)}n.default.Assert(o.isClosed,"Document must not already be open when we are loading");try{o.isClosed||n.default.reportError(new Error("Multi-Document Load"),window.__LOAD_REQUESTS.ordered())}catch(e){n.default.reportError(e)}return o.initialized=!0,o.loadedOnce=!0,ShouldLog(LogLevels.Timing)&&log("Loading document from gdrive",log.now()),o.doc=e,o.model=e.getModel(),o.root=o.model.getRoot(),o.isReadOnly()&&n.default.vmMain.gdriveStatusObs.notify(),o.root.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,o.rootChanged),o.isClosed=!1,o.registerForSaveStateChange(o.onSaveStateChange),o.migrateData()?(log("---- Skipping Document Load! ----"),o.isClosed=!0,o.initialized=!1,o.doc=void 0,o.model=void 0,o.root=void 0,!1):(o.loadDataCaches(),o.rootItem=o.root.get("root"),o.rootItem?(o.rootID=o.rootItem.id,window.__remoteDoc=e,f&&(o.registerForUndoRedoStateChange(f),f=void 0),n.default.vmMain&&n.default.vmMain.isLoaded?n.default.vmMain.loadGDriveData():n.default.requireGDriveDataCallback=!0,o.loadCollaborators(),!0):void n.default.menus.alert({text:"Moo.do has encountered an error. The developers have been notified to make sure this doesn't happen again. If the problem persists, please contact support@moo.do.",actionText:"RELOAD",callback:function(){i(6).default.clearData(function(){n.default.reload()})}}))}catch(e){n.default.reportError(e)}},o.getServerVersion=function(){if(o.model&&!o.isClosed)return o.model.serverVersion};var X=[];o.registerSaveNotify=function(e){X.push(e)};var Q,J=!1,Z=!1;o.onSaveStateChange=function(e){if(J!==e.isPending||Z!==e.isSaving){if(e.isSaving||e.isPending)navigator.onLine?e.isSaving&&(e.isPending||n.default.vmMain.setGDriveStatus(DriveStatus.Saving),clearTimeout(Q),Q=setTimeout(o.onErrorSaving,o.offlineTimeoutMS)):n.default.vmMain.setGDriveStatus(DriveStatus.Offline);else{var t=0;n.default.vmMain.setGDriveStatus(DriveStatus.Saved),i(6).default.clearPendingUpdates(),clearTimeout(Q),Q=void 0,n.default.toasts.clearMessage(MessageID.ConnectionError);for(var a=0;a<X.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;X[a](o.numChanges)}o.numChanges=0,o.lastChangeTime.set(Date.now())}J=e.isPending,Z=e.isSaving}},o.onErrorSaving=function(){n.default.vmMain.setGDriveStatus(DriveStatus.Offline),Q=void 0},o.getVersion=function(e,t){var i;switch(n.default.Assert(!n.default.isVMLI(e),"Must pass in a valid remote item: ",n.default.getObjectInfo(e)),t){case VersionType.Structure:i=e.get(n.default.translateFieldIn("version"));break;case VersionType.Text:i=e.get(n.default.translateFieldIn("versionText"));break;default:i=-2,n.default.Assert(!1,"Invalid version type")}return i||0},o.get=function(e,t){return n.default.Assert(!n.default.isVMLI(e),"Must pass in a valid remote item: ",n.default.getObjectInfo(e)),e.get(n.default.translateFieldIn(t))},o.set=function(e,t,i){return n.default.Assert(!o.isReadOnly(),"Should never perform a write action on a read-only doc"),o.beginWriteAction(),n.default.Assert(!n.default.isVMLI(e),"Must pass in a valid remote item: ",n.default.getObjectInfo(e)),void 0===i&&(i=null),e.set(n.default.translateFieldIn(t),i)},o.delete=function(e,t){return n.default.Assert(!o.isReadOnly(),"Should never perform a write action on a read-only doc"),o.beginWriteAction(),n.default.Assert(!n.default.isVMLI(e),"Must pass in a valid remote item: ",n.default.getObjectInfo(e)),e.delete(n.default.translateFieldIn(t))},o.findInTree=function(e){n.default.Assert(e,"Must provide a valid item to find");var t=!1,i=o.getItemParent(e);if(i){var a=o.getItemList(i,!1),s=-1;if(a&&(s=a.indexOf(e)),s<0){var r=o.getItemList(i,!0);r&&(s=r.indexOf(e))>=0&&(t=!0)}}var l=void 0;return i&&s>=0&&(l={parent:i,index:s,isArchived:t}),l},t.a=o},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(26),r=i(2),o=i.n(r),l=i(46),d=i.n(l),u=i(12),c=i(55),h=u.a.createClass({displayName:"FancyButton",componentDisplay:n.a.ComponentDisplay.Everywhere,init:function(){this.createObservables({isLoading:!1})},getElement:function(){return d.a.findDOMNode(this)},onClick:function(e){this.isLoading.get()||!1===this.props.enabled||(this.props.onClick||this.props.onMouseDown)(e,this.onButtonClickCallback)&&this.isLoading.set(!0)},onMouseDown:function(e){if(!1!==this.props.enabled&&e.button===ButtonCode.Left&&this.props.onHold){var t={target:e.target,preventDefault:e.preventDefault};this._holdTimeout=setTimeout(this.onHold,150,t)}},onMouseUp:function(e){this._clearHoldTimeout(),this.props.onMouseUp&&this.props.onMouseUp(e)},onHold:function(e){this._clearHoldTimeout(),this.props.onHold(e)},_clearHoldTimeout:function(){this._holdTimeout&&(clearTimeout(this._holdTimeout),this._holdTimeout=0)},onKeyDown:function(e){e.keyCode===KeyCode.Enter&&this.onClick(e)},focus:function(){this.getElement().focus()},onButtonClickCallback:function(){this.isLoading.set(!1)},removeRipple:function(){this.ripples.removeAt(0)},render:function(){var e,t=this.state,i=this.props,n=!1===i.enabled;i.color?e=i.color:i.primary?e=i.raised?"c-button-raised-primary":"c-button-primary":i.heavy?i.raised||(e="c-button-heavy"):e=i.cancel?i.raised?"c-button-raised-cancel":"c-button-cancel":i.raised?"c-button-raised":"c-button";var r={display:i.display,lineHeight:i.height?"auto"===i.height?null:i.height+"px":"36px",height:i.height,width:i.width,textAlign:"center",margin:i.margin,paddingLeft:i.paddingLeft,paddingTop:i.paddingTop,paddingRight:i.paddingRight,paddingBottom:i.paddingBottom,fontWeight:i.fontWeight,fontSize:i.fontSize,color:i.color};void 0===i.margin&&(r.marginLeft=i.marginLeft,r.marginTop=i.marginTop,r.marginRight=i.marginRight,r.marginBottom=i.marginBottom),r=a.default.extend(r,this.props.style),i.raised&&!i.children&&i.icon&&!1!==i.round&&(r.borderRadius="50%");var l,d={fontSize:i.fontSize};if(i.icon){var u={height:i.height,fontSize:i.iconSize},h=a.default.classNames("fancyButtonIcon",i.icon,{"c-button":!1});i.children?0!==i.padding&&(d.paddingLeft="6px",d.paddingRight=0,r.paddingLeft="16px",r.paddingRight="16px"):(r.width=i.width||36,r.height=i.height||36,r.textAlign="center"),l=o.a.createElement("i",{className:h,style:u})}isNaN(i.padding)||(d.padding="0 "+i.padding+"px");var f=i.children&&o.a.Children.count(i.children)>0,p=a.default.classNames("fancyButtonText"),g=f&&o.a.createElement("div",{className:p,style:d},i.children),m=a.default.classNames("fancyButton",e,{raised:i.raised},{loading:t.isLoading},{primary:i.primary},{cancel:i.cancel},{hasText:f},{hasIcon:!!i.icon},{disabled:n},{selected:i.selected},i.className),v=t.isLoading&&o.a.createElement("div",{className:"fancyButtonLoading"},o.a.createElement("i",{className:"icon-spinner"})),_=i.tooltipHotkey,y=_?a.default.isString(_)?_:s.a.printHotkeyByName(_.name,_.group):void 0;return o.a.createElement(c.a,{className:m,style:r,enabled:i.enabled,onMouseEnter:void 0,onMouseLeave:void 0,onMouseDown:i.onHold&&this.onMouseDown||void 0,onMouseUp:void 0,onClick:i.onClick?this.onClick:void 0,onDoubleClick:i.onDoubleClick,onRightClick:i.onRightClick,onKeyDown:this.onKeyDown,id:i.id,center:i.center||!!i.icon&&!f,ripple:i.ripple,tabIndex:i.tabIndex,"data-tooltip":!n&&i.tooltip?i.tooltip:null,"data-tooltiphotkey":n?null:y},l,g,v)}});t.a=h},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(4),r=i(35);function o(){this.ErrorTimeout=a.default.seconds(30),this.NetworkTimeout=a.default.seconds(15),this.UnauthorizedTimeout=a.default.seconds(2),this._isConnecting=!1,this._isConnected=!1,this._linkedAccounts={},this._decodedIDTokens={},this.onAccountsUpdated=new r.a,this._authCBList={},this._connectedCBList=[],this._signupCBList=[],this._signupUserDataRequested=!1,this._iteratingAuthList=!1,a.default.isDemoMode()&&setTimeout(function(){var e=[GScope.UserInfoEmail,GScope.Calendar,GScope.GmailCompose,GScope.GmailModify];this.addLinkedAccount("me","Moo.do User","InvalidGID",e,{expires_in:3600,expires_at:Math.floor((Date.now()+a.default.minutes(60))/1e3),access_token:"InvalidToken",id_token:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJERU1PIiwibmFtZSI6IkRlbW8gQWNjb3VudCIsImF1ZCI6IjU5Nzg0NzMzNzkzNi5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsImF6cCI6IjU5Nzg0NzMzNzkzNi5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsImVtYWlsIjoibWUiLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwiaXNzIjoiYWNjb3VudHMuZ29vZ2xlLmNvbSJ9.uHbEA0ZvxneZiXwmiL9nnt3J-HYLXBbjwmpoeFkyHh8",scope:e},PrivateAPIErrorCodes.Success)}.bind(this))}o.prototype={getInfo:function(){var e={};for(var t in this._linkedAccounts)if(this._linkedAccounts.hasOwnProperty(t)){var i=this._linkedAccounts[t];if(i){var a=void 0;this.isTokenValid(i.token)&&(a={scope:i.token.scope,hasIDToken:!!i.token.id_token}),e[t]={scopes:i.scopes,gid:i.gid,error:i.serverError,validToken:this.isTokenValid(i.token),hasToken:this.hasToken(i.token),token:a}}else e[t]="UNDEFINED ACCOUNT"}return e},getDefaultAccessToken:function(){var e=this.getAccountTokenSync("me");return a.default.Assert(e,"Must verify that a valid token is available before requesting"),e?e.access_token:void 0},getDefaultIDToken:function(){var e=this.getAccountTokenSync("me");return a.default.Assert(e,"Must verify that a valid token is available before requesting"),e?e.id_token:void 0},_areEmailsEqual:function(e,t){return e&&t&&e.toUpperCase()===t.toUpperCase()},getDefaultEmail:function(){var e=this._getDecodedIDToken("me");return e?e.email:"me"},getDefaultGID:function(){var e=this._getDecodedIDToken("me");return e?e.sub:void 0},isDefaultEmail:function(e){return"me"===e||this._areEmailsEqual(e,this.getDefaultEmail())||this._areEmailsEqual(e,a.default.getActiveUser())},_generateState:function(){return"Dchs"+(new Date).getTime()},requestNoneLink:function(e,t){},requestWebLink:function(e,t,i){var n=this;a.default.Assert(e,"Must provide a valid email to link"),a.default.Assert(a.default.isArray(t),"Must always provide a valid scopes array"),a.default.Assert(t.indexOf(GScope.UserInfoEmail)>=0,"Must request profile scope"),a.default.Assert(!s.a.app,"Should never use web link in native app");var r,o=this._generateState(),l=this._createAuthURL(e,t,o),d=!1,u=window.open(l,"googleauth","height=600,width=550"),c=function t(s){clearInterval(r);var l=a.default.getLocationOrigin(),u=!1;try{u=s.data.state===o}catch(e){a.default.reportError(e)}if(l&&u)return window.removeEventListener("message",t),d=!0,s.data.code?n._handleGoogleAuthorized(e,s.data,o,i):i()};r=setInterval(function(){u.closed&&!d&&(clearInterval(r),window.removeEventListener("message",c),i())},1e3),window.addEventListener("message",c)},requestNativeLink:function(e,t,n){a.default.Assert(e&&"me"!==e,"Must provide a valid email to link"),a.default.Assert(a.default.isArray(t),"Must always provide a valid scopes array"),a.default.Assert(t.indexOf(GScope.UserInfoEmail)>=0,"Must request profile scope");var s=this._generateState(),r={scope:t.join(" ")+" profile",immediate:!1,offline:!0,state:s,login_hint:e,redirect_uri:this._getRedirectURL()};i(16).default.requestNativeOAuth(r,function(t){return t.code?this._handleGoogleAuthorized(e,t,s,n):n()}.bind(this))},_getRedirectURL:function(){return window.location.protocol+"//"+window.location.host+"/oauthRelay.html"},_createAuthURL:function(e,t,n){a.default.Assert(a.default.isArray(t)&&t.length>0,"Must pass in a valid scopes array");var s={scope:t.join(" ")+" profile",state:n,login_hint:e,redirect_uri:this._getRedirectURL(),response_type:"code",access_type:"offline",include_granted_scopes:!0,prompt:"consent",client_id:i(16).default.CLIENT_ID},r=[];for(var o in s)r.push(o+"="+encodeURIComponent(s[o]));return"https://accounts.google.com/o/oauth2/v2/auth?"+r.join("&")},unlinkAccount:function(e,t,i){if(!t)return i(!0);var s={email:e,gidLinked:t};a.default.XHR_PrivateAPI({type:"POST",path:"/user/unlinkAccount",data:s,requireAuth:!0,autoRetry:!0,cb:function(e){return e.status===n.a.HTTPStatusCode.Success?i(!0):i(!1)}.bind(this)})},_handleGoogleAuthorized:function(e,t,i,s){var r=this,o={email:e,state:i,code:t.code,redir:this._getRedirectURL()};a.default.XHR_PrivateAPI({type:"POST",path:"/user/linkAccount",data:o,requireAuth:!0,autoRetry:!0,maxRetries:1,cb:function(t){if(t.status===n.a.HTTPStatusCode.Success&&t.response){var i,o;try{var l=JSON.parse(t.response).data;a.default.Assert(l.gidLinked,"Must receive a valid GID back from the server"),i=l.access_token,a.default.Assert(i&&i.id_token,"Missing valid ID token from linking account: ",i),o=r.addLinkedAccount(e,l.gidLinked,l.name,i.scope,i,PrivateAPIErrorCodes.Success)}catch(e){a.default.reportError(e)}if(s)return s(i,o)}else if(s)return s()}})},removeLinkedAccount:function(e,t){var i=this._getLinkedAccount(e);if(a.default.Assert(i,"Must always have linked account data when removing"),!i)return t(!0);this.unlinkAccount(e,i.gid,function(i){return this._deleteLinkedAccount(e),this.onAccountsUpdated.notify(),t(i)}.bind(this))},addLinkedAccount:function(e,t,i,n,s,r){a.default.Assert(!s||void 0===n||n.indexOf(GScope.UserInfoEmail)>=0,"Must request profile scope"),a.default.Assert(!this._hasLinkedAccount(e)||void 0===this._getLinkedAccount(e).gid||this._getLinkedAccount(e).gid===t,"Google ID should never change"),a.default.Assert(void 0!==r||void 0===t,"Must supply a valid error code if this is a non-temp account");var o=this._getLinkedAccount(e);o&&this._clearRefreshTimeout(o);var l,d={lastRefreshRequested:o?o.lastRefreshRequested:0,refreshTimeout:void 0,refreshScheduleTime:0,isRequestingToken:!1,serverError:r||PrivateAPIErrorCodes.Success,scopes:n||[],gid:t,name:i};s?l=this._runDecodeIDToken(s).email:l=e;delete this._linkedAccounts[e],this._linkedAccounts[l]=d,s&&this.updateAccountToken(e,s),this.onAccountsUpdated.notify();try{if(!a.default.isDemoMode())for(var u=0,c=a.default.vmMain.pluginManager.getPlugin(PluginID.Gmail).getSyncAccounts(),h=0;h<c.length;++h){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;a.default.Assert(c[h]===l||c[h].toUpperCase()!==l.toUpperCase(),"Gmail sync account does not match linked account casing")}}catch(e){a.default.reportError(e)}return l},updateAccountToken:function(e,t){a.default.Assert(t,"Must provide a token when updating"),a.default.Assert(this.isTokenValid(t),"Token must be valid to be updated");var i=this._getLinkedAccount(e);if(i){i.token=t,i.serverError=PrivateAPIErrorCodes.Success;var n=1e3*(a.default.parseInt(t.expires_in)-600);a.default.isDemoMode()||this._createTokenRefresh(e,i,n),this.notifyUserAuthorized(e,t)}},_clearAccountToken:function(e,t){var i=this._getLinkedAccount(e);i&&(i.token=void 0,i.serverError=t||PrivateAPIErrorCodes.Success,this._clearRefreshTimeout(i),this.onAccountsUpdated.notify())},updateServerLinkedAccount:function(e,t,i,a,n,s){this.addLinkedAccount(e,t,i,a,n,s)},_getLinkedAccount:function(e){var t;for(var i in this._linkedAccounts)if(this._areEmailsEqual(i,e)){t=this._linkedAccounts[i];break}return t},_deleteLinkedAccount:function(e){for(var t in this._linkedAccounts)this._areEmailsEqual(t,e)&&(this._clearRefreshTimeout(this._linkedAccounts[t]),delete this._linkedAccounts[t])},_hasLinkedAccount:function(e){return!!this._getLinkedAccount(e)},getLinkedAccounts:function(){var e=[];for(var t in this._linkedAccounts)e.push(t);return e},_getDecodedIDToken:function(e){var t;return this._decodedIDTokens[e]&&(t=this._decodedIDTokens[e]),t},_decodeIDToken:function(e){var t=this.getAccountTokenSync(e);return a.default.Assert(t,"Must always call this method when user is authorized"),a.default.Assert(!t||t.id_token,"All authorized users must have a valid id token"),this._runDecodeIDToken(t)},_runDecodeIDToken:function(e){var t;if(e&&e.id_token){var i=e.id_token,n=i.split(".");a.default.Assert(n&&3===n.length&&n[0]&&n[1]&&n[2],"A valid JWT should always have three parts: "+i);try{t=JSON.parse(a.default.b64_to_utf8(n[1]))}catch(t){a.default.reportError(t,e.id_token)}}return t},getAccountGID:function(e){var t;if(this.isDefaultEmail(e)&&!a.default.isDemoMode()){var i=this._getDecodedIDToken(e);t=i&&i.sub?i.sub:a.default.vmMain.getUserID()}else this._hasLinkedAccount(e)?t=this._getLinkedAccount(e).gid:a.default.Assert(!1,"Unknown account email requested: ",e);return t},getAccountEmail:function(e){var t;for(var i in this._linkedAccounts)if(this._linkedAccounts[i].gid===e){t=i;break}if(!t){var n=this._getDecodedIDToken("me");n&&n.email?n.sub===e&&(t=n.email):e===a.default.vmMain.getUserID()&&(t="me")}return t},getAccountName:function(e){var t;if(this.isDefaultEmail(e))t=a.default.vmMain.getUserName();else if(this._hasLinkedAccount(e)){var i=this._getLinkedAccount(e);i.name&&(t=i.name)}else a.default.Assert(!1,"Unknown account name requested: ",e);return t},getAccountDomain:function(e){var t;if(this.isDefaultEmail(e)){var i=this._getDecodedIDToken(e);t=i&&i.hd?i.hd:a.default.vmMain.getAccountDomain()}return t},isAccountValidLinked:function(e){var t=!1;return this._hasLinkedAccount(e)&&(t=!!this._getLinkedAccount(e).token),t},isLinkedAccountAuthorized:function(e,t){var i=!1,a=this._getLinkedAccount(e);return a&&a.token&&(!t||a.scopes.indexOf(t)>=0)&&(i=!0),i},isAuthorized:function(e,t){a.default.Assert(t,"Must provide a valid scope to check authorization for");var n=!1;if(this._hasLinkedAccount(e)||this.isDefaultEmail(e)){var s=this.getAuthorizedScopes(e);s&&s.indexOf(t)>=0&&(n=!0)}else{var r=a.default.getActiveUser(),o=i(16).default.getAuthorizedScopes();e===r&&(!t||o.indexOf(t)>=0)&&(n=!0)}return n},isCurrentlyAuthorized:function(e,t){a.default.Assert(e,"Must provide a valid email");var i=!1;return a.default.isDemoMode()?i=!0:this.hasValidAccessToken(e,t)&&(i=!0),i},_refreshToken:function(e){var t=this._getLinkedAccount(e);a.default.Assert(t,"Must have properly linked account before requesting a token"),t&&(this._clearRefreshTimeout(t),this._getAccountToken(e,!0,function(i,n){i&&!i.error?this.updateAccountToken(e,i):(a.default.Assert(void 0!==n,"Missing error code on token failure"),this._clearAccountToken(e,n),t.serverError===PrivateAPIErrorCodes.Success&&(a.default.Assert(!t.refreshTimeout,"Should not have a refresh timeout after failure"),this._createTokenRefresh(e,t,this.ErrorTimeout)))}.bind(this)))},_createTokenRefresh:function(e,t,i){if(a.default.Assert(i>0,"Should never schedule an immediate token refresh"),!t.refreshTimeout){var n=!1,s=Date.now()-t.lastRefreshRequested;t.serverError!==PrivateAPIErrorCodes.TokenMissing?n=!0:s>a.default.minutes(90)&&(n=!0),n&&(t.refreshTimeout=setTimeout(this._refreshToken.bind(this,e),i),t.lastRefreshRequested=Date.now(),t.refreshScheduleTime=t.lastRefreshRequested+i)}},_clearRefreshTimeout:function(e){clearTimeout(e.refreshTimeout),e.refreshTimeout=void 0,e.refreshScheduleTime=0},_isRefreshTimeoutValid:function(e){var t=!1;return e.refreshTimeout&&e.refreshScheduleTime>=Date.now()&&(t=!0),t},isMissingAccountToken:function(){var e=!1;for(var t in this._linkedAccounts){if(this._linkedAccounts[t].serverError===PrivateAPIErrorCodes.TokenMissing){e=!0;break}}return e},notifyUnauthorizedRequest:function(e){var t=this._getLinkedAccount(e);t?this._isRefreshTimeoutValid(t)||Date.now()-t.lastRefreshRequested>a.default.seconds(90)&&(this._clearRefreshTimeout(t),this._createTokenRefresh(e,t,this.UnauthorizedTimeout)):this.isConnected()||this.isConnecting()||a.default.billingManager.checkRemotePremiumStatus()},notifyUnauthorizedAccount:function(e,t,i){log("Unauthorized Request: ",e,t,i),this._invalidateAccountToken(e,function(e,t){e?t?log("Account Token Refreshed for Invalidation"):log("Account Token Invalidated"):log("Account Token Failed Invalidation")})},getAccountToken:function(e,t){return this._getAccountToken(e,!1,t)},_getErrorString:function(e){var t;switch(e){case PrivateAPIErrorCodes.TokenMissing:t="Authorization has been revoked.";break;case PrivateAPIErrorCodes.InvalidToken:t="There is an error with your authorization. Please try disabling and re-enabling your plugins in the settings.";break;case PrivateAPIErrorCodes.DomainPolicy:t="Access denied by a security policy established by the Google Apps administrator of your organization. Please contact your administrator for further assistance.";break;default:a.default.Assert(!1,"Unknown error code for account authorization: "+e),t="There was an error authorizing your account."}return t},getAccountError:function(e){var t,i=this._getLinkedAccount(e);return i?i.serverError!==PrivateAPIErrorCodes.Success&&(t=this._getErrorString(i.serverError)):this.isDefaultEmail(e)||(t="There was an error authorizing your account."),t},_invalidateAccountToken:function(e,t,i){var s=this.getAccountGID(e);if(s&&this._getLinkedAccount(e)){var r={gid:s};this._clearAccountToken(e,PrivateAPIErrorCodes.InvalidToken),this.onUserAuthorized("me","_invalidateAccountToken",function(){a.default.XHR_PrivateAPI({type:"POST",path:"/user/invalidateAccountToken",data:r,requireAuth:!0,autoRetry:!0,cb:function(i){if(i.status!==n.a.HTTPStatusCode.Success||!i.response)return t(!1,!1);try{var s=JSON.parse(i.response);if(s.success&&s.data){var r=s.data;return r&&!r.error?(this.updateAccountToken(e,r),t(!0,!0)):t(!0,!1)}return t(!0,!1)}catch(e){return a.default.reportError(e),t(!0,!1)}}.bind(this)})}.bind(this))}else{if(i)return t(!1,!1);a.default.billingManager.onBillingIdentifierAvailable(function(){this._invalidateAccountToken(e,t,!0)}.bind(this))}},_getAccountToken:function(e,t,i){var s=this._getLinkedAccount(e);if(a.default.Assert(s,"Must have properly linked account before requesting a token"),!s)return setTimeout(i,0);if(!t&&this.isTokenValid(s.token))return setTimeout(i,0,s.token,PrivateAPIErrorCodes.Success);var r=this._generateState(),o={gid:s.gid,state:r};a.default.Assert(s.gid,"Must have a valid GID for account"),s.isRequestingToken=!0,this.onUserAuthorized("me","_getAccountToken",function(){a.default.XHR_PrivateAPI({type:"POST",path:"/user/getAccountToken",data:o,requireAuth:!0,autoRetry:!0,cb:function(r){if(s.isRequestingToken=!1,r.response){var o;try{o=JSON.parse(r.response)}catch(e){a.default.reportError(e)}return r.status===n.a.HTTPStatusCode.Success?o&&o.success?i(o.data,PrivateAPIErrorCodes.Success):(this._clearAccountToken(e,PrivateAPIErrorCodes.TokenMissing),i(void 0,PrivateAPIErrorCodes.TokenMissing)):(this._clearAccountToken(e,o.code),i(void 0,o.code))}if(r.status===n.a.HTTPStatusCode.Success)return this._clearAccountToken(e,PrivateAPIErrorCodes.TokenMissing),i(void 0,PrivateAPIErrorCodes.TokenMissing);setTimeout(this._getAccountToken.bind(this),this.NetworkTimeout,e,t,i)}.bind(this)})}.bind(this))},_getAccountTokenRaw:function(e,t){var i;if(e&&this.isAccountValidLinked(e)){var a=this._getLinkedAccount(e);a&&(i=a.token)}else!t&&this.isJSAuthLibLoaded()&&this.isDefaultEmail(e)&&(i=this.getJSAuthLibToken());return i},getAccountTokenSync:function(e){if(a.default.Assert(e,"Must provide a valid email to retreive the token for"),this.isDefaultEmail(e)){var t=this._getAccountTokenRaw(e);return a.default.Assert(this.isTokenValid(t)||a.default.isDemoMode(),"Must ensure token is valid before requesting sync"),t}var i=this._getLinkedAccount(e);return a.default.Assert(i,"Must have properly linked account before getting a token"),a.default.Assert(this.isTokenValid(i.token)||a.default.isDemoMode(),"Must ensure token is valid before requesting sync"),i.token},getAccessTokenSync:function(e){var t=this.getAccountTokenSync(e);return t?t.access_token:void 0},getAuthorizedScopes:function(e){var t;if(this.isAccountValidLinked(e))t=this._getLinkedAccount(e).scopes;else if(this.isDefaultEmail(e))try{if(this.isJSAuthLibLoaded()){var n=this.getJSAuthLibToken();n?(t=a.default.isArray(n.scope)?n.scope:n.scope.split(" "),a.default.Assert(a.default.isArray(t),"Must always be a valid scopes array on auth token")):t=a.default.getActiveUser()===e?i(16).default.getAuthorizedScopes().slice(0):[]}else t=a.default.getActiveUser()===e?i(16).default.getAuthorizedScopes().slice(0):[]}catch(e){a.default.reportError(e),t=[]}else a.default.Assert(this._hasLinkedAccount(e),"Unknown account email requested: ",e),t=[];return t},onConnected:function(e){this._isConnected?setTimeout(e,0):this._connectedCBList.push(e)},setConnected:function(){if(a.default.Assert(!this._isConnected,"Should not already be connected"),!this._isConnected){var e=0;this._isConnected=!0;for(var t=0;t<this._connectedCBList.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this._connectedCBList[t];try{i()}catch(e){a.default.reportError(e)}}}},isConnected:function(){return this._isConnected},setConnecting:function(){a.default.Assert(!this._isConnecting,"Should not already be connecting"),a.default.Assert(!this._isConnected,"Should not already be connected"),this._isConnecting||(this._isConnecting=!0)},setNotConnecting:function(){a.default.Assert(this._isConnecting,"Must already be connecting to cancel"),a.default.Assert(!this._isConnected,"Should not already be connected if canceling"),this._isConnecting&&(this._isConnecting=!1)},isConnecting:function(){return this._isConnecting},notifyUserAuthorized:function(e,t){a.default.Assert(a.default.isString(e),"Must provide a valid email addr for authorization"),a.default.Assert(a.default.isObject(t),"Must provide a valid auth token");var i=this._runDecodeIDToken(t);i&&i.email&&(a.default.Assert(this._areEmailsEqual(i.email,e)||"me"===e,"Emails must match id_token"),this._decodedIDTokens[i.email]=i,this.isDefaultEmail(e)&&(this._decodedIDTokens.me=i)),this._iteratingAuthList=!0;var n=this._authCBList[e];for(var s in n)if(n.hasOwnProperty(s))try{n[s]()}catch(e){a.default.reportError(e)}if(this._authCBList[e]={},this._iteratingAuthList=!1,a.default.Assert(a.default.isDemoMode()||a.default.vmMain&&a.default.vmMain.pluginManager,"Must have initialized plugin manager before users are authorized"),a.default.vmMain&&a.default.vmMain.pluginManager&&("me"!==e&&a.default.vmMain.pluginManager.notifyAuthorizationAdded(e),this.isDefaultEmail(e))){var r=a.default.isArray(t.scope)?t.scope:t.scope.split(" ");a.default.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.GoogleLogin,r)}},onUserAuthorized:function(e,t,i,n){if(a.default.Assert(!this._iteratingAuthList,"Should not queue additional authorizations while iterating"),this.isCurrentlyAuthorized(e))setTimeout(i,0);else{var s=this._authCBList[e];s||(s=this._authCBList[e]={}),s[t]=i,n&&setTimeout(function(){s[t]&&(delete s[t],i())}.bind(this),n)}},notifyRemoteAccountsLinked:function(){a.default.vmMain.pluginManager.verifyAuthorization(this.getDefaultEmail())},hasLinkedAccessToScope:function(e,t){if(this._hasLinkedAccount(e)){var i=this._getLinkedAccount(e);if(i.token&&i.token.scope&&i.token.scope.indexOf(t)>=0)return!0}return!1},verifyLinkedTokenScopes:function(e,t){var i=[];if(t)if(this._hasLinkedAccount(e)){var a=this._getLinkedAccount(e);if(a.token&&a.token.scope)for(var n=0,s=0;s<t.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;a.token.scope.indexOf(t[s])<0&&i.push(t[s])}else i=t.slice(0)}else if(this.isConnected()&&this.isDefaultEmail(e)&&this.isJSAuthLibLoaded()){var r=this.getJSAuthLibToken();if(r&&r.scope){var o=0;for(s=0;s<t.length;++s){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;r.scope.indexOf(t[s])<0&&i.push(t[s])}}else i.pushArray(t)}return i},isTokenValid:function(e){a.default.Assert(!e||!a.default.isString(e),"Must supply a valid token object to check if valid");var t=!1;if(e&&e.expires_at){var i=a.default.parseInt(e.expires_at);i*=i>1e12?1:1e3;var s=Date.now()+a.default.seconds(n.a.MinimumTokenExpireTime);try{var r=new Date(i),o=(new Date).addHours(5);a.default.Assert(r.isBefore(o),"Token lease must be under five hours: ",e.expires_at)}catch(e){a.default.reportError(e)}i>s&&(t=!0)}return t},hasToken:function(e){return!!e},hasValidAccessToken:function(e,t){var i=!1;a.default.Assert(a.default.isString(e),"Must supply a valid email to check access token");var n=this._getAccountTokenRaw(e,t);return n&&this.isTokenValid(n)&&(i=!0),i},getSignupUserData:function(e){this._signupCBList.push(e),this._signupUserDataRequested||(this._signupUserDataRequested=!0,a.default.XHR({type:"GET",url:"https://www.googleapis.com/oauth2/v2/userinfo?alt=json&access_token="+this.getDefaultAccessToken(),autoRetry:!0,cb:function(e){if(this._signupUserDataRequested=!1,200===e.status){var t=0,i={};try{i=JSON.parse(e.responseText)}catch(t){a.default.reportError(new Error("Error parsing user info"),e.responseText)}for(var n=0;n<this._signupCBList.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this._signupCBList[n](i)}this._signupCBList=[]}}.bind(this)}))},getJSAuthLibToken:function(){var e;return this.isJSAuthLibLoaded()&&(e=window.gapi.auth.getToken()),e},isJSAuthLibLoaded:function(){return!!(window.gapi&&window.gapi.auth&&window.gapi.auth.authorize)},canRunAuthenticate:function(){return this.isJSAuthLibLoaded()||s.a.isFeatureEnabled(n.a.Feature.OAuth)}},t.a=new o},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(2),r=i.n(s),o=i(46),l=i.n(o),d=i(72),u=i.n(d),c=i(26),h=i(8),f=i(23),p=i(13),g=i(35),m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},v={};v.createClass=function(e){a.default.Assert(!e.mixins,"Should not supply separate mixins value"),a.default.Assert(e.displayName,"Must always specify displayName for react components"),e.mixins=[v.MooReactMixin];var t=!1;return e.componentDisplay?a.default.isFlagSet(e.componentDisplay,n.a.ComponentDisplay.Mobile)&&(t=!0):(t=!0,__warn("Unmarked React Create: ",e.displayName)),t?u()(e):void 0};var _=0;function y(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}function S(e,t,i){var a=0;if(y(e,t))return!0;if("object"!==(void 0===e?"undefined":m(e))||null===e||"object"!==(void 0===t?"undefined":m(t))||null===t)return!1;var n,s=Object.keys(e),r=Object.keys(t);if(s.length!==r.length)return!1;for(var o=0;o<s.length;o++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(n=void 0,!hasOwnProperty.call(t,s[o]))return!1;if(i&&!1===(n=i(s[o],e[s[o]],t[s[o]])))return!1;if(void 0===n&&!y(e[s[o]],t[s[o]]))return!1}return!0}v.MooReactMixin={shouldComponentUpdate:function(e,t){return!S(this.props,e,this.arePropsEqual)||!S(this.state,t,this.areStatesEqual)},getInitialState:function(){var e;(e=this).componentDisplay?a.default.Assert(a.default.isFlagSet(e.componentDisplay,n.a.ComponentDisplay.Mobile),"Component created on wrong platform"):console.log("Create Unmarked Component: ",e.constructor.displayName),this.init&&this.init();var t=this.getState?this.getState(this.props):{};this._observables&&(t=a.default.extend(t,this._observables));var i=null;return t&&(this.setupListeners(t),i=this.transformState(t)),i},createObservables:function(e){for(var t in a.default.Assert(!this._listeners,"You have to run createObservables in init()"),e)if(e.hasOwnProperty(t)){var i=e[t];a.default.isArray(i)?e[t]=new f.a(i):e[t]=new h.a(i),a.default.Assert(!this.hasOwnProperty(t),"Must not multi-define observable properties"),this[t]=e[t]}a.default.Assert(!this.hasOwnProperty("_observables"),"Must not define an _observables property and use createObservables"),this._observables=e},addObservable:function(e,t){t=a.default.isArray(t)?new f.a(t):new h.a(t),this[e]=t,this._observables[e]=t,this._addListener(t.listen(this.onListener))},_addListener:function(e){a.default.Assert(e&&e.target,"Must add a valid listener"),this._ensureListeners(),a.default.Assert(!this._hasListener(e.target),"Must not double register the same observable/trigger"),this._listeners.push(e)},refreshListeners:function(e){this.disposeListeners();var t=this.getState?this.getState(e||this.props):{};this._observables&&(t=a.default.extend(t,this._observables)),t&&this.setupListeners(t)},_ensureListeners:function(){this._listeners||(this._listeners=[],this._permanentListeners=[])},setupListeners:function(e){for(var t in this._ensureListeners(),e||(e=this.getState?this.getState(this.props):{}),e)if(e.hasOwnProperty(t)){var i=e[t];i instanceof h.a&&this._addListener(i.listen(this.onListener))}},disposeListeners:function(e){if(this._listeners){for(var t=0,i=0;i<this._listeners.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this._listeners[i].dispose()}if(this._listeners=[],e){var a=0;for(i=0;i<this._permanentListeners.length;++i){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;this._permanentListeners[i].dispose()}}}e&&this.disposeDispatcherListeners()},disposeDispatcherListeners:function(){if(this._dispatcherListeners){for(var e=0,t=0;t<this._dispatcherListeners.length;t++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this._dispatcherListeners[t],a=i[0],n=i.slice(1);a.unlisten.apply(a,n)}this._dispatcherListeners=[]}},listenTo:function(e,t){if(a.default.Assert(e instanceof g.a||e instanceof h.a,"Can only listen to an Observable or a Trigger object"),e instanceof g.a||e instanceof h.a){var i=e.listen(this.onListener);!1!==t?this._addListener(i):this._permanentListeners.push(i)}},listenToDispatcher:function(){this._dispatcherListeners||(this._dispatcherListeners=[]);var e,t=Array.prototype.slice.call(arguments);a.default.isString(t[0])?e=p.a:(e=t[0],t.splice(0,1)),t.push(this.onListener),e.listen.apply(e,t);var i=[e].concat(t);this._dispatcherListeners.push(i)},listenToSetting:function(e,t){this.listenToDispatcher(a.default.settings,"settingChanged",t||Settings.DefaultGroup,e)},_hasListener:function(e){var t=0;a.default.Assert(e,"Must have a valid target");for(var i=!1,n=0;n<this._listeners.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(this._listeners[n].target===e){i=!0;break}}return i},_getState:function(e){var t=this.getState?this.getState(e||this.props):{};return this._observables&&(t=a.default.extend(t,this._observables)),this.transformState(t)},transformState:function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];i&&i instanceof h.a&&(e[t]=i.get(),i instanceof f.a&&(e[t+"_arrVer"]=i.version))}return e},onListener:function(){this.updateState()},updateState:function(e){if(a.default.Assert(this._isMounted,"updateState called on a component that is not yet mounted:",this.constructor&&this.constructor.displayName),this._isMounted){var t=this.state,i=this._getState(e);this.onBeforeChanged&&(i=this.onBeforeChanged(i,t,e)||i),this.setState(i),this.onAfterChanged&&this.onAfterChanged(i,t)}},componentWillUnmount:function(){this.disposeListeners(!0),this.__hotkeys&&(c.a.popStack(this.__hotkeys),this.__hotkeys=void 0),this.onUnmount&&this.onUnmount(this.state),this._isMounted=!1},addTap:function(e,t,i){var n=this.refs[e];a.default.Assert(n,"Invalid refName to add tap to: ",e),n&&a.default.setupClick(n,t,i)},refElement:function(e){var t=this.refs[e];return a.default.isDOMNode(t)?t:l.a.findDOMNode(t)},getChildByKey:function(e){var t;return r.a.Children.forEach(this.props.children,function(i){i&&i.key===e&&(t=i)}),t},getChildByDisplayName:function(e){var t;return r.a.Children.forEach(this.props.children,function(i){i&&i.type&&i.type.displayName===e&&(t=i)}),t},componentDidMount:function(){this._isMounted=!0,this.getHotkeys?this.__hotkeys=c.a.pushStack(this.getHotkeys()):this.onEscapeKey&&(this.__hotkeys=c.a.pushStackEscape(this.onEscapeKey))},getUniqueID:function(){return this.props["data-moo-id"]?this.props["data-moo-id"]:(this.__id||(this.__id="m_"+_++),this.__id)},componentDidCatch:function(e,t){a.default.reportError(e,t,void 0,"React Component Error: "),a.default.toasts.pushMessage(MessageID.ReactError)}},t.a=v},function(e,t,i){"use strict";var a=i(5),n=i(40);function s(){}a.a.defineBase(s),a.a.extend(s.prototype,n.a),t.a=new s},function(e,t,i){"use strict";i.r(t);var a=i(0),n=i(1),s=i(4),r=i(7),o=i(5),l=i(26),d=i(8),u=i(3),c=i(15),h=i(13);function f(){this.activePane=void 0,this.startPane=void 0,this.previousEventTarget=void 0,this.previousDropTarget=void 0,this.previousHighlightElement=void 0,this.previousAbove=void 0,this.dataTransfer=void 0,this.startInfo=void 0,this.startDragItem=void 0,this.externalData=void 0,this.isDragging=!1,this.dragItem=void 0,this.draggingItems=[],this.position=void 0,this.isVisible=new d.a(!1),this.isInDrag=new d.a(!1),this.transform=new d.a({left:0,top:0}),this.linePosition=new d.a,this.isDraggingPane=new d.a(!1),this.draggingToOutline=new d.a,this.dragTargetHovered=new d.a,window.addEventListener("dragover",this.handleDragOver.bind(this)),window.addEventListener("dragleave",this.handleDragLeave.bind(this)),window.addEventListener("drop",this.handleDrop.bind(this)),o.a.binder(this,"handleEscapeKey"),a.default.dragDrop=this,s.a.ios&&(document.ontouchmove=function(e){return a.default.preventAndStop(e),f.isDragging},window.addEventListener("touchmove",function(e){f.isDragging&&e.preventDefault()},{passive:!1}))}f.prototype={stop:function(){var e=0;this.__hotkeyEscape&&(l.a.popStack(this.__hotkeyEscape),this.__hotkeyEscape=void 0),this.activePane&&!this.activePane.isDestroyed()?this.activePane.notifyDragEnd():a.default.vmMain.paneManager.runForEachPane(function(e){e.notifyDragEnd()});for(var t=this.draggingItems,i=0;i<t.length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;t[i].item.draggedInPane.set(!1)}this.draggingItems=[],this.isDragging=!1,this.dragItem=void 0,this.position=void 0,this.externalData=void 0},finish:function(){this.isVisible.set(!1),this.isInDrag.set(!1),this.blockTarget=void 0,h.a.fireEvent("endDrag",[])},start:function(e,t,i,s,o,d,c,h){var f=0;this.isDragging&&(this.stop(),this.finish()),this.__hotkeyEscape=l.a.pushStackEscape(this.handleEscapeKey),a.default.vmMain.setItemAnimationMode(n.a.ItemAnimationMode.None),this.isDragging=!0,this.activePane=o,this.dragInfo=null,this.startPane=o,this.startInfo=d,this.dataTransfer=c,this.dragItem=e,this.startDragitem=e,this.fromOverview=h,this.externalData=void 0,this.draggingItems=t,this.position={left:i,top:s},this.transform.set({left:0,top:0},!1),u.a.reset();for(var p=0;p<t.length;++p){if(f++>5e3&&__infLoop&&__infLoop(f))throw new RangeError;t[p].item.draggedInPane.set(a.default.focusedPane)}this.isInDrag.set(!0),this.isVisible.set(!0),this.activePane.notifyDragStart(),r.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.DragItem,data:{itemID:this.id,fromPane:o}})},startExternal:function(e){this.isDragging=!0,this.activePane=e,this.startPane=e,this.draggingItems=[],this.isVisible.set(!0),this.isInDrag.set(!0),this.activePane.notifyDragStart()},setExternalData:function(e){this.externalData=e},setTransform:function(e,t){this.isVisible.set(!0,!1),this.isInDrag.set(!0,!1),this.transform.set({left:e,top:t})},handleDragOver:function(e){var t=a.default.elementFromPoint(e.clientX,e.clientY),i=a.default.getPaneForElement(t);this.activePane&&i!==this.activePane&&this.revertDrag();var n=a.default.findParent(t,"dragTarget",3);if(n&&(n=n.id),this.dragTargetHovered.set(n),a.default.vmMain.checkDragForScroll(e),i){this.isDragging||this.startExternal(i),this.activePane=i;var s=!!a.default.findParent(t,"paneOverviewWrapper");i.canAcceptDragOver(e.dataTransfer.pane,e.item,t,s)?this.dragInfo=i.handleDragOver(e.dataTransfer.pane,e.item,t,e.clientX,e.clientY):this.revertDrag()}return this.linePosition.set(this.dragInfo&&this.dragInfo.linePosition),this.dragInfo&&this.dragInfo.targetElement||a.default.cancelRepeatScroll(),!1},revertDrag:function(){this.dragInfo=null,this.activePane.revertDrag()},handleDropItem:function(e,t,i){var s=e,r=this.activePane;this.isDropping=!0,a.default.cancelRepeatScroll();var o=document.elementFromPoint(t.clientX,t.clientY);if(o&&a.default.findParent(o,"mobileDropBucket"))a.default.vmMain.dropBucket.addItemEntry(e,r),this.dragTargetHovered.set(void 0);else if(o&&a.default.findParent(o,"mobileDragToOutline"))this.draggingToOutline.set({item:e,pane:this.activePane}),a.default.vmMain.switchPaneMobile(PaneMode.Task,n.a.TaskViewMode.Outline,!0),this.dragTargetHovered.set(void 0);else if(this.dragInfo&&r)a.default.vmMain.beginUpdateItems(),this.startInfo&&0===this.startInfo.items[0].index&&this.startPane.setIgnoreRestoreScroll(),r.handleDragDrop(e,t,this.dragInfo,i),a.default.vmMain.commitUpdateItems();else if(a.default.isNonPaneDropTarget(t.target)){var l;if((r=t.dataTransfer.pane)&&(l=r.notifyDropFromToEdit(e,t.target),a.default.Assert(!l||a.default.isDOMNode(l),"Must always return DOM elements to insert")),l){var d=c.default._getCursorSelectionRange(t.clientX,t.clientY);c.default.setSelectionRange(d),c.default.insertNode(l)}}return this.isDropping=!1,s},handleDrop:function(e){var t=this,n=this.activePane;if(n&&(a.default.elementInPane(e.target)||e.fromDropBucket)){var o=e.dataTransfer.item;if(this.isDragging=!1,this.isVisible.set(!1),o)this.handleDropItem(o,e);else if(!a.default.vmMain.pluginManager.handleDropEvent(e,function(i,a){r.a.beginAction();var s=n.createVMLI({text:i},{changeType:ChangeType.AllLocal,noParentOkay:!0});return s=t.handleDropItem(s,e,a),r.a.endAction(),s}))if(e.dataTransfer.getData(s.a.ie?"Text":"text/plain")||e.dataTransfer.getData("text/html")){var l=c.default.getCursorSelectionRange(e);a.default.Assert(l,"Range should always be properly set"),u.a.setFocusedPane(n),r.a.beginAction();var d=n.createVMLI({text:""},{changeType:ChangeType.AllLocal,noParentOkay:!0});d=this.handleDropItem(d,e,!0),u.a.selectItem(d,0),i(65).default.insert(e.dataTransfer,e,DataSource.Drop),r.a.endAction()}else if(this.externalData){var h=this.externalData;this.externalData=void 0;var f=h.split(":"),p=(f.removeAt(0),"["+f.removeAt(0)+"]("+f.join(":")+")");r.a.beginAction();d=n.createVMLI({text:p},{changeType:ChangeType.AllLocal});d=this.handleDropItem(d,e,!0),r.a.endAction()}}else a.default.isNonPaneDropTarget(e.target)&&e.dataTransfer.item&&this.handleDropItem(e.dataTransfer.item,e);this.isInDrag.set(!1),a.default.vmMain.resetItemAnimationMode(),e.stopPropagation(),e.preventDefault()},handleDragLeave:function(e){e.clientX||e.clientY||(this.isDragging=!1,this.isVisible.set(!1),this.isInDrag.set(!1))},setBlockTarget:function(e){this.blockTarget=e},stopDraggingToOutline:function(){var e=this.draggingToOutline.get();e&&e.pane&&setTimeout(function(){a.default.vmMain.switchPaneMobile(e.pane.type,n.a.TaskViewMode.Outline,!0)},300),this.dragTargetHovered.set(void 0),this.draggingToOutline.set(void 0)},handleEscapeKey:function(){this.escapedDragging=!0,this.dragItem.dragEnd()}},t.default=new f},function(e,t,i){"use strict";i.r(t);var a=i(0),n=i(4);function s(e){this._range=e,this._range||(this._range=i(15).default._getSelectionRange())}s.prototype={isValid:function(){return!!this._range},getNativeRange:function(){return this._range},getStartContainer:function(){return this._range.startContainer},getEndContainer:function(){return this._range.endContainer},getStartElement:function(){return a.default.getElementParent(this.getStartContainer())},getEndElement:function(){return a.default.getElementParent(this.getEndContainer())},getSelectOffsetsInElement:function(e){return i(15).default.getSelectOffsetsInElement(e,this._range)},getStartOffset:function(){return this._range.startOffset},getEndOffset:function(){return this._range.endOffset}};var r=s,o=i(1);function l(){}l.prototype={createFakeRange:function(e,t,i,n){try{var s=this.createSelectionRange();return s.setStart(e,t),s.setEnd(i,n),new r(s)}catch(e){a.default.reportError(e)}},createSelectionRange:function(){return document.createRange()},setSelection:function(e,t,i,s,r){if("TEXTAREA"===e.nodeName)a.default.Assert(e===i,"Cannot multiselect textareas"),e.focus(),e.selectionStart=t,e.selectionEnd=s,!r&&n.a.android&&setTimeout(this.setSelection.bind(this,e,t,i,s,!0),0);else{var o=this.createSelectionRange();this.setSelectionValues(o,e,t,i,s),this.setSelectionRange(o)}},setSelectionRange:function(e){var t=window.getSelection();t.removeAllRanges(),e instanceof r&&(e=e.getNativeRange()),t.addRange(e)},insertNode:function(e){var t=this._getSelectionRange();t&&t.insertNode(e)},selectAfterNode:function(e){var t=document.createRange();t.setStartAfter(e),this.setSelectionRange(t)},setSelectionRangeToWhatItAlreadyIs:function(){var e=this._getSelectionRange();e&&this.setSelectionRange(e)},hasValidSelection:function(){return this.getSelectionRange(!0).isValid()||n.a.android&&document.activeElement&&"TEXTAREA"===document.activeElement.nodeName},getSelectionRange:function(e){var t;return e&&(t=this._getSelectionRange()),new r(t)},_getSelectionRange:function(){var e,t=window.getSelection();return t.rangeCount>0&&(e=t.getRangeAt(0)),e},getSelectionNode:function(){var e=window.getSelection().anchorNode;if(e)return e.nodeType===Node.TEXT_NODE?e.parentNode:e},getSelectedText:function(){return window.getSelection?window.getSelection().toString():document.selection&&"Control"!==document.selection.type?document.selection.createRange().text:void 0},clearSelection:function(){window.getSelection().removeAllRanges()},hasSelection:function(){var e=this._getSelectionRange();return!(!e||e.startContainer===document.documentElement)&&(a.default.getPaneForElement(e.startContainer)&&a.default.findParent(e.startContainer,"paneContent"))},hasRawSelection:function(){return!!window.getSelection().anchorNode},getCursorSelectionRange:function(e){var t,i=e.target,n=a.default.ensureDOMNode(e.target);if(n){var s=a.default.getElementParent(i),l=0,d=a.default.getItemForElement(i),u=a.default.getPaneObjectForElement(i);a.default.Assert(s,"getCursorSelectionRange must only be called when hovered item is item",n),a.default.findParent(i,"line")||(n=s.firstElementChild,l=o.a.LineLeftPad+(!u.isBlockHeader&&d.hasPrefix()?o.a.PrefixWidth:0));var c=n.getBoundingClientRect(),h=a.default.clamp(e.clientY,c.top+9,c.bottom-9),f=a.default.clamp(e.clientX,c.left+l,c.right-1);t=this._getCursorSelectionRange(f,h)}return t?new r(t):void 0},_getCursorSelectionRange:function(e,t){var i;if(document.caretRangeFromPoint)i=document.caretRangeFromPoint(e,t);else if(document.caretPositionFromPoint){var n=document.caretPositionFromPoint(e,t);n&&((i=document.createRange()).setStart(n.offsetNode,n.offset),i.setEnd(n.offsetNode,n.offset))}else if(document.body.createTextRange){var s=this._getSelectionRange(),r=document.body.createTextRange();try{r.moveToPoint(e,t),r.select(),i=this._getSelectionRange(),this.setSelectionRange(s)}catch(e){}}else a.default.Assert(!1,"Unable to get selection range at cursor");return i},_ensureSelectionInElement:function(e,t){a.default.Assert(e,"Must have a valid element"),a.default.Assert(t,"Must have a valid range"),a.default.isAncestor(t.startContainer,e)||t.setStart(e,0),a.default.isAncestor(t.endContainer,e)||t.setEnd(e,0),a.default.hasClass(t.startContainer,"textSelected")&&t.setStart(t.startContainer.parentElement.firstElementChild,t.startContainer.innerText.length),a.default.hasClass(t.endContainer,"textSelected")&&t.setEnd(t.endContainer.parentElement.firstElementChild,t.endContainer.innerText.length),a.default.hasClass(t.startContainer,"itemIgnoreText")&&t.setStart(t.startContainer.previousSibling,t.startContainer.previousSibling.length),a.default.hasClass(t.endContainer,"itemIgnoreText")&&t.setEnd(t.endContainer.previousSibling,t.endContainer.previousSibling.length);var i=a.default.getPluginForElement(t.startContainer);if(i){var n=i.textContent.length;!(r=i.nodeType===Node.TEXT_NODE)&&0===t.startOffset||r&&t.startOffset<n/2?t.setStartBefore(i):t.setStartAfter(i)}var s=a.default.getPluginForElement(t.endContainer);if(s){var r,o=s.textContent.length;!(r=s.nodeType===Node.TEXT_NODE)&&0===t.endOffset||r&&t.endOffset<o/2?t.setEndBefore(s):t.setEndAfter(s)}},getSelectOffsetsInElement:function(e,t){var i={start:0,end:0,total:0};if("TEXTAREA"===e.nodeName){i.start=e.selectionStart,i.end=e.selectionEnd,i.total=e.value.length;var n=e.value.indexOf("\n");n>=0&&i.start>n&&(i.start--,i.end--,i.total--)}else if(e&&(a.default.Assert(t,"Must provide a valid range"),t)){this._ensureSelectionInElement(e,t);var s=this._getComponentNode(t.startContainer,t.startOffset),r=t.startOffset,o=this._getComponentNode(t.endContainer,t.endOffset),l=t.endOffset;!s||s.textContent!==TextSpace&&0!==s.textContent.length||(r=0),!o||o.textContent!==TextSpace&&0!==o.textContent.length||(l=0);var d=0,u=this._getComponentNodesIn(e);if(u.length>0)for(var c=0,h=0;h<u.length;++h){if(c++>5e3&&__infLoop&&__infLoop(c))throw new RangeError;u[h]===s&&(i.start=d+r),u[h]===o&&(i.end=d+l),d+=this._getComponentNodeLength(u[h]),void 0===o&&(h===l-1?i.end=d:0===h&&0===l&&(i.end=0)),void 0===s&&(h===r-1?i.start=d:0===h&&0===r&&(i.start=0))}else i.start=0,i.end=0;i.total=d,isNaN(i.end)&&(i.end=d),i.start>i.total&&(i.start=i.total),i.end>i.total&&(i.end=i.total)}return a.default.Assert(!isNaN(i.start)&&!isNaN(i.end),"Must have valid start and end",i),i},getSelectOffsetsForMouseEvent:function(e){var t=a.default.getElementParent(e.target),i=this.getCursorSelectionRange(e);return i&&i.getSelectOffsetsInElement(t)},getOffsetChildElement:function(e,t){if(a.default.Assert(e,"Must supply a valid element"),"TEXTAREA"===e.nodeName)return{element:e,offset:t};if(this._isComponentNode(e))return a.default.Assert(this._isComponentSelectable(e),"Component must be selectable"),{element:e,offset:t};for(var i=0,n=0,s=this._getComponentNodesIn(e),r=0;r<s.length;++r){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var o=this._getComponentNodeLength(s[r]);if(n+o>=t)return{element:s[r],offset:t-n};n+=o}a.default.Assert(!1,"Unable to find offset child element")},getChildNodeOffset:function(e){var t=0;a.default.Assert(e,"Must supply a valid child element");for(var i=0,n=this._getComponentNodesIn(a.default.getElementParent(e)),s=this._getComponentNodesIn(e),r=0;r<n.length;++r){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(n[r]===s[0])break;i+=this._getComponentNodeLength(n[r])}return i},_getComponentNodeLength:function(e){return a.default.Assert(this._isComponentNode(e),"Supplied node must be a valid component"),a.default.hasClass(e,"plugin")?1:a.default.hasClass(e,"mdImageWrapper")?0:1===e.length&&e.textContent===TextSpace?0:e.length},_getComponentNodesIn:function(e){if(this._isComponentNode(e))return[e];var t=[];return this._getComponentNodes(t,e),t},_isComponentNode:function(e){var t=!1;return e&&(e.nodeType===Node.TEXT_NODE&&!a.default.getPluginForElement(e)||a.default.hasClass(e,"plugin")||a.default.hasClass(e,"mdImageWrapper"))&&(t=!0),t},_isComponentSelectable:function(e){a.default.Assert(!e||this._isComponentNode(e),"Must either be an invalid node (not-selectable) or a component");var t=!1;return e&&e.nodeType===Node.TEXT_NODE&&(t=!0),t},_getComponentNodes:function(e,t){if(t)if(this._isComponentNode(t))e.push(t);else if(t.childNodes)for(var i=0,a=0;a<t.childNodes.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=t.childNodes[a];this._getComponentNodes(e,n)}},_getComponentNode:function(e){var t;if(this._isComponentNode(e))t=e;else{var i=a.default.getPluginForElement(e);i&&(t=i)}return t},setSelectionValues:function(e,t,i,n,s){a.default.Assert(e,"Range must be supplied"),a.default.Assert(this._isComponentNode(t),"Must be selecting a valid component"),a.default.Assert(this._isComponentNode(n),"Must be selecting a valid component"),a.default.Assert(t!==n||i<=s,"Select elements must be different, or selection must start before it ends"),t.nodeType===Node.TEXT_NODE?e.setStart(t,i):(a.default.Assert(a.default.hasClass(t,"plugin"),"Only other valid component is plugin"),a.default.Assert(0===i||1===i,"Must eiter be selecting before or after the plugin"),0===i?this._selectBeforeComponent(e,t,"setStart"):1===i&&this._selectAfterComponent(e,t,"setStart")),n.nodeType===Node.TEXT_NODE?e.setEnd(n,s):(a.default.Assert(a.default.hasClass(n,"plugin"),"Only other valid component is plugin"),a.default.Assert(0===s||1===s,"Must eiter be selecting before or after the plugin"),0===s?this._selectBeforeComponent(e,n,"setEnd"):1===s&&this._selectAfterComponent(e,n,"setEnd"))},_selectBeforeComponent:function(e,t,i){var a=this._getPrevComponent(t);if(this._isComponentSelectable(a))e[i](a,this._getComponentNodeLength(a));else{var n=document.createTextNode("");t.parentNode.insertBefore(n,t),e[i](n,0)}},_selectAfterComponent:function(e,t,i){var a=this._getNextComponent(t);if(this._isComponentSelectable(a))e[i](a,0);else{var n=document.createTextNode("");t.parentNode.insertBefore(n,void 0),e[i](n,0)}},_getPrevComponent:function(e){a.default.Assert(e,"Must supply a valid node"),a.default.Assert(this._isComponentNode(e),"Supplied node must be a valid component itself");var t=e.previousSibling;return a.default.Assert(!t||this._isComponentNode(t),"Siblings must always be valid components"),t},_getNextComponent:function(e){a.default.Assert(e,"Must supply a valid node"),a.default.Assert(this._isComponentNode(e),"Supplied node must be a valid component itself");var t=e.nextSibling;return a.default.Assert(!t||this._isComponentNode(t),"Siblings must always be valid components"),t},selectElement:function(e,t,i){var a;if(isNaN(i)&&(i=t),isNaN(t))(a=this.createSelectionRange()).selectNodeContents(e);else{var n=this.getOffsetChildElement(e,t),s=t!==i?this.getOffsetChildElement(e,i):n;n&&(a=this.createFakeRange(n.element,n.offset,s.element,s.offset))}a&&this.setSelectionRange(a)},getSelectionInElement:function(e){var t=this._getSelectionRange();if(t&&a.default.isAncestor(t.startContainer,e)&&a.default.isAncestor(t.endContainer,e))return this.getSelectOffsetsInElement(e,t)},deleteRangeContents:function(){var e=this._getSelectionRange();e&&e.deleteContents()}};t.default=new l},function(e,t,i){"use strict";i.r(t);var a=i(6),n=i(0),s=i(5),r=i(1),o=i(18),l=i(9),d=i(4),u=i(47),c=i(13),h=i(11);t.default=new function(){var e={CLIENT_ID:"597847337936.apps.googleusercontent.com",eventSubscribers:[]};n.default.goog=e;var t=1e4,i=10485760,f=.85,p=.95;e.APP_ID="597847337936",e.REALTIME_MIMETYPE="application/vnd.google-apps.drive-sdk",e.FOLDER_MIMETYPE="application/vnd.google-apps.folder",e.MoodoMimetype=e.REALTIME_MIMETYPE+"."+e.APP_ID,window.GScope={Calendar:"https://www.googleapis.com/auth/calendar",CalendarRO:"https://www.googleapis.com/auth/calendar.readonly",Contacts:"https://www.googleapis.com/auth/contacts.readonly",Drive:"https://www.googleapis.com/auth/drive.file",UserInfoEmail:"https://www.googleapis.com/auth/userinfo.email",DriveFull:"https://www.googleapis.com/auth/drive",TasksRO:"https://www.googleapis.com/auth/tasks.readonly",UserInfoProfile:"https://www.googleapis.com/auth/userinfo.profile",DriveInstall:"https://www.googleapis.com/auth/drive.install",DriveAppData:"https://www.googleapis.com/auth/drive.appdata",DriveMetadataRO:"https://www.googleapis.com/auth/drive.metadata.readonly",GmailRO:"https://www.googleapis.com/auth/gmail.readonly",GmailCompose:"https://www.googleapis.com/auth/gmail.compose",GmailModify:"https://www.googleapis.com/auth/gmail.modify"};var g=[GScope.TasksRO],m=[GScope.UserInfoProfile,GScope.GmailRO],v=["https://www.googleapis.com/auth/plus.me","https://www.googleapis.com/auth/contacts",GScope.TasksRO,"email","openid","profile","https://www.googleapis.com/auth/drive.readonly"],_={};_[GScope.CalendarRO]=GScope.Calendar,_[GScope.Drive]=GScope.DriveFull,_[GScope.DriveMetadataRO]=GScope.DriveFull,e.LEGACY_DefaultDriveDocTitle="DuchessBeta",e.DefaultDocTitle="My Tasks",e.DefaultProperty="MooDoDefault",e.DefaultPropertyValue="TRUE",e.folders={root:{title:"_Moo.do Files (Do not delete)",id:void 0,prop:"MooDoDefaultRoot",setting:Settings.rootFolderId},attach:{title:"Shared Attachments",id:void 0,prop:"MooDoDefaultAttach",setting:Settings.attachFolderId},backup:{title:"Moo.do Backups",id:void 0,prop:"MooDoDefaultBackup",setting:Settings.backupFolderId}},e.DocFolderTitlePrefix="Moodo_",e.DocFolderProperty="MooDoFolder",e.DocFolderPropertyPrefix="MDSF_",e.DocFolderTitleProperty="MooDoTitle",e.requiredScopes=[GScope.Drive,GScope.UserInfoEmail,GScope.DriveInstall,GScope.DriveAppData],e.requestScopes=[],e.scopes=[GScope.Calendar,GScope.CalendarRO,GScope.Contacts,GScope.Drive,GScope.UserInfoEmail,GScope.DriveFull,GScope.UserInfoProfile,GScope.DriveInstall,GScope.DriveAppData,GScope.DriveMetadataRO,GScope.GmailRO,GScope.GmailModify,GScope.GmailCompose];var y=[];e.getAuthorizedScopes=function(){return y};e.isLoaded=!1,e.init=function(){h.a.isJSAuthLibLoaded()?e.addOAuthMethod(OAuthSchemeType.Web):window.addEventListener("gapiLoaded",function(){e.addOAuthMethod(OAuthSchemeType.Web)});var t=n.default.settings.get(Settings.oauthScheme);if(void 0!==t&&t!=OAuthSchemeType.Web)try{var i=n.default.parseInt(t);e.addOAuthMethod(i)}catch(e){n.default.reportError(e)}Z();var a=n.default.settings.get(Settings.authScopes);if(a){var r;try{r=JSON.parse(a)}catch(e){n.default.reportError(e)}if(r){for(var o=0,l=[],u=0;u<r.length;++u){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;n.default.Assert(r[u]>=0,"Each saved scope should be a valid array index"),r[u]>=0&&l.push(e.scopes[r[u]])}e.requestScopes=n.default.arrayUniques(l)}}else e.requestScopes=e.requiredScopes;y=e.requestScopes,d.a.syncContacts&&s.a.getURLParam("access_token")&&!s.a.hasURLParam("error")&&(y.indexOf(GScope.Contacts)<0&&(y.push(GScope.Contacts),B()),n.default.settings.set(Settings.syncContacts,!0)),n.default.settings.registerForChangeNotification(Settings.syncContacts,void 0,function(t,i){i&&e.authAndLoadContacts(!1,function(e){n.default.settings.set(Settings.syncContacts,e)})}),h.a.onUserAuthorized("me","goog_init",function(){window.ga&&ga("set","&uid",n.default.getAnonUserIdentifier())})},e.ensureRequiredScopesAreRequested=function(){for(var t=0,i=!1,a=0;a<e.requiredScopes.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(y.indexOf(e.requiredScopes[a])<0){i=!0;break}}i&&e.runAuthenticate(e.requiredScopes,!0,!1,function(t){!t||t.error?n.default.toasts.pushMessage({text:"We need additional permissions to give you the best experience.",actionText:"AUTHORIZE",action:function(){e.runAuthenticate(e.requiredScopes,!1,!1,function(t){t&&!t.error||n.default.toasts.pushMessage({text:"There was an error authenticating. Please try again.",actionText:"AUTHORIZE",action:e.ensureRequiredScopesAreRequested})})}}):B()})};var S;e.startWatchdog=function(){S||(S=setInterval(e.watchdogFn,96e4))},e.stopWatchdog=function(){clearInterval(S),S=void 0};var w,I,b=0;e.watchdogFn=function(){var e=Date.now();if(b-e>=96e4){try{var t=h.a.getJSAuthLibToken();if(t){var i=1e3*parseInt(t.expires_at);e>i?(ShouldLog(LogLevels.Error)&&log("Active token is no longer valid: "+e+" vs. "+i),ne(),n.default.reportError(new Error("Watchdog found expired token on client"))):l.a.poke()}else ShouldLog(LogLevels.Error)&&log("No active token on client!"),ne(),n.default.reportError(new Error("Watchdog found client with no token set"))}catch(e){n.default.reportError(e)}finally{b=e}n.default.checkForRemoteChanges()}},e.hasPermission=function(e){return y.indexOf(e)>-1};var A=!0;function D(e){if(e){var t=e.error;t.code===r.a.HTTPStatusCode.Forbidden?n.default.toasts.pushMessage({text:"Google Drive Error: "+t.message+".",action:MessageAction.OpenURL,actionText:"LEARN MORE",data:{url:"https://support.google.com/drive/answer/2500820"}}):n.default.toasts.pushMessage({text:t.message+". Please reload to try again.",action:MessageAction.Reload}),n.default.reportError(new Error("Failed to find default doc: "+e.error.code),e)}else n.default.toasts.pushMessage({text:"There was an internal error in Google Drive. Please reload to try again.",action:MessageAction.Reload});n.default.vmMain.setGDriveStatus(DriveStatus.Offline)}function T(e){log("First Run Drive Document"),M(e),l.a.onFirstInitialized(e),h.a.getSignupUserData(function(e){n.default.reportSignup(e.email,e)})}function M(e){log("Drive Document Initialized"),l.a.onInitialized(e),h.a.onUserAuthorized("me","onDocInitialized",function(){n.default.sendEvent("Documents","CreateNew")})}function C(t){if(ShouldLog(LogLevels.Timing)&&log("Drive document load started: ",log.now()),n.default.checkpoint(Checkpoint.DocLoaded),n.default.vmMain.setGDriveStatus(DriveStatus.Saved),l.a.onLoad(t)){if(ShouldLog(LogLevels.Timing)&&log("Drive document load done: ",log.now()),e.startWatchdog(),!t.getModel().getRoot().get("docFolderID")){var a=n.default.vmMain.docManager.getOpenDoc();n.default.Assert(a,"Must have an open doc to load a realtime doc"),a.getDocumentFolder(function(e){t.getModel().getRoot().set("docFolderID",e)})}t.getModel().getRoot().get("attachFolderID")||e.getAttachFolder(function(e){t.getModel().getRoot().set("attachFolderID",e)}),t.getModel().bytesUsed>=i*f?n.default.menus.alert({text:"Your document is nearing our maximum size. Consider starting a new document.",actionText:"OKAY"}):t.getModel().bytesUsed>=i*p&&n.default.menus.alert({text:"Your document has reached our maximum allowed size. You must create a new document to continue editing.",actionText:"OKAY"}),e.isLoaded=!0,n.default.vmMain.notifySuccessfulLoad(),n.default.fireCustomEvent("docLoaded")}}function L(t){switch(ShouldLog(LogLevels.Error)&&log("Doc Load Error - ",JSON.stringify(t)),t.type){case gapi.drive.realtime.ErrorType.TOKEN_REFRESH_REQUIRED:n.default.Assert(!t.isFatal,"Token refresh required causes a non-fatal error"),e.recoverFromError();break;case gapi.drive.realtime.ErrorType.INVALID_COMPOUND_OPERATION:n.default.Assert(t.isFatal,"Invalid compound operation causes a fatal error"),ShouldLog(LogLevels.Error)&&log("RealtimeAPI Error: ["+t.type+"] Fatal: "+t.isFatal),n.default.reportError(new Error("Invalid Compound Operation: "+n.default.safeStringify(t)));break;case gapi.drive.realtime.ErrorType.CONCURRENT_CREATION:case gapi.drive.realtime.ErrorType.CLIENT_ERROR:ShouldLog(LogLevels.Error)&&log("RealtimeAPI Error: ["+t.type+"] Fatal: "+t.isFatal),n.default.reportError(new Error("Client Error: "+n.default.safeStringify(t))),e.clearDocInfo(),k();break;case gapi.drive.realtime.ErrorType.FORBIDDEN:ShouldLog(LogLevels.Error)&&log("Unable to access or find the requested document"),(i=n.default.decodeURLObject(s.a.getURLParam("sinfo")))&&i.fromUser?n.default.menus.alert({text:"Moo.do is not able to access the document you requested. Please contact "+i.fromUser+" to make sure you have permission to view the document.",actionText:"RELOAD",callback:a.default.clearDataAndReload}):n.default.menus.alert({text:"Moo.do has lost access to your document. If the problem persists, please contact support@moo.do.",actionText:"RELOAD",callback:a.default.clearDataAndReload}),n.default.reportError(new Error("DocError Forbidden"),i),n.default.vmMain.notifyFailedLoad();break;case gapi.drive.realtime.ErrorType.NOT_FOUND:var i;ShouldLog(LogLevels.Error)&&log("Unable to access or find the requested document"),(i=n.default.decodeURLObject(s.a.getURLParam("sinfo")))&&i.fromUser?n.default.menus.alert({text:"Moo.do cannot find your document. Please contact "+i.fromUser+" to ensure the document still exists.",actionText:"RELOAD",callback:a.default.clearDataAndReload}):n.default.menus.alert({text:"Moo.do cannot find your document. If the problem persists, please contact support@moo.do.",actionText:"RELOAD",callback:a.default.clearDataAndReload}),n.default.reportError(new Error("DocError NotFound"),i),n.default.vmMain.notifyFailedLoad();break;case gapi.drive.realtime.ErrorType.SERVER_ERROR:ShouldLog(LogLevels.Error)&&log("Received server error: "+n.default.safeStringify(t)),t.isFatal&&(n.default.reportError(new Error("Fatal Server Error"),t),n.default.vmMain.setGDriveStatus(DriveStatus.Offline));break;case"fatal_network_error":ShouldLog(LogLevels.Error)&&log("Fatal network error: "+n.default.safeStringify(t)),t.isFatal&&n.default.vmMain.setGDriveStatus(DriveStatus.Offline);break;default:ShouldLog(LogLevels.Error)&&log("Unkown Doc Error - "+n.default.safeStringify(t)),n.default.reportError(new Error("Unknown Doc Error: "+n.default.safeStringify(t)))}return t.isFatal}e.onFocusHandler=function(){I&&Date.now()>I&&!A&&ne()},e.onBlurHandler=function(){w&&clearTimeout(w)},e.getContactInfo=function(e,t){var i=h.a.getAccessTokenSync(e);if(i){var s="https://www.google.com/m8/feeds/contacts/default/full?v=3.0&alt=json",r=n.default.settings.get(Settings.lastContactSync),o=a.default.areLocalContactsLoaded()&&0===a.default.contactManager.numContacts();r&&!o&&(s+="&updated-min="+new Date(r).toString("yyyy-MM-ddTHH:mm:ss")),s+="&max-results=10000",s+="&access_token="+i,n.default.JSONP({url:s,cb:function(e){if(e)try{n.default.settings.set(Settings.lastContactSync,new Date(e.feed.updated.$t))}catch(e){n.default.reportError(e)}t(e)}})}else t(void 0)},e.loadedContacts=!1,e.loadContacts=function(t){if(e.loadedContacts)t(0);else{e.loadedContacts=!0,a.default.loadLocalContacts();var i=a.default.contactManager.numContacts(),s=n.default.vmMain.getUserEmail();h.a.onUserAuthorized(s,"loadContacts",function(){e.getContactInfo(s,function(e){if(e){log("Loading Remote Contacts!",parseInt(e.feed.openSearch$totalResults.$t));var n=0;if(e&&e.feed&&e.feed.entry&&e.feed.entry.length){var s=0;n=e.feed.entry.length;for(var r=e.feed.entry,o=0;o<r.length;o++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var l=r[o],d={id:/\/([^\s\/]+$)/gi.exec(l.id.$t)[1],text:""};if(l.gd$name&&l.gd$name.gd$fullName){var u=l.gd$name.gd$fullName.$t;d.text=u,"'"===d.text[0]&&(d.text=d.text.substr(1))}if(l.gd$email){for(var c=0,h=l.gd$email,f=0;f<h.length;f++){if(c++>5e3&&__infLoop&&__infLoop(c))throw new RangeError;delete h[f].rel,!d.text&&h[f].primary&&(d.text=h[f].address)}!d.text&&h.length>0&&(d.text=h[0].address),d.emails=h}if(l.gd$phoneNumber){var p=0,g=l.gd$phoneNumber;for(d.phoneNumbers=[],f=0;f<g.length;f++){if(p++>5e3&&__infLoop&&__infLoop(p))throw new RangeError;var m={number:g[f].$t};g[f].rel?m.type=g[f].rel.replace("http://schemas.google.com/g/2005#",""):m.type=g[f].label,d.phoneNumbers.push(m)}}d.text&&(0===i?a.default.contactManager.addContact(d):a.default.contactManager.updateContact(d))}}n>0&&a.default.saveContacts(),t&&t(n)}else t(-1)})})}},e.setDocInfo=function(e,t){n.default.settings.set(Settings.gdocId,e),n.default.settings.set(Settings.gdocTitle,t)},e.getDocId=function(){return n.default.vmMain.docManager.getOpenDoc().id},e.clearDocInfo=function(){n.default.settings.reset(Settings.gdocId),n.default.settings.reset(Settings.gdocTitle)},e.getFolder=function(t,i){var a=e.folders[t];if(n.default.Assert(a,"Trying to get invalid folder"),n.default.Assert(!n.default.isDemoMode(),"Should not be creating file structure in demo mode"),n.default.Assert(i,"Must provide a valid callback when getting the root folder"),a.id)return i(a.id);var s=function(){var s=n.default.settings.get(a.setting),r=function(){!function(t,i){var a=e.folders[t];n.default.Assert(!n.default.isDemoMode(),"Should not be creating "+t+"folder in demo mode"),n.default.Assert(void 0===a.id,"Must not already have a "+t+"folder"),"root"!==t&&n.default.Assert(e.folders.root.id,"Must have already created and found the root folder"),n.default.Assert(i,"Must supply a valid callback when done creating the "+t+" file structure");var s=o.a.fns("drive").files.insert.packedFn,r={resource:{mimeType:e.FOLDER_MIMETYPE,title:a.title,writersCanShare:!1,folderColorRgb:"#FF7537",properties:[{key:a.prop,value:"TRUE",visibility:"PRIVATE"}]}};"root"!==t&&(r.resource.parents=[{id:e.folders.root.id}]),n.default.vmMain.remoteAPI().runRemoteSingleRequest(s,r,function(e){return i(e.id)},function(e){return i()})}(t,function(e){return e?(a.id=e,n.default.settings.set(a.setting,e),i(e)):i()})};if(s)n.default.vmMain.remoteAPI().driveFilesGet(s,function(e){if(e)return a.id=s,i(s);r()},function(e){if(n.default.settings.set(a.setting,void 0),!e||!e.error||404!==e.error.code)return i();r()});else{var l="properties has {key='"+a.prop+"' and value='TRUE' and visibility='PRIVATE'} and 'me' in owners and trashed=false";n.default.vmMain.remoteAPI().driveFilesList(l,function(e){if(e.length>0)return n.default.Assert(1===e.length,"Must have a single root folder present"),a.id=e[0].id,n.default.settings.set(a.setting,a.id),i(a.id);r()},function(e){return i()},{getAllPages:!0})}};"root"!==t?e.getFolder("root",s):s()},e.getAttachFolder=function(t){return e.getFolder(r.a.DriveFolder.Attach,t)},e.getRootFolder=function(t){return e.getFolder(r.a.DriveFolder.Root,t)},e.getBackupFolder=function(t){return e.getFolder(r.a.DriveFolder.Backup,t)},e.createDefaultRealtimeFile=function(){var t=n.default.vmMain.docManager.createNewDoc();e.createAndSetupDocument(t,!0,function(i){if(!i||i.error)D();else{n.default.vmMain.docManager.setDoc(t);var a=s.a.getURLParam("file");if(a)try{n.default.Assert(gapi.drive,"gapi.drive should exist"),s.a.removeURLParam("file"),n.default.vmMain.docManager.loadDocFromData({id:a},!1).open(),e.setDocInfo(a,void 0),l.a.driveRealtimeLoad(a,C,M,L);try{window.__LOAD_REQUESTS.push(n.default.getCurrentStack("File Request After Default Load"))}catch(e){n.default.reportError(e)}}catch(e){n.default.reportError(e)}else e.onDefaultRealtimeFileOpened(i,!0)}})},e.createAndSetupDocument=function(t,i,a){n.default.Assert(a,"Must pass in a valid creation callback"),e.getRootFolder(function(s){var r;i&&(r=[{key:e.DefaultProperty,value:e.DefaultPropertyValue,visibility:"PRIVATE"}]);var l=o.a.fns("drive").files.insert.packedFn,d={fields:"createdDate,id,mimeType,owners(displayName,isAuthenticatedUser,permissionId,emailAddress),parents(id,isRoot),permissions(id,name,emailAddress,role,type),properties,shared,appDataContents,sharedWithMeDate,sharingUser(displayName,permissionId,emailAddress),title,userPermission(id,role,type)",resource:{mimeType:e.REALTIME_MIMETYPE,title:t.getTitle()||e.DefaultDocTitle,writersCanShare:!1,parents:[{id:s}],properties:r}};n.default.vmMain.remoteAPI().runRemoteSingleRequest(l,d,function(e){t.updateData(e),t.createDocumentFileStructure(function(t){return a(e)})},function(e){return a(void 0)})})};var P=t;function E(t,i,a){if(t){ShouldLog(LogLevels.Timing)&&log("Drive document requested: ",log.now());var s=n.default.vmMain.docManager.loadDocFromData({id:t,title:i},!1);s.isOpen()||s.open(),e.setDocInfo(t,i);try{var r=a?T:M;l.a.driveRealtimeLoad(t,C,r,L);try{window.__LOAD_REQUESTS.push(n.default.getCurrentStack("Normal Load ["+a+"]"))}catch(e){n.default.reportError(e)}}catch(t){e.recoverFromError(t)}}else k()}function k(){!function(){n.default.vmMain.setGDriveStatus(DriveStatus.Connecting);var t="(title='"+e.LEGACY_DefaultDriveDocTitle+"' or properties has {key='"+e.DefaultProperty+"' and value='"+e.DefaultPropertyValue+"' and visibility='PRIVATE'}) and 'me' in owners and trashed=false";function i(){var t=n.default.vmMain.docManager;t.loadDocList(function(i,a){if(i){var s=t.getAutoDefaultDoc();s?e.onDefaultRealtimeFileOpened(s.getData(),!1):t.hasTrashedDocuments()?n.default.vmMain.showTrashedDocumentError():e.createDefaultRealtimeFile()}else D(a)})}n.default.vmMain.remoteAPI().driveFilesList(t,function(t){0===t.length?n.default.vmMain&&n.default.vmMain.docManager?i():c.a.listen("VMMainLoaded",i):e.onDefaultRealtimeFileOpened(t[0],!1)},function(e){D(e)},{getAllPages:!0,maxResults:1})}()}e.recoverFromError=function(t){t&&(ShouldLog(LogLevels.Error)&&log("GDrive Error: ",t),n.default.reportError(t)),n.default.vmMain.setGDriveStatus(DriveStatus.Connecting),ne(function(t){if(!t||t.error){n.default.toasts.pushMessage(MessageID.ConnectionError),n.default.vmMain.setGDriveStatus(DriveStatus.Offline);var i="Unable to refresh authentication token - ",a=!1;t?(i+=t.error,"immediate_failed"===t.error&&(a=!1)):i+="No Token",a?n.default.reportError(new Error(i)):ShouldLog(LogLevels.Error)&&log("Refresh Auth Failed: ",i),P<16e4&&(setTimeout(e.recoverFromError,P),P*=2)}})},e.onDefaultRealtimeFileOpened=function(e,t){e&&e.id?E(e.id,e.title,t):n.default.reportError(new Error("We should always find a valid document with a defined id"))};var x=!1;e.loadClientDefaultFile=function(){var t=r.a.DocLoadSkipReason.None,i=!!n.default.vmMain,s=e.isRealtimeAPILoaded();if(x)t=r.a.DocLoadSkipReason.Already;else if(i)if(s)if(h.a.isCurrentlyAuthorized("me"))if(n.default.getLoginState()==LoginState.LOGGED_IN){n.default.checkpoint(Checkpoint.LoadDefaultFile),x=!0,ShouldLog(LogLevels.Timing)&&log("Loading Default Client File: ",log.now()),n.default.vmMain.setGDriveStatus(DriveStatus.Connecting);var o=h.a.getDefaultEmail(),l=n.default.getActiveUser();l&&o&&o!==l?a.default.clearData(function(){n.default.reload()}):!l&&o&&n.default.setActiveUser(o),E(n.default.settings.get(Settings.gdocId),n.default.settings.get(Settings.gdocTitle),!1),e.authAndLoadContacts(!1)}else t=r.a.DocLoadSkipReason.LoginState;else t=r.a.DocLoadSkipReason.NotAuth;else t=r.a.DocLoadSkipReason.Drive;else t=r.a.DocLoadSkipReason.Main;return t},e.reconnectToActiveDocument=function(){var t=!!n.default.vmMain,i=e.isRealtimeAPILoaded(),a=n.default.getLoginState()==LoginState.LOGGED_IN,s=h.a.getDefaultAccessToken();n.default.Assert(!l.a.isConnected(),"Should not try to reconnect if gdata is still connected"),t&&i&&a&&s&&!l.a.isConnected()&&!n.default.vmMain.isReconnecting()&&(n.default.vmMain.setGDriveStatus(DriveStatus.Reconnecting),n.default.isReconnected=!0,E(n.default.settings.get(Settings.gdocId),n.default.settings.get(Settings.gdocTitle),!1))},e.deleteAppDataFiles=function(e){n.default.vmMain.remoteAPI().driveFilesList("'appfolder' in parents",function(t){for(var i=0,a=o.a.createBatch(),n=0,s=0;s<t.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=o.a.createRequest("me",o.a.fns("drive").files.trash.packedFn,{fileId:t[s].id});a.add(r,"default",t[s].id),n++}n>0?a.then(function(t){e(!0)},function(){e(!1)}):e(!0)},function(t,i){e(!1)},{getAllPages:!0})},e.deleteAllFiles=function(t,i){for(var a=0,n=o.a.createBatch(),s=0,r=0;r<t.length;++r){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(t[r].hasDriveBacking()){var l=t[r].getData();if(l.userPermission&&"owner"===l.userPermission.role){var d=o.a.createRequest("me",o.a.fns("drive").files.trash.packedFn,{fileId:t[r].id});n.add(d,"default",t[r].id),s++}}}s>0?n.then(function(t){e.deleteAppDataFiles(i)},function(){i(!1)}):e.deleteAppDataFiles(i)},e.DeleteErrorCode={None:0,RootFolder:1,UnlinkFailure:2,UnlinkException:3,MissingFolders:4,FolderException:5,MissingRoot:6},e.deleteAccount=function(t){e._deleteAccount(t)};var R,O=1500;function F(e,t){if(0===e.length)return t(!0);!function i(a){e[a].then(function(n){e.length>a+1?setTimeout(function(){i(a+1)},O):t(!0)},function(){t(!1)})}(0)}function N(e,t){n.default.vmMain.remoteAPI().driveChildrenList(e,function(i){try{if(i.length>0){for(var a=0,s=o.a.createBatch(),r=0;r<i.length;++r){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var l=o.a.createRequest("me",o.a.fns("drive").children.delete.packedFn,{folderId:e,childId:i[r].id});s.add(l,"default",i[r].id)}t(s)}else t(void 0)}catch(e){n.default.reportError(e),t(void 0)}},function(e,i){t(void 0)},{getAllPages:!0,maxPageResults:500})}function B(){for(var t=0,i=[],a=0;a<y.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=e.scopes.indexOf(y[a]),r=g.indexOf(y[a])>=0;s>=0&&!r&&i.push(s)}i.sort();var o=JSON.stringify(i);n.default.settings.set(Settings.authScopes,o)}function U(e){e>0&&n.default.vmMain.updateAllItems(!1,!0)}function V(){return""+Math.floor((Date.now()-n.default.minutes(1))/1e3)}function H(e,t){return""+Math.floor(n.default.parseInt(t)+1e3*n.default.parseInt(e)/1e3)}function q(e){n.default.Assert(h.a.isJSAuthLibLoaded(),"Auth lib must be loaded to set token"),n.default.Assert(e.id_token,"Token must provide a valid id_token value",e),n.default.Assert(e.access_token,"Token must provide a valid access_token value",e),n.default.Assert(e.expires_in||e.expires_at,"Token must provide a valid expires_in value",e),e.issued_at||(e.issued_at=V()),e.expires_in?e.expires_at||(e.expires_at=H()):e.expires_in=parseInt(e.expires_at)-parseInt(e.issued_at),window.gapi.auth.setToken(e)}function z(){n.default.Assert(void 0!==R,"Should always have a valid token value"),n.default.isString(R.scope)&&(R.scope=R.scope.split(" ")),q(R)}e._deleteAccount=function(t){var i=0,a=0,s=[];e.getRootFolder(function(r){function o(t){n.default.vmMain.remoteAPI().driveFilesTrash(r,function(){t(!0,e.DeleteErrorCode.None)},function(){t(!1,e.DeleteErrorCode.RootFolder)})}if(r){var l="'"+r+"' in parents";n.default.vmMain.remoteAPI().driveFilesList(l,function(r){try{if((a=r.length)>0)for(var l=0,d=0;d<r.length;++d){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;var u=r[d];"owner"===u.userPermission.role?N(u.id,function(r){r&&s.push(r),++i===a&&F(s,function(i){try{i?o(t):t(!1,e.DeleteErrorCode.UnlinkFailure)}catch(i){n.default.reportError(i),t(!1,e.DeleteErrorCode.UnlinkException)}})}):a--}else o(t)}catch(i){n.default.reportError(i),t(!1,e.DeleteErrorCode.FolderException)}},function(i,a){t(!1,e.DeleteErrorCode.MissingFolders)},{getAllPages:!0,maxPageResults:999})}else t(!1,e.DeleteErrorCode.MissingRoot)})},e.authAndLoadContacts=function(t,i){h.a.onConnected(function(){e._authAndLoadContacts(t,i)})},e._authAndLoadContacts=function(t,i){if(n.default.settings.get(Settings.syncContacts)){var a=n.default.vmMain.getUserEmail();h.a.isAuthorized(a,GScope.Contacts)?e.loadContacts(function(e){U(e),i&&i(e>=0)}):e.runAuthenticate([GScope.Contacts],!0,t,function(t){e.loadContacts(function(e){U(e),i&&i(e>0)})})}},e.refreshContacts=function(t){return a.default.clearLocalContacts(),e.loadedContacts=!1,!!n.default.settings.get(Settings.syncContacts)&&(e.authAndLoadContacts(!0,function(e){t&&t()}.bind(this)),!0)},window.__LOAD_HANDLES=new u.a(5),window.__LOAD_REQUESTS=new u.a(5),e.checkTokenInHash=function(){var e=!1;if(s.a.hasURLParam("access_token"))try{var t,i=s.a.getURLParam("scope");i&&(t=i.split("+"));var a=s.a.hasURLParam("issued_at")?s.a.getURLParam("issued_at"):V(),r=s.a.getURLParam("expires_in"),o=s.a.hasURLParam("expires_at")?s.a.getURLParam("expires_at"):H(r,a),l={access_token:s.a.getURLParam("access_token"),id_token:s.a.getURLParam("id_token"),issued_at:a,expires_in:r,expires_at:o,scope:t,token_type:s.a.getURLParam("token_type")};q(l),e=!0,s.a.removeURLParam("access_token",!0),s.a.removeURLParam("issued_at",!0),s.a.removeURLParam("expires_in",!0),s.a.removeURLParam("expires_at",!0),s.a.removeURLParam("scope",!0),s.a.removeURLParam("token_type",!0),s.a.removeURLParam("id_token",!0),s.a.hasURLParam("login")||s.a.insertURLParam("login",!0,!0),h.a.notifyUserAuthorized("me",l)}catch(e){n.default.reportError(e)}return e},e.setExternalAccessToken=function(e){R=e;var t=h.a._runDecodeIDToken(e);n.default.Assert("me"===h.a.getDefaultEmail()||h.a.isDefaultEmail(t.email),"Must only set external access token with default email"),h.a.isJSAuthLibLoaded()?z():window.addEventListener("gapiLoaded",z)};var W=0,G={};e.requestNativeOAuth=function(e,t){n.default.Assert(e,"Must supply valid OAuth config"),n.default.Assert(t,"Must specify a callback function for OAuth respose"),n.default.Assert(!e.offline||!e.immediate,"Cannot request immediate offline access");var i=++W,a={id:i,scope:e.scope,immediate:!!e.immediate,offline:!!e.offline,state:e.state,login_hint:e.login_hint,include_granted_scopes:!0,redirect_uri:e.redirect_uri};n.default.nativeBridge.sendToApp("getOAuth",a),G[i]=t},e.handleNativeOAuthResponse=function(t){n.default.Assert(t&&!n.default.isString(t),"Must supply valid oauth response data"),n.default.Assert(!t||t.id,"Response must have a valid request ID associated with it");var i=G[t.id];if(i)if(G[t.id]=void 0,t.success&&t.token&&!t.token.error)t.token.id_token&&t.token.access_token?e.setExternalAccessToken(t.token):t.token.code||n.default.reportError(new Error("Token missing expected properties"),t),i(t.token);else{try{log("Native Token Error: ",JSON.stringify(t))}catch(e){n.default.reportError(e)}i(t.token)}else n.default.Assert(!1,"OAuth callback without a valid handler: ",t.id)};var j=[];e.requestNoneOAuth=function(e,t){j.push({config:e,cb:t})};var K=!1,Y=[];Y[OAuthSchemeType.None]=!0;var X,Q=OAuthSchemeType.Invalid;function J(e){return function(t,i){e(t,function(e){e&&!e.error&&(K=!0,n.default.settings.set(Settings.oauthScheme,Q)),i(e)})}}function Z(){if(n.default.Assert(!K,"Should not be setting up OAuth if locked into the current scheme"),!K){var t=function(){for(var e=0,t=OAuthSchemeType.Count;t>=0;t--){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;if(Y[t])return t}}();if(t>Q)switch(Q=t,t){case OAuthSchemeType.None:X={authorize:J(e.requestNoneOAuth),link:h.a.requestNoneLink.bind(h.a)};break;case OAuthSchemeType.Web:n.default.Assert(h.a.isJSAuthLibLoaded(),"GAPI Auth should always be valid at this point"),X={authorize:J(window.gapi.auth.authorize),link:h.a.requestWebLink.bind(h.a)};break;case OAuthSchemeType.Native:n.default.Assert(d.a.app,"Native auth should be used in a native app"),X={authorize:J(e.requestNativeOAuth),link:h.a.requestNativeLink.bind(h.a)};break;default:n.default.Assert(!1,"Invalid OAuth scheme type")}}}e.addOAuthMethod=function(t){Y[t]||(e.isOAuthMethodValid(t)?(Y[t]=!0,K||Z()):n.default.Assert(!1,"Adding invalid OAuth method: ",t))},e.isOAuthMethodValid=function(e){var t=!1;switch(e){case OAuthSchemeType.Native:d.a.app&&(t=!0);break;case OAuthSchemeType.Web:case OAuthSchemeType.None:t=!0}return t},e.getOAuthMethod=function(){return Q},e.linkAccount=function(e,t,i){return X.link(e,t,i)},e.runAuthenticateOffline=function(t,i,a){var r=0,o=n.default.vmMain.getUserEmail();n.default.Assert(o===s.a.getURLParam("user")||!s.a.getURLParam("user"),"Do not try to login a user that is not valid"),e.numTokensRequestedOffline++;var l=t.slice(0);l.indexOf(GScope.UserInfoEmail)<0&&l.push(GScope.UserInfoEmail);for(var d=!1,u=0;u<l.length;++u){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;if(!h.a.isLinkedAccountAuthorized(o,l[u])){d=!0;break}}if(d||i){var c=h.a.getAuthorizedScopes(o);l.pushOnlyUniques(c),e.linkAccount(o,l,function(t){t&&!t.error&&(n.default.toasts.clearMessage(MessageID.MissingOffline),n.default.toasts.clearMessage(MessageID.MissingOfflineMobile),e.setExternalAccessToken(t)),ee(t,!0,a)})}else h.a.getAccountToken(o,a)},e.runAuthenticate=function(t,i,a,r){if(!h.a.canRunAuthenticate())return log("Connection: runAuthenticate - Skipped"),r&&r(),!1;var o=n.default.getActiveUser()||void 0;if(n.default.Assert(o===s.a.getURLParam("user")||!s.a.getURLParam("user"),"Do not try to login a user that is not valid"),i&&!o&&!s.a.hasURLParam("login",!0))return r&&r(),!1;var l,u=h.a.getJSAuthLibToken();if(u){if(n.default.isArray(u.scope))l=u.scope.slice();else if(n.default.isString(u.scope))try{l=u.scope.split(" ")}catch(e){n.default.reportError(e)}else l=[];var c=0;if(u.scope)for(var f=0,p=0;p<t.length;++p){if(f++>5e3&&__infLoop&&__infLoop(f))throw new RangeError;u.scope.indexOf(t[p])<0&&(l.push(t[p]),c++)}else l=t,c=t.length;0===c&&(l=[])}else l=t;if(l.length>0){var g=ie(l);ae(g,o);var m={client_id:e.CLIENT_ID,scope:g.join(" "),immediate:i,include_granted_scopes:!0,login_hint:o,response_type:"token id_token",authuser:-1};d.a.requireCustomRedirect&&!i&&(m.redirect_uri=d.a.customRedirectString,d.a.customRedirectState&&(l.indexOf(GScope.Contacts)>=0&&(d.a.customRedirectState.syncContacts=!0),m.state=d.a.iosui?d.a.customRedirectState:JSON.stringify(d.a.customRedirectState))),A=!0,e.numTokensRequested++,X.authorize(m,function(t){A=!1,ShouldLog(LogLevels.Timing)&&log("GAPI Authorized: ",log.now()),(!t||t.error)&&i&&a?(e.numTokenRequestFailed++,e.runAuthenticate(l,!1,!1,r)):(t&&!t.error&&(d.a.app||s.a.hasURLParam("login","true"))&&(n.default.vmSetup?n.default.vmSetup.setLoginState(LoginState.LOGGED_IN):n.default.setLoginState(LoginState.LOGGED_IN)),ee(t,!1,r),t&&!t.error&&(d.a.app||s.a.hasURLParam("login","true"))&&e.loadClientDefaultFile())})}else ShouldLog(LogLevels.Error)&&log("Authorization request with no scopes: ",l),r&&r(u);return!0};var $=0;function ee(i,a,s){if(i&&!i.error){n.default.Assert(i.scope,"Scopes must be valid"),e.numTokenRequestSuccess++,n.default.isString(i.scope)&&(i.scope=i.scope.split(" "));var o=y,d=n.default.arrayUniques(i.scope);a&&d.pushOnlyUniques(o),y=d,o.equals(d)||B(),log("Authorized Token: ",i);var u=1e3*Math.max(parseInt(i.expires_in)-2*r.a.MinimumTokenExpireTime,r.a.MinimumTokenExpireTime);I=Date.now()+u,clearTimeout(w),w=setTimeout(ne,u),P=t,l.a.poke();var f=function(){n.default.vmMain.realtimeDocManager.notifyGoogleAuthorization(y),h.a.notifyUserAuthorized("me",i)};n.default.vmMain?f():c.a.listen("VMMainLoaded",function(){f()}),setTimeout(function(){for(var e,t=0,i=document.getElementsByTagName("iframe"),a=0;a<i.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(i[a].src.startsWith("https://accounts.google.com/o/oauth2/auth?"))if(""===i[a].id)i[a].id="auth_"+$++;else{var n=(e=i[a],parseInt(e.id.split("_")[1]));n!==$&&n!==$-1&&i[a].parentElement.removeChild(i[a])}}},0)}else log("Error authorizing token: "+(i?i.error:"UNDEFINED")),e.numTokenRequestFailed++;s&&s(i)}e.totalTokenLifetime=0,e.numTokensRequested=0,e.numTokensRequestedOffline=0,e.numTokenRequestSuccess=0,e.numTokenRequestFailed=0,e.getTokenStats=function(t){var i={totalLifetime:e.totalTokenLifetime,averageLifetime:e.totalTokenLifetime/(e.numTokenRequestFailed+e.numTokenRequestSuccess),numRequested:e.numTokensRequested,numRequestedOffline:e.numTokensRequestedOffline,numRequestSuccess:e.numTokenRequestSuccess,numRequestFailed:e.numTokenRequestFailed};t.tokenStats=i},e.numScriptLoads=0,e.numTokenRefreshes=0,e.numOnlines=0,e.numEnsureDocs=0,e.getOAuthData=function(t){var i={isLocked:K,availableSchemes:Y,currentScheme:Q,nativeOAuthCount:W,numScriptLoads:e.numScriptLoads,numTokenRefreshes:e.numTokenRefreshes,numOnlines:e.numOnlines,numEnsureDocs:e.numEnsureDocs};t.oauthData=i};var te=!1;function ie(t,i){for(var a=0,s=[],r=0;r<t.length;++r){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var o=t[r],l=e.scopes.indexOf(o)>=0||!i&&o===GScope.TasksRO;n.default.Assert(l||v.indexOf(o)>=0,"Unknown scope requested: ",o),m.indexOf(o)<0&&l&&(!_[o]||t.indexOf(_[o])<0)&&s.push(o)}return s}function ae(e,t){var i=!0;t&&!t.endsWith("@gmail.com")&&e.length>7&&(i=!1),i||(e.remove(GScope.DriveInstall),e.length>7&&(e.remove(GScope.Contacts),e.length>7&&n.default.reportError(new Error("Unfixable too many scoops! "+e))))}function ne(t){if(n.default.Assert(X&&X.authorize,"Must have locked in a valid auth scheme to refresh"),!X||!X.authorize)return t(void 0),!1;n.default.Assert(y.length>=e.requiredScopes.length,"We lost some required scopes somewhere..."),A=!0;var i=h.a.getJSAuthLibToken();if(i){var a=1e3*n.default.parseInt(i.expires_in),s=Math.min(Date.now()-1e3*n.default.parseInt(i.issued_at),a);e.totalTokenLifetime+=s}var r=n.default.vmMain.getUserEmail(),o=ie(y,!0);ae(o,r);var l={client_id:e.CLIENT_ID,scope:o.join(" "),immediate:!0,include_granted_scopes:!0,login_hint:r,response_type:"token id_token",authuser:-1};return e.numTokensRequested++,X.authorize(l,function(e){te=!0,A=!1,ee(e,!1,t)}),!0}e.ensureScopeAccess=function(t){for(var i,a=0,s=e.getAuthorizedScopes(),r=(i=e.getAuthorizedScopes().slice(0),n.default.vmMain.pluginManager.runForEachPlugin(function(e){if(e.isEnabled()){var t=e.googleScopes();t&&i.pushArray(t)}}),n.default.settings.get(Settings.syncContacts)&&i.push(GScope.Contacts),ie(i,!1)),o=!1,l=0;l<r.length;++l){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(s.indexOf(r[l])<0){o=!0;break}}o?(log("Current Scopes: "+s.join(", ")),log("Necessary Scopes: "+r.join(", ")),n.default.reportError(new Error("Missing offline auth scopes")),n.default.toasts.pushMessage({text:"There is an error with your authentication. Please authenticate again.",actionText:"AUTHENTICATE",action:function(){e.runAuthenticate(r,!1,!1,function(e){e?log("Authenticated Scopes: "+(e.scope?e.scope.join(", "):void 0)):log("Failed to authorize to ensure scopes - no token"),t(e&&!e.error)})}})):(log("Determined no extra auth necessary for missing token"),t(!0))},e.isRealtimeAPILoaded=function(){return!!(window.gapi&&window.gapi.client&&window.gapi.drive&&window.gapi.drive.realtime)},e.isGoogleClientAPILoaded=function(){return!(!window.gapi||!window.gapi.load)};var se=void 0;function re(t){e.numTokenRefreshes++,clearTimeout(se),se=void 0,te?(l.a.poke(),setTimeout(function(){(!l.a.doc||l.a.doc.saveDelay>=n.default.seconds(30)&&l.a.doc.saveDelay<=n.default.seconds(50))&&ne()},n.default.seconds(40)),n.default.toasts.clearMessage(MessageID.ConnectionError),t&&t()):(ne(),se=setTimeout(function(){re(t)},n.default.seconds(10)))}return e.goOnline=function(){return e.numOnlines++,n.default.vmSetup.closeConnectionError(),c.a.fireEvent("goOnline",[]),!se&&(te=!1,se=setTimeout(function(){re()},n.default.seconds(2)),!0)},e.ensureDocConnection=function(){e.numEnsureDocs++,e.goOnline(),re(function(){x?l.a.isConnected()||e.reconnectToActiveDocument():e.loadClientDefaultFile()})},e.tryToFixConnection=function(t){e.runAuthenticate(e.requestScopes,!1,!1,function(i){i&&!i.error?t&&(n.default.vmSetup?n.default.vmSetup.setLoginState(LoginState.LOGGED_IN):n.default.setLoginState(LoginState.LOGGED_IN),e.loadClientDefaultFile()):(n.default.settings.reset(Settings.authScopes),e.runAuthenticate(e.requiredScopes,!0,!1,function(i){i&&!i.error?t&&(n.default.vmSetup?n.default.vmSetup.setLoginState(LoginState.LOGGED_IN):n.default.setLoginState(LoginState.LOGGED_IN),e.loadClientDefaultFile()):(n.default.vmSetup?(n.default.vmSetup.setLoginState(LoginState.LOGGED_OUT),n.default.vmSetup.loggedOutByAuthFailure.set(!0)):n.default.setLoginState(LoginState.LOGGED_OUT),i&&"immediate_failed"===i.error&&(n.default.authImmediateFailed=!0))}))})},e}},function(e,t,i){"use strict";var a=i(0),n=i(5),s=i(40),r=i(8),o=i(23);function l(){this.selected={},this.numSelected=new r.a(0),this._queueRemoveEditables=[],n.a.forceBind("reset",this)}l.prototype={_selectedObjForPane:function(e){a.default.Assert(e,"Multiselect should always pass in a pane"),e=e||a.default.focusedPane;var t=this.selected[e.id];return t||(t=this.selected[e.id]={arr:new o.a,isInverted:!1}).arr.listen(this.onChanged.bind(this,e)),t},_selectedForPaneObs:function(e){return this._selectedObjForPane(e).arr},_selectedForPane:function(e){return this._selectedObjForPane(e).arr.get()},onChanged:function(e){this.numSelected.set(this.numSelectedInPane(e))},isInverted:function(e){return this._selectedObjForPane(e).isInverted},setInverted:function(e,t){this._selectedObjForPane(t).isInverted=e},isSelected:function(e,t){return this._selectedForPane(t).indexOf(e)>=0},getSelected:function(e){return this._selectedForPane(e)},getSelectedItems:function(e,t){for(var i=0,a=this._selectedForPane(e),n=[],s=0;s<a.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=a[s];if(e.numItems()>r){var o=e.itemAtIndex(r);!o||!t&&o.isNote()||n.push(o)}}return n},numSelectedInPane:function(e){for(var t=0,i=0,a=this._selectedForPane(e),n=0;n<a.length;n++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=e.itemAtIndex(a[n]);!s||s.isNote&&s.isNote()||i++}return i},getFirstSelectedIndex:function(e){var t=0;e=e||a.default.focusedPane;for(var i=this._selectedForPane(e),n=Number.MAX_VALUE,s=!1,r=0;r<i.length;r++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var o=i[r];o<n&&(n=o,s=!0)}return s?n:-1},getFirstSelectedItem:function(e){e=e||a.default.focusedPane;var t=this.getFirstSelectedIndex(e);if(t>=0)return e.itemAtIndex(t)},getLastSelectedIndex:function(e){var t=0;e=e||a.default.focusedPane;for(var i=this._selectedForPane(e),n=-1,s=0;s<i.length;s++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var r=i[s];r>n&&(n=r)}return n},getLastSelectedItem:function(e){e=e||a.default.focusedPane;var t=this.getLastSelectedIndex(e);if(t>=0)return e.itemAtIndex(t)},_resetPaneID:function(e){var t=a.default.vmMain.paneManager,i=!0;if(t.isPaneActive(e)){var n=t.getPaneById(e);n.canResetMultiselect()?(this.setSelected([],n),this.selected[e].isInverted=!1):i=!1}else delete this.selected[e];return i},reset:function(e){var t=!0;if(e)e.canResetMultiselect()?this._resetPaneID(e.id):t=!1;else for(var i in this.selected)this.selected.hasOwnProperty(i)&&(t=t&&this._resetPaneID(i));t&&this.fireEvent("reset",[e])},clearEditables:function(e){for(var t=0,i=this.getSelectedItems(e),a=1===i.length?i[0]:void 0,n=0;n<this._queueRemoveEditables.length;n++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=this._queueRemoveEditables[n];s!==a&&(s.isEditable.set(!1),s.itemChanged.notify())}this._queueRemoveEditables=[]},setSelected:function(e,t,i){var n=0;t=t||a.default.focusedPane;var s=this._selectedForPane(t),r=a.default.arrayDiff(s,e);this.setInverted(!1,t),this._selectedForPaneObs(t).set(e);for(var o=0;o<r.length;o++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var l=r[o];if(l<t.numItems()){var d=t.itemAtIndex(l);if(d){if(t.isWriteable)1===e.length&&e[0]===l?d.isEditable.set(!0):i?this._queueRemoveEditables.push(d):d.isEditable.set(!1);d.itemChanged.notify()}}}},toggleSelected:function(e,t,i){t=t||a.default.focusedPane;var n=this._selectedForPaneObs(t),s=t.itemAtIndex(e),r=n.indexOf(e);r>=0&&!0!==i?(n.remove(e),s.itemChanged.notify()):r<0&&!1!==i&&(n.push(e),s.itemChanged.notify())},addSelected:function(e,t){this.toggleSelected(e,t,!0)},removeSelected:function(e,t){this.toggleSelected(e,t,!1)},selectInOrder:function(e,t,i){var n=0;i=i||a.default.focusedPane;for(var s=[],r=e;r<=t;r++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;s.push(r)}this.setSelected(s,i)},applyFnToSelected:function(e,t){var i=0;a.default.vmMain.beginUpdateItems(),t=t||a.default.focusedPane;for(var n,s=this.getSelectedItems(t),r=0;r<s.length&&!1!==n;r++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;n=e(s[r],r,s.length)}a.default.vmMain.commitUpdateItems()}},n.a.extend(l.prototype,s.a),t.a=new l},function(e,t,i){"use strict";var a=i(0),n=i(1),s=function(e,t){this._batchConstructor=e,this._batchParams=t,this._batchedRequests={},this._successCB=a.default.emptyFn,this._failureCB=a.default.emptyFn,this._context=void 0,this._hasRun=!1,this._batchID=a.default.generateTempId()};s.prototype={add:function(e,t,i){a.default.Assert(e,"Must provide a valid request to add to batch"),a.default.Assert(t,"Must supply a valid group ID when adding to a batch"),a.default.Assert(!this._hasRun,"Should never add new requests to a batch that has already run");var n=this._ensureGroup(t);return this._addRequestToGroup(t,i,e),n},then:function(e,t,i){this._successCB=e||a.default.newEmptyFn(),this._failureCB=t||a.default.newEmptyFn(),this._context=i,this._run()},execute:function(e){this._successCB=e,this._failureCB=e,this._run()},getBatchID:function(){return this._batchID},_ensureGroup:function(e){var t=!1;return this._batchedRequests[e]||(this._batchedRequests[e]={size:0,batch:this._createBatchInternal()},t=!0),t},_addRequestToGroup:function(e,t,i){var s=this._getGroupBatch(e),r=this._getGroupSize(e);a.default.Assert(r<=n.a.MaxBatchSize,"Too many requests for a single batch"),t?s.add(i,{id:t}):s.add(i)},_getGroupBatch:function(e){return a.default.Assert(this._batchedRequests[e],"Must ensure before querying"),this._batchedRequests[e].batch},_getGroupSize:function(e){return a.default.Assert(this._batchedRequests[e],"Must ensure before querying"),this._batchedRequests[e].size},_getBatchURL:function(){return this._baseURL},_run:function(){for(var e in a.default.Assert(!this._hasRun,"Should never run a batch twice"),this._hasRun=!0,this._batchedRequests){this._getGroupBatch(e).then(this._handleSuccess.bind(this),this._handleFailure.bind(this))}},_createBatchInternal:function(){return new this._batchConstructor(this._batchParams)},_handleSuccess:function(e){a.default.Assert(this._hasRun,"Must run batch before success"),this._successCB.call(this._context,e)},_handleFailure:function(e){a.default.Assert(this._hasRun,"Must run batch before failure"),this._failureCB.call(this._context,e)}};var r=s,o=i(11),l=function(){0};l.prototype={fns:function(e){return this._data.gapi.client[e]},generatePackedFns:function(e){var t=this._data.gapi.client[e],i=["gapi","client",e];this._iterateAPI(t,i)},_iterateAPI:function(e,t){if(a.default.isString(e.path))e.packedFn||(log("WARNING: Missing Pre-Packed Fn: [ '"+t.join("', '")+"' ]"),e.packedFn=t.slice(0));else for(var i in e)a.default.isObject(e[i])&&(t.push(i),this._iterateAPI(e[i],t),t.pop())},_constructPath:function(e,t){var i=a.default.clone(t);for(var n in t){var s=new RegExp("\\{"+n+"\\}"),r=e.replace(s,encodeURIComponent(t[n]));r!==e&&delete i[n],e=r}return delete i.resource,delete i.timeoutMS,delete i.forceNoDupe,{path:e,fields:i}},_constructHeaders:function(e,t){var i={Authorization:"Bearer "+o.a.getAccountTokenSync(t).access_token};for(var a in e)i[a]=e[a];return i},canConstruct:function(e){var t=!1;return a.default.isFunction(e)||(t=!!a.default.unpackFn(e,this._data)),t},createBatch:function(e){return new r(gapi.client.newBatch,e)},createRequest:function(e,t,i){var n,s=a.default.unpackFn(t,this._data);if(s){var r=this._constructPath(s.path,i),o=this._constructHeaders(s.headers,e),l={path:r.path,method:s.method||"GET",params:r.fields,body:i.resource,headers:o};a.default.isDemoMode()&&(l.__packedFn=t,l.__rawParams=i),n=gapi.client.request(l)}else{var d=a.default.unpackFn(t);d&&(n=d(i))}return n},getAPIForRequest:function(e){return a.default.Assert(a.default.isDemoMode(),"Must only reverse the path in demo mode"),a.default.unpackFn(e.__packedFn)},_data:{gapi:{client:{drive:{files:{get:{path:"/drive/v2/files/{fileId}",method:"GET",packedFn:["gapi","client","drive","files","get"]},list:{path:"/drive/v2/files",method:"GET",packedFn:["gapi","client","drive","files","list"]},trash:{path:"/drive/v2/files/{fileId}/trash",method:"POST",packedFn:["gapi","client","drive","files","trash"]},untrash:{path:"/drive/v2/files/{fileId}/untrash",method:"POST",packedFn:["gapi","client","drive","files","untrash"]},insert:{path:"/drive/v2/files",method:"POST",packedFn:["gapi","client","drive","files","insert"]},patch:{path:"/drive/v2/files/{fileId}",method:"PATCH",packedFn:["gapi","client","drive","files","patch"]}},permissions:{list:{path:"/drive/v2/files/{fileId}/permissions",method:"GET",packedFn:["gapi","client","drive","permissions","list"]},insert:{path:"/drive/v2/files/{fileId}/permissions",method:"POST",packedFn:["gapi","client","drive","permissions","insert"]},delete:{path:"/drive/v2/files/{fileId}/permissions/{permissionId}",method:"DELETE",packedFn:["gapi","client","drive","permissions","delete"]}},properties:{insert:{path:"/drive/v2/files/{fileId}/properties",method:"POST",packedFn:["gapi","client","drive","properties","insert"]},update:{path:"/drive/v2/files/{fileId}/properties/{propertyKey}",method:"PUT",packedFn:["gapi","client","drive","properties","update"]}},parents:{insert:{path:"/drive/v2/files/{fileId}/parents",method:"POST",packedFn:["gapi","client","drive","parents","insert"]},delete:{path:"/drive/v2/files/{fileId}/parents/{parentId}",method:"DELETE",packedFn:["gapi","client","drive","parents","delete"]}},changes:{list:{path:"/drive/v2/changes",method:"GET",packedFn:["gapi","client","drive","changes","list"]}},children:{list:{path:"/drive/v2/files/{folderId}/children",method:"GET",packedFn:["gapi","client","drive","children","list"]},delete:{path:"/drive/v2/files/{folderId}/children/{childId}",method:"DELETE",packedFn:["gapi","client","drive","children","delete"]}}},gmail:{users:{threads:{list:{path:"/gmail/v1/users/{userId}/threads",method:"GET",packedFn:["gapi","client","gmail","users","threads","list"]},get:{path:"/gmail/v1/users/{userId}/threads/{id}",method:"GET",packedFn:["gapi","client","gmail","users","threads","get"]},modify:{path:"/gmail/v1/users/{userId}/threads/{id}/modify",method:"POST",packedFn:["gapi","client","gmail","users","threads","modify"]},trash:{path:"/gmail/v1/users/{userId}/threads/{id}/trash",method:"POST",packedFn:["gapi","client","gmail","users","threads","trash"]},untrash:{path:"/gmail/v1/users/{userId}/threads/{id}/untrash",method:"POST",packedFn:["gapi","client","gmail","users","threads","untrash"]}},labels:{list:{path:"/gmail/v1/users/{userId}/labels",method:"GET",packedFn:["gapi","client","gmail","users","labels","list"]},create:{path:"/gmail/v1/users/{userId}/labels",method:"POST",packedFn:["gapi","client","gmail","users","labels","create"]}},history:{list:{path:"/gmail/v1/users/{userId}/history",method:"GET",packedFn:["gapi","client","gmail","users","history","list"]}},messages:{get:{path:"/gmail/v1/users/{userId}/messages/{id}",method:"GET",packedFn:["gapi","client","gmail","users","messages","get"]},send:{path:"/gmail/v1/users/{userId}/messages/send",method:"POST",packedFn:["gapi","client","gmail","users","messages","send"]},trash:{path:"/gmail/v1/users/{userId}/messages/{id}/trash",method:"POST",packedFn:["gapi","client","gmail","users","messages","trash"]},untrash:{path:"/gmail/v1/users/{userId}/messages/{id}/untrash",method:"POST",packedFn:["gapi","client","gmail","users","messages","untrash"]},attachments:{get:{path:"/gmail/v1/users/{userId}/messages/{messageId}/attachments/{id}",method:"GET",packedFn:["gapi","client","gmail","users","messages","attachments","get"]}}},drafts:{create:{path:"/gmail/v1/users/{userId}/drafts",method:"POST",packedFn:["gapi","client","gmail","users","drafts","create"]},update:{path:"/gmail/v1/users/{userId}/drafts/{id}",method:"PUT",packedFn:["gapi","client","gmail","users","drafts","update"]},send:{path:"/gmail/v1/users/{userId}/drafts/send",method:"POST",packedFn:["gapi","client","gmail","users","drafts","send"]},delete:{path:"/gmail/v1/users/{userId}/drafts/delete",method:"DELETE",packedFn:["gapi","client","gmail","users","drafts","delete"]},list:{path:"/gmail/v1/users/{userId}/drafts",method:"GET",packedFn:["gapi","client","gmail","users","drafts","list"]}},settings:{sendAs:{list:{path:"/gmail/v1/users/{userId}/settings/sendAs",method:"GET",packedFn:["gapi","client","gmail","users","settings","sendAs","list"]}}}}},calendar:{settings:{list:{path:"/calendar/v3/users/{userId}/settings",method:"GET",packedFn:["gapi","client","calendar","settings","list"]}},events:{get:{path:"/calendar/v3/calendars/{calendarId}/events/{eventId}",method:"GET",packedFn:["gapi","client","calendar","events","get"]},list:{path:"/calendar/v3/calendars/{calendarId}/events",method:"GET",packedFn:["gapi","client","calendar","events","list"]},patch:{path:"/calendar/v3/calendars/{calendarId}/events/{eventId}",method:"PATCH",packedFn:["gapi","client","calendar","events","patch"]},insert:{path:"/calendar/v3/calendars/{calendarId}/events",method:"POST",packedFn:["gapi","client","calendar","events","insert"]},delete:{path:"/calendar/v3/calendars/{calendarId}/events/{eventId}",method:"DELETE",packedFn:["gapi","client","calendar","events","delete"]}},calendars:{insert:{path:"/calendar/v3/calendars",method:"POST",packedFn:["gapi","client","calendar","calendars","insert"]}},calendarList:{list:{path:"/calendar/v3/users/{userId}/calendarList",method:"GET",packedFn:["gapi","client","calendar","calendarList","list"]}}}}}}};t.a=new l},function(e,t,i){"use strict";var a=i(0),n=i(1);function s(){this._localized=[],this._loadedDateFormat=void 0,this.init()}var r=/([\s]|^)(\d{1,2})[-/.](\d{1,2})(?:[-/.](\d{2,4}))?/g,o=/([\s]|^)(?:(\d{2,4})[-/.])?(\d{1,2})(?:[-/.](\d{1,2}))/g;window.DFormat={LongDayTime:0,ShortDayTime:1,ShortTime:2,ShortDate:3,MonthDay:4,MonthDayYear:5,LongStrDate:6,DayYearTime:7,MonthDayYearShort:8,DayMonthDateYear:9,MonthDayLong:10,MonthDayYearLong:11,DayDate:12,NoPadShortDayTime:13,MonthDayShort:14},s.prototype={init:function(){var e=a.default.settings.get(Settings.dateFormat)||n.a.DateFormat.MDY;this._loadLocalized(e),a.default.settings.registerForChangeNotification(Settings.dateFormat,void 0,function(e,t){if(this._loadLocalized(t||n.a.DateFormat.MDY),a.default.vmMain.root()){a.default.vmMain.parseSubtree(a.default.vmMain.root(),ChangeType.Auto);var s=i(24).default;s.clearItemCache(),s.clearLineCache(),a.default.vmMain.updateAllItems(!1,!0)}}.bind(this))},parseDate:function(e,t){return Date.parse(this.normalizeDateString(e,t))},parseDateDefaultFormat:function(e){return Date.parse(this.normalizeDateString(e,this.getCurrentDateFormat()))},getFormat:function(e){return a.default.Assert(this._localized[e],"Invalid format request"),this._localized[e]},getCurrentDateFormat:function(){return this._loadedDateFormat||n.a.DateFormat.MDY},_loadLocalized:function(e){this._loadedDateFormat=e,this._localized[DFormat.LongDayTime]="dddd h:mm tt",this._localized[DFormat.ShortTime]="h:mm tt",this._localized[DFormat.MonthDay]="MMM d",this._localized[DFormat.LongStrDate]="MMMM dd, yyyy",this._localized[DFormat.DayMonthDateYear]="ddd, MMM dd, yyyy",this._localized[DFormat.MonthDayLong]="MMMM d",this._localized[DFormat.MonthDayYearLong]="MMMM d, yyyy",e===n.a.DateFormat.MDY?(this._localized[DFormat.ShortDayTime]="MM/dd h:mm tt",this._localized[DFormat.ShortDate]="MM/dd",this._localized[DFormat.MonthDayYear]="MM/dd/yy",this._localized[DFormat.MonthDayYearShort]="M/d/yy",this._localized[DFormat.DayYearTime]="MM/dd/yy h:mm tt",this._localized[DFormat.DayDate]="ddd M/d",this._localized[DFormat.NoPadShortDayTime]="M/dd h:mm tt",this._localized[DFormat.MonthDayShort]="M/d"):e===n.a.DateFormat.DMY?(this._localized[DFormat.ShortDayTime]="dd/MM h:mm tt",this._localized[DFormat.ShortDate]="dd/MM",this._localized[DFormat.MonthDayYear]="dd/MM/yy",this._localized[DFormat.MonthDayYearShort]="d/M/yy",this._localized[DFormat.DayYearTime]="dd/MM/yy h:mm tt",this._localized[DFormat.DayDate]="ddd d/M",this._localized[DFormat.NoPadShortDayTime]="dd/M h:mm tt",this._localized[DFormat.MonthDayShort]="d/M"):e===n.a.DateFormat.YMD?(this._localized[DFormat.ShortDayTime]="MM/dd h:mm tt",this._localized[DFormat.ShortDate]="MM/dd",this._localized[DFormat.MonthDayYear]="yy/MM/dd",this._localized[DFormat.MonthDayYearShort]="yy/M/d",this._localized[DFormat.DayYearTime]="yy/MM/dd h:mm tt",this._localized[DFormat.DayDate]="ddd M/d",this._localized[DFormat.NoPadShortDayTime]="M/dd h:mm tt",this._localized[DFormat.MonthDayShort]="M/d"):a.default.Assert(!1,"Unsupport date format requested: "+e)},formatDate:function(e,t,i){var n;if(a.default.Assert(a.default.isDateValid(e),"Must provide a valid date to format"),a.default.Assert(t,"Must provide a valid format for the date"),a.default.isDateValid(e)){var s=e.toString(this.getFormat(t));n=i&&i!==this._loadedDateFormat?this.convertDateFormat(s,this._loadedDateFormat,i):s}return n},_isParsedDateValid:function(e,t,i){var n=!0,s=a.default.parseInt(e),r=a.default.parseInt(t),o=a.default.parseInt(i);return void 0!==e&&s<13?n=!1:r<=0||r>12?n=!1:(o<=0||o>31)&&(n=!1),n},_detectDelim:function(e){var t="/";return e.indexOf("-")>=0?t="-":e.indexOf(".")>=0&&(t="."),t},convertDateFormat:function(e,t,i){a.default.Assert(t,"Must provide a date format to convert from"),a.default.Assert(i,"Must provide a date format to convert to");var s=e;if(t!==i){var l,d,u=0;for(o.lastIndex=0,r.lastIndex=0,l=t===n.a.DateFormat.YMD?o:r;null!==(d=l.exec(s));){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;var c,h,f,p,g=this._detectDelim(s);if(i===n.a.DateFormat.MDY)switch(t){case n.a.DateFormat.DMY:d[4]?(h=d[4],c=(f=d[3])+g+(p=d[2])+g+h):d[2]&&d[3]&&(c=(f=d[3])+g+(p=d[2]));break;case n.a.DateFormat.YMD:d[2]?(h=d[2],c=(f=d[3])+g+(p=d[4])+g+h):d[3]&&d[4]&&(c=(f=d[3])+g+(p=d[4]));break;default:a.default.Assert(!1,"Invalid date format requested from MDY: ",t)}else if(i===n.a.DateFormat.DMY)switch(t){case n.a.DateFormat.MDY:d[4]?(h=d[4],f=d[2],c=(p=d[3])+g+f+g+h):d[2]&&d[3]&&(f=d[2],c=(p=d[3])+g+f);break;case n.a.DateFormat.YMD:d[2]?(h=d[2],f=d[3],c=(p=d[4])+g+f+g+h):d[3]&&d[4]&&(f=d[3],c=(p=d[4])+g+f);break;default:a.default.Assert(!1,"Invalid date format requested from DMY: ",t)}else if(i===n.a.DateFormat.YMD)switch(t){case n.a.DateFormat.MDY:d[4]?c=(h=d[4])+g+(f=d[2])+g+(p=d[3]):d[2]&&d[3]&&(c=(f=d[2])+g+(p=d[3]));break;case n.a.DateFormat.DMY:d[4]?c=(h=d[4])+g+(f=d[3])+g+(p=d[2]):d[2]&&d[3]&&(c=(f=d[3])+g+(p=d[2]));break;default:a.default.Assert(!1,"Invalid date format requested from YMD: ",t)}else a.default.Assert(!1,"Invalid date format requested: ",i);c&&this._isParsedDateValid(h,f,p)&&(s=s.substr(0,d.index)+d[1]+c+s.substr(d.index+d[0].length))}}return s},normalizeDateString:function(e,t){var i=e,a=!1;e.startsWith(n.a.DatePrefix)&&(i=e.slice(1),a=!0);var s=this.convertDateFormat(i,t,n.a.DateFormat.MDY);return a?n.a.DatePrefix+s:s},getAppendDateText:function(e,t,i){var n,s=Date.today();n=e<s||e.getFullYear()!==s.getFullYear()?this.getFormat(DFormat.MonthDayYearShort):this.getFormat(DFormat.MonthDayShort);var r=e.toString(n);if(t instanceof Date)n=0===t.getMinutes()?" htt":" h:mmtt",r+=t.toString(n);else if(a.default.isNumber(t)){var o=Math.floor(t),l=o%12,d=a.default.pad2(60*(t-o));0===l&&(l=12),r+=" "+l+":"+d+(o>11?"pm":"am")}return isNaN(i)||(r+=" "+a.default.round(i,2)+"hr"),r}},t.a=new s},function(e,t,i){"use strict";var a=i(0),n=i(5),s=i(4),r=i(40),o=i(3);function l(){this.styles={},this.stylesheet={},this.Themes={SpacingCompact:{itemLineHeight:18,itemPadding:3,itemIndentSize:20,fontSizeHeader:16,fontSizeHeaderTopLevel:16},SpacingComfortable:{itemLineHeight:18,itemPadding:5,itemIndentSize:30,fontSizeHeader:16,fontSizeHeaderTopLevel:18},PrefixesFaded:{projectOpacity:30,bulletOpacity:30,checkboxOpacity:25,checkboxBackgroundOpacity:0},PrefixesStrong:{projectOpacity:80,bulletOpacity:80,checkboxOpacity:80,checkboxBackgroundOpacity:20}},this.Defaults={Desktop:{noteLineHeight:18,notePadding:0,noteFontSize:12,grayscale:!1,boldHeaders:!1,fontSize:14,showVerticalLines:!0,verticalLinesOpacity:6,Colors:{light:{bulletColor:"#222222",projectColor:"#222222",verticalLinesColor:32,tagColor:"#0099DD",dateColor:"#AA3300",contactColor:"#22AA66",linkColor:"#3333BB",calendarLinesColor:"#E6E6E6"},dark:{bulletColor:"#F6F6F6",projectColor:"#F6F6F6",verticalLinesColor:255,tagColor:"#0099DD",dateColor:"#C9302C",contactColor:"#00AF4A",linkColor:"#539bd8",calendarLinesColor:"#444444"}}}},this.timeoutSettingChanged=void 0,n.a.forceBind("_updateSettings",this),n.a.forceBind("updateStyles",this),this.updateSettingValues()}l.prototype={getSettingValue:function(e,t){var i=!t;if(t)if(a.default.billingManager)if(a.default.billingManager.hasPremiumFeatures())i=!0;else{var n=a.default.billingManager.getPremiumStatus();i=n===PremiumStatus.Unknown||n===PremiumStatus.Trial||n===PremiumStatus.Active||n===PremiumStatus.Never}else i=!0;if(i){var s=a.default.settings.get(e,Settings.UISettingsGroup);return s===this.Defaults.Desktop.Colors.light[e]?this.Defaults.Desktop.Colors[this._colorTheme][e]:s}return this.getThemeValue(e)},getThemeValue:function(e){var t=this.Themes.SpacingComfortable[e];return void 0===t&&(t=this.Themes.PrefixesFaded[e]),void 0===t&&(t=this.Defaults.Desktop[e]),void 0===t&&(t=this.Defaults.Desktop.Colors[this._colorTheme][e]),t},setFromThemeValue:function(e,t){a.default.settings.set(t,this.getThemeValue(t),Settings.UISettingsGroup)},updateSettingValues:function(){this._colorTheme=a.default.settings.get(Settings.theme),this._bulletColor=this.Defaults.Desktop.Colors[this._colorTheme].bulletColor,this._projectColor=this.Defaults.Desktop.Colors[this._colorTheme].projectColor,this._verticalLinesColor=this.Defaults.Desktop.Colors[this._colorTheme].verticalLinesColor,this._boldHeaders=this.getSettingValue(Settings.boldHeaders),this._fontSize=this.getSettingValue(Settings.fontSize,!0),this._fontSizeHeader=this.getSettingValue(Settings.fontSizeHeader,!0),this._fontSizeHeaderTopLevel=this.getSettingValue(Settings.fontSizeHeaderTopLevel,!0),this._noteFontSize=this.getSettingValue(Settings.noteFontSize,!0),this._itemPadding=this.getSettingValue(Settings.itemPadding,!0),this._notePadding=this.getSettingValue(Settings.notePadding,!0),this._itemLineHeight=this.getSettingValue(Settings.itemLineHeight,!0),this._noteLineHeight=this.Defaults.Desktop.noteLineHeight,this._itemIndentSize=this.getSettingValue(Settings.itemIndentSize,!0),this._bulletOpacity=this.getSettingValue(Settings.bulletOpacity,!0),this._projectOpacity=this.getSettingValue(Settings.projectOpacity,!0),this._checkboxOpacity=this.getSettingValue(Settings.checkboxOpacity,!0),this._checkboxBackgroundOpacity=this.getSettingValue(Settings.checkboxBackgroundOpacity,!0),this._showVerticalLines=this.getSettingValue(Settings.showVerticalLines,!0),this._verticalLinesOpacity=this.getSettingValue(Settings.verticalLinesOpacity,!0),this._tagColor=this.getSettingValue(Settings.tagColor,!0),this._dateColor=this.getSettingValue(Settings.dateColor,!0),this._contactColor=this.getSettingValue(Settings.contactColor,!0),this._linkColor=this.getSettingValue(Settings.linkColor,!0),this._grayscale=this.getSettingValue(Settings.grayscale)},onSettingChanged:function(){this.timeoutSettingChanged||this.isChangingTheme||(this.timeoutSettingChanged=setTimeout(this._updateSettings,0))},_updateSettings:function(){var e=this._fontSize,t=this._fontSizeHeader,i=this._fontSizeHeaderTopLevel,n=this._noteFontSize;this.timeoutSettingChanged=void 0,this.updateSettingValues();var s=this._fontSize!==e||this._fontSizeHeader!==t||this._fontSizeHeaderTopLevel!==i||this._noteFontSize!==n;this.fireEvent("settingsChanged",[s]),a.default.vmMain&&a.default.vmMain.paneManager&&a.default.vmMain.paneManager.clearPaneCaches(),a.default.vmMain&&a.default.vmMain.updateAllItems(!1,!0),o.a.updateCaret()},fontSize:function(){return 15},fontSizeHeader:function(){return this._fontSizeHeader},fontSizeHeaderTopLevel:function(){return this._fontSizeHeaderTopLevel},fontSizeHeaderProjectView:function(){return 17},noteFontSize:function(){return 12},itemPadding:function(){return 7},notePadding:function(){return 0},itemLineHeight:function(){return 18},noteLineHeight:function(){return 18},itemIndentSize:function(){return 20},itemIndentStart:function(){return 24},paddingForBlockHeader:function(){return 0},paddingForItemBottom:function(e,t,i){return t.hasNote()?i&&i.isViewProject()&&i.isItemTopLevel(e,t)?this.itemPadding():0:this.itemPadding()},paddingForItemTop:function(e,t,i){return t.isNote()?this.notePadding():this.itemPadding()},fontSizeForItem:function(e,t,i){if(t.isPrefixHeader()){if(i.isItemTopLevel(e,t))return this.fontSizeHeaderTopLevel();if(i.isViewOutline())return this.fontSizeHeader()}else if(t.isNote())return this.noteFontSize();return this.fontSize()},lineHeightForItem:function(e,t,i){var a=this.itemLineHeight()-this.fontSize();return t.isNote()?this.noteLineHeight():this.fontSizeForItem(e,t,i)+a},boldHeaders:function(){return!!s.a.phone||this._boldHeaders},createSheet:function(){var e=document.head||document.getElementsByTagName("head")[0],t=document.createElement("style");t.type="text/css",t.rel="stylesheet",e.appendChild(t),this.sheet=t.sheet},changeColorTheme:function(e){e!==this._colorTheme&&(this._colorTheme=e,a.default.settings.set(Settings.theme,e),this.updateSettingValues(),this.updateStyles(),this.fireEvent("themeChanged",[]))},changeTheme:function(e,t){this.isChangingTheme=!0;var i=this.Themes[t];for(var n in i)i.hasOwnProperty(n)&&a.default.settings.set(n,i[n],Settings.UISettingsGroup);a.default.settings.set(e,t,Settings.UISettingsGroup),this.isChangingTheme=!1,this._updateSettings()},updateStyles:function(){a.default.Assert(!1,"Should not be running display settings on mobile")},tagColor:function(){return this._tagColor},dateColor:function(){return this._dateColor},contactColor:function(){return this._contactColor},isDark:function(){return!1}},n.a.extend(l.prototype,r.a),t.a=new l},function(e,t,i){"use strict";var a=i(0),n=function(){function e(e,t){for(var i=0,a=0;a<t.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();var s=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,[{key:"init",value:function(){}},{key:"saveItem",value:function(e,t,i){e.save(t,i)}}]),e}()),r=i(5),o=i(1),l=i(45),d=i(4),u=i(11),c=i(13),h=i(16),f=i(9),p=function(){function e(e,t){for(var i=0,a=0;a<t.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();var g=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r.a.binder(this,"onGapiLoaded","onGapiClientLoaded","onGapiLoadError","onReady","goOnline","tryToReloadGapi"),this._isLoaded=!1,this._gapiLoadError=!0,this._isLoadingScript=!1,this._numTriesLoad=-1,c.a.listen("goOnline",this.goOnline)}return p(e,[{key:"init",value:function(){this.loadScript(),h.default.init()}},{key:"loadScript",value:function(){var e=document.getElementById("gapiScript");e&&e.parentNode.removeChild(e),a.default.addScript("https://apis.google.com/js/api.js","gapiScript",this.onGapiLoaded,this.onGapiLoadError)}},{key:"onGapiLoaded",value:function(){gapi.load("client:drive-realtime",{callback:this.onGapiClientLoaded,onerror:this.onGapiLoadError})}},{key:"onGapiClientLoaded",value:function(){if(window.gapi&&window.gapi.drive&&window.gapi.drive.realtime)a.default.blockedMessage="",this._gapiLoadError=!1,this._numTriesLoad=-1,a.default.fireCustomEvent("gapiLoaded"),l.a.onAuthed(this.onReady);else{var e;window.gapiCalled=!1,window.gapiLoadError=!0,e=gapi?gapi.drive?gapi.drive.realtime?"all exist":"gapi.drive.realtime":"gapi.drive":"gapi";var t=function(t){a.default.isBlocked=!0,d.a.app||t?(a.default.reportError(new Error("Error loading GAPI: "+e)),a.default.blockedMessage="There was an error loading the Google APIs."):(a.default.reportError(new Error("Extension blocked gapi from loading: "+e)),a.default.blockedMessage="An extension has blocked apis.google.com from loading."),a.default.vmMain&&a.default.vmMain.gdriveStatus(DriveStatus.Offline)};a.default.XHR({type:"GET",timeout:7e3,url:"https://api.moo.do/private/v1/info",cb:function(e){var i=!1;if(200===e.status){var a;try{!0===(a=JSON.parse(e.response)).success&&0===a.data.indexOf("Moo.do")&&(i=!0)}catch(e){}t(!i)}else t(!0)}})}}},{key:"onReady",value:function(){var e=this;if(!this._isLoaded&&navigator.onLine){var t=l.a.getScopes().join(" ");gapi.client.init({apiKey:o.a.APIKey,clientId:o.a.ClientID,scope:t}).then(function(){var t=function(){if(!e._isLoaded){e._isLoaded=!0;var t=u.a.getAccountTokenSync("me");a.default.vmMain.realtimeDocManager.notifyGoogleAuthorization(),u.a.notifyUserAuthorized("me",t),h.default.loadClientDefaultFile(),a.default.fireCustomEvent("gapiDriveLoaded")}};gapi.auth2.getAuthInstance().isSignedIn.get()?t():(gapi.auth2.getAuthInstance().isSignedIn.listen(t),h.default.runAuthenticate(h.default.requestScopes,!0,!1,function(i){i&&!i.error?t():e.requestSignIn()}))})}}},{key:"requestSignIn",value:function(){a.default.menus.alert({text:"Moo.do encountered an issue with your authorization. Please sign in again.",callback:function(){l.a.signIn()}})}},{key:"onGapiLoadError",value:function(){this._gapiLoadError=!0,navigator.onLine&&this.goOnline()}},{key:"tryToReloadGapi",value:function(){this._gapiLoadError&&(this.loadScript(),this.numTriesLoad-- >0?setTimeout(this.tryToLoadGapi,a.default.seconds(20)):this._isLoadingScript=!1)}},{key:"goOnline",value:function(){this._gapiLoadError?(this._numTriesLoad=2,this._isLoadingScript||(this._isLoadingScript=!0,setTimeout(this.tryToReloadGapi,a.default.seconds(5)))):this._isLoaded||l.a.onAuthed(this.onReady)}},{key:"saveItem",value:function(e,t){f.a.saveChanges(e,t)}}]),e}()),m=function(){function e(e,t){for(var i=0,a=0;a<t.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();var v=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return m(e,[{key:"init",value:function(){g.init()}},{key:"saveItem",value:function(e,t){g.saveItem(e,t)}}]),e}()),_=i(6),y=i(61),S=function(){function e(e,t){for(var i=0,a=0;a<t.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();var w=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r.a.binder(this,"checkBackup","onTimeChanged")}return S(e,[{key:"init",value:function(){this.lastBackup=a.default.settings.get(Settings.lastBackup),this.needsBackup=a.default.settings.get(Settings.needsBackup),this.backupFrequency=a.default.settings.get(Settings.backupFrequency),this.timeoutCheckBackup=void 0,a.default.settings.listen("settingChanged",Settings.DefaultGroup,Settings.backupFrequency,this.onTimeChanged),this.needsBackup&&u.a.onUserAuthorized("me","Backup",this.checkBackup)}},{key:"setNeedsBackup",value:function(e){this.needsBackup=e,a.default.settings.set(Settings.needsBackup,e)}},{key:"setLastBackup",value:function(e){this.lastBackup=e,a.default.settings.set(Settings.lastBackup,e)}},{key:"onTimeChanged",value:function(e){this.backupFrequency=e,this.setNeedsBackup(!1),this.timeoutCheckBackup&&clearTimeout(this.timeoutCheckBackup)}},{key:"onDataSaved",value:function(){this.backupFrequency>0&&!this.needsBackup&&(log("Scheduling backup in",this.backupFrequency/1e3,"seconds"),this.timeoutCheckBackup=setTimeout(this.checkBackup,this.backupFrequency),this.setLastBackup(Date.now()),this.setNeedsBackup(!0))}},{key:"checkBackup",value:function(){if(this.needsBackup&&this.backupFrequency>0){if(!isNaN(this.lastBackup)&&Date.now()-this.lastBackup>this.backupFrequency)return this.backup(),!0;var e=isNaN(this.lastBackup)?this.backupFrequency:this.lastBackup+this.backupFrequency-Date.now();this.timeoutCheckBackup=setTimeout(this.checkBackup,e)}}},{key:"backup",value:function(e){var t=this;this.timeoutCheckBackup&&clearTimeout(this.timeoutCheckBackup);var i=_.default.getRootItem(),n=_.default.toJSON(i,!1,!0,!0,!0),s=new Blob([n],{type:"application/json"}),r=(new Date).toString("yy/MM/dd h:mm tt");s.name=a.default.settings.get(Settings.gdocTitle)+" "+r,new y.a(s,"me",o.a.DriveFolder.Backup,function(){},function(){log("Backup complete",Date.now()),t.setLastBackup(Date.now()),t.setNeedsBackup(!1),e&&e()},function(e){log("on error",e)}).upload()}}]),e}()),I=function(){function e(e,t){for(var i=0,a=0;a<t.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();var b=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return I(e,[{key:"init",value:function(){s.init(),v.init(),w.init()}},{key:"saveItem",value:function(e,t,i,n,r){e.shouldSave()&&(a.default.isLocalChange(i)&&!a.default.isUndoRedoChange(i)?(v.saveItem(e,t),t=a.default.clone(t)):n=SaveFlag.None,r&&a.default.extend(t,r),s.saveItem(e,t,n)),w.onDataSaved()}},{key:"saveItemRemote",value:function(e,t){v.saveItem(e,t)}},{key:"saveItemLocal",value:function(e,t,i){s.saveItem(e,t,i)}}]),e}();t.a=new b},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(5),r=i(4),o=i(20),l=i(8),d=i(23),u=i(13),c=i(39),h=i(42),f=i(3),p=i(7),g=i(54);function m(){this.openOnPane=void 0,this.messages=new d.a,this.messagesLoaded=new l.a(!1),this.isLoading=new l.a(!1),this.errorMessage=new l.a(""),this.threadAttach=void 0,this.threadAttachLoading=void 0,this.threadItem=void 0,this.numLoaded=0,this._cachedCSS=void 0,s.a.forceBind("onAttachmentUpdate",this),s.a.forceBind("reset",this),s.a.forceBind("_onWindowResizeTimeout",this),o.a.listen("themeChanged",this.onDisplaySettingsChanged.bind(this)),this.init()}function v(e,t){!function(){function i(e){console.log("ERROR: ",e)}var a=window.InjectedJS={postMessage:function(t,a){try{var n;if(void 0!==a)if("string"==typeof a)n="-"+a;else try{n="-"+JSON.stringify(a)}catch(e){i(e),n=""}else n="";window.parent.postMessage("-"+t+"-"+e+n,"*")}catch(e){i(e)}}};function n(e){var i,n,s=1;t.isAndroid&&(i=document.documentElement.scrollWidth,n=document.documentElement.clientWidth/i,(s=Math.max(n,.25))<1&&(document.documentElement.style.transform="scale("+s+")")),a.postMessage("resize",{canBeShorter:e,scale:s})}var s=!1;function r(){document.removeEventListener("DOMContentLoaded",r,!1),s?n():(s=!0,function(){var e=0,t=0,i=0;document.documentElement.addEventListener("click",function(e){a.postMessage("click")}),document.addEventListener("keydown",function(e){var t={type:e.type,keyCode:e.keyCode,charCode:e.charCode,which:e.which,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,metaKey:e.metaKey,altKey:e.altKey};a.postMessage("keypress",t)},!0);for(var s=function(e){e.stopImmediatePropagation(),e.preventDefault();var t=this.getAttribute("href");return t.startsWith("attach:")?a.postMessage("reqResource",[t]):t.startsWith("moodoAction:")?a.postMessage(t.replace(/^moodoAction:/gi,"")):a.postMessage("href",t),!1},r=document.querySelectorAll("[mlink]"),o=0;o<r.length;++o){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;r[o].addEventListener("click",s)}var l=document.querySelectorAll("[place]");for(o=0;o<l.length;++o){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;l[o].addEventListener("click",function(e){for(var t=0,i=this.id,a=this.nextElementSibling,s=!1;a&&a.getAttribute("group")===i;){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var r="collapsed"===a.getAttribute("quote")?"uncollapsed":"collapsed";"collapsed"===r&&(s=!0),a.setAttribute("quote",r),a=a.nextElementSibling}return setTimeout(function(){n(s)},0),e.stopImmediatePropagation(),e.preventDefault(),!1})}var d=[],u=document.querySelectorAll("img");for(o=0;o<u.length;++o){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var c=u[o].getAttribute("cid");c&&d.push(c),u[o].addEventListener("load",function(){n()})}d.length>0&&a.postMessage("reqResource",d)}(),a.postMessage("epLoaded"))}window.addEventListener("message",function(e){if(e.data&&e.data.startsWith&&e.data.startsWith("-")){var t=e.data.indexOf("-",1),a=e.data.substring(1,t),s=e.data.substring(t+1);switch(a){case"resLoad":try{if(s)for(var r=0,o=JSON.parse(s),l=document.querySelectorAll('[cid="'+o.cid+'"]'),d="data:"+o.mimeType+";base64,"+o.data,u=0;u<l.length;++u){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;l[u].src=d}}catch(e){i(e)}break;case"contentLoad":try{if(s){o=JSON.parse(s);document.open(),document.write(o.data),document.close(),setTimeout(n,0)}}catch(e){i(e)}break;default:i(new Error("Unknown PreviewFrame message: "+a))}}}),"complete"===document.readyState||"interactive"===document.readyState?setTimeout(r):(document.addEventListener("DOMContentLoaded",r,!1),window.addEventListener("load",r,!1))}()}m.prototype={init:function(){window.addEventListener("message",function(e){if(a.default.getLocationOrigin()===e.origin&&e.data&&e.data.startsWith&&e.data.startsWith("-")){var t=e.data.indexOf("-",1),i=e.data.indexOf("-",t+1);i<0&&(i=void 0);var n=e.data.substring(1,t),s=e.data.substring(t+1,i),r=i?e.data.substring(i+1):void 0;a.default.batchRenderUpdates(function(){this.handleFrameMessage(s,n,r,e)}.bind(this))}}.bind(this)),u.a.listen("selectedIndexChanged",this.onSelectedIndexChanged.bind(this)),r.a.onResize.listen(this._onWindowResize.bind(this))},reset:function(e,t){if(this.threadAttach){for(var i=0,a=this.threadAttach.getField("messages"),n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;a[n].initializedForDisplay&&this._destroyMessageDisplay(a[n])}this.threadAttach.unsubscribe(this)}this.numLoaded=0,this.threadAttach=void 0,this.threadItem=void 0,this.emailElement=void 0,this.errorMessage.set("",!1),this.isLoading.set(t,!1),this.messagesLoaded.set(!1,!1),this.messages.get().length>0&&this.messages.set([],e)},_onWindowResizeTimeout:function(){if(this.threadAttach)for(var e=0,t=this.threadAttach.getField("messages"),i=0;i<t.length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;this.updateMessageHeight(t[i].id,!0)}},_onWindowResize:function(){a.default.timeoutOnce("email resize",this._onWindowResizeTimeout,0)},getPlugin:function(){return this.threadAttach?this.threadAttach.getPlugin():a.default.vmMain.getDefaultEmailPlugin()},_sendReply:function(e,t,i){a.default.Assert(e,"Must supply a valid target"),a.default.Assert(t,"Must supply a valid action");try{var n="-"+t+(void 0!==i?"-"+i:"");e.postMessage(n,"*")}catch(e){a.default.reportError(e)}},handleFrameMessage:function(e,t,i,n){switch(t){case"resize":try{var s=JSON.parse(i);this.updateMessageHeight(e,!0===s.canBeShorter,s.scale)}catch(e){a.default.reportError(e)}break;case"click":a.default.fireCustomEvent("tapMain");break;case"keypress":try{var o=JSON.parse(i);r.a.normalizeKeys(o),f.a.fireKeyEvent(document.documentElement,o)}catch(e){a.default.reportError(e)}break;case"href":if(i.startsWith("mailto:")){var l=this.parseMailtoURL(i.replace(/^mailto:/gi,"")),d={to:[{email:l.to}],subject:l.subject&&unescape(l.subject),body:l.body&&unescape(l.body).replace(/\r?\n/g,"<br>")};a.default.menus.openComposeEmail(this.getPlugin(),void 0,void 0,d)}else a.default.openUrl(i);break;case"epLoaded":this.onMessageLoaded(e);break;case"reloadMessage":this.threadAttach&&this._requestMessageReload(e,this.threadAttach,e);break;case"reqResource":try{if(a.default.Assert(n,"Must provide a valid request event"),this.threadAttach)for(var u=0,c=JSON.parse(i),h=0;h<c.length;++h){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;var p=c[h],g=!1;p.startsWith("attach:")&&(p=p.replace(/^attach:/gi,""),g=!0),this.getPlugin().loadResource(this.threadAttach.id,e,p,function(e,t){var i;e&&(i={cid:t,data:g?this._createMessageHTML(this.getPlugin()._decodeEmail(e.data,void 0,{}),{},"text/html").parsed:e.data,mimeType:e.mimeType});try{if(n.source&&i){var s=g?"contentLoad":"resLoad";this._sendReply(n.source,s,i?JSON.stringify(i):void 0)}}catch(e){a.default.reportError(e)}}.bind(this))}}catch(e){a.default.reportError(e)}break;default:log("Unknown message from child frame: ",e,t,i,n)}},isOpen:function(){return this.openOnPane&&this.openOnPane.isExpanded.get()},isOpenOnPane:function(e){return this.openOnPane===e&&this.openOnPane.isExpanded.get()},isOpenOnThread:function(e){return this.isOpen()&&this.threadAttach===e},close:function(){this.isOpen()&&(this.wantsPaneTransition=!0,this.setOpenPane(null),setTimeout(this.reset,n.a.EmailOpenTimeMobile),this.wantsPaneTransition=!1,u.a.fireEvent("EmailPreview","onClosed",[]))},setOpenPane:function(e,t){this.openOnPane&&this.openOnPane!==e&&this.openOnPane.setExpanded(!1,t),this.openOnPane=e,e&&e.setExpanded(!0,t)},_openPane:function(e,t){a.default.Assert(t,"Must supply a valid cb to openPane"),e!==this.openOnPane?(this.wantsPaneTransition=!0,setTimeout(function(){this.wantsPaneTransition=!1,t()}.bind(this),n.a.EmailOpenTime+100)):t(),this.setOpenPane(e)},getPane:function(){return a.default.Assert(this.openOnPane,"Should not be trying to get pane if email preview is not open"),this.openOnPane},startOpenOnLoad:function(e){this.setOpenPane(e,!1)},open:function(e,t,i,n){if(t!==this.threadAttach||i!==this.openOnPane){var s=t.getPlugin();this.reset(!0,!0),this.threadAttachLoading=t,f.a.closeKeyboard();var r=2,o=!1;if(n){var l=function(e){if(e.length>0)return e[e.length-1].labelIds.indexOf("DRAFT")<0&&this.setLastMessageResponseMode(n),!1}.bind(this);this.messages.listen(l)}var d=function(){0===--r&&t===this.threadAttachLoading&&(o?(this._setThread(t,e),p.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenEmail,data:{pane:i}})):this.errorMessage.get()?this.isLoading.set(!1):a.default.menus.alert({text:"Unable to load email messages. You may be offline.",actionText:"OKAY"}))}.bind(this);this._openPane(i,function(){d()}),s.loadThread(t,function(e,t,i){o=e,!e&&i?this.errorMessage.set(i):this.errorMessage.set(""),d()}.bind(this))}else n&&this.isOpen()&&this.setLastMessageResponseMode(n)},_getReplyToFromMessage:function(e){return this._selfSentMessage(e)?e.to:e.replyTo?[e.replyTo]:[e.from]},_getSenderFromMessage:function(e){var t=this.threadAttachLoading||this.threadAttach;return this._findSelf(t.getField("accountID"),e)},_selfSentMessage:function(e){return this.getPlugin().isMyAccountID(e.from.email)},_removeSelf:function(e){if(e){for(var t=0,i=e.slice(0),a=this.getPlugin(),n=0;n<i.length;n++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;a.isMyAccountID(i[n].email)&&(i.splice(n,1),n--)}return i}},_findSelf:function(e,t){var i,a=this.getPlugin(),n=a.getSendingAccounts(e);if(n.indexOf(t.from.email)>=0)i=t.from.email;else{if(t.to)for(var s=0,r=0;r<t.to.length;++r){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;if(n.indexOf(t.to[r].email)>=0){i=t.to[r].email;break}}if(!i&&t.cc){var o=0;for(r=0;r<t.cc.length;++r){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;if(n.indexOf(t.cc[r].email)>=0){i=t.cc[r].email;break}}}if(!i&&t.bcc){var l=0;for(r=0;r<t.bcc.length;++r){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;if(n.indexOf(t.bcc[r].email)>=0){i=t.bcc[r].email;break}}}}return i||(i=a.getDefaultSendingAccount(e)),{text:a.getDisplayName(i),email:i}},areContactsEqual:function(e,t){return e.email===t.email},_updateDraftFromMessage:function(e,t,i){var s,r,o,l,d=this.getPlugin(),u=e.subject,c=this._getSenderFromMessage(e);a.default.Assert(i!==n.a.EmailResponseMode.Other,"Should never pass Other mode to _updateDraftFromMessage"),i===n.a.EmailResponseMode.Reply?s=this._getReplyToFromMessage(e):i===n.a.EmailResponseMode.ReplyAll?(s=this._removeSelf(this._getReplyToFromMessage(e).concat(e.to)),r=this._removeSelf(e.cc)):i===n.a.EmailResponseMode.Forward&&(l=e.resources.clone()),i&&(o=d.createMessageBody(e,t.from.email,i)),s=a.default.arrayUniques(s||[],this.areContactsEqual),r=a.default.arrayUniques(r||[],this.areContactsEqual),i===n.a.EmailResponseMode.Reply||i===n.a.EmailResponseMode.ReplyAll?(0!==u.toLowerCase().indexOf("re")&&(u="Re: "+u),l=t.resources):i===n.a.EmailResponseMode.Forward&&0!==u.toLowerCase().indexOf("fwd")&&(u="Fwd: "+u);var f={to:s,from:c,cc:r,bcc:void 0,subject:u,body:o,resources:l||new h.a};this.getPlugin().updateDraft(this.threadAttach,t.id,t.draftID,f,o,!0,!1,function(e){a.default.Assert(e,"Should always be able to update a draft")})},requestAttachment:function(e,t,i,a){this.getPlugin().loadResource(e,t,i,a)},getAttachmentURL:function(e,t,i){return this.getPlugin().getAttachmentURL(e,t,i)},getPreviewURL:function(e){return this.getPlugin().getPreviewURL(e)},reportMessage:function(e,t,i,a,n){this.getPlugin().reportMessage(e,t,i,a,n)},dumpMessage:function(e,t,i){a.default.Assert(!1,"Should not be dumping message in non-DEBUG modes"),this.getPlugin().dumpMessage(e,t,i)},parseMailtoURL:function(e){var t={to:void 0,subject:void 0,body:void 0},i=e.split("?");if(t.to=i[0],i[1])for(var a=0,n=i[1].split("&"),s=0;s<n.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var r=n[s].split("=");switch(r[0].toUpperCase()){case"SUBJECT":t.subject=r[1];break;case"BODY":t.body=r[1]}}return t},parseListUnsubscribe:function(e){for(var t=0,i={emailData:void 0,url:void 0},n=e.split(","),s=0;s<n.length;++s){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var r=/^<?(http|https|mailto):([^<>]*)>?/gi.exec(n[s]);if(r)switch(r[1]){case"http":case"https":i.url=r[1]+":"+r[2];break;case"mailto":i.emailData=this.parseMailtoURL(r[2]);break;default:a.default.Assert(!1,"Unknown List Unsubscribe Format: "+e)}}return i},setMessageResponseMode:function(e,t){var i=this.messages.get()[this.messages.indexOfWithProperty("id",e)];if(a.default.Assert(i,"Must be able to find a valid reply message to update response mode for"),i){if(t!==n.a.EmailResponseMode.None){a.default.Assert(i.initializedForDisplay,"Must be initialized for display to set response mode");var s=this.getPlugin().getDraftForMessage(this.threadAttach.getField("accountID"),this.threadAttach.id,e,this._getSenderFromMessage(i));this._updateDraftFromMessage(i,s,t)}i.responseMode&&i.responseMode.set(t),t!==n.a.EmailResponseMode.None&&a.default.menus.openModalNew(Modals.EmailReply,{threadAttach:this.getThreadAttach(),message:s,inReplyToMessage:i,responseMode:t})}},setLastMessageResponseMode:function(e){if(e){var t=this.messages.get()[this.messages.length()-1];a.default.Assert(t,"Setting message response mode when there are no messages"),t&&this.setMessageResponseMode(t.id,e)}},_createErrorHTML:function(){return c.a.update('<html><body>There was an error loading your mail message.<br><br><a href="moodoAction:reloadMessage">Retry</a></body></html>',{},{},"text/html")},_createMessageHTML:function(e,t,i,a){var n={collapseQuotes:!0,replaceLinks:!0,createLinksFromText:!0};if(a)for(var s in a)a.hasOwnProperty(s)&&(n[s]=a[s]);return c.a.update(e,t,n,i)},_generateCSS:function(){if(!this._cachedCSS){var e={html:{"transform-origin":"0 0"},body:{"overflow-x":"auto","overflow-y":"hidden","font-family":"'Helvetica Neue', Helvetica, Arial, Sans-serif","font-size":"14px","text-rendering":"optimizeLegibility","-moz-font-smoothing":"antialiased","-webkit-font-smoothing":"antialiased","font-smoothing":"antialiased",margin:0},"#moodoAttach":{display:"none"},'[moodoAttach="true"]':{display:"none"},'[quote="collapsed"]':{display:"none"},'[place="true"]':{cursor:"pointer",display:"inline-block",height:"12px",width:"26px","text-align":"center","margin-top":"8px","margin-bottom":"8px",color:"#aaa",border:"1px solid #ddd","background-color":"#f6f6f6","border-radius":"3px"},'[place="true"]:before':{content:'"..."',"line-height":"5px","font-size":"16px","vertical-align":"text-top"}};o.a.isDark()&&(e.body["-webkit-filter"]="invert(100%) hue-rotate(180deg)",e.img={"-webkit-filter":"invert(100%) hue-rotate(180deg)"});var t="";for(var i in e){for(var a in t+=i+"{",e[i]){t+=a+":"+e[i][a]+";"}t+="}"}this._cachedCSS="<style>"+t+"</style>"}return this._cachedCSS},_createFrameBlob:function(e,t,i){var a={isApp:r.a.app,isAndroid:r.a.android},n=this._generateCSS(),s="<script>("+v.toString()+')("'+i+'",'+JSON.stringify(a)+");<\/script>",o="<!DOCTYPE html>";t='<meta http-equiv="Content-Type" content="'+t+'">';return r.a.supportBlobURLIFrame?new Blob([o,"<html>","<head>",t,n,s,"</head>",e,"</html>"],{type:"text/html"}):[o,"<html>","<head>",t,n,s,"</head>",e,"</html>"].join("")},onMessageLoaded:function(e){this.updateMessageHeight(e),this.messagesLoaded.set(!0)},getPreviewIFrame:function(e){return document.getElementById("emailPreview_"+e)},updateMessageHeight:function(e,t,i){var n=this.getPreviewIFrame(e);if(n){var s=this.messages.get()[this.messages.indexOfWithProperty("id",e)];t&&(n.style.height="0px");try{var r=n.contentDocument.documentElement;if(r){var o=i||s.defaultScale.get(),l=Math.ceil(r.scrollWidth*o),d=Math.ceil(r.scrollHeight*o);t&&d===s.height.get()&&(n.style.height=d+"px"),s.width.set(l),s.height.set(d),i&&s.defaultScale.get()!==i&&s.defaultScale.set(i)}}catch(e){a.default.reportError(e)}}},_generateAltParts:function(e,t){var i=this.getPlugin().getMessageAttachments(t);if(i)for(var n=0,s=0;s<i.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var r=i[s];"application/ics"===r.mimeType&&this.getPlugin().loadResource(e.id,t.id,r.cid,function(e){if(e){var t=g.a.parseICS(a.default.b64_to_utf8(e.data));log("Parsed ICS Data: ",t)}})}},_computeResponseMode:function(e){var t=n.a.EmailResponseMode.None;return e&&e.labelIds.indexOf("DRAFT")>=0&&(t=e.subject.startsWith("Fwd:")?n.a.EmailResponseMode.Forward:e.subject.startsWith("Re:")?1===e.to.length?n.a.EmailResponseMode.Reply:n.a.EmailResponseMode.ReplyAll:n.a.EmailResponseMode.Other),t},_createMessageDisplay:function(e,t,i){a.default.Assert(!e.initializedForDisplay,"Should only initialize message for display once"),a.default.Assert(e.to,"Must have a valid to object"),a.default.Assert(e.from,"Mus have a valid from object");var n,s=!0;if(e.decoded?(e.isErrorMessage=!1,(n=this._createMessageHTML(e.decoded,e.resources,e.mimeType,i)).missingResourceData&&(s=!1)):(a.default.reportError(!1,"Missing message decoded data: "+a.default.isString(e.decoded)),e.isErrorMessage=!0,n=this._createErrorHTML()),e.listUnsubscribe){var o=this.parseListUnsubscribe(e.listUnsubscribe);log("Unsub Data: ",o)}return a.default.Assert(n.parsed,"Must have valid parsed data"),e.blob=this._createFrameBlob(n.parsed,e.contentType,e.id),a.default.isString(e.blob)||(e.blobURL&&(r.a.URL.revokeObjectURL(e.blobURL),e.blobURL=void 0),e.blobURL=r.a.URL.createObjectURL(e.blob)),e.specialLinks=n.specialLinks,e.width||(e.width=new l.a(0)),e.height||(e.height=new l.a(0)),e.defaultScale||(e.defaultScale=new l.a(1)),e.responseMode||(e.responseMode=new l.a(this._computeResponseMode(t))),e.initializedForDisplay=!0,s},_destroyMessageDisplay:function(e){a.default.Assert(e.initializedForDisplay,"Message must first be initialized before being destroyed"),e.initializedForDisplay=!1,e.isErrorMessage=!1,e.width=void 0,e.height=void 0,e.defaultScale=void 0,e.responseMode&&(e.responseMode=void 0),e.specialLinks=void 0,e.blob=void 0,e.blobURL&&(r.a.URL.revokeObjectURL(e.blobURL),e.blobURL=void 0)},ensureDisplayMessages:function(e){if(e===this.threadAttach)try{for(var t=0,i=e.getField("messages"),n=[],s=0;s<i.length;++s){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var r=i[s];if(!e.getPlugin().isMessageDraft(r)&&!r.initializedForDisplay){try{this._generateAltParts(e,r)}catch(e){a.default.reportError(e)}(0===s?this._createMessageDisplay(r,i[s+1],{collapseQuotes:!1}):this._createMessageDisplay(r,i[s+1]))||this.getPlugin().reportMessage(e.getField("accountID"),e.id,r.id,"Error creating display",!1)}n.push(r)}n.equals(this.messages.get())||this.messages.set(n)}catch(e){a.default.reportError(e)}},_requestMessageReload:function(e,t,i){t.getPlugin().forceReloadMessage(t,i,function(n){if(a.default.Assert(n,"Must be able to re-load message data"),t===this.threadAttach){var s=t.getField("messages"),o=s[s.indexOfWithProperty("id",i)];if(o){var l=this.getPreviewIFrame(e);if(l)if(o.initializedForDisplay=!1,this.ensureDisplayMessages(t),r.a.supportBlobURLIFrame)l.src=o.blobURL;else{var d=l.contentWindow.document;d.documentElement.innerHTML="",d.open(),d.write(o.blob),d.close()}}}}.bind(this))},onAttachmentUpdate:function(e,t,i){(!t||t.indexOf("messages")>=0)&&e.getPlugin().loadThread(e,function(t,i){a.default.Assert(t,"Must be able to re-load thread data"),i&&e===this.threadAttach&&this.ensureDisplayMessages(e)}.bind(this))},getThreadAttach:function(){return this.threadAttach},_setThread:function(e,t){a.default.Assert(e.hasField("messages"),"Must supply valid messages to the email preview"),a.default.Assert(this.errorMessage.get()||e.getField("dataLoaded"),"Must have loaded remote data or have an error"),this.threadAttach&&this.threadAttach.id===e.id||(this.reset(),this.threadAttach=e,this.threadItem=t,e.subscribe(this),this.ensureDisplayMessages(e),e.getPlugin().attachmentHasLabelByID(e,"UNREAD")&&e.getPlugin().performAction(n.a.PluginAction.Gmail.MarkRead,!0,e),u.a.fireEvent("EmailPreview","openThreadChanged",[]))},onSelectedIndexChanged:function(e,t,i){},onDisplaySettingsChanged:function(){this._cachedCSS=void 0,this.threadAttach&&this.ensureDisplayMessages(this.threadAttach)}},t.a=new m},function(e,t,i){"use strict";var a=i(0),n=i(5),s=i(8);function r(e,t){this._super.constructor.call(this,e,t),this._value=e||[],this.version=0}var o={notify:function(e,t,i){0===arguments.length&&this.version++,this._super.notify.apply(this,arguments)},length:function(){return this._value.length},set:function(e,t){a.default.Assert(e&&a.default.isArray(e),"Value set on an Observable array must be an array",e),this._value=e,this.version++,!1!==t&&this.notify(this._value)},clear:function(e){this.set([],e)},remove:function(e,t){var i=[];if(a.default.isFunction(e))for(var n=0,s=0;s<this._value.length;s++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var r=this._value[s];e(r)&&(i.push(r),this._value.splice(s,1),s--)}else i=this._value.remove(e);return this.version++,!1!==t&&this.notify(this._value),i},removeAt:function(e,t){var i=this._value.removeAt(e);return this.version++,!1!==t&&this.notify(this._value),i},push:function(e,t){var i=this._value.push(e);return this.version++,!1!==t&&this.notify(this._value),i},insertSorted:function(e,t,i){var a=this._value.insertSorted(e,t);return this.version++,!1!==i&&this.notify(this._value),a},splice:function(e,t,i,a){var n;return n=i?this._value.splice(e,t,i):this._value.splice(e,t),this.version++,!1!==a&&this.notify(this._value),n},indexOf:function(e){return this._value.indexOf(e)},indexOfWithProperty:function(e,t){return this._value.indexOfWithProperty(e,t)}};n.a.inherit(s.a,r),n.a.extend(r.prototype,o),t.a=r},function(e,t,i){"use strict";i.r(t);var a=i(0),n=i(1),s=i(50),r=i(4),o=i(30),l=i(20),d=i(8),u=i(15),c=i(3);var h,f,p,g={" ":!0,"-":!0},m=(h={},f=n.a.AttachChar,p=!0,f in h?Object.defineProperty(h,f,{value:p,enumerable:!0,configurable:!0,writable:!0}):h[f]=p,h),v=function(){this.fontSize=l.a.fontSize(),this.needsFontUpdate=!1,this.isNote=!1,this.isBold=!1,this.needsFontUpdate=!0,this.canvasContext=void 0,this.canvasElement=void 0,this.measureTextItem=new d.a,this.measureTextPane=new d.a,this.registerWordCaches(["Normal","Bold","Note","Header","HeaderTopLevel"]),this._lineCache=s.a.registerLocalCache("LineCache","LineCache",StorageType.LocalStorage,{saveTime:-1,writeOnUnload:!0,clearBackingOnLoad:!0,isPerDoc:!0}),this._imageCache=s.a.registerLocalCache("ImageCache","ImageCache",StorageType.LocalStorage,{saveTime:-1,writeOnUnload:!0,clearBackingOnLoad:!0,isPerDoc:!0}),this._paneObjectCache={},this._paneObjectsForItem={},this._loadCaches(),l.a.listen("settingsChanged",this.onDisplaySettingsChanged.bind(this))},_={CallCount:{GetCaretOffset:0,GetClassStyles:0,measurePaneObject:0,MeasureLines:0,MeasureWord:0,GetOffsetForPositionInLine:0},Cache:{ItemCacheMiss:0,ItemCacheHit:0,LinesCacheMiss:0,LinesCacheHit:0,CanvasStyleHit:0,CanvasStyleMiss:0,WordCacheHit:0,WordCacheMiss:0}};var y=100;function S(e){return Math.round(e*y)/y}v.prototype={registerWordCaches:function(e){var t=0;this._wordCaches=[];for(var i=0;i<e.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=e[i],n=s.a.registerLocalCache("WordCache"+a,"WordCache"+a,StorageType.LocalStorage,{isPerDoc:!0});this._wordCaches.push(n),this["_wordCache"+a]=n}},updateFont:function(e){this.needsFontUpdate||this.fontSize!==e.fontSize||e.isBold!==this.isBold||e.isNote!==this.isNote||e.isPrefixHeader!==this.isPrefixHeader||e.isHeaderTopLevel!==this.isHeaderTopLevel?(this.fontSize=e.fontSize,this.isBold=!!e.isBold,this.isNote=!!e.isNote,this.isPrefixHeader=e.isPrefixHeader,this.isHeaderTopLevel=e.isHeaderTopLevel,this.canvasFont=(this.isBold?"bold ":"")+this.fontSize+"px Helvetica Neue, Helvetica, Arial, Sans-serif",_.Cache.CanvasStyleMiss++,this.canvasContext&&(this.canvasContext.font=this.canvasFont),this.needsFontUpdate=!1):_.Cache.CanvasStyleHit++},getCanvasElement:function(){return this.canvasElement||(this.canvasElement=document.createElement("canvas")),this.canvasElement},getCanvasContext:function(e){return this.canvasContext||(this.canvasContext=this.getCanvasElement().getContext("2d")),this.updateFont(e),this.canvasContext},getMeasureStats:function(){return _},_getLineOffset:function(e,t,i){var n=e.childNodes,s=0;if(n)for(var r=0,o=0;o<n.length;o++){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;var l=n[o];if(l===t){s+=i;break}if(a.default.hasClass(l,"plugin")?s+=1:l.nodeType===Node.TEXT_NODE?l.nodeValue!==TextSpace&&(s+=l.length):l.childNodes.length>0&&(s+=this._getLineOffset(l,t,i)),t&&a.default.isAncestor(t,l))break}return s},_getCaretPosition:function(e,t,i,s,o){var l=a.default.element("measureTextItem"),d=l.querySelector(".line");if(d){var c=d.getBoundingClientRect(),h=l.getBoundingClientRect(),f={left:c.left,top:h.top},p=i.isNote()?a.default.unescape(i.getNotePreviewText()):i.getParsedText(),g=0,m=i.hasPrefix()&&s.isViewProject()&&s.isItemTopLevel(t,i),v=void 0,_=void 0,y=void 0,S=void 0;e>p.length&&(e=p.length);var w=u.default._getSelectionRange();u.default.selectElement(l,e);var I,b=u.default._getSelectionRange();if(b){_=a.default.findParent(b.startContainer,"line");var A=a.default.findParent(b.startContainer,"itemPrefix",2);if(_){var D=0;y=[].indexOf.call(_.parentNode.children,_),S=this._getLineOffset(_,b.startContainer,b.startOffset);var T=0,M=b.startContainer.parentElement,C=M.previousElementSibling;if(C&&!o&&"IMG"===C.nodeName)T=-C.getBoundingClientRect().width;else if(!o&&a.default.hasClass(M,"mdImageMarkup")){var L=M.nextElementSibling;b.startOffset>0&&b.endOffset>0&&"IMG"===L.nodeName&&(T=L.getBoundingClientRect().width+10+(i.hasPrefix()?n.a.PrefixWidth:0))}a.default.showMarkdown()||a.default.hasClass(M,"mdMarkup")&&(b=this.adjustSelectionForMarkup(b)),a.default.hasClass(b.startContainer,"plugin")?(I=b.startContainer.getBoundingClientRect(),v={left:b.startOffset>0?I.right+12:I.left,top:I.top}):A&&e===i.getPrefixLength()?(I=A.getBoundingClientRect(),v={left:f.left+n.a.PrefixWidth+(r.a.isFirefox?0:5),top:I.top}):o&&S===this._getLineOffset(_)&&_.nextSibling?(v={left:(I=(_=_.nextSibling).getBoundingClientRect()).left+5+(i.hasPrefix()?n.a.PrefixWidth:0),top:I.top},S=0,y++):(I=b.getBoundingClientRect())&&(I.left===I.right&&0===I.left&&(I=b.getClientRects()[0]||_.getBoundingClientRect()),v={left:I.left,top:I.top}),r.a.isFirefox||(v.left=Math.max(v.left-5,0));for(var P=_.parentNode.childNodes,E=0;E<y;E++){if(D++>5e3&&__infLoop&&__infLoop(D))throw new RangeError;g+=this._getLineOffset(P[E])}return w&&!a.default.findParent(w.startContainer,"fancyInput")&&u.default.setSelectionRange(w),{left:v.left-f.left-(m?n.a.PrefixWidth:0)+T,top:v.top-f.top,line:y,lineOffset:S,lineLength:this._getLineOffset(_),lineStart:g}}}}return a.default.Assert(!1,"Failed to compute caret position: ",e,i.getParsedText().length,a.default.getElementPath(l)),{left:0,top:0,line:0,lineOffset:0,lineLength:0,lineStart:0}},_measureCaretPosition:function(e,t,i,n){for(var s=0,r=a.default.element("measureText"),o=a.default.element("measureTextItem"),d=e.item,u=i.getStyledLinesForPaneObject(e,!1,!0),c="",h=0;h<u.length;h++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var f=u[h],p=(0===h?"margin-top:"+l.a.paddingForItemTop(e,d,i)+"px;":"")+(f.isImage||h===u.length-1?"margin-bottom:"+l.a.paddingForItemBottom(e,d,i)+"px;":"");if(f.isImage)c+='<span class="line" style="'+(p+=f.maxWidth?"max-width: "+f.maxWidth+"px;":"")+'">'+f.previousText+'<span class="mdImageMarkup">'+f.originalText+"</span>"+(f.isDriveImage||!a.default.showMarkdown()?'<img class="inlineImage" src="'+f.src+'"></img>':"")+"<span>"+f.nextText+"</span></span>";else c+='<span class="line" style="'+(p+="font-size:"+l.a.fontSizeForItem(e,d,i)+"px;line-height:"+l.a.lineHeightForItem(e,d,i)+"px")+'">'+(u[h]||TextSpace)+"</span>"}return r.className="pane "+i.paneClass,o.className="item "+d.styleProps(e,i),o.innerHTML=c,this._getCaretPosition(t,e,d,i,n)},getCaretOffset:function(e,t,i,a){var n=e.item;if(_.CallCount.GetCaretOffset++,isNaN(i)&&(i=n.getParsedText().length),void 0===a){var s=t.caretPosition.get();if(s&&c.a.getStartOffset()===c.a.getEndOffset()&&c.a.getStartIndex()===c.a.getEndIndex())a=s.left-t.getPaddingForPaneObject(e)<30;else{var r=c.a.isArrowSelectInverted(),o=r?c.a.getStartOffset():c.a.getEndOffset(),l=r?c.a.getStartObject():c.a.getEndObject(),d=this._measureCaretPosition(l,o,t,!0),u=this._measureCaretPosition(l,o,t,!1);d.left!==u.left&&(a=!r)}}return this._measureCaretPosition(e,i,t,a)},getCaretScreenPosition:function(e,t,i){a.default.Assert(t>=0,"Must provide a valid index");var n=e.itemAtIndex(t),s=e.objectAtIndex(t);if(a.default.Assert(n,"Must be able to find a valid item at index"),e.isIndexMounted(t)){var r=e.elementAtIndex(t);a.default.Assert(r,"Must be able to get element for item at index");var o=e.getPaddingForPaneObject(s),l=this.getCaretOffset(s,e,i),d={left:-1,top:-1};if(r){var u=r.getBoundingClientRect();d.left=l.left+u.left+o,d.top=l.top+u.top}return d}return{left:-1,top:-1}},_getClassStyles:function(e,t,i,n){_.CallCount.GetClassStyles++,a.default.Assert(a.default.isVMLI(t),"Item must be a valid VMLI instance");var s=t.isNote(),r=t.isPrefixHeader(),o=t.isPrefixHeader()&&i.isItemTopLevel(e,t);return{isBold:r||n.hasClass("mdBold")||o&&i.isViewProject()||t.isHeader()&&l.a.boldHeaders()||n.hasClass("contact")||n.hasClass("date")||n.hasClass("duration")||n.hasClass("tag"),fontSize:t.isNote()?l.a.noteFontSize():o&&l.a.fontSizeHeaderTopLevel()||r&&l.a.fontSizeHeader()||l.a.fontSize(),isPrefixHeader:r,isHeaderTopLevel:o,isNote:s,attrs:n.getAttrs()}},measureLines:function(e,t,i,s,r){var o=0;a.default.Assert(a.default.isVMLI(t),"Must provide a valid item to measure lines for"),a.default.Assert(a.default.isPane(i),"Must provide a valid pane to measure lines for"),a.default.Assert(s>=0,"Max width must be greater than 0: ",s),_.CallCount.MeasureLines++;var l=this.getItemDisplayText(t),d=!t.isDestroyed()&&t.requireStoredEls();if(r=r||!d,a.default.Assert(t&&(t.els||!d),"A Item has no els: ",t.__TEMP_InitCalled,t.__TEMP_InitParseCalled,t.__TEMP_ParseCalled,t.__TEMP_SkippedInitParsed,t.isArchived(),a.default.vmMain.hasDisplayedArchivedItems()),0===l.length||!t||!t.els&&d)return t&&a.default.vmMain.runSingleParse(t,ChangeType.Auto),[{text:"",start:0,length:0,width:0}];if(!r){var u=this.getLinesFromCache(t,i,s);if(u){for(var c=0,h=l.length,f=0,p=0;p<u.length;p++){if(c++>5e3&&__infLoop&&__infLoop(c))throw new RangeError;f+=u[p].length}if(h===f)return _.Cache.LinesCacheHit++,u}else _.Cache.LinesCacheMiss++}var v=[],y=t.els,w=0,I="",b=0,A=[],D=0;if(y&&d)for(var T=0,M=0;M<y.length;++M){var C=0;if(T++>5e3&&__infLoop&&__infLoop(T))throw new RangeError;var L=y[M],P=this._getClassStyles(e,t,i,L),E=L.getParsedText(),k=L.getWidth(r),x=!!(P&&P.attrs&&P.attrs.attachSimple),R=void 0;if(L.hasClass("plugin_drive_image_inline")&&(k=s,x=!0,R=!0),void 0===k){var O=E.length;a.default.Assert(!P.plugin||E===n.a.AttachChar,"Plugin should only be set for attachment element");for(var F=0;F<O;++F){if(C++>5e3&&__infLoop&&__infLoop(C))throw new RangeError;var N=E[F];if(!g[N]||w===D||0===F&&M>0&&void 0!==y[M-1].getWidth(r)){var B=0;I+=N;for(var U="",V=w+1;V<l.length;++V){if(B++>5e3&&__infLoop&&__infLoop(B))throw new RangeError;var H=l[V];if(!g[H])break;U+=H}var q=U||m[N]||E[F+1]===n.a.AttachChar;if(q&&x&&F+U.length<O)I+=U;else if(q){var z=this.measureWord(i,I,P,r),W=this.measureWord(i,U,P,r);A.push({text:I,delim:U,styles:P,width:z,delimWidth:Math.min(W,s),isAttach:N===n.a.AttachChar,isImage:x,isDriveImage:R}),I=""}}w++}if(I.length>0){var G=this.measureWord(i,I,P,r);A.push({text:I,delim:"",styles:P,width:G,delimWidth:0,isImage:x,isDriveImage:R}),I=""}}else A.push({isPrefix:0===M,text:E,width:M>0||i.shouldRenderPrefix(e)?k:0,styles:P,delimWidth:0,delim:"",isImage:x,isDriveImage:R}),D+=E.length,w+=E.length}else{a.default.Assert(t&&!d,"Items that do not have els must be marked as not requiring them to be cached"),t.els||a.default.vmMain.runSingleParse(t,ChangeType.Auto),a.default.Assert(t.els&&1===t.els.length,"Should always have a single el for non-measure cached items");var j=this._getClassStyles(e,t,i,t.els[0]);j&&j.attrs?A.push({text:n.a.AttachChar,delim:"",styles:j,width:a.default.vmMain.pluginManager.measureAttachment(i,j),delimWidth:0}):(I=t.els[0].getParsedText(),A.push({text:I,delim:"",styles:j,width:this.measureWord(i,I,j,r),delimWidth:0}))}var K=0,Y="",X=0,Q=0;w=0;for(var J=0;J<A.length;++J){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;if((I=A[J]).isPrefix&&(X=I.width),I.isImage&&1===J&&X){var Z=this.getAttachSimpleLine(I,w,A[0]);if(Z){v.push(Z),w+=Z.length,Y="",b=J+1,X=0;continue}}if(J>b&&(I.isImage||K+I.width>s&&!(X&&1===Q&&I.width>0))&&(v.push({text:Y,start:w,length:Y.length,width:S(K)}),w+=Y.length,K=0,Y="",b=J,X=0),I.isImage){var $=this.getAttachSimpleLine(I,w);if($){v.push($),w+=$.length,Y="",b=J+1,X=0;continue}}if(!I.isPrefix&&I.width+I.delimWidth>s&&!I.isAttach){var ee=0,te=0,ie=0;K=0;for(var ae=0;ae<I.text.length;++ae){if(ee++>5e3&&__infLoop&&__infLoop(ee))throw new RangeError;K=ie,(ie+=this.measureChar(I.text[ae],I.styles))>s&&ae>0&&ae-1>te&&(Y+=I.text.substring(te,ae),v.push({text:Y,start:w,length:Y.length,width:S(K)}),w+=Y.length,te=ae,K=0,X=0,Y="",ae--,ie=0)}if(te>=0){var ne=I.text.substring(te,I.text.length);ne.length>0&&(I.text=I.text.substr(0,te),Y=ne+I.delim,K=this.measureWord(i,ne,I.styles,!0),b=J)}}else I.isPrefix||(K+=I.width+I.delimWidth),Y+=I.text+I.delim;J===A.length-1&&(v.push({text:Y,start:w,length:Y.length,width:S(K)}),X=0),I.width>0&&Q++}return r||this.saveLinesToCache(t,i,s,v),v},getPaneObjectFromCache:function(e,t){var i,s=e.item,r=e.id,o=this._paneObjectCache[r],l=t,d=this.getItemDisplayText(s);if(o&&o[l]&&o[l].isHeader===s.isHeader()&&d===o.text&&o[l].isNote===s.isNote()&&d.indexOf(n.a.AttachChar)<0){var u=o[l];u.els?(_.Cache.ItemCacheHit++,i=u):a.default.Assert(!1,"Getting item from cache with no els")}return i||_.Cache.ItemCacheMiss++,i},savePaneObjectToCache:function(e,t){a.default.Assert(t,"Must save a valid measured item to cache"),a.default.Assert(t.els,"Measured item must have els"),a.default.Assert(t.maxWidth,"Measured item must have a valid max width");var i=e.item,n=this.getItemDisplayText(i),s=e.id,r=this._paneObjectCache[s];if(r&&r.text===n){var o,l=0,d=Number.MAX_VALUE;for(var u in r)if(r.hasOwnProperty(u)){l++;var c=r[u].lastAccess;c<d&&(d=c,o=u)}l>=5&&delete r[o]}else r=this._paneObjectCache[s]={text:n},this._paneObjectsForItem[i.id]||(this._paneObjectsForItem[i.id]=[]),this._paneObjectsForItem[i.id].push(s);r[t.maxWidth]=t},getLinesFromCache:function(e,t,i){if(t.useLineCache){var n=this._lineCache.getEntrySync(e.id),s=void 0,r=void 0;if(n)for(var o=0,l=0;l<n.length;l++){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;if(s=n[l][i])break}if(s){var d=this.getItemDisplayText(e);if(a.default.isNumber(s))r=[{start:0,length:d.length,text:d}];else{var u=0;r=new Array(s.length);for(var c=0,h=0;h<s.length;h++){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;var f=s[h];a.default.Assert(!a.default.isNumber(f),"Cached lines should always be line info rather than a number"),r[h]={start:c,length:f.length,text:d.substr(c,f.length)},f.size&&(r[h].size=f.size),c+=f.length}}}return r}},saveLinesToCache:function(e,t,i,a){if(t.useLineCache){var n,s=0;if(a.length>1||a[0].size){var r=0;n=a;for(var o=0;o<n.length;o++){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;delete n[o].imageUrl,delete n[o].originalText}}else n=1;var l=this._lineCache.getEntrySync(e.id)||[];l.length>=5&&l.pop();for(var d=0;d<l.length;d++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;l[d][i]&&(l.splice(d,1),d--)}var u={};u[i]=n,l.splice(0,0,u),this._lineCache.cacheEntry(e.id,l)}},measurePaneObject:function(e,t,i){_.CallCount.measurePaneObject++;var n,s=e.item,r=t.maxWidthOfPaneObject(e),d=this.getItemDisplayText(s),u=s.isHeader(),c=s.isNote();if(a.default.Assert(a.default.isNumber(r),"Must provide a valid number for maxWidth: ",r),a.default.Assert(r>=0,"Max width must be greater than 0: ",r),0===d.length||r<a.default.MinItemWidth){return{height:this.lineItemHeight(e,s,t,1),maxWidth:r,lineLengths:[0],styledLines:[TextSpace],els:[{text:"",start:0,length:0,width:0,cls:"line",index:0}],isHeader:u,isNote:c}}if(!(n=!i&&this.getPaneObjectFromCache(e,r))||t.search.shouldHighlightSearch()){for(var h=0,f=this.measureLines(e,s,t,r,i),p=[],g=[],m=0,v=f.length,y=0;y<f.length;++y){if(h++>5e3&&__infLoop&&__infLoop(h))throw new RangeError;var S=f[y];if(S.size&&!isNaN(S.size.height)){var w=Math.min(S.size.width,r);m+=S.size.height*w/S.size.width+(y>0?l.a.paddingForItemTop(e,s,t):0)+(y<f.length-1?l.a.paddingForItemBottom(e,s,t):0),v--}p.push(S.length),g.push({text:S.text,start:S.start,length:S.length,width:S.width,cls:"line",index:y})}if(a.default.Assert(s&&(s.els||!s.requireStoredEls()),"B Item has no els: ",s.__TEMP_InitCalled,s.__TEMP_InitParseCalled,s.__TEMP_ParseCalled,s.__TEMP_SkippedInitParsed,s.isArchived(),a.default.vmMain.hasDisplayedArchivedItems()),!s.els&&s.requireStoredEls()){return{height:this.lineItemHeight(e,s,t,1),maxWidth:r,lineLengths:[],styledLines:[],els:[{text:"",start:0,length:0,width:0,cls:"line",index:0}],isHeader:u,isNote:c}}var I=o.a.generateStyledLines(s.els,f,t);n={height:this.lineItemHeight(e,s,t,v)+m,maxWidth:r,lineLengths:p,styledLines:I,els:g,isHeader:u,isNote:c,lastAccess:Date.now()},t.search.shouldHighlightSearch()&&(n.searchHighlightedLines=o.a.generateStyledLines(s.els,f,t,!0)),i||this.savePaneObjectToCache(e,n)}return n},measureWord:function(e,t,i,s){if(_.CallCount.MeasureWord++,a.default.Assert(void 0!==t,"Must pass in a valid word"),a.default.Assert(i,"Must supply valid styles for word"),a.default.Assert(t.indexOf(n.a.AttachChar)<0||1===t.length,"AttachChar should not be processed with other chars"),t.length>0){if(t===n.a.AttachChar&&i&&i.attrs)return a.default.Assert(!i.attrs||i.attrs.plugin,"Must have a valid plugin: ",i.attrs&&i.attrs.plugin),a.default.Assert(!i.attrs||i.attrs["plugin-id"],"Must have a valid attachment",i.attrs&&i.attrs["plugin-id"]),a.default.vmMain.pluginManager.measureAttachment(e,i);var r=this._selectCache(i),o=r.getEntrySync(t);if(o)return _.Cache.WordCacheHit++,o;for(var l=0,d=0,u=0;u<t.length;u++){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;d+=this.measureChar(t[u],i)}var c=S(d);return s||r.cacheEntry(t,c),c}return 0},measureChar:function(e,t){var i=this._selectCache(t),a=i.getEntrySync(e);if(a)return a;var n=this.getCanvasContext(t).measureText(e).width;return i.cacheEntry(e,n),n},getOffsetForScreenPositionInLine:function(e,t,i,s,r){var o,d=t.item;if(i.isIndexMounted(e)){var c=i.elementAtIndex(e).querySelectorAll(".line");if(c.length>s){var h=c[s],f=h.getBoundingClientRect(),p=u.default.getSelectOffsetsForMouseEvent({target:h,clientX:a.default.clamp(r,f.left,f.right-2),clientY:f.top+2+(d.shouldShowParents(t,i)?n.a.HeightAgendaParents:0)+(0===s?l.a.paddingForItemTop(t,d,i):0)});p&&(o=p.start)}}if(isNaN(o)){var g=0,m=this.measurePaneObject(t,i,!0).lineLengths;o=0;for(var v=0;v<m.length;v++){if(g++>5e3&&__infLoop&&__infLoop(g))throw new RangeError;o+=m[v]}}return o},clearCacheForItem:function(e){this._lineCache.removeEntry(e);var t=this._paneObjectsForItem[e];if(t){for(var i=0,a=0;a<t.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=t[a];this._paneObjectCache[n]&&delete this._paneObjectCache[n]}delete this._paneObjectsForItem[e]}},_loadCaches:function(){for(var e=0,t=0;t<this._wordCaches.length;t++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;this._wordCaches[t].loadAll()}this._lineCache.loadAll(),this._imageCache.loadAll()},clearWordCaches:function(){for(var e=0,t=0;t<this._wordCaches.length;t++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;this._wordCaches[t].clearCache()}},clearItemCache:function(){this._paneObjectCache={},this._paneObjectsForItem={}},clearLineCache:function(){this._lineCache.clearCache()},_selectCache:function(e){var t;return e.isHeaderTopLevel?t=this._wordCacheHeaderTopLevel:e.isPrefixHeader?t=this._wordCacheHeader:e.isBold?(a.default.Assert(!e.isNote,"Currently do not support bold+note"),t=this._wordCacheBold):t=e.isNote?this._wordCacheNote:this._wordCacheNormal,t},lineItemHeight:function(e,t,i,n){return a.default.isNumber(n)&&!t.isNote()||(n=1),l.a.paddingForItemTop(e,t,i)+l.a.paddingForItemBottom(e,t,i)+l.a.lineHeightForItem(e,t,i)*n},getItemDisplayText:function(e){return e.getParsedText()},onDisplaySettingsChanged:function(e){this.needsFontUpdate=!0,e&&this.clearWordCaches(),this.clearItemCache(),this.clearLineCache()},measureImage:function(e){var t=!this._imageCache.getEntrySync(e.src);return this._imageCache.cacheEntry(e.src,{width:e.naturalWidth,height:e.naturalHeight}),t},getImageOriginalSize:function(e,t){var i=this._imageCache.getEntrySync(e)||t&&this._imageCache.getEntrySync(t);return{width:i.width,height:i.height}},getImageSize:function(e,t,i){var a,n=this._imageCache.getEntrySync(e)||t&&this._imageCache.getEntrySync(t);return n&&(a=i?{width:i=Math.min(i,n.width),height:n.height*(i/n.width)}:{width:n.width,height:n.height}),a},getAttachSimpleLine:function(e,t,i){var n,s,r,o=e.styles.attrs,l=(i?i.text+i.delim:"")+e.text+e.delim;if(o.plugin){var d=a.default.vmMain.pluginManager.getPlugin(o.plugin),u=d.getAttachment(o["plugin-id"]);n=d.getAttachUrl(u),s=d.getAttachDataUrl(u),r=d.getAttachWidth(u)}else n=o["data-href"],r=o.size;if(n){var c=this.getImageSize(n,s,r);return{text:l,start:t,length:l.length,size:c}}},adjustSelectionForMarkup:function(e){var t=!1,i=e.startContainer.parentElement,n=a.default.hasClass(i,"mdMarkupStart"),s=a.default.hasClass(i,"mdMarkupEnd","appLinkStart");if(n||s){var r=n?1:-1,o=this.findNextNonMarkup(i,r);if(o){var l=o.childNodes[0]||o;l&&(e.setStart(l,r<0?l.length:0),t=!0)}else if(r*=-1,o=this.findNextNonMarkup(i,r)){var d=o.childNodes[0];d&&(e.setStart(d,r<0?d.length:0),t=!0)}}return t?this.adjustSelectionForMarkup(e):e},findNextNonMarkup:function(e,t){for(var i=0;e&&a.default.hasClass(e,"mdMarkup","appLinkStart");){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;e=t>0?e.nextSibling:e.previousSibling}return e}},t.default=new v},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(5),r=i(24),o=(i(13),i(3)),l=i(7),d=function(){function e(e,t){for(var i=0,a=0;a<t.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();var u=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._batchTimeout=void 0,this.itemsBatchingUpdates={},s.a.forceBind("runUpdates",this),s.a.forceBind("_runUpdate",this)}return d(e,[{key:"beginBatch",value:function(e,t){a.default.isEmpty(this.itemsBatchingUpdates)&&(!l.a.undoRedoActive&&t?(this._savedSelectionDrive=o.a.save(),o.a.reset()):this._savedSelectionDrive=void 0,this._batchTimeout=setTimeout(this.runUpdates,500)),this.itemsBatchingUpdates[e.id]={item:e}}},{key:"commitBatch",value:function(e){var t=this.itemsBatchingUpdates[e.id];t&&(this._runUpdate(e,t),delete this.itemsBatchingUpdates[e.id])}},{key:"itemItemsChanged",value:function(e){this.updateItem(e,n.a.ItemProp.Items)}},{key:"itemTextChanged",value:function(e){this.updateItem(e,n.a.ItemProp.Text)}},{key:"itemDateChanged",value:function(e){this.updateItem(e,n.a.ItemProp.Date)}},{key:"itemTagsChanged",value:function(e,t){this.updateItem(e,n.a.ItemProp.Tags,t)}},{key:"itemFontChanged",value:function(e){this.updateItem(e,n.a.ItemProp.Font)}},{key:"itemSearchChanged",value:function(e){this.updateItem(e,n.a.ItemProp.Search)}},{key:"updateItem",value:function(e,t,i){if(i=i||!0,this.itemsBatchingUpdates[e.id]){var a=this.itemsBatchingUpdates[e.id];a||(a=this.itemsBatchingUpdates[e.id]={item:e}),a[t]=i,this._batchTimeout&&clearTimeout(this._batchTimeout),this._batchTimeout=setTimeout(this.runUpdates,500)}else this._runUpdate(e,function(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}({item:e},t,i))}},{key:"_runUpdate",value:function(e,t){r.default.clearCacheForItem(e.id),!e.isDestroyed()&&e.getItemStore()&&e.getItemStore().onItemChanged(e,t)}},{key:"runUpdates",value:function(){var e=this;clearTimeout(this._batchTimeout),a.default.batchRenderUpdates(function(){for(var t in a.default.vmMain.beginUpdateItems(),e.itemsBatchingUpdates)if(e.itemsBatchingUpdates.hasOwnProperty(t)){var i=e.itemsBatchingUpdates[t];e._runUpdate(i.item,i)}e.itemsBatchingUpdates={},a.default.vmMain.commitUpdateItems(),e._savedSelectionDrive&&o.a.restore(e._savedSelectionDrive)})}}]),e}();t.a=new u},function(e,t,i){"use strict";var a=i(0),n=i(5),s=i(4),r=i(1),o=i(8),l=i(7),d=(i(32),i(33)),u=i(15);function c(){this.stack=[]}c.prototype={push:function(e){this.stack.push(e)},pop:function(e){this.stack.remove(e)},peek:function(){return this.stack[this.stack.length-1]},contains:function(e){return this.stack.indexOf(e)>=0},forEach:function(e){for(var t=0,i=this.stack.length-1;i>=0;i--){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(!1===e(this.stack[i],i))break}}};var h=c,f=i(3),p=i(34),g={},m={Ctrl:0,Meta:1,Alt:2,Shift:3};function v(){var e,t=this;this.currentArrowsMode=void 0,this.platformPrimaryKey=s.a.mac?m.Meta:m.Ctrl,this.platformSecondaryKey=s.a.mac?m.Ctrl:m.Alt;var i=function(e,i){for(var n,s=0,r=0;r<i.length;r++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var o,l,d,u,c=i[r],h=!c.mods;if(h||(o=!!c.mods[m.Ctrl]==!!e.ctrlKey,l=!!c.mods[m.Meta]==!!e.metaKey,d=!!c.mods[m.Alt]==!!e.altKey,u=!!c.mods[m.Shift]==!!e.shiftKey),(h||o&&l&&d&&u)&&(c.isGlobal||e.target===document.body&&!a.default.menus.isContextMenuOpen()&&!a.default.menus.isModalOpen()||a.default.findParent(e.target,"paneContent"))){n=c;break}}if(n){t.currentArrowsMode&&!n.isOnPane&&(t._exitingArrowsMode=t.currentArrowsMode,t._exitArrowsMode());var f=n.callback.call(t,e);return a.default.sendEvent("Hotkey",n.name),n.stopPropagation&&e.stopPropagation(),t._exitingArrowsMode=void 0,!1===f||(e.handled=!0,e.preventDefault(),!1)}},r=function(n){if(a.default.vmSetup&&a.default.vmSetup.isLoggedIn()){var r;if(s.a.normalizeKeys(n),e=n.normCode,t.currentArrowsMode&&t._updateArrowsMode(n),t.hotkeyStack.forEach(function(e){if(e&&e[n.normCode]&&(r=i(n,[e[n.normCode]])),void 0!==r)return!1}),void 0===r){var o=g[n.normCode];o&&(r=i(n,o))}if(void 0!==r)return a.default.vmMain&&a.default.vmMain.updateCursorFromEvent(n),r;if(s.a.android&&n.target===document.body){if(function(e){return(s.a.mac&&e.metaKey||!s.a.mac&&e.ctrlKey)&&e.normCode===KeyCode.A}(n))return n.preventDefault(),!1;d.default.keydown(null,n)}}};this.hotkeyStack=new h,this.currentArrowsMode=void 0,this.arrowsModeHotkeys={},n.a.forceBind("onMouseDownArrowsMode",this),document.addEventListener("keydown",r,!0),document.addEventListener("keyup",function(t){a.default.vmSetup&&a.default.vmSetup.isLoggedIn()&&(s.a.normalizeKeys(t),a.default.vmMain&&a.default.vmMain.updateCursorFromEvent(t),s.a.windows&&e!==t.normCode&&(t.normCode!==KeyCode.D1&&t.normCode!==KeyCode.D2&&t.normCode!==KeyCode.D3&&t.normCode!==KeyCode.D8||g[t.normCode]&&(r(t),e=void 0)))},!0),this.loadConfig()}v.prototype={loadConfig:function(){for(var e in this.config={Pane:{Search:["Pr+F"],Goto:["Se+G"],Overview:["Se+O"],Complete:["Pr+Enter"],ZoomOut:["Se+Sh+Enter","Se+LeftArrow"],ZoomIn:["Se+Enter","Se+RightArrow"],EditNote:["Sh+Enter"],Collapse:["Pr+Period","mac:Se+Space"],CollapseRecursive:["Pr+Sh+Period","mac:Se+Sh+Space"],CollapseAll:["Pr+Se+Period","mac:Pr+Se+Sh+Space"],Unindent:["Sh+Tab","Pr+LBracket","Se+LBracket","Se+Sh+LeftArrow"],Indent:["Tab","Pr+RBracket","Se+RBracket","Se+Sh+RightArrow"],MoveUp:["Se+Sh+UpArrow","mac:Op+UpArrow"],MoveDown:["Se+Sh+DownArrow","mac:Op+DownArrow"],Priority1:["Pr+D1"],Priority2:["Pr+D2"],Priority3:["Pr+D3"],PriorityNone:["Pr+D0","Pr+D4"],Star:["Pr+D8","win:Pr+Tilde"],NextPane:["mac:app:Se+Tilde","mac:app:Pr+Op+RightArrow","win:Se+Tilde"],PreviousPane:["mac:app:Se+Sh+Tilde","mac:app:Pr+Op+LeftArrow","win:Se+Sh+Tilde"],SelectItem:["Se+L"],ClosePane:["Sh+F4"],Bold:["Pr+B"],Italic:["Pr+I"],Underline:["Pr+U"],InsertLink:["Pr+K"],MoveAutocomplete:["Se+M"],JumpAutocomplete:["Se+J"],PrefixHeader:["Pr+Sh+D6","Pr+Sh+P","Pr+Sh+H","win:Pr+Sh+D3"],PrefixTask:["mac:app:Pr+Sh+LBracket","win:Pr+Sh+LBracket","Se+Sh+LBracket","Pr+Sh+D9","Pr+Sh+D0"],PrefixBullet:["Pr+Sh+D8"],PrefixNumList:["Pr+Sh+D1"],AddToCalendar:["Se+C"],DeleteItem:["Pr+Sh+Backspace","Pr+Sh+K"]},Global:{SelectPane1:["app:Se+D1"],SelectPane2:["app:Se+D2"],SelectPane3:["app:Se+D3"],SelectPane4:["app:Se+D4"],SelectPane5:["app:Se+D5"],SelectPane6:["app:Se+D6"],SelectPane7:["app:Se+D7"],SelectPane8:["app:Se+D8"],SelectPane9:["app:Se+D9"],SelectPane10:["app:Se+D0"],Undo:["Pr+Z"],Redo:["Pr+Y","Pr+Sh+Z"],AddPane:["app:Pr+T","Se+T"],NewItem:["app:Pr+N","Se+N"],EmailCompose:["Pr+E"],NextBoard:["mac:app:Se+Tab","win:app:Pr+Tab"],PreviousBoard:["mac:app:Se+Sh+Tab","win:app:Pr+Sh+Tab"],SelectBoard1:["Se+Sh+D1"],SelectBoard2:["Se+Sh+D2"],SelectBoard3:["Se+Sh+D3"],SelectBoard4:["Se+Sh+D4"],SelectBoard5:["Se+Sh+D5"],SelectBoard6:["Se+Sh+D6"],SelectBoard7:["Se+Sh+D7"],SelectBoard8:["Se+Sh+D8"],SelectBoard9:["Se+Sh+D9"],SelectBoard10:["Se+Sh+D0"],HelpHotkeys:["Pr+Slash","Se+Slash"],Help:["Pr+Sh+Slash","Se+Sh+Slash"],Settings:["mac:app:Pr+Comma"],ZoomInApp:["app:Pr+Plus"],ZoomOutApp:["app:Pr+Dash"]},Email:{Down:["DownArrow","J"],Up:["UpArrow","K"],Open:["Enter"],Archive:["E","Slash"],Delete:["Delete","win:Backspace","Sh+D3"],Schedule:["C"],Snooze:["D"],Move:["M","V"],Task:["T"],Label:["L"],MarkRead:["I"],MarkUnread:["U"],Star:["S","D8"],Reply:["R"],ReplyAll:["Sh+R","A"],Forward:["F"],Priority1:["D1"],Priority2:["D2"],Priority3:["D3"],RemoveFromLabel:["Y"],Undo:["Z"],Print:["P"],OpenInGmail:["G"]}},this.config.Pane)this.config.Pane.hasOwnProperty(e)&&this.createHotkeyNew(e,this.config.Pane[e],!1);for(var t in this.config.Global)this.config.Global.hasOwnProperty(t)&&this.createHotkeyNew(t,this.config.Global[t],!0);for(var i in this.config.Email)this.config.Email.hasOwnProperty(i)&&this.createHotkeyNew(i,this.config.Email[i],!1,!0,"Email");this.createHotkeyNew("Noop",["Pr+S"],!0)},createHotkeyNew:function(e,t,i){var n=0,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:void 0,o=s?this.callbackOnPane.bind(this,r,e):this["hotkey"+e];a.default.Assert(o&&a.default.isFunction(o),"Missing hotkey handler",e);for(var l=0;l<t.length;l++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var d=t[l],u=d.split(":"),c=u[u.length-1].split("+"),h=KeyCode[c[c.length-1]];if(a.default.Assert(h,"Key code must be defined",d),this.isValidPlatform(d)){var f={name:l>0?e+l:e,isGlobal:i,keyCode:h,primary:c.indexOf("Pr")>=0,secondary:c.indexOf("Se")>=0,shift:c.indexOf("Sh")>=0,option:c.indexOf("Op")>=0,isOnPane:s,callback:o};this.addHotkeyNew(f)}}},isValidPlatform:function(e){var t=e.split(":");return 1===t.length||(t.indexOf("win")<0||!s.a.mac)&&(t.indexOf("mac")<0||s.a.mac)&&(t.indexOf("app")<0||s.a.isNativeApp())},pushStack:function(e){for(var t=0,i={},a=0;a<e.length;a++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[a];i[n.keyCode]=n}return this.hotkeyStack.push(i),i},pushStackEscape:function(e){return this.pushStack([this.createEscape(e)])},popStack:function(e){this.hotkeyStack.pop(e)},getHotkey:function(e){var t,i=g[e.normCode];if(i)for(var a=0,n=0;n<i.length;n++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s,r,o,l,d=i[n],u=!d.mods;if(u||(s=!!d.mods[m.Ctrl]==!!e.ctrlKey,r=!!d.mods[m.Meta]==!!e.metaKey,o=!!d.mods[m.Alt]==!!e.altKey,l=!!d.mods[m.Shift]==!!e.shiftKey),u||s&&r&&o&&l){t=d.name;break}}return t},create:function(e,t,i,n,o,l){a.default.Assert(a.default.isNumber(e),"Invalid keyCode"),a.default.Assert(a.default.isBoolean(t),"Invalid isGlobal"),a.default.Assert(a.default.isFunction(o),"Invalid callback");var d={keyCode:e,mods:{},callback:o,isGlobal:t};return i!==r.a.Primary.Yes&&i!==r.a.Primary.Both&&i!==r.a.Primary.Only||(d.mods[this.platformPrimaryKey]=!0),i!==r.a.Primary.No&&i!==r.a.Primary.Never&&i!==r.a.Primary.Both||(d.mods[this.platformSecondaryKey]=!0),l&&s.a.mac&&(d.mods[m.Alt]=!0),n===r.a.Shift.Yes&&(d.mods[m.Shift]=!0),d},addHotkeyNew:function(e){e.mods={},e.primary&&(e.mods[this.platformPrimaryKey]=!0),e.secondary&&(e.mods[this.platformSecondaryKey]=!0),e.option&&(e.mods[m.Alt]=!0),e.shift&&(e.mods[m.Shift]=!0);var t=e.keyCode;g[t]||(g[t]=[]),g[t].push(e)},createEscape:function(e){return this.create(KeyCode.Escape,!0,r.a.Primary.Either,r.a.Shift.Either,e)},addHotkey:function(e,t,i,n,o,l,d,u){a.default.Assert(i,"Must supply a valid keycode"),s.a.app&&!isNaN(n)&&n!==r.a.Primary.Both&&n!==r.a.Primary.Never&&n!==r.a.Primary.Only&&(n=r.a.Primary.Either),this._addHotkey(e,t,i,n,o,l,d,u)},_addHotkey:function(e,t,i,n,o,l,d,u){if(a.default.Assert(i,"Must supply a valid keycode"),!u||!s.a.windows){if(g[i]=g[i]||[],n===r.a.Primary.Either)return this._addHotkey(e,t,i,r.a.Primary.No,o,l,d,u),void this._addHotkey(e,t,i,r.a.Primary.Yes,o,l,d,u);if(o===r.a.Shift.Either)return this._addHotkey(e,t,i,n,r.a.Shift.No,l,d,u),void this._addHotkey(e,t,i,n,r.a.Shift.Yes,l,d,u);a.default.Assert(!s.a.windows||n!==r.a.Primary.Both,"Should never require AltGr combo on windows");var c=this.create(i,t,n,o,l,u);c.stopPropagation=d,c.name=e,g[i].push(c)}},registerArrowsMode:function(e,t,i,a,n,s){var r=this["arrowsModeIndex"+e]=new o.a(-1);return!0===t?this._enterArrowsMode(e,i,a,n):this._addHotkey(e,!0,t.keyCode,t.primary,t.shift,this._onKeyDownArrowsMode.bind(this,e,i,a,n,s)),r},getArrowsModeObs:function(e){return this["arrowsModeIndex"+e]},isInArrowsMode:function(e){return this.currentArrowsMode&&this.currentArrowsMode.name===e},exitArrowsMode:function(e){this.isInArrowsMode(e)&&this._exitArrowsMode()},_onKeyDownArrowsMode:function(e,t,i,a,n){this.currentArrowsMode?this._exitArrowsMode():this._exitingArrowsMode&&this._exitingArrowsMode.name===e||this._enterArrowsMode(e,t,i,a,n)},_enterArrowsMode:function(e,t,i,a,n){this.currentArrowsMode={name:e,cbGetMax:t,cbSelect:i,cbKey:a,cbOnHotkey:n},n&&n(),document.addEventListener("mousedown",this.onMouseDownArrowsMode,!0),this["arrowsModeIndex"+e].set(-1)},_exitArrowsMode:function(){this.currentArrowsMode&&(document.removeEventListener("mousedown",this.onMouseDownArrowsMode,!0),this.getArrowsModeObs(this.currentArrowsMode.name).set(-1),this.currentArrowsMode=void 0)},onMouseDownArrowsMode:function(e){this._exitArrowsMode()},_updateArrowsMode:function(e){var t=this.currentArrowsMode,i=this.getArrowsModeObs(t.name),a=s.a.getKeyCode(e),n=i.get(),r=t.cbGetMax();if(a===KeyCode.Enter)n>=0&&t.cbSelect(n),this._exitArrowsMode();else if(a===KeyCode.Escape)this._exitArrowsMode();else if(a===KeyCode.UpArrow)n>0&&i.set(n-1);else if(a===KeyCode.DownArrow)n<r-1&&i.set(n+1);else if(t.cbKey){var o=t.cbKey(a,e);o>=0&&(t.cbSelect(o),this._exitArrowsMode(),e.stopPropagation(),e.preventDefault())}},checkToggleSearchFilter:function(e){var t=a.default.focusedPane;return!(!t||!t.search.isFocused.get())&&(t.search.toggleFilterDefault(e),!0)},checkToggleSearchPriority:function(e){var t=a.default.focusedPane;return!(!t||!t.search.isFocused.get())&&(t.search.getFilterValue("priority")===e&&(e=0),t.search.setFilter("priority",e),!0)},hotkeyNewItem:function(){a.default.menus.openItemEditor({addOnSave:!0,element:a.default.element("newItemButton")})},hotkeyAddPane:function(){a.default.menus.openAddPaneMenu({element:a.default.element("addPaneButton")})},hotkeySearch:function(){var e=a.default.focusedPane||a.default.vmMain.paneManager.getPaneAtIndex(0);if(e){var t=e.search;t.isFocused.get()||t.focus()}},hotkeyGoto:function(){a.default.vmMain.applyToSelection(function(e){return a.default.scrollToAndHighlightItem(e,a.default.focusedPane),!1})},hotkeyOverview:function(){a.default.focusedPane&&a.default.focusedPane.toggleOverviewVisibility()},hotkeyComplete:function(){var e,t=f.a.getSelectedItems();f.a.isValid()&&1===t.length&&!t[0].isComplete()&&(e=!0),a.default.vmMain.beginCompleteAction(),a.default.vmMain.applyFnToSelection("isComplete",{toggle:!0,restoreSelection:!0,value2:ChangeType.Local}),e&&a.default.focusedPane.selectNearestItem(f.a.getStartIndex()),a.default.vmMain.endCompleteAction(),a.default.sendEvent("Hotkey","Complete")},_hotkeyPriorityHelper:function(e){a.default.focusedPane&&!this.checkToggleSearchPriority(e)&&a.default.focusedPane.applyPriorityToSelection(e,!0)},hotkeyPriority1:function(){this._hotkeyPriorityHelper(VMLIFlag.P0)},hotkeyPriority2:function(){this._hotkeyPriorityHelper(VMLIFlag.P1)},hotkeyPriority3:function(){this._hotkeyPriorityHelper(VMLIFlag.P2)},hotkeyPriorityNone:function(){a.default.focusedPane.applyPriorityToSelection(VMLIFlag.None)},hotkeyStar:function(){this.checkToggleSearchFilter("starred")||a.default.vmMain.applyFnToSelection("isStarred",{toggle:!0,restoreSelection:!0,value2:ChangeType.Local})},selectPaneAtIndex:function(e){if(e>=0&&e<a.default.vmMain.paneManager.paneCount()){var t=a.default.vmMain.paneManager.getPaneAtIndex(e);if(t&&(f.a.focusPane(t),!f.a.isValid()&&t.isEditable)){var i=t.indexOfFirstItem();t.selectIndex(i),t.scrollIndexIntoView(i,ScrollDuration.Default)}}},hotkeySelectPane1:function(){this.selectPaneAtIndex(0)},hotkeySelectPane2:function(){this.selectPaneAtIndex(1)},hotkeySelectPane3:function(){this.selectPaneAtIndex(2)},hotkeySelectPane4:function(){this.selectPaneAtIndex(3)},hotkeySelectPane5:function(){this.selectPaneAtIndex(4)},hotkeySelectPane6:function(){this.selectPaneAtIndex(5)},hotkeySelectPane7:function(){this.selectPaneAtIndex(6)},hotkeySelectPane8:function(){this.selectPaneAtIndex(7)},hotkeySelectPane9:function(){this.selectPaneAtIndex(8)},hotkeySelectPane10:function(){this.selectPaneAtIndex(9)},hotkeyPreviousPane:function(){var e=a.default.vmMain.paneManager,t=a.default.vmMain.paneManager.getFocusedPaneIndex()-1;t<0&&(t=e.paneCount()-1),this.selectPaneAtIndex(t)},hotkeyNextPane:function(){var e=a.default.vmMain.paneManager,t=a.default.vmMain.paneManager.getFocusedPaneIndex()+1;t>=e.paneCount()&&(t=0),this.selectPaneAtIndex(t)},hotkeyZoomIn:function(){a.default.vmMain.applyToSelection(function(e){return e.isNote()||a.default.vmMain.zoomin(e),!1})},hotkeyZoomOut:function(){var e=a.default.focusedItem;e&&e.parent()&&a.default.vmMain.zoomout(e.parent())},hotkeyCollapse:function(){a.default.vmMain.applyToSelection(function(e){a.default.focusedPane.supportCollapsing&&e.toggleCollapsed(a.default.focusedPane)})},hotkeyCollapseAll:function(){a.default.focusedItem&&a.default.focusedPane&&a.default.focusedPane.supportCollapsing&&a.default.focusedPane.toggleCollapseAll()},hotkeyCollapseRecursive:function(){var e,t=a.default.focusedPane;a.default.vmMain.applyToSelection(function(i,a,n,s){t.supportCollapsing&&(void 0===e&&(e=!t.isPaneObjectCollapsed(s)),t.collapseAll(i,e,!0))})},hotkeyIndent:function(){d.default.compoundOperation(function(){f.a.isValid()&&d.default.handleTab()})},hotkeyUnindent:function(){d.default.compoundOperation(function(){f.a.isValid()&&d.default.handleTab(!0)})},hotkeyMoveUp:function(){d.default.moveUp()},hotkeyMoveDown:function(){d.default.moveDown()},hotkeySelectItem:function(){d.default.handleSelectAllItem()},hotkeyClosePane:function(e){var t=a.default.vmMain.paneManager.removeFocusedPane();void 0!==t&&(l.a.performAction(TrackerType.UIAction,{type:TrackerUIAction.RemovePane,data:t}),a.default.tooltip.hideTip(),e.stopImmediatePropagation())},hotkeyBold:function(e){return f.a.isValid()&&a.default.vmMain.applyFormatToSelection("**"),e.preventDefault(),!1},hotkeyItalic:function(e){return f.a.isValid()&&a.default.vmMain.applyFormatToSelection("*"),e.preventDefault(),!1},hotkeyUnderline:function(e){return f.a.isValid()&&a.default.vmMain.applyFormatToSelection("__"),e.preventDefault(),!1},hotkeyInsertLink:function(e){f.a.isValid()&&f.a.getStartItem().insertLinkAtSelection();return e.preventDefault(),!1},hotkeyMoveAutocomplete:function(){a.default.focusedPane&&f.a.isValid()&&a.default.focusedPane.autocompleteMove()},hotkeyJumpAutocomplete:function(){var e=a.default.focusedPane;if(e){var t=e.search,i={};t.isFocused.get()?i.elementDisplay=t.getSearchBox():e!==a.default.focusedPane&&(f.a.focusPane(e),i.elementDisplay=t.getSearchBox()),e.autocompleteJump(i)}},hotkeyUndo:function(){u.default.hasRawSelection()&&a.default.elementInNonPaneEdit(u.default.getSelectionNode())||(a.default.focusedPane?a.default.focusedPane.handleUndo():l.a.undoAction())},hotkeyRedo:function(){u.default.hasRawSelection()&&a.default.elementInNonPaneEdit(u.default.getSelectionNode())||(a.default.focusedPane?a.default.focusedPane.handleRedo():l.a.redoAction())},hotkeyPrefixHeader:function(){a.default.vmMain.applyPrefixToSelection(r.a.Prefix.Header)},hotkeyPrefixTask:function(e){a.default.vmMain.applyPrefixToSelection(r.a.Prefix.Task)},hotkeyPrefixBullet:function(e){a.default.vmMain.applyPrefixToSelection(r.a.Prefix.Bullet)},hotkeyPrefixNumList:function(e){a.default.vmMain.applyPrefixToSelection(r.a.Prefix.NumList)},hotkeyEmailCompose:function(){var e=a.default.vmMain.getDefaultEmailPlugin();e.isEnabled()?a.default.menus.openComposeEmail(e):a.default.toasts.pushMessage(MessageID.NeedGmailPermission)},hotkeyPreviousBoard:function(){p.a.hotkeyPrevBoard()},hotkeyNextBoard:function(){p.a.hotkeyNextBoard()},hotkeySelectBoard1:function(){p.a.selectBoard(0)},hotkeySelectBoard2:function(){p.a.selectBoard(1)},hotkeySelectBoard3:function(){p.a.selectBoard(2)},hotkeySelectBoard4:function(){p.a.selectBoard(3)},hotkeySelectBoard5:function(){p.a.selectBoard(4)},hotkeySelectBoard6:function(){p.a.selectBoard(5)},hotkeySelectBoard7:function(){p.a.selectBoard(6)},hotkeySelectBoard8:function(){p.a.selectBoard(7)},hotkeySelectBoard9:function(){p.a.selectBoard(8)},hotkeySelectBoard10:function(){p.a.selectBoard(9)},hotkeyAddToCalendar:function(){var e=a.default.vmMain.getDefaultCalendarPlugin();e.isActive()&&!e.isPluginBlocked()&&a.default.vmMain.applyToSelection(e.createEventForItem)},hotkeyEditNote:function(){a.default.focusedPane&&(a.default.vmMain.beginUpdateItems(),a.default.focusedPane.clearPreventUpdate(),a.default.vmMain.applyToSelection(function(e){e.isNote()||e.editNote()}),a.default.vmMain.commitUpdateItems())},hotkeyHelp:function(){a.default.intro.toggle(r.a.HelpMode.Normal)},hotkeyHelpHotkeys:function(){a.default.intro.toggle(r.a.HelpMode.Hotkeys)},hotkeySettings:function(){a.default.menus.openSettings()},hotkeyDeleteItem:function(){a.default.focusedPane.deleteSelected()},hotkeyZoomInApp:function(){a.default.nativeBridge.sendToApp("zoomIn")},hotkeyZoomOutApp:function(){a.default.nativeBridge.sendToApp("zoomOut")},hotkeyNoop:function(){},callbackOnPane:function(e,t,i){var n=a.default.focusedPane;return n&&n.onHotkey&&n.onHotkey(e,t,i),!1},printHotkeyByName:function(e,t){var i=this.config[t||"Pane"][e];if(a.default.Assert(i,"Getting an invalid hotkey"),i)for(var n=0,s=0;s<i.length;s++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var r=i[s];if(this.isValidPlatform(r))return this.printHotkey(r)}},printHotkey:function(e){for(var t=0,i=e.split(":"),a=i[i.length-1].split("+"),n="",r=0;r<a.length;r++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var o=a[r];r>0&&(n+=s.a.windows?" + ":" "),n+="Pr"===o?s.a.priModKey:"Se"===o?s.a.secModKeyForce:"Sh"===o?s.a.mac?"⇧":"Shift":"Op"===o?"⌥":2===o.length&&"D"===o[0]?o[1]:"Slash"===o?"/":"Tilde"===o?"~":"LeftArrow"===o?"←":"RightArrow"===o?"→":"UpArrow"===o?"↑":"DownArrow"===o?"↓":"Period"===o?".":"Comma"===o?",":"Equals"===o?"=":"Plus"===o?"+":"Dash"===o?"-":"Backspace"===o?s.a.mac?"Delete":o:o.endsWith("Bracket")?o.startsWith("L")?"[":"]":o}return n},__dbgCheckHotkeyOverlap:function(e,t){for(var i=0,n=t.mods,s=g[e],r=0;r<s.length;++r){var o=0;if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;for(var l=s[r].mods,d=!0,u=0;u<4;u++){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;if(n[u]!==l[u]){d=!1;break}}d&&(l[this.platformPrimaryKey]&&n[this.platformPrimaryKey]&&a.default.Assert(!1,"Overlapping hotkey: ",t),l[this.platformSecondaryKey]&&n[this.platformSecondaryKey]&&a.default.Assert(!1,"Overlapping hotkey: ",t))}}};t.a=new v},function(e,t,i){"use strict";var a=i(0),n=i(6),s=i(5),r=i(1),o=i(23),l=i(24),d=i(3);function u(){this.softDays=["today","tomorrow"],this.dayModifiers=["next"],this.days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],this.months=["january","february","march","april","may","june","july","august","september","october","november","december"],this.repeatStart=["every"],this.dict=this.repeatStart.concat(this.softDays).concat(this.dayModifiers).concat(this.days).concat(this.months),this.init()}u.prototype={init:function(){},findMatchLike:function(e){for(var t=0,i=e.toLowerCase(),a=[],n=0;n<this.dict.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;0===this.dict[n].indexOf(i)&&a.push({type:"date",text:this.dict[n]})}return a},findMatchExact:function(e){if(this.dict.indexOf(e)>=0&&this.nextWordOptions(e)===this.NextWordOptions.None)return{type:"date",text:e}}};var c=u;function h(){s.a.forceBind("tagComparatorNumber",this)}h.prototype={tagComparator:function(e,t){return e.localeCompare(t)},tagComparatorNumber:function(e,t){var i=e.count,a=t.count;return i===a?e.text.localeCompare(t.text):i>a?-1:1},findMatchExact:function(e){return!1},findMatchLike:function(e,t,i){var n={},s=[],r=e.toLowerCase(),o={comparator:function(e){if(!e.isComplete()){var t=e.getTagsLower();if(t)for(var i=0,a=0;a<t.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var o=t[a];if(!r||o.startsWith(r)&&o!==r){if(!n[o]){var l=n[o]={type:"tag",text:o,count:0};s.push(l)}n[o].count++}}}}};return i?o.item=i.getRootItem():o.itemStore=a.default.vmMain.itemStoreManager.getDefaultItemStore(),a.default.searchVMLIs(o),s.sort(this.tagComparatorNumber),s.length>t&&(s=s.slice(0,t)),s},printStats:function(e){var t=0;log("--- Tag stats ---",e);for(var i=this.findMatchLike("",100),a=0;a<i.length;a++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;console.log(i[a].text,i[a].count)}},getAll:function(){return this.findMatchLike("")}};var f=new h;function p(){this.items=[]}p.prototype={findMatchLike:function(e,t){var i=a.default.vmMain.itemStoreManager.getDefaultItemStore(),n=e.toLowerCase(),s=[];return a.default.searchVMLIs({itemStore:i,comparator:function(e){return!e.isComplete()},each:function(e){var i=!1;n?(e.getPrefix()+e.getSearchText()).indexOf(n)>=0&&(i=!0):i=e.isPrefixHeader();if(i&&s.push({type:"item",text:e.getParsedText(),item:e}),s.length>=t)return!1}}),s},findMatchExact:function(e,t){}};var g=new p;function m(){this.accountID=void 0}m.prototype={setAccountID:function(e){this.accountID=e},findMatchLike:function(e,t){for(var i=0,n=a.default.vmMain.getDefaultEmailPlugin(),s=n.getLabels(this.accountID,e,t),o=[],l=0;l<s.length;++l){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;s[l].isSystemLabel()||o.insertSorted(s[l],n.labelSortFn)}return o.map(function(e){return{type:r.a.AutocompleteMode.GmailLabel,text:e.getName(),label:e}})},findMatchExact:function(e,t){}};var v=new m;function _(){this.matches=new o.a,this._isShowing=!1,this._isTempDisabled=!1,this._showNoMatches=!1,this._searchInfo=void 0,this.owner=void 0,this.elementInput=void 0,this.text=void 0,this._prefixes=[r.a.ContactPrefix,r.a.DatePrefix,r.a.TagPrefix,r.a.PrefixItemAutocomplete],this._prefixMap={},this._prefixMap[r.a.ContactPrefix]=n.default.contactManager,this._prefixMap[r.a.TagPrefix]=f,this._prefixMap[r.a.DatePrefix]=new c,this._prefixMap[r.a.PrefixItemAutocomplete]=g,s.a.forceBind("onClosed",this),s.a.forceBind("onSelectedFromPane",this),this.supportedModes=null}_.prototype={isShowing:function(){return this._isShowing},getText:function(){return this.text},getProviderForPrefix:function(e){return this._prefixMap[e]||ACProvider.None},_checkPrefixes:function(e,t){for(var i=0,a=e.startsWith("-")?1:0,n=0;n<this._prefixes.length;n++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this._prefixes[n];if((s!==r.a.PrefixItemAutocomplete||t)&&e[a]===s)return{length:a+1,prefix:s}}},_findClosestWithPrefix:function(e,t,i,a){for(var n,s=0,o=e.split(/\s/),l=0,d=-1,u=-1,c=-1,h=0,f=0;f<o.length&&l<=t;++f){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var p=o[f];o[d]===n&&(h=0);var g=this._checkPrefixes(p,a.canAutocompleItems);g?(d=f,c=(u=l)+p.length,h=g.length,n=g.prefix):h&&n!==r.a.TagPrefix&&(c+=p.length+1),l+=p.length+1}if(h&&t>=u&&t<=c)return{mode:i,text:e,prefix:n,searchText:e.substr(u+h,c-u-h),start:u+h,end:c}},_findClosestDelimited:function(e,t,i){var a,n=0;a=i===r.a.AutocompleteMode.Item?[e]:e.split(",");for(var s=!1,o=0,l=-1,d=-1,u=0;u<a.length&&o<=t;++u){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var c=a[u];l=o+this._numStartSpaces(c),d=o+c.length-this._numEndSpaces(c),s=l<t&&t<=d&&c.length>0,o+=c.length+1}if(s||this._showNoMatches)return{mode:i,text:e,searchText:e.substr(l,d-l+1),start:l,end:d}},_findClosestVMLIElement:function(e,t,i,a){for(var n,s,r,o=0,l=0,d=!1,u=0;u<t.length&&!1===d;u++){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var c=t[u].getParsedText();if(n=l+this._numStartSpaces(c),s=l+c.length-1-this._numEndSpaces(c),n<i&&i<=s+1&&c.length>0){d=u,r=c.trim();break}l+=c.length}if(!1!==d)return{mode:a,text:e,prefix:"",searchText:r,start:n,end:s,el:t[u]}},_numStartSpaces:function(e){for(var t=0,i=0,a=0;a<e.length;a++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(" "!==e[a])break;i++}return i},_numEndSpaces:function(e){for(var t=0,i=0,a=e.length-1;a>=0;a--){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(" "!==e[a])break;i++}return i},insertMatch:function(e){var t=this._searchInfo,i=t.text,a=i.substr(0,t.start),n=i.substr(t.end,i.length),s=t.start+e.length;return" "!==n[0]&&e&&" "!==e[e.length-1]&&(e+=" ",s++),{text:a+e+n,offset:s}},onSelectedFromPane:function(e){e.owner.setText(e.value,!0,ChangeType.Local),d.a.selectIndex(e.index,e.offset)},prefixForMode:function(e){return"date"===e&&r.a.DatePrefix||"contact"===e&&r.a.ContactPrefix||"tag"===e&&r.a.TagPrefix||void 0},startMobileAutocomplete:function(e){var t=e.mode,i=this.prefixForMode(t),a="date"===t?"Enter date":"Search "+t.capitalize()+"s";this.showPopup({mode:t,text:a,allowCustom:"date"===t,buttonText:"Add",onSelected:function(t){var a=e.owner;if(a){var n=a.getParsedText(),s=a.getDateText();n="date"===e.mode&&s?n.replace(s,t.value):n+(n.endsWith(" ")?"":" ")+i+t.value,a.setText(n,!0,ChangeType.Local)}}})},updateFromPane:function(e){var t=e.owner.getACText()||"";if(!(e.start<=1)||"#"!==t&&"+"!==t){var i=e.element.getBoundingClientRect(),a=l.default.getCaretScreenPosition(e.pane,e.index,e.start);this.update({mode:"all",text:t,offset:e.start,owner:e.owner,positionOffset:{left:a.left-i.left,top:0},fromPane:!0,indexInPane:e.index,elementDisplay:e.element,position:"full",onSelected:this.onSelectedFromPane})}},update:function(e){var t=e.mode;if(e.owner===this.owner&&e.elementInput===this.elementInput||(this._isTempDisabled=!1),e.showNoMatches&&(this._showNoMatches=!0),this.text=e.text,this._isTempDisabled||!e.text&&!this._showNoMatches)this.matches.set([]),this._showNoMatches||this.hide();else{this.owner=e.owner,this.elementInput=e.elementInput;var i=e.text,n=null,s=null;this._searchInfo="all"===t?this._findClosestWithPrefix(i,e.offset,e.mode,e):this._findClosestDelimited(i,e.offset,e.mode);if(this._searchInfo){if(this.text=this._searchInfo.searchText,"all"===t)s=this.getProviderForPrefix(this._searchInfo.prefix);else switch(t){case r.a.AutocompleteMode.Move:case r.a.AutocompleteMode.Jump:case r.a.AutocompleteMode.Item:s=g;break;case r.a.AutocompleteMode.Email:n=(s=this._prefixMap[r.a.ContactPrefix]).findEmailsLike(this._searchInfo.searchText.trim(),100);break;case r.a.AutocompleteMode.Contact:s=this._prefixMap[r.a.ContactPrefix];break;case r.a.AutocompleteMode.Tag:s=this._prefixMap[r.a.TagPrefix];break;case r.a.AutocompleteMode.Date:case r.a.AutocompleteMode.Snooze:s=this._prefixMap[r.a.DatePrefix];break;case r.a.AutocompleteMode.GmailLabel:var o=a.default.vmMain.getDefaultEmailPlugin()._getAccountIDFromItem(e.item);(s=v).setAccountID(o);break;default:a.default.Assert(!1,"Unknown autocomplete mode: ",t)}null===n&&(n=s.findMatchLike(this._searchInfo.searchText,100,a.default.focusedPane))}n=n||[],e.supportSearchItemAutocomplete&&"all"===t&&0===n.length&&e.parsedEls&&(this._searchInfo=this._findClosestVMLIElement(i,e.parsedEls,e.offset,t)),this.matches.set(n),!this._isShowing&&n.length>0&&!this._isTempDisabled&&!e.noShow?this.show(e):0===n.length&&(this._showNoMatches||this.hide(),this._isTempDisabled=!1)}},clearDisabled:function(){this._isTempDisabled=!1},onClosed:function(){this._isShowing=!1,this._owner=null,this.matches.clear()},show:function(e){var t="email"===e.mode;this._isShowing=!0,this._showNoMatches=!!e._showNoMatches,this._owner=e.owner,e.componentName="ReactAutocomplete",e.onClosed=this.onClosed,a.default.menus.openContextMenu(e,t)},showPopup:function(e){this._isShowing=!0,this._showNoMatches=!0,e.componentName="ReactAutocomplete",e.onClosed=this.onClosed,e.position="full",a.default.menus.openContextMenu(e)},hide:function(){this._isShowing&&(this._isShowing=!1,a.default.menus.closeContextMenu("ReactAutocomplete"))}};t.a=new _},function(e,t,i){"use strict";var a=i(0);function n(){}var s=[" ","-","/","[","]","(",")","*","_","@",".",":"];n.prototype={getPreviousWord:function(e,t,i){for(var a=0,n=i-1;n>=0;n--){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var r=t[n];if(s.indexOf(r)>=0&&!this.isInsideMarkup(e,n))return n}return-1},getNextWord:function(e,t,i){for(var a=0,n=i+1;n<t.length;n++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var r=t[n];if(s.indexOf(r)>=0&&!this.isInsideMarkup(e,n,!0))return n}return t.length},moveLeft:function(e,t){if(a.default.showMarkdown())t--;else{var i=0;do{if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;t--}while(t>0&&this.isInsideMarkup(e,t,!1))}return t},moveRight:function(e,t,i){var n=t;if(a.default.showMarkdown())n++;else{var s=0;do{if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;n++}while(n<=i&&this.isInsideMarkup(e,n-1,!0))}return t<i-3&&n>i&&(n=i),n},isInsideMarkup:function(e,t,i,n){if(!a.default.showMarkdown())for(var s=0,r=e.getEls(),o=0;o<r.length;o++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var l=r[o],d=l.getOrigTextLength();if(t<d)return(n?l.hasClass(n):l.isMarkdown()||l.isMDImage()||!!i&&l.hasClass("itemPrefix"))?l:void 0;t-=d}}},t.a=new n},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(4),r=i(26),o=i(2),l=i.n(o),d=i(12),u=i(10),c=i(55),h=d.a.createClass({displayName:"FancyContextMenuItem",componentDisplay:n.a.ComponentDisplay.Everywhere,init:function(){this.createObservables({isHovered:!1})},getElement:function(){var e=this.refs.element;return e.getElement?e.getElement():e},closeMenu:function(){!1!==this.props.canClose&&a.default.menus.closeContextMenu()},onClick:function(e){var t=this.props;t.hasButtons||this.didClickJustFire||!t.onClick||(!1!==t.clickCloses&&this.closeMenu(),t.onClick(e),this.didClickJustFire=!0,setTimeout(function(){this.didClickJustFire=!1}.bind(this),300))},onClickIcon:function(e){var t=this.props;t.onClickIcon?(this.closeMenu(),t.onClickIcon(e)):this.onClick(e)},onMouseDown:function(e){(this.props.onClickIcon||a.default.hasClass(e.target,"fancyContextMenuIcon"))&&e.preventDefault()},onMouseUp:function(e){var t=this.props;!isNaN(e.button)&&e.button!==ButtonCode.Left||s.a.mac&&e.ctrlKey||t.onClickIcon&&a.default.hasClass(e.target,"fancyContextMenuIcon")||this.onClick(e)},onMouseEnter:function(e){this.isHovered.set(!0),this.props.onMouseEnter&&this.props.onMouseEnter(e)},onMouseLeave:function(){this.isHovered.set(!1)},render:function(){var e,t=this.props,i=this.state,n=t.onClick||t.hoverEffects,s=a.default.classNames("fancyContextMenuItem",{flexbox:!t.customLayout},{"c-foreground":!t.faded},{"c-foreground-faded":t.faded},{"c-popup-item":n&&!1!==t.hoverEffects},{selected:t.selected||!1!==t.hoverEffects&&i.isHovered},{active:t.active},{disabled:t.disabled},{hasIcon:!!t.icon},{hasContent:!!t.children},{bold:t.bold},{hasHotkey:t.hotkey},{"flex-center":t.center},{hasButtons:t.hasButtons},this.props.className);if(t.icon)if(t.onClickIcon)e=l.a.createElement(u.a,{className:"fancyContextMenuIcon",icon:t.icon,tooltip:t.iconTooltip,width:36,height:t.height||28,onClick:this.onClickIcon});else{var o=a.default.classNames("fancyContextMenuIcon c-foreground-faded",t.icon),d={fontSize:t.iconSize,height:t.height,lineHeight:t.height&&t.height+"px",color:t.iconColor};e=l.a.createElement("span",{className:o,style:d,onClick:this.onClickIcon,"data-tooltip":t.iconTooltip})}var h,f=t.hotkey;if(t.hoverHotkeyIcon&&i.isHovered){var p=a.default.classNames("fancyContextMenuHotkey c-button",t.hoverHotkeyIcon,{centered:t.hotkeyCentered});h=l.a.createElement("span",{className:p,onMouseUp:t.onClickHoverHotkeyIcon})}else if(f){var g=a.default.classNames("fancyContextMenuHotkey c-foreground-faded",{centered:t.hotkeyCentered}),m=a.default.isString(f)?f:r.a.printHotkeyByName(f.name,f.group);h=l.a.createElement("span",{className:g},m)}var v=t.style||{};v.height=t.height,v.lineHeight=t.height&&t.height+"px",v.cursor=n?"pointer":"";var _={id:t.id,className:s,"data-tooltip":t.tooltip,onMouseOver:t.onMouseOver,style:v,ref:"element"};return n&&(_.onMouseDown=(t.onClick,void 0),_.onMouseUp=t.onClick&&!t.noMouseUp?this.onMouseUp:void 0,_.onClick=t.onClick&&(t.noMouseUp,1)?this.onMouseUp:void 0,_.onMouseEnter=void 0,_.onMouseLeave=void 0),l.a.createElement(t.onClick?c.a:"div",_,e,h?l.a.createElement("span",{className:"f1"},t.children):t.children,h)}});t.a=h},function(e,t,i){"use strict";var a=i(0),n=i(6),s=i(1),r=["data-href","plugin","plugin-id","appLink","tooltip","data-original-text","attachSimple","size"];function o(e,t){this._parsedText=e,this._textLength=e.length,this._attrs=t?a.default.clone(t):{},this._width=void 0}o.prototype={setWidth:function(e){this._width=e},getWidth:function(e){return!this.isMarkdown()||a.default.showMarkdown()&&e?this._width:this.isAppLinkStart()?20:0},getParsedText:function(){return this._parsedText},getOrigTextLength:function(){return this._textLength},setParsedText:function(e){this._parsedText=e},getUnstyledText:function(e){var t;if(this.getAttr("plugin")){a.default.Assert(this.getAttr("plugin-id"),"If a plugin is specified, must have the ID for that plugin as well");var i=a.default.vmMain.pluginManager.getPlugin(this._attrs.plugin),n=i.getAttachment(this.getAttr("plugin-id"));t=i.getUnstyledText(n,e)}else t=a.default.escape(this._parsedText);return t},getStyledText:function(e,t,i){var n;if(this.getAttr("plugin")){a.default.Assert(this.getAttr("plugin-id"),"If a plugin is specified, must have the ID for that plugin as well");var s=a.default.vmMain.pluginManager.getPlugin(this._attrs.plugin),r=s.getAttachment(this.getAttr("plugin-id"));n=s._getDisplayText(r,e,i)}else n=t?this._parsedText:a.default.escape(this._parsedText);return n},getAttrs:function(){return this._attrs},getAttr:function(e){var t;return this._attrs&&(t=this._attrs[e]),t},hasAttrs:function(){return!!this._attrs},getClasses:function(){var e;return this._attrs&&(e=this._attrs.cls),e},hasClasses:function(){var e=this.getClasses();return!!e&&e.length>0},hasClass:function(e){var t=!1,i=this.getClasses();return i&&(t=i.indexOf(e)>=0),t},getClassString:function(){var e="",t=this.getClasses();return t&&(e=t.join(" ")),e},addClass:function(e){this._attrs||(this._attrs={}),this._attrs.cls||(this._attrs.cls=[]),this._attrs.cls.push(e)},mergeAttrs:function(e){if(e)if(this._attrs){var t=0;e.cls&&(this._attrs.cls?this._attrs.cls=this._attrs.cls.concat(e.cls):this._attrs.cls=e.cls),a.default.Assert(void 0===this._attrs.plugin||void 0===e.plugin||this._attrs.plugin===e.plugin,"A single element cannot match multiple plugins"),a.default.Assert(void 0===this._attrs["plugin-id"]||void 0===e["plugin-id"]||this._attrs["plugin-id"]===e["plugin-id"],"A single element cannot match multiple plugins");for(var i=0;i<r.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=r[i],s=this._attrs[n]||e[n];s&&(this._attrs[n]=s)}}else this._attrs=e},addAttr:function(e,t){this._attrs||(this._attrs={}),this._attrs[e]=t},isMarkdown:function(){return this.hasClass("mdMarkup")},isMDImage:function(){return this.hasClass("mdImage")},isAppLinkStart:function(){return this.hasClass("mdMarkupStart")&&this._attrs.appLink}};var l,d,u,c=o,h=(i(4),i(19)),f=", . ? ! ) ( : ; [ ] ' \"".split(" "),p=(navigator.userAgent.indexOf("Mac"),0),g=["http","https","evernote","onenote","bear"],m=window.__PARSE_STATS={total:0,parseText:0,parseNote:0,parseSinglePlugin:0},v=new Date(9e12).getTime(),_=new Date(1401606e6),y=/^(next|today|tomorrow|yesterday|(?:sun|mon|tue(?:s)?|wed(?:nes)?|thu(?:rs)?|fri|sat(?:ur)?)(?:day)?)/i,S=/^(?:(?:([0]?[1-9]|1[0-2])(?::([0-5]\d))?(?:\s)?(am?|pm?|\b))|(?:([0]?\d|1\d|2[0-3]):([0-5]\d)))$/i,w=/(^#|[\(\s-]#)([^\s\),*#]+)/g,I=/(?:^(?:[\*_]*?)@|[\(\s](?:[\*_]*?)@)([^\s\)\*_]{2,})(\s[^\s\)@\u2001\u2003\*_]{1,})?(\s[^\s\)@\u2001\u2003\*_]{1,})?/g,b=/(?:^(?:[\*_]*?|before:|after:)@|[\(\s](?:[\*_]*?)(?:before:|after:)?@)([^\s\)\*_]{2,})(\s[^\s\)@\u2001\u2003\*_]{1,})?(\s[^\s\)@\u2001\u2003\*_]{1,})?/g,A=(s.a.Regexp.Link,s.a.Regexp.LinkExc),D=/(?:^|[\s\(\[])([^\(\[#@\s]+\.(?:com|org|net|io))/gi,T=/(?:(?:\u2001|\u2003)(p:[^\u2001\u2003]+)(?:\u2001|\u2003))/gi,M=s.a.Regexp.Prefix,C=/(\#+|\^|\-|\*|\[(?: ?\])?|\]|\((?: ?\))?|\)|\+|[0-9]+\.) /gi,L=s.a.Regexp.MDLink,P=/^(-{3,})$/g,E=/^([\*_]*)([^\*_]+)([\*_]*)/g,k=/\b([^<>\s]+@[^<>\s]+\.[^<>\s]+)\b/gi,x=/^(\#+|\^|\-|\*|\[(?: ?\])?|\]|\((?: ?\))?|\)|\+|[0-9]+\.) (-{3,})$/g,R=/(\*\*\*)(.*?)\1/g,O=/(\*\*)(.*?)\1/g,F=/(__)(.*?)\1/g,N=/(\*)(\u2005*?)([^\u2005|\*]+?)\2\1/gi,B={repeat:/^(ev(ery)?|after)\b/i,recur:/^(other|first|second|third|fourth|1st|2nd|3rd|4th|last)$/i,day:/^(((sun|mon|tue(s)?|wed(nes)?|thu(rs)?|fri|sat(ur)?)(day)?)(?:,|\sand\s)?)$/i,daysOfWeek:/^(weekday|weekend)$/i,len:/^(day|week|month|year|morning|afternoon|night)$/i,count:/^((\d{1,2})|one|two|three|four|five|six|seven|eight|nine|ten)$/i,month:/^(jan(uary)?|feb(ruary)?|ma((r(ch)?)?|y)|apr(il)?|ju(l|n|ly|ne)|aug(ust)?|oct(ober)?|(sep(t)?|nov|dec)(ember)?)$/i,at:/^at$/i,of:/^of$/i,in:/^in$/i,delim:/^and$/i,date:/^((\d{1,2})|([2-5]?1(st)?|[2-5]?2(nd)?|[2-5]?3(rd)?|(0|[1-5]?[4-9]|[1-5]0|1[1-3])(th)?)(?:,|\sand\s)?)$/i,year:/^((\d\d)|(\d\d\d\d))$/i,time:S,from:/^(from|starting)$/i,until:/^(until)$/i,measure:/^(days|weeks|months|years)$/i},U={"1st":1,fir:1,"2nd":2,sec:2,"3rd":3,thi:3,"4th":4,fou:4,sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6,jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11,one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,days:RepeatFreq.Daily,weeks:RepeatFreq.Weekly,months:RepeatFreq.Monthly,years:RepeatFreq.Yearly},V={h:1,hr:1,hrs:1,hour:1,hours:1,Hours:1,m:2,min:2,mins:2,Minutes:2,d:3,day:3,days:3,Days:3,"-":1,until:1,to:1,till:1,EndDate:1,for:2,Duration:2},H={duration:/^(-\s|(?:for|until|to|till)\b)/i,len:/^(\d{0,3}(?:\.\d{1,2})?)(h(?:(?:ou)?r(?:s)?)?|m(?:in(?:s)?)?|d(?:ay(?:s)?)?)$/i},q=0,z=0,W=1;function G(){}G.prototype={isFlagSet:function(e,t){return(e&t)===t},trimPunc:function(e){return e.replace(/[:,\.\'\"\)\]\*_]*$/g,"")},generateStyledLines:function(e,t,i,a){for(var n=0,s=this.linesToEls(e,t),r=[],o=0;o<s.length;++o){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;r.push(this.generateHTML(s[o],{convertLines:!1,pane:i,highlightSearch:a}))}return r},linesToEls:function(e,t){for(var i=0,a=[],n=[],s=!1,r=0;r<t.length;++r){var o=0;if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;for(var l=0,d=t[r].start,u=t[r].length,h=0,f=0;f<e.length;++f){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var p=e[f],g=p.getParsedText().length,m=Math.max(d-l,0);if(m<g){var v=Math.min(g-m,u-h);if(v>0){var _=p.getParsedText().substr(m,v),y=new c(_,p.getAttrs());y.getAttr("appLink")&&!s&&y.addAttr("appLinkStart",!0),n.push(y),s=!!y.getAttr("appLink"),h+=v}}l+=g}a.push(n),n=[]}return a},replaceTextInEls:function(e,t,i,n){var s=0;a.default.Assert(a.default.isArray(e),"Must supply a valid VMLIElement array"),a.default.Assert(t,"Must be replacing at least one of parsed or styled text");for(var r=0,o=0;o<e.length;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var l=e[o],d=l.getParsedText();if(i+n>=r&&i<r+l.getOrigTextLength()){var u=i-r,c=Math.min(n,d.length-u),h=d.substr(0,u),f=d.substr(u+c);t&&l.setParsedText(h+t+f);break}r+=l.getOrigTextLength()}},getElAtOffset:function(e,t){for(var i=0,a=0,n=0;n<e.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=e[n],r=s.getOrigTextLength();if(t>=a&&t<a+r)return s;a+=r}},insertEl:function(e,t,i,n){var s=0;a.default.Assert(a.default.isArray(t.cls),"Must always pass in a valid classes array"),a.default.Assert(a.default.isNumber(i),"Must have a valid start"),a.default.Assert(a.default.isNumber(n),"Must have a valid length");for(var r,o=0,l=n,d=0;d<e.length;++d){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var u=e[d],h=u.getParsedText();if(o<i+n&&i<o+u.getOrigTextLength()){var f=0,p=Math.max(i-o,0),g=Math.min(l,h.length),m=p+l,v=h.length-m;if(p>0){var _=h.substr(0,p);e.splice(d,0,new c(_,u.getAttrs())),f++}var y=h.substr(p,g);if((r=new c(y,u.getAttrs())).mergeAttrs(t),e.splice(d+f,1,r),f++,v>0){var S=h.substr(m,v);e.splice(d+f,0,new c(S,u.getAttrs()))}if(d+=f-1,l-=g,v>0)break}o+=u.getOrigTextLength()}return r},replaceTextWithSearch:function(e,t){for(var i=0,n=t.search.getSearchWords(),s=e.toLowerCase(),r=[],o=e.length+1,l=0;l<n.length;l++){var d=0;if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;for(var u=n[l],c=void 0,h=void 0;(c=s.indexOf(u,h))>=0;){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;if(c>=0)for(var f=0,p=c;p<c+u.length;p++){if(f++>5e3&&__infLoop&&__infLoop(f))throw new RangeError;(isNaN(o)||p<o)&&(o=p),r[p]=!0}h=c+1}}if(o<=e.length)for(var g=0,m=-1,v=!0,_=e.length-1;_>=o-1;_--){if(g++>5e3&&__infLoop&&__infLoop(g))throw new RangeError;if(m>=0&&(_<0||!r[_])){var y=e.substring(_+1,m+1),S=e.substr(m+1),w=e.substr(0,_+1);_===o&&(w=a.default.escape(w)),v&&(S=a.default.escape(S),v=!1),e=w+'<span class="c-search-highlight">'+a.default.escape(y)+"</span>"+S,m=-1}r[_]&&m<0&&(m=_)}else e=a.default.escape(e);return e},generateHTML:function(e,t){var i,n=0,s=t.convertSpaces,r=t.pane,o=t.noPrefix,l=t.suffix,d=t.highlightSearch,u=[],c=!1;a.default.Assert(e,"C Item has no els: "),e||(e=[]);for(var h=0;h<e.length;++h){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var f=e[h],p=f.getAttrs(),g="",m="",v=f.getStyledText(r,!0,d);if(!d||p&&f.hasClass("plugin")?f.hasClass("plugin")||(v=a.default.escape(v)):v=this.replaceTextWithSearch(v,r),s&&(v=v&&v.replace(/ /g,"&nbsp;")),!o||!f.hasClass("itemPrefix"))if(p){if(r&&!r.plugin&&f.hasClass("plugin_drive_image_inline")){var _=a.default.vmMain.pluginManager.getPlugin(f.getAttr("plugin")),y=_.getAttachment(f.getAttr("plugin-id")),S=_.getAttachUrl(y);if(S)return{isImage:!0,isDriveImage:!0,maxWidth:_.getAttachWidth(y),src:S,srcDataUrl:_.getAttachDataUrl(y),text:f.getParsedText(),originalText:f.getParsedText(),previousText:u.join(""),attach:y,nextText:h<e.length-1?" ":""}}if(f.hasClass("mdImage"))return{isImage:!0,src:f.getAttr("data-href"),text:f.getParsedText(),maxWidth:f.getAttr("size"),originalText:f.getAttr("data-original-text"),previousText:u.join(""),nextText:h<e.length-1?" ":""};var w="",I="",b=f.getClassString();for(var A in f.getAttr("appLink")&&(c||(w+='<span class="appLink '+((f.hasClass("evernote")?"Evernote":"")||(f.hasClass("onenote")?"OneNote":"")||(f.hasClass("bear")?"Bear":""))+'">',w+='<span contenteditable="false"'+(f.getAttr("appLinkStart")?' class="appLinkStart"':"")+"></span>"),c=!0),f.hasClass("plugin")&&(v="<span>"+v+"</span>"),w+="<span ",I+=">"+v+"</span>",f.hasClass("plugin")&&(w+='contenteditable="false" '),p)p.hasOwnProperty(A)&&("cls"===A?(m='class="'+b+'" ',"itemPrefix"===p[A][0]&&(i=!0)):"appLink"!==A&&(g+=A+'="'+p[A]+'" '));!c||h!==e.length-1&&e[h+1].getAttr("appLink")||(I+="</span>",c=!1),m||g?u.push(w+(m||"")+(g?" "+g:"")+I):u.push(v)}else u.push(v)}return i&&1===e.length&&u.push("<span>"+TextSpace+"</span>"),l&&u.push(l),u.join("")},getNowRelativeDate:function(e){var t;switch(e.toUpperCase()){case"NOW":t=Date.today().add({hours:11});break;case"NEXT":t=Date.today().add({hours:12});break;case"SOON":t=Date.today().add({days:2});break;case"LATER":t=Date.today().add({days:5});break;case"SOMEDAY":t=Date.today().add({days:14});break;default:a.default.Assert(!1,"Must supply a valid now relative date string")}return t},_notifyParse:function(e){m.total++,m[e]++},runParseSinglePlugin:function(e,t){return this.parseSinglePlugin(e.getRawText(),t)},parseSinglePlugin:function(e,t){if(this._notifyParse("parseSinglePlugin"),!e||0===e.length)return{parsedText:void 0,els:void 0};var i,n;if(a.default.Assert(!p,"We do not support recursive calls to parse"),p++," "===e[0]||" "===e[0]){var s=!a.default.isFlagSet(t,ChangeType.ItemLoad),r=a.default.vmMain.pluginManager.parseAttachmentEmbedString(e.slice(1,-1),s);n=[r],e=window.AttachChar,s&&(i=[new c(window.AttachChar,r.displayElement.attrs)])}else i=[new c(e)];return p--,{parsedText:e,attachments:n,els:i}},parseNote:function(e){return this._notifyParse("parseNote"),{parsedText:e.getRawText(),els:[new c(e.getRawText())]}},runParseText:function(e,t){var i;return(i=this.isFlagSet(t,ChangeType.Local)?h.a.getCurrentDateFormat():e.getDateFormat())||(i=s.a.DateFormat.MDY),this.parseText(e.getRawText(),e.getDateTime(),e.getRepeatDateString(),e.getDateText(),i,e.getDateCompletedTime(),t,n.default.contactManager.getContacts())},parseText:function(e,t,i,n,r,o,l,d,u,m,v){var _=0;if(this._notifyParse("parseText"),!e||0===e.length)return{parsedText:void 0,els:[]};a.default.Assert(!p,"We do not support recursive calls to parse"),p++;var y,S,C,x,B,U,V,H,q,z,W,G,j=!1,K=e,Y=e,X=0,Q=!1,J=[new c(K)];m||(M.lastIndex=0,null!==(y=M.exec(K))&&(V=y[1])&&(X=y[0].length,0===V.indexOf("#")||0===V.indexOf("^")?(G="prefixHeader",H="header"):"["===V||"[]"===V||"[ ]"===V||"]"===V||"("===V||"()"===V||"( )"===V||")"===V?(G="prefixTask icon-square-o",H="task"):"*"===V||"-"===V||"+"===V?(G="prefixBullet",H="bullet"):(G="prefixNumList",H="numList"),this.insertEl(J,{cls:["itemPrefix",G]},0,X).setWidth(s.a.PrefixWidth),Y=K.substr(X)));var Z=0;for(T.lastIndex=0;null!==(y=T.exec(K));){if(Z++>5e3&&__infLoop&&__infLoop(Z))throw new RangeError;var $=a.default.vmMain.pluginManager.parseAttachmentEmbedString(y[1],!0),ee=this.insertEl(J,$.displayElement.attrs,y.index,y[0].length);this.replaceTextInEls(J,window.AttachChar,y.index,y[0].length);var te=J.indexOf(ee);te>0&&ee.addClass("padB"),te<J.length-1&&ee.addClass("padA"),j=!0,B?B.push($):B=[$]}var ie=0,ae=0,ne=0,se=0,re=0;for(L.lastIndex=0;null!==(y=L.exec(Y));){if(ie++>5e3&&__infLoop&&__infLoop(ie))throw new RangeError;var oe=y[3],le=oe.indexOf("://")>0?oe:"http://"+oe,de=!!a.default.parseEvernoteLink(oe),ue=a.default.isOneNoteLink(oe),ce=a.default.isBearLink(oe),he=de||ue||ce,fe=["mdMarkup","mdMarkupStart"],pe=X+y.index+y[1].length,ge="!"===y[1],me=y[4]||"",ve=me&&+me.replace(/\s|=|x/g,"");ge?(this.insertEl(J,{attachSimple:"inlineImage",cls:["mdImage"],"data-href":le,"data-original-text":y[0],size:ve},X+y.index,y[0].length),Q=!0):y[2]&&(de?fe.push("evernote"):ue?fe.push("onenote"):ce&&fe.push("bear"),this.insertEl(J,{cls:fe,appLink:he},X+y.index,1+y[1].length),this.insertEl(J,{cls:["mdSpan","link","c-link"].concat(a.default.isUrlImage(le)?"linkImage":[]),appLink:he,"data-href":le,"data-original-text":y[0]},pe+1,y[2].length),this.insertEl(J,{cls:["mdMarkup"],appLink:he},pe+1+y[2].length,2),this.insertEl(J,{cls:["mdSpan","link","c-link","mdMarkup"].concat(a.default.isUrlImage(le)?"linkImage":[]),appLink:he,"data-href":le,"data-original-text":y[0]},pe+y[2].length+3,oe.length+me.length),this.insertEl(J,{cls:["mdMarkup","mdMarkupEnd"],appLink:he},pe+y[2].length+me.length+oe.length+3,1),Q=!0)}if(!Q){var _e=void 0,ye=void 0,Se=void 0,we=void 0;if(A.lastIndex=0,null!==(y=A.exec(Y)))Se=g.indexOf(y[3])>=0?y[2]:"http://"+y[2],_e=y.index+X,ye=y[0].length,we="!"===y[1];else if(D.lastIndex=0,null!==(y=D.exec(Y))){var Ie=y[0].length-y[1].length;Se=y[1].startsWith("http")?y[1]:"http://"+y[1],_e=y.index+Ie+X,ye=y[1].length}if(Se)if(we)this.insertEl(J,{attachSimple:"inlineImage",cls:["mdImage"],"data-href":Se,"data-original-text":y[0]},X+y.index,y[0].length);else{var be=a.default.parseEvernoteLink(Se),Ae=a.default.isOneNoteLink(Se),De=a.default.isBearLink(Se),Te={cls:["link","c-link"].concat(a.default.isUrlImage(Se)?"linkImage":[]),"data-href":Se};be&&(Te.appLink=!0,Te.cls.push("evernote")),Ae&&(Te.appLink=!0,Te.cls.push("onenote")),De&&(Te.appLink=!0,Te.cls.push("bear")),this.insertEl(J,Te,_e,ye)}}for(F.lastIndex=0;null!==(y=F.exec(Y));){if(ae++>5e3&&__infLoop&&__infLoop(ae))throw new RangeError;this.isInTag(y)||this.getElAtOffset(J,y.index).hasClass("link")||(this.insertEl(J,{cls:["mdMarkup","mdMarkupStart"]},X+y.index,y[1].length),this.insertEl(J,{cls:["mdSpan","mdUnderline"]},X+y.index+y[1].length,y[2].length),this.insertEl(J,{cls:["mdMarkup","mdMarkupEnd"]},X+y.index+y[1].length+y[2].length,y[1].length))}for(R.lastIndex=0;null!==(y=R.exec(Y));){if(ne++>5e3&&__infLoop&&__infLoop(ne))throw new RangeError;this.isInTag(y)||this.getElAtOffset(J,y.index).hasClass("link")||(this.insertEl(J,{cls:["mdMarkup","mdMarkupStart"]},X+y.index,y[1].length),this.insertEl(J,{cls:["mdSpan","mdBold","mdItalic"]},X+y.index+y[1].length,y[2].length),this.insertEl(J,{cls:["mdMarkup","mdMarkupEnd"]},X+y.index+y[1].length+y[2].length,y[1].length))}var Me=Y.replace(R,"   $2   ");for(O.lastIndex=0;null!==(y=O.exec(Me));){if(se++>5e3&&__infLoop&&__infLoop(se))throw new RangeError;this.isInTag(y)||this.getElAtOffset(J,y.index).hasClass("link")||(this.insertEl(J,{cls:["mdMarkup","mdMarkupStart"]},X+y.index,y[1].length),this.insertEl(J,{cls:["mdSpan","mdBold"]},X+y.index+y[1].length,y[2].length),this.insertEl(J,{cls:["mdMarkup","mdMarkupEnd"]},X+y.index+y[1].length+y[2].length,y[1].length))}for(Me=Me.replace(O,"  $2  "),N.lastIndex=0;null!==(y=N.exec(Me));){if(re++>5e3&&__infLoop&&__infLoop(re))throw new RangeError;this.isInTag(y)||this.getElAtOffset(J,y.index).hasClass("link")||(this.insertEl(J,{cls:["mdMarkup","mdMarkupStart"]},X+y.index,y[1].length),this.insertEl(J,{cls:["mdSpan","mdItalic"]},X+y.index+y[1].length+y[2].length,y[3].length),this.insertEl(J,{cls:["mdMarkup","mdMarkupEnd"]},X+y.index+y[1].length+y[2].length+y[3].length+y[2].length,y[1].length))}for(P.lastIndex=0,null!==(y=P.exec(Y))&&this.insertEl(J,{cls:["mdSpan","mdHR","c-border-heavy"]},0,K.length),k.lastIndex=0;null!==(y=k.exec(K));){if(_++>5e3&&__infLoop&&__infLoop(_))throw new RangeError;this.getElAtOffset(J,y.index).hasClass("link")||this.insertEl(J,{cls:["email","c-contact"]},y.index,y[1].length)}if(d&&d.___info___.count>0&&K.indexOf(s.a.ContactPrefix)>=0){var Ce,Le=0,Pe=K.split(/\s/),Ee=0;for(z=0;z<Pe.length;z++){if(Le++>5e3&&__infLoop&&__infLoop(Le))throw new RangeError;var ke=Pe[z].replace(E,"$2"),xe=Pe[z].indexOf(ke);if(0===ke.indexOf(s.a.ContactPrefix)){var Re=0;Ce=void 0;var Oe=ke.substring(1);for(W=1;;W++){if(Re++>5e3&&__infLoop&&__infLoop(Re))throw new RangeError;if(""===d[Oe])Ce=Oe;else{var Fe=this.trimPunc(Oe);""===d[Fe]&&(Ce=Fe)}if(!(z+W<Pe.length))break;Oe+=" "+Pe[z+W]}Ce&&(x?x.push(Ce):x=[Ce],this.insertEl(J,{cls:["contact","c-contact"]},Ee+xe,Ce.length+1))}Ee+=Pe[z].length+1}}var Ne=0;for(w.lastIndex=0;null!==(y=w.exec(K));){var Be=0;if(Ne++>5e3&&__infLoop&&__infLoop(Ne))throw new RangeError;for(var Ue=y.index+y[1].length-1,Ve=y[2].length+1,He=y[2];f.indexOf(He.charAt(He.length-1))>=0;){if(Be++>5e3&&__infLoop&&__infLoop(Be))throw new RangeError;Ve--,He=He.substr(0,He.length-1)}He&&(S?S.push(He):S=[He]),this.insertEl(J,{cls:["tag","c-tag"]},Ue,Ve)}var qe=0,ze=v?b:I;for(ze.lastIndex=0;null!==(y=ze.exec(K));){var We=0;if(qe++>5e3&&__infLoop&&__infLoop(qe))throw new RangeError;X=y[0].indexOf(s.a.DatePrefix),y[1];var Ge=!1;for(z=1;z<y.length&&y[z];++z){if(We++>5e3&&__infLoop&&__infLoop(We))throw new RangeError;if(Ge)y[z]=void 0;else{var je=y[z][y[z].length-1];f.indexOf(je)>=0&&(y[z]=y[z].slice(0,-1),Ge=!0)}}if(v){var Ke=y[0].trim(),Ye=y[0].indexOf(Ke[0]);(q=this.getSearchSpecialDate(Ke))&&this.insertEl(J,{cls:["date","c-date"]},y.index+Ye,q.length)}var Xe,Qe=!u&&this.parseRepeatDate(i,n,r,o,l,K.substr(y.index+X+1));if(Qe||y[1].startsWith("every")||"in"===y[1]){if(Qe){Xe=y.index+X,Qe.replacedDate?(this.insertEl(J,{cls:["date","c-date"]},Xe,Qe.repLength+1),this.replaceTextInEls(J,Qe.text,Xe+1,Qe.repLength),K=K.substr(0,Xe+1)+Qe.text+K.substr(Xe+Qe.repLength+1),j=!0):this.insertEl(J,{cls:["date","c-date"]},Xe,Qe.repLength+1),C?C.push(Qe):C=[Qe];var Je=new Date(Qe.startDate);if(Je.hasTimeOfDay()){nt=Xe+Qe.text.length+1,st=K.substr(nt);if(at=this.parseDuration(Je,st,r)){var Ze=Xe+Qe.oldText.length+1;this.insertEl(J,{cls:["duration","c-date"]},Ze,at.durationText.length+1),U?U.push(at):U=[at]}}break}}else{var $e=[y[1]?y[1]:"",y[2]?y[2]:"",y[3]?y[3]:""];if(!v&&a.default.isDateSoft($e[0])){var et=!0;"NEXT"===$e[0].toUpperCase()&&this.runDateParse($e,r)&&(et=!1),et&&(t=this.getNowRelativeDate($e[0]),$e[1]="",$e[2]="")}var tt=this.computeDateInfo(t,n,r,h.a.getCurrentDateFormat(),l,$e,v);if(tt.isValid){var it;Xe=y.index+X,tt.replacedDate?(this.insertEl(J,{cls:["date","c-date"]},Xe,tt.oldText.length+1),this.replaceTextInEls(J,tt.text,Xe+1,tt.oldText.length),K=K.substr(0,Xe+1)+tt.text+K.substr(Xe+tt.oldText.length+1),j=!0,it={type:DateType.Once,date:tt.date,dateFormat:tt.format,origText:tt.oldText,text:tt.text,explicitTime:tt.date.hasTimeOfDay()}):(this.insertEl(J,{cls:["date","c-date"]},Xe,tt.text.length+1),it={type:DateType.Once,date:tt.date,dateFormat:tt.format,origText:tt.oldText,text:tt.text,explicitTime:tt.date.hasTimeOfDay()}),C?C.push(it):C=[it];var at,nt=Xe+tt.text.length+1,st=K.substr(nt);(at=this.parseDuration(tt.date,st,r))&&(this.insertEl(J,{cls:["duration","c-date"]},nt,at.durationText.length+1),it.explicitTime||at.duration%a.default.days(1)==0||(it.explicitTime=!0),U?U.push(at):U=[at]);break}}}return B&&(T.lastIndex=0,K=K.replace(T,window.AttachChar)),p--,{parsedText:j?K:void 0,dates:C,durations:U,tags:S,attachments:B,contacts:x,prefix:V,prefixType:H,searchSpecialDate:q,els:J}},getDurationLength:function(e){var t=H.len.exec(e),i=parseFloat(t[1]),n=0;switch(V[t[2].toLowerCase()]){case V.Hours:n=a.default.hours(i);break;case V.Minutes:n=a.default.minutes(i);break;case V.Days:n=a.default.days(i);break;default:a.default.Assert(!1,"Invalid duration length: "+t[2])}return n},parseDuration:function(e,t,i){this.setDateTokens(t);var a,n=0;if(this.checkAndParse(H.duration)){if(V[l.toLowerCase()]===V.EndDate)if(this.checkAndParse(S,2)){var s=this.getTimeFromString(l),r=e.clone();r.setHours(s.hour),r.setMinutes(s.min),n=r-e}else this.checkAndParseDate(i)&&(n=u?u-e:0);else if(V[l.toLowerCase()]===V.Duration){for(var o=0;this.checkAndParse(H.len);){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;n+=this.getDurationLength(l)}n--}}else{for(var d=0;this.checkAndParse(H.len);){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;n+=this.getDurationLength(l)}n--}return n>0&&(a={durationText:t.substr(1,q).trim(),duration:n}),a},getSoftText:function(e,t){return t<0?t>=-864e5?"yesterday":e.toString(h.a.getFormat(DFormat.MonthDayYear)):t<=864e5&&e.isToday()?"today":t<1728e5?"tomorrow":void 0},runDateParse:function(e,t){var i=e.join(""),a=h.a.parseDate(i,t);return!a&&e[1]&&(i=e[0]+e[1],a=h.a.parseDate(i,t)),!a&&e[0]&&(i=e[0],a=h.a.parseDate(i,t)),{dt:a,dateString:i}},computeDateInfo:function(e,t,i,n,s,r,o){var l,d,u,c,f=new Date(e).clearTime()-(new Date).clearTime(),p=t||r.join(""),g=p,m=!1;if(this.isFlagSet(s,ChangeType.Auto)||this.isFlagSet(s,ChangeType.Remote)&&this.isFlagSet(s,ChangeType.DocLoad)){if(l=new Date(e),void 0!==e&&(f<0||f>=0&&f<1728e5)){if(y.lastIndex=0,o||null===(u=y.exec(p))){if(null!==(u=S.exec(p))){if((d=this.getSoftText(l,f))&&"today"!==d){if(void 0===t)p=(_=this.runDateParse(r,i)).dateString;g=d+" "+p,m=!0}}else if(void 0===e||void 0===t){(_=this.runDateParse(r,i)).dateString!==t&&(l=_.dt,p=_.dateString,g=_.dateString)}}else if("NEXT"!==p.toUpperCase()&&(d=this.getSoftText(l,f))&&!p.toUpperCase().startsWith(d.toUpperCase())){if(void 0===t)p=(_=this.runDateParse(r,i)).dateString;g=p.replace(u[0],d),m=!0}}else if(void 0===e||void 0===t){var v=this.isFlagSet(s,ChangeType.Rollover);if(a.default.isDemoMode()||!this.isFlagSet(s,ChangeType.Auto)||v)l=(_=this.runDateParse(r,i)).dt,g=_.dateString,v||(p=_.dateString);else void 0===e&&(l=void 0)}}else if(this.isFlagSet(s,ChangeType.Local)||this.isFlagSet(s,ChangeType.Remote)){if(this.isFlagSet(s,ChangeType.PluginLoad))l=e?new Date(e):void 0;else l=(_=this.runDateParse(r,i)).dt,p=_.dateString,g=_.dateString}else if(!o||!a.default.isDateSoft(r[0])){var _;l=(_=this.runDateParse(r,i)).dt,p=_.dateString,g=_.dateString}return a.default.Assert(!l||!isNaN(l.getTime()),"Must be a valid parsed date"),i!==n?(c=h.a.convertDateFormat(g,i,n),m=!0):c=g,{isValid:!!l,oldText:p,text:c,date:l,format:i,replacedDate:m}},getRepeatStartDate:function(e){if(e&&"string"==typeof e){var t=e.split("|");if(t.length>3&&"1"===t[0])return new Date(parseInt(t[1]))}},setDateTokens:function(e){l="",d=e.split(" "),W=1,q=d[0].length,z=0,u=void 0},checkAndParse:function(e,t){var i=!1;if(void 0===(t=void 0!==t&&t>1?Math.min(d.length-W,t):t)||1===t)W<d.length&&(i=d[W].match(e))&&(l=d[W],W++,q+=l.length+1);else if(t>1&&W+t<=d.length)for(var a=0,n=t;n>0;n--){var s=0;if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;for(var r="",o=0;o<n;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;r+=d[W+o],o+1!==n&&(r+=" ")}if(i=r.match(e)){l=r,W+=n,q+=r.length+1;break}}return i},checkAndParseDate:function(e){var t=!1;if(W+1<d.length&&!d[W+1].match(B.at)){var i=h.a.parseDate(d[W]+" "+d[W+1],e);i&&(t=!0,l=d[W]+d[W+1],u=i,W+=2,q+=l.length+2)}if(!t&&W<d.length){var a=h.a.parseDate(d[W],e);a&&(t=!0,l=d[W],u=a,W++,q+=l.length+1)}return t},computeStartDate:function(e,t,i,a,n,s){var r=s||new Date,o=(s?new Date(s):new Date).clearTime();(void 0!==a&&o.setMonth(a),void 0!==i)&&(i>0&&i<=31&&((Date.getDaysInMonth(o.getFullYear(),o.getMonth())<i||i<o.getDate())&&void 0===a&&o.addMonths(1),o.setDate(i)));return void 0!==t?(o.moveToNthOccurrence(e,t),o.isBefore(r)&&(o.addMonths(1),o.moveToNthOccurrence(e,t))):void 0!==e&&o.getDay()!==e&&(o.moveToDayOfWeek(e,-1),o.isBefore(r)&&o.moveToDayOfWeek(e)),void 0!==a&&o.isBefore(r)&&(o.addYears(1),o.setMonth(a)),n&&this.updateDateWithTime(o,n),o},updateDateWithTime:function(e,t){var i=this.getTimeFromString(t);e.setHours(i.hour),e.setMinutes(i.min),e.setMilliseconds(1)},getTimeFromString:function(e){var t,i,n,s,r=S.exec(e),o=0;void 0!==r[1]?(i=(t=r[3].toUpperCase())===Date.CultureInfo.pmDesignator[0]||t===Date.CultureInfo.pmDesignator,o=a.default.parseInt(r[1])+(i?12:0),n=r[2]?a.default.parseInt(r[2]):0,s=r[1]):void 0!==r[4]&&void 0!==r[5]&&(o=a.default.parseInt(r[4]),n=a.default.parseInt(r[5]),s=r[4]);var l=!1;if(s){var d=a.default.parseInt(s);(s.startsWith("0")||0===d||d>12)&&(l=!0)}return t||l?t&&!l&&(i||12!==o?i&&24===o&&(o=12):o=0):o<8&&(o+=12),{hour:o,min:n}},parseRepeatDate:function(e,t,i,n,s,r){var o,d,c,f,p,g,m,y,S=!1,w=Date.today(),I=RepeatFreq.Daily,b=1;if(r.match(B.repeat)){this.setDateTokens(r);var A=!1;if(this.checkAndParse(B.recur)){switch(l){case"other":b=2;break;case"last":I=RepeatFreq.NthMonthInst,g=-1;break;default:I=RepeatFreq.NthMonthInst,g=U[l.substr(0,3).toLowerCase()]}A=!0}if(A&&"other"!==l||!this.checkAndParse(B.date))if(!A&&this.checkAndParse(B.count)){var D=a.default.parseInt(l);isNaN(D)&&(D=U[l]),this.checkAndParse(B.measure)&&(I=U[l.toLowerCase()],b=D,S=!0)}else if(this.checkAndParse(B.day)){var T,M=0;for(I!==RepeatFreq.NthMonthInst&&(I=RepeatFreq.Weekly),p=U[l.substr(0,3).toLowerCase()];(l.endsWith(",")||this.checkAndParse(B.delim))&&this.checkAndParse(B.day);){if(M++>5e3&&__infLoop&&__infLoop(M))throw new RangeError;var C=U[l.substr(0,3).toLowerCase()];T?T.push(C):T=[p,C]}T&&(T.sort(),c=T),S=!0}else if(this.checkAndParse(B.daysOfWeek))I=RepeatFreq.Weekly,"weekday"===l?c=[1,2,3,4,5]:"weekend"===l&&(c=[0,6]),S=!0;else if(this.checkAndParse(B.month)){var L=l;if(this.checkAndParse(B.date)){var P=parseInt(l);P>0&&P<=31&&(m=P,y=U[L.substr(0,3).toLowerCase()],I=RepeatFreq.Yearly,S=!0)}}else if(A&&"other"!==l||!this.checkAndParse(B.len))if(A&&"last"!==l||!this.checkAndParse(B.len))A&&"other"!==l&&(I=RepeatFreq.DayOfMonth,m=g,g=void 0,S=!0);else switch(l){case"day":S=!0,I=RepeatFreq.EndOfMonthOffset}else{switch(l){case"day":I=RepeatFreq.Daily;break;case"week":I=RepeatFreq.Weekly;break;case"month":I=RepeatFreq.Monthly;break;case"year":I=RepeatFreq.Yearly;break;case"morning":I=RepeatFreq.Daily,f="9:00am";break;case"afternoon":I=RepeatFreq.Daily,f="2:00pm";break;case"night":I=RepeatFreq.Daily,f="7:00pm"}S=!0}else{var E,k=0,x=a.default.parseInt(this.trimPunc(l));for(0;(l.endsWith(",")||this.checkAndParse(B.delim))&&this.checkAndParse(B.date);){if(k++>5e3&&__infLoop&&__infLoop(k))throw new RangeError;var R=a.default.parseInt(this.trimPunc(l));R>0&&R<=31&&(E?E.push(R):E=[x,R])}E&&E.length>1?(E.sort(a.default.numberComparator),I=RepeatFreq.DayOfMonth,m=E[0],c=E,S=!0):x>0&&x<=31&&(isNaN(x)||(I=RepeatFreq.DayOfMonth,m=x,S=!0),this.checkAndParse(B.measure)?(I=U[l.toLowerCase()],b=x,m=void 0,S=!0):(this.checkAndParse(B.of),this.checkAndParse(B.month)&&(m=x,y=U[l.substr(0,3).toLowerCase()],I=RepeatFreq.Yearly,S=!0)))}var O=!1;this.checkAndParse(B.at)&&(O=!0),this.checkAndParse(B.time,2)&&(f=l,S=!0);var F,N,V,H=!1,W=!1;if(this.checkAndParse(B.in))W=!0,this.checkAndParse(B.month)&&(N=U[l.substr(0,3).toLowerCase()]),this.checkAndParse(B.year)&&(V=parseInt(l)),void 0===N&&void 0===V||(d=new Date,F=new Date,H=!0,V&&(d.setYear(V),d.setMonth(11),F.setYear(V),F.setMonth(0)),void 0!==N&&(void 0!==V&&(d.getMonth()>N&&d.addYears(1),F.getMonth()>N&&F.addYears(1)),d.setMonth(N),F.setMonth(N)),d.moveToLastDayOfMonth(),F.setDate(1));var G=q+1,j=q;this.checkAndParse(B.from)?(G=q+1,this.checkAndParseDate(i)&&(H&&!u.isAfter(F)||(F=u),H=!1,z=q)):z=q;var K=!1;O||f||(this.checkAndParse(B.at)&&(O=!0,K=!0),this.checkAndParse(B.time,2)&&(f=l,K=!0)),W||this.checkAndParse(B.until)&&this.checkAndParseDate(i)&&(d=u,K=!0),d&&d.isBefore(F)&&(S=!1)}else"everyday"===r&&(this.setDateTokens(r),S=!0,I=RepeatFreq.Daily,b=1);if(S){var Y=this.getRepeatStartDate(e),X=this.isFlagSet(s,ChangeType.Remote)?Y:F;if(c&&I===RepeatFreq.Weekly)for(var Q=0,J=(X||new Date).getDay(),Z=0;Z<c.length;++Z){if(Q++>5e3&&__infLoop&&__infLoop(Q))throw new RangeError;if(c[Z]>=J){p=c[Z];break}}var $=!!(w=this.computeStartDate(p,g,m,y,f,X));if(w&&(w.isBefore(_)&&($=!1),d&&d.isBefore(w)&&($=!1)),$){var ee,te,ie=!1,ae=r.substr(0,q);if(!n&&F&&e&&!H){te=r.substr(G,z);var ne=this.computeDateInfo(Y,void 0,i,i,s,[te]);ne.replacedDate&&(te=ne.text)}else n&&n!==v&&(this.isFlagSet(s,ChangeType.Text)||(te=h.a.formatDate(new Date(n),DFormat.MonthDayYear,i)));if(te)if(r.substr(G,z).toUpperCase()!==te.toUpperCase()){0;var se=h.a.parseDate(te,i);se&&(f&&this.updateDateWithTime(se,f),ae=ae.substr(0,j)+" from "+te+(K?ae.substr(z):""),ee=se.getTime(),ie=!0)}var re,oe=r.substr(0,q),le=h.a.getCurrentDateFormat();i!==le?(re=h.a.convertDateFormat(ae,i,le),ie=!0):re=ae,o={type:DateType.Repeat,repLength:q,oldText:oe,text:re,dateFormat:i,startDate:ee||w,endDate:d,frequency:I,separation:b,offsets:c,replacedDate:ie}}}return o},isInTag:function(e){for(var t=0,i=e.index;i>=0;i--){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(" "===e.input[i])return!1;if("#"===e.input[i])return!0}return!1},checkMultiplePrefixes:function(e){var t,i,a=0;for(C.lastIndex=0;null!==(i=C.exec(e));){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(t)i.index===t[0].length&&(e=e.substr(i.index));else{if(0!==i.index)break;t=i}}return e=e.replace(x,s.a.TextMDHR)},getSearchSpecialDate:function(e){return e===s.a.SearchDates.Overdue?e:e.startsWith(s.a.SearchDates.Before)?s.a.SearchDates.Before:e.startsWith(s.a.SearchDates.After)?s.a.SearchDates.After:void 0}};t.a=new G},function(e,t,i){"use strict";i.r(t);var a=i(0),n=i(1),s=i(4),r=i(8),o=i(49),l=i(14),d=i(3),u=i(17),c=i(27),h={None:0,Item:1,Multiselect:2,Overview:3};function f(){this.swipeMode=h.None,this.swipeX=0,this.swipePoints=[],this.multiselectAnimate=!1,this.multiselectOffset=new r.a(0),this.topBarMode=new r.a(n.a.TopBarMode.Normal),this._isDisabled=!1}f.prototype={init:function(){this.bottomBarHeight=new o.a([a.default.vmMain.gdriveStatusObs],this.getBottomBarHeight.bind(this))},isSwiping:function(){return this._isSwiping},disable:function(){this._isDisabled=!0},enable:function(){a.default.Assert(!0,"Should never enable MobileUI on desktop"),this._isDisabled=!1},isDisabled:function(){return this._isDisabled||a.default.isKeyboardOpen},start:function(e){if(this.enable(),a.default.focusedPane.isOverviewVisible()&&e.clientX>this.overviewWidth())return!0},update:function(e){if(!this.isDisabled()&&!l.default.draggingToOutline.get()){var t=a.default.getItemForElement(e.startSrc);this.swipeMode===h.None&&(a.default.focusedPane.isOverviewVisible()?this.swipeMode=h.Overview:Math.abs(e.distanceY)<a.default.ClickThreshold&&Math.abs(e.diffX)>a.default.ClickThreshold&&(this.isInMultiselect()?this.swipeMode=h.Multiselect:t&&a.default.isVMLI(t)&&!t.isNote()&&(this.swipeMode=h.Item)));var i=e.diffX;if(this.swipePoints.splice(0,0,{time:Date.now(),x:e.xThisFrame}),this.swipePoints.length>20&&this.swipePoints.splice(this.swipePoints.length-1,1),this.swipeMode===h.Multiselect)i=a.default.clamp(-n.a.RightMenuWidth+i,-n.a.RightMenuWidth,0),this.updateMultiselectPosition(i);else if(this.swipeMode===h.Overview)i=a.default.clamp(this.overviewWidth()+i,0,this.overviewWidth()),a.default.focusedPane.updatePosition(i,!1);else if(this.swipeMode===h.Item&&t){var r=a.default.getCellForElement(e.target);a.default.Assert(r,"Expected cell for swipe"),r&&(i=a.default.clamp(i,-s.a.windowWidth(),s.a.windowWidth()),r.isAnimatingOffsetX=!1,r.offsetX.set(i))}this.lastX=e.diffX}return this.swipeMode!==h.None&&e.preventDefault(),this.swipeMode!==h.None},onClickPane:function(e){var t=a.default.focusedPane;!this.isDisabled()&&t.isOverviewVisible()&&(d.a.closeKeyboard(),this.setOverviewVisibility(t,!1))},end:function(e){var t=a.default.focusedPane,i=this.swipeMode!==h.None;if(!this.isDisabled())if(this.swipeMode===h.Item){var r=a.default.getItemForElement(e.startSrc);if(r){var o=a.default.getCellForElement(e.target);if(a.default.Assert(o,"Expected cell and item for swipe"),o){var l=t.getSwipeMenuItem(r,o.offsetX.get());o.isAnimatingOffsetX=!0,o.offsetX.set(0),l.fn&&l.fn(r)}}}else if(this.swipeMode===h.Multiselect||this.swipeMode===h.Overview){for(var u,c,f=0,p=Date.now(),g=0,m=0,v=0;v<this.swipePoints.length;v++){if(f++>5e3&&__infLoop&&__infLoop(f))throw new RangeError;var _=this.swipePoints[v];if(!(p-_.time<300))break;g+=_.x,m=p-_.time}var y=g?g/(m/1e3):0;y<-200?u=0:y>200?u=1:this.swipeMode===h.Overview?u=Math.round((this.overviewWidth()+this.lastX)/s.a.windowWidth()):this.swipeMode===h.Multiselect&&(u=Math.round(this.lastX/n.a.RightMenuWidth)),this.swipeMode===h.Overview?(c=u>0,this.setOverviewVisibility(t,c),c&&d.a.closeKeyboard()):this.swipeMode===h.Multiselect&&(c=0===u,this.setMultiselectVisibility(c))}return this.swipeMode=h.None,this.swipePoints.length=0,i},setOverviewVisibility:function(e,t){e.updatePosition(t?this.overviewWidth():0,!0),e.overview.setVisibility(t)},toggleOverviewVisibility:function(e){var t=!(e=e||a.default.focusedPane).isOverviewVisible();this.setOverviewVisibility(e,t)},overviewWidth:function(){return Math.min(Math.floor(.85*s.a.windowWidth()),400)},isInMultiselect:function(){return 0!==this.multiselectOffset.get()},updateMultiselectPosition:function(e,t){this.multiselectAnimate=t,this.multiselectOffset.set(e),this.topBarMode.set(0!==e?n.a.TopBarMode.Multiselect:n.a.TopBarMode.Normal),0!==e&&d.a.closeKeyboard()},setMultiselectVisibility:function(e){this.updateMultiselectPosition(e?-n.a.RightMenuWidth:0,!0),e||(a.default.focusedPane.search.hideNonMatches(),u.a.reset())},setTopBarMode:function(e){this.topBarMode.set(e)},resetTopBarMode:function(){var e=this.topBarMode.get();e===n.a.TopBarMode.Multiselect?this.setMultiselectVisibility(!1):e===n.a.TopBarMode.Note&&(a.default.menus.closeContextMenu(),d.a.reset()),c.a.hide(),this.topBarMode.set(n.a.TopBarMode.Normal)},getBottomBarHeight:function(){return n.a.MobileBottomHeight+(a.default.vmMain.onlineText()?14:0)}},t.default=new f},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(4),r=i(8),o=i(35);function l(){this.sidebarTransitioning=!1,this.isDraggingSidebar=new r.a(!1),this.lightboxPosition=new r.a,this.lightboxSrc=new r.a,this.lightboxElement=void 0,this.sidebarChanged=new o.a}l.prototype={init:function(){this.showSidebar=new r.a(!s.a.isMailbirdSidebar()&&!a.default.isDemoInIframe()&&a.default.settings.get(Settings.showSidebar));var e=a.default.settings.get(Settings.sidebarWidth)||n.a.DesktopMenuWidthDefault;this._savedSidebarWidth=e===n.a.DesktopMenuWidthSmall?n.a.DesktopMenuWidthDefault:e,this.sidebarWidth=new r.a(e)},toggleSidebar:function(e){this.sidebarTransitioning=!0;var t=void 0!==e?e:!this.showSidebar.get();t&&(!0===e&&this._savedSidebarWidth===n.a.DesktopMenuWidthSmall&&(this._savedSidebarWidth=n.a.DesktopMenuWidthDefault),this.sidebarWidth.set(this._savedSidebarWidth)),this._setSidebarVisible(t),this.sidebarChanged.notify()},minimize:function(){this.sidebarTransitioning=!0;var e=n.a.DesktopMenuWidthSmall;a.default.settings.set(Settings.sidebarWidth,e),this.sidebarWidth.set(e),this.sidebarChanged.notify()},restore:function(){this.toggleSidebar(!0),a.default.settings.set(Settings.sidebarWidth,this.sidebarWidth.get())},getSidebarWidth:function(){return s.a.isMailbirdSidebar()||!this.showSidebar.get()?0:this.sidebarWidth.get()},setSidebarWidthMoving:function(e){this.showSidebar.set(!0),this.sidebarTransitioning=!1,this.isDraggingSidebar.set(!0),this.sidebarWidth.set(e)},setSidebarWidthUp:function(){var e=this.sidebarWidth.get();e<20?e=0:e<n.a.DesktopMenuWidthMinBig&&(e=n.a.DesktopMenuWidthSmall),e!==this.sidebarWidth.get()&&(this.sidebarTransitioning=!0,this.sidebarWidth.set(e)),e>0&&(this._savedSidebarWidth=e,a.default.settings.set(Settings.sidebarWidth,e)),this._setSidebarVisible(e>0),this.isDraggingSidebar.set(!1),this.sidebarChanged.notify()},_setSidebarVisible:function(e){a.default.settings.set(Settings.showSidebar,e),this.showSidebar.set(e)},shouldShowTopBar:function(){return!this.showSidebar.get()||s.a.isNativeMac()&&this.sidebarWidth.get()<n.a.DesktopMenuWidthMinBig},topBarHeight:function(){return this.shouldShowTopBar()?32:0}},t.a=new l},function(e,t,i){"use strict";i.r(t);var a=i(0),n=i(1),s=i(4),r=i(6),o=i(7),l=i(3),d=i(28),u=i(24),c=(i(27),i(19)),h=i(25);function f(){}var p={None:0,Left:1,Right:2,StartLine:3,EndLine:4,LeftWord:5,RightWord:6,Down:7,Up:8,PageDown:9,PageUp:10,Top:11,Bottom:12,PrevHeader:13,NextHeader:14,All:15},g=[KeyCode.Tab,KeyCode.Backspace,KeyCode.Delete],m=[KeyCode.UpArrow,KeyCode.DownArrow,KeyCode.LeftArrow,KeyCode.RightArrow,KeyCode.Home,KeyCode.End,KeyCode.A,KeyCode.E,KeyCode.F,KeyCode.B,KeyCode.PageUp,KeyCode.PageDown];f.prototype={getNavigationAction:function(e){var t=s.a.mac,i=e.ctrlKey&&!e.altKey&&!e.metaKey,a=e.altKey&&!e.ctrlKey&&!e.metaKey,n=e.metaKey&&!e.ctrlKey&&!e.altKey,r=!e.ctrlKey&&!e.altKey&&!e.metaKey,o=e.normCode,l=KeyCode,d=p;if(o===l.LeftArrow){if(i&&!s.a.mac||a&&s.a.mac)return d.LeftWord;if(n&&t)return d.StartLine;if(r)return d.Left}if(o===l.RightArrow){if(i&&!s.a.mac||a&&s.a.mac)return d.RightWord;if(n&&t)return d.EndLine;if(r)return d.Right}if(o===l.UpArrow){if(t&&n)return d.Top;if(t&&i)return d.PageUp;if(t&&a)return d.StartLine;if(!t&&i)return d.PrevHeader;if(r)return d.Up}if(o===l.DownArrow){if(t&&n)return d.Bottom;if(t&&i)return d.PageDown;if(t&&a)return d.EndLine;if(!t&&i)return d.NextHeader;if(r)return d.Down}if(o===l.A&&i&&t)return d.StartLine;if(o===l.E&&i&&t)return d.EndLine;if(o===l.B&&i&&t)return d.Left;if(o===l.F&&i&&t)return d.Right;if(o===l.Home&&!t){if(i)return d.Top;if(r)return d.StartLine}if(o===l.End&&!t){if(i)return d.Bottom;if(r)return d.EndLine}return o===l.PageUp&&r?d.PageUp:o===l.PageDown&&r?d.PageDown:o===l.A&&n&&t||o===l.A&&i&&!t?d.All:d.None},updateAutocomplete:function(e){e&&e.normCode&&m.indexOf(e.normCode)>=0&&e.key},stopPropagation:function(e){a.default.Assert(e.stopImmediatePropagation,"Should always be defined"),e.stopImmediatePropagation&&e.stopImmediatePropagation()},preventDefault:function(e){a.default.Assert(e.preventDefault,"Should always be defined"),e.preventDefault&&e.preventDefault()},keyup:function(e,t){if(l.a.scrollStartIntoView(s.a.ios),this.stopPropagation(t),this.preventDefault(t),this.isTyping=!1,t.handled)return!0},handleSelectAll:function(e){var t=e.indexOfFirstItem(),i=e.indexOfLastItem();return l.a.selectIndices(t,0,i,-1,n.a.SelectOption.AllowPrefix),!1},handleSelectAllItem:function(){if(a.default.focusedPane&&a.default.focusedPane.isWriteable)return l.a.selectIndex(l.a.getStartIndex(),0,-1),!1},_move:function(e,t){a.default.Assert(e===Direction.Up||e===Direction.Down,"Must move in a direction");var i,s,r=a.default.focusedPane,d=l.a.getStartIndex(),u=l.a.getEndIndex(),c=l.a.getStartItem(),f=l.a.getEndItem(),p=!1;if((c.parent()===f.parent()&&(p=!0),!p)&&!r.getNextItem(l.a.getEndIndex(),!0))for(var g=0;f;){if(g++>5e3&&__infLoop&&__infLoop(g))throw new RangeError;if(c.parent()===f.parent()){p=!0;break}f=f.parent()}if(p&&(e===Direction.Up?(i=r.getPreviousItem(d,!0),s=f.getIndex()+1):(i=r.getNextItem(u,!0),s=c.getIndex()),i)){o.a.beginAction(),r.setIgnoreRestoreScroll();var m=l.a.save();l.a.reset();var v=1+i.numChildrenRecursive();a.default.vmMain.setItemAnimationMode(n.a.ItemAnimationMode.Move),this.isInCompoundOperation&&h.a.beginBatch(i.parent()),i.moveTo({parent:i.parent(),index:s},ChangeType.Local),a.default.vmMain.resetItemAnimationMode(),e===Direction.Up?(m.startIndex-=v,m.endIndex-=v):e===Direction.Down&&(m.startIndex+=v,m.endIndex+=v),l.a.restore(m),e===Direction.Up?l.a.scrollStartIntoView():l.a.scrollEndIntoView(),o.a.endAction()}},moveUp:function(e){!a.default.focusedPane.isViewAgenda()&&l.a.isValid()&&this._move(Direction.Up,e)},moveDown:function(e){!a.default.focusedPane.isViewAgenda()&&l.a.isValid()&&this._move(Direction.Down,e)},handleArrows:function(e,t){var i=a.default.focusedPane;if(!l.a.isValid())return!0;var n=this.getNavigationAction(t),r=p;switch(l.a.preferLineStart=!1,n){case r.Left:case r.Right:case r.StartLine:case r.EndLine:case r.LeftWord:case r.RightWord:var o,c,h,f,g=n===r.Left||n===r.LeftWord||n===r.StartLine,m=n===r.Right||n===r.RightWord||n===r.EndLine;if(g&&(!t.shiftKey||l.a.isArrowSelectInverted())||m&&t.shiftKey&&l.a.isArrowSelectInverted()||n===r.StartLine&&l.a.getStartIndex()===l.a.getEndIndex()?(C=l.a.getStartOffset(),M=l.a.getStartIndex(),h=l.a.getStartTotal(),o=l.a.getStartObject()):(C=l.a.getEndOffset(),M=l.a.getEndIndex(),h=l.a.getEndTotal(),o=l.a.getEndObject()),c=(H=o.item).getParsedText(),n===r.StartLine)k=(v=u.default.getCaretOffset(o,i,C)).lineStart,M=l.a.isArrowSelectInverted()?l.a.getStartIndex():l.a.getEndIndex(),h=l.a.isArrowSelectInverted()?l.a.getStartTotal():l.a.getEndTotal();else if(n===r.EndLine){var v=u.default.getCaretOffset(o,i,C);H.metricsInPane(i,M);k=v.lineStart+v.lineLength,M=l.a.isArrowSelectInverted()?l.a.getStartIndex():l.a.getEndIndex()}else if(n===r.LeftWord){var _=d.a.getPreviousWord(H,c,C-1),y=c.prevIndexOf(window.AttachChar,C);if(y<0||y<=_)if(-1===_&&0===C)if(a.default.settings.selectFullItems()&&t.shiftKey)k=0;else if(M>0){if((M=i.indexOfPrevVMLI(M,!1,!0))>=0){var S=i.itemAtIndex(M).getParsedText();k=d.a.getPreviousWord(H,S,S.length-1)+1,h=S.length}}else k=-1;else k=_+1;else y>_&&(k=y+1,y+1===C&&k--)}else if(n===r.RightWord){var w=d.a.getNextWord(H,c,C+1),I=c.indexOf(window.AttachChar,C);if(I<0||I>=w)if(w===h)if(C!==h||t.shiftKey&&a.default.settings.selectFullItems())k=h;else if(M<i.numItems()-1){if((M=i.indexOfNextVMLI(M,!1,!0))>=0){var b=(f=i.itemAtIndex(M)).getParsedText();w=d.a.getNextWord(f,b,0),h=b.length,-1===w&&(w=b.length),k=w}}else k=h+1;else k=w;else(w>I||w<0)&&I>=0&&(k=I,I===C&&k++)}else n===r.Left?k=l.a.getStartOffset()===l.a.getEndOffset()||t.shiftKey?d.a.moveLeft(H,C):l.a.getStartOffset():n===r.Right&&(k=l.a.getStartOffset()===l.a.getEndOffset()||t.shiftKey?d.a.moveRight(H,C,h):l.a.getEndOffset());if(l.a.preferLineStart=g,!(f||a.default.settings.selectFullItems()&&t.shiftKey))if(k<l.a.getStartItem().getPrefixLength()&&n!==r.StartLine)if(l.a.preferLineStart=!1,M>0)M=i.indexOfPrevVMLI(M,!1,!0),k=(E=i.itemAtIndex(M)).getParsedText().length,d.a.isInsideMarkup(E,k)&&(k=d.a.moveLeft(E,k));else k=0;else k>h&&(M<i.numItems()-1?(M=i.indexOfNextVMLI(M,!1,!0),k=0):k=h);if(t.shiftKey){var A=l.a.isArrowSelectInverted()?l.a.getEndIndex():l.a.getStartIndex(),D=l.a.isArrowSelectInverted()?l.a.getEndOffset():l.a.getStartOffset();!l.a.isArrowSelectInverted()&&g&&M<=l.a.getStartIndex()&&k>=-1&&k<l.a.getStartOffset()?l.a.setArrowSelectInverted(!0):l.a.isArrowSelectInverted()&&m&&M>=l.a.getEndIndex()&&k>l.a.getEndOffset()&&l.a.setArrowSelectInverted(!1),l.a.isArrowSelectInverted()?l.a.selectIndices(M,k,A,D):l.a.selectIndices(A,D,M,k)}else l.a.selectIndex(M,k);if(s.a.isFirefox)if(t.normCode===KeyCode.LeftArrow){if(H.getParsedText()[l.a.getStartOffset()-1]===window.AttachChar&&!t.shiftKey)return l.a.selectItem(H,l.a.getStartOffset()-1),!1}else if(t.normCode===KeyCode.RightArrow){if(H.getParsedText()[l.a.getEndOffset()]===window.AttachChar&&!t.shiftKey)return l.a.selectItem(H,l.a.getEndOffset()+1),!1}g?l.a.scrollStartIntoView():l.a.scrollEndIntoView();break;case r.Up:case r.Down:case r.Top:case r.Bottom:case r.PageUp:case r.PageDown:case r.PrevHeader:case r.NextHeader:var T,M,C,L=n===r.Up||n===r.Top||n===r.PageUp,P=n===r.Down||n===r.Bottom||n===r.PageDown;L&&(!t.shiftKey||l.a.isArrowSelectInverted())||P&&t.shiftKey&&l.a.isArrowSelectInverted()?(C=l.a.getStartOffset(),M=l.a.getStartIndex(),T=l.a.getStartObject()):(C=l.a.getEndOffset(),M=l.a.getEndIndex(),T=l.a.getEndObject());E=T.item;var E,k,x=u.default.getCaretOffset(T,i,C),R=u.default.getCaretScreenPosition(i,M,C),O=(x.lineOffset,R.left);if(l.a.preferLineStart=x.lineOffset<=2,n===r.Up){var F=x.line-1;if(0===M&&F<0)k=0,F=0;else{if(F<0&&M>0)if((M=i.indexOfPrevVMLI(M,!1,!0))>=0)E=i.itemAtIndex(M),T=i.objectAtIndex(M),F=u.default.getCaretOffset(T,i).line;F>=0&&(k=u.default.getOffsetForScreenPositionInLine(M,T,i,F,O))}}else if(n===r.Down){(F=x.line+1)>E.metricsInPane(i,M).styledLines.length-1&&(M<i.numItems()-1&&(M=i.indexOfNextVMLI(M,!1,!0))>=0?(E=i.itemAtIndex(M),F=0):F=x.line),M>=0&&(T=i.objectAtIndex(M),k=u.default.getOffsetForScreenPositionInLine(M,T,i,F,O))}else if(n===r.Top)M=i.indexOfFirstItem(),k=0;else if(n===r.Bottom){var N=i.getLastItem(),B=i.numItems();N&&B>0&&(M=i.indexOfLastItem(),k=N.getParsedText().length)}else if(n===r.PageUp){M=i.indexPageUp(l.a.getStartIndex()),k=0}else if(n===r.PageDown){var U=i.indexPageDown(l.a.getStartIndex());M=U,k=(H=i.itemAtIndex(U)).getParsedText().length}else{if(n===r.PrevHeader&&i.isViewOutline()){if((H=l.a.getStartItem()).parent()===a.default.focusedItem)H.isFirstChild()||(a.default.Assert(H.getIndex()>0,"Should never hit this with the first item in the list"),q=H.parent().getChild(H.getIndex()-1));else{for(var V=0;H.parent()!==a.default.focusedItem;){if(V++>5e3&&__infLoop&&__infLoop(V))throw new RangeError;H=H.parent()}q=H}return void 0!==q&&l.a.selectItem(q,-1),!1}if(n===r.NextHeader&&i.isViewOutline()){var H,q;if((H=l.a.getEndItem()).parent()===a.default.focusedItem)H.isLastChild()||(q=H.parent().getChild(H.getIndex()+1));else{for(var z=0;H.parent()!==a.default.focusedItem;){if(z++>5e3&&__infLoop&&__infLoop(z))throw new RangeError;H=H.parent()}H.isLastChild()||(q=H.parent().getChild(H.getIndex()+1))}return void 0!==q&&l.a.selectItem(q,-1),!1}}if(M>=0&&!isNaN(k))if(t.shiftKey){A=l.a.isArrowSelectInverted()?l.a.getEndIndex():l.a.getStartIndex(),D=l.a.isArrowSelectInverted()?l.a.getEndOffset():l.a.getStartOffset();!l.a.isArrowSelectInverted()&&L&&(M===l.a.getStartIndex()&&k<l.a.getStartOffset()||M<l.a.getStartIndex())?l.a.setArrowSelectInverted(!0):l.a.isArrowSelectInverted()&&P&&(M===l.a.getEndIndex()&&k>l.a.getEndOffset()||M>l.a.getEndIndex())&&l.a.setArrowSelectInverted(!1),l.a.isArrowSelectInverted()?l.a.selectIndices(M,k,A,D):l.a.selectIndices(A,D,M,k)}else l.a.selectIndex(M,k);L?l.a.scrollStartIntoView():l.a.scrollEndIntoView();break;case r.All:this.handleSelectAll(i)}return n===r.None},keydown:function(e,t){this.isTyping=!0;var i=!0;if(g.indexOf(t.normCode)>=0?i=this.keypress(e,t,!0):s.a.mac&&t.ctrlKey&&t.normCode===KeyCode.D?i=this.keypress(e,t,!0):m.indexOf(t.normCode)>=0?(a.default.vmMain.setItemAnimationMode(n.a.ItemAnimationMode.None),i=this.handleArrows(e,t),a.default.vmMain.resetItemAnimationMode(),s.a.ios||this.getNavigationAction(t)&&this.updateAutocomplete(t)):s.a.mac&&t.metaKey||!s.a.mac&&t.ctrlKey&&!t.altKey?t.normCode!==KeyCode.Y&&t.normCode!==KeyCode.Z||(i=this.keypress(e,t,!0)):s.a.mac&&t.ctrlKey&&t.normCode===KeyCode.H&&this.preventDefault(t),i&&l.a.getStartIndex()===l.a.getEndIndex()&&l.a.getStartOffset()===l.a.getEndOffset()){var r=l.a.getStartOffset(),o=l.a.getStartItem(),u=o.getParsedText();0,"]"===u[r]&&d.a.isInsideMarkup(o,r)&&(r=d.a.moveRight(o,r,u.length-1),l.a.selectIndex(l.a.getStartIndex(),r),l.a.focusHiddenInput())}return i},checkKeypressSpecialCases:function(e,t){var i;return e.ctrlKey&&e.altKey&&t?i=!0:e.metaKey&&e.normCode===KeyCode.Tilde&&(i=!1),i},isMultiselectDangerous:function(){var e=0,t=a.default.focusedPane;if(!t.isViewOutline()&&!t.isViewProject())return"Are you sure you want to delete multiple items?";for(var i=t.indexOfNextVMLI(l.a.getStartIndex()-1),n=t.indexOfPrevVMLI(l.a.getEndIndex()+1),s=i,r=0;!isNaN(s)&&s>=0&&s<=n;){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var o=t.itemAtIndex(s);if(t.isSearchedFlat()){if(t.search.isFlatSearchResult(o)&&r++,r>=2)return MessageID.FlatSearchMultiSelect}else if(++r>=8)return"You have selected a large number of items to delete. Are you sure?";s=t.indexOfNextVMLI(s)}return!1},keypress:function(e,t,i,n){var r=[KeyCode.Enter,KeyCode.D];a.default.Assert(t.stopPropagation,"Should always be defined"),t.stopPropagation&&t.stopPropagation();var d=!0,u=a.default.focusedPane,c=t.normCode>=32||r.indexOf(t.normCode)>=0;if(!(0===t.which)&&(i||c)){if(s.a.mac&&t.metaKey||!s.a.mac&&t.ctrlKey)switch(String.fromCharCode(t.normCode)){case"c":case"C":return t.handled=!0,!0;case"v":case"V":return t.handled=!0,!0;case"x":case"X":return t.handled=!0,!0;case"Y":case"y":case"Z":case"z":return a.default.Assert(!1,"Should not be handled undo/redo hotkeys here"),t.handled=!0,!0;case"r":case"R":case"a":case"A":case"t":case"T":return t.handled=!0,!0}var h=l.a.getStartItem();o.a.beginAction();var f=[KeyCode.Tab,KeyCode.Enter,KeyCode.Backspace,KeyCode.Delete,KeyCode.D];if(l.a.getStartIndex()!==l.a.getEndIndex()&&t.normCode!==KeyCode.Tab&&(!t.metaKey&&!t.ctrlKey&&!t.altKey||f.indexOf(t.normCode)>=0))if(u.isViewOutline()||u.isViewProject()){var p;if(a.default.vmMain.beginUpdateItems(),!n&&(p=this.isMultiselectDangerous())){if(u.isSearchedFlat())a.default.toasts.pushMessage(MessageID.FlatSearchMultiSelect);else{var g=l.a.save();a.default.menus.confirm(p,function(a){l.a.restore(g),a&&this.keypress(e,t,i,!0)}.bind(this))}d=!1}else d=!!u.isEditable&&(d&&this.handleMultiselect(t));a.default.vmMain.commitUpdateItems()}else a.default.toasts.pushMessage({text:"Editing multiple items from this view is not currently supported. Please edit them individually.",actionText:"OKAY"}),d=!1;d&&f.indexOf(t.normCode)>=0&&(a.default.vmMain.beginUpdateItems(),t.normCode===KeyCode.Enter?d=!!u.isEditable&&(d&&this.handleEnter(t)):t.normCode===KeyCode.Backspace?d=!!(h&&h.allowTextEditing()&&u.isEditable)&&(d&&this.handleBackspace(t)):(t.normCode===KeyCode.Delete||s.a.mac&&t.ctrlKey&&t.normCode===KeyCode.D)&&(d=!!(h&&h.allowTextEditing()&&u.isEditable)&&(d&&this.handleDelete(t))),a.default.vmMain.commitUpdateItems()),o.a.endAction()}return d},handleMultiselect:function(e){var t=0,i=0,s=a.default.focusedPane,r=s.indexOfNextVMLI(l.a.getStartIndex()-1),d=s.indexOfPrevVMLI(l.a.getEndIndex()+1),u=l.a.getStartOffset(),c=l.a.getEndOffset();l.a.selectIndices(r,u,d,c,n.a.SelectOption.AllowPrefix);var f=!0,p=s.objectAtIndex(r),g=l.a.getStartItem(),m=l.a.getEndItem();if(g.isNote()&&(g=g.parent()),m.isNote()&&(m=m.parent()),!s.hasNonVMLIs&&g===m)return!1;if(e.normCode===KeyCode.Enter&&e.shiftKey)return!0;for(var v=[],_=(d=d,s.indexOfNextVMLI(r));_&&_>=0&&(_<d||_===d&&l.a.getEndOffset()===l.a.getEndTotal());){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;(x=s.itemAtIndex(_)).parent()===a.default.focusedPane.getItem()&&x.isHeader()&&0,v.indexOf(x)<0&&x!==g&&v.push(x),_=s.indexOfNextVMLI(_)}var y,S=l.a.getEndItem().levelsDeep.get()-l.a.getStartItem().levelsDeep.get();if(l.a.getStartOffset()>0||l.a.getEndOffset()<l.a.getEndTotal()){var w=g.splitUsableText(g.getParsedText(),u,u),I=m.splitUsableText(m.getParsedText(),c,c);y=w.before+I.after,o.a.performAction(TrackerType.Remove,{itemID:g.id,position:l.a.getStartOffset(),text:g.getParsedText().slice(l.a.getStartOffset())}),o.a.performAction(TrackerType.Insert,{itemID:g.id,position:l.a.getStartOffset(),text:m.getParsedText().substring(l.a.getEndOffset())}),v.indexOf(m)<0&&v.push(m),0===l.a.getStartOffset()&&g.copyProperties(m)}else o.a.performAction(TrackerType.Remove,{itemID:g.id,position:0,text:g.getParsedText()}),y="";if(e.normCode!==KeyCode.Backspace&&e.normCode!==KeyCode.Delete&&e.normCode!==KeyCode.Enter||(f=!1),g.setText(y,!0,ChangeType.Local),m.moveChildren(g,0,ChangeType.Local),S>0){for(var b=0,A=[],D=m.nextSibling();S>0&&D;){if(b++>5e3&&__infLoop&&__infLoop(b))throw new RangeError;_=D.getIndex();var T=D.parent().getItems().slice(_);A=A.concat(T),D=D.parent().nextSibling(),S--}if(A.length>0)for(var M=0,C=g,L=(_=0,0);L<A.length;L++){if(M++>5e3&&__infLoop&&__infLoop(M))throw new RangeError;var P=(x=A[L]).parent();if(v.indexOf(P)>=0){var E=x.getIndex();this.isInCompoundOperation&&(h.a.beginBatch(x.parent()),h.a.beginBatch(C)),x.moveTo({parent:C,index:_},ChangeType.Local),o.a.performAction(TrackerType.Move,{itemID:x.id,oldParent:P.id,oldPosition:E,newParent:C.id,newPosition:_}),_++}}}else if(v.indexOf(m.parent())>=0)for(var k=0,x=(C=g.parent(),s.getNextItem(d,!0));x;){if(k++>5e3&&__infLoop&&__infLoop(k))throw new RangeError;_=C.numItems(),E=(P=x.parent()).getChildIndex(x);this.isInCompoundOperation&&(h.a.beginBatch(x.parent()),h.a.beginBatch(C)),x.moveTo({parent:C,index:_},ChangeType.Local),o.a.performAction(TrackerType.Move,{itemID:x.id,oldParent:P.id,oldPosition:E,newParent:C.id,newPosition:_}),x=s.getNextItem(d,!0)}for(L=0;L<v.length;L++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;x=v[L];a.default.Assert(x,"Item must exist"),x.isDeleted()||x.parent().deleteChild(x,void 0,void 0,ChangeType.Local)}if(s.hasNonVMLIs){var R=s.closestIndexOfObject(p);a.default.Assert(R>=0,"Could not find item to select"),R>=0&&l.a.selectIndex(R,u)}else l.a.selectIndex(r,u);return f},handleTab:function(e){var t=0,i=l.a.getPane(),n=l.a.getStartItem(),s=l.a.getStartIndex(),r=l.a.getEndItem(),d=l.a.getStartObject(),u=(l.a.getEndObject(),l.a.getStartOffset(),l.a.getEndOffset(),!e),c=u?0:1;if(d.levelsDeep<c)return!1;if(u&&i.isViewAutoBlocks()&&d.levelsDeep===c){var f=i.prevPaneObjectAtSameLevel(s);if(!f||f.block!==d.block||f.item.parent()!==n.parent())return!1}a.default.vmMain.beginUpdateItems(),n&&n.isNote()&&(n=n.parent()),r&&r.isNote()&&(r=r.parent()),l.a.scrollStartIntoView();var p=n,g={},m=[n],v={},_={};if(_[n.id]=!0,n!==r){var y=0;do{if(y++>5e3&&__infLoop&&__infLoop(y))throw new RangeError;(p=a.default.getNextItem(p,i,{numLevels:0,ignoreSearch:!0}))&&(m.push(p),_[p.id]=!0)}while(p!==r&&void 0!==p)}var S,w,I,b=0;for(e?(S=function(){b=m.length-1},w=function(){return b>=0},I=function(){b--}):(S=function(){b=0},w=function(){return b<m.length},I=function(){b++}),S();w();I()){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var A=m[b];a.default.Assert(A,"Must always be tabbing/untabbing valid items");var D,T,M=A.parent(),C=M.getItems().indexOf(A);if(u){var L=0,P=void 0;if(D=C>0&&!d.isBlockHeader,i.search.isFlatSearchResult(A)&&(D=!1,a.default.toasts.pushMessage(MessageID.FlatSearchTab)),D)if(d.block){var E=i.prevPaneObjectAtSameLevel(s+b);E&&E.item&&(P=E.item,!0)}else P=M.itemAtIndex(C-1);if(D&&P){for(var k=0;P.isHidden(i);){if(k++>5e3&&__infLoop&&__infLoop(k))throw new RangeError;if(--C<=0)return a.default.vmMain.commitUpdateItems(),!1;P=M.itemAtIndex(C-1)}v[M.id]||(g[A.parent().id]=A.parent(),g[P.id]=P,this.isInCompoundOperation&&(h.a.beginBatch(A.parent()),h.a.beginBatch(P)),A.moveTo({parent:P,fromTab:!0},ChangeType.Local),P.isCollapsed(i,!1)&&P.setCollapsed(!1,i)),v[A.id]=!0,o.a.performAction(TrackerType.Move,{itemID:A.id,oldParent:M.id,oldPosition:C,newParent:P.id,newPosition:P.numItems()-1})}else P=M,v[A.id]=v[M.id];for(var x=!1,R=A;R;){if(L++>5e3&&__infLoop&&__infLoop(L))throw new RangeError;if(v[R.id]){R.isCollapsed(i,!1)||(x=!0);break}R=R.parent()}var O=A.getIndex()+1;if(x){var F=0,N=A.getItems(),B=0;for(T=0;T<N.length;T++){if(F++>5e3&&__infLoop&&__infLoop(F))throw new RangeError;var U=N[T];if(!_[U.id]){if(U.isHidden(i,!1))continue;g[U.parent().id]=U.parent(),g[A.parent().id]=A.parent();var V=O+B;this.isInCompoundOperation&&(h.a.beginBatch(A.parent()),h.a.beginBatch(U.parent())),U.moveTo({parent:A.parent(),index:V,fromTab:!0},ChangeType.Local),v[U.id]=!0,o.a.performAction(TrackerType.Move,{itemID:U.id,oldParent:A.id,oldPosition:T,newParent:A.parent().id,newPosition:V}),B++,T--}}}}else if(D=A.parent()!==a.default.focusedItem&&!(i.isViewProject()&&d.block.id!==i.blockNoKey&&A.parent().parent()===a.default.focusedItem),(i.search.isFlatSearchResult(A)||i.search.isFlatSearchResult(A.parent()))&&(D=!1,a.default.toasts.pushMessage(MessageID.FlatSearchTab)),D){var H=0,q=A.parent().parent(),z=M.getItems();for(T=C+1;z[C+1];){if(H++>5e3&&__infLoop&&__infLoop(H))throw new RangeError;var W=z[C+1];_[W.id]||W.isHidden(i)?C++:(g[W.parent().id]=W.parent(),g[A.id]=A,this.isInCompoundOperation&&(h.a.beginBatch(A),h.a.beginBatch(W.parent())),W.moveTo({parent:A,fromTab:!0},ChangeType.Local),v[W.id]=!0,o.a.performAction(TrackerType.Move,{itemID:W.id,oldParent:M.id,oldPosition:T,newParent:A.id,newPosition:A.numItems()-1})),T++}if(_[M.id]>=0&&(!M.parent()||M.parent()!==a.default.focusedItem))continue;var G=q.getItems().indexOf(M);g[A.parent().id]=A.parent(),g[q.id]=q,this.isInCompoundOperation&&(h.a.beginBatch(q),h.a.beginBatch(A.parent())),A.moveTo({parent:q,index:G+1,fromTab:!0},ChangeType.Local),v[A.id]=!0,o.a.performAction(TrackerType.Move,{itemID:A.id,oldParent:M.id,oldPosition:C,newParent:q.id,newPosition:G+1})}}i.setIgnoreRestoreScroll(),a.default.vmMain.commitUpdateItems(!1,!1)},handleEnter:function(e){var t=a.default.focusedPane,i=l.a.getStartItem(),u=l.a.getStartObject(),h=l.a.getStartIndex(),f=l.a.getStartOffset(),p=l.a.getStartTotal(),g=l.a.getEndItem(),m=l.a.getEndOffset(),v=l.a.getEndTotal();if(!i)return a.default.Assert(!1,"Invalid item in handleEnter"),!1;var _=i.parent();if(!_)return a.default.Assert(!1,"Invalid parent in handleEnter"),!1;var y,S=_.getItems().indexOf(i),w=i.getParsedText(),I=!1,b=_;if(t.clearPreventUpdate(),t.setIgnoreRestoreScroll(),e.shiftKey)return e.preventDefault(),!1;if(i.isNote())0;else{if(t.search.isFlatSearchResult(i))return a.default.toasts.pushMessage(MessageID.FlatSearchEnter),e.preventDefault(),!1;if(t.isViewProject()&&t.isItemTopLevel(u,i)&&i.hasChildren()&&0===i.getChild(0).getParsedTextWithoutPrefix().length)l.a.selectIndex(h+1,0);else if(i.shouldCopyPrefix()&&w===i.getPrefix())i.setText("",!0,ChangeType.Local),l.a.selectIndex(h,0);else{if(!i.getPrefix()||f!==i.getPrefixLength()||m!==v){var A,D,T=!0,M=!1,C=!1,L={text:""},P=u.block;if(t.setIgnoreRestoreScroll(),t.isViewTag()&&i.getParsedText().indexOf(u.block.text)>=0&&(A=u.block.text,D=i.getParsedText()[i.getPrefixLength()]===n.a.TagPrefix?0:-1),d.a.isInsideMarkup(i,f)&&(f=d.a.moveRight(i,f,w.length)),!t.isViewAgenda()||0!==u.levelsDeep||i.hasVisibleChildren(t)&&!i.isCollapsed(t))if(i.hasAttachmentType(n.a.PluginType.Calendar));else if(m===g.getPrefixLength()&&""!==w)S--,T=!1,M=!0;else if(f>=p)(I=!i.isCollapsed(t,!1)&&(i.getVisibleChildren(t).length>0||i.isPrefixHeader()))&&(b=i);else if(f===i.getPrefixLength()&&m===v)i.setText(i.getPrefix(),!0,ChangeType.Local),o.a.performAction(TrackerType.Remove,{itemID:i.id,position:0,text:w});else{var E=i.splitUsableText(w,f,m);A&&E.before.indexOf(E)<0&&(0===D?E.before=A+" "+E.before:E.before+=" "+A),L.text=E.after,a.default.vmMain.setItemAnimationMode(n.a.ItemAnimationMode.Move),i.setText(E.before,!0,ChangeType.Local),o.a.performAction(TrackerType.Remove,{itemID:i.id,position:0,text:w.substring(0,m)}),C=!0,(I=!i.isCollapsed(t,!1)&&(i.numItems()>0||i.isHeader()))&&(b=i)}else{if(P.isStarred)L.isStarred=!0;else if(P.isImportant)L.priority=i.priority();else if(P.isDate&&P.date){var k=void 0;k=!i.getDateText()||i.repeatDate()||i.isComplete()?i.isComplete()?c.a.getAppendDateText(P.date):c.a.getAppendDateText(P.date)+" "+i.time():i.getDateText(),L.text=" "+n.a.DatePrefix+k}else L.text=" "+P.id;i.shouldSave()||(b=r.default.getRootModel(),S=-1)}!I&&A&&L.text.indexOf(A)<0&&(0===D?L.text=A+" "+L.text:L.text+=" "+A);var x=a.default.settings.get(Settings.defaultItemPrefix);I||!i.shouldCopyPrefix()&&!C?(!I||I&&x&&(i.isPrefixHeader()||i.shouldCopyPrefix()&&i.prefix===x))&&(L.text=(x&&x+" ")+L.text):L.text=i.getPrefix()+L.text,y=t.createVMLI(L,{parent:b,changeType:ChangeType.AllLocal,isEditable:!0}),C&&y.copyProperties(i),y.parseText(!0,ChangeType.Local|ChangeType.All),a.default.vmMain.itemBeingModified={item:y,action:"added"},I?(i.insertItem(y,0),o.a.performAction(TrackerType.Create,{itemID:y.id,parent:i.id,position:0,text:y.getParsedText()})):(a.default.Assert(!y.isNote(),"Should never be inserting a note here"),b.insertItem(y,S+1),o.a.performAction(TrackerType.Create,{itemID:y.id,parent:b.id,position:S+1,text:y.getParsedText()})),a.default.vmMain.resetItemAnimationMode();var R=T?y:i;a.default.Assert(R,"Expected another item to exist");var O=t.closestIndexOfObject(u),F=T?t.indexOfItem(y,P):M?O-1:O,N=R.shouldCopyPrefix()&&R.getPrefixLength()||0;return F>=0&&l.a.selectIndex(F,N,N,s.a.android&&n.a.SelectOption.Delay),a.default.Assert(e.preventDefault,"Should always be defined"),e.preventDefault&&e.preventDefault(),a.default.vmMain.itemBeingModified=void 0,!1}i.setText(i.getPrefix(),!0,ChangeType.Local),l.a.selectIndex(h,0),o.a.performAction(TrackerType.Remove,{itemID:i.id,position:0,text:w})}}},handleBackspace:function(e){var t=l.a.getStartItem(),i=l.a.getStartIndex(),r=l.a.getStartOffset(),u=l.a.getEndOffset(),c=l.a.getStartObject(),h=a.default.focusedPane,f=r===u;if(!t)return a.default.Assert(!1,"Invalid item in handleBackspace"),!1;var p=t.parent();a.default.Assert(p,"Must always have a valid parent for an item"),s.a.ie&&(e.preventDefault(),e.stopImmediatePropagation());var g=t.getParsedText(),m="",v=0,_=!0,y=t.hasAttachmentType(n.a.PluginType.Calendar);if(0===r&&0===u||""===g)if(c.isBlockHeader&&t.hasChildren())_=!1;else if(t.isNote()&&""!==g)_=!1;else if(y)_=!1;else if(l.a.getStartIndex()>0){var S=a.default.focusedPane.indexOfPrevVMLI(l.a.getStartIndex(),!0,!0),w=S>=0&&a.default.focusedPane.itemAtIndex(S);if(w&&w.allowTextEditing()){if((h.isViewAgenda()||h.search.isFlatSearchResult(t))&&0!==(g=g.replace(t.getItemDateString(),"").trim()).length&&(_=!1),_){a.default.vmMain.itemBeingModified={item:t,action:"removed"},h.setIgnoreRestoreScroll();var I=w.getParsedText(),b=w.isFullscreen()?0:S,A=h.objectAtIndex(b),D=w.isFullscreen()?0:I.length;l.a.selectIndex(b,D),p.deleteChild(t,w,0,ChangeType.Local),g.length>0&&""!==g&&(0===I.length&&w.copyProperties(t),w.setText(w.generateSaveText(I)+t.generateSaveText(g),!0,ChangeType.Local),t.hasNote()&&(w.hasNote()||w.moveNote(t,ChangeType.Local)),o.a.performAction(TrackerType.Insert,{itemID:w.id,position:I.length,text:g})),b=h.indexOfObject(A),l.a.selectIndex(b,D),_=!1}}else _=!1}else _=!1;else if(f&&r<=t.getPrefixLength())c.isBlockHeader&&t.hasChildren()?_=!1:(o.a.performAction(TrackerType.Remove,{itemID:t.id,position:0,text:g.slice(0,t.getPrefixLength())}),m=g.substr(t.getPrefixLength()),v=0);else if(0===r&&u===g.length)o.a.performAction(TrackerType.Remove,{itemID:t.id,position:0,text:t.getParsedText()}),m="",v=0;else if(e.metaKey)if(t.isNote()){var T=g.prevIndexOf("\n",u);T<0?(m=g.substring(u),v=0,o.a.performAction(TrackerType.Remove,{itemID:t.id,position:0,text:g.slice(0,u)})):(m=g.substring(0,T)+g.substring(u),v=T,o.a.performAction(TrackerType.Remove,{itemID:t.id,position:0,text:g.slice(T,u)}))}else m=t.getPrefix()+g.substring(u),o.a.performAction(TrackerType.Remove,{itemID:t.id,position:0,text:g.slice(0,u)}),v=0;else{var M=d.a.isInsideMarkup(t,r-1);if(M&&(r=d.a.moveLeft(t,r-1)+1,M.isMDImage()&&"!"===g[r-1]&&r--),d.a.isInsideMarkup(t,u-1)&&(u=d.a.moveRight(t,u-1,l.a.getStartTotal())-1),f=r===u,(s.a.mac&&e.altKey||!s.a.mac&&e.ctrlKey)&&f){var C=g.substring(r),L=d.a.getPreviousWord(t,g,r-1)+1;0,L>=0?(o.a.performAction(TrackerType.Remove,{itemID:t.id,position:L,text:g.slice(L,r)}),m=g.substring(0,L)+C,v=L):(r===g.length?0===r&&(m="",o.a.performAction(TrackerType.Remove,{itemID:t.id,position:0,text:g})):(o.a.performAction(TrackerType.Remove,{itemID:t.id,position:0,text:g.slice(0,r)}),m=C),v=0)}else if(f){var P=1;g.length>1&&""===g[r-1]&&P++,y&&g.charAt(r-1)===window.AttachChar?" "===g.charAt(r-2)?(m=g.substr(0,r-3)+g.substr(r-2),v=r-3):(m=g.substr(0,r-2)+g.substr(r-1),v=r-2):(m=g.substr(0,r-P)+g.substr(r),o.a.performAction(TrackerType.Remove,{itemID:t.id,position:r-P,text:g.slice(r-P,r)}),v=r-P),!y||m!==" "+window.AttachChar&&m!==window.AttachChar||(m="",v=0)}else{var E=g.slice(r,u);y&&E.indexOf(window.AttachChar)>=0&&E.indexOf(n.a.DatePrefix)<0?(o.a.performAction(TrackerType.Remove,{itemID:t.id,position:r,text:E.replace(window.AttachChar,"")}),m=g.substr(0,r)+g.substr(u)+window.AttachChar):(o.a.performAction(TrackerType.Remove,{itemID:t.id,position:r,text:E}),m=g.substr(0,r)+g.substr(u)),v=r}}if(_){if(!a.default.showMarkdown()){var k=m.search(/(_{4,}?|\*{4,}?)/);k>=0&&(m=m.replace(/(_{4,}?|\*{4,}?)/g,""),v>k&&(v-=v-k))}t.setText(m,!0,ChangeType.Local),l.a.selectIndex(i,v),this.updateAutocomplete(e),a.default.vmMain.itemBeingModified=void 0}return!1},handleDelete:function(e){var t=l.a.getStartItem(),i=a.default.focusedPane;if(!t)return!1;var r,u=t.parent(),c=t.getParsedText(),h=l.a.getStartIndex(),f=l.a.getStartOffset(),p=l.a.getEndOffset(),g=f===p,m=!0,v=t.hasAttachmentType(n.a.PluginType.Calendar);if(a.default.vmMain.itemBeingModified={item:t,action:"removed"},""===c)if(i.isViewOutline()){if(t.isNote())u.setNote(void 0,ChangeType.Local),l.a.selectItem(u,-1);else if(h<i.numItems()-1){var _=h;i.setIgnoreRestoreScroll(),i.numItems()>1&&(t.hasChildren()?u.replaceChild(t,t.getFirstChild(),ChangeType.Local):u.deleteChild(t,u,_,ChangeType.Local)),l.a.selectIndex(_,0)}}else m=!1;else if(f===l.a.getStartTotal()&&p===l.a.getEndTotal())if(i.isViewOutline())if(t.isNote())m=!1;else{var y=i.indexOfNextVMLI(h,!0,!0),S=y>=0&&i.itemAtIndex(y);if(i.setIgnoreRestoreScroll(),S&&m){c=t.generateSaveText(c);var w=S.generateSaveText(S.getParsedText()),I=S.hasNote()&&S.getNote();if(t.setText(c+w,!0,ChangeType.Local),I){var b=t.hasNote()&&t.getNote();if(b){var A=b.getRawText()+"\n\n--- merged note ---\n\n"+I.getRawText();b.setText(A,!0,ChangeType.Local)}else I.parent(t),t.setNote(I,ChangeType.Local)}o.a.performAction(TrackerType.Insert,{itemID:t.id,position:c.length,text:S.getParsedText()}),S.parent().deleteChild(S,t,0,ChangeType.Local),l.a.selectIndex(l.a.getEndIndex(),p)}}else m=!1;else if(e.metaKey)t.isNote()||(r=c.substring(0,f),t.setText(r,!0,ChangeType.Local),o.a.performAction(TrackerType.Remove,{itemID:t.id,position:0,text:c.slice(0,f)}),l.a.selectIndex(h,f));else if((s.a.mac&&e.altKey||!s.a.mac&&e.ctrlKey)&&f===p){var D=d.a.getNextWord(t,c,f+1);D<0&&(D=l.a.getStartTotal()),D>=0&&(r=c.substring(0,f)+c.substring(D),t.setText(r,!0,ChangeType.Local),o.a.performAction(TrackerType.Remove,{itemID:t.id,position:D,text:r}),l.a.selectIndex(h,f))}else{if(d.a.isInsideMarkup(t,f-1)&&(f=d.a.moveLeft(t,f-1)+1),d.a.isInsideMarkup(t,p)&&(p=d.a.moveRight(t,p,l.a.getStartTotal())-1),g)v&&c.charAt(f)===window.AttachChar||(r=c.substr(0,f)+c.substr(f+1),o.a.performAction(TrackerType.Remove,{itemID:t.id,position:f,text:c.slice(f,f+1)}));else{var T=c.slice(f,p);v&&T.indexOf(window.AttachChar)>=0&&T.indexOf(n.a.DatePrefix)<0?(r=c.substr(0,f)+c.substr(p)+window.AttachChar,o.a.performAction(TrackerType.Remove,{itemID:t.id,position:f,text:c.slice(f,p)})):(r=c.substr(0,f)+c.substr(p),o.a.performAction(TrackerType.Remove,{itemID:t.id,position:f,text:c.slice(f,p)}))}!v||r!==" "+window.AttachChar&&r!==window.AttachChar&&r!==" "+window.AttachChar&&c!==window.AttachChar||(r=""),void 0!==r&&(t.setText(r,!0,ChangeType.Local),l.a.selectIndex(h,f),this.updateAutocomplete(e))}return a.default.vmMain.itemBeingModified=void 0,!1},keyWantsScrollIntoView:function(e,t){switch(e.normCode){case KeyCode.LeftMeta:case KeyCode.RightMeta:case KeyCode.Alt:case KeyCode.Shift:case KeyCode.Ctrl:case KeyCode.LeftArrow:case KeyCode.RightArrow:case KeyCode.UpArrow:case KeyCode.DownArrow:return!1}return!(s.a.mac&&e.metaKey&&(t&&e.normCode===KeyCode.Tilde||!t&&"`"===String.fromCharCode(e.normCode)))&&((!(s.a.mac&&e.metaKey||!s.a.mac&&e.ctrlKey)||e.normCode!==KeyCode.Z&&e.normCode!==KeyCode.Y)&&!(e.normCode>=KeyCode.F1&&e.normCode<=KeyCode.F12))},compoundOperation:function(e){var t=this;this.isInCompoundOperation=!0,o.a.beginAction(),a.default.vmMain.beginUpdateItems(),a.default.batchRenderUpdates(function(){e(),t.isInCompoundOperation=!1,h.a.runUpdates()}),a.default.vmMain.commitUpdateItems(),o.a.endAction()}},t.default=new f},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(5),r=(i(4),i(26),i(8)),o=i(35),l=i(49),d=i(23),u=n.a.TaskViewMode,c=1;function h(){}h.prototype={init:function(){this._isSaving=!1,this._isAdding=!1,this._docID=void 0,this._syncState=void 0,this._localState=void 0,this._selectionState=void 0,this._workspaces=new d.a,this.selectedIndex=new r.a,this.selected=new l.a([this.selectedIndex],function(){return this.get()}.bind(this)),this.selectedChanged=new o.a,s.a.binder(this,"hotkeyNextBoard","hotkeyPrevBoard","selectBoard","save"),a.default.settings.listen("settingChanged",Settings.DefaultGroup,Settings.workspaces,this.onSettingChanged.bind(this))},setIsAdding:function(e){this._isAdding=e},isAdding:function(){return this._isAdding},add:function(e){this.setIsAdding(!0);var t={id:this.getNextID(),name:this.getNextName(),needsName:!0,panes:e||[]};return this._workspaces.push(t),this.save(),t},removeWorkspace:function(e){if(this._workspaces.length()>1){var t=this._workspaces.indexOf(e),i=this.selectedIndex.get();this._workspaces.remove(e),!isNaN(i)&&i>=t&&this.setSelectedIndex(i-1),this._localState[this.getDocID()]&&delete this._localState[this.getDocID()][e.id],this.save()}},length:function(){return this._workspaces.length()},setSelectedIndex:function(e,t){var i=this.getDocID(),n=e!==this.selectedIndex.get();this.selectedIndex.set(e),!1!==t&&n&&this.selectedChanged.notify(),this._selectionState[i]!==e&&(this._selectionState[i]=e,a.default.settings.set(Settings.selectedWorkspace,this._selectionState))},switchTo:function(e){var t=this._workspaces.indexOf(e);this.setSelectedIndex(t)},getDocID:function(){return this._docID||(this.trackPaneState()?this._docID=a.default.settings.get(Settings.gdocId):this._docID="TEST"),this._docID},_findMatchingLocalPane:function(e,t){var i;if(t)for(var a=0,n=0;n<t.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(t[n].id===e){i=t[n];break}}return i},_generateUsablePaneState:function(e,t){for(var i=0,a=[],n=0;n<e.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=e[n],r=this._findMatchingLocalPane(s.id,t)||s;a.push({id:s.id,name:s.name,item:s.item,type:s.type,showarch:s.showarch,search:s.search,viewState:s.viewState||(s.viewMode?{viewMode:s.viewMode}:void 0),displayLocalItems:s.displayLocalItems,displayCalendars:s.displayCalendars,blocksCollapsed:s.blocksCollapsed,widthManual:s.widthManual,widthManualExpanded:s.widthManualExpanded,offset:r?r.offset:0,itemState:r?r.itemState:{},isOverviewVisible:!!r&&r.isOverviewVisible,isExpanded:!!r&&r.isExpanded,selectedItem:r?r.selectedItem:void 0})}return a},_loadWorkspaces:function(){var e=this._workspaces.get();return e&&0!==e.length||(a.default.Assert(this.getDocID(),"Should have a docID before loading workspaces panes from state"),this.load(),e=this._workspaces.get()),a.default.Assert(e.length>0,"Must have loaded workspaces and pane state before accessing"),e},hasLoadedPaneState:function(){return!!this._localState},getPaneState:function(){this._loadWorkspaces();var e=this.get(),t=this._localState&&this._localState[this.getDocID()]||[];return e?this._generateUsablePaneState(e.panes,t[e.id]):[]},_generateSyncPaneState:function(e){for(var t=0,i=[],a=0;a<e.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[a];i.push({id:n.id,name:n.name,item:n.item,type:n.type,showarch:n.showarch,search:n.search,viewState:n.viewState,displayCalendars:n.displayCalendars,displayLocalItems:n.displayLocalItems,widthManual:n.widthManual,widthManualExpanded:n.widthManualExpanded,blocksCollapsed:n.blocksCollapsed})}return i},_generateLocalPaneState:function(e){for(var t=0,i=[],a=0;a<e.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[a];i.push({id:n.id,offset:n.offset,itemState:n.itemState,isOverviewVisible:n.isOverviewVisible,isExpanded:n.isExpanded,selectedItem:n.selectedItem})}return i},savePaneState:function(e,t){this._loadWorkspaces();try{t||this._saveSyncState(e),this._saveLocalState(e),this.save(t)}catch(e){a.default.reportError(e,{numWorkspaces:this._workspaces.length(),selectedIndex:this.selectedIndex.get(),docID:this.getDocID()})}},_saveLocalState:function(e){var t=this.get().id;a.default.Assert(t,"Must have a valid workspace ID");var i=this._generateLocalPaneState(e),n=this.getDocID();a.default.Assert(n,"Must have a valid doc ID"),this._localState[n]||(this._localState[n]={}),this._localState[n][t]=i},_saveSyncState:function(e){var t=this.get();a.default.Assert(t,"Selected workspace does not exist"),t&&(t.panes=this._generateSyncPaneState(e))},renameWorkspace:function(e,t){for(var i=0,a=!1,n=0;n<this._workspaces.length();n++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this._workspaces.get()[n];s!==e&&s.name===t&&(a=!0)}return!a&&(e.name=t,this.save(),this.selected.notify(),!0)},saveWorkspaceDefault:function(e){e.defaultPanes=a.default.clone(e.panes),this.save()},restoreWorkspaceDefault:function(e){e.panes=a.default.clone(e.defaultPanes),this.selectedChanged.notify()},get:function(){var e=this.selectedIndex.get();if(void 0!==e)return this._workspaces.get()[e]},migrateLocalFromPaneState:function(e){var t={};for(var i in e)if(e.hasOwnProperty(i)){var a=e[i];t[i]=this.createDefaultState(a,["id","offset","itemState","isOverviewVisible","isExpanded"])}return t},migrateSyncFromPaneState:function(e){var t={};for(var i in e)if(e.hasOwnProperty(i)){var a=e[i];t[i]=this.createDefaultState(a,["id","item","type","showarch","search"])}return t},createDefaultState:function(e,t){for(var i=0,n=[],s=0;s<e.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=e[s],o={};for(var l in r)r.hasOwnProperty(l)&&t.indexOf(l)>=0&&(o[l]=r[l]);n.push(o)}var d=[{name:"Tasks",panes:[{type:PaneMode.Task,viewState:{viewMode:u.Groups_Project},isOverviewVisible:!0}]},{name:"Today",panes:[{type:PaneMode.Task,viewState:{viewMode:u.Agenda_Today},isOverviewVisible:!0}]},{name:"Calendar",panes:[{type:PaneMode.Task,viewState:{viewMode:u.Calendar_Week}}]}];return a.default.vmMain.pluginManager.isEnabled(PluginID.Gmail)&&d.splice(2,0,{name:"Email",panes:[{type:PaneMode.Gmail,isOverviewVisible:!0,isExpanded:!0}]}),n.length>0&&d.push({name:"My First Board",panes:n}),{workspaces:d}},getNextName:function(){var e,t,i=0,a=this._workspaces.get(),n=1;do{var s=0;if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;e=!1,t="Board "+n,n++;for(var r=0;r<a.length;r++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;if(a[r].name===t){e=!0;break}}}while(e);return t},getNextID:function(){return 1e3*Math.floor(Math.random())+"I"+Date.now()+"Z"+ ++c},load:function(){var e,t,i=this.getDocID(),n=!1;if(i){if(this.trackPaneState()){var r=a.default.settings.get(Settings.workspaces);if(r){try{e=JSON.parse(r)}catch(t){a.default.reportError(t),e={}}try{var o=a.default.settings.get(Settings.localPaneState);t=o?JSON.parse(o):{}}catch(e){a.default.reportError(e),t={}}}else{n=!0;var l=s.a.storage.getItem("paneState");if(l){try{l=JSON.parse(l)}catch(e){a.default.reportError(e),l={}}e=this.migrateSyncFromPaneState(l),t=this.migrateLocalFromPaneState(l)}else t={},(e={})[i]=this.createDefaultState([])}}else e={},t={};if(e){var d=0,u=e[i];u&&u.workspaces||(e[i]=this.createDefaultState([]),u=e[i],n=!0),this._selectionState=a.default.settings.get(Settings.selectedWorkspace),this._selectionState&&a.default.isObject(this._selectionState)||(this._selectionState={});var c=this._selectionState[i];void 0===c&&(c=0),!isNaN(c)&&c>=u.workspaces.length&&(c=u.workspaces.length-1),this._syncState=e,this._localState=t;for(var h=0;h<u.workspaces.length;++h){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;var f=u.workspaces[h];a.default.isString(f.name)?f.name=f.name.replace("Workspace","Board"):f.name="Board",f.id||(f.id=this.getNextID(),n=!0)}this._workspaces.set(u.workspaces),this.setSelectedIndex(c)}n&&this.save()}},save:function(e){if(this.trackPaneState()){this._isSaving=!0;try{e||a.default.settings.set(Settings.workspaces,JSON.stringify(this._syncState)),a.default.settings.set(Settings.localPaneState,JSON.stringify(this._localState))}catch(e){a.default.reportError(e)}this._isSaving=!1}},trackPaneState:function(){return!a.default.isRunningScript()&&!a.default.isDemoMode()&&!0},onSettingChanged:function(){this._isSaving||this.load()},moveTo:function(e,t){var i=this._workspaces.get()[e],n=this.get();this._workspaces.splice(e,1,void 0,!1),this._workspaces.splice(t,0,i);var s=this._workspaces.indexOf(n);s>=0&&(a.default.timeoutOnce("saveBoardsAfterMove",this.save,2e3),this.selectedIndex.set(s))},cloneBoard:function(e,t){var i;(e=e||this.get(),t)?i=[t.getSaveInfoForClone()]:i=e.panes;a.default.Assert(i,"Must have valid panes to clone a board");var n=this.add(i);return this.switchTo(n),n},hotkeyPrevBoard:function(){var e=this.selectedIndex.get()-1;e<0&&(e=this.length()-1),this.setSelectedIndex(e)},hotkeyNextBoard:function(){var e=this.selectedIndex.get()+1;e>=this.length()&&(e=0),this.setSelectedIndex(e)},selectBoard:function(e){e>=0&&e<this.length()&&this.setSelectedIndex(e)}},t.a=new h},function(e,t,i){"use strict";var a=i(60),n=function(e){this._listeners=[],this._enabled=!0,e&&this._listeners.push(e)};n.prototype={listen:function(e){return this._addListener(e),new a.a(this,e)},_addListener:function(e){this._listeners.push(e)},_hasListener:function(e){return this._listeners.indexOf(e)>=0},unlisten:function(e){this._listeners.remove(e)},enable:function(){this._enabled=!0},disable:function(){this._enabled=!1},notify:function(){if(this._enabled)for(var e=0,t=0;t<this._listeners.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;arguments.length>0?this._listeners[t](arguments[0]):this._listeners[t]()}}},t.a=n},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(4),r=i(2),o=i.n(r),l=i(12),d=i(26),u=i(44);var c=l.a.createClass({displayName:"FancyContextMenu",componentDisplay:n.a.ComponentDisplay.Everywhere,init:function(){var e=this.props;this.listenToDispatcher("windowResize"),e.supportArrows&&(this.selectedIndex=d.a.registerArrowsMode("FancyContextMenu",!0,this.getNumItems,this.onArrowsModeSelect,this.onArrowsModeKey),e.fromHotkey&&this.selectedIndex.set(0,!1),e.onSelectedIndexChanged&&this.selectedIndex.listen(e.onSelectedIndexChanged))},close:function(){a.default.Assert(this.props.name,"Cannot call close on a menu without a name"),a.default.menus.closeContextMenu(this.props.name)},getHotkeys:function(){var e=this.props,t=[d.a.createEscape(this.onEscapeKey)];return e.hotkeys&&(t=t.concat(e.hotkeys)),t},getRefAtIndex:function(e){return this.refs["el_"+e]},componentDidMount:function(){0},onUnmount:function(){this.props.supportArrows&&d.a.exitArrowsMode("FancyContextMenu")},getState:function(){if(this.props.useElementPosition){var e=this.updatePosition();return{selectedIndex:this.selectedIndex,left:e.left,top:e.top,right:e.right,bottom:e.bottom,maxHeight:e.maxHeight}}return{top:this.isAtPosition("search")&&a.default.topBarHeight+n.a.MobileHeaderRow2Height||this.isAtPosition("top")&&a.default.topBarHeight||null,bottom:this.isAtPosition("bottom")?0:null}},onMouseDownNoBackdrop:function(e){a.default.findParent(e.target,"fancyContextMenu")||a.default.menus.closeContextMenu()},isAtPosition:function(e){if(this.props.position&&this.props.position.split("-").indexOf(e)>=0)return!0;return!1},getNumItems:function(){return this.numItems},onArrowsModeSelect:function(e){if(e>=0)if(this.props.onEnterKey)this.props.onEnterKey();else{var t=this.refs["el_"+e];t&&t.onClick&&t.onClick()}},onArrowsModeKey:function(e,t){var i=this.props;i.onKeyPress&&i.onKeyPress(e,t)&&i.supportArrows&&d.a.exitArrowsMode("FancyContextMenu")},onEscapeKey:function(){this.props.onEscape&&this.props.onEscape(),a.default.menus.closeContextMenu()},onChildMouseEnter:function(e,t){this.selectedIndex.set(e)},isOnSide:function(e){return this.props.side?this.props.side.indexOf(e)>=0:"bottom"===e},updatePosition:function(){var e=this.props,t=s.a.windowWidth(),i=s.a.windowHeight();if(a.default.Assert(e.element,"Context menu needs an element to open on",e.id),e.element){var n,r,o=e.element.getBoundingClientRect(),l=e.pos,d=(this.refs.menu,l?l.left:void 0),u=l?l.top:void 0;isNaN(d)&&(this.isOnSide("right")?d=o.right:this.isOnSide("left")?n=t-("top left"===e.side?o.right:o.left):d=o.left),isNaN(u)&&(this.isOnSide("bottom")?u=o.bottom:this.isOnSide("top")?r=i-o.top:u=o.top);var c=e.positionOffset;c&&(!isNaN(d)&&c.left&&(d+=c.left),!isNaN(n)&&c.right&&(n+=c.right),!isNaN(u)&&c.top&&(u+=c.top),!isNaN(r)&&c.bottom&&(r+=c.bottom));var h={left:d,top:u,right:n,bottom:r};return h.left=0,h.bottom=s.a.getKBSize(),h}return{left:0,top:0,maxHeight:400}},remapChildren:function(e,t){var i=this;return o.a.Children.map(e,function(e){if(e&&"hr"!==e.type){if("leftcol"===e.key){var a=e.props,n=a.children,r=function(e,t){var i={};for(var a in e)t.indexOf(a)>=0||Object.prototype.hasOwnProperty.call(e,a)&&(i[a]=e[a]);return i}(a,["children"]);return o.a.createElement("div",r,i.remapChildren(n,t))}if("scroller"===e.key){var l={maxHeight:.6*s.a.windowHeight()};return o.a.createElement(u.a,{style:l},i.remapChildren(e.props.children,t))}if(!e.props||e.props.onClick||e.props.customLayout){var d=e.props.onMouseEnter?function(a){i.onChildMouseEnter(t.index,a),e.props.onMouseEnter(a)}:i.onChildMouseEnter.bind(i,t.index);return o.a.cloneElement(e,{onMouseEnter:d,ref:"el_"+t.index,selected:!1})}return e}return e})},render:function(){var e=this.state,t=this.props,i=a.default.classNames("fancyContextMenu popup c-shadow-popup",t.className,t.position,t.background,{"c-bg-menu":!t.background},{loading:t.loading},{openFromBottom:t.openFromBottom},{top:this.isAtPosition("top")},{bottom:this.isAtPosition("bottom")},{left:this.isAtPosition("left")},{right:this.isAtPosition("right")},{fill:this.isAtPosition("fill")},{full:this.isAtPosition("full")}),n={left:e.left,top:e.top,right:e.right,bottom:isNaN(t.bottom)?e.bottom:t.bottom,width:t.width,height:t.height,minWidth:t.minWidth,maxHeight:e.maxHeight||t.maxHeight,maxWidth:t.maxWidth};this.isAtPosition("fill")&&(n.top=a.default.topBarHeight),n=a.default.extend(n,this.props.style);var s=this.props.children;if(t.supportArrows){var r={index:0};s=this.remapChildren(this.props.children,r),this.numItems=r.index}return o.a.createElement("div",{ref:"menu",id:t.id,className:i,style:n},s)}});t.a=c},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(6),r=i(5),o=i(33),l=i(7),d=i(20),u=i(4),c=i(14),h=i(8),f=i(57),p=i(3),g=i(13),m=i(31).default;function v(e,t){this.pane=e,this.root=e.getRootItem(),this.contentElement=void 0,this._scrollListenerAttached=!1,this.isVisible=new h.a(!!t);this.transform=new h.a(0),this.cursor=new h.a,this.topItem=void 0,this.dragHoverItem=void 0,this._infiniteList=new f.a({pane:e,isOverview:!0,itemsObs:e.headers,itemsFn:e.getHeaders,widthFn:e.getWidth,heightFn:e.getHeight,minItemSize:this.getMinItemSize}),this.init()}v.prototype={init:function(){r.a.forceBind("refreshScrollListener",this)},destroy:function(){this.pane=void 0,r.a.destroy(this)},onPaneLoad:function(){0},getInfiniteList:function(){return this._infiniteList},getContentElement:function(){return this.contentElement},onTapSection:function(e){a.default.vmMain.vmPicker.onTapSection(e)},getScrollOffset:function(){this._infiniteList.getScrollOffset()},refreshScrollListener:function(){this._infiniteList.refreshScrollListener()},onTap:{onStart:function(e){if(u.a.useCustomScroller&&e.preventDefault(),!a.default.hasClass(e.target,"overviewList")&&a.default.findParent(e.target,"overviewList")){var t=a.default.getItemForElement(e.target);t&&(c.default.startDragItem=t)}},onMove:function(e){},onClick:function(e){var t,i=this.pane,n=a.default.getItemForElement(e.target),s=a.default.getElementParent(e.target);(s&&n!==i&&n!==this&&a.default.findParent(e.target,"overviewList")&&(t=a.default.getPaneObjectForElement(e.target),n=a.default.getItemForElement(e.target),a.default.Assert(n,"Element in overview was text but was not an item")),n)&&(a.default.Assert(s,"Item must have an overview element: "+(n.getRawText?n.getRawText():"not an item")),s&&(e.clientX-a.default.offset(s).left<i.getPaddingForPaneObject(n,!0)?i.setPaneObjectCollapsed(!i.isPaneObjectCollapsed(t,!0),t,!0):a.default.hasClass(e.target,"overviewOptions")?(a.default.menus.openContextMenu({componentName:"ReactContextMenuOverviewOptions",key:"menu"+n.id+e.clientX+e.clientY,element:e.target,item:n,pane:i,pos:{left:e.pageX,top:e.pageY}}),a.default.preventAndStop(e)):this.pane.allowZoom(n)?(a.default.vmMain.zoomin(n),m.setOverviewVisibility(this.pane,!1),a.default.sendEvent("Menu","OverviewZoom")):this.pane.performOverviewAction(n)));a.default.preventDefault(e)},onEnd:function(e){}},scrollItemIntoView:function(e){var t=0;this._disablePaneScrollListener=!0;for(var i=e;i&&i!==this.pane.getItem();){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(this.pane.indexOfItem(i)>=0){this.pane.scrollItemToTop(i,ScrollDuration.Default);break}i=i.parent()}this.updateTopPaneItem(e),setTimeout(function(){this._disablePaneScrollListener=!1}.bind(this),2*ScrollDuration.Default)},setVisibility:function(e){e&&(p.a.reset(),this._infiniteList.setInitialScrollOffset(0)),e!==this.isVisible.get()&&(this.isVisible.set(e),g.a.fireEvent("panesChanged",[])),e&&a.default.isKeyboardOpen&&!a.default.getActiveSearch().isFocused.get()&&a.default.blurActiveElement(),l.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ToggleOverview,data:{value:e,pane:this.pane}}),this.pane.onOverviewToggled(e)},_attachScrollListener:function(){a.default.Assert(!this._scrollListenerAttached,"Must not double attach scroll listener"),this._scrollListenerAttached||(this.pane.addScrollListener(this.onPaneScroll),this.onPaneScroll(),this._scrollListenerAttached=!0)},_detachScrollListener:function(){a.default.Assert(this._scrollListenerAttached,"Must only detach overview listener when already attached"),this._scrollListenerAttached&&(this.pane.removeScrollListener(this.onPaneScroll),this._scrollListenerAttached=!1)},toggleDesktop:function(){this.isVisible.get()?this.setVisibility(!1):this.setVisibility(!0),l.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ToggleOverview,data:{value:this.isVisible.get(),pane:this.pane}})},onPaneScroll:function(){if(!this._disablePaneScrollListener){a.default.Assert(this.isVisible.get(),"Should not be tracking scroll if overview is not open");var e=this.findTopPaneItem();e&&(this.updateTopPaneItem(e),this._infiniteList.scrollItemToMiddle(e,ScrollDuration.Default))}},findTopPaneItem:function(){var e=this.pane;if(this.pane.numItems()>0){for(var t,i,a=0,n=this.pane.indexOfTop();n>=0&&n<e.numItems()&&!i;){var s=0;if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;for(t=this.pane.itemAtIndex(n);t&&t!==this.root&&!i;){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;this._infiniteList.indexOfItem(t)<0?t=t.parent():i=t}i||n++}return!i&&this._infiniteList.numItems()>0&&(i=this._infiniteList.itemAtIndex(0)),i}},updateTopPaneItem:function(e){var t=this.topItem;this.topItem=e,t&&t.itemChanged.notify(),e.itemChanged.notify()},updateDragHoverItem:function(e){var t=this.dragHoverItem;this.dragHoverItem=e,t&&t.itemChanged.notify(),e&&e.itemChanged.notify()},onPaneItemsUpdated:function(e){if(e===this.pane&&this.isVisible.get()&&this.pane.overviewTracksScroll){var t=this.findTopPaneItem();t&&this.updateTopPaneItem(t)}},isItemAtTop:function(e){return e===this.topItem},isItemDragHovered:function(e){return e===this.dragHoverItem},getiScroller:function(){return this._infiniteList.iScroller},getMinItemSize:function(){return d.a.itemLineHeight()+2*d.a.itemPadding()}};var _=v,y=i(19),S=i(23),w=i(30),I=i(66),b=i(17),A=i(15),D=i(27),T=i(11),M=i(24),C=i(51),L=i(22),P=i(28),E=i(32),k=i(31).default,x=0,R=["collapser","itemParents","itemCheckbox","agendaTime","itemMenuIcon","vertLines"];function O(e){this.__ISPANE=!0,this.setPropDefault("title",n.a.RootItemName),this.setPropDefault("contextMenuMode",n.a.ContextMenuMode.Default),this.setPropDefault("paneEmptyMessage","Start typing to get started"),this.setPropDefault("paneEmptySearchMessage","No search results"),this.setPropDefault("titleContextMenuHeader","Zoom to item"),this.setPropDefault("searchFilters",[]),this.setPropDefault("dropEffect",function(){return n.a.DropEffect.Move}),this.setPropDefault("isWriteable",!0),this.setPropDefault("isEditable",!1),this.setPropDefault("isDraggable",!0),this.setPropDefault("isDropTarget",!0),this.setPropDefault("hasNonVMLIs",!1),this.setPropDefault("canAddItem",!0),this.setPropDefault("overrideCopyBehavior",!0),this.setPropDefault("supportMenuIcon",!1),this.setPropDefault("supportCollapsing",!0),this.setPropDefault("supportCompleting",!0),this.setPropDefault("supportCheckbox",!1),this.setPropDefault("supportArchiving",!1),this.setPropDefault("supportIndent",!0),this.setPropDefault("supportOffline",!0),this.setPropDefault("supportPerformArchive",!0),this.setPropDefault("supportDataRefresh",!1),this.setPropDefault("supportReportError",!1),this.setPropDefault("supportCompose",!1),this.setPropDefault("supportPagination",!1),this.setPropDefault("supportVertLines",!0),this.setPropDefault("supportStarClick",!1),this.setPropDefault("supportSearchItemAutocomplete",!0),this.setPropDefault("supportSearchListenTextChanges",!0),this.setPropDefault("supportSearchFlat",!0),this.setPropDefault("supportLocalSearch",!0),this.setPropDefault("supportClone",!0),this.setPropDefault("supportDates",!0),this.setPropDefault("supportMultiselect",!0),this.setPropDefault("supportDeferredItemLoad",!1),this.setPropDefault("supportCellTransition",!0),this.setPropDefault("supportViewMenu",!1),this.setPropDefault("showRootOnRow2",!1),this.setPropDefault("useLineCache",!0),this.setPropDefault("supportSel",!0),this.setPropDefault("shouldSearchMatchParents",!0),this.setPropDefault("shouldUpdateOnTextChanged",!0),this.setPropDefault("noOverviewStyle",!1),this.setPropDefault("supportClickOverviewScroll",!1),this.setPropDefault("overviewTracksScroll",!0),this.setPropDefault("overviewHasPaneItems",!0),this.setPropDefault("overviewPadLevels",0),this.setPropDefault("minWidth",n.a.StdPaneWidthMin),this.setPropDefault("minWidthFlex",n.a.StdPaneWidthMin),this.setPropDefault("maxWidth",n.a.PaneWidthMax),this.setPropDefault("maxWidthFlex",n.a.StdPaneWidthMax),this.setPropDefault("maxWidthSingle",n.a.StdPaneWidthMax),this.setPropDefault("widthBiggerInSingle",!0),this.setPropDefault("collapsedFieldName",n.a.PerPaneStateField.Collapsed),this.setPropDefault("hasMoreButtons",!0),this.setPropDefault("_topBoxHeight",a.default.activeDisplayMode&DisplayMode.NoPaneTop?0:16),this.topBoxHeight=new h.a(this._topBoxHeight),this.rect=new h.a(e.rect),this.isExpanded=new h.a(!1),a.default.Assert(void 0!==e.id,"Must supply a valid pane id"),this.id=e.id,this.uniquePaneID=x++,this.isFakePane=e.isFakePane,e.item||(this.supportDeferredItemLoad?(e.item=this.getDefaultDisplayItem(),this.deferredItemState={itemID:e.deferredItemID,search:e.search,offset:0}):(e.item=this.getDefaultDisplayItem(),e.search=e.search||"")),this.name=new h.a(e.name),this.item=new h.a(e.item),this.items=new S.a,this.headers=new S.a,this.paneObjectsByItem={},this.isDefaultPane=e.isDefaultPane,this.initialOffset=e.offset,this.itemsDirtyState=void 0,this.rootElement=void 0,this.scrollElement=void 0,this.element=void 0,this.paneContent=void 0,this.reloading=!1,this.showArchived=new h.a(!1),this._panePadding=0,this.paneTopText=new h.a,this.toast=new h.a,this.isInitialized=!1,this.isLoaded=!1,this._didInitialScroll=!1,this.isLoading=new h.a(!1),this.isFocused=new h.a(!1),this.caretPosition=new h.a,this.widthManual=e.widthManual,this.widthManualExpanded=e.widthManualExpanded,this.isReady=new h.a(!this.plugin||this.plugin.isReady()),this.isActive=new h.a(!1),this.hasBeenActive=this.isActive.get(),this.hasCollapsedObs=new h.a,r.a.binder(this,"getItems","getHeaders","getWidth","getHeight","zoomInOnSwipe","getMinItemSize","onInputAndroid","onInputSetText"),this._infiniteList=new f.a({pane:this,offset:e.offset||0,isOverview:!1,itemsObs:this.items,itemsFn:this.getItems,widthFn:this.getWidth,heightFn:this.getHeight,intialOffset:this.initialOffset,minItemSize:this.getMinItemSize}),this.useCustomScroller=this._infiniteList.useCustomScroller,this.isLoadingNewPage=new h.a(!1),this.orientation=new h.a(n.a.Orientation.Vertical),this.showScrollbars=new h.a(!0),this._perPaneState={},this._destroyed=!1,this._numItemComputes=0,this._numHeaderComputes=0,this._numItemSets=0,this.isAnimatingOffset=!1,this._ignoreRestoreScroll=!1,this._activeItemStores={},this.defaultOffset=Math.max(this.topBoxHeight.get()-16,0),this.offsetX=new h.a(0),this.swipeMenuItems=this.getSwipeMenuItems(),r.a.forceBind("onTouchHoldTimeout",this),r.a.binder(this,"onInput","compositionStart","compositionEnd","onShowArchivedChanged","updateItems"),this.showArchived.listen(this.onShowArchivedChanged),this.search=new I.a(this,e.search,this.onSearchChanged.bind(this)),this.overview=new _(this,e.isOverviewVisible)}O.prototype={init:function(){this.getItem()&&this.setItem(this.getItem(),!1),this.plugin&&this.plugin.notifyPaneCreated(this)},isDestroyed:function(){return this._destroyed},getStats:function(){return{numItemComputes:this._numItemComputes,numHeaderComputes:this._numHeaderComputes,numItemSets:this._numItemSets}},becomeReal:function(){},activate:function(){a.default.Assert(!0,"Activating panes should only ever happen on mobile devices"),this.isActive.set(!0),this.hasBeenActive=!0,this.updateItemsImmediate(!0,!1)},deactivate:function(){a.default.Assert(!0,"Deactivating panes should only ever happen on mobile devices"),this.isActive.set(!1)},unload:function(){this._isUnloaded=!0},isUnloaded:function(){return this._isUnloaded},destroy:function(){this._destroyed=!0,this.plugin&&this.plugin.notifyPaneDestroyed(this),this.showArchived.unlisten(this.onShowArchivedChanged),this.search.destroy(),this.search=void 0,this.overview.destroy(),this.overview=void 0,this.rootElement=void 0,this.scrollElement=void 0,this.element=void 0,this.paneContent=void 0,this.hiddenInput=void 0,this._onAfterLoadedRAF&&(cancelAnimationFrame(this._onAfterLoadedRAF),this._onAfterLoadedRAF=void 0),this.isLoaded&&this.getItemStore()===a.default.vmMain.itemStoreManager.getDefaultItemStore()&&g.a.unlisten("itemNoteSet",this._infiniteList.handleItemNoteSet),this._infiniteList=void 0,a.default.Assert(a.default.focusedPane!==this,"Globally focused pane should never be the one destroyed"),a.default.Assert(p.a.getPane()!==this,"Selection focused pane should never be the one destroyed"),a.default.Assert(!a.default.vmMain.paneManager.isPaneActive(this.id),"Pane manager has reference to pane in map to destroyed pane"),r.a.destroy(this)},notifyPluginLoaded:function(){a.default.Assert(!1,"Plugin load notification not supported by pane type: ",this.type)},getContextMenuMode:function(){return this.contextMenuMode},isItemDraggable:function(){return this.isDraggable},getInfiniteList:function(e){var t;if(e){var i=this.getOverview();a.default.Assert(i,"Trying to get infinite list for overview that doesnt exist."),i&&(t=i.getInfiniteList())}else t=this._infiniteList;return t},getItemStore:function(){return a.default.vmMain.itemStoreManager.getDefaultItemStore()},usesItemStore:function(e){return e===this.getItemStore()||!!this._activeItemStores[e.id]},useItemStore:function(e){a.default.Assert(!this._activeItemStores[e.id],"Should never use the same store twice"),this._activeItemStores[e.id]=e},stopUsingItemStore:function(e){a.default.Assert(this._activeItemStores[e.id],"Must be using item store to stop using it"),delete this._activeItemStores[e.id]},getOverview:function(){return this.overview},isOverviewVisible:function(){return this.overview.isVisible.get()},getiScroller:function(){return this._infiniteList.iScroller},numItems:function(){return this.getItems().length},numHeaders:function(){return this.getHeaders().length},getItems:function(){return a.default.vmMain.flushItemsUpdate(this),this.items.get()},getHeaders:function(){return this.headers.get()},itemAtIndex:function(e){return this._infiniteList.itemAtIndex(e)},objectAtIndex:function(e){return this._infiniteList.objectAtIndex(e)},indexOfItem:function(e,t,i){return this._infiniteList.indexOfItem(e,t,i)},indexOfObject:function(e){return this._infiniteList.indexOfItem(e)},topOfItem:function(e){return this._infiniteList.topOfItem(e,this.topBoxHeight.get())},topOfIndex:function(e){return this._infiniteList.topOfIndex(e,this.topBoxHeight.get())},indexOfTop:function(){return this._infiniteList.indexOfTop()},inViewCount:function(){return this._infiniteList.inViewCount()},itemAtTop:function(){return this._infiniteList.itemAtTop()},elementAtIndex:function(e){return this._infiniteList.getElementAtIndex(e)},isIndexMounted:function(e){return this._infiniteList.isIndexMounted(e)},notifyDragStart:function(){return this._infiniteList.notifyDragStart()},notifyDragEnd:function(){return this._infiniteList.notifyDragEnd()},notifySwappedIn:function(e){return this._infiniteList.notifySwappedIn(e)},getScrollOffset:function(){return this._infiniteList.getScrollOffset()},addScrollListener:function(e){return this._infiniteList.addScrollListener(e)},removeScrollListener:function(e){return this._infiniteList.removeScrollListener(e)},refreshScrollListener:function(){return this._infiniteList.refreshScrollListener()},setScrollOffset:function(e,t,i){return this._infiniteList.setScrollOffset(e,t,i)},scrollIndexIntoView:function(e,t,i){return this._infiniteList.scrollIndexIntoView(e,t,i)},scrollItemIntoView:function(e,t,i){return this._infiniteList.scrollItemIntoView(e,t,i)},scrollIndexToTop:function(e,t,i){return this._infiniteList.scrollIndexToTop(e,t,i)},scrollItemToTop:function(e,t,i){return this._infiniteList.scrollItemToTop(e,t,i)},scrollItemToMiddle:function(e,t,i){return this._infiniteList.scrollItemToMiddle(e,t,i)},scrollIndexToMiddle:function(e,t,i){return this._infiniteList.scrollIndexToMiddle(e,t,i)},addScrollDelta:function(e){return!!this._infiniteList&&this._infiniteList.addScrollDelta(e)},addPadding:function(){return this._infiniteList.addPadding()},removePadding:function(){return this._infiniteList.removePadding()},getScrollTop:function(){return this._infiniteList.getScrollTop()},closestIndexOfObject:function(e){return this.indexOfObject(e)},sizeAtIndex:function(e,t){var i=0,n=t?this.overview._infiniteList:this._infiniteList;if(a.default.Assert(n,"Must have a valid owner"),n){var s=n.objectAtIndex(e);a.default.Assert(s,"Must have found a valid item"),s&&(i=this.sizeOfItem(s,e,t))}return i},sizeOfItem:function(e,t,i){a.default.Assert(e,"Must provide a valid item to measure");var n=0,s=e.sizeInPane;return void 0!==s&&(n=isNaN(s)?e.sizeInPane(this,t,i):s,e.sizePad&&(n+=e.sizePad)),n},getPaneDoc:function(){return a.default.vmMain.docManager.getOpenDoc()},handleStatusClick:function(){},_getLoadingMessage:function(){return"Loading..."},getStatusMessage:function(e){var t;return e||(this.isLoading.get()?t=this._getLoadingMessage():0===this.numItems()?t=this.isSearched()?this.paneEmptySearchMessage:this.paneEmptyMessage:this.isReady.get()||(t=this._getNotReadyStatus())),t},_getNotReadyStatus:function(){return"Pane data is only available while online."},getSaveInfoForClone:function(){var e=this.getSaveInfo();for(var t in delete e.id,e)e.hasOwnProperty(t)&&a.default.isObject(e[t])&&(e[t]=a.default.clone(e[t]));return e},getSaveInfo:function(){return{id:this.id,name:this.name.get(),item:this.getItem().id,type:this.type,showarch:this.showArchived.get(),search:this.search.getState(),offset:this.getScrollOffset(),itemState:this.getSaveInfoItemState(),isOverviewVisible:!1,isExpanded:!1,widthManual:this.widthManual,widthManualExpanded:this.widthManualExpanded}},getSaveInfoItemState:function(){var e=this._perPaneState,t={};for(var i in e)if(e.hasOwnProperty(i)){var a=s.default.getModel(i);if(a){var r=e[i];for(var o in r)if(r.hasOwnProperty(o)&&o.startsWith(n.a.PerPaneStateField.Collapsed)){var l=r[o];if(void 0!==l){var d=o.replace(n.a.PerPaneStateField.Collapsed,"");if("Search"===d||l!==this.getCollapsedDefault(a,"Overview"===d,d)||!l&&a.isDemandLoad()){var u=(r[o]?"":"un")+o;t[u]||(t[u]=[]),t[u].push(i)}}}}else delete e[i]}return t},getPerPaneState:function(e,t){var i=this._perPaneState[e];if(i)return i[t]},setPerPaneState:function(e,t,i){this._perPaneState[e]||(this._perPaneState[e]={}),this._perPaneState[e][t]=i},clearPerPaneStateSearch:function(){var e=this._perPaneState;for(var t in e)e.hasOwnProperty(t)&&(e[t][n.a.PerPaneStateField.CollapsedSearch]=void 0)},deletePerPaneState:function(e){this._perPaneState[e]=void 0},isSearched:function(){return a.default.Assert(this.search,"Pane must be initialized: ",this._destroyed),!!this.search&&this.search.isSearched()},isSearchedText:function(){return a.default.Assert(this.search,"Pane must be initialized: ",this._destroyed),!!this.search&&this.search.getValue()},isSearchedFlat:function(){return!1},onSearchChanged:function(){var e=p.a.isValid();if(e&&p.a.reset(),this.paneObjectsByItem={},this.updateItems(),e&&this.numItems()>0){var t=this.indexOfFirstItem();t>=0&&p.a.selectIndex(t,0)}a.default.vmMain.paneManager.updatePaneStateForPane(this)},refreshSearchResults:function(){this.updateItems(!0)},_applyItemStateArr:function(e,t,i){if(e)for(var a=0,n=0;n<e.length;n++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=e[n];this.setPerPaneState(s,t,i)}},applyItemState:function(e){if(e)for(var t in e)if(e.hasOwnProperty(t)){var i=t.startsWith("un"+n.a.PerPaneStateField.Collapsed)?t.slice(2):t;if(i.startsWith(n.a.PerPaneStateField.Collapsed)){var a=e[t];this._applyItemStateArr(a,i,!t.startsWith("un"))}}},requestDemandLoadData:function(e,t){a.default.Assert(!1,"SubClass must override - by default demand load is not supported")},requestDataPage:function(e){a.default.Assert(!1,"SubClass must override - by default data pagination is not supported")},getDefaultDisplayItem:function(){return this.getRootItem()},getRootItem:function(){return a.default.vmMain.root()},setRootItem:function(e,t){a.default.Assert(void 0===e.parent(),"Root should never have a parent"),a.default.Assert(this.getItem()!==e,"Should not be setting root to the same value"),this.setItem(e,t)},onTapSection:function(e){a.default.vmMain.vmPicker.onTapSection(e)},scrollFromMousePosition:function(e,t,i){var s=i?this.getWidth():this.getHeight(),r=a.default.clamp(.1*s,20,40),o=r,l=i?this.getWidth():this.getHeight()-n.a.MobileBottomHeight,d=l-r,u=i?e-this.scrollElement.getBoundingClientRect().left:t-this.contentTop(),c=0;u<o?c=a.default.computeScrollSpeed(0,o,u,4,-1):u>d&&(c=a.default.computeScrollSpeed(d,l,u,4)),0!==c?a.default.repeatScroll("pane",c,this,!1):a.default.cancelRepeatScroll("pane")},getContentElement:function(){return this.paneContent},getPaneIcon:function(){return"icon-align-left"},itemHasChildren:function(){return this.getItem().numItems()>0},getItem:function(){return this.item.get()},allowZoom:function(e){return!0},performOverviewAction:function(e){},setItem:function(e,t){this._numItemSets++;var i=this.getItem();this.item.set(e,!1),this.updateItemsImmediate(!0,!1,!0),i.parent()&&i._updateStylePadding(i.parent().levelsDeep.get(),!0),t&&(e.itemChanged.notify(),e!==i&&i.itemChanged.notify(),this.item.notify(e,i))},getItemSearchParams:function(){return{item:this.getItem(),comparator:this.search.isMatched,noCollapsed:!0,includeNotes:!0,pane:this}},getHeaderSearchParams:function(){return{item:this.getRootItem(),comparator:this.search.isMatched,noCollapsed:!0,collapseAfterDepth:1,headers:!0,overview:!0,pane:this}},setItemsDirty:function(){this._setDirtyState(!1,!1)},isItemsDirty:function(){return!!this.itemsDirtyState},_setDirtyState:function(e,t){this.itemsDirtyState?(this.itemsDirtyState.updateSearch=e||this.itemsDirtyState.updateSearch,this.itemsDirtyState.forceNotify=t||this.itemsDirtyState.forceNotify):this.itemsDirtyState={updateSearch:e,forceNotify:t}},updateItems:function(e,t){this._setDirtyState(e,t),a.default.vmMain.updateAllItems()},updateItemsImmediate:function(e,t,i,n){var s=this;if(!this.isFakePane&&this.isActive.get()){this.itemsDirtyState&&(e=e||this.itemsDirtyState.updateSearch,t=t||this.itemsDirtyState.forceNotify,this.itemsDirtyState=void 0),!this.search.isRunningSearch&&e&&this.search.update(void 0,e,!n);var r=void 0,o=a.default.vmMain.itemBeingModified,l=!0;if(this.search.isUpdatingSearch)r=this.search.getSavedItemsArray();else if(o&&this.isViewOutline()){var d=o.item;if("added"===o.action){for(var u=0,c=d.parent(),h=d.getIndex()-1,f=-1;h>=0&&f<0;){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;var p=c.getChild(h);f=this.indexOfItem(p),h--}f<0?f=this.indexOfItem(c):l=!1,f>=0&&(r=this._allPaneItems).splice(f+1,0,d)}else"removed"===o.action&&(r=this._allPaneItems).remove(d)}if(!r){var m=this.item.get(),v=this.getItemSearchParams(),_=v.each,y=!1;r=[],v.each=function(e){e.isNote()&&e.parent()===m||(r.push(e),y=y||e.isCollapsed(s),_&&_(e))},this.runItemSearch(v)}this._numItemComputes++,this.setItems(r,t),l&&this.updateHeaders(t||i),this.hasCollapsedObs.set(y),this.isInitialized||(this.isInitialized=!0),g.a.fireEvent("itemsUpdated",[this])}},runItemSearch:function(e){a.default.searchVMLIs(e)},updateOutline:function(e,t){var i,a=0,n=[],s=this.getItem().levelsDeep.get();if(t){var r=0,o=0,l=[];for(i=0;i<e.length;i++){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;e[i].isNote()||l.push({item:e[i],index:l.length})}for(l.sort(t),e=[],i=0;i<l.length;i++){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var d=l[i].item;e.push(d),d.hasNote()&&e.push(d.getNote())}}for(i=0;i<e.length;i++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var u=e[i],c=this.paneObjectsByItem[u.id],h=void 0;c?(h=c[0],n.push(h)):(h=new C.a({type:"blockItem",item:u,id:u.id,index:i,parentObject:this.paneObjectsByItem[u.parent().id],levelsDeep:(u.isNote()?u.parent():u).levelsDeep.get()-s-1,sizeInPane:u.sizeInPane}),this.addPaneObject(n,h))}this.items.set(n)},_setItems:function(e,t){this.updateOutline(e)},setItems:function(e,t){!t&&this._searchShowHierarchy===this.search.showHierarchy()&&e.equals(this._allPaneItems)||(this._allPaneItems=e,this._setItems(e,t),p.a.getPane()===this&&p.a.checkValid())},updateHeaders:function(e){var t=[],i=this.getHeaderSearchParams();i.each=function(e){t.push(e)},a.default.searchVMLIs(i),this._numHeaderComputes++,this.setHeaders(t,e)},setHeaders:function(e,t){!t&&e.equals(this.headers.get())||this.headers.set(e)},clearItems:function(e){this.items.set([],e)},onLoad:function(){this.isLoaded=!0,this.getItemStore()===a.default.vmMain.itemStoreManager.getDefaultItemStore()&&g.a.listen("itemNoteSet",this._infiniteList.handleItemNoteSet),this._onAfterLoadedRAF=requestAnimationFrame(this.onAfterLoaded.bind(this))},onInfiniteListLoaded:function(){},onInfiniteListMounted:function(){},onAfterLoaded:function(){this._onAfterLoadedRAF=void 0,this._didInitialScroll||this.isDestroyed()||(isNaN(this.initialOffset)&&(this.initialOffset=this.defaultOffset),0!==this.initialOffset&&this.setScrollOffset(this.initialOffset),this._didInitialScroll=!0,this._infiniteList.saveScrollOfTop()),this.isFakePane&&(this.isFakePane=!1,this.becomeReal())},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function(){var e=this.rect.get().width;return a.default.Assert(e>100,"Pane width is not set",this.rect.get()),e>100?e:u.a.windowWidth()},getHeight:function(){return this.rect.get().height-this.headerHeight()},getLeft:function(){return this.rect.get().left},toggleOverviewVisibility:function(){this.getOverview().toggleDesktop()},notifyDropFrom:function(e){},notifyDropFromToEdit:function(e,t){if(!e.hasChildren()&&e.hasAttachmentType(n.a.PluginType.Storage))return e.getAttachmentByType(n.a.PluginType.Storage).getPlugin().notifyDropFromToEdit(e,t);var i=document.createElement("ul");return i.innerHTML=s.default.toDropHtml(e),i},dropEffectCopyBehavior:function(e,t){return e.clone(t,ChangeType.Local)},_isNodeTextParent:function(e){return R.every(function(t){return!e.classList.contains(t)})},convertElementToText:function(e){var t="";if("TEXTAREA"===e.nodeName)t+=e.value;else if(e.nodeType===Node.TEXT_NODE)t+=e.nodeValue;else if(e.classList.contains("plugin"))t+=n.a.AttachChar;else if(this._isNodeTextParent(e))for(var i=0,a=0;a<e.childNodes.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;t+=this.convertElementToText(e.childNodes[a])}return t},onInputAndroid:function(e){if(e.target&&a.default.findParent(e.target,"item")===p.a.getStartElement()){var t=this.convertElementToText(e.target),i=A.default.getSelectOffsetsInElement(e.target),n=p.a.getStartIndex(),s=t.indexOf("\n");if(!this._hasDetectedEnterAndroid)if(s>=0)s===i.start&&(a.default.clearTimeoutOnce("androidInputSetText"),this.setDetectedEnterAndroid(),p.a.fireKeyEvent(void 0,{normCode:KeyCode.Enter}));else{var r=p.a.getStartItem();a.default.timeoutOnce("androidInputSetText",this.onInputSetText,0,r,t,n,i.start,i.end)}}},onInput:function(e){if(p.a.isValid()){var t=p.a.getStartItem(),i=this.convertElementToText(e.target),n=A.default._getSelectionRange(),s=a.default.getElementParent(e.target),r=A.default.getSelectOffsetsInElement(s,n),o=p.a.getStartIndex();this.onInputSetText(t,i,o,r.start,r.end,e)}},onInputSetText:function(e,t,i,n,s,r){if(!this._hasDetectedEnterAndroid){t=t.replace(new RegExp(TextSpace,"g"),"");var l=w.a.checkMultiplePrefixes(t);if(l!==t){var d=t.length-l.length;n-=d,s-=d,t=l}a.default.showMarkdown()||(n===s&&n>2&&")"===t[n-2]&&P.a.isInsideMarkup(e,n-2,!1,"mdMarkupEnd")&&(t=t.substr(0,n-1)+" "+t.substr(n-1),n++,s++),n===s&&"["===t[n]&&P.a.isInsideMarkup(e,n-1,!1,"mdMarkupStart")&&(t=t.substr(0,n)+" "+t.substr(n))),this.isSettingText=!0,e.setText(t,!0,ChangeType.Local),t.length>0&&(u.a.ios?p.a.selectIndex(i,n,s):u.a.android||p.a.selectIndex(i,s)),this.isSettingText=!1,o.default.updateAutocomplete(r)}this._hasDetectedEnterAndroid=!1},setDetectedEnterAndroid:function(){this._hasDetectedEnterAndroid=!0,setTimeout(function(){this._hasDetectedEnterAndroid=!1}.bind(this),0)},updateSelectionAndroid:function(e){if(u.a.android&&!this._hasDetectedEnterAndroid){var t=a.default.hasClass(e.target,"item")&&e.target.firstElementChild||a.default.hasClass(e.target,"androidInput")&&e.target;if(t){var i=p.a.getStartIndex(),n=A.default.getSelectOffsetsInElement(t);p.a.setSelection(i,n.start,i,n.end)}}},keydown:function(e){if(e.handled)return!0;if(this.updateSelectionAndroid(e),a.default.tooltip.hideTip(),this.isWriteable&&0===this.numItems()&&this.canAddItem&&!a.default.hasClass(this.paneContent,"loading")&&n.a.KeyCodesModifiers.indexOf(e.normCode)<0&&n.a.KeyCodesArrows.indexOf(e.normCode)<0&&this.addItem(e),p.a.isValid()){this.getInfiniteList(!1).reMount();try{o.default.keydown(this,e)||(a.default.preventDefault(e),a.default.stopPropagation(e))}catch(t){a.default.reportError(t,e)}}},keypress:function(e){if(p.a.isValid()){u.a.android&&e.normCode===KeyCode.Enter&&this.setDetectedEnterAndroid();try{o.default.keypress(this,e)||(a.default.preventDefault(e),a.default.stopPropagation(e))}catch(t){a.default.reportError(t,e)}}},keyup:function(e){if(a.default.vmMain.notifyActivity(),p.a.isValid())try{o.default.keyup(this,e)||(a.default.preventDefault(e),a.default.stopPropagation(e))}catch(t){a.default.reportError(t,e)}},compositionStart:function(){p.a.isComposing=!0},compositionEnd:function(e){p.a.isComposing=!1},addItemToPane:function(e,t){var i=this.getItem();e||(e=""),this.setIgnoreRestoreScroll();var a=i.addItemAtIndex(e,t,this);return b.a.setSelected([t],this),a},runUnarchive:function(e){var t=function(e){e.isArchived()&&e.parent().unarchiveChild(e,ChangeType.Local)},i=function(){if(e.hasArchivedAncestor())for(var t=0,i=e.getCollapsedField(this,!1),a=e.parent();void 0!==a;){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(void 0===this.getPerPaneState(a.id,i)&&a.setCollapsed(!1,this,!1),a.isArchived())break;a=a.parent()}}.bind(this);e.hasArchivedAncestor()?a.default.menus.options("An ancestor of this item is still archived. Which items do you want to unarchive?",["Entire Tree","Single Item"],function(n){("Single Item"===n||"Entire Tree"===n)&&(i(),"Single Item"===n?t(e):"Entire Tree"===n&&a.default.vmMain.runFnOnSubtree(e.getArchivedAncestor(!0),t))}):e.hasArchivedDescendant()?a.default.menus.options("Which items do you want to unarchive?",["Entire Subtree","Single Item"],function(n){("Single Item"===n||"Entire Subtree"===n)&&(i(),"Single Item"===n?t(e):"Entire Subtree"===n&&a.default.vmMain.runFnOnSubtree(e,t))}):(i(),t(e)),p.a.reset()},archiveItem:function(e,t){return t.parent().archiveChild(t,ChangeType.Local)},archiveSelected:function(){var e=0,t=this.indexOfPrevVMLI(p.a.getStartIndex(),!0,!0);if(a.default.vmMain.applyToSelection(function(t){this.archiveItem(!0,t)&&e++}.bind(this)),e>0){if(t<0&&this.numItems()>0&&(t=this.indexOfFirstItem()),t>=0){var i=this.itemAtIndex(t).getParsedText().length;p.a.selectIndex(t,i)}var n=e>1?" items.":" item.";a.default.toasts.pushMessage({text:"Archived "+e+n,action:MessageAction.Undo,hold:!0,timeout:void 0})}},deleteSelected:function(e,t){var i=this.indexOfPrevVMLI(p.a.getStartIndex(),!0,!0),s=0;if(a.default.vmMain.applyToSelection(function(t){e&&!e(t)||(t.deleteSelf(ChangeType.Local),s++)}),i<0&&this.numItems()>0&&(i=this.indexOfFirstItem()),i>=0){var r=this.itemAtIndex(i);if(r){var o=r.getParsedText().length;p.a.selectIndex(i,o)}else p.a.reset()}var l=s>1?" items.":" item.";a.default.toasts.pushMessage({text:"Deleted "+s+l,action:MessageAction.Undo,timeout:n.a.ToastTimeoutDefault})},handleLeftSideTap:function(e,t){var i=e.item;if(this.supportCollapsing)if(u.a.mac&&t.metaKey||!u.a.mac&&t.ctrlKey)a.default.vmMain.zoomin(i);else if(i.isCollapsible()){var n=p.a.save(),s=!this.isPaneObjectCollapsed(e);t.shiftKey?this.collapseAll(i,s,!0):this.setPaneObjectCollapsed(s,e),n&&(n.startItem&&!n.startItem.isDescendantOf(i)||p.a.closeKeyboard())}},handleRightSideTap:function(e){this.supportCompleting&&(a.default.vmMain.beginCompleteAction(),e.isComplete(!e.isComplete(),ChangeType.Local),a.default.vmMain.endCompleteAction())},onClickTitle:function(e){a.default.vmMain.zoomout(e),a.default.sendEvent("Menu","Title")},onDoubleClickTitle:function(){this.toggleCollapseAll()},onTap:{onStart:function(e){if(this._disableClick)a.default.preventDefault(e);else if(!a.default.findParent(e.target,"itemNotInPane")&&!a.default.hasClass(e.target,"androidInput")){var t,i;if(this.getInfiniteList(!1).reMount(),this.getInfiniteList(!0).reMount(),u.a.useCustomScroller&&a.default.preventDefault(e),a.default.touchHoldTimeout&&clearTimeout(a.default.touchHoldTimeout),k.isInMultiselect()||this.isOverviewVisible()||this.useCustomScroller&&this.getiScroller()&&this.getiScroller().moved||(i=a.default.getItemForElement(e.target))&&(a.default.touchHoldTimeout=setTimeout(this.onTouchHoldTimeout,a.default.isKeyboardOpen?a.default.iOSDragTimeKeyboardOpen:a.default.iOSDragTime,e)),!k.start(e)){p.a.setFocusedPane(this),i=a.default.getItemForElement(e.target);var n=a.default.getIndexForElement(e.target);if(!i)a.default.getPaneForElement(e.target)===this&&this.indexOfLastItem()>=0&&(i=this.getLastItem(),n=this.indexOfLastItem());if(i&&i.onStart&&i&&i.onStart){var s=this.objectAtIndex(n);(t=i.onStart(n,s,e))&&a.default.preventAndStop(e)}}this._startPrevented=t}},onMove:function(e){if(a.default.isAttachedToDoc(e.target)&&!a.default.findParent(e.target,"itemNotInPane")&&!a.default.hasClass(e.target,"androidInput")){if(a.default.touchHoldTimeout&&(clearTimeout(a.default.touchHoldTimeout),a.default.touchHoldTimeout=void 0),D.a.hide(),!k.update(e)){var t=a.default.getItemForElement(e.startSrc),i=!1;if(!t)a.default.getPaneForElement(e.target)===this&&this.indexOfLastItem()>=0&&(t=this.getLastItem(),i=!0);c.default.isDragging&&(t=c.default.dragItem),t&&t.onMove&&t.onMove(e,i)}return!1}},onClick:function(e){if(!(a.default.findParent(e.target,"itemNotInPane")||a.default.hasClass(e.target,"androidInput")||k.onClickPane(e)||this._startPrevented)){var t,i=a.default.getItemForElement(e.startSrc);if(!i&&a.default.hasClass(e.startSrc,"paneScroller")&&(i=this.getLastItem(),t=this.numItems()-1,(i&&e.clientX<i.getPadding(this)||e.clientX>this.getWidth()-a.default.SPThresholdRight)&&(i=void 0)),i&&(e.targetItem=i),i&&i.onClick){void 0===t&&(t=a.default.getIndexForElement(e.startSrc));var n=this.objectAtIndex(t);this.onClickItem(t,i,n,e)}else a.default.hasClass(e.startSrc,"paneDataPageLoad")||e.startSrc.parentElement&&a.default.hasClass(e.startSrc.parentElement,"paneDataPageLoad")?this.getItem().hasPaginationToken()&&this.requestDataPage(this.getItem()):a.default.hasClass(e.startSrc,"agendaCollapser")||a.default.hasClass(e.startSrc,"dateHeader")||(this.isWriteable&&0===this.numItems()&&this.canAddItem&&!a.default.hasClass(this.paneContent,"loading")?this.addItem(e):a.default.preventDefault(e))}},onEnd:function(e){p.a._isMouseDown=!1,a.default.touchHoldTimeout&&(clearTimeout(a.default.touchHoldTimeout),a.default.touchHoldTimeout=void 0),this.isOverviewVisible()||k.end(e);var t=e.targetItem||a.default.getItemForElement(e.startSrc);!t&&this.indexOfLastItem()>=0&&(t=this.getLastItem()),c.default.isDragging&&(t=c.default.dragItem),t&&("paneContent"===e.startSrc.id&&a.default.preventDefault(e),t&&t.onEnd&&t.onEnd(e))},onDoubleClick:function(e){if(!a.default.findParent(e.target,"itemNotInPane")){var t=a.default.getItemForElement(e.startSrc);if(t&&t.onDoubleClick){var i=a.default.getIndexForElement(e.startSrc);this.onDoubleClickItem(i,t,e)}}},onRightClick:function(e){if(!a.default.findParent(e.target,"itemNotInPane")&&!a.default.isDisplayModeActive(DisplayMode.NoRightClick)){p.a.setFocusedPane(this);var t=a.default.getItemForElement(e.target);if(t&&t.onRightClick){var i=a.default.getIndexForElement(e.target);this.onRightClickItem(i,t,e)}l.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.RightClick,data:{element:void 0,pane:this}})}}},onClickItem:function(e,t,i,a){t.onClick(e,i,a)},onRightClickItem:function(e,t,i){t.onRightClick(e,i)},onDoubleClickItem:function(e,t,i){t.onDoubleClick(e,i)},addItem:function(e,t){var i=this;a.default.vmMain.beginUpdateItems(),t=a.default.getDefaultItemText()+(t||""),p.a.reset();var n=this.addItemToPane(t,0),s=this.indexOfItem(n);if(b.a.setSelected([0],this),this.paneContent&&(p.a.focusPane(this),s>=0)){p.a.selectIndex(s,0)}a.default.vmMain.commitUpdateItems(),e&&setTimeout(function(){a.default.openKeyboardOnIndex(e,i,s,function(){i.setFocused(!0)},function(){})},0),a.default.sendEvent("Menu","AddItemButton")},onClose:function(){},onTapAddItem:function(e){var t=this;if(!this.isOverviewVisible())if(p.a.setFocusedPane(this),this.getScrollOffset()>this.topBoxHeight.get())this.setScrollOffset(0,ScrollDuration.Default,function(){t._infiniteList.saveScrollOfTop(),t.onTapAddItem(e)});else{var i=this.isViewAgenda()?" @today":"";this.addItem(e,i)}},onTapOverviewButton:function(){this.toggleOverviewVisibility(),this.isOverviewVisible()?a.default.sendEvent("Menu","OpenOverview"):a.default.sendEvent("Menu","CloseOverview")},onTapClosePane:function(){var e=a.default.vmMain.paneManager.removePane(this);e&&(a.default.Assert(e===this.id,"Pane IDs must match"),l.a.performAction(TrackerType.UIAction,{type:TrackerUIAction.RemovePane,data:e}),a.default.sendEvent("Menu","ClosePane"),a.default.tooltip.hideTip(),this.onClose())},onTapArchiveCompleted:{onStart:function(e){e.stopImmediatePropagation()},onClick:function(e){this.archiveCompleted(),a.default.preventAndStop(e),a.default.sendEvent("Menu","ArchiveCompleted")}},onTapRefreshData:{onStart:function(e){e.stopImmediatePropagation()},onClick:function(e){a.default.Assert(this.supportDataRefresh,"How did this pane try to perform a data refresh if it is not supported",this.type),this.refreshPaneData(),a.default.sendEvent("Menu","PaneDataRefresh"),a.default.preventAndStop(e)}},onTapReportError:{onStart:function(e){e.stopImmediatePropagation()},onClick:function(e){a.default.Assert(this.supportReportError,"Pane does not support error reporting"),this.reportPaneError(),a.default.sendEvent("Menu","PaneReportError"),a.default.preventAndStop(e)}},getItemsToArchive:function(){var e=[];return a.default.searchVMLIs({item:this.getItem(),each:function(t){t.isComplete()&&!t.isNote()&&e.push(t)}}),e},archiveCompleted:function(){var e,t,i=0;if(p.a.isValid()){var n=0;for(e=p.a.getEndIndex();e<this.items.length();){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if((t=this.itemAtIndex(e))&&!this.itemAtIndex(e).hasCompletedAncestor()){this.objectAtIndex(e);break}e++}}var s=this.getItemsToArchive();for(l.a.beginAction(),a.default.vmMain.beginUpdateItems(),e=s.length-1;e>=0;e--){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;(t=s[e]).parent().archiveChild(t,ChangeType.Local)}if(a.default.vmMain.commitUpdateItems(),l.a.endAction(),s.length>0){var r=s.length>1?" items.":" item.";a.default.toasts.pushMessage({text:"Archived "+(s.length+r),action:MessageAction.Undo,hold:!0,timeout:void 0})}else a.default.toasts.pushMessage({text:"No completed items to archive"});p.a.reset()},updatePosition:function(e,t){this.isAnimatingOffset=t,e=Math.round(e),this.offsetX.set(e)},updatePositionMobile:function(){this.updatePosition(this.isOverviewVisible()?k.overviewWidth():0)},bottomListMessage:function(){},isSearchingRemote:function(){return!1},getTitleList:function(){return this.getItem().parents().concat(this.getItem())},itemTitle:function(){return this.getItem().parent()?this.getItem().getParsedText():this.titleOfFirstItem()},titleOfFirstItem:function(){return this.title},onShowArchivedChanged:function(){this.showArchived.get()&&g.a.fireEvent("showArchived",[]),this.updateItems()},indexOfFirstItem:function(){return this.indexOfNextVMLI(-1)},indexOfLastItem:function(){return this.indexOfPrevVMLI(this.numItems(),!1,!0)},getFirstItem:function(){var e=this.indexOfFirstItem();if(e>=0){var t=this.getItems()[e];return t?t.item:void 0}},getFirstObject:function(){return this.objectAtIndex(this.indexOfFirstItem())},getLastItem:function(){return this.itemAtIndex(this.indexOfLastItem())},getLastObject:function(){return this.objectAtIndex(this.indexOfLastItem())},setFocused:function(e){e&&this.paneContent&&this.paneContent.focus(),this.isFocused.set(e)},headerHeight:function(){return 0},shouldShowSecondHeaderRow:function(){return this.showRootOnRow2||this.getTitleList().length>1},handleUndo:function(){l.a.undoAction()},handleRedo:function(){l.a.redoAction()},contentTop:function(){return E.a.topBarHeight()+this.headerHeight()},indexPageUp:function(e){return e=this._infiniteList.indexPageUp(e),this.itemAtIndex(e)||(e=this.indexOfNextVMLI(e)),e},indexPageDown:function(e){return e=this._infiniteList.indexPageDown(e),this.itemAtIndex(e)||(e=this.indexOfPrevVMLI(e)),e},adjustSelectionFromPaneObject:function(e){a.default.Assert(e,"Must pass in a valid saved selection");var t=e;return e.startItem&&e.endItem&&(e.startIndex=this.indexOfObject(e.startObject),e.endIndex=this.indexOfObject(e.endObject),(e.startIndex<0||e.endIndex<0)&&(t=void 0)),t},restoreSelection:function(e){if(a.default.Assert(e,"Must always have a valid saved selection"),e){var t=this.indexOfObject(e.startObject),i=this.indexOfObject(e.endObject);if(t>=0&&i>=0){var n=e.startOffset,s=e.endOffset,r=e.startItem.getParsedText(),o=e.endItem.getParsedText();(n<0||n>r.length||s<0||s>o.length)&&(n=-1,s=-1),p.a.selectIndices(t,n,i,s)}else p.a.reset()}else p.a.reset()},restoreSelectionAfterCollapse:function(e,t){if(e){var i,n,s=e.startItem,r=this.indexOfItem(e.startItem),o=this.indexOfItem(e.endItem);if(r>=0&&o>=0)p.a.selectIndices(r,e.startOffset,o,e.endOffset),i=e.startItem;else if(r>=0)p.a.selectIndex(r,e.startOffset),i=e.startItem,n=!0;else if(o>=0)p.a.selectIndex(o,e.endOffset),i=e.endItem,n=!0;else if(!0===t){var l=0;for(i=s;i;){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;var d=i.parent();if(d===a.default.focusedPane.item.get()){p.a.selectItem(i,i===s?p.a.getStartOffset():-1),n=!0;break}i=d}}else p.a.reset();i&&n&&a.default.focusedPane.scrollItemToMiddle(i,ScrollDuration.Snap)}},setCollapsedRecursive:function(e,t,i){var a=0,n=e.numChildren(),s=e.getItems();!i||this.isSearchedFlat()&&!this.search.isMatched(e)||e.setCollapsed(t,this,!1,!1);for(var r=0;r<n;++r){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var o=s[r];o.hasChildren()&&(this.isSearchedFlat()||this.search.isMatched(o))&&this.setCollapsedRecursive(o,t,!0)}},collapseAll:function(e,t,i,n){a.default.Assert(this.supportCollapsing,"Should not be collapsing all");var s=e||this.item.get(),r=p.a.save();this.setIgnoreRestoreScroll(),a.default.vmMain.beginUpdateItems(),void 0!==t&&this.setCollapsedRecursive(s,t,!!i),a.default.vmMain.paneManager.updatePaneStateForPane(this),(n||this.isSearchedFlat())&&this.updateItems(),a.default.vmMain.commitUpdateItems(),this.restoreSelectionAfterCollapse(r,t)},toggleCollapseAll:function(){if(this.supportCollapsing){var e=!this.hasCollapsed();this.collapseAll(this.item.get(),e)}},hasCollapsed:function(e){return this.hasCollapsedObs.get()},onOverviewToggled:function(e){this.useCustomScroller&&(e?this.getiScroller().disable():(this.getiScroller().enable(),this._disableClick=!1))},onTouchHoldTimeout:function(e){a.default.touchHoldTimeout=void 0,a.default.isKeyboardOpen&&!this.isOverviewVisible()&&this.useCustomScroller&&this.getiScroller().disable(),k.disable(),g.a.fireEvent("touchHoldTimeout",[e])},getPaddingForPaneObject:function(e,t){var i=e.levelsDeep,n=t?e:e.item,s=!t&&this.isSearchedFlat()?d.a.itemIndentStart(this):n.getPadding(this,t,i);return s>this.getWidth()-a.default.SPThresholdRight&&(s=this.getWidth()-a.default.SPThresholdRight-8),s},maxWidthOfPaneObject:function(e){var t=this.getPaddingForPaneObject(e,!1);return this.getWidth()-t-a.default.SPThresholdRight-(e.item.hasPrefix()?this.shouldRenderPrefix(e)?n.a.PrefixWidth:5:0)},prevPaneObjectAtSameLevel:function(e){var t=0;a.default.Assert(e>=0,"Must supply a valid selection index: "+e),a.default.Assert(e<this.numItems()+1,"Must supply a valid selection index: "+e);for(var i=this.objectAtIndex(e),n=e-1;n>=0;){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=this.objectAtIndex(n),r=this.itemAtIndex(n);if(r&&i.item!==r&&!r.isNote()&&s.levelsDeep===i.levelsDeep)return s;n--}},indexOfPrevVMLI:function(e,t,i){var n=0;a.default.Assert(e>=0,"Must supply a valid selection index: "+e),a.default.Assert(e<this.numItems()+1,"Must supply a valid selection index: "+e);for(var s=t?this.itemAtIndex(e):void 0,r=e-1;r>=0;){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var o=this.itemAtIndex(r);if(o&&s!==o&&(!i||!o.isNote()))return r;r--}return-1},indexOfNextVMLI:function(e,t,i){var n=0;a.default.Assert(e>=-1,"Must supply a valid selection index: "+e),a.default.Assert(e<this.numItems(),"Must supply a valid selection index: "+e);for(var s=t?this.itemAtIndex(e):void 0,r=e+1;r<this.numItems();){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var o=this.itemAtIndex(r);if(o&&s!==o&&(!i||!o.isNote()))return r;r++}return-1},indexOfNextSibling:function(e){var t=0;a.default.Assert(e>=-1,"Must supply a valid selection index: "+e),a.default.Assert(e<this.numItems(),"Must supply a valid selection index: "+e);var i=this.itemAtIndex(e);for(e=this.indexOfNextVMLI(e);e>=0;){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(!this.itemAtIndex(e).isDescendantOf(i))break;e=this.indexOfNextVMLI(e)}return e>=0?e:-1},_getPrevNextItem:function(e,t,i){var a=i?this.indexOfNextVMLI:this.indexOfPrevVMLI,n=a.call(this,e);if(t)for(var s=0,r=this.itemAtIndex(e);n>=0;){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var o=this.itemAtIndex(n);if(r.parent()===o.parent())return o;if(r.parent()===o||o.parent()===r.parent().parent()){n=-1;break}n=a.call(this,n)}else if(n>=0)return this.itemAtIndex(n)},getPreviousItem:function(e,t){return this._getPrevNextItem(e,t,!1)},getNextItem:function(e,t){return this._getPrevNextItem(e,t,!0)},getFirstSelectedItem:function(){var e;return this.applyToSelection(function(t){return e=t,!1}),e},getFirstSelectedIndex:function(){return p.a.getStartIndex()},applyToSelection:function(e,t){k.isInMultiselect()?b.a.applyFnToSelected(e,this):a.default.vmMain.applyToSelection(e,t)},applyPriorityToSelection:function(e,t){t?a.default.vmMain.applyFnToSelection("priority",{toggle:!0,value:e,value2:ChangeType.Local,emptyValue:VMLIFlag.None}):a.default.vmMain.applyFnToSelection("priority",{value:e,value2:ChangeType.Local})},autocompleteTag:function(){this._autocompletePopup({mode:"tag",text:"Add tag",buttonText:"Add"},function(e,t){var i=t.value.trim(),a=e.getParsedText()+" "+n.a.TagPrefix+i;e.setText(a,!0,ChangeType.Local)})},autocompleteDate:function(){this._autocompletePopup({mode:"date",text:"Choose date",buttonText:"Schedule"},function(e,t){var i=t.value.trim(),a=e.getParsedText()+" "+n.a.DatePrefix+i;e.setText(a,!0,ChangeType.Local)})},autocompleteMove:function(e,t){var i=this;(e=e||{}).mode=n.a.AutocompleteMode.Move,e.text="Select item to move to",e.buttonText="MOVE",this._autocompletePopup(e,function(e,t){var a;t.subItemText?(a=i.createVMLI({text:t.subItemText},{parent:t.item,changeType:ChangeType.AllLocal}),t.item.insertItem(a,0)):t.item===e||t.item.isDescendantOf(e)||(a=t.item),a&&i.moveItem(e,a)},function(){t&&t(),p.a.updateCaret()})},autocompleteJump:function(e,t){var i=this;(e=e||{}).mode=n.a.AutocompleteMode.Jump,e.text="Select item to jump to",e.buttonText="JUMP",this._autocompletePopup(e,function(){},function(e){e.item&&i.indexOfItem(e.item)>=0&&(p.a.selectItem(e.item,0,0),i.scrollItemToTop(e.item,ScrollDuration.Default)),t&&t(),p.a.updateCaret()})},autocompleteSnooze:function(e,t,i){var s,r=this,o=a.default.vmMain.pluginManager.getPlugin(PluginID.Gmail);if(!t){var l=e&&e.item||this.getFirstSelectedItem();l&&(s=l.getAttachmentByPlugin(o.id))&&(t=s.getField("accountID"))}var d=function(){var t=e&&e.elementDisplay;if(!t){var i=r.getFirstSelectedIndex();t=r.elementAtIndex(i)}a.default.menus.openContextMenu({componentName:"ReactContextMenuAuthorize",element:t,message:"Your account needs additional authorization to Snooze. Please update your authorization to enable Snooze."})},u=a.default.settings.get(Settings.enableOfflineAuth);T.a.isConnected()?u?(a.default.toasts.clearMessage(MessageID.SnoozeOffline),(e=e||{}).mode="snooze",e.text="Snooze until date",e.buttonText="SNOOZE",e.allowCustom=!0,this._autocompletePopup(e,function(e,t){o.beginAction();var i=t.value.trim(),r=y.a.parseDateDefaultFormat(i);if(s=e.getAttachmentByPlugin(o.id))if(a.default.isDateValid(r))if(T.a.isLinkedAccountAuthorized(s.getField("accountID"),GScope.GmailModify)){var l=r.getTime()-Date.now();l<a.default.weeks(1)?o.performAction(n.a.PluginAction.Gmail.Snooze,!1,s,l):a.default.toasts.pushMessage({text:"Maximum snooze delay is one week. Please enter a date less than a week from now.",action:MessageAction.Okay})}else a.default.menus.closeContextMenu(),d();else a.default.toasts.pushMessage({text:"Unable to read date. Please try a different option.",action:MessageAction.Okay});else a.default.toasts.pushMessage(MessageID.ReselectEmail);o.endAction()},i)):d():a.default.toasts.pushMessage(MessageID.SnoozeOffline)},autocompleteSchedule:function(e,t){(e=e||{}).mode="date",e.text="Add event on date",e.buttonText="Add",e.allowCustom=!0;var i=a.default.vmMain.pluginManager.getPlugin(PluginID.Gmail);this._autocompletePopup(e,function(e,t){l.a.beginAction();var n=t.value.trim(),s=y.a.parseDateDefaultFormat(n);a.default.isDateValid(s)?i.scheduleEmail(e,s):a.default.toasts.pushMessage({text:"Unable to read date. Please try a different option.",action:MessageAction.Okay}),l.a.endAction()},t)},autocompleteLabel:function(e,t){var i,s=this,r=a.default.vmMain.pluginManager.getPlugin(PluginID.Gmail),o=function(e){var t=e.getAttachmentByPlugin(r.id),n=t.getPlugin().getDisplayTags(t);i=i?a.default.arrayIntersection(i,n):n};(e=e||{}).item?o(e.item):this.applyToSelection(o),e.tokens=(i||[]).map(function(e){return{text:e}}),e.mode=n.a.AutocompleteMode.GmailLabel,e.text="Select a label",e.buttonText="LABEL",e.allowCustom=!0,e.allowEmpty=!0,e.onTokenRemoved=function(i){var o=i.text;r.beginAction();var l=function(e){var t=e.getAttachmentByPlugin(r.id);t?r.attachmentHasLabel(t,o)?r.performAction(n.a.PluginAction.Gmail.RemoveLabel,!1,t,o):a.default.Assert(!1,"Tried to remove a tag from an attachment without a tag"):a.default.toasts.pushMessage(MessageID.ReselectEmail)};e.item?l(e.item):s.applyToSelection(l),r.endAction(),t&&t(i)},this._autocompletePopup(e,function(e,t){var i=t.value.trim();a.default.Assert(e.hasPluginAttachment(r.id),"Must have valid plugin attachment");var s=e.getAttachmentByPlugin(r.id);if(s){if(i){var o=r.createLabelString(i);o?r.attachmentHasLabel(s,o)||r.performAction(n.a.PluginAction.Gmail.AddLabel,!1,s,o):a.default.toasts.pushMessage({text:"Cannot create a label with a reserved named.",action:MessageAction.Okay})}}else a.default.toasts.pushMessage(MessageID.ReselectEmail)})},_autocompletePopup:function(e,t,i){var a=this;e.onSelected=function(n){e.item?t(e.item,n):a.applyToSelection(function(e){t(e,n)}),i&&i(n)},D.a.showPopup(e)},moveItem:function(e,t){l.a.beginAction(),a.default.vmMain.beginUpdateItems(),t.belongsToSameItemStore(e)?e.moveTo({parent:t,index:0},ChangeType.Local):a.default.Assert(!1,"Currently do not support moving items between item stores"),a.default.vmMain.commitUpdateItems(),l.a.endAction()},setPropDefault:function(e,t){void 0===this[e]&&(this[e]=t)},setExpanded:function(e,t){var i=this.isExpanded.get()!==e;this.isExpanded.set(e),i&&!1!==t&&(g.a.fireEvent("panesChanged",[]),a.default.vmMain.paneManager.updatePaneStateForPane(this),a.default.vmMain.paneManager.ensurePaneInView(this))},modifyTextOnDropBasedOnSearch:function(e,t,i,a,n,s){var r=0;if(!i||!i.search)return e;var o,l,d=i.search,u=this.search,c=t[s](),h=d[s](),f=u[s](),p=[],g=[];for(o=0;f&&o<f.length;o++){var m=0;if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;l=f[o];for(var v=a,_=!c||c.indexOf(l)<0;_&&v;){if(m++>5e3&&__infLoop&&__infLoop(m))throw new RangeError;var y=v[s]();y&&y.indexOf(l)>=0&&(_=!1),v=v.parent()}_&&p.push(n+l)}if(p.length){var S=0;for(o=0;c&&h&&o<h.length;o++){if(S++>5e3&&__infLoop&&__infLoop(S))throw new RangeError;l=h[o],c.indexOf(l)>=0&&f.indexOf(l)<0&&g.push(n+l)}var w=p.join(" ");if(g.length>0){var I=0;for(o=0;o<g.length;o++){if(I++>5e3&&__infLoop&&__infLoop(I))throw new RangeError;l=g[o],e=0===o?e.replace(l,w):e.replace(l,"")}}else e=e+" "+w;e=e.replace(/  +/g," ")}return e},canAcceptDragOver:function(){return this.isDropTarget},handleDragOver:function(e,t,i,n,s){var r=a.default.getElementParent(i),o=r&&a.default.getItemForElement(r),l=(r||a.default.findParent(i,"blockHeader"))&&a.default.getPaneObjectForElement(i),d={};return r&&a.default.findParent(r,"overviewList")?(this.overview.updateDragHoverItem(o),d={overview:!0,targetItem:o,targetElement:r}):(this.overview.updateDragHoverItem(null),d=this._handleDragOverPane(e,t,i,r,l,n,s)),d},_handleDragOverPane:function(e,t,i,a,n,s,r){},handleDragDrop:function(e,t,i,a){i&&e!==i.targetItem&&i.targetItem&&this._handleDragDrop(e,t.dataTransfer,i,t,a),this.revertDrag()},_handleDragDrop:function(e,t,i,s,r){for(var o=0,d=i.overview,c=!0,h=t.pane,f=e,p=i.targetItem,m=p.parent();m&&c;){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;m===e&&(c=!1),m=m.parent()}if(c){var v,_=-1;if(d)_=(v=p).numChildren();else if(i.dropOnPane)v=p,_=i.atEnd?p.numItems():0;else if(i.position===n.a.DragDropPosition.Above)v=p.parent(),_=p.getIndex();else if(i.position===n.a.DragDropPosition.On){v=p,_=u.a.mac&&s.ctrlKey||!u.a.mac&&s.altKey?0:p.numItems()}else{var y=this.indexOfItem(p),S=this.getNextItem(y);S&&S.parent()===p&&!S.isNote()?(v=p,_=0):(v=p.parent(),_=p.getIndex()+1)}l.a.beginAction(),a.default.Assert(v,"Trying to move without a target"),a.default.Assert(!isNaN(_),"Trying to move without a target index");var w=!0;if(t.dropEffect===n.a.DropEffect.Move){var I=e.parent();if(I){var b=e.getIndex();if(I.belongsToSameItemStore(v)){e.moveTo({parent:v,index:_},ChangeType.Local),l.a.performAction(TrackerType.Move,{itemID:e.id,oldParent:I.id,oldPosition:b,newParent:v.id,newPosition:_});var A=e.getRawText();A=this.modifyTextOnDropBasedOnSearch(A,e,h,v,n.a.TagPrefix,"getTags"),(A=this.modifyTextOnDropBasedOnSearch(A,e,h,v,n.a.ContactPrefix,"getContacts"))!==e.getRawText()&&e.setText(A,!0,ChangeType.Local)}else e=e.clone(v,ChangeType.Local),v.insertItem(e,_),I.removeChildAtIndex(b,ChangeType.Local)}else e=e.clone(v,ChangeType.Local),v.insertItem(e,_)}else r||(e=t.pane?t.pane.dropEffectCopyBehavior(e,v):e.clone(v,ChangeType.Local)),e?(e.parent(v),v.insertItem(e,_)):w=!1;w&&(g.a.fireEvent("droppedItem",[f,this,t.pane]),l.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.DropItem,data:{itemID:e.id,toPane:this,fromPane:t.pane}})),l.a.endAction(),w&&t.pane&&t.pane.notifyDropFrom(e,this)}},revertDrag:function(){this.overview&&this.overview.updateDragHoverItem(null)},isItemHeader:function(e,t){return t?e.hasHeaderChildren():e.hasVisibleChildren(this)},onNotePopupClosed:function(){},openNoteContextMenu:function(){var e=p.a.getStartItem(),t=p.a.getStartIndex(),i=t-1,s=p.a.getStartOffset(),r=p.a.getEndOffset(),o=this.elementAtIndex(t);if(o){a.default.Assert(o.firstChild,"Opening a note should have a firstChild",a.default.getElementPath(o)),o.firstChild&&(o=o.firstChild),void 0!==s&&void 0===r&&(r=s);var l={componentName:"ReactNotePopup",onClosed:this.onNotePopupClosed.bind(this),element:o,item:e.parent(),note:e,pane:this,noBackdrop:!0,index:t,position:"fill",selectionStart:s,selectionEnd:r};a.default.menus.isContextMenuOpen()&&a.default.menus.closeContextMenu(),this._editingNote={note:e,index:t,itemIndex:i};var d=e.parent();l.bottom=u.a.getKBSize(),l.positionOffset={top:-12},this.scrollItemToTop(d,0,function(){a.default.menus.openContextMenu(l),k.setTopBarMode(n.a.TopBarMode.Note)})}},closeNoteContextMenu:function(){if(a.default.menus.isContextMenuOpen()){if(u.a.ios){var e=this._editingNote,t=e.note,i=e.itemIndex,n=t.parent().getParsedText().length;p.a.selectIndex(i,n),this._editingNote=void 0}a.default.menus.closeContextMenu()}},canResetMultiselect:function(){return!0},replaceTextOnDropOnBlock:function(e,t,i,a){var n=t.isNoKey?"":t.name,s=i&&i.name.replace(a,""),r=e.getRawText();(""===n||r.indexOf(n)<0)&&(s?r=r.replace(a+s,n):r+=" "+n,e.setText(r,!0,ChangeType.Local))},applyDropOnBlock:function(e,t,i,s){var r,o=e;if(p.a.setFocusedPane(i),o.isStarred||o.isImportant)o.isStarred?t.isStarred(!0,ChangeType.Local):o.p0||o.isImportant?r=VMLIFlag.P0:o.p1?r=VMLIFlag.P1:o.p2&&(r=VMLIFlag.P2),r&&t.priority(r,ChangeType.Local);else if(e.isTag)this.replaceTextOnDropOnBlock(t,e,s&&s.isTag?s:void 0,"#");else if(e.isContact)this.replaceTextOnDropOnBlock(t,e,s&&s.isContact?s:void 0,"+");else if(e.isPriority)t.priority(e.priority,ChangeType.Local);else{var l=!0;if(t.hasAttachmentType(n.a.PluginType.Calendar)){var d=t.getAttachmentByType(n.a.PluginType.Calendar);d&&d.getField("recurringEventId")&&t.getCalendarParsedText()===d.getField("summary")&&(a.default.toasts.pushMessage({text:"Moo.do does not currently support modifying repeated events.",actionText:"OKAY"}),l=!1)}if(l){var u="";if(o.isDate&&a.default.isDateValid(o.date)){var c=t.date(),h=!o.allDay&&(o.dateTime||c&&c.hasTimeOfDay()&&c);n.a.DatePrefix,u=h?y.a.getAppendDateText(o.date,h):y.a.getAppendDateText(o.date),u=n.a.DatePrefix+u}else u=o.id;if(u){t.setDateDuration(u,o.duration?a.default.round(o.duration,2)+"hr":"");var f=a.default.vmMain.getDefaultCalendarPlugin();if(a.default.isDateValid(o.date)&&f&&i!==this&&!t.hasAttachmentType(n.a.PluginType.Calendar))if(f.getDefaultExportCalendarID()){var g=a.default.vmMain.pluginManager,m=PluginSettingsID.GCalendar.SyncDraggedEvents,v=function(){g.getSetting(PluginID.GCalendar,m)&&f.createEventForItem(t)};a.default.vmMain.shouldShowHelp("syncNewEvents")?a.default.menus.confirm("Add events to Google Calendar when dropping onto the Calendar pane?",function(e){a.default.vmMain.closeHelp("syncNewEvents"),g.setSetting(PluginID.GCalendar,m,e),v()}):v()}}}}if(i.isEditable){var _=i.indexOfItem(t,e);_>=0&&p.a.selectIndex(_,t.getParsedText().length)}},setIgnoreRestoreScroll:function(e,t){var i=this;this._ignoreRestoreScroll=!0,this._ignoreRestoreScrollTimeout&&clearTimeout(this._ignoreRestoreScrollTimeout),this._ignoreRestoreScrollTimeout=setTimeout(function(){i._ignoreRestoreScroll=!1,t&&t()},e||100)},isIgnoringRestoreScroll:function(){return this._ignoreRestoreScroll},zoomInOnSwipe:function(e){var t=this.item.get();a.default.vmMain.zoomin(e),a.default.toasts.pushMessage({text:"<b>Zoomed in to:</b><br>"+e.getParsedText(),action:function(){a.default.vmMain.zoomin(t)},hold:!1,actionText:"UNDO"})},getSwipeMenuItems:function(){var e=this;return{leftOuter:{text:"Zoom",icon:"icon-zoom-in",color:"#09d",fn:this.zoomInOnSwipe},leftInner:{text:function(t){return e.supportCollapsing&&t.isCollapsible()?t.isCollapsed(e,!1)?"Expand":"Collapse":"Zoom"},icon:function(t){return e.supportCollapsing&&t.isCollapsible()?"icon-"+(t.isCollapsed(e,!1)?"caret-down":"caret-right"):"icon-zoom-in"},color:function(t){return e.supportCollapsing&&t.isCollapsible()?"#777":"#09d"},fn:function(t){e.supportCollapsing&&t.isCollapsible()?(t.toggleCollapsed(e),p.a.closeKeyboard()):e.zoomInOnSwipe(t)}},rightInner:{text:function(e){return e.isComplete()?"Uncomplete":"Complete"},icon:"icon-check",color:"#0c0",fn:function(t){e.supportCompleting&&(a.default.vmMain.beginCompleteAction(),t.isComplete(!t.isComplete(),ChangeType.Local),a.default.vmMain.endCompleteAction())}},rightOuter:{text:"Delete",icon:"icon-delete",color:"#a30",fn:function(e){var t;(e.deleteSelf(ChangeType.Local),e.hasAttachmentType(n.a.PluginType.Email))?t=e.getAttachmentByType(n.a.PluginType.Email).getField("subject"):t=e.getParsedText();a.default.toasts.pushMessage({text:"<b>Deleted:</b><br>"+t,action:function(){l.a.undoAction()},hold:!1,actionText:"UNDO"})}}}},getSwipeMenuItem:function(e,t){var i=u.a.windowWidth(),a=.16*i,n=.45*i,s=this.swipeMenuItems;return t>n?s.leftOuter:t>a?s.leftInner:t<-n?s.rightOuter:t<-a?s.rightInner:{color:"#ddd"}},_openSelectedInMode:function(e){var t=p.a.getStartItem();t&&this.openEmailByItem(t,e)},replySelected:function(){this._openSelectedInMode(n.a.EmailResponseMode.Reply)},replyAllSelected:function(){this._openSelectedInMode(n.a.EmailResponseMode.ReplyAll)},forwardSelected:function(){this._openSelectedInMode(n.a.EmailResponseMode.Forward)},openEmailByItem:function(e,t){if(e){var i=e.getAttachmentByPlugin(PluginID.Gmail);(i&&i!==L.a.getThreadAttach()||!L.a.isOpenOnPane(this)||t)&&i.getPlugin().openEmailByItem(e,this,t)}},markItemRead:function(e,t){var i=a.default.vmMain.getDefaultEmailPlugin(),s=t.getAttachmentByPlugin(i.id),r=e?n.a.PluginAction.Gmail.MarkRead:n.a.PluginAction.Gmail.MarkUnread;a.default.Assert(s,"Must be able to get a valid attachment"),(e&&i.isItemUnread(t)||!e&&!i.isItemUnread(t))&&i.performAction(r,!1,s)},markReadSelected:function(e){var t=a.default.vmMain.getDefaultEmailPlugin();t.beginAction(),this.applyToSelection(this.markItemRead.bind(this,e)),t.endAction()},toggleStarSelected:function(){var e,t=a.default.vmMain.getDefaultEmailPlugin();t.beginAction(),this.applyToSelection(function(i){var s=i.getAttachmentByPlugin(t.id);a.default.Assert(s,"Must be able to get a valid attachment");var r=t.isItemStarred(i);void 0===e&&(e=r?n.a.PluginAction.Gmail.Unstar:n.a.PluginAction.Gmail.Star),(r&&e===n.a.PluginAction.Gmail.Unstar||!r&&e===n.a.PluginAction.Gmail.Star)&&t.performAction(e,!1,s)}),t.endAction()},selectIndex:function(e,t){p.a.selectIndex(e,t||0)},onAdded:function(){this.isEditable&&this.isWriteable&&setTimeout(this.selectFirstItem.bind(this),0)},selectFirstItem:function(){var e=this.indexOfFirstItem();e>=0&&p.a.selectIndex(e,0)},isOverviewVisibleInPane:function(e){var t=this.item.get();return e===t||e.isDescendantOf(t)},getContentWidth:function(){return this.getWidth()},getContentHeight:function(){return this.getHeight()},getMinItemSize:function(){return Math.ceil(d.a.itemLineHeight()+2*d.a.itemPadding()+(d.a.noteLineHeight()+d.a.itemPadding()))/2},onZoom:function(){this.setScrollOffset(this.defaultOffset)},widthOfDrag:function(){},getSubItems:function(e,t){var i=[],a={item:e,comparator:this.search.isMatched,pane:this,each:function(e){t&&e.isComplete()||i.push(e)}};return this.runItemSearch(a),i},getMetricsForPaneObject:function(e,t,i){var n;try{n=M.default.measurePaneObject(e,this,a.default.settings.get(Settings.showMarkdown)&&i)}catch(e){a.default.reportError(e)}return n},getStyledLinesForPaneObject:function(e,t,i){var a=e.item;if(a.isNote())return[a.getNotePreviewText()];var n=this.getMetricsForPaneObject(e,t,i);return n?n.styledLines:[a.getParsedText()]},isItemInPane:function(e){return this.indexOfItem(e)>=0},isItemTopLevel:function(e,t){return t.levelsDeep.get()-this.item.get().levelsDeep.get()==1},checkHeightChanged:function(e,t){return this._infiniteList.checkHeightChanged(e,t)},getCollapsedDefault:function(){return!1},isViewProject:function(){return!1},isViewDates:function(){return!1},isViewAgenda:function(){return!1},isViewCalendar:function(){return!1},isViewOutline:function(){return!1},isViewGroups:function(){return!1},isViewText:function(){return!0},isViewFlatList:function(){return!1},shouldShowAddBox:function(){return!1},viewModeIcon:function(){return""},extraPaddingForPaneObject:function(){return 0},createVMLI:function(e,t){var i=s.default.createVMLI(e,t);return this.search.stickMatch(i),i},selectNearestItem:function(e){var t=this.indexOfNextSibling(e);t<0&&(t=this.indexOfPrevVMLI(e,!0,!0)),t>=0?p.a.selectIndex(t,0):p.a.reset()},supportsSortBlocks:function(){return!1},supportsSortBlocksMode:function(){return!1},supportsSortItems:function(){return!1},getViewMode:function(){},scrollToTop:function(e){this.setScrollOffset(0,e)},setName:function(e){this.name.set(e),a.default.vmMain.paneManager.savePaneState()},setWidthManual:function(e,t){isNaN(e)?this.widthManual=this.widthManualExpanded=e:t?(e=a.default.clamp(e,n.a.EmailPreviewSizeMin,n.a.EmailPreviewSizeMax),this.widthManualExpanded=e):(e=a.default.clamp(e,this.minWidth,this.maxWidth),this.widthManual=e),a.default.vmMain.paneManager.updatePaneStateForPane(this),a.default.vmMain.paneManager.updatePaneRects(!isNaN(e))},isPaneObjectCollapsed:function(e,t){return(a.default.isVMLI(e)?e:e.item).isCollapsed(this,t)},setPaneObjectCollapsed:function(e,t,i,n){return(a.default.isVMLI(t)?t:t.item).setCollapsed(e,this,i,n)},shouldRenderPrefix:function(e){return!0},needsUpdateForDate:function(){return!1},needsUpdateForTags:function(){return!1},handleItemChanged:function(e,t,i){var a=this.getInfiniteList();if(i=i||!1,this.clearPaneObjectsForItem(e),t[n.a.ItemProp.Items]&&(d.a.boldHeaders()&&a.clearItemInfoForItem(e),i=!0),t[n.a.ItemProp.Text]){var s=a.handleItemTextChanged(e);if(i=i||s,this.supportSearchListenTextChanges){var r=this.search.handleItemTextChanged(e);i=i||r}}if(t[n.a.ItemProp.Search]){var o=this.search.handleItemChanged(e);i=i||o}if(t[n.a.ItemProp.Date]&&(i=i||this.needsUpdateForDate(e)),t[n.a.ItemProp.Tags]&&(i=i||this.needsUpdateForTags(e,t[n.a.ItemProp.Tags])),i)return this.preventUpdateItemsForItem&&this.preventUpdateItemsForItem.item===e?this.setItemsWillBeDirty():this.setItemsDirty(),!0},addPaneObject:function(e,t){var i=t.item;e.push(t),i&&(this.paneObjectsByItem[i.id]?this.paneObjectsByItem[i.id].push(t):this.paneObjectsByItem[i.id]=[t])},getPaneObjectsForItem:function(e){return this.paneObjectsByItem[e.id]},getPaneObjectForItemWithId:function(e,t){var i=this.paneObjectsByItem[e.id];if(i){var a=i.indexOfWithProperty("id",t);if(a>=0)return i[a]}},clearPaneObjectsForItem:function(e){var t=0;this.paneObjectsByItem[e.id]=void 0;for(var i=e.items.get(),a=0;a<i.length;a++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this.clearPaneObjectsForItem(i[a])}}},r.a.defineBase(O),a.default.VMPane=O;t.a=O},function(e,t,i){"use strict";var a=i(0),n=i(6),s=i(5),r=i(4),o=i(16),l=i(7),d=i(8),u=i(23);i(11);function c(){this.pluginsAvailable=[PluginID.Contacts,PluginID.Drive,PluginID.GCalendar,PluginID.Gmail],this._pluginEnabledObservables={},this._pluginOptionObservables={},this.isRefreshingContacts=new d.a(!1),this.GCalendarsAvailable=new u.a,this.GCalendarSyncErrors=new u.a(void 0),this.GCalendarAddFailure=new d.a(!1),this.GCalendarListFailure=new d.a(!1),this.GCalendarListLoading=new d.a(!1),this.GmailNumSyncd=new d.a(0),this.GmailNumTotal=new d.a(0),this.GmailCacheSize=new d.a(0),this.GmailSyncAccounts=new u.a,this.enableOfflineAuth=new d.a(!1),this.isSaveEnabled=new d.a(!1),this.hasRefreshed=!1,s.a.forceBind("calendarComparator",this)}c.prototype={init:function(){var e=a.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar),t=e.getSetting(e.Settings.ImportCalendars);t&&this.GCalendarsAvailable.set(t)},checkRefresh:function(){this.hasRefreshed||this.refreshPluginStatus()},refreshPluginStatus:function(e){var t=0;this.hasRefreshed=!0;for(var i=0;i<this.pluginsAvailable.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n,s=this.pluginsAvailable[i];n=s===PluginID.Contacts?a.default.settings.get(Settings.syncContacts):a.default.vmMain.pluginManager.isAuthorized(s),this.updatePluginStatus(s,n)}e&&e!==PluginID.GCalendar||(this.updatePluginOptionStatus(PluginID.GCalendar,PluginSettingsID.GCalendar.WriteAccess),this.updatePluginOptionStatus(PluginID.GCalendar,PluginSettingsID.GCalendar.ImportCalendars,!0),this.updatePluginOptionStatus(PluginID.GCalendar,PluginSettingsID.GCalendar.ExportCalendar)),e&&e!==PluginID.Drive||this.updatePluginOptionStatus(PluginID.Drive,PluginSettingsID.Drive.WriteAccess),this.enableOfflineAuth.set(a.default.settings.get(Settings.enableOfflineAuth))},refresh:function(e){this.refreshPluginStatus(),e&&e!==PluginID.GCalendar||(this.GCalendarAddFailure.set(!1),this.GCalendarListFailure.set(!1),this.updateCalendarList()),e&&e!==PluginID.Gmail||this.updateGmailInfo()},calendarComparator:function(e,t){return e.summary.localeCompare(t.summary)},updateGmailInfo:function(){var e=a.default.vmMain.pluginManager.getPlugin(PluginID.Gmail);e.getTotalMessageCount(function(e){this.GmailNumTotal.set(e)}.bind(this)),e.getSyncdMessageCount(function(e){this.GmailNumSyncd.set(e)}.bind(this)),this.GmailSyncAccounts.set(e.getSyncAccounts())},updateCalendarList:function(){if(a.default.vmMain.pluginManager.isAuthorized(PluginID.GCalendar)){var e=a.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar);this.GCalendarListLoading.set(!0),e.getFullCalendarList(function(e){this.GCalendarListLoading.set(!1,!1),e?(e.sort(this.calendarComparator),this.GCalendarsAvailable.set(e),this.GCalendarListFailure.set(!1)):this.GCalendarListFailure.set(!0)}.bind(this))}},getEnabledPlugins:function(){this.checkRefresh();var e=this._pluginEnabledObservables;return Object.keys(e).filter(function(t){return e[t].get()})},getPluginEnabledObservable:function(e){return this.checkRefresh(),this._pluginEnabledObservables[e]},isPluginEnabled:function(e){return this.checkRefresh(),this._pluginEnabledObservables[e].get()},getPluginOptionObservable:function(e,t){return this.checkRefresh(),this._pluginOptionObservables[e][t]},getPluginOptions:function(e){return this.checkRefresh(),this._pluginOptionObservables[e]},isPluginAnOption:function(e){return e===PluginID.Mailbird?r.a.embed===EmbedApps.Mailbird:this.pluginsAvailable.indexOf(e)>=0},updatePluginStatus:function(e,t,i){this._pluginEnabledObservables[e]?this._pluginEnabledObservables[e].set(t,i):this._pluginEnabledObservables[e]=new d.a(t)},updatePluginOptionStatus:function(e,t,i){var n=a.default.vmMain.pluginManager.getSetting(e,t);this._pluginOptionObservables[e]||(this._pluginOptionObservables[e]={}),this._pluginOptionObservables[e][t]?this._pluginOptionObservables[e][t].set(n||i&&[]):this._pluginOptionObservables[e][t]=i?new u.a(n):new d.a(n)},onFailedAuthenticate:function(e){a.default.toasts.pushMessage({text:"We failed to successfully authenticate you for "+e+", please try again.",actionText:"OKAY"})},_wasPluginAuthorized:function(e,t){var i;e===PluginID.Contacts?t.indexOf(GScope.Contacts)>=0&&(i=!0):i=a.default.vmMain.pluginManager.getPlugin(e).verifyAuthorization(a.default.vmMain.getUserEmail());return a.default.Assert(i,"Should always be successful at authorizing plugins"),i},setEnabledPlugins:function(e,t,i){for(var n=0,s=0;s<e.length;s++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var r=e[s],o=r.id,l=r.enable,d=this._pluginEnabledObservables[o].get(),u=a.default.vmMain.pluginManager.getPlugin(r.id);!l&&d&&this.disablePlugin(o),r.id===PluginID.GCalendar&&u.setSetting(PluginSettingsID.GCalendar.WriteAccess,!0),r.id!==PluginID.Drive||r.shared||u.setSetting(PluginSettingsID.Drive.WriteAccess,!1)}this.enableOfflineAuth.set(t),a.default.settings.set(Settings.enableOfflineAuth,t);var c=e.filter(function(e){return e.enable});this.enablePlugins(c,!1,i)},enablePlugins:function(e,t,i){var n=this,s=e.map(function(e){var t=e.id,i=a.default.vmMain.pluginManager.getPlugin(e.id);return i?t===PluginID.Drive?i.googleScopes(e.shared):i.googleScopes():t===PluginID.Contacts?[GScope.Contacts]:void 0}).reduce(function(e,t){return e.concat(t)},[]);if(t||s&&s.length>0){o.default.runAuthenticateOffline(s,!1,function(t){t&&!t.error?(n.refresh(),e.map(function(e){if(e.id===PluginID.Contacts)n.enableSyncContacts();else{var i=a.default.vmMain.pluginManager.getPlugin(e.id);a.default.vmMain.pluginManager.onPluginAuthorized(i,!0),e.id===PluginID.Drive&&e.shared&&i.setSetting(PluginSettingsID.Drive.WriteAccess,!0)}a.default.Assert(n._wasPluginAuthorized(e.id,t.scope),"Plugin "+e.id+" was not authorized properly.")}),n.refresh(),i(!0)):i(!1)})}else this.enableOfflineAuth.set(!0),a.default.settings.set(Settings.enableOfflineAuth,!0),i(!0)},_enablePlugin:function(e){var t=this._pluginEnabledObservables[e];a.default.vmMain.pluginManager.authorizePlugin(e,this.enableOfflineAuth.get(),function(i){i?(t.set(!0),this.refresh(e),a.default.sendEvent(e,"PluginEnabled")):(this.onFailedAuthenticate(e),a.default.sendEvent(e,"PluginEnableFailed"))}.bind(this))},enablePlugin:function(e){e===PluginID.Contacts?this.enableSyncContacts():this._enablePlugin(e)},disablePlugin:function(e){var t=this._pluginEnabledObservables[e];e===PluginID.Contacts?(a.default.sendEvent("Settings","DisableContacts"),o.default.loadedContacts=!1,a.default.settings.set(Settings.syncContacts,!1),n.default.clearContacts(),t.set(!1)):a.default.vmMain.pluginManager.deauthorizePlugin(e,function(){t.set(!1),a.default.sendEvent(e,"PluginDisabled")})},togglePlugin:function(e){!this._pluginEnabledObservables[e].get()?this.enablePlugin(e):this.disablePlugin(e)},togglePluginOption:function(e,t){var i=this._pluginOptionObservables[e][t],n=!i.get();a.default.vmMain.pluginManager.setSetting(e,t,n),n?a.default.vmMain.pluginManager.authorizePlugin(e,this.enableOfflineAuth.get(),function(s){s?(a.default.vmMain.pluginManager.onAuthorizedSetting(e,t,n),i.set(!0),a.default.sendEvent(e,"OptionEnabled_"+t)):(this.onFailedAuthenticate(t),a.default.vmMain.pluginManager.setSetting(e,t,!n),a.default.sendEvent(e,"OptionEnableFailed_"+t))}.bind(this)):(i.set(!1),a.default.sendEvent(e,"OptionDisabled_"+t))},setPluginOption:function(e,t,i,n,s){var r=this._pluginOptionObservables[e][t],o=r.get();a.default.vmMain.pluginManager.setSetting(e,t,i),i&&n?a.default.vmMain.pluginManager.authorizePlugin(e,this.enableOfflineAuth.get(),function(n){n?(a.default.vmMain.pluginManager.onAuthorizedSetting(e,t,i),r.set(i),a.default.sendEvent(e,"OptionSet_"+t+"_"+i),s&&s(!0)):(this.onFailedAuthenticate(t),a.default.vmMain.pluginManager.setSetting(e,t,o),a.default.sendEvent(e,"OptionEnableFailed_"+t+"_"+i),s&&s(!1))}.bind(this)):(r.set(i),a.default.sendEvent(e,"OptionSet_"+t+"_"+i),s&&s(!0))},enableOfflineFeatures:function(e,t){var i=this,n=this.getEnabledPlugins().map(function(e){return e===PluginID.Drive?{id:e,shared:i.getPluginOptionObservable(e,PluginSettingsID.Drive.WriteAccess).get()}:{id:e}});this.enablePlugins(n,e,function(e){e?(a.default.settings.set(Settings.enableOfflineAuth,!0),a.default.sendEvent("OfflineAccess",!0)):(a.default.toasts.pushMessage({text:"We failed to successfully authenticate you for offline access.",actionText:"OKAY"}),a.default.sendEvent("OfflineAccessFailed",!0)),t&&t(e)})},isNotificationsEnabled:function(){return!a.default.settings.get(Settings.disableNotifications)},toggleNotifications:function(){var e=a.default.settings.get(Settings.disableNotifications);a.default.settings.set(Settings.disableNotifications,!e),e?a.default.timeline.updateNotifications():a.default.timeline.clearNotifications()},enableSyncContacts:function(e){a.default.sendEvent("Settings","EnableContacts");var t=function(t){t&&!t.error?(a.default.settings.set(Settings.syncContacts,!0),this.updatePluginStatus(PluginID.Contacts,!0),o.default.loadContacts(function(t){t<0?(a.default.toasts.pushMessage({text:"There was an error syncing your contacts. Please try again.",actionText:"SYNC",action:function(){this.enableSyncContacts(e)}.bind(this)}),e&&e(!1)):(t>0&&a.default.vmMain.parseSubtree(a.default.vmMain.root(),ChangeType.Auto),e&&e(!0))}.bind(this)),l.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SyncContacts})):(a.default.settings.set(Settings.syncContacts,!1),this.updatePluginStatus(PluginID.Contacts,!1),a.default.toasts.pushMessage({text:"To sync your contacts we need permission to access them. Please try again.",actionText:"SYNC",action:function(){this.enableSyncContacts(e)}.bind(this)}),e&&e(!1))}.bind(this);this.enableOfflineAuth.get()?o.default.runAuthenticateOffline([GScope.Contacts],!1,t):o.default.runAuthenticate([GScope.Contacts],!1,!1,t)},onTapRefreshContacts:function(e,t){var i=!1;return this.isRefreshingContacts.get()||(this.isRefreshingContacts.set(!0),i=o.default.refreshContacts(function(e){this.isRefreshingContacts.set(!1),t&&t()}.bind(this)),a.default.sendEvent("Menu","RefreshContacts")),i},onAllDayTimeValid:function(e){this.isAllDayTimeValid(e),e&&this.datesAllDayTime(a.default.element("settings-allday").value)},addCalendar:function(e){var t=a.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar);this.GCalendarListLoading.set(!0),t.createCalendar(e,function(e){this.GCalendarListLoading.set(!1),e?this.updateCalendarList():this.GCalendarAddFailure.set(!0)}.bind(this))},notifySyncError:function(e){this.GCalendarSyncErrors.set(e||[])}},t.a=new c},function(e,t,i){"use strict";var a=i(0),n=/^<(.*)>$/,s=/^[^:]+(?=:)/;function r(){}var o={Default:{bannedTags:["style","script","source","track","iframe","frame","frameset","button","input","audio","video","math","svg","link","comment","base","object","embed"],allowedAttributes:["abbr","accept","acceptcharset","accesskey","align","alt","async","autocomplete","axis","background","border","bordercolor","bgcolor","cellpadding","cellspacing","char","charoff","charset","checked","cid","class","classid","classname","color","colspan","cols","content","contextmenu","controls","coords","data","datetime","defer","dir","disabled","download","draggable","enctype","form","formaction","formenctype","formmethod","formnovalidate","formtarget","frame","frameborder","headers","height","hidden","high","href","hreflang","htmlfor","httpequiv","icon","itemscope","itemtype","itemid","itemprop","itemref","label","lang","list","loop","low","manifest","marginheight","marginwidth","max","maxlength","media","mediagroup","method","min","multiple","muted","name","novalidate","nowrap","open","optimum","pattern","placeholder","poster","preload","radiogroup","readonly","rel","required","role","rowspan","rows","rules","sandbox","scope","scoped","scrolling","seamless","selected","shape","size","sizes","sortable","sorted","span","spellcheck","src","srcdoc","srcset","start","step","style","summary","tabindex","target","title","translate","type","usemap","valign","value","width","wmode"],allowedTagAttributes:{A:["href","name"],IMG:["src","alt"],FONT:["face"],HTML:["xmlns"],BODY:["text","link","alink","vlink"],META:["http-equiv"],VAR:["id"]}}};r.prototype={update:function(e,t,i,n){var s;return a.default.Assert(t,"Must supply a valid resource lib"),a.default.Assert(i,"Must supply a valid options obj"),"text/plain"===n?s=this._parsePlain(e,t,i):"text/html"===n?s=this._parseHTML(e,t,i):a.default.reportError("Unknown email mimeType: "+n),s?s.parsed=this._escapeHTMLEntities(s.parsed):s={parsed:void 0,missingResourceData:!0},s},_escapeHTMLEntities:function(e){return e.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,function(e){return"&#"+(1024*(e.charCodeAt(0)-55296)+(e.charCodeAt(1)-56320)+65536)+";"}).replace(/[\x01-\t\x0B\f\x0E-\x1F\x7F\x81\x8D\x8F\x90\x9D\xA0-\uFFFF]/g,function(e){return"&#x"+e.charCodeAt(0).toString(16).toUpperCase()+";"})},getAttachmentLinks:function(e,t){var i=[],n=this._createDoc(e);if(n){var s=this._findLinkElements(n),r=this._findQuoteElements(n);try{i=this._findSpecialLinks(s,r,t).attachments}catch(e){a.default.reportError(e)}}return i},generatePlaintext:function(e,t){return this._createDoc(e).body.innerText},replaceSignature:function(e,t){var i,n=this._createDoc(e),s=this._findActiveSignature(n);if(s){var r=!!s.innerHTML;if(s.innerHTML=t||"",t)r||(s.parentNode.insertBefore(document.createElement("br"),s),s.parentNode.insertBefore(document.createElement("br"),s),s.parentNode.insertBefore(document.createTextNode("--"),s),s.parentNode.insertBefore(document.createElement("br"),s));else{var o=s.previousSibling;if(o&&"BR"===o.tagName){var l=o.previousSibling;if(l&&a.default.isTextNode(l)&&"--"===l.textContent){var d=l.previousSibling;if(d){var u=d.previousSibling;"BR"===d.tagName&&(d.parentElement.removeChild(d),u&&"BR"===u.tagName&&u.parentElement.removeChild(u))}o.parentElement.removeChild(o),l.parentElement.removeChild(l)}}}i=n.body.outerHTML}else i=e;return i},_ensurePartDoc:function(e){var t;switch(e.mimeType){case"text/plain":t=this._createDoc(this._parsePlain(e.decoded).parsed);break;case"text/html":t=this._createDoc(e.decoded);break;default:a.default.Assert(!1,"Unknown display part mimeType: "+e.mimeType)}return t},_mergeDocs:function(e,t){if(e.body){var i=t.adoptNode(e.body),n=t.createElement("div");try{for(var s=0,r=0;r<i.attributes.length;++r){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var o=i.attributes[r];n.setAttribute(o.name,o.value)}}catch(e){a.default.reportError(e)}try{for(var l=0;i.childNodes.length>0;){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;n.appendChild(i.firstChild)}}catch(e){a.default.reportError(e)}try{t.body.appendChild(n)}catch(e){a.default.reportError(e)}}},combineParts:function(e){a.default.Assert(a.default.isArray(e)&&e.length>0,"Must always supply a valid part list with contents");var t=this._createDoc("<body></body>");if(a.default.Assert(t,"Must always be able to create a valid document for first part in list"),t)for(var i=0,n=0;n<e.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this._ensurePartDoc(e[n]);if(s)try{this._mergeDocs(s,t)}catch(e){a.default.reportError(e)}}return t?t.body.outerHTML:" "},removeElementById:function(e,t){a.default.Assert(a.default.isString(e),"Must pass in a valid decoded HTML email string"),a.default.Assert(a.default.isString(t),"Must provide a valid item ID");var i=!1;try{var n=this._createDoc(e);n&&(i=this._removeElementById(n,t))}catch(e){a.default.reportError(e)}return i?n.body.outerHTML:e},_removeElementById:function(e,t){var i=!1,a=e.getElementById(t);return a&&(a.parentNode.removeChild(a),i=!0),i},removeElementsByAttribute:function(e,t,i){a.default.Assert(a.default.isString(e),"Must pass in a valid decoded HTML email string"),a.default.Assert(a.default.isString(t),"Must provide a valid item ID");var n=!1;try{var s=this._createDoc(e);s&&(n=this._removeElementsByAttribute(s,t,i))}catch(e){a.default.reportError(e)}return n?s.body.outerHTML:e},_removeElementsByAttribute:function(e,t,i){var a,n=0,s=!1;a=void 0!==i&&null!==i?e.querySelectorAll("["+t+'="'+i+'"]'):e.querySelectorAll("["+t+"]");for(var r=0;r<a.length;++r){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var o=a[r];o.parentNode.removeChild(o),s=!0}return s},_createFragment:function(){return{lines:[],isQuote:!1}},_createPlainFragments:function(e){var t=0,i=[],a=e.split("\n"),n=this._createFragment();i.push(n);for(var s=0;s<a.length;++s){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var r=a[s].trim(),o=new RegExp(/^>+/).test(r);n.lines.length>0&&o!==n.isQuote&&""!==r&&(n=this._createFragment(),i.push(n)),n.lines.push(r),n.isQuote=n.isQuote||o}return i},_getFragmentText:function(e){var t,i,a=0,n="";if(e.isQuote){var s=this._generatePlaceholderID();t='<div id="'+s+'" place="true"></div><p quote="collapsed" group="'+s+'">',i="</p>"}else t="",i="";for(var r=0;r<e.lines.length;++r){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;n+=e.lines[r]+"\n"}return t+n+i},_joinPlainFragments:function(e){for(var t=0,i="",a=0;a<e.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[a];i+=this._getFragmentText(n)}return i},_parsePlain:function(e,t,i){var n,s=this._escapeHTMLEntities(e),r=this._createPlainFragments(s);try{n=this._joinPlainFragments(r);n=n.replace(/\b((?:(https?):\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/gm,'<a mlink="true" href="$1">$1</a>')}catch(e){a.default.reportError(e),n="There was an error loading this message."}return{parsed:'<html><head></head><body style="white-space: pre-wrap;">'+n+"</body><html>"}},_parseHTML:function(e,t,i){var n={parsed:void 0},s=this._createDoc(e),r=this._findQuoteElements(s);if(r=this._cleanupDocQuotes(s,r,t),this._isFullQuote(s,r)||this._collapseAndMarkQuotes(s,r,!!i.collapseQuotes),i.createLinksFromText)try{this._createLinksFromText(s)}catch(e){a.default.reportError(e)}var o=this._findLinkElements(s);this._markLinks(o);try{n.specialLinks=this._findSpecialLinks(o,r,i)}catch(e){a.default.reportError(e)}try{n.parsedMetadata=this._parseMetadata(s)}catch(e){a.default.reportError(e)}try{var l=this._updateResourceImages(s,t);n.missingResourceData=l.missingResourceData}catch(e){a.default.reportError(e)}return this._trimTrailingWhitespace(s),this._trimQuoteWhitespace(r),n.parsed=s.body.outerHTML,n},_traverseNode:function(e,t){if(!1!==t(e))for(var i=0,a=e.childNodes.length-1;a>=0;a--){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;this._traverseNode(e.childNodes[a],t)}},_sanitizeInputDoc:function(e,t){var i=o[t];e.body&&this._traverseNode(e.body,function(e){if(e.nodeType===Node.COMMENT_NODE)a.default.Assert(0===e.childNodes.length,"A comment node should never have children"),e.parentNode.removeChild(e);else if(e.nodeType===Node.TEXT_NODE);else if(i.bannedTags.indexOf(e.tagName.toLowerCase())>=0)e.parentNode.removeChild(e);else if(e.attributes.length>0){for(var t=0,n=i.allowedTagAttributes[e.tagName],s=e.attributes.length-1;s>=0;s--){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var r=e.attributes[s].name;if(i.allowedAttributes.indexOf(r)<0&&(!n||n.indexOf(r)<0))e.removeAttribute(r);else{var o=e.getAttribute(r);o&&o.startsWith("javascript:")&&(console.log("Remove Inline JS: ",e.tagName,r),e.removeAttribute(r))}}var l=e.getAttribute("height");l&&l.indexOf("%")>=0&&(e.removeAttribute("height"),console.log("Remove Height: ",e.tagName,l))}})},sanitizeContent:function(e){var t;if(e){var i=this._createDoc(e);try{this._traverseNode(i.body,function(e){e.nodeType===Node.TEXT_NODE?e.textContent=new Array(e.textContent.length+1).join("#"):"A"===e.nodeName&&e.removeAttribute("href")}),t=i.body.outerHTML}catch(e){a.default.reportError(e),t="<<SANITIZED>>"}}else t="<<NO HTML CONTENT>>";return t},sanitizePlaintext:function(e){return e?a.default.isWhiteSpace(e)?"":"<<NonHTML-Sanitized: "+e.length+">>":"<<NO CONTENT>>"},getComposeBody:function(e,t){var i=!1;try{var n=this._createDoc(e);if(n){i=this._removeElementsByAttribute(n,"moodoAttach","true");var s=this._updateResourceImages(n,t);i=i||s.didUpdate}}catch(e){a.default.reportError(e)}return i?n.body.outerHTML:e},_createDoc:function(e){var t,i=new DOMParser;try{if(t=i.parseFromString(e,"text/html")){var n=this._parseJSONLD(t);this._sanitizeInputDoc(t,"Default"),n&&n.length>0&&this._reportMetadata(t,n)}}catch(e){a.default.reportError(e);try{t=i.parseFromString("Error parsing email message","text/html")}catch(e){a.default.reportError(e)}}return t},_updateResourceImages:function(e,t){for(var i=0,a={missingData:!1,didUpdate:!1},n=this._findImageElements(e),s=0;s<n.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=n[s];if(r.src.startsWith("cid:")){var o=r.src.substr(4);if(o){r.setAttribute("cid",o);var l=t.getByCID(o);if(l&&l.data){var d="data:"+l.mimeType+";base64,"+l.data;r.src=d,a.didUpdate=!0}else r.src="data:image/gif;base64,R0lGODlhAQABAAAAACwAAAAAAQABAAA=",a.didUpdate=!0,l||(a.missingData=!0)}else r.src="data:image/gif;base64,R0lGODlhAQABAAAAACwAAAAAAQABAAA=",a.didUpdate=!0}}return a},_findImageElements:function(e){return e.querySelectorAll("img")},_findLinkElements:function(e){return Array.prototype.slice.call(e.querySelectorAll("a"))},_sanitizeLink:function(e){if(e&&e.hasAttribute("href")){e.setAttribute("mlink",!0);var t=e.getAttribute("href");if(t.startsWith("file:"))e.setAttribute("href","");else s.exec(t)||e.setAttribute("href","https://"+t)}},_createLinksFromText:function(e){this._traverseNode(e.body,function(t){var i=!0;if(t.nodeType===Node.TEXT_NODE){var a=t.textContent;if(a.indexOf("http")>=0||a.indexOf("www.")>=0){var n=/\b((?:(https?):\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/gm,s=t.textContent.replace(n,'<a href="$1">$1</a>'),r=e.createElement("div");r.innerHTML=s;var o=r.childNodes.length;if(o>1||1===o&&"A"===r.childNodes[0].tagName){for(var l=0;r.firstChild;){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;t.parentNode.insertBefore(r.firstChild,t)}t.parentNode.removeChild(t)}}}else"A"===t.tagName&&(i=!1);return i})},_markLinks:function(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this._sanitizeLink(e[i])}},_isAttachmentURL:function(e){return!!/^https:\/\/drive.google.com\/file\/d\/.*\/view/g.exec(e)},_findSpecialLinks:function(e,t,i){for(var a=0,n={unsubscribe:[],twitter:[],attachments:[]},s=0;s<e.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var r=e[s];r.href&&this._isAttachmentURL(r.href)&&(i.ignoreQuotedAttachments&&this._isInsideQuote(r,t)||n.attachments.push({href:r.href,cid:r.id,name:r.innerText,type:"application/octet-stream"}))}return n},_parseMetadata:function(e){var t=this._parseMicrodata(e);return t&&t.length>0&&this._reportMetadata(e,t),t},_reportMetadata:function(e,t){a.default.reportError("Metadata Schemas Found: ",t)},_parseJSONLD:function(e){for(var t=0,i=[],n=e.getElementsByTagName("script"),s=0;s<n.length;++s){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var r=n[s];if("application/ld+json"===r.getAttribute("type")){var o=r.innerText.trim();if(o)try{var l=JSON.parse(o);i.push(l)}catch(e){a.default.reportError(new Error("Invalid JSONLD Schema String"),o)}}}return i},_parseMicrodata:function(e){var t=e.querySelectorAll("[itemscope]");return Array.prototype.map.call(t,function(e){if(!e.hasAttribute("itemprop"))return this._parseMicrodataScope(e)}.bind(this)).filter(function(e){return!!e})},_parseMicrodataScope:function(e){var t={type:e.getAttribute("itemtype"),properties:{}};return this._recurseMicrodataScope(t,e),t},_recurseMicrodataScope:function(e,t){for(var i=0,a=0;a<t.children.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=t.children[a];if(n.hasAttribute("itemprop")){var s,r=n.getAttribute("itemprop");if(n.hasAttribute("itemscope"))s=this._parseMicrodataScope(n);else switch(n.tagName.toLowerCase()){case"a":case"area":case"link":s=n.getAttribute("href");break;case"meta":s=n.getAttribute("content");break;case"img":s=n.getAttribute("src");break;case"data":case"meter":s=n.getAttribute("value");break;case"time":s=n.getAttribute("datetime");break;default:s=n.hasAttribute("content")?n.getAttribute("content"):n.textContent}r&&s&&(e.properties[r]=s)}else this._recurseMicrodataScope(e,n)}},_cleanupDocQuotes:function(e,t,i){return t.filter(function(e){var t=!1;"BLOCKQUOTE"===e.nodeName&&"cite"===e.getAttribute("type")&&(function(e){var t;n.lastIndex=0;var i=n.exec(e);return i&&i[1]&&(t=i[1]),t}(e.innerText)&&e&&e.parentNode&&(e.parentNode.removeChild(e),t=!0));return!t})},_generatePlaceholderID:function(){return a.default.generateTempId()},_createQuotePlaceholder:function(e){var t=e.createElement("div");return t.id=this._generatePlaceholderID(),t.setAttribute("place",!0),t},_findFirstSiblingQuote:function(e,t){for(var i=0,a=e;a.previousElementSibling&&t.indexOf(a.previousElementSibling)>=0;){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;a=a.previousElementSibling}return a},_markAdjacentQuotes:function(e,t,i,a){for(var n=0;e&&i.indexOf(e)>=0;){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;e.setAttribute("quote",a),e.setAttribute("group",t),e=e.nextElementSibling}},_collapseAndMarkQuotes:function(e,t,i){for(var a=0,n=0;n<t.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=t[n];if(!s.getAttribute("quote")){var r=this._findFirstSiblingQuote(s,t),o=this._createQuotePlaceholder(e),l=0===n&&i?"collapsed":"uncollapsed";this._markAdjacentQuotes(r,o.id,t,l),r.parentNode.insertBefore(o,s)}}},_removeQuote:function(e){e&&e.parentNode&&e.parentNode.removeChild(e)},_removeQuotes:function(e,t){for(var i=0,a=0;a<t.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;this._removeQuote(t[a])}},_isFullQuote:function(e,t){for(var i=0,a=!0,n=0;n<e.body.childNodes.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=e.body.childNodes[n];if(""!==s.textContent.trim()&&t.indexOf(s)<0&&t.indexOf(s.firstElementChild)<0){a=!1;break}}return a},_findQuoteElements:function(e){var t=this._findGmailQuotes(e),i=this._findOffice365Quotes(e),a=this._findBlockquoteQuotes(e),n=[];return n.pushOnlyUniques(t),n.pushOnlyUniques(i),n.pushOnlyUniques(a),n=this._cleanupGmail(n),n=this._removeEmptyQuotes(n)},_cleanupGmail:function(e){return e.filter(function(t){var i=!1;if("BLOCKQUOTE"===t.nodeName&&a.default.hasClass(t,"gmail_quote"))for(var n=0,s=0;s<e.length;++s){var r=0;if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;for(var o=t.parentNode;o;){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;if(a.default.hasClass(o,"gmail_quote")){"DIV"===o.nodeName&&(i=!0);break}o=o.parentNode}}return!i})},_removeEmptyQuotes:function(e){return e},_findGmailQuotes:function(e){return Array.prototype.slice.call(e.querySelectorAll(".gmail_quote"))},_findOffice365Quotes:function(e){var t=Array.prototype.slice.call(e.querySelectorAll("#divRplyFwdMsg, #OLK_SRC_BODY_SECTION")),i=e.getElementById('3D"divRplyFwdMsg"');return i&&t.push(i),t=t.map(function(e){return e.previousElementSibling&&"HR"===e.previousElementSibling.nodeName?e.parentElement:e})},_findBlockquoteQuotes:function(e){return Array.prototype.slice.call(e.querySelectorAll("blockquote"))},_findGmailSignatures:function(e){return Array.prototype.slice.call(e.querySelectorAll(".gmail_signature"))},_findActiveSignature:function(e){for(var t,i=0,n=this._findGmailSignatures(e),s=this._findQuoteElements(e),r=n.length-1;r>=0&&!t;r--){var o=0;if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;for(var l=n[r],d=!0,u=0;u<s.length;++u){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;if(a.default.isAncestor(l,s[u])){d=!1;break}}d&&(t=l)}return t},_trimTrailingWhitespace:function(e){for(var t=0,i=e.body.childNodes,a=[],n=i.length-1;n>=0;n--){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=i[n],r=i[n-1];if(!s||"BR"!==s.nodeName||!r||"BR"!==r.nodeName)break;a.push(s)}this._removeElements(a)},_trimQuoteWhitespace:function(e){for(var t=0,i=[],a=0;a<e.length;++a){var n=0;if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;for(var s=e[a].previousElementSibling;s;){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;"BR"===s.nodeName&&s.previousElementSibling&&"BR"===s.previousElementSibling.nodeName&&i.push(s),s=s.previousElementSibling}}this._removeElements(i)},_removeElements:function(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=e[i];try{a.parentNode&&a.parentNode.removeChild(a)}catch(e){}}},_isInsideQuote:function(e,t){for(var i=0;e.parentNode;){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(t.indexOf(e.parentNode)>=0)return!0;e=e.parentNode}return!1}},t.a=new r},function(e,t,i){"use strict";var a=i(0),n={_ensureListeners:function(){return this._listeners||(this._listeners={}),this._listeners},clearListeners:function(){this._listeners=void 0},listen:function(){for(var e=0,t=this._ensureListeners(),i=0;i<arguments.length-1;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;a.default.Assert("callbacks"!==arguments[i],"Invalid event name/grouping"),a.default.Assert(a.default.isString(arguments[i])||a.default.isFunction(arguments[i]),"Only accept string or functions for listen"),t[arguments[i]]||(t[arguments[i]]={callbacks:[]}),t=t[arguments[i]]}var n=arguments[arguments.length-1];a.default.Assert(a.default.isFunction(n),"Listeners must always be valid functions"),a.default.Assert(t.callbacks.indexOf(n)<0,"Should never listen with the same function twice"),t.callbacks.push(n)},isListening:function(){var e=0,t=this._ensureListeners(),i=arguments[arguments.length-1];a.default.Assert(a.default.isFunction(i),"Listeners must always be valid functions");for(var n=0;n<arguments.length-1;++n){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;t[arguments[n]]&&(t=t[arguments[n]])}return t&&t.callbacks&&t.callbacks.indexOf(i)>=0},unlisten:function(){var e=0,t=this._ensureListeners(),i=arguments[arguments.length-1];a.default.Assert(a.default.isFunction(i),"Listeners must always be valid functions");for(var n=0;n<arguments.length-1;++n){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;a.default.Assert("callbacks"!==arguments[n],"Invalid event name/grouping"),a.default.Assert(a.default.isString(arguments[n]),"Only accept string for unlisten"),a.default.Assert(t[arguments[n]],"Cannot unlisten something that has never been listened"),t[arguments[n]]&&(t=t[arguments[n]])}a.default.Assert(t&&t.callbacks&&t.callbacks.indexOf(i)>=0,"Cannot unlisten something that has never been listened"),t.callbacks&&t.callbacks.remove(i)},fireEvent:function(){var e=0,t=!0,i=this._ensureListeners(),n=arguments[arguments.length-1];a.default.Assert(void 0===n||a.default.isArray(n),"Last argument to fireEvent must be an array");for(var s=0;s<arguments.length-1;++s){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;if(a.default.Assert("callbacks"!==arguments[s],"Invalid event name/grouping"),a.default.Assert(a.default.isString(arguments[s])||a.default.isArray(arguments[s]),"Only accept strings for firing event"),!i[arguments[s]])break;var r=0;i=i[arguments[s]];for(var o=0;o<i.callbacks.length;++o){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;try{t=i.callbacks[o].apply(this,n)&&t}catch(e){a.default.reportError(e)}}}return t}};t.a=n},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(5),r=i(37);function o(e){this.type=PaneMode.Archived,this.title="Archived",this.paneClass="paneArchived",this.contextMenuMode=n.a.ContextMenuMode.Archived,this.isWriteable=!0,this.isEditable=!1,this.isDraggable=!1,this.isDropTarget=!1,this.canAddItem=!1,this.supportCollapsing=!0,this.supportCompleting=!1,this.supportCheckbox=!1,this.supportArchiving=!0,this.supportPerformArchive=!1,this.supportIndent=!1,this.supportClone=!1,this.hasMoreButtons=!1,this.searchFilters=["project","task","starred","priority","showOnlyMatches"],this._super.constructor.call(this,e),this._blocks=[],this._blocksById={},s.a.forceBind("isItemMatched",this),s.a.forceBind("itemEach",this),this.initArchived()}var l={initArchived:function(){this.showArchived.set(!0)},isItemMatched:function(e){return(e.isArchived()||e.isNote()&&e.parent().isArchived()||e.hasArchivedDescendant()||e.hasArchivedAncestor())&&this.search.isMatched(e)},itemEach:function(e){var t=e.getCollapsedField(this,!1);void 0!==this.getPerPaneState(e.id,t)||e.isNote()||(e.isArchived()&&!e.hasArchivedDescendant()||!e.isArchived()&&e.hasArchivedAncestor()&&!e.hasArchivedDescendant())&&e.setCollapsed(!0,this,!1,!1)},getItemSearchParams:function(){return{item:this.getItem(),comparator:this.isItemMatched,each:this.itemEach,includeArchived:!0,includeNotes:!0,noCollapsed:!0,pane:this}},getHeaderSearchParams:function(){return{item:this.getItem(),comparator:this.isItemMatched,includeArchived:!0,noCollapsed:!0,collapseAfterDepth:1,headers:!0,overview:!0,pane:this}},getStatusMessage:function(){return"No archived items"},handleRightSideTap:function(e){this.runUnarchive(e)}};s.a.inherit(r.a,o),s.a.extend(o.prototype,l);var d=o,u=i(6),c=i(14),h=n.a.TaskSortMode;function f(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);this.id=e.id,this.text=e.name,this.search=this.pane.search,this.items=[],this.numInstancesOfItem={},s.a.binder(this,"toggleCollapsed","heightOfHeader","compareItemsAgenda","compareItemsCreated","compareItemsCompleted"),a.default.Assert(this.id,"Added an agenda block without an id")}f.prototype={shouldShowTime:function(){return!this.isOverdue&&this.isDate},heightOfHeader:function(){return 32},heightOfSpaceBetween:function(){return 16},heightOfAddButton:function(){return this.heightOfHeader()+this.heightOfSpaceBetween()},numItems:function(){return this.items.length},getLastItem:function(){var e=this.items[this.items.length-1];return e&&e.isNote()&&(e=e.parent()),e},comparePriority:function(e,t){var i=e.priority(),a=t.priority();return i>a?-1:i<a?1:0},compareDate:function(e,t){a.default.Assert(this.date,"This block does not have a date",this.text);var i=this.pane,n=e.getDate(i)||e.repeatDate(i)&&e.repeatDate(i).getDateOnDay(this.date),s=t.getDate(i)||t.repeatDate(i)&&t.repeatDate(i).getDateOnDay(this.date);if(e.isComplete()&&!t.isComplete())return-1;if(!e.isComplete()&&t.isComplete())return 1;if(e.isComplete()&&t.isComplete())return e.dateCompleted>t.dateCompleted?1:-1;if(n&&!s)return-1;if(!n&&s)return 1;if(!n&&!s)return 0;e.getDuration(i)>0&&(n=e.getDisplayDateWithDuration(this.date)),t.getDuration(i)>0&&(s=t.getDisplayDateWithDuration(this.date));var r=n.clone().clearTime(),o=s.clone().clearTime();if(!r.equals(o))return r<o?-1:1;if(n.hasTimeOfDay()&&s.hasTimeOfDay()){var l=n.getTimeOfDay(),d=s.getTimeOfDay();return l===d?0:l<d?-1:1}return n.hasTimeOfDay()?1:s.hasTimeOfDay()?-1:0},compareOrder:function(e,t){return e.index-t.index},compareItemsAgenda:function(e,t){var i=e.item,n=t.item;a.default.DAssert(i,"Must have a valid left item to compare"),a.default.DAssert(n,"Must have a valid right item to compare"),a.default.DAssert(!i||i.parent(),"Must have a valid left parent item"),a.default.DAssert(!n||n.parent(),"Must have a valid right parent item"),i.isNote()&&(i=i.parent()),n.isNote()&&(n=n.parent());var s=this.isStarred||this.isImportant?0:this.compareDate(i,n);if(0===s){var r=this.isStarred?0:this.comparePriority(i,n);return 0===r?this.compareOrder(e,t):r}return s},compareItemsCreated:function(e,t){return this.pane.compareDate(e.dateCreated,t.dateCreated)},compareItemsCompleted:function(e,t){return this.pane.compareDate(e.dateCompleted,t.dateCompleted)},addItem:function(e){a.default.Assert(e&&a.default.isVMLI(e),"Must be adding a valid item: "+a.default.getObjectInfo(e)),this.items.indexOf(e)<0&&this.items.push(e)},toggleCollapsed:function(){this.pane.setBlockCollapsed(this,!this.isCollapsed())},isCollapsed:function(){return this.pane.isBlockCollapsed(this)},getItemID:function(e){var t=this.numInstancesOfItem[e.id]||0;return this.numInstancesOfItem[e.id]=t+1,e.id+"_"+this.id+(t?"_"+t:"")},sort:function(){var e;if(this.pane.isViewAgenda()){var t=this.pane.getSortModeBlocks();t===h.Date?e=this.compareItemsAgenda:t===h.Created?e=this.compareItemsCreated:t===h.Completed&&(e=this.compareItemsCompleted)}else this.pane.isViewCalendarMonth()?e=this.compareItemsAgenda:this.sortMode&&this.sortMode!==h.None&&(e=this.pane.getItemComparator());if(e){var i=this.items.map(function(e,t){return{item:e,index:t}});i.sort(e),this.items=i.map(function(e){return e.item})}}};var p=f,g=i(8),m=i(19),v=i(13),_=i(3),y=i(7),S=i(51),w=n.a.TaskViewMode,I=n.a.TaskSortMode,b="__block_nokey",A={};function D(e){var t=a.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar).isActive()&&!a.default.isDemoMode();this.type=PaneMode.Task,this.paneClass="paneTask",this.isWriteable=!0,this.hasNonVMLIs=!0,this.supportCollapsing=!0,this.supportCompleting=!0,this.supportIndent=!1,this.supportOffline=!0,this.supportMenuIcon=!0,this.supportViewMenu=!0,this.supportMultiselect=!1,this.supportDataRefresh=t,this.supportClickOverviewScroll=!1,this.isDraggable=!0,this.overviewTracksScroll=!1,this.overviewCanTrackScroll=!0,this.combineOverdue=!0,this.searchFilters=["project","task","starred","complete","priority","showOnlyMatches","showOnlyAgendaDates","showOnlyMatchingTags","showChildProjects"],s.a.binder(this,"getDayWidth","updateAllDay","scrollToToday","openViewMenu","setViewMode","compareBlockDate","compareBlockName","compareBlockItemPriority","compareBlockItemCreated","compareItemDate","compareItemName","_itemSearchComparator","onScroll","checkFlatListMode","addFnProject","addFnTag","addFnDate","onGCalendarActiveChanged","onGmailActiveChanged","onCalendarCustomDaysChanged","switchToOutline","_onSelectionChanged"),this.dragHoveredBlock=new g.a;var i=e.viewState||{};if(i.viewMode=i.viewMode||w.Groups_Project,i.sortModeBlocks=i.sortModeBlocks||{mode:I.None},i.sortModeItems=i.sortModeItems||{mode:I.None},a.default.isString(i.sortModeBlocks)&&(i.sortModeBlocks={mode:i.sortModeBlocks}),a.default.isString(i.sortModeItems)&&(i.sortModeItems={mode:i.sortModeItems}),this.viewState=new g.a(i,this.onViewStateChanged.bind(this)),this._super.constructor.call(this,e),this._allPaneItems=[],this._isViewHelper={},this.topBoxHeight.set(0,!1),this.blocksCollapsed=e.blocksCollapsed,!this.blocksCollapsed){var r=this.blocksCollapsed={};r[b+"_"+w.Groups_Project]=!0,r[b+"_"+w.Groups_Tag]=!0,r[b+"_"+w.Groups_Contact]=!0,r[b+"_"+w.Groups_Priority]=!0}this.search.getFilterObs("showOnlyMatches").listen(this.checkFlatListMode),this.dropEffect=function(e){var t=n.a.DropEffect.Move;return this.isCalendarItem(e)&&(t=n.a.DropEffect.Copy),t},this.displayLocalItems=new g.a(void 0===e.displayLocalItems||e.displayLocalItems),this.displayCalendars=new g.a(e.displayCalendars||{}),this.numAllDay=new g.a(0),this.setupViewState(),this.initBlocks()}A[w.Groups_Project]={Default:I.None,Available:[I.None,I.Alphabetical,I.NumItems,I.Date,I.Priority,I.Created]},A[w.Groups_Tag]=A[w.Groups_Contact]={Default:I.Alphabetical,Available:[I.Alphabetical,I.NumItems]},A[w.Agenda_Today]=A[w.Agenda_Week]=A[w.Agenda_All]={Default:I.Date,Available:[I.Date,I.Created,I.Completed]};var T={initBlocks:function(){this.blocks=[],this.blockImportant=void 0,this.blockStarred=void 0,this.days={},this.datesByItem={},this.starredItems={},this.priorityItems={},this.blocksByKey={},this.preventUpdateItemsForItem=void 0,this.itemAnimationTimeout=void 0;var e=a.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar);e.isActive()&&this.useItemStore(e.getDefaultItemStore());var t=a.default.vmMain.pluginManager.getPlugin(PluginID.Gmail);t.isActive()&&this.useItemStore(t.getDefaultItemStore()),a.default.vmMain.pluginManager.listen("pluginActiveChanged",PluginID.GCalendar,this.onGCalendarActiveChanged),a.default.vmMain.pluginManager.listen("pluginActiveChanged",PluginID.Gmail,this.onGmailActiveChanged),v.a.listen("selectionChanged",this._onSelectionChanged),a.default.settings.listen("settingChanged",Settings.DefaultGroup,Settings.dayWeekStart,this.scrollToToday),a.default.settings.listen("settingChanged",Settings.DefaultGroup,Settings.calendarCustomDays,this.onCalendarCustomDaysChanged)},init:function(){this._super.init.call(this)},destroy:function(){v.a.unlisten("selectionChanged",this._onSelectionChanged),a.default.settings.unlisten("settingChanged",Settings.DefaultGroup,Settings.dayWeekStart,this.scrollToToday),a.default.settings.unlisten("settingChanged",Settings.DefaultGroup,Settings.calendarCustomDays,this.onCalendarCustomDaysChanged),this._onAfterLoadedRAF||this.removeScrollListener(this.onScroll),a.default.vmMain.pluginManager.unlisten("pluginActiveChanged",PluginID.GCalendar,this.onGCalendarActiveChanged),a.default.vmMain.pluginManager.unlisten("pluginActiveChanged",PluginID.Gmail,this.onGmailActiveChanged),this._super.destroy.call(this)},getPaneIcon:function(){return"icon-calendar"},keydown:function(e){_.a.isValid()&&_.a.getStartIndex()===_.a.getEndIndex()&&!y.a.undoRedoActive&&(this.preventUpdateItemsForItem=_.a.getStartObject(),this.search.stickMatch(_.a.getStartObject())),this._super.keydown.call(this,e)},handleLeftSideTap:function(e,t){this.clearPreventUpdate(),this._super.handleLeftSideTap.call(this,e,t)},setItemsWillBeDirty:function(){this.itemsWillBeDirty=!0},clearPreventUpdate:function(){var e=this.preventUpdateItemsForItem;if(e&&c.default.isDragging){var t=function(){v.a.unlisten("endDrag",t),this.clearPreventUpdate()}.bind(this);v.a.listen("endDrag",t)}else{var i=!1;e&&(i=i||this.search.unstickMatch(e),this.preventUpdateItemsForItem=void 0),i&&(this.itemsWillBeDirty=void 0,this.setItemsDirty(),a.default.vmMain.updateAllItems())}},_onSelectionChanged:function(e){_.a.getPane()===this&&this.preventUpdateItemsForItem&&!y.a.undoRedoActive?_.a.isValid()?_.a.getStartObject().id!==this.preventUpdateItemsForItem.id&&(a.default.vmMain.beginUpdateItems(),this.clearPreventUpdate(),setTimeout(this.updateItems,0),a.default.vmMain.commitUpdateItems()):(this.clearPreventUpdate(),this.updateItems()):this.clearPreventUpdate()},isCalendarItem:function(e){return e.belongsToItemStore(a.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar).getDefaultItemStore())},isEmailItem:function(e){return e.belongsToItemStore(a.default.vmMain.pluginManager.getPlugin(PluginID.Gmail).getDefaultItemStore())},_itemSearchComparator:function(e){if(this.paneObjectsByItem[e.id])return!0;var t=this.search.isMatched(e)||e.isNote()&&this.search.isMatched(e.parent()),i=!1,n=!1;if(this.isCalendarItem(e)){var s=e.getAttachmentByPlugin(PluginID.GCalendar);s&&("cancelled"===s.getField("status")?n=!0:s.forEachItem(void 0,function(e){e.belongsToItemStore(a.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar).getDefaultItemStore())||(i=!0)}))}else if(this.isEmailItem(e)){var r=e.getAttachmentByPlugin(PluginID.Gmail);if(r){var o=a.default.vmMain.pluginManager.getPlugin(PluginID.Gmail);if(o.isItemArchived(e))t=!1;else o.getAttachmentPriority(r)!==VMLIFlag.None&&(t=!0)}}return t&&!i&&!n},getItemSearchParams:function(){return{itemStoreFilter:this.search.itemStoreFilter,item:this.item.get(),comparator:this._itemSearchComparator,noCollapsed:this.isViewOutline(),includeArchived:this.showArchived.get(),includeNotes:!0,pane:this}},_setItems:function(e,t){this.updateBlockItems()},onTapViewArchived:function(){a.default.vmMain.beginUpdateItems(),this.showArchived.set(!this.showArchived.get()),a.default.vmMain.commitUpdateItems(),a.default.vmMain.paneManager.updatePaneStateForPane(this),a.default.sendEvent("Menu","ShowArchivedTimeline")},onLoad:function(){isNaN(this.initialOffset)&&this.isViewDates()&&(this.initialOffset=this.getScrollOffsetOfToday(),this._infiniteList.setInitialScrollOffset(this.initialOffset)),this._super.onLoad.call(this)},onAfterLoaded:function(){this.orientation.get()===n.a.Orientation.Horizontal&&(this.paneContent.scrollTop=this.getDayViewY()),this.setIgnoreRestoreScroll(),this._super.onAfterLoaded.call(this),this.addScrollListener(this.onScroll)},getScrollOffsetOfToday:function(){var e;this.getViewMode();if(this.isViewCalendarMonth())e=this.heightWeek()*(n.a.CalendarMonthViewNumWeeksPad+1);else if(this.isViewCalendarHoriz())e=this.getDayWidth()*n.a.CalendarDayViewNumDaysPad+1;else if(this.isViewAgenda())for(var t=0,i=this.items.get(),a=0;a<i.length;a++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=i[a];if((s.isOverdue||s.isToday)&&"blockHeader"===s.type){e=this.topOfIndex(a)-16;break}}return e},_getDateInMiddle:function(){var e=(new Date).clearTime(),t=this.getViewMode();return t===w.Calendar_Month?e=this.getMonthStart(e):t===w.Calendar_Week&&(e=this.getWeekStart(e)),e},scrollToTop:function(e){this.isViewDates()?this.scrollToToday(e):this._super.scrollToTop.call(this,e)},scrollToToday:function(e){var t=this.getScrollOffsetOfToday();e=isNaN(e)?ScrollDuration.Default:e,this.setIgnoreRestoreScroll(e+100),this.setScrollOffset(t,e),this.orientation.get()===n.a.Orientation.Horizontal&&(this.paneContent.scrollTop=this.getDayViewY(),this.scrollElement.scrollTop=0)},weekCount:function(e,t,i){var a=new Date(e,t,1),n=i?new Date(e,t,i):new Date(e,t+1,0),s=a.getDay()+n.getDate();return Math.ceil(s/7)},scrollJump:function(e,t){t=isNaN(t)?ScrollDuration.Default:t;var i,n,s=this.getViewMode(),r=this._infiniteList.getScrollOffset(),o=this._infiniteList.indexOfTop(),l=this._infiniteList.objectAtIndex(o),d=r-this.topOfIndex(o);if(s===w.Calendar_Month){var u=l.date;if(e<0){var c=u.clone().addMonths(-1);i=this.weekCount(u.getFullYear(),u.getMonth(),u.getDate())-1,n=this.weekCount(c.getFullYear(),c.getMonth()),r-=this.heightWeek()*(n+i)+d}else n=this.weekCount(u.getFullYear(),u.getMonth()),i=this.weekCount(u.getFullYear(),u.getMonth(),u.getDate())-1,r+=this.heightWeek()*(n-i)-d}else if(s===w.Calendar_Custom){var h=a.default.settings.get("calendarCustomDays");r+=this.getDayWidth()*h*e-d+1}else if(s===w.Calendar_Week){var f,p=l.date.getDay(),g=a.default.settings.get(Settings.dayWeekStart);f=e<0?p>g?-p+g:-7:7-p+g,r+=this.getDayWidth()*f-d+1}else s===w.Calendar_Day&&(e<0&&d>200?r-=d:r+=this.getDayWidth()*e-d+1);this.setIgnoreRestoreScroll(),this.setScrollOffset(r,t)},compareDate:function(e,t){return e||t?e?t?e.compareTo(t):-1:1:0},compareText:function(e,t){return e.localeCompare(t)},comparePriority:function(e,t){var i=e.getPriority(this),a=t.getPriority(this);return a>i?1:a<i?-1:0},compareBlockBase:function(e,t,i){a.default.Assert(e,"Comparator was invalid");var n,s=this.getSortOrderBlocks()||1;if(e&&(n=this.compareNoKey(t,i)*s||e(t,i)),0===n||void 0===n){var r=A[this.getViewMode()].Default,o=this._getBlockSortComparator(r);if(o!==e)return o(t,i)}return n*s},compareBlockPriority:function(e,t){return t.priority-e.priority},compareNoKey:function(e,t){return e.id===this.blockNoKey?1:t.id===this.blockNoKey?-1:void 0},compareNone:function(e,t){return e.originalIndex-t.originalIndex},compareBlockDate:function(e,t){return this.compareDate(e.date,t.date)},compareBlockName:function(e,t){return this.compareText(e.name,t.name)},compareBlockNumItems:function(e,t){return t.items.length-e.items.length},compareBlockItemPriority:function(e,t){return this.comparePriority(e.item,t.item)},compareBlockItemCreated:function(e,t){return this.compareDate(e.item.dateCreated,t.item.dateCreated)},_getBlockSortComparator:function(e){return e===I.Alphabetical&&this.compareBlockName||e===I.Date&&this.compareBlockDate||e===I.NumItems&&this.compareBlockNumItems||e===I.Priority&&this.compareBlockItemPriority||e===I.Created&&this.compareBlockItemCreated||e===I.None&&this.compareNone},getBlockComparator:function(){var e=this.getSortModeBlocks();return this.compareBlockBase.bind(this,this._getBlockSortComparator(e))},compareItemBase:function(e,t,i){a.default.Assert(e,"Comparator was invalid");var n,s=this.getSortOrderItems();return e&&(n=e(t,i)*s),0===n||void 0===n?this.compareItemNone(t,i):n},compareItemNone:function(e,t){return e.index-t.index},compareItemDate:function(e,t){return this.compareDate(e.item.getDate(this),t.item.getDate(this))},compareItemName:function(e,t){return this.compareText(e.item.getSearchText(this),t.item.getSearchText(this))},compareItemNumItems:function(e,t){return t.item.numItems()-e.item.numItems()},_getItemSortComparator:function(e){return e===I.Alphabetical&&this.compareItemName||e===I.Date&&this.compareItemDate||e===I.NumItems&&this.compareItemNumItems||e===I.Priority&&this.compareBlockItemPriority||e===I.Created&&this.compareBlockItemCreated||e===I.None&&this.compareItemNone},getItemComparator:function(){var e=this.getSortModeItems();return this.compareItemBase.bind(this,this._getItemSortComparator(e))},findIndexOfNextBlock:function(){for(var e=0,t=new Date,i=this.items.get(),a=0;a<i.length;++a){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var n=i[a];if("blockHeader"===n.type){var s=n.block;if(s.isOverdue||s.isNow||s.isToday||s.isStarred||s.isImportant||s.date>=t)return a}}return-1},_keyHelper:function(e,t){var i=e["get"+t](this);if(i){if(i=i.map(function(e){return{value:e,lower:e.toLowerCase()}}),this.search.showOnlyMatchingTags()){var n=this.search["get"+t]();n&&n.length>0&&(n=n.map(a.default.toLowerCase),i=i.filter(function(e){for(var t=0,i=0;i<n.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(e.lower===n[i])return!0}}))}return i}if(!e.hasVisibleChildren(this)){for(var s=0,r=!0,o=e.parent();void 0!==o&&o!==this.getItem();){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var l=o["get"+t](this);if(l)for(var d=0,u=0;u<l.length;u++){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;if(this.blocksByKey[l[u].toLowerCase()]){r=!1;break}}o=o.parent()}if(r)return[this.blockNoKey]}},_getKeysForItem:function(e){var t=this.getViewMode();if(this.isViewAgenda()||this.isViewCalendar()){var i=!0;if(this.isViewAgenda()&&e.hasAttachmentType(n.a.PluginType.Calendar)&&e.date()<Date.today()){var s=e.getAttachmentByType(n.a.PluginType.Calendar);s.getPlugin().shouldDisplayOverdueInAgenda()&&s.getPlugin().hasWritePermissionForAttach(s)||(i=!1)}if(i){var r=this._getDateForItem(e);if(this.isViewAgenda()&&this.getSortModeBlocks()===I.Date&&!this.search.showOnlyAgendaDates()){var o=[];if(!e.isComplete()){if(e.getStarred(this)){var l="starred";a.default.timeline.getDateForKey(l)&&o.push(l)}if(e.isImportant(this)){l="important";a.default.timeline.getDateForKey(l)&&o.push(l)}}var d=e.getTagsLower();if(d)for(var u=0,c=0;d&&c<d.length;c++){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;var h="#"+d[c];a.default.timeline.getDateForKey(h)&&o.push(h)}o.length>0&&(r=r?r.concat(o):o)}return r}}else if(t===w.Groups_Project){var f=e.parent();if(f===this.getItem()&&!e.isPrefixHeader(this))return[this.blockNoKey];if(f&&f.isPrefixHeader()&&f!==this.getItem()&&(this.search.showChildProjects()||f.parent()===this.getItem()))return[f.id]}else{if(t===w.Groups_Tag)return this._keyHelper(e,"Tags");if(t===w.Groups_Contact)return this._keyHelper(e,"Contacts");if(t===w.Groups_Priority){var p=e.getPriority(this);if(p)return[p];if(!e.hasVisibleChildren(this)){for(var g=0,m=(i=!0,e.parent());void 0!==m&&m!==this.getItem();){if(g++>5e3&&__infLoop&&__infLoop(g))throw new RangeError;if(m.getPriority(this)){i=!1;break}m=m.parent()}if(i)return[this.blockNoKey]}}}},isOkOnAgenda:function(e){return!!this._getKeysForItem(e)||this.search.showHierarchy()&&e.parent()&&this.isOkOnAgenda(e.parent())},_getDateForItem:function(e){var t,i,n=this.getSortModeBlocks();if(this.isViewCalendar()||n===I.Date){var s=e.getDate(this),r=e.repeatDate(this),o=e.getDateText(this);if(e.isComplete()&&this.isViewAgenda())e.dateCompleted>=Date.today()&&(t=e.dateCompleted);else if(a.default.isDateSoft(o))t=o.toLowerCase(),t=(i=this.getDateForSoftDate(t))?"#"+t:void 0;else if(r)t=r.getDates();else if(s)if(e.getDuration(this)>0){var l=0;t=[];for(var d=s.clone().clearTime(),u=e.getEndDate(this).clone().clearTime();d<=u;){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;d.equals(u)?t.push(e.getEndDate(this)):t.push(d.clone()),d.addDays(1)}}else t=s}else if(n===I.Created||n===I.Completed){var c=n===I.Created?e.dateCreated:e.dateCompleted;(!this.startDate||c>=this.startDate)&&(t=c)}if(t){if(a.default.isArray(t)){for(var h=0,f=0;f<t.length;f++){if(h++>5e3&&__infLoop&&__infLoop(h))throw new RangeError;this.isDateWithinRange(t[f])||(t.splice(f,1),f--)}return t}if(this.isDateWithinRange(i||t))return[t]}},isDateWithinRange:function(e){return e&&(!this.endDate||e<this.endDate)},_getKeyForDate:function(e){var t=Date.today();if(!(this.combineOverdue&&e<t)){var i=DFormat.MonthDayYearLong,a=m.a.getFormat(i);return e.toString(a)}return"overdue".toLowerCase()},updateBlockItems:function(){var e,t=this.getViewMode();this.isViewOutline()?this.updateOutline(this._allPaneItems,this.supportsSortItems()&&this.getItemComparator()):(this.updateBlocks(),t===w.Calendar_Month?this.updateCalendarMonth():this.isViewCalendarHoriz()?(this.updateCalendarWeek(),e=!0):this.updatePaneObjects()),e&&this.updateAllDay()},updateBlocks:function(){var e,t,i,a=0;for(this.blocks=[],this.blocksByKey={},this.isViewAgenda()&&this.getBlock(Date.today()),e=0;e<this._allPaneItems.length;e++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=!(t=this._allPaneItems[e]).isNote();if(s)if(t.hasAttachmentType(n.a.PluginType.Calendar)){var r=t.getAttachmentByType(n.a.PluginType.Calendar),o=r.hasField("calendarID"),l=o&&r.getField("calendarID");s=o&&!1!==this.displayCalendars.get()[l]}else s=this.displayLocalItems.get();s&&this.addToBlock(this._allPaneItems[e])}this.isViewAgenda()?i=this.compareBlockDate:this.isViewPriority()?i=this.compareBlockBase.bind(this,this.compareBlockPriority):this.supportsSortBlocks()&&(i=this.getBlockComparator()),i&&this.blocks.sort(i)},addItemToPaneObjects:function(e,t,i,a,n){a=a||0;var s=t.getItemID(i)+(n?"_"+n.id:""),r=this.getPaneObjectForItemWithId(i,s);if(r||(r=new S.a({type:"blockItem",item:i,id:s,block:t,parentObject:n,index:e.length,levelsDeep:a,sizeInPane:i.sizeInPane})),this.addPaneObject(e,r),i.hasNote()&&this.addItemToPaneObjects(e,t,i.getNote(),a,n),i.hasChildren()&&!i.isCollapsed(this)){var o=i.getVisibleChildren(this);if(o)for(var l=0,d=0;d<o.length;d++){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;this.addItemToPaneObjects(e,t,o[d],a+1,r)}}return r},updatePaneObjects:function(){var e,t,i,a,n=0,s=[];for(i=0;i<this.blocks.length;i++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var r=this.blocks[i],o=this.isBlockCollapsed(r)&&(i===this.blocks.length-1||!this.isBlockCollapsed(this.blocks[i+1]));if(r.sort(),r.item){var l=(t=r.item).id+"_"+r.id;(a=this.getPaneObjectForItemWithId(t,l))||(a=new S.a({type:"blockItem",item:t,id:l,block:r,index:s.length,levelsDeep:0,sizePad:o?r.heightOfSpaceBetween():r.isCollapsed()?0:4,sizeInPane:t.sizeInPane,isBlockHeader:!0})),this.addPaneObject(s,a),t.hasNote()&&!this.isBlockCollapsed(r)&&this.addItemToPaneObjects(s,r,t.getNote(),0,a)}else this.isViewProjectNoBlocks()||(a=new S.a({type:"blockHeader",block:r,id:r.id,index:s.length,isToday:r.isToday,isOverdue:r.isOverdue,isFirstCollapsed:e&&r.isCollapsed()&&!e.isCollapsed(),sizePad:o?r.heightOfSpaceBetween():this.isViewProject()||this.isViewAgenda()&&r.isDate?4:0,sizeInPane:r.heightOfHeader}),this.addPaneObject(s,a));if(1===this.blocks.length&&this.isViewProject()||!this.isBlockCollapsed(r)){for(var d=0,u=!1,c=0;c<r.items.length;c++){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;t=r.items[c],a=this.addItemToPaneObjects(s,r,t),!u&&this.isViewAgenda()&&this.shouldShowTime(a)&&!t.time()&&(a.showAllDay=!0,u=!0)}a=new S.a({type:"blockAddItem",id:r.id+"_add",block:r,index:s.length,sizeInPane:r.noAddButton?r.heightOfSpaceBetween():r.heightOfAddButton(),addFn:r.addItem}),this.addPaneObject(s,a)}e=r}this.isViewProject()&&!this.isViewProjectNoBlocks()&&((r=this.getBlock("newProject")).isNewProject=!0,a=new S.a({type:"blockHeader",block:r,id:r.id,index:s.length,sizeInPane:r.heightOfHeader}),this.addPaneObject(s,a)),this.items.set(s)},addToBlock:function(e){this.isViewProject()&&e.isPrefixHeader(this)&&(this.search.showChildProjects()||e.parent()===this.getItem())&&this.getBlock(e.id,e);var t=this._getKeysForItem(e);if(t)for(var i=0,a=0;a<t.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=this.getBlock(t[a],e);n&&n.addItem(e)}},_addFnBase:function(e,t,i,n,s){var r=this;e=a.default.getDefaultItemText(n)+e,this.clearPreventUpdate(),a.default.vmMain.beginUpdateItems(),y.a.beginAction();var o={text:e};s&&(o=a.default.extend(o,s));var l=this.createVMLI(o,{parent:i,changeType:ChangeType.AllLocal,isEditable:!0});i.insertItem(l),y.a.performAction(TrackerType.Create,{itemID:l.id,parent:i.id,position:i.numItems(),text:e}),y.a.endAction(),a.default.vmMain.commitUpdateItems();var d=this.indexOfItem(l,t);d>=0&&(_.a.selectIndex(d,0),a.default.openKeyboardOnIndex(void 0,this,d,function(){r.setFocused(!0)}))},addFnProject:function(e){return this._addFnBase("",e,e.id===this.blockNoKey?this.getItem():u.default.getModel(e.id))},addFnTag:function(e){return this._addFnBase(e.id===this.blockNoKey?"":" "+e.text,e,this.getItem())},addFnDate:function(e){var t,i="";return e.isDate?i=" "+n.a.DatePrefix+m.a.getAppendDateText(e.date):e.isStarred?t={isStarred:!0}:e.isImportant?t={priority:VMLIFlag.P2}:i=" "+e.id,this._addFnBase(i,e,this.getItem(),void 0,t)},addFnContact:function(e){return this._addFnBase(e.id===this.blockNoKey?"":" "+e.text,e,this.getItem())},addFnPriority:function(e){return this._addFnBase("",e,this.getItem(),void 0,{priority:e.priority})},getDateForSoftDate:function(e){var t=a.default.timeline.getDateForKey(e.toLowerCase());if(!isNaN(t)){var i=100*Math.round(t/100),n={days:Math.round(i/100),minutes:Math.round(t-i)};return Date.today().add(n)}},getBlock:function(e,t){var i,n=this.isViewDates(),s=this.isViewAgenda(),r=e;if(n&&!a.default.isString(e)?(i=e,r=e=this._getKeyForDate(i),"overdue"===e&&(!t.isComplete()&&a.default.timeline.getDateForKey(e)||(e=void 0),i=void 0)):a.default.isObject(e)&&(a.default.Assert(e.value&&e.lower,"If key is object it should have this form"),r=e.lower,e=e.value),e){var o,l=this.isViewAutoBlocks()?void 0:u.default.getModel(e),d=this.getViewMode(),c=this.blocksByKey[r];if(!c)if(void 0!==(o=l?l.getStyledTextAsOneLine(!0):this.isViewPriority()?e===VMLIFlag.P0?"High":e===VMLIFlag.P1?"Medium":e===VMLIFlag.P2?"Low":"(No priority)":e)){var h={pane:this,id:e,name:o,sortMode:this.supportsSortItems()&&this.getSortModeItems(),addFn:this.isViewProject()&&this.addFnProject.bind(this)||this.isViewTag()&&this.addFnTag.bind(this)||this.isViewContact()&&this.addFnContact.bind(this)||this.isViewPriority()&&this.addFnPriority.bind(this)||s&&this.addFnDate};this.isViewTag()?(h.name=e===this.blockNoKey?"(No tag)":"#"+h.name,h.isTag=!0):this.isViewContact()?(h.name=e===this.blockNoKey?"(No contact)":"+"+h.name,h.isContact=!0):this.isViewPriority()&&(h.isPriority=!0,h.priority=e),d===w.Groups_Project&&(h.name=e===this.blockNoKey?"(No project)":h.name,h.item=l,h.isEditable=!0,h.date=l&&l.getDate(this)),e===this.blockNoKey&&(h.isNoKey=!0),n&&(i?(h.date=i.clone().clearTime(),h.isDate=!0,h.date.equals(Date.today())&&(h.isToday=!0)):(h.date=this.getDateForSoftDate(e),h.name=h.name.toUpperCase(),"now"===e?h.isNow=!0:"starred"===e?h.isStarred=!0:"important"===e?h.isImportant=!0:"overdue"===e&&(h.isOverdue=!0,h.noAddButton=!0))),c=new p(h),this.blocksByKey[r]=c,c.originalIndex=this.blocks.length,this.blocks.push(c)}}return c},closestIndexOfObject:function(e){return this.indexOfItem(e,e.block,e.index)},onGCalendarActiveChanged:function(e,t){this.supportDataRefresh=t;var i=e.getDefaultItemStore();t?this.useItemStore(i):this.stopUsingItemStore(i)},onGmailActiveChanged:function(e,t){var i=e.getDefaultItemStore();t?this.useItemStore(i):this.stopUsingItemStore(i)},refreshPaneData:function(){var e=a.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar);e.isActive()&&e.forceRemoteEventSync(this.id)},viewModeIcon:function(e){return e=e||this.getViewMode(),n.a.TaskViewModeIcon[e]},isViewDates:function(){return this._isViewHelper.dates},isViewAgenda:function(){return this._isViewHelper.agenda},isViewCalendar:function(){return this._isViewHelper.calendar},isViewCalendarHoriz:function(){return this._isViewHelper.calendarHoriz},isViewCalendarMonth:function(){return this._isViewHelper.calendarMonth},isViewProject:function(e){return this._isViewHelper.project},isViewProjectNoBlocks:function(){return this._isViewHelper.project&&(0===this.blocks.length||1===this.blocks.length&&this.blocks[0].id===this.blockNoKey)},isViewGroups:function(e){return this._isViewHelper.groups},isViewOutline:function(e){return this._isViewHelper.outline},isViewFlatList:function(e){return this._isViewHelper.flatList},isViewTag:function(e){return this._isViewHelper.tag},isViewContact:function(e){return this._isViewHelper.contact},isViewPriority:function(e){return this._isViewHelper.priority},isViewAutoBlocks:function(e){return this._isViewHelper.autoBlocks},isViewText:function(e){return this._isViewHelper.text},isViewPremiumBlocked:function(){return!a.default.billingManager.hasPremiumFeatures()&&n.a.TaskViewModesPremium[this.getViewMode()]},shouldShowAddBox:function(){return this.isViewOutline()||this.isViewProject()},isCalFilterActive:function(){var e=this.displayCalendars.get(),t=!this.displayLocalItems.get();for(var i in e)if(e.hasOwnProperty(i)&&!1===e[i]){t=!0;break}return t},becomeReal:function(){this._super.becomeReal.call(this),this.onViewStateChanged()},onViewStateChanged:function(){var e=this;this.isFakePane?this.setupViewStateMinor():(a.default.vmMain.setItemAnimationMode(n.a.ItemAnimationMode.None),this.setIgnoreRestoreScroll(void 0,function(){e._infiniteList.saveScrollOfTop()}),this.setupViewState(!0),this._infiniteList.clearCache(),this._infiniteList.alwaysRenderScroll=!0,this.isViewCalendar()||this._infiniteList.setInitialScrollOffset(0),this.updateItemsImmediate(!0,void 0,void 0,!0),a.default.vmMain.paneManager.updatePaneStateForPane(this),this.isViewDates()?(this.scrollToToday(ScrollDuration.Snap),requestAnimationFrame(function(){this.isViewDates()&&(this.scrollToToday(ScrollDuration.Snap),a.default.vmMain.resetItemAnimationMode(),requestAnimationFrame(function(){this._infiniteList.alwaysRenderScroll=!1}.bind(this)))}.bind(this))):this.setScrollOffset(0,ScrollDuration.Snap),a.default.vmMain.resetItemAnimationMode(),this.hasCollapsedObs.set(this.hasCollapsed()))},setupViewStateMinor:function(){var e=this.getViewMode(),t=this.getSortModeBlocks(),i={agenda:e===w.Agenda_Today||e===w.Agenda_Week||e===w.Agenda_All,calendar:e===w.Calendar_Day||e===w.Calendar_Week||e===w.Calendar_Month||e===w.Calendar_Custom,calendarHoriz:e===w.Calendar_Day||e===w.Calendar_Week||e===w.Calendar_Custom,calendarMonth:e===w.Calendar_Month,project:e===w.Groups_Project,groups:e===w.Groups_Project||e===w.Groups_Tag||e===w.Groups_Contact||e===w.Groups_Priority,outline:e===w.Outline||e===w.List_Flat,flatList:e===w.List_Flat,tag:e===w.Groups_Tag,contact:e===w.Groups_Contact,priority:e===w.Groups_Priority};i.dates=i.agenda||i.calendar,i.autoBlocks=i.agenda||i.tags||i.contact||i.priority,i.text=!i.calendar,this._isViewHelper=i,this.supportsSortBlocks()&&(this.supportsSortBlocksMode(t)||this.setSortModeBlocks(A[e].Default,1,!1),(t=this.getSortModeBlocks())===I.Completed&&0===this.search.getFilterValue("completeOption")&&this.search.setFilter("completeOption",1)),this.search.setFilterEnabled("showOnlyAgendaDates",this.isViewAgenda()),this.search.setFilterEnabled("showOnlyMatchingTags",this.isViewTag()||this.isViewContact()),this.search.setFilterEnabled("showChildProjects",this.isViewProject()),(this.isViewTag()||this.isViewContact())&&this.search.setFilterTooltip("showOnlyMatchingTags","Show only matching "+(this.isViewTag()?"Tag":"Contact")+" blocks")},setupViewState:function(e){this.setupViewStateMinor();var t,i=this.getViewMode(),s=this.getSortModeBlocks(),r=this.isViewOutline(),o=this.isViewCalendar()||a.default.activeDisplayMode&DisplayMode.NoPaneTop?0:16;if(this.paneObjectsByItem={},this.blockNoKey=b+"_"+i,this.supportIndent=r,this.supportMultiselect=r,this.overviewTracksScroll=r,this.supportSearchFlat=r,this.supportCheckbox=!this.isViewCalendar(),this.topBoxHeight.set(o,!1),this.paneClass=this.getPaneClass(),this.paneEmptyMessage=(this.isViewAgenda()?"Nothing on the agenda":this.isViewOutline()&&"Write some things here to get started")||"",this.collapsedFieldName=n.a.PerPaneStateField.Collapsed+(this.viewState?i:""),this._isSearchedFlat=!(this.isViewCalendar()||!this.search)&&!this.search.showHierarchy(),this.isViewPremiumBlocked()?this.toast.set({text:"The "+n.a.TaskViewModeText[i]+" view is a Premium feature",actionText:"GO TO OUTLINE",doAction:this.switchToOutline}):this.toast.set(void 0),(this.isViewCalendar()||this.isViewAgenda())&&(t=n.a.ItemStoreFilter.Dates,(this.isViewCalendar()||this.getSortModeBlocks()===I.Date)&&(t|=n.a.ItemStoreFilter.Priority)),this.search.itemStoreFilter=t,this.search.onlyMatchDates=this.isViewDates(),this.shouldUpdateOnTextChanged=this.isViewAgenda()||this.isViewTag(),this.combineOverdue=this.isViewAgenda()&&s===I.Date,this.showScrollbars.set(!this.isViewCalendar()),this.isViewAgenda()){var l,d;if(i!==w.Agenda_All)i===w.Agenda_Today?d=1:i===w.Agenda_Week&&(d=7),l=Date.today().addDays(s===I.Date?d:-(d-1));s===I.Date?this.endDate=l:(this.startDate=l,this.endDate=Date.today().addDays(1))}this.isEditable=this.supportSel=!this.isViewCalendar(),this.orientation.set(this.isViewCalendarHoriz()?n.a.Orientation.Horizontal:n.a.Orientation.Vertical),i===w.Calendar_Week||i===w.Calendar_Month?(this.minWidthFlex=700,this.maxWidthFlex=1200,this.maxWidthSingle=1600,this.minWidth=600,this.maxWidth=1600):(this.minWidth=n.a.StdPaneWidthMin,this.minWidthFlex=n.a.StdPaneWidthMin,this.maxWidth=n.a.PaneWidthMax,this.maxWidthFlex=this.maxWidthSingle=n.a.StdPaneWidthMax),this.dateInMiddle=this._getDateInMiddle(),a.default.vmMain.paneManager.updatePaneRects()},getPaneClass:function(){return"paneTask pane"+((this.isViewCalendar()?"Calendar":this.isViewAgenda()&&"Agenda")||this.isViewProject()&&"Project"||this.isViewTag()&&"Tag"||this.isViewContact()&&"Contact"||this.isViewPriority()&&"Priority"||this.isViewOutline()&&"Outline")},onScroll:function(){this.getViewMode();this.isViewCalendarHoriz()&&(clearTimeout(this._timeoutUpdateAllDay),this._timeoutUpdateAllDay=setTimeout(this.updateAllDay,50))},_handleDragOverPane:function(e,t,i,n,s,r,o){if(e&&a.default.findParent(i,"paneContent")&&!a.default.hasClass(i,"paneContent")&&!a.default.hasClass(i,"paneTopBox")&&s&&"blockHeader"===s.type&&(this.isViewAgenda()&&e.supportDates||this.isViewAutoBlocks())){var l,d=a.default.getListCellForElement(i);return d&&d.props.cell&&(l=d.props.cell.paneObject.block,this.isViewAgenda()&&l.isOverdue&&(l=void 0)),this.dragHoveredBlock.set(l),c.default.setBlockTarget(l),{block:l}}if(!s||"blockItem"===s.type)return this.dragHoveredBlock.set(void 0),this.isViewCalendar()||c.default.setBlockTarget(void 0),this._handleDragOverTasks(e,t,i,n,s,r,o)},_handleDragOverTasks:function(e,t,i,a,s,r,o){var l,d,u,c,h,f=!1,p=n.a.DragDropPosition.Below,g=!1,m=0;if(s){l=s.item,h=s.index,l.isNote()&&(h--,s=this.objectAtIndex(h),a=this.elementAtIndex(h),l=l.parent()),l.hasNote()&&(m=this.sizeOfItem(l.getNote(),h+1));var v=a.getBoundingClientRect(),_=v.height+m;p=o<v.top+_/2?n.a.DragDropPosition.Above:n.a.DragDropPosition.Below,u=a,f=!0}else if(0===this.numItems())l=this.getItem(),g=!0;else{var y=this.indexOfLastItem();!f&&y>=0&&this.isIndexMounted(y)&&o>=(c=this.elementAtIndex(y)).getBoundingClientRect().bottom&&(l=this.getLastItem(),s=this.getLastObject(),u=c,p=n.a.DragDropPosition.Below,f=!0)}if(!f&&!this.isSearchedFlat()){var S=this&&this.indexOfFirstItem();if(this&&S>=0&&this.isIndexMounted(S))if(o<(c=this.elementAtIndex(S)).getBoundingClientRect().top)l=this.getFirstItem(),s=this.getFirstObject(),u=c,p=this.isViewProject()&&0===s.levelsDeep?n.a.DragDropPosition.On:n.a.DragDropPosition.Above,f=!0}if(f){var w=u.getBoundingClientRect(),I=p!==n.a.DragDropPosition.Below?w.top:w.top+w.height+m,b=p===n.a.DragDropPosition.On?w.height:void 0;if(I>this.contentTop()){var A;p===n.a.DragDropPosition.Below&&h+1<this.numItems()&&l.hasChildren()&&((A=this.objectAtIndex(h+1)).item||(A=void 0)),A=A||s;var D=this.getPaddingForPaneObject(A);d={left:w.left+D,top:I,width:w.right-w.left-D,height:b}}}return this.scrollFromMousePosition(r,o,this.orientation.get()===n.a.Orientation.Horizontal),{position:p,targetElement:u,targetItem:l,linePosition:d,overview:!1,dropOnPane:g,atEnd:void 0}},handleDragDrop:function(e,t,i,a){c.default.blockTarget?(c.default.startPane.applyDropOnBlock(c.default.blockTarget,e,this,t.dataTransfer.block),this.revertDrag()):this.isViewAutoBlocks()||this._super.handleDragDrop.call(this,e,t,i,a)},revertDrag:function(){this._super.revertDrag.call(this),this.dragHoveredBlock.get()&&this.dragHoveredBlock.set(null)},getSaveInfo:function(){var e=this._super.getSaveInfo.call(this);return e.viewState=this.viewState.get(),e.displayCalendars=this.displayCalendars.get(),e.displayLocalItems=this.displayLocalItems.get(),e.blocksCollapsed=this.blocksCollapsed,e},isBlockCollapsed:function(e){return e.item?e.item.isCollapsed(this):!0===this.blocksCollapsed[e.id]},setBlockCollapsed:function(e,t){_.a.reset(),this.blocksCollapsed[e.id]=t,this.hasCollapsedObs.set(this.hasCollapsed()),this.updateBlockItems(),a.default.vmMain.paneManager.savePaneState()},onInfiniteListLoaded:function(){!this.initialOffset&&this.isViewCalendar()&&(this.initialOffset=this.getScrollOffsetOfToday()||0,this._infiniteList.setInitialScrollOffset(this.initialOffset))},addProject:function(e,t,i){return this.addItemWithPrefix(e,n.a.Prefix.Header,t,i)},addItemWithPrefix:function(e,t,i,s){e=e||0,a.default.vmMain.beginUpdateItems(),_.a.reset(),this.setIgnoreRestoreScroll();var r=s?this.getRootItem():this.getItem(),o=(t?t+" ":"")+(i||""),l=a.default.getDefaultItemText(),d=r.addItemAtIndex(o,e,this);this.isViewProject()&&t===n.a.Prefix.Header&&d.addItemAtIndex(l,e,this),a.default.vmMain.commitUpdateItems();var u=this.indexOfItem(d);return this.scrollIndexIntoView(u),_.a.selectIndex(u,o.length),d},setDisplayLocal:function(e){this.displayLocalItems.set(e),this.updateItems()},setDisplayCalendar:function(e,t){var i=a.default.clone(this.displayCalendars.get());i[e.id]=t,this.displayCalendars.set(i),this.updateItems()},getCollapsedDefault:function(e,t,i){return t?e.parent()!==this.getRootItem():(i=i||this.getViewMode(),!(this.isViewOutline()||this.isViewProject()&&e.isPrefixHeader()&&this.isItemTopLevel(void 0,e)))},getWidth:function(){var e=this._super.getWidth.call(this);return this.isViewCalendar()&&!this.isViewCalendarMonth()&&(e-=50),e},getMonthStart:function(e){return e.clone().clearTime().addDays(1-e.getDate())},getWeekStart:function(e){return e.clone().clearTime().addDays(-e.getDay()+a.default.settings.get(Settings.dayWeekStart))},doesWeekCrossMonth:function(e){if(e.clone().addDays(6).getDate()<e.getDate())return!0},updateCalendarMonth:function(){var e,t,i,a=0,s=0,r=[],o=this.dateInMiddle,l=this.getWeekStart(o),d=n.a.CalendarMonthViewNumWeeksPad;for(i=-1;r.length<d;i--){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;e=l.clone().addWeeks(i),t=this.doesWeekCrossMonth(e),r.splice(0,0,this.updateCalendarMonthWeek(e,!1,t)),t&&r.length<d&&r.splice(0,0,this.updateCalendarMonthWeek(e,!0,!1))}for(d=2*n.a.CalendarMonthViewNumWeeksPad+1,i=0;r.length<d;i++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;e=l.clone().addWeeks(i),(t=this.doesWeekCrossMonth(e))&&r.length<d&&r.push(this.updateCalendarMonthWeek(e,!0,!1)),r.push(this.updateCalendarMonthWeek(e,!1,t))}this.items.set(r)},updateCalendarMonthWeek:function(e,t,i){for(var a,n,s=0,r=[],o=1===e.getDate(),l=0;l<7;l++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var d=e.clone().addDays(l);if(a&&d.getDate()<a.getDate()&&(o=!0),!(!o&&i||o&&t)){r[l]={date:d};var u=this._getKeyForDate(d),c=this.blocksByKey[u];c&&(c.sort(),r[l].items=c.items),n||(n=d)}a=d}return{type:"calendarWeek",id:"week_"+e+(t?"_end":""),date:n,dates:r,sizeInPane:this.heightWeek()}},heightWeek:function(){return n.a.CalendarMonthViewWeekHeight},getItemsOnDay:function(e){var t=this._getKeyForDate(e),i=this.blocksByKey[t];return i&&i.items||[]},updateCalendarWeek:function(){for(var e=0,t=[],i=n.a.CalendarDayViewNumDaysPad,a=this.dateInMiddle,s=this.getViewMode(),r=-i;r<i;r++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var o=a.clone().addDays(r),l=this._getKeyForDate(o),d=this.blocksByKey[l],u=d&&d.items||[];t.push({type:"calendarDay",id:s+"_day_"+(r+i),date:o,items:u,sizeInPane:this.getDayWidth})}this.items.set(t)},getItemPlacementOnDate:function(e,t){var i=e.repeatDate(),a=e.date()||e.repeatDate(),s=e.getDuration()&&e.date()&&e.getEndDate();if(a&&a.hasTimeOfDay()&&(i||a.isSameDay(t))){var r=a.getHours()+a.getMinutes()/60,o=e.getDuration()?e.getDuration()/n.a.MSPerHour:1;if(o=Math.round(10*Math.min(o,24-a.getHours()))/10,r>0||o<24)return{time:r,duration:o}}else if(a&&a.hasTimeOfDay()&&s&&!a.isSameDay(t)&&s.isSameDay(t)){return{time:0,duration:o=s.getHours()+s.getMinutes()/60}}return!1},updateAllDay:function(){if(!this._destroyed){for(var e=0,t=this.indexOfTop(),i=this.inViewCount(),a=1,n=t;n<t+i;n++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var s=this.items.get()[n];if(s){for(var r=0,o=0,l=s.items||[],d=0;d<l.length;d++){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;var u=l[d];this.getItemPlacementOnDate(u,s.date)||o++}o>a&&(a=o)}}this.numAllDay.set(a)}},getContentHeight:function(){return 1224+this.getHeightAllDay()+2},getHeightAllDay:function(){return Math.min(n.a.CalendarDayViewMaxAllDayHeight,26*this.numAllDay.get())+1},getDayViewY:function(){return 409},getDayWidth:function(){var e=this.getWidth(),t=this.getViewMode(),i=(t===w.Calendar_Day?1:t===w.Calendar_Week&&7)||t===w.Calendar_Custom&&a.default.settings.get("calendarCustomDays");return Math.max(e/i,40)},openItemEditor:function(e){e.pane=this,a.default.menus.openItemEditor(e)},getPaddingForPaneObject:function(e,t){var i=this._super.getPaddingForPaneObject.call(this,e,t);return t||(i+=this.extraPaddingForPaneObject(e)),i},extraPaddingForPaneObject:function(e){return this.isViewAgenda()?n.a.PaddingAgendaTime:0},shouldShowTime:function(e,t){var i="blockItem"===e.type&&e.item;return i&&!i.isNote()&&0===e.levelsDeep&&e.block&&e.block.shouldShowTime()},isSearchedFlat:function(){return this._isSearchedFlat},isItemTopLevel:function(e,t){var i=!0;if(this.isViewProject()){if(e)return e.isBlockHeader;i=t.isPrefixHeader(this)}return this.isViewProject()&&this.search.showChildProjects()||(i=this._super.isItemTopLevel.call(this,e,t)),i},openViewMenu:function(e){a.default.menus.openContextMenu({componentName:"ReactContextMenuPanes",element:e.target,pane:this,positionOffset:{left:45},subset:PaneMode.Task})},hasCollapsed:function(e){if(!e&&this.isViewAutoBlocks()){for(var t=0,i=0;this.blocks&&i<this.blocks.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(this.isBlockCollapsed(this.blocks[i]))return!0}return!1}return this._super.hasCollapsed.call(this,e)},toggleCollapseAll:function(){var e=!this.hasCollapsed();if(this.isViewAutoBlocks()){for(var t=0,i=0;i<this.blocks.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this.blocksCollapsed[this.blocks[i].id]=e}e||(e=void 0)}this._super.collapseAll.call(this,this.item.get(),e,void 0,this.isViewAutoBlocks())},supportsSortBlocks:function(e){return e=e||this.getViewMode(),D.supportsSortBlocks(e)},supportsSortBlocksMode:function(e,t){return t=t||this.getViewMode(),D.supportsSortBlocksMode(e,t)},supportsSortItems:function(e){return e=e||this.getViewMode(),D.supportsSortItems(e)||this.isViewOutline()&&this.isSearchedFlat()},getSortModeBlocks:function(){if(this.supportsSortBlocks())return this.viewState.get().sortModeBlocks.mode},getSortOrderBlocks:function(){if(this.supportsSortBlocks())return this.viewState.get().sortModeBlocks.order||1},isSortedBlocks:function(){var e=this.getSortModeBlocks();return e&&e!==I.None},setSortModeBlocks:function(e,t,i){this.setViewProp("sortModeBlocks",{mode:e,order:t},i)},getSortModeItems:function(){if(this.supportsSortItems())return this.viewState.get().sortModeItems.mode},getSortOrderItems:function(){if(this.supportsSortItems())return this.viewState.get().sortModeItems.order||1},setSortModeItems:function(e,t,i){this.setViewProp("sortModeItems",{mode:e,order:t},i)},isSortedItems:function(){var e=this.getSortModeItems();return e&&e!==I.None},getViewMode:function(){return this.viewState.get().viewMode},setViewMode:function(e){this.setViewProp("viewMode",e)},setViewProp:function(e,t,i){var a=this.viewState.get();a[e]!==t&&(a[e]=t,this.viewState.set(a,!1!==i))},createVMLI:function(e,t){var i=this.search.getTags();if(!this.isViewTag()&&i)for(var a=0,n=0;n<i.length;n++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=i[n],r="#"+s;if(e.text.indexOf(r)<0){for(var o=0,l=!1,d=t&&t.parent;d;){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var u=d.getTags();if(u&&u.indexOf(s)>=0){l=!0;break}d=d.parent()}l||(e.text+=" "+r)}}return this._super.createVMLI.call(this,e,t)},getItemDisplayTime:function(e){var t=this.getSortModeBlocks(),i=e.item;return t===I.Date?i.time()||(e.showAllDay?"All day":""):t===I.Created?i._formatDateTime(i.dateCreated):t===I.Completed?i.dateCompleted?i._formatDateTime(i.dateCompleted):"no time":void 0},checkFlatListMode:function(){var e=this.getViewMode();e===w.List_Flat&&0===this.search.getFilterValue("showOnlyMatches")&&this.setViewMode(w.Outline),e===w.Outline&&1===this.search.getFilterValue("showOnlyMatches")&&this.setViewMode(w.List_Flat)},onCalendarCustomDaysChanged:function(){this.getViewMode()===w.Calendar_Custom&&this.onViewStateChanged()},switchToOutline:function(){this.setViewMode(w.Outline)},shouldRenderPrefix:function(e){return e.item.hasPrefix()&&!(this.isViewProject()&&e.isBlockHeader)},bottomListMessage:function(){var e=void 0;if(!(this.numItems()>0)){var t=this.search.numUnmatchedItems();t&&(e=this.isSearched()?t+" items hidden by search / filters. Click the search box above to clear your search / filters, or click to add new items.":t+" completed items hidden by filter. Click the search box above and click the checkbox filter to show completed items.")}return{text:e,clickable:!1}},needsUpdateForDate:function(e){return this.isViewDates()},_anyTagHasKey:function(e){return e&&e.some(function(e){return a.default.timeline.getDateForKey("#"+e)})},needsUpdateForTags:function(e,t){if(this.isViewAgenda())return this._anyTagHasKey(t)},handleItemChanged:function(e,t){var i=!1;return t[n.a.ItemProp.Text]&&this.isViewAutoBlocks()&&(i=!0),this._super.handleItemChanged.call(this,e,t,i)},addPaneObject:function(e,t){var i=t.item;e.push(t),i&&(this.paneObjectsByItem[i.id]?this.paneObjectsByItem[i.id].push(t):this.paneObjectsByItem[i.id]=[t])}};s.a.inherit(r.a,D),s.a.extend(D.prototype,T),D.supportsSortBlocks=function(e){return!!A[e]},D.supportsSortBlocksMode=function(e,t){return A[t]&&A[t].Available.indexOf(e)>=0},D.supportsSortItems=function(e){return e===w.Groups_Project||e===w.Groups_Tag||e===w.Groups_Contact||e===w.Groups_Priority};var M=D,C=i(23),L=n.a.TaskViewMode;function P(){this._inactivePaneTypes={},this.activePaneTypes=new C.a,this._registeredTypes={},this.numInactivePanes=new g.a(0),this.registerPaneType(void 0,PaneMode.Task,"Task",M,"icon-align-left",99),this.registerPaneType(void 0,PaneMode.Archived,"Archived",d,"icon-inbox",90)}P.prototype={paneSortCompare:function(e,t){return e.priority<t.priority?1:-1},registerPaneType:function(e,t,i,a,n,s){this._registeredTypes[t]={plugin:e,constructor:a};var r={type:t,name:i,icon:n,text:i,priority:s,tooltip:"Add "+i+" Pane"};!e||e.isActive()?this.activePaneTypes.insertSorted(r,this.paneSortCompare):(this._inactivePaneTypes[t]=r,this.numInactivePanes.set(this.numInactivePanes.get()+1))},activatePaneType:function(e){var t=this._inactivePaneTypes[e];a.default.Assert(t,"Must have previously registered pane type"),this._inactivePaneTypes[e]=void 0,this.activePaneTypes.insertSorted(t,this.paneSortCompare),this.numInactivePanes.set(this.numInactivePanes.get()-1)},deactivatePaneType:function(e){var t=this.activePaneTypes.remove(function(t){return t.type===e})[0];a.default.Assert(t,"Must have previously activated pane type"),a.default.vmMain.paneManager.removePanesByType(e),this._inactivePaneTypes[e]=t,this.numInactivePanes.set(this.numInactivePanes.get()+1)},canCreatePane:function(e){var t=this._registeredTypes[e];return!(t.plugin&&(!t.plugin.isActive()||t.plugin.isPluginBlocked()))},createPane:function(e,t){(t=t||{}).id||(t.id=a.default.vmMain.paneManager.getNextPaneID()),"PaneTimeline"===e?(e=PaneMode.Task,t.viewState={viewMode:L.Agenda_All}):"PaneOutline"===e&&(e=PaneMode.Task,t.viewState={viewMode:L.Outline});var i=this._registeredTypes[e];if(i){if(!i.plugin||i.plugin.isActive()&&!i.plugin.isPluginBlocked())try{a.default.vmMain.beginUpdateItems();var n=new i.constructor(t);return a.default.vmMain.commitUpdateItems(),n}catch(e){return void a.default.reportError(e)}}else a.default.Assert(!1,"Invalid pane type requested")},isPaneTypeActive:function(e){var t=!!this._registeredTypes[e],i=!!this._inactivePaneTypes[e];return t&&!i},getRegisteredPanes:function(){return this.activePaneTypes.get()},_getTaskView:function(e,t,i,s){for(var r=0,o=[],l=0;l<i.length;l++){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;var d=i[l],u=n.a.TaskViewModeText[d];d===L.Calendar_Custom&&(u=u.replace("#",a.default.settings.get(Settings.calendarCustomDays))),o.push({text:u,type:PaneMode.Task,viewMode:d,icon:n.a.TaskViewModeIcon[d],premium:!!n.a.TaskViewModesPremium[d],canZoom:!0})}e.push({text:t,viewModes:o,border:!s})},getAvailablePanes:function(e){var t=this.activePaneTypes.get(),i=this.numInactivePanes.get(),n=[];if(this._getTaskView(n,"List",[L.Outline,L.List_Flat]),this._getTaskView(n,"Grouped by",[L.Groups_Project,L.Groups_Tag,L.Groups_Contact,L.Groups_Priority]),this._getTaskView(n,"Agenda",[L.Agenda_Today,L.Agenda_Week,L.Agenda_All]),this._getTaskView(n,"Calendar",[L.Calendar_Day,L.Calendar_Custom,L.Calendar_Week,L.Calendar_Month],e),!e){for(var s=0,r=0;r<t.length;r++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var o=t[r],l=!0;if(o.type!==PaneMode.Task){if(o.type===PaneMode.Archived)a.default.vmMain.root().hasArchivedDescendant()||(l=!1);if(l){var d=o.type===PaneMode.Gmail;n.push({text:o.text,type:o.type,icon:o.icon,canZoom:d,border:!0})}}}n[n.length-1].border=!1,i>0&&n.push({enableMore:!0})}return n}};t.a=new P},function(e,t,i){"use strict";var a=i(0);function n(){this._lib={}}n.prototype={add:function(e){a.default.Assert(1===arguments.length,"Only expect a single resource to be passed in, not a res,key pair"),a.default.Assert(e.id,"Must specify a valid resource ID"),a.default.Assert(!this._lib[e.id],"Should never have duped resources"),this._lib[e.id]=e},getByCID:function(e){var t;this._lib;return this.forEachResource(function(i){if(i.cid===e)return t=i,!1}),t},find:function(e){var t;if(this.has(e))t=this.getByCID(e);else{var i=e.split("@");t=this.getByCID(i[0])}return t},has:function(e){return!!this.getByCID(e)},remove:function(e){a.default.Assert(this._lib[e.id],"Must only remove resouces that actually exist"),delete this._lib[e.id]},isEmpty:function(){return a.default.isEmpty(this._lib)},forEachResource:function(e){for(var t in this._lib)try{if(!1===e(this._lib[t]))break}catch(e){a.default.reportError(e)}},clone:function(){var e=new n;for(var t in this._lib)e.add(a.default.clone(this._lib[t]));return e}},t.a=n},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(2),r=i.n(s),o=i(12),l=Object.assign||function(e){for(var t=0,i=1;i<arguments.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=arguments[i];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};var d=o.a.createClass({displayName:"DivX",componentDisplay:n.a.ComponentDisplay.Everywhere,componentDidMount:function(){(this.props.onClick||this.props.onMouseDown)&&a.default.setupClick(this.refs.element,this,this.onTap)},getElement:function(){return this.refs.element},onMouseDown:function(e){this.lastX=e.clientX,this.lastY=e.clientY,this.moveX=0,this.moveY=0,this.isDown=!0,this.startSrc=e.target,this.props.onMouseDown&&this.props.onMouseDown(e)},onMouseMove:function(e){if(this.isDown){this.moveX+=Math.abs(e.clientX-this.lastX),this.moveY+=Math.abs(e.clientY-this.lastY),this.lastX=e.clientX,this.lastY=e.clientY;var t={startSrc:this.startSrc,target:e.target,clientX:e.clientX,clientY:e.clientY,eventX:e.clientX,eventY:e.clientY,preventDefault:a.default.emptyFn,stopPropagation:a.default.emptyFn,stopImmediatePropagation:a.default.emptyFn};this.props.onMouseMove&&this.props.onMouseMove(t)}},onClick:function(e){this.moveX<a.default.ClickThreshold&&this.moveY<a.default.ClickThreshold&&this.props.onClick&&this.props.onClick(e)},onMouseUp:function(e){this.isDown=!1,this.props.onMouseUp&&this.props.onMouseUp(e),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)},onTap:{onStart:function(e){this.onMouseDown(e),e.stopPropagation()},onClick:function(e){this.props.onClick&&(this.props.onClick(e),e.stopPropagation())},onMove:function(e){this.props.onMouseMove&&this.props.onMouseMove(e),e.stopPropagation()},onEnd:function(e){this.onMouseUp(e),e.stopPropagation()}},render:function(){var e=this.props,t=(e.onClick,e.globalEvents),i=function(e,t){var i={};for(var a in e)t.indexOf(a)>=0||Object.prototype.hasOwnProperty.call(e,a)&&(i[a]=e[a]);return i}(e,["onClick","globalEvents"]);return r.a.createElement("div",l({},i,{onMouseDown:void 0,onMouseMove:t?void 0:this.onMouseMove,onClick:void 0,onMouseUp:void 0,ref:"element"}),this.props.children)}});t.a=d},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(4),r=i(2),o=i.n(r),l=(i(8),i(12)),d=Object.assign||function(e){for(var t=0,i=1;i<arguments.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=arguments[i];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};var u=l.a.createClass({displayName:"FancyScroller",componentDisplay:n.a.ComponentDisplay.Everywhere,init:function(){var e=this.props;this.thumbExtraHeight=0,a.default.Assert(!(e.noOwnScroll&&e.onScroll),"FancyScroller can not have onScroll prop if it does not own its own scroll")},componentDidMount:function(){this.refs.thumb&&this.addTap("thumb",this,this.onTapThumb)},onUnmount:function(){this.timeoutShow&&(clearTimeout(this.timeoutShow),this.timeoutShow=void 0),this.timeoutHide&&(clearTimeout(this.timeoutHide),this.timeoutHide=void 0)},getScrollSize:function(){var e=this.props.orientation!==n.a.Orientation.Horizontal?"Height":"Width";return this.props.getScrollSize?this.props.getScrollSize():this.refs.scroller["scroll"+e]},getClientHeight:function(){var e=this.props.orientation!==n.a.Orientation.Horizontal?"Height":"Width";return this.props.getClientHeight?this.props.getClientHeight():this.refs.scroller["client"+e]},getScrollTop:function(){var e=this.props.orientation!==n.a.Orientation.Horizontal?"Top":"Left";return this.props.getScrollTop?this.props.getScrollTop():this.refs.scroller["scroll"+e]},calculateThumb:function(){this.props;var e,t=this.getScrollSize(),i=this.getClientHeight(),a=this.getScrollTop(),n=this.props.thumbHeight;(n||(t===i?n=i:(n=i/t*i,this.thumbExtraHeight=n<30?30-n:0,n=Math.floor(Math.max(n,30)))),t===i)?e=0:e=a/(t-i)*(i-n);e=Math.floor(e);var s=n!==this.thumbHeight.get()||e!==this.thumbTop.get();this.thumbHeight.set(n,!1),this.thumbTop.set(e,s)},onScroll:function(e){this.handleScroll(),this.props.onScroll&&this.props.onScroll(e)},handleScroll:function(){this.isMouseDown||(this.calculateThumb(),this.isVisible.set(!0),this.hideTimeout()),this.props.trackHasScrolled&&this.hasScrolled.set(this.getScrollTop()>0)},onMouseMove:function(e){this.timeoutHide&&(clearTimeout(this.timeoutHide),this.timeoutHide=void 0)},onMouseEnter:function(e){var t=this.refs.scroller;t.scrollHeight>t.clientHeight&&(this.timeoutShow&&clearTimeout(this.timeoutShow),this.timeoutShow=setTimeout(this.showScrollbar,100))},onMouseLeave:function(e){this.timeoutShow&&(clearTimeout(this.timeoutShow),this.timeoutShow=void 0),this.isMouseDown||this.hideTimeout()},onTapThumb:{onStart:function(e){e.button===ButtonCode.Left&&(this.isMouseDown=!0,this.lastY=this.props.orientation===n.a.Orientation.Horizontal?e.clientX:e.clientY,a.default.disableMouseMove=!0,this.isDragging.set(!0)),e.stopPropagation()},onMove:function(e){if(this.isMouseDown){var t=this.refs.scroller,i=this.props.orientation===n.a.Orientation.Horizontal,s=i?e.clientX:e.clientY,r=i?"Left":"Top",o=i?"Width":"Height",l=s-this.lastY;this.lastY=s;var d=a.default.clamp(this.thumbTop.get()+l,0,t["client"+o]-this.thumbHeight.get());this.thumbTop.set(d);var u=d/(t["client"+o]-this.thumbExtraHeight)*t["scroll"+o];t["scroll"+r]=u,e.preventDefault()}},onEnd:function(e){this.isMouseDown&&e.button===ButtonCode.Left&&(this.isMouseDown=!1,a.default.disableMouseMove=!1,this.isDragging.set(!1),this.hideTimeout())}},hideTimeout:function(){this.timeoutHide&&clearTimeout(this.timeoutHide),this.timeoutHide=setTimeout(this.hideScrollbar,500)},hideScrollbar:function(){this.isVisible.set(!1),this.timeoutHide=void 0},showScrollbar:function(){this.calculateThumb(this.refs.scroller),this.isVisible.set(!0),this.timeoutShow=void 0},getElement:function(){return this.refs.element},getScrollElement:function(){return this.getElement()},scrollTo:function(e,t,i){isNaN(i)&&(i=ScrollDuration.Default),a.default.scrollTo(e,t,i,this.refs.scroller)},scrollToBottom:function(){var e=this.getClientHeight();this.scrollTo(0,e)},render:function(){var e=this.state,t=this.props,i=(t.getScrollSize,t.getClientHeight,t.getScrollTop,t.noOwnScroll,t.showScrollbars,t.trackHasScrolled,t.scrollable),r=(t.orientation,t.tinyMode),l=function(e,t){var i={};for(var a in e)t.indexOf(a)>=0||Object.prototype.hasOwnProperty.call(e,a)&&(i[a]=e[a]);return i}(t,["getScrollSize","getClientHeight","getScrollTop","noOwnScroll","showScrollbars","trackHasScrolled","scrollable","orientation","tinyMode"]),u=t.orientation===n.a.Orientation.Horizontal,c=!1!==i&&!a.default.noScrollbars,h=a.default.classNames("fancyScroller",t.className,{flexbox:!1},{"flexvert horizontal":u},{vertical:!u},{trackHasScrolled:t.trackHasScrolled},{scrolled:e.hasScrolled},{tinyMode:r}),f=(a.default.classNames("fancyScrollbar",{"visible c-border":e.isVisible},{dragging:e.isDragging}),a.default.classNames("fancyScrollbarThumb c-bg-scrollthumb",{dragging:e.isDragging}),{});u?(f.width=e.thumbHeight,f[s.a.transform.react]="translate3d("+e.thumbTop+"px,0,0)"):(f.height=e.thumbHeight,f[s.a.transform.react]="translate3d(0,"+e.thumbTop+"px,0)");a.default.classNames("fancyScrollContent",{hideScrollbar:void 0!==t.showScrollbars},{scrollable:c});return{}[t.orientation===n.a.Orientation.Horizontal?"overflowX":"overflowY"]="auto",o.a.createElement("div",d({},l,{className:h,ref:"element","data-moo-id":this.getUniqueID()}),t.children)}});t.a=u},function(e,t,i){"use strict";var a=i(0),n=(i(5),i(1),i(16),i(64)),s=function(){function e(e,t){for(var i=0,a=0;a<t.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();var r=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.onAuthedCallbacks=[]}return s(e,[{key:"init",value:function(){var e=this;Object(n.a)(function(){e.isSignedIn=!0,e.runAuthedCallbacks()})}},{key:"runAuthedCallbacks",value:function(){this.isSignedIn&&a.default.vmSetup.setLoginState(LoginState.LOGGED_IN),this.onAuthedCallbacks.length>0&&this.onAuthedCallbacks.forEach(function(e){return e()})}},{key:"signIn",value:function(){a.default.vmSetup.onTapLogin()}},{key:"onAuthed",value:function(e){this.isSignedIn?e():this.onAuthedCallbacks.push(e)}},{key:"getScopes",value:function(){return["https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/drive.install","https://www.googleapis.com/auth/drive.appdata"]}},{key:"signOut",value:function(e){e()}}]),e}();t.a=new r},,function(e,t,i){"use strict";function a(e){this._limit=e,this._offset=0,this._buffer=[]}a.prototype={get:function(e){return this._buffer[e]},push:function(e){this._buffer[this._offset]=e,this._offset=(this._limit+this._offset+1)%this._limit},peek:function(){var e=(this._limit+this._offset-1)%this._limit;return this._buffer[e]},pop:function(){var e=(this._limit+this._offset-1)%this._limit,t=this._buffer[e];return t&&(this._buffer[e]=void 0,this._offset=e),t},hasData:function(){return!!this.peek()},reset:function(){this._offset=0,this._buffer=[]},buffer:function(){return this._buffer},limit:function(e){this._limit=e},ordered:function(){return this._buffer.slice(this._offset).concat(this._buffer.slice(0,this._offset))},entries:function(){for(var e=0,t=this.ordered(),i=0;i<t.length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;console.log("---- Entry ["+i+"] ----"),console.log(t[i])}}},t.a=a},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(6),r=i(4),o=i(19),l=i(2),d=i.n(l),u=i(12),c=i(26),h=i(30),f=i(27),p=i(15),g=u.a.createClass({displayName:"FancyInput",componentDisplay:n.a.ComponentDisplay.Everywhere,init:function(){var e=this.props,t={isFocused:e.focused,isComposing:!1,value:e.value||"",tokens:e.tokens||[],item:e.item?{item:e.item,text:e.item.getStyledTextAsOneLine()}:void 0};this.isInput="password"===e.type,this.isInput||(this.html=this.parseHTML(t.value||TextSpace)),e.buttonText&&(t.isLoading=!1),this.createObservables(t)},componentDidMount:function(){this.updateHTML(this.state.value,!1),this.props.focused&&(this.focus(),this.props.selectAll?this.selectAll():this.selectEnd())},onUnmount:function(){this.isFocused.get()&&this.onBlur(),f.a.hide()},componentWillReceiveProps:function(e){this.state.item!==e.item&&e.item&&this.item.set(e.item?{item:e.item,text:e.item.getStyledTextAsOneLine()}:void 0),this.props.value!==e.value&&e.value!==this.state.value&&(this.setValue(e.value,this.isFocused.get()),this.forceUpdate()),this.props.tokens!==e.tokens&&e.tokens!==this.state.tokens&&this.tokens.set(e.tokens)},componentDidUpdate:function(){var e=this._isDirty;if(this._isDirty=void 0,e&&this._dirtyCallbacks){for(var t=0,i=0;i<this._dirtyCallbacks.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this._dirtyCallbacks[i]()}this._dirtyCallbacks=void 0}},clearValue:function(){this.setValue("")},isButtonEnabled:function(){return void 0!==this.props.buttonEnabled?this.props.buttonEnabled:this.state.value||this.state.tokens.length>0},getValue:function(){return this.value.get()},getTokens:function(){var e=this.getValue().trim(),t=this.tokens.get();return e?t.concat([{text:e,email:e,type:"contact"}]):t},getItem:function(){return this.state.item},parseHTML:function(e){var t;if(this.props.parse){var i=h.a.parseText(e,null,null,null,o.a.getCurrentDateFormat(),null,null,s.default.contactManager.getContacts(),!0,!0,this.props.isSearch);this.parsedEls=i.els;var n=e.match(/(^#|[\(\s]#)([^\s\),#]+)/g);n&&(n=n.map(function(e){return e.trim().slice(1)})),this.tags=i.tags=n,this.contacts=i.contacts,this.props.onParsed&&this.props.onParsed(i),t=h.a.generateHTML(i.els,{convertSpaces:!0})}else t=e&&a.default.escape(e).replace(/ /g,"&nbsp;");return t},addDirtyCallback:function(e){this._dirtyCallbacks||(this._dirtyCallbacks=[]),this._dirtyCallbacks.push(e)},focus:function(){this._isDirty?this.addDirtyCallback(this.focus):this.refs.input.focus()},blur:function(){this.refs.input.blur()},select:function(){p.default.selectElement(this.refs.input)},selectEnd:function(e){if(!e&&this._isDirty)this.addDirtyCallback(this.selectEnd);else{var t=this.refs.input.innerText;t.length>0&&t!==TextSpace&&p.default.selectElement(this.refs.input,t.length)}},selectAll:function(e){if(!e&&this._isDirty)this.addDirtyCallback(this.selectAll);else{var t=this.refs.input.innerText;t.length>0&&t!==TextSpace&&p.default.selectElement(this.refs.input,0,t.length)}},handleCut:function(e){var t=this.getSelectionOffsets();if(t.start===t.end){var i=r.a.ie?"Text":"text/plain",n=e&&e.clipboardData?e.clipboardData:window.clipboardData,s=this.getValue();n.setData(i,s),this.clearValue(),this.onInput(),a.default.preventDefault(e),a.default.stopPropagation(e)}},_getHotkeys:function(e){var t=[c.a.create(KeyCode.L,!0,n.a.Primary.No,n.a.Shift.Either,this.selectAll)];return r.a.app&&t.push(c.a.create(KeyCode.L,!0,n.a.Primary.Yes,n.a.Shift.Either,this.selectAll)),e&&t.push(c.a.create(KeyCode.Escape,!0,n.a.Primary.Either,n.a.Shift.Either,this.handleEscapeKey)),t},onFocus:function(e){this.props.autocompleteMode&&f.a.clearDisabled(),this.props.autocompleteOnClick&&this.updateAutocomplete(),a.default.vmMain.activeInput.set(this),this.isFocused.set(!0),this.___hotkeys=c.a.pushStack(this._getHotkeys(!!this.props.onEscape)),this.refs.input.addEventListener("cut",this.handleCut,!0),this.props.onFocus&&this.props.onFocus(e)},onBlur:function(e){a.default.vmMain.activeInput.set(null),this.isFocused.set(!1),this.___hotkeys&&(c.a.popStack(this.___hotkeys),this.___hotkeys=void 0),this.refs.input.removeEventListener("cut",this.handleCut,!0),this.props.onBlur&&this.props.onBlur(e)},getSelectionOffset:function(){return this.getSelectionOffsets().end},getSelectionOffsets:function(){var e=p.default._getSelectionRange(),t={start:0,end:0};return e&&(t=p.default.getSelectOffsetsInElement(this.refs.input,e)),t},_setSelectionOffset:function(e){var t,i;if(e>0){var n=p.default.getOffsetChildElement(this.refs.input,e);t=n.element,i=n.offset}else t=this.refs.input,i=0;var s=p.default.createFakeRange(t,i,t,i);a.default.Assert(s,"Range should be valid when setting selection offset"),s&&p.default.setSelectionRange(s)},setSelectionOffset:function(e){this._setSelectionOffset(e)},updateAutocomplete:function(e){var t=this.props,i=this.refs.input,a=t.autocompleteMode;if(e=e||this.item.get()||t.autocompleteItem,a){var n=p.default.getSelectionInElement(i);n||(n={start:0,end:0}),(t.autocompleteOnClick||n&&n.start===n.end)&&f.a.update({mode:a,canAutocompleItems:t.canAutocompleItems,text:this.value.get(),offset:n?n.start:0,owner:this,item:e,parsedEls:this.parsedEls,positionOffset:t.positionOffset,elementDisplay:t.autocompleteElementDisplay||this.refs.wrapper,elementInput:i,supportSearchItemAutocomplete:t.supportSearchItemAutocomplete,noShow:t.noShowAutocomplete,showNoMatches:t.autocompleteOnClick})}},setValue:function(e,t,i){this._isDirty=!0,a.default.Assert(void 0!==e,"Should not set FancyInput value to undefined"),e=e||"",this.updateHTML(e,t,i),this.value.set(e)},updateHTML:function(e,t,i){var a=i;t&&void 0===a&&(a=this.getSelectionOffset());var n=this.parseHTML(e||TextSpace);n!==this.refs.input.innerHTML&&(this.refs.input.innerHTML=n),t&&(a>e.length&&(a=e.length),this.setSelectionOffset(a))},addToken:function(e){this.tokens.push(e);var t=this.refs.inner;t.scrollWidth>t.clientWidth&&(t.scrollLeft=t.scrollWidth-t.clientWidth)},updateTokens:function(e){for(var t=0,i=a.default.parseTokensFromText(this.value.get()),n="",s=0;s<i.length;++s){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var r=i[s];"contact"===r.type?this.addToken(r):n+=r.text}this.setValue(n,!0)},onChange:function(){this.value.set(this.refs.input.value)},stripBRs:function(e){for(var t=0,i=e.children,a=i.length-1;a>=0;a--){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=i[a];"BR"===n.nodeName?n.remove():n.children.length>0&&this.stripBRs(n)}},onInput:function(){if(!this.isComposing.get()){this.stripBRs(this.refs.input);var e=this.refs.input.textContent.replace(/\u00a0/g," ").replace(new RegExp(TextSpace,"g"),"").replace(/\n/g,"");this.setValue(e,!0),this.updateAutocomplete(),this.props.onChange&&this.props.onChange(e,this.item.get())}},handleEscapeKey:function(){this.props.onEscape?this.props.onEscape():this.isInput||this.select(),this.__hotkeyEscape&&(c.a.popStack(this.handleEscapeKey),this.__hotkeyEscape=void 0)},onMouseDown:function(e){e.stopPropagation(),this.props.onMouseDown&&this.props.onMouseDown(e)},onKeyDown:function(e){var t=this.props;this.isInput||(t.autocompleteMode&&f.a.isShowing()||t.buttonText&&e.keyCode===KeyCode.Enter&&this.onButtonClick(),e.keyCode===KeyCode.Backspace&&(!this.state.value&&this.state.tokens.length>0&&this.removeToken(this.tokens.length()-1),0===this.refs.input.textContent.length&&(this.refs.input.textContent=TextSpace)),e.keyCode===KeyCode.Tab&&f.a.isShowing()&&f.a.hide(),e.keyCode===KeyCode.Enter&&(t.onEnter&&t.onEnter(e),e.preventDefault())),t.onKeyDown&&t.onKeyDown(e)},onKeyUp:function(e){var t=this.props;!this.isInput&&t.autocompleteMode&&(e.keyCode!==KeyCode.LeftArrow&&e.keyCode!==KeyCode.RightArrow||this.updateAutocomplete()),"email"===t.autocompleteMode&&(e.keyCode===KeyCode.Comma?this.updateTokens(!1):e.keyCode===KeyCode.Enter&&this.updateTokens(!0)),e.keyCode===KeyCode.Enter&&this.selectEnd(!0),t.onKeyUp&&t.onKeyUp(e)},onCompositionStart:function(){r.a.android||this.isComposing.set(!0)},onCompositionEnd:function(e){r.a.android||(this.isComposing.set(!1),this.onInput(e))},onAutocompleteSelected:function(e){var t=this.props;e.item&&t.isSearch?t.onAutocompleteSelected(e):(e.item&&this.item.set({item:e.item,text:e.item.getStyledTextAsOneLine()}),void 0!==e.value&&(this.setValue(e.value,!0,e.offset),t.onChange&&t.onChange(e.value,this.item.get())),e.token&&this.addToken(e.token),t.onAutocompleteSelected&&t.onAutocompleteSelected(e))},onButtonClick:function(){var e=this.state;if(this.isButtonEnabled()){if(this.props.onButtonClick)this.props.onButtonClick(e.value,this.onButtonClickCallback)&&this.isLoading.set(!0);f.a.isShowing()&&f.a.hide()}},onButtonClickCallback:function(){this.value.set(""),this.isLoading.set(!1)},removeToken:function(e){var t=this.props,i=this.tokens.get()[e];this.tokens.removeAt(e),t.onChange&&t.onChange(this.getValue(),this.item.get()),t.onTokenRemoved&&t.onTokenRemoved(i)},removeItem:function(){this.item.set(void 0),this.props.onChange&&this.props.onChange(this.getValue(),this.item.get())},render:function(){var e,t,i=this.state,n=this.props,s=n.margin||{},o=n.padding||{};isNaN(o.left)&&(o.left=8),isNaN(o.right)&&(o.right=8);var l=!1!==n.border,u=l?2:0,c=a.default.classNames("fancyInput",{disabled:n.disabled},{focused:i.isFocused},{hasFloatingText:!!n.floatingText},{hasButton:!!n.buttonText},{hasBorder:l},this.props.className),h=n.height||40,f=(h-40)/2,p=a.default.extend({width:n.width,height:h,display:n.display,fontSize:n.fontSize},n.style);if(n.floatingText)o.bottom=5+Math.min(f,2),o.top=h-16-o.bottom;else{var g=(h-u-16)/2;o.top=g,o.bottom=g}if(n.floatingText){var m={marginBottom:5+f,marginLeft:o.left,marginRight:o.right};i.isFocused||i.value?i.isFocused?m.color=a.default.colorBlue:m.color="#ccc":m.color="#aaa";var v=a.default.classNames("placeholder c-foreground-super-faded","noSelect",{floating:i.isFocused||i.value||i.tokens.length>0});e=d.a.createElement("div",{className:v,style:m},n.floatingText)}else if(n.placeholder&&!i.value&&!i.isComposing&&0===i.tokens.length&&!i.item){var _={paddingTop:o.top,marginLeft:o.left,marginRight:o.right};e=d.a.createElement("div",{className:"placeholder c-foreground-super-faded noSelect",style:_},n.placeholder)}var y,S={right:n.buttonText&&50};if(i.isFocused&&!i.item?S[r.a.transform.react]="":S[r.a.transform.react]="scale(0,1)",t=d.a.createElement("div",{className:"focusUnderline",style:S}),n.buttonText){var w=a.default.classNames("fancyInputButton c-button-raised-primary",{loading:i.isLoading},{disabled:!this.isButtonEnabled()}),I={width:n.buttonWidth,lineHeight:h+"px"};y=d.a.createElement("span",{className:w,style:I,onClick:this.onButtonClick},n.buttonText)}var b,A={paddingLeft:o.left,paddingRight:o.right,marginLeft:s.left,marginRight:s.right},D={ref:"input",className:"fancyInputInput",style:{paddingTop:o.top,paddingBottom:o.bottom},onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onMouseDown:this.onMouseDown,autoComplete:"false",tabIndex:n.tabIndex,disabled:i.isLoading};this.isInput?(D.type=n.type,D.onChange=this.onChange,b=d.a.createElement("input",D)):(D.onInput=this.onInput,D.contentEditable=n.readonly||i.item?null:"true",D.onCompositionStart=this.onCompositionStart,D.onCompositionEnd=this.onCompositionEnd,b=d.a.createElement("div",D));var T=[];if(i.tokens)for(var M=0,C=0;C<i.tokens.length;C++){if(M++>5e3&&__infLoop&&__infLoop(M))throw new RangeError;var L=i.tokens[C],P={marginTop:o.top-4,paddingLeft:n.padding&&!isNaN(n.padding.left)?n.padding.left:8};T.push(d.a.createElement("div",{key:"token"+C,className:"token c-button-raised c-border",style:P},d.a.createElement("span",{dangerouslySetInnerHTML:{__html:L.text}}),d.a.createElement("i",{className:"icon-close c-button",onClick:this.removeToken.bind(this,C)})))}if(i.item){var E={lineHeight:h+"px",marginTop:0,paddingLeft:n.padding&&!isNaN(n.padding.left)?n.padding.left:8};T.push(d.a.createElement("div",{key:"tokenItem",className:"token flexbox",style:E},d.a.createElement("span",{className:"f1",dangerouslySetInnerHTML:{__html:i.item.text}}),d.a.createElement("i",{className:"icon-close c-button",onClick:this.removeItem})))}var k=a.default.classNames("fancyInputWrap c-foreground c-background c-border",{hasTokens:T.length>0},{hasItem:i.item});return d.a.createElement("div",{className:c,id:this.props.id,style:p,onClick:this.props.onClick},d.a.createElement("div",{className:"fancyInputContent"},d.a.createElement("div",{className:k,ref:"wrapper"},e,d.a.createElement("div",{className:"fancyInputInner",style:A,ref:"inner"},T,d.a.createElement("div",{className:"fancyInputInner2"},b))),y,t))}});t.a=g},function(e,t,i){"use strict";var a=i(0),n=i(5),s=i(8);function r(e,t,i){var s=0;this._destroyed=!1,n.a.forceBind("onChanged",this);for(var r=0;r<e.length;r++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;e[r].listen(this.onChanged)}this._observables=e,t&&a.default.isFunction(t)?this.checkFn=t:this.checkFn="or"===t?this.checkFnOr:this.checkFnAnd;var o=this.checkFn();this._super.constructor.call(this,o,i)}var o={checkFnOr:function(){for(var e=0,t=!1,i=0;!t&&i<this._observables.length;i++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;t=t||this._observables[i].get()}return t},checkFnAnd:function(){for(var e=0,t=!0,i=0;t&&i<this._observables.length;i++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;t=t&&this._observables[i].get()}return t},onChanged:function(e,t,i){var a=this._value,n=this.checkFn();(n!==a||i)&&this._super.set.call(this,n,i)},destroy:function(){var e=0;this._destroyed=!0;for(var t=0;t<this._observables.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;this._observables[t].unlisten(this.onChanged)}}};n.a.inherit(s.a,r),n.a.extend(r.prototype,o),t.a=r},function(e,t,i){"use strict";var a=i(0),n=i(5),s=i(6);function r(e,t,i){this._id=e,this._name=t,this._isOpen=!1,this._isReady=!1,this._isAllLoaded=!1,this._storageError=!1,this._loggingEnabled=!1,this._preloadConsumed=!1,this._usesDiskSpace||(this._usesDiskSpace=!1),this._onReadyFns=[],this._onMetadataReadyFns=[],this._cache={},this._metadata={},this._useInMemoryStore=!i||!i.noInMemoryCache,this._useMetadataInMemoryStore=!i||!i.noMetadataInMemoryCache,this._isPerDoc=i&&i.isPerDoc,this.open()}var o={getStats:function(e){this.getFilterEntries(function(){return!0},function(t){var i={id:this._id,count:t.length,size:JSON.stringify(t).length};e(i)}.bind(this))},getState:function(){return{isOpen:this._isOpen,isReady:this._isReady,isAllLoaded:this._isAllLoaded,storageError:this._storageError}},enableLogging:function(){this._loggingEnabled=!0},disableLogging:function(){this._loggingEnabled=!1},isLoggingEnabled:function(){return this._loggingEnabled},usesDiskSpace:function(){return this._usesDiskSpace},_cacheInMemory:function(){return this._useInMemoryStore},_cacheMetadataInMemory:function(){return this._useMetadataInMemoryStore},_hasLoadedAll:function(){return this._isAllLoaded},isPerDoc:function(){return this._isPerDoc},getStorageType:function(){a.default.Assert(!1,"SubClass must override")},open:function(){this._isOpen=!0},close:function(){this._isOpen=!1,this._isReady=!1},isOpen:function(){return this._isOpen},isReady:function(){return this._isOpen&&this._isReady},requestPreloadData:function(e){var t=this._preloadConsumed;this._preloadConsumed=!0;var i=window.__preload;if(!(!t&&i&&i.cachePreloads&&i.cachePreloads.indexOf(this._id)>=0))return e(void 0);if(i.cacheResults[this._id]){a.default.Assert(!i.cacheCallbacks[this._id],"Should never have active callbacks and results");var n=i.cacheResults[this._id];return delete i.cacheResults[this._id],i.cachePreloads.remove(this._id),e(n)}i.cacheCallbacks[this._id]||(i.cacheCallbacks[this._id]=[]),i.cacheCallbacks[this._id].push(e)},isMetadataReady:function(){return this._isOpen&&this._isMetadataReady},notifyCacheReady:function(e){if(e){var t=0;this._storageError=!1,this._isReady=!0;for(var i=0;i<this._onReadyFns.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this._onReadyFns[i]()}this._onReadyFns=[]}else this._storageError=!0,this._isReady=!1},notifyCacheMetadataReady:function(e){if(e){var t=0;this._isMetadataReady=!0;for(var i=0;i<this._onMetadataReadyFns.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this._onMetadataReadyFns[i]()}this._onMetadataReadyFns=[]}else this._isMetadataReady=!1},onCacheReady:function(e){a.default.Assert(e,"Must provide a valid cb"),this._isReady?setTimeout(e,0):(a.default.Assert(this._onReadyFns.indexOf(e)<0,"Must not double register a cache ready fn"),this._onReadyFns.push(e))},onCacheMetadataReady:function(e){a.default.Assert(e,"Must provide a valid cb"),this._isMetadataReady?setTimeout(e,0):(a.default.Assert(this._onMetadataReadyFns.indexOf(e)<0,"Must not double register a cache metadata ready fn"),this._onMetadataReadyFns.push(e))},setMetadata:function(e,t,i){a.default.Assert(!i,"In memory query is sync"),this._cacheMetadataInMemory()&&(this._metadata[e]=t)},removeMetadata:function(e,t){a.default.Assert(!t,"In memory query is sync"),this._cacheMetadataInMemory()&&delete this._metadata[e]},getMetadata:function(e,t){return a.default.Assert(!t,"In memory query is sync"),this._cacheMetadataInMemory()?this._metadata[e]:void 0},_setRawInMemoryMetadata:function(e){a.default.Assert(this._cacheMetadataInMemory(),"Must be running an in-memory cache"),this._metadata=e},_getRawInMemoryMetadata:function(){return this._cacheMetadataInMemory()?this._metadata:void 0},_setRawInMemoryCache:function(e){a.default.Assert(this._cacheInMemory(),"Must be running an in-memory cache"),this._cache=e},_getRawInMemoryCache:function(){return this._cacheInMemory()?this._cache:void 0},count:function(e){return a.default.Assert(!e,"In memory query is sync"),this._cacheInMemory()?Object.keys(this._cache).length:void 0},size:function(e){return a.default.Assert(!e,"In memory query is sync"),this._cacheInMemory()?2*JSON.stringify(this._cache).length:void 0},loadAll:function(e){a.default.Assert(!e,"In memory query is sync"),this._isAllLoaded=!0},getEntrySync:function(e){return this._cacheInMemory()?this._cache[e]:void 0},getEntry:function(e,t){return a.default.Assert(!t,"In memory query is sync"),this._cacheInMemory()?this._cache[e]:void 0},getBoundEntries:function(e,t,i,n){var s;if(a.default.Assert(!n,"In memory query is sync"),this._cacheInMemory())for(var r in s=[],this._cache)this._cache[r][e]>=t&&this._cache[r][e]<=i&&s.push(this._cache[r]);return s},getFilterEntries:function(e,t){var i;if(a.default.Assert(!t,"In memory query is sync"),this._cacheInMemory())for(var n in i=[],this._cache)e(this._cache[n])&&i.push(this._cache[n]);return i},removeEntry:function(e,t){a.default.Assert(!t,"In memory query is sync"),this._cacheInMemory()&&delete this._cache[e]},hasEntry:function(e,t){return a.default.Assert(!t,"In memory query is sync"),!!this._cacheInMemory()&&this._cache.hasOwnProperty(e)},cacheEntry:function(e,t,i){a.default.Assert(!i,"In memory query is sync"),this.isLoggingEnabled()&&log("Cache Entry: ",e,t),this._cacheInMemory()&&t&&(this._cache[e]=t)},clearCache:function(e){a.default.Assert(!e,"In memory query is sync"),this._cache={}},clearMetadata:function(e){a.default.Assert(!e,"In memory query is sync"),this._metadata={}},clearBackingStore:function(e){a.default.Assert(!1,"SubClass must override")},dumpData:function(e){console.log("-- Cache: ",this._id,"--"),console.log(this._cache)},onCacheError:function(e){a.default.reportError(e)}};n.a.defineBase(r),n.a.extend(r.prototype,o);var l=r;function d(e,t,i){i&&(a.default.Assert(!i.noInMemoryCache,"Invalid in-memory cache option"),a.default.Assert(!i.noMetadataInMemoryCache,"Invalid metadata in-memory cache option"),i.noInMemoryCache=!1,i.noMetadataInMemoryCache=!1),this._super.constructor.call(this,e,t,i),this._db=void 0}var u={getStorageType:function(){return StorageType.InMemory},setMetadata:function(e,t,i){this._super.setMetadata.call(this,e,t),i&&i(!0)},removeMetadata:function(e,t){this._super.removeMetadata.call(this,e),t&&t(!0)},getMetadata:function(e,t){var i=this._super.getMetadata.call(this,e)||void 0;t&&t(i)},count:function(e){a.default.Assert(e,"Must provide a valid callback");var t=this._super.count.call(this);e&&e(t)},size:function(e){a.default.Assert(e,"Must provide a valid callback");var t=this._super.size.call(this);e&&e(t)},loadAll:function(e){this._super.loadAll.call(this),e&&e(!0)},getEntrySync:function(e){return a.default.Assert(e,"Must provide a valid ID to get"),this._super.getEntrySync.call(this,e)||void 0},getEntry:function(e,t){a.default.Assert(e,"Must provide a valid ID to get"),a.default.Assert(t,"Must provide a valid entry callback");var i=this._super.getEntry.call(this,e)||void 0;t&&t(i,e)},getBoundEntries:function(e,t,i,n){a.default.Assert(e,"Must specify a valid index"),a.default.Assert(n,"Must provide a valid entry callback");var s=this._super.getBoundEntries.call(this,e,t,i)||[];n&&n(s)},getFilterEntries:function(e,t){a.default.Assert(a.default.isFunction(e),"Must specify a valid filter function"),a.default.Assert(t,"Must provide a valid entry callback");var i=this._super.getFilterEntries.call(this,e)||[];t&&t(i)},removeEntry:function(e,t){a.default.Assert(e,"Must provide valid data id"),this._super.removeEntry.call(this,e),t&&t(!0)},hasEntry:function(e,t){var i=this._super.hasEntry.call(this,e);t&&t(i)},cacheEntry:function(e,t,i){a.default.Assert(e,"Must provide valid data id"),this._super.cacheEntry.call(this,e,t),i&&i(!0)},clearCache:function(e){this._super.clearCache.call(this),e&&e(!0)},clearMetadata:function(e){this._super.clearMetadata.call(this),e&&e(!0)},clearBackingStore:function(e){e&&e(!0)}};n.a.inherit(l,d),n.a.extend(d.prototype,u);var c=d;function h(e,t,i){this._usesDiskSpace=!0,this._db=void 0,this._cacheTable=void 0,this._metadataTable=void 0,this._version=2,this._schema=this._getDefaultSchema(),this._super.constructor.call(this,e,t,i)}var f={_makeID:function(e){return e},validID:function(e){return!0},_metadataID:function(e){return e},getStorageType:function(){return StorageType.IndexedDB},_migrateEntry:function(e,t,i){delete e.cid,this._cacheTable.update(e).done(t).fail(i)},_migrateMetadata:function(e,t,i){delete e.cid,this._super.setMetadata.call(this,e.id,e.value),this._metadataTable.update(e).done(t).fail(i)},_runMigration:function(e){s.default.onCachesAvailable(function(){var t=s.default.openCacheTable(this._id);t.query().bound(this._id,this._id+"￿").execute().done(function(i){var a=0,n=!1,r=0,o=0,l=0,d=this._id;function u(){n&&r+o===l&&(log("Migration Completed: ",r,o,l,n),s.default.closeCacheTable(d),e(!0))}function c(){r++,u()}function h(e){o++,u()}for(var f=0;i&&f<i.length;++f){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;t.remove(i[f].cid),this._migrateEntry(i[f],c,h),l++}t.query().bound("Meta_Moo_","Meta_Moo_￿").execute().done(function(e){for(var i=0,a=0;e&&a<e.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;e[a].cid.endsWith(this._id)&&(t.remove(e[a].cid),this._migrateMetadata(e[a],c,h),l++)}n=!0,u()}.bind(this))}.bind(this))}.bind(this))},open:function(){this._super.open.call(this),s.default.openCacheDatabase(this._id,this._version,this._schema,function(e){a.default.Assert(!this._db,"Should not open the cache DB twice"),e&&(this._db=e,this._cacheTable=e.cache,this._metadataTable=e.metadata),a.default.vmMain.cacheManager.needsMigration()?this._runMigration(function(t){log("Cache data migrated: ",this._id),this.notifyCacheMetadataReady(!!e),this.notifyCacheReady(!!e)}.bind(this)):(this.notifyCacheMetadataReady(!!e),this.notifyCacheReady(!!e))}.bind(this))},close:function(){this._super.close.call(this),this._db.close(),this._db=void 0,this._cacheTable=void 0,this._metadataTable=void 0},isReady:function(){return this._super.isReady.call(this)&&this._db&&this._cacheTable},isMetadataReady:function(){return this._super.isReady.call(this)&&this._db&&this._metadataTable},notifyCacheReady:function(e){this._super.notifyCacheReady.call(this,e)},notifyCacheMetadataReady:function(e){this._super.notifyCacheMetadataReady.call(this,e)},setMetadata:function(e,t,i){if(this._super.setMetadata.call(this,e,t),this.isMetadataReady()){var a={id:e,value:t};try{this._metadataTable.update(a).done(function(){i&&i(!0)}).fail(function(e,t){this.onCacheError(t),i&&i(!1)}.bind(this))}catch(e){this.onTransactionError(e),i&&i(!1)}}else i&&i(!1)},removeMetadata:function(e,t){if(this._super.removeMetadata.call(this,e),this.isMetadataReady())try{this._metadataTable.remove(this._metadataID(e)).done(function(){t&&t(!0)}).fail(function(e){log("IDB removeMetadata Error: ",e),t&&t(!1)})}catch(e){this.onTransactionError(e),t&&t(!1)}else t&&t(!1)},getMetadata:function(e,t){var i=this._super.getMetadata.call(this,e);if(i)t(i);else if(this.isMetadataReady())try{this._metadataTable.query().only(this._metadataID(e)).limit(1).execute().done(function(e){var i;a.default.Assert(!e||0===e.length||1===e.length&&e[0],"Mismatch in metadata value"),e&&1===e.length&&e[0]&&(i=e[0].value),t(i)}).fail(function(e){log("IDB getMetadata Error: ",e),t(void 0)})}catch(e){this.onTransactionError(e),t(void 0)}else t(void 0)},count:function(e){if(this.isReady())try{this._cacheTable.query().all().count().execute().done(function(t){e(t)}).fail(function(t){e()})}catch(t){this.onTransactionError(t),e()}else e()},size:function(e){if(this.isReady())try{this._cacheTable.query().all().execute().done(function(t){for(var i=0,a=0,n=0;n<t.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;a+=this._entrySize(t[n])}e(a)}).fail(function(t){e()})}catch(t){this.onTransactionError(t),e()}else e()},loadAll:function(e){if(this.isReady())try{this._cacheTable.query().all().execute().done(function(t){for(var i=0,a=0;a<t.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;this._super.cacheEntry.call(this,t[a].id,t[a])}this._super.loadAll.call(this),e(!0,t)}.bind(this)).fail(function(t){log("IDB loadAll Error: ",t),this._super.loadAll.call(this),e(!1)})}catch(t){this.onTransactionError(t),e(!1)}else e(!1)},getEntrySync:function(e){a.default.Assert(!1,"Sync access to IDB is not supported")},getEntry:function(e,t){a.default.Assert(e,"Must provide a valid ID to get"),a.default.Assert(t,"Must provide a valid entry callback");var i=this._super.getEntry.call(this,e);if(i)t(i);else if(this.isReady())try{this._cacheTable.query().only(this._makeID(e)).limit(1).execute().done(function(i){var a;i&&1===i.length&&(a=i[0],this._super.cacheEntry.call(this,e,a)),t(a,e)}.bind(this)).fail(function(e){log("IDB getEntry Error: ",e),t(void 0)})}catch(e){this.onTransactionError(e),t(void 0)}else t(void 0)},getBoundEntries:function(e,t,i,n){if(a.default.Assert(e,"Must specify a valid index to query"),a.default.Assert(n,"Must provide a valid entry callback"),this.isReady())try{this._cacheTable.query().filter(function(a){return a[e]>=t&&a[e]<=i}).execute().done(function(e){n(e,!0)}.bind(this)).fail(function(e){n([],!1)}.bind(this))}catch(e){this.onTransactionError(e),n([],!1)}else n([],!1)},getFilterEntries:function(e,t){if(a.default.Assert(a.default.isFunction(e),"Must specify a valid filter function"),a.default.Assert(t,"Must provide a valid entry callback"),this.isReady())try{this._cacheTable.query().filter(e).execute().done(function(e){t(e,!0)}.bind(this)).fail(function(e){t([],!1)}.bind(this))}catch(e){this.onTransactionError(e),t(!1)}else t([],!1)},removeEntry:function(e,t){if(a.default.Assert(e,"Must provide valid data id"),this._super.removeEntry.call(this,e),this.isReady())try{this._cacheTable.remove(this._makeID(e)).done(function(){t&&t(!0)}).fail(function(e){log("IDB removeEntry Error: ",e),t&&t(!1)})}catch(e){this.onTransactionError(e),t&&t(!1)}else t&&t(!1)},hasEntry:function(e,t){if(this._super.hasEntry.call(this,e))t(!0);else if(this.isReady())try{this._cacheTable.query().only(this._makeID(e)).limit(1).execute().done(function(i){var a;i&&1===i.length&&(a=i[0],this._super.cacheEntry.call(this,e,a)),t(!!a)}.bind(this)).fail(function(e){log("IDB hasEntry Error: ",e),t(!1)})}catch(e){this.onTransactionError(e),t(!1)}else t(!1)},_entrySize:function(e){var t=0;try{t=2*JSON.stringify(e).length}catch(e){a.default.reportError(e)}return t},cacheEntry:function(e,t,i){if(a.default.Assert(e,"Must provide valid data id"),a.default.Assert(t.id,"Data must also contain a valid item id"),this._super.cacheEntry.call(this,e,t),this.isReady())try{this._cacheTable.update(t).done(function(){if(i)try{i(!0)}catch(e){a.default.reportError(e)}}).fail(function(e,t){this.onCacheError(t),i&&i(!1)}.bind(this))}catch(e){this.onTransactionError(e),i&&i(!1)}else i&&i(!1)},clearCache:function(e){if(this._super.clearCache.call(this),this.isReady())try{this._cacheTable.clear().done(function(){e&&e(!0)}).fail(function(t){log("IDB clearcache Error: ",t),e&&e(!1)})}catch(t){this.onTransactionError(t),e&&e(!1)}else e&&e(!1)},clearMetadata:function(e){if(this._super.clearMetadata.call(this),this.isReady())try{this._metadataTable.clear().done(function(){e&&e(!0)}.bind(this)).fail(function(t){log("IDB clearMetadata Error: ",t),e&&e(!1)})}catch(t){this.onTransactionError(t),e&&e(!1)}else e&&e(!1)},dumpData:function(e){e?this._super.dumpData.call(this,e):(console.log("-- Cache: ",this._id,"--"),this.isReady()?this._cacheTable.query().all().execute().done(function(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;console.log(e[i])}}).fail(function(e){console.log("Error running IDB query: ",e)}):console.log("Cache not ready"))},_getDefaultSchema:function(){return{cache:{key:{keyPath:"id"}},metadata:{key:{keyPath:"id"}}}},onTransactionError:function(e){s.default.notifyDBUnexpectedClose(!1)},onCacheError:function(e){if(e&&e.target)try{var t=e.target.error;t?"QuotaExceededError"===t.name||4===t.code?a.default.vmMain.cacheManager.hasReportedQuotaError()||(a.default.vmMain.cacheManager.reportQuotaExceeded(),a.default.vmMain.pluginManager.onCacheLimitExceeded()):"InvalidStateError"===t.name?s.default.notifyDBUnexpectedClose(!1):a.default.reportError(new Error("IDB Cache Transaction Error"),e):a.default.reportError(new Error("IDB Cache Transaction Error [No Target Error]"),e)}catch(e){a.default.reportError(e)}}};n.a.inherit(l,h),n.a.extend(h.prototype,f);var p=h,g=i(13),m=5e3;function v(e,t,i){i?(a.default.Assert(!i.noInMemoryCache,"Invalid in-memory cache option"),a.default.Assert(!i.noMetadataInMemoryCache,"Invalid metadata in-memory cache option"),i.noInMemoryCache=!1,i.noMetadataInMemoryCache=!1,this.saveTime=isNaN(i.saveTime)?m:i.saveTime,i.writeOnUnload&&g.a.listen("onUnload",this.writeCache.bind(this)),i.clearBackingOnLoad&&(this.clearBackingOnLoad=!0,g.a.listen("enterForeground",this.clearBackingStore.bind(this)))):this.saveTime=m,this._super.constructor.call(this,e,t,i),this._saveTimeout=void 0,n.a.forceBind("writeCache",this)}var _={_localStorageKey:function(){return"MDC_"+this._id},_onWrite:function(e){e||0===this.saveTime?(this._saveTimeout&&(clearTimeout(this._saveTimeout),this._saveTimeout=void 0),this.writeCache()):this.saveTime>=0&&(this._saveTimeout&&clearTimeout(this._saveTimeout),this._saveTimeout=setTimeout(this.writeCache,this.saveTime))},writeCache:function(){performance.now();var e,t={metadata:this._getRawInMemoryMetadata(),cache:this._getRawInMemoryCache()};try{e=JSON.stringify(t),n.a.storage.setItem(this._localStorageKey(),e)}catch(e){a.default.reportError(e)}},close:function(){this._onWrite(!0),this._super.close.call(this)},getStorageType:function(){return StorageType.LocalStorage},setMetadata:function(e,t,i){this._super.setMetadata.call(this,e,t),this._onWrite(),i&&i(!0)},getMetadata:function(e,t){var i=this._super.getMetadata.call(this,e)||void 0;t&&t(i)},count:function(e){a.default.Assert(e,"Must provide a valid callback");var t=this._super.count.call(this);e&&e(t)},size:function(e){a.default.Assert(e,"Must provide a valid callback");var t=this._super.size.call(this);e&&e(t)},loadAll:function(e){try{var t=n.a.storage.getItem(this._localStorageKey());if(t){var i=JSON.parse(t);this._setRawInMemoryMetadata(i.metadata),this._setRawInMemoryCache(i.cache)}this._super.loadAll.call(this),this.clearBackingOnLoad&&this.clearBackingStore(),e&&e(!0)}catch(t){a.default.reportError(t),this._super.loadAll.call(this),e&&e(!1)}},getEntrySync:function(e){return a.default.Assert(e,"Must provide a valid ID to get"),this._super.getEntrySync.call(this,e)||void 0},getEntry:function(e,t){a.default.Assert(e,"Must provide a valid ID to get"),a.default.Assert(t,"Must provide a valid entry callback");var i=this._super.getEntry.call(this,e)||void 0;t&&t(i,e)},getBoundEntries:function(e,t,i,a){var n=this._super.getBoundEntries.call(this,e,t,i);a&&a(n)},getFilterEntries:function(e,t){var i=this._super.getFilterEntries.call(this,e);t&&t(i)},removeEntry:function(e,t){a.default.Assert(e,"Must provide valid data id"),this._super.removeEntry.call(this,e),this._onWrite(),t&&t(!0)},hasEntry:function(e,t){var i=this._super.hasEntry.call(this,e);t&&t(i)},cacheEntry:function(e,t,i){a.default.Assert(e,"Must provide valid data id"),this._super.cacheEntry.call(this,e,t),this._onWrite(),i&&i(!0)},clearCache:function(e){this._super.clearCache.call(this),this._onWrite(!0),e&&e(!0)},clearMetadata:function(e){this._super.clearMetadata.call(this),this._onWrite(),e&&e(!0)},clearBackingStore:function(e){n.a.storage.removeItem(this._localStorageKey()),e&&e(!0)}};n.a.inherit(l,v),n.a.extend(v.prototype,_);var y=v,S=function(){this._reportedQuotaError=!1,this._migrationRequired=!1,this._registeredCaches={},this._storageReady=[],this.init()};S.prototype={init:function(){this._storageReady[StorageType.InMemory]=!0,this._storageReady[StorageType.LocalStorage]=!0},getInfo:function(){return{reportedQuotaError:this._reportedQuotaError,migrationRequired:this._migrationRequired,numCaches:Object.keys(this._registeredCaches).length}},registerLocalCache:function(e,t,i,n){a.default.Assert(e,"Must provide a valid cache ID"),a.default.Assert(t,"Must have a valid cache name");var s,r=this._createCacheId(e,t);switch(a.default.Assert(void 0===this._registeredCaches[r],"Must not have a previously registered cache with the same id"),a.default.shouldWriteLocal()||(i=StorageType.InMemory,n&&(n.noInMemoryCache=!1,n.noMetadataInMemoryCache=!1)),i){case StorageType.InMemory:s=new c(r,t,n);break;case StorageType.LocalStorage:s=new y(r,t,n);break;case StorageType.IndexedDB:s=new p(r,t,n)}return a.default.Assert(s,"Must have valid cache after creation"),this._registeredCaches[e]=s,this._storageReady[i]&&(s.notifyCacheMetadataReady(!0),s.notifyCacheReady(!0)),s},clearLocalCache:function(e,t){var i=this._registeredCaches[e];a.default.Assert(i,"Must have valid local cache"),i.clearCache(),t&&i.clearMetadata()},clearLocalCaches:function(e){for(var t in this._registeredCaches)this.clearLocalCache(t,e)},clearPerDocCaches:function(e){for(var t in this._registeredCaches){this._registeredCaches[t].isPerDoc()&&this.clearLocalCache(t,e)}},_notifyIDBReady:function(e){},_createCacheId:function(e,t){return e},notifyMigrationRequired:function(){this._migrationRequired=!0},needsMigration:function(){return this._migrationRequired||5===a.default.settings.get(Settings.localDataVersion)},hasReportedQuotaError:function(){return this._reportedQuotaError},reportQuotaExceeded:function(){this._reportedQuotaError||(this._reportedQuotaError=!0,a.default.reportError(new Error("Quota exceeded!")))}};t.a=new S},function(e,t,i){"use strict";var a=i(0);function n(e){for(var t in a.default.Assert(e.id&&e.type&&e.sizeInPane,"Pane object missing properties"),e)e.hasOwnProperty(t)&&(this[t]=e[t])}n.prototype={},t.a=n},,function(e,t,i){"use strict";var a=i(0),n=i(6),s=i(1),r=i(2),o=i.n(r),l=i(12),d=i(20),u=i(15),c=i(27),h=i(43),f=l.a.createClass({displayName:"ReactItem",componentDisplay:s.a.ComponentDisplay.Everywhere,init:function(){var e=this.props,t=e.item;e.renderLikePane&&!isNaN(e.paneObject.index)&&(this.styleProps=t.styleProps(e.paneObject,e.pane),this.metrics=t.metricsInPane(e.pane,e.paneObject.index))},componentDidMount:function(){var e=this.props,t=e.item;this.listenTo(t.itemChanged),a.default.Assert(e.pane||!e.renderLikePane&&!e.padded,"Should not use these props if no pane"),this.props.editable&&(this._needsSelect=isNaN(e.selectIndex)?t.getParsedText().length:e.selectIndex,u.default.selectElement(this.getElement(),this._needsSelect))},getElement:function(){return this.refs.element.getElement()},getState:function(){var e=this.props,t=e.pane,i=e.item,n={flags:i.flags,renderLikePane:e.renderLikePane&&!isNaN(e.paneObject.index),styleProps:this.styleProps,priorityProps:e.showPriority&&i.getPriorityProps(),isComplete:i.isComplete(),hasPrefix:i.hasPrefix()};return e.allowDrag&&(n.draggedInPane=i.draggedInPane,n.isBeingDragged=i.draggedInPane.get()===t||t===a.default.focusedPane&&a.default.vmMain.dropBucket.hasItemEntry(i)),n.renderLikePane?(n.metrics=this.metrics,n.lines=n.metrics.styledLines):n.lines=[i.getStyledTextAsOneLine()],n},focus:function(){var e=this.props.item.getParsedText().length;u.default.selectElement(this.getElement(),e)},onKeyDown:function(e){var t=this.props,i=t.item;e.keyCode===KeyCode.Backspace&&this.state.hasPrefix&&""===i.getParsedTextWithoutPrefix()&&i.setText("",!0,!1!==t.shouldSave?ChangeType.Local:ChangeType.Auto),t.onKeyDown&&t.onKeyDown(e)},onKeyPress:function(e){var t=this.props;if(t.onKeyPress&&(t.onKeyPress(e),!e.defaultPrevented)){var i=this.props.item,a=u.default._getSelectionRange(),n=u.default.getSelectOffsetsInElement(e.target,a);if(this._needsSelect=void 0,n.start!==n.end){var s=i.getParsedText(),r=s.substr(0,n.start)+s.substr(n.end);i.setText(r,!0,!1!==t.shouldSave?ChangeType.Local:ChangeType.Auto),this._needsSelect=n.start}}},componentDidUpdate:function(){if(!isNaN(this._needsSelect)){var e=this.getElement(),t=e.innerHTML;(t.indexOf("<br")>=0||t.indexOf("></span>")>0||""===t)&&(e.innerHTML=this.getRenderedHtml()),u.default.selectElement(e,Math.min(e.textContent.length,this._needsSelect)),this._needsSelect=void 0}},convertElementToText:function(e){var t="";if(e.nodeType===Node.TEXT_NODE)t+=e.nodeValue;else if(e.classList.contains("plugin"))t+=s.a.AttachChar;else for(var i=0,a=0;a<e.childNodes.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;t+=this.convertElementToText(e.childNodes[a])}return t},stopResizing:function(){this.isResizing=!1},onInput:function(e){e.target.innerHTML.indexOf("<br")>=0&&(e.target.innerHTML=e.target.innerHTML.replace("<br/>","").replace("<br>",""));var t=this.props.item,i=this.convertElementToText(e.target).replace(new RegExp(TextSpace,"g"),""),a=u.default._getSelectionRange();if(a){var n=u.default.getSelectOffsetsInElement(e.target,a);this._needsSelect=n.start}t.setText(i,!0,ChangeType.Local),this.updateAutocomplete(),e.preventDefault()},updateAutocomplete:function(){var e=this.getElement(),t=this.props.autocompleteMode;if(t&&("snooze"===t||"move"===t||"email"===t||"gmailLabel"===t||"item"===t)){var i=u.default.getSelectionInElement(e);i||(i={start:0,end:0}),i&&i.start===i.end&&c.a.update({mode:t,text:this.convertElementToText(e).replace(new RegExp(TextSpace,"g"),""),offset:i.start,owner:this,parsedEls:this.parsedEls,positionOffset:this.props.positionOffset,elementDisplay:e,elementInput:e,supportSearchItemAutocomplete:this.props.supportSearchItemAutocomplete})}},onAutocompleteSelected:function(e){void 0!==e.value&&(this.props.item.setText(e.value,!0,ChangeType.Local),u.default.selectElement(this.getElement(),e.offset),setTimeout(function(){u.default.selectElement(this.getElement(),e.offset)}.bind(this),0))},onClick:function(e){if(!this.isResizing){var t=this.props;if(a.default.menus.isContextMenuOpen("ReactContextMenuContactDetails")&&a.default.menus.closeContextMenu("ReactContextMenuContactDetails"),t.editOnClick)e.preventDefault(),e.stopPropagation(),a.default.menus.isContextMenuOpen()&&a.default.menus.closeContextMenu(),a.default.menus.openContextMenu({componentName:"ReactItemDetailsPopup",element:e.target,item:t.item,pane:t.pane});else{var i=!0;if((t.editable||t.inItemDetails)&&t.pane&&(i=!a.default.vmMain.pluginManager.handleTapClick(t.item,t.pane,e)),i&&!t.inItemDetails&&a.default.hasClass(e.target,"contact")){var r=e.target.textContent,o=n.default.contactManager.findMatchExact(r[0]===s.a.ContactPrefix?r.substr(1):r);o&&a.default.menus.openContextMenu({componentName:"ReactContextMenuContactDetails",position:"bottom",element:e.target,contact:o})}}}},onMouseDown:function(e){},onMouseMove:function(e){!this.isResizing&&this.props.allowDrag&&this.props.item.checkDragOnMove(e,!1)},onMouseUp:function(e){!this.isResizing&&this.props.allowDrag&&this.props.item.checkDragOnEnd(e)},onRightClick:function(e){var t=this.props;t.pane&&!1!==t.allowDrag&&(a.default.menus.openContextMenu({componentName:"ReactContextMenuItem",key:"contextMenuItem"+this.props.item.id,element:e.target,item:this.props.item,pane:this.props.pane,pos:{left:e.clientX,top:e.clientY}}),e.preventDefault(),e.stopPropagation())},getRenderedHtml:function(){for(var e,t=0,i=this.props,a=i.paneObject,n=this.props.item,s=this.state.lines,r="",o=0;o<s.length;++o){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;e=i.renderLikePane?"padding-top: "+(0===o?d.a.paddingForItemTop(a,n)+"px":0)+"; padding-bottom: "+(o===s.length-1?(i.noNotes?d.a.paddingForItemTop(a,n):d.a.paddingForItemBottom(a,n))+"px":0)+";":"padding-top: 2px; padding-bottom: 2px",r+='<span class="line'+(o===s.length-1?" last":"")+'" style="'+e+'">'+(s[o]||TextSpace)+"</span>"}return r},render:function(){var e=this.props,t=e.item,i=this.state,n=(i.lines,e.editable&&a.default.vmMain.pluginManager.allowTextEditing(t)),s=a.default.classNames("item itemNotInPane",e.className,i.styleProps,i.priorityProps,e.coloredInCalendar&&"colored",{hasPrefix:i.hasPrefix},{"itemBeingDragged c-bg-light":i.isBeingDragged},{autoSelect:n},{complete:i.isComplete},{"c-bg-dark":i.isComplete&&e.coloredInCalendar}),r={};i.renderLikePane&&e.padding&&(r.paddingLeft=e.padding);var l=this.getRenderedHtml();if(e.style&&(r=a.default.extend(e.style,r)),e.coloredInCalendar&&!i.isBeingDragged){i.isComplete||(r.backgroundColor=t.getCalendarColor());var d=t.getCalendarDisplayProps();if(d)for(var u in d.style)d.hasOwnProperty(u)&&(a.default.Assert(!r[u],"Calendar display prop overwriting default styling"),r[u]=d.style[u])}return o.a.createElement(h.a,{"data-moo-id":this.getUniqueID(),style:r,className:s,contentEditable:n,onClick:e.editOnClick||n||e.inItemDetails?this.onClick:void 0,onKeyDown:n?this.onKeyDown:void 0,onKeyPress:n?this.onKeyPress:void 0,onInput:n?this.onInput:void 0,onMouseDown:void 0,onMouseMove:void 0,onMouseUp:void 0,onContextMenu:void 0,tabIndex:e.tabIndex,dangerouslySetInnerHTML:{__html:l},ref:"element"})}});t.a=f},function(e,t,i){"use strict";var a=i(0),n=i(6),s=i(1),r=i(7),o=i(19),l=i(39);function d(){}d.prototype={_setSectionValue:function(e,t,i){e.hasOwnProperty(t)||(e[t]=i)},_parseSection:function(e,t){for(var i=0,n={},s=t;s<e.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=e[s];if(r){var o=r.indexOf(":"),l=[r.substr(0,o),r.substr(o+1)],d=l[0].split(";");switch(d[0]){case"BEGIN":var u=this._parseSection(e,s+1);s+=u.size,n[l[1]]=u.section;break;case"END":return{section:n,size:s-t+1};default:if(d.length>1){for(var c=0,h={value:l[1]},f=1;f<d.length;++f){if(c++>5e3&&__infLoop&&__infLoop(c))throw new RangeError;var p=d[f].split("=");a.default.Assert(!h.hasOwnProperty(p[0]),"Should never overwrite line values"),h[p[0]]=p[1]}this._setSectionValue(n,d[0],h)}else this._setSectionValue(n,d[0],l[1]);break;case void 0:case null:a.default.Assert(!1,"Invalid ICS format: "+r)}}}return n},parseICS:function(e){for(var t=0,i=e.split("\n"),a=[],n=0;n<i.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=i[n];s.startsWith(" ")?a[a.length-1]+=s.trim():a.push(s.trim())}return this._parseSection(a,0)},parseHead:function(e){for(var t=0,i={},a=0;a<e.childElementCount;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e.children[a],s=n.nodeName;if(n.firstChild){var r=n.firstChild.textContent;i[s]=r}}return i},parseOPML:function(e,t){var i,s=function(e,r){var o,l=!0;switch(e.nodeName){case"#document":case"body":case"opml":break;case"head":l=!1;var d=this.parseHead(e);d&&d.title&&!i&&(i=n.default.createVMLI({text:d.title},{parent:n.default.getRootModel(),changeType:ChangeType.AllLocal}),n.default.getRootModel().insertItem(i));break;case"outline":r||(i?r=i:(r=i=n.default.createVMLI({text:t},{parent:n.default.getRootModel(),changeType:ChangeType.AllLocal}),n.default.getRootModel().insertItem(i)));var u=e.attributes.text,c=u?u.value:"",h=e.attributes.complete||e.attributes._complete,f=!(!h||"true"!==h.value),p=e.attributes.note||e.attributes._note||e.attributes.Notes,g={text:a.default.stripFormattingTags(c).replace(/[\r\n\t]/g," "),isComplete:f};if(o=n.default.createVMLI(g,{parent:r,changeType:ChangeType.AllLocal}),r.insertItem(o),p){var m={text:p.value,isNote:!0},v=n.default.createVMLI(m,{parent:o,changeType:ChangeType.AllLocal});o.setNote(v,ChangeType.AllLocal)}break;default:log("Unknown OPML Node: ",e)}if(l)for(var _=0,y=0;y<e.childElementCount;++y){if(_++>5e3&&__infLoop&&__infLoop(_))throw new RangeError;s(e.children[y],o)}return o}.bind(this);return r.a.beginAction(),s(e),r.a.endAction(),!0},parseJSON:function(e,t){function i(e,a){var s=a||t||n.default.getRootModel(),r={text:e.text,dateCompleted:e.dateCompleted,dateFormat:e.dateFormat,priority:e.priority,isComplete:e.isComplete,isStarred:e.isStarred},o=n.default.createVMLI(r,{parent:s,changeType:ChangeType.AllLocal});if(s.insertItem(o),e.note){var l={text:e.note.text,isNote:!0},d=n.default.createVMLI(l,{parent:o,changeType:ChangeType.AllLocal});o.setNote(d,ChangeType.AllLocal)}if(e.items)for(var u=0,c=0;c<e.items.length;++c){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;i(e.items[c],o)}}if(void 0!==e.moodoVer&&void 0!==e.moodoRoot)try{a.default.parseInt(e.moodoVer),r.a.beginAction();var s=e.moodoRoot;if(s.items)for(var o=0,l=0;l<s.items.length;++l){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;i(s.items[l])}return r.a.endAction(),!0}catch(e){a.default.reportError(e)}else if(void 0!==e.text&&void 0!==e.items)try{return r.a.beginAction(),i(e),r.a.endAction(),!0}catch(e){}return!1},_findLineParent:function(e,t,i){for(var a,n=0,s=Math.min(e.length-1,t-1);s>=0;--s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var r=e[s];if(r&&r.indentLevel===i-1){a=r;break}}return a},parseText:function(e){for(var t=0,i={items:[]},a=[],n=0;n<e.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=this._parseTextLine(e[n]);if(s){a.push(s);var r=this._findLineParent(a,n,s.indentLevel)||i;s.parent=r,r.items.push(s)}}return i},_parseTextLine:function(e){if(e&&e.length>0)return{indentLevel:Math.floor(e.search(/\S|$/)/4),text:a.default.trimString(e.replace(/[\ud800-\udfff]+/g,"")),items:[]}},_addMulti:function(e,t,i){return e[t]||(e[t]=i),e[t]},_getReference:function(e,t){var i;return"Evernote"!==t.type&&(i=e[t.value]),i},_hasReference:function(e,t){var i=!0;return"Evernote"!==t.type&&(i=!!e[t.value]),i},_parseIQTellFilename:function(e){return e.replace(/[\s_]-[\s_]Folder[\s_]Content(.*)\.csv/gi,"")},_visitIQTellNode:function(e,t,i){if(!e.isComplete){var a=0,s=n.default.createVMLI(e,{parent:t,changeType:ChangeType.AllLocal});if(e.__noteInfo){var r=n.default.createVMLI({text:e.__noteInfo,isNote:!0},{parent:s,changeType:ChangeType.AllLocal});s.setNote(r,ChangeType.AllLocal)}t.insertItem(s);for(var o=0;o<e.children.length;++o){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;this._visitIQTellNode(e.children[o],s,i+1)}}return s},_createVMLITree:function(e){return this._visitIQTellNode(e,n.default.getRootModel(),0)},_createIQTellText:function(e){var t=e.desc;return e.context&&(t+=" #"+e.context),e.date&&(t+=" @"+e.date.toString(o.a.getFormat(DFormat.MonthDayYear))),t},_lookupNode:function(e,t){return e[a.default.hashString(t)]},_storeNode:function(e,t,i){e[a.default.hashString(t)]=i},_beginImport:function(e){this._reportedImportError=!1,this._rawImportData=e},_endImport:function(){this._reportedImportError=!1,this._rawImportData=void 0},_reportRecursiveImport:function(){this._reportRecursiveImport||a.default.reportError(new Error("Recursive import failure"),this._rawImportData)},_ensureIQTellNode:function(e,t,i,n){if(a.default.Assert(i,"Must always provide a valid entry"),a.default.Assert(!i||i.desc,"Entry must always have a valid description"),n>60&&this._reportRecursiveImport(),!this._lookupNode(e,i.desc)){var s,r=0,o={text:this._createIQTellText(i),isStarred:i.star,isComplete:i.isComplete,priority:i.priority,parent:void 0,children:[],__noteInfo:void 0,__raw:i};if(i.notes){a.default.Assert(a.default.isString(i.notes),"Note must be a valid string");var d=l.a.generatePlaintext(i.notes,{});o.__noteInfo=d?d.replace(/(\s*\r?\n){2,}/gm,"\r\n").replace(/^\s*\r?\n/gm,"").replace(/\r([^\n])/gm,"\r\n$1").replace(/\r\n/gm,"\n"):i.notes}for(var u=0;u<i.parents.length;++u){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;(s=this._lookupNode(e,i.parents[u].value))||(s=this._ensureIQTellNode(e,t,t[i.parents[u].value],n+1));break}s||(s=this._lookupNode(e,"__MDFile__"+i.file)),o.parent=s,s.children.push(o),this._storeNode(e,i.desc,o)}return this._lookupNode(e,i.desc)},_createIQTellTree:function(e,t){var i=0,a={};log("Creating Tree From: ",e,t);for(var n={text:"IQTell Import",parent:void 0,children:[]},s=0;s<t.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=this._parseIQTellFilename(t[s]),o={text:r,parent:n,children:[]};this._storeNode(a,"__MDFile__"+r,o),n.children.push(o)}for(var l in e)this._ensureIQTellNode(a,e,e[l],0);return this._createVMLITree(n)},_parseIQTellDate:function(e){var t;try{e&&(t=o.a.parseDate(e,s.a.DateFormat.MDY))}catch(e){}return t},_parseIQTellPriority:function(e){var t;switch(e){case"1 - Low":t=VMLIFlag.P2;break;case"2 - Medium":t=VMLIFlag.P1;break;case"3 - High":t=VMLIFlag.P0;break;default:t=VMLIFlag.None}return t},iqtellProcess:function(e,t){var i,n=0,s={},r=[];for(var o in e)for(var l=0,d=e[o],u=0;u<d.length;++u){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;var c=d[u],h=c["Short Description"]||c.Title;if(h){var f={raw:c,generated:!1,context:c.Context,file:this._parseIQTellFilename(o),children:[],category:c.Category,area:c.Area,parents:this._parseEntries(c["Parent Entries"]),desc:h,links:this._parseEntries(c.Links),notes:c.Notes,date:this._parseIQTellDate(c["Due Date"]||c["Follow-up Date"]),isComplete:"Completed"===c.Status||"Canceled"===c.Status,priority:this._parseIQTellPriority(c.Priority),star:"Yes"===c.Star};this._addMulti(s,h,f),r.push(f)}}for(u=0;u<r.length;++u){var p=0,g=0;if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;f=r[u];for(var m=0;m<f.parents.length;++m){if(p++>5e3&&__infLoop&&__infLoop(p))throw new RangeError;(v=this._getReference(s,f.parents[m]))||this._hasReference(s,f.parents[m])?v.children.push(f):this._addMulti(s,f.parents[m].value,{raw:{},generated:!0,file:f.file,children:[f],parents:[],desc:f.parents[m].value,links:[],notes:void 0,priority:void 0,star:void 0})}for(m=0;m<f.links.length;++m){if(g++>5e3&&__infLoop&&__infLoop(g))throw new RangeError;if(!(v=this._getReference(s,f.links[m]))&&!this._hasReference(s,f.links[m]))var v=this._addMulti(s,f.links[m].value,{raw:{},generated:!0,file:f.file,children:[],parents:[{type:"generated",value:f.desc}],desc:f.links[m].value,links:[],notes:void 0,priority:void 0,star:void 0});f.children.push(v)}}this._beginImport(t);try{i=this._createIQTellTree(s,Object.keys(e))}catch(e){a.default.reportError(e)}return this._endImport(),i},_parseEntries:function(e){var t=[];if(e){for(var i=0,a=0,n=e.split(", "),s=["Organization","Contact","Prospect","Email","Evernote","Project","Sub-Project","Subtask","Action"],r=[],o=n.length-1;o>=0;o--){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var l=n[o],d=/^([^:]*):\s(.*)/.exec(l);(!d||!d[1]||s.indexOf(d[1])<0)&&o>0?(n[o-1]+=", "+n[o],n.removeAt(o)):r.push(l)}for(o=0;o<r.length;++o){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var u=r[o],c=u.indexOf(":");if(c>0){var h=u.substr(0,c),f=u.substr(c+2);t.push({type:h,value:f})}}}return t},stripParents:function(e){if(e.parent=void 0,e.items)for(var t=0,i=0;i<e.items.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this.stripParents(e.items[i])}},parseClassName:function(e,t){if(e)return e.indexOf("high")>=0?t.priority=VMLIFlag.P0:e.indexOf("medium")>=0?t.priority=VMLIFlag.P1:e.indexOf("low")>=0&&(t.priority=VMLIFlag.P2),e.indexOf("complete")>=0&&(t.isComplete=!0),e.indexOf("starred")>=0&&(t.isStarred=!0),e.indexOf("note")>=0&&(t.isNote=!0),t},traverseDOM:function(e){var t,i=0,n=e.root,s=e.stripParents,r=e.shouldPrint,o=e.preserveWhitespace,l=n.firstChild,d={items:[]},u={text:"",parent:d};d.items.push(u);var c,h,f,p=!1,g=!1,m=this;function v(e){if(e.nodeType===Node.TEXT_NODE){(g||p)&&(o||(u.text=u.text.replace(/^ +/g,"").replace(/ +$/g,"")),""!==u.text&&(t={text:"",parent:u.parent},m.parseClassName(c,t),a.default.hasClass(e.parentNode,"note")?(t.isNote=!0,u._note=t):u.parent.items.push(t),u=t)),g=!1,p=!1;var i=e.nodeValue.replace(/[\ud800-\udfff]+/g,"");""===u.text&&(i=o?i.replace(/^[\r\n\t]+/g,""):i.replace(/^[ \r\n\t]+/g,"")),m.parseClassName(c,u),u.text+=a.default.stripFormattingTags(i)}else e.nodeType===Node.COMMENT_NODE||("BR"===e.tagName||"P"===e.tagName||"LI"===e.tagName||"DIV"===e.tagName?(p=!0,c=e.className):"A"===e.tagName?u.text+="[":"UL"!==e.tagName&&"OL"!==e.tagName||(u.text=u.text.replace(/^ +/g,"").replace(/ +$/g,""),t={text:"",parent:u},m.parseClassName(c,t),u.items?u.items.push(t):u.items=[t],u=t,p=!1,c=""))}function _(e){e.nodeType!==Node.TEXT_NODE&&("UL"===e.tagName||"OL"===e.tagName?(u=u.parent,g=!0):"DIV"===e.tagName||"P"===e.tagName?(p=!0,c=""):"A"===e.tagName&&(u.text+="]("+e.getAttribute("href")+")"))}do{if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(v(l),"note"===l.className?(f=l,u.text=f.innerHTML,u.parent._note=u,u.isNote=!0,u={text:"",parent:u.parent},g=!0,p=!0,h=void 0):h=l.firstChild,h)l=h;else if(h=l.nextSibling)l=h;else{var y=0;do{if(y++>5e3&&__infLoop&&__infLoop(y))throw new RangeError;(h=l.parentNode.nextSibling)?(_(l.parentNode),l=h):_(l=l.parentNode)}while(!h&&l&&l.parentNode);if(!h)break}}while(l);return s&&this.stripParents(d),r&&function e(t,i){var a=0;isNaN(i)&&(i=0);for(var n="",s=0;s<i;s++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;n+="--"}if(i&&console.log(n,t.text),t.items){var r=0;for(s=0;s<t.items.length;s++){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;e(t.items[s],i+1)}}}(d),d}},t.a=new d},function(e,t,i){"use strict";var a=i(0),n=i(1),s=(i(4),i(2)),r=i.n(s),o=i(46),l=i.n(o),d=i(12),u=Object.assign||function(e){for(var t=0,i=1;i<arguments.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=arguments[i];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};var c=d.a.createClass({displayName:"FancyRippler",componentDisplay:n.a.ComponentDisplay.Everywhere,init:function(){this.createObservables({ripples:[]}),this.rippleNum=0},componentDidMount:function(){this.props.onClick&&a.default.setupClick(this.refs.element,this,this.onTap)},getElement:function(){return l.a.findDOMNode(this)},onMouseDown:function(e){var t=this.props;if(!1!==t.enabled){if(this.props.onMouseDown&&this.props.onMouseDown(e),this.props.children&&!e.defaultPrevented&&!1!==t.ripple){var i,n,s=this.refs.element,r=s.offsetWidth,o=s.offsetHeight,l=Math.max(r,o);if(this.props.center)i="50%",n="50%";else{var d=a.default.offset(s);i=e.clientX-d.left,n=e.clientY-d.top}var u={id:this.rippleNum++,left:i,top:n,width:l,height:l};this.ripples.push(u),setTimeout(this.removeRipple,1e3)}e.stopPropagation()}},onRightClick:function(e){e.preventDefault(),e.stopPropagation(),this.props.onRightClick(e)},onTap:{onStart:function(e){!1===this.props.enabled||a.default.findParent(e.target,"fancyInput")||(this.onMouseDown(e),e.stopPropagation())},onClick:function(e){!1===this.props.enabled||a.default.findParent(e.target,"fancyInput")||(this.props.onClick(e),e.preventDefault(),e.stopPropagation())}},removeRipple:function(){this.ripples.removeAt(0)},render:function(){for(var e=0,t=this.state,i=this.props,n=[],s=0;s<t.ripples.length;s++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var o={left:(d=t.ripples[s]).left,top:d.top,width:d.width,height:d.height,marginLeft:-d.width/2,marginTop:-d.height/2};n.push(r.a.createElement("div",{key:"ripple_"+d.id,className:"fancyRipple",style:o}))}var l=a.default.classNames(this.props.className,"fancyRippler",{rippleCenter:this.props.center}),d=(i.center,i.onClick,i.enabled,i.ripple),c=i.onRightClick,h=function(e,t){var i={};for(var a in e)t.indexOf(a)>=0||Object.prototype.hasOwnProperty.call(e,a)&&(i[a]=e[a]);return i}(i,["center","onClick","enabled","ripple","onRightClick"]);return r.a.createElement("div",u({},h,{className:l,onMouseDown:void 0,onClick:void 0,onContextMenu:c?this.onRightClick:void 0,ref:"element"}),this.props.children,n.length>0&&r.a.createElement("div",{className:"fancyRipples"},n))}});t.a=c},function(e,t,i){"use strict";var a=i(1),n=i(0),s=i(2),r=i.n(s),o=i(12).a.createClass({displayName:"FancyContextMenuHeader",componentDisplay:a.a.ComponentDisplay.Desktop,render:function(){var e=this.props,t=n.default.classNames("fancyContextMenuItem fancyContextMenuHeader flexbox c-foreground-very-faded",e.className,{"border c-border-light":!1!==e.border},{topHeader:e.topHeader}),i=n.default.classNames("fancyContextMenuHotkey c-foreground-faded",{centered:e.hotkeyCentered}),a={padding:isNaN(e.padding)?void 0:e.padding};return r.a.createElement("div",{className:t,style:a},r.a.createElement("span",{className:"f1"},e.children),e.hotkey&&r.a.createElement("span",{className:i},e.hotkey))}});t.a=o},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(5),r=i(4),o=i(8),l=i(23),d=i(3),u=i(14),c=i(15),h=i(62),f=i(40),p=i(13),g={None:0,OnScroll:1};function m(e){this._pane=e.pane,this._isOverview=e.isOverview,this._itemsObs=e.itemsObs,this._getItemsList=e.itemsFn,this.getHeight=e.heightFn,this.getWidth=e.widthFn,this.minItemSize=e.minItemSize,this.hasSetHeightOnce=!1,this.scrollHandler=void 0,this._mobilePadBottom=!1,this.contentSize=new o.a(0),this.paddingBottom=new o.a(0),this._timeoutPointerEvents=void 0,this.disablePointerEvents=new o.a(!1),this._direction=Direction.None,this._scrollTop=0,this._lastProcessedScrollTop=0,this._itemInfoById={},this._savedScrollOfTop={},this._indexOfTop=0,this._inViewCount=0,this._reactList=void 0,this._isMounted=!1,this._panePadding=0,this.useCustomScroller=r.a.useCustomScroller,this.cellsObs=new l.a([]),this.cells=this.cellsObs.get(),this.cellsNew=[],this._tops=[],this.scrollListeners=[],this.offscreenScrollPadding=400,this._phase=g.None,this.init()}m.prototype={init:function(){s.a.binder(this,"_onListChanged","_onSettingChanged","_onResize","_onScroll","_handleScroll","handleItemTextChanged","handleItemNoteSet","_onTimeoutPointerEvents","_computeRenderItemsBatched","_onSetScrollComplete","_onSetScrollCompleteTimeout","_afterSetScrollComplete","reMount","onImageLoaded")},getID:function(){return this._pane.id+(this._isOverview?"_o":"")},notifyInit:function(e){this._pane.setIgnoreRestoreScroll(),a.default.Assert(!this._isMounted,"Should not initialize a pane twice"),this.clearCache(),this.allocateCells(),this._onListChanged(),this._isMounted=!0,this._reactList=e,this._listenToItemsList(this._onListChanged),this._pane.rect.listen(this._onResize),a.default.settings.listen("settingChanged",Settings.UISettingsGroup,this._onSettingChanged),this._isOverview||(this._pane.topBoxHeight.listen(this._onListChanged),p.a.listen("imageLoaded",this.onImageLoaded))},notifyUnmounted:function(){s.a.destroy(this),this._isMounted=!1,this.isDelayingMounts=!1,this._unlistenToItemsList(this._onListChanged),this._pane.rect.unlisten(this._onResize),a.default.settings.unlisten("settingChanged",Settings.UISettingsGroup,this._onSettingChanged),this._isOverview||(this._pane.topBoxHeight.unlisten(this._onListChanged),p.a.unlisten("imageLoaded",this.onImageLoaded)),clearTimeout(this._timeoutPointerEvents),this._timeoutPointerEvents=void 0,this.removeNativeScrollListener(this._onScroll),this._reactList=void 0,this.useCustomScroller&&(this.iScroller.destroy(),this.iScroller=void 0),a.default.clearTimeoutOnce("afterScroll"+this.getID()),a.default.clearTimeoutOnce("listSettingChanged_"+this.getID())},allocateCells:function(){var e=this.cells.length,t=Math.ceil((r.a.windowHeight()+2*this.offscreenScrollPadding)/this.minItemSize())+4;if(t>e){for(var i=0,a=this.cells,n=e;n<t;n++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=new h.a;a.push(s)}this.cellsObs.set(a),this.cells=this.cellsObs.get()}},setupScroller:function(e,t){this.scrollElement=e,this.useCustomScroller&&this.setupCustomScroller(e,t),this.addNativeScrollListener(this._onScroll),this.useCustomScroller&&setTimeout(this.refreshScrollListener.bind(this))},setupCustomScroller:function(e,t){var i;this.iScroller=a.default.createCustomScroller(e),this.iScroller.on("scrollStart",function(){r.a.ios&&(i=a.default.isKeyboardOpen?c.default.getSelectionRange(!0):null,a.default.addClass(t,"preventSelect"))}.bind(this)),this.iScroller.on("scrollEnd",function(){this._onSetScrollComplete(),r.a.ios&&(!i&&a.default.isKeyboardOpen&&(i=c.default.getSelectionRange(!0)),setTimeout(function(){a.default.removeClass(t,"preventSelect"),i&&(c.default.setSelectionRange(i),i=null)},0))}.bind(this))},clearItemInfoForItem:function(e){var t=this._pane.getPaneObjectsForItem(e),i=this._itemInfoById;if(t)for(var a=0,n=0;n<t.length;n++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=t[n];i[s.id]&&(i[s.id].needsUpdate=!0)}},handleItemNoteSet:function(e){this.clearItemInfoForItem(e.item)},handleItemTextChanged:function(e){a.default.Assert(!this._isOverview,"Overviews should never listen to text changes");var t=this._pane,i=!1;if(t&&t.isViewText())if(t.isItemInPane(e)){var n=this.indexOfItem(e);this.checkHeightChanged(e,n)?(this.clearItemInfoForItem(e),i=!0,window.__TEXT_CHANGED_UPDATES.CausedUpdate++):window.__TEXT_CHANGED_UPDATES.NoUpdate++}else this.clearItemInfoForItem(e),window.__TEXT_CHANGED_UPDATES.PaneSkipped++;return i},getElementAtIndex:function(e){return this._reactList.getElementAtIndex(e)},isIndexMounted:function(e){return this._reactList.isIndexMounted(e)},hasItems:function(){return this._getItemsList().length>0},numItems:function(){return this._getItemsList().length},indexOfTop:function(){return this._indexOfTop},inViewCount:function(){return this._inViewCount},objectAtTop:function(){var e=this._getItemsList(),t=this.indexOfTop(),i=t>=0&&t<e.length;return a.default.Assert(i,"Item at top is not in range",t,e.length),e[t]},itemAtTop:function(){var e=this.objectAtTop();return e&&(a.default.isVMLI(e)?e:e.item)},indexPageUp:function(e){for(var t=0,i=this.size.height,a=0,n=e-1;n>=0;--n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if((a+=this._sizes[n])>i)return n+1}return 0},indexPageDown:function(e){for(var t=0,i=this.size.height,a=0,n=this._sizes.length,s=e;s<n;++s){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if((a+=this._sizes[s])>i)return s}return Math.max(n-1,0)},_listenToItemsList:function(e){this._itemsObs.listen(e)},_unlistenToItemsList:function(e){this._itemsObs.unlisten(e)},objectAtIndex:function(e){var t=this._getItemsList();return a.default.Assert(e>=0&&e<t.length,"Invalid item index: "+e,t.length,this._pane.type),t[e]},itemAtIndex:function(e){var t=this._getItemsList();a.default.Assert(e>=0&&e<t.length,"Invalid item index: "+e,t.length,this._pane.type);var i=t[e];return i&&(a.default.isVMLI(i)?i:i.item)},sizeAtIndex:function(e){return this._pane.sizeAtIndex(e,this._isOverview)},addPadding:function(){this.useCustomScroller?(this._panePadding=r.a.windowHeight()-2*a.default.topBarHeight,this.refreshScrollListener()):(this._mobilePadBottom=!0,this._computeContentSize(!0))},removePadding:function(){if(this.useCustomScroller){var e=this.iScroller;this._panePadding=0,this.refreshScrollListener(),e&&e.y<e.maxScroll&&this.iScroller.scrollTo(0,e.maxScroll,200)}else this._mobilePadBottom=!1,this._computeContentSize(!0)},addNativeScrollListener:function(e){this.useCustomScroller?this.iScroller.on("scroll",e):r.a.addPassiveListener(this.scrollElement,"scroll",e)},removeNativeScrollListener:function(e){this.useCustomScroller?this.iScroller.off("scroll",e):this.scrollElement&&this.scrollElement.removeEventListener("scroll",e)},addScrollListener:function(e){this.scrollListeners.push(e)},removeScrollListener:function(e){a.default.Assert(this.hasScrollListener(e),"Removing a listener that does not exist"),this.scrollListeners.remove(e)},hasScrollListener:function(e){return this.scrollListeners.indexOf(e)>=0},refreshScrollListener:function(){if(this.useCustomScroller&&this.iScroller){var e=this.contentSize.get();this.iScroller.manualRefresh(e+this._panePadding)}},getScrollOffset:function(){if(this._isMounted){if(this.useCustomScroller){var e=this._pane.orientation.get()===n.a.Orientation.Vertical?"y":"x";return this.iScroller?-this.iScroller[e]:0}if(this.scrollElement){e=this._pane.orientation.get()===n.a.Orientation.Vertical?"scrollTop":"scrollLeft";return this.scrollElement[e]}return 0}return 0},getScrollSize:function(){return Math.max(this.contentSize.get()+0,0)},getMaxScrollOffset:function(){var e=this._pane.orientation.get()===n.a.Orientation.Vertical?this.getHeight():this.getWidth();return Math.max(this.getScrollSize()-e,0)},setScrollOffset:function(e,t,i){var s=this;if(a.default.Assert(this.scrollElement,"Pane must have loaded a scrollable element"),a.default.Assert(a.default.isNumber(e),"Must supply a valid scroll offset"),this.scrollElement&&this._pane){if(this._pane.isFakePane)return;t=t||ScrollDuration.Snap;var o=this.getScrollOffset(),l=this.getMaxScrollOffset();if(l+=r.a.getKBSize()+n.a.KeyboardToolbarHeight,e<0?e=0:e>l&&(e=l),e=Math.floor(e),this._isMounted&&this._scrollingTo!==e){this._scrollingTo=t?e:void 0,this._isSettingScroll=!0;var d,u,c=this._pane.orientation.get()===n.a.Orientation.Vertical;this.useCustomScroller?(d=c?0:-e,u=c?-e:0,this.iScroller.scrollTo(d,u,t),t||this.iScroller._execEvent("scroll"),i&&(t?setTimeout(i,t):i())):(d=c?void 0:e,u=c?e:void 0,a.default.scrollTo(d,u,t,this.scrollElement,function(){s._onSetScrollComplete(),i&&i()}))}else a.default.timeoutOnce("setScrollComplete_"+this.getID(),this._onSetScrollComplete,0),i&&i();return e-o}},_onSetScrollComplete:function(){this._restoringScroll?this._afterSetScrollComplete():a.default.timeoutOnce("scrollCompleteTimeout_"+this.getID(),this._onSetScrollCompleteTimeout,60)},_onSetScrollCompleteTimeout:function(){this._isMounted&&this.saveScrollOfTop(!0,!0),this._afterSetScrollComplete()},_afterSetScrollComplete:function(){this._scrollingTo=void 0,this._isSettingScroll=!1},_computeContentSize:function(e){var t=0,i=this.getPaddingTop(),n=i,s=this._getItemsList(),o=this._pane.getItem().levelsDeep.get();this._sizes=[],this._tops=[];for(var l=0;l<s.length;++l){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var d,u=s[l],c=s[l].item||u,h=a.default.isVMLI(c),f=this._itemInfoById[u.id],p=h?c.levelsDeep.get()-o:void 0;f&&!f.needsUpdate&&f.levelsDeep===p&&void 0===u.sizePad?d=f.size:(d=this.sizeAtIndex(l),f=this._itemInfoById[u.id]={size:d,levelsDeep:p,paneObject:u,needsUpdate:!1}),this._sizes[l]=d,this._tops[l]=l>0?this._tops[l-1]+this._sizes[l-1]:i,f.previousTop=f.top,f.top=this._tops[l],n+=f.size}var g=2*this.minItemSize();return this._mobilePadBottom&&(g+=r.a.getKBSize()),this.paddingBottom.set(g),this.contentSize.set(n,e),this.useCustomScroller&&this.refreshScrollListener(),n},flushTimeoutPointerEvents:function(){this._timeoutPointerEvents&&(clearTimeout(this._timeoutPointerEvents),this._timeoutPointerEvents=void 0,this._onTimeoutPointerEvents())},_onTimeoutPointerEvents:function(){this._pane.isDestroyed()||(this.disablePointerEvents.set(!1),this.killAllDeadCells(),this._isSettingScroll||this._wasSettingScroll||this.saveScrollOfTop(),this._scrollingTo=void 0,this._wasSettingScroll=!1)},reMount:function(){this.isDelayingMounts=!1,this.fireEvent("reMount",[])},_onScroll:function(e){var t=0;if(!e||!a.default.findParent(e.target,"preventScrollPropagate")){this._restoringScroll&&!this._isSettingScroll||(this._prevScrollTop=this._scrollTop,this._scrollTop=this.getScrollOffset(),this._handleScroll());for(var i=0;i<this.scrollListeners.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this.scrollListeners[i](e)}}},_handleScroll:function(){if(this._phase=g.OnScroll,r.a.useCustomScroller||d.a.isMouseDown()||(this._prevScrollTop!==this._scrollTop&&this.disablePointerEvents.set(!0),this._timeoutPointerEvents&&clearTimeout(this._timeoutPointerEvents),this._wasSettingScroll=this._isSettingScroll,this._timeoutPointerEvents=setTimeout(this._onTimeoutPointerEvents,50),0===this._scrollTop&&0!==this._prevScrollTop&&this.saveScrollOfTop()),d.a.isMouseDown()||(this.isDelayingMounts=!0,a.default.timeoutOnce("afterScroll"+this.getID(),this.reMount,150)),d.a.hoveredItem&&d.a.setHovered(this,null,null),this._scrollTop!==this._prevScrollTop){this._direction=this._scrollTop>this._prevScrollTop?Direction.Down:Direction.Up;var e=Math.abs(this._scrollTop-this._lastProcessedScrollTop);if(this.alwaysRenderScroll||e>=this.offscreenScrollPadding/2)this._lastProcessedScrollTop=this._scrollTop,this._computeRenderItems();else this.updateTopIndex()}this.scrollHandler&&this.scrollHandler(this._scrollTop),this._phase=g.None},_updateSize:function(){this.size={width:this._pane.getWidth(),height:this._pane.getHeight()}},_onListChanged:function(){if(this._needsResize)return this._needsResize=!1,void this._onResize(void 0,void 0,!0);this.rect=this._pane.rect.get(),this._updateSize(),this.killAllDeadCells(),this._computeContentSize(!1),this._computeRenderItems(this._isMounted)},_onSettingChanged:function(){this._needsResize=!0,a.default.timeoutOnce("listSettingChanged_"+this.getID(),this._onResize,0,void 0,void 0,!0)},_onResize:function(e,t,i){if(!a.default.vmMain.paneManager.isResizingPane){a.default.clearTimeoutOnce("listSettingChanged_"+this.getID()),this._needsResize=!1;var s=this.rect?this.rect.width:-1,r=this.rect?this.rect.height:-1;i||e&&(e.width!==s||e.height!==r)?(this.saveScrollOfTop(),this._updateSize(),this.clearCache(),this.allocateCells(),a.default.vmMain.setItemAnimationMode(n.a.ItemAnimationMode.None),this._onListChanged(),a.default.vmMain.resetItemAnimationMode(),d.a.getPane()===this._pane&&d.a.updateCaret()):this._updateSize()}},saveScrollOfTop:function(e,t){this._savedScrollOfTop;if(this.numItems()>0&&(t||!this._pane.isIgnoringRestoreScroll())){for(var i,a,n=0,s=[],r=this.numItems(),o=e?this.getScrollOffset():this._scrollTop,l=this._indexOfTop;l<Math.min(this._indexOfTop+this._inViewCount-1,r);l++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;i=this.objectAtIndex(l),(a=o-this.topOfIndex(l))-this._sizes[l]<-this.getPaddingTop()&&s.push({index:l,paneObject:i,scrollOffset:a})}this._savedScrollOfTop.inView=s}},restoreScrollOfTop:function(){var e=this._savedScrollOfTop;if(!this._pane.isIgnoringRestoreScroll()&&this._pane._didInitialScroll){if(e&&!a.default.isEmpty(e)){var t=e.inView;if(t)for(var i=0,n=0;n<t.length;n++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=t[n];if(this.restoreScroll(s))break}this._restoringScroll||this._pane.scrollToTop(ScrollDuration.Snap)}this._restoringScroll=!1}},restoreScroll:function(e){var t=this.indexOfItem(e.paneObject);if(t>=0){var i=Math.max(this.topOfIndex(t)+(e.scrollOffset||0),0),n=this.getMaxScrollOffset();return i>n&&(i=n),this._restoringScroll=!0,this._scrollTop=i,this.setScrollOffset(i,ScrollDuration.Snap),a.default.animFrameOnce("restoreScroll_"+this.getID(),function(){this.setScrollOffset(i,ScrollDuration.Snap)}.bind(this)),!0}return!1},clearCache:function(){var e=0;this._itemInfoById={};for(var t=0;t<this.cells.length;t++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this.cells[t];i.isLive&&(i.width=i.height=void 0)}},_isInBounds:function(e,t){var i=!1;return e>this._getPVRBottom()+this.offscreenScrollPadding||t<this._getPVRTop()-this.offscreenScrollPadding||(i=!0),i},getScrollTop:function(){return this._scrollTop},_getPVRTop:function(){return this._scrollTop},_getPVRBottom:function(){return this._scrollTop+(this._pane.orientation.get()===n.a.Orientation.Vertical?this.size.height:this.size.width)},killAllDeadCells:function(){for(var e=0,t=0;t<this.cells.length;t++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this.cells[t];!i.isLive&&i.deadNeedsNotify&&i.kill(!0)}},_startCellPassOnCell:function(e){e.seenInPass=!1},startCellPass:function(){var e=0;this.cellsCurrent={};for(var t=0;t<this.cells.length;t++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this.cells[t];i.isLive&&(this.cellsCurrent[i.paneObject.id]=i,this._startCellPassOnCell(i))}},_pruneCellPassOnCell:function(e,t){if(!e.seenInPass||t){var i,a=e.index;(this._phase!==g.OnScroll||this._isInBounds(this._tops[a],this._tops[a]+this._sizes[a]))&&(i=!0),e.kill(i)}},pruneCellPass:function(){for(var e=0,t=0;t<this.cells.length;t++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this.cells[t];i.isLive&&this._pruneCellPassOnCell(i)}},updateCell:function(e){var t=this._pane,i=this._getItemsList()[e],a=i.id,s=this.cellsCurrent[a],r=this._isOverview||this._pane.orientation.get()===n.a.Orientation.Vertical,o=this._sizes[e],l=r?t.getContentWidth():o,d=r?o:t.getContentHeight(),u=this._tops[e],c=this._itemInfoById[a],h=c&&c.previousTop;s&&!s.seenInPass?s.update(e,l,d,u,h,i):!s&&this.cellsNew.indexOfWithProperty("index",e)<0&&this.cellsNew.push({index:e,width:l,height:d,offset:u,paneObject:i,prevOffset:h})},_addPassOnCell:function(e){for(var t,i=0,n=0;n<this.cells.length;n++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(!this.cells[n].isLive){t=this.cells[n];break}}a.default.Assert(t,"Must always have additional cells to use",r.a.windowHeight()),t||(t=new h.a,this.cells.push(t)),t.update(e.index,e.width,e.height,e.offset,e.prevOffset,e.paneObject)},addCellPass:function(){for(var e=0,t=0;t<this.cellsNew.length;t++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this.cellsNew[t];this._addPassOnCell(i)}this.cellsNew=[]},_isIndexSeen:function(e){var t=this._getItemsList()[e].id,i=this.cellsCurrent[t];return i&&i.seenInPass},_computeRenderItems:function(e){a.default.batchRenderUpdates(this._computeRenderItemsBatched,e)},_computeRenderItemsBatched:function(e){var t,i,n,s,r=0,o=this._getItemsList(),l=0;this.startCellPass(),e&&this.restoreScrollOfTop();for(var c=0;c<o.length;++c){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;if(t=this._tops[c],i=this._sizes[c],this._isInBounds(t,t+i))isNaN(n)&&t+i>this._getPVRTop()&&(n=c),this.updateCell(c),!isNaN(n)&&Math.round(t)<this._getPVRBottom()-2&&l++;else if(t>this._getPVRBottom())break}isNaN(n)&&(n=0),this._indexOfTop=n,this._inViewCount=l,d.a.isValid()&&a.default.isKeyboardOpen&&this._pane===d.a.getPane()&&(s=d.a.getStartIndex())<this._sizes.length&&!this._isIndexSeen(s)&&this.updateCell(s),u.default.isDragging&&(s=this._pane.indexOfItem(u.default.dragItem))>=0&&!this._isIndexSeen(s)&&this.updateCell(s),this.pruneCellPass(),this.addCellPass(),this._isSettingScroll||this._phase===g.OnScroll||this.saveScrollOfTop()},updateTopIndex:function(){for(var e,t,i=0,a=this._getItemsList(),n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(e=this._tops[n],t=this._sizes[n],this._isInBounds(e,e+t)&&e+t>this._getPVRTop()){this._indexOfTop=n;break}}},getItemInfo:function(e){return this._itemInfoById[e]},getItemInfosForItem:function(e){var t=this._itemInfoById,i=[];if(t[e.id])i.push(t[e.id]);else for(var a in this._itemInfoById)t.hasOwnProperty(a)&&t[a].paneObject.item===e&&i.push(t[a]);return i},indexOfItem:function(e,t,i){for(var n,s=0,r=a.default.isVMLI(e),o=this._getItemsList(),l=0;l<o.length;l++){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var d=o[l];if(r){if(!(d!==e&&d.item!==e||d.type&&"blockItem"!==d.type||t&&d.block&&d.block.id!==t.id))return l}else{if(d.id===e.id)return l;d.item&&d.item===e.item&&(n||(n=[]),n.push({index:l,item:d}))}}if(n){if(i){var u,c,h=0;for(l=0;l<n.length;l++){if(h++>5e3&&__infLoop&&__infLoop(h))throw new RangeError;var f=Math.abs(n[l].index-i);(isNaN(c)||f<u)&&(c=l,u=f)}return n[c].index}return n[0].index}return-1},topOfItem:function(e){a.default.Assert(e,"Must provide a valid item to measure");var t=this.indexOfItem(e);return a.default.Assert(t>=0,"Must supply a valid item that is in this pane"),this.topOfIndex(t)},topOfIndex:function(e){return a.default.Assert(e>=0,"Must supply a valid index"),this._tops[e]},scrollIndexToTop:function(e,t,i){var a=this.topOfIndex(e),n=this.getScrollOffset();if(a<n||a-n>200)return this.setScrollOffset(a-16,t,i);i&&i()},scrollItemToTop:function(e,t,i){a.default.Assert(a.default.isVMLI(e),"Must be a valid VMLI instance"),a.default.Assert(a.default.isNumber(t),"Must have a valid scroll duration");var n=this.indexOfItem(e);return a.default.Assert(n>=0,"Must supply a valid item that is in this pane"),this.scrollIndexToTop(n,t,i)},scrollIndexToMiddle:function(e,t,i){if(this._isMounted){var a=this.topOfIndex(e),n=this._sizes[e],s=Math.floor(a+n/2-this.getHeight()/2);return this.setScrollOffset(s,t,i)}i&&i()},scrollItemToMiddle:function(e,t,i){if(this._isMounted){var a=this.indexOfItem(e);if(a>=0)return this.scrollIndexToMiddle(a,t,i)}else i&&i()},scrollItemIntoView:function(e,t,i){if(this._isMounted){var a=this.indexOfItem(e);return this.scrollIndexIntoView(a,t,i)}i&&i()},scrollIndexIntoView:function(e,t,i){t=isNaN(t)?ScrollDuration.Default:t,a.default.Assert(a.default.isNumber(e),"Must supply a valid index"),a.default.Assert(!i||a.default.isFunction(i),"Must supply a valid callback function");var s=this.itemAtIndex(e);if(a.default.Assert(s,"Item does not exist to scroll to",e,this.numItems()),this._isMounted&&s){var o,l,d,u=r.a.getKBSize(),c=this.topOfIndex(e);o=this.getHeight()-u-n.a.KeyboardToolbarHeight,d=(l=this.getScrollOffset())+o;var h=this._sizes[e],f=c+h,p=f>d,g=c<l;g&&h>o&&f>=d&&(g=!1);var m,v=0;return g?m=0===c?0:c:p&&(m=f-o),g||p?(v=m-l,this.setScrollOffset(m,t,function(){i&&setTimeout(i,0)})):i&&i(),v}return!1},getPaddingTop:function(){return this._isOverview?8:this._pane.topBoxHeight.get()+a.default.topBarHeight},notifyDragStart:function(){this.useCustomScroller&&this.iScroller.disable()},notifyDragEnd:function(){this.useCustomScroller&&this.iScroller&&this.iScroller.enable()},notifySwappedIn:function(e){isNaN(e)||this.setScrollOffset(e)},addScrollDelta:function(e){return a.default.Assert(this.scrollElement,"Pane must have loaded a scrollable element"),this.setScrollOffset(this.getScrollOffset()+e)},setScrollHandler:function(e){this.scrollHandler=e},setInitialScrollOffset:function(e){this._scrollTop=e||0},checkHeightChanged:function(e,t){var i=this._pane,a=this.objectAtIndex(t),n=e.sizeInPane(i,t,!1)+(a.sizePad||0),s=this.getItemInfosForItem(e);if(s.length>0&&n!==s[0].size)return this.clearItemInfoForItem(e),!0},onImageLoaded:function(e){if(this._pane.isItemInPane(e)){var t=this.indexOfItem(e);(t<0||this.checkHeightChanged(e,t))&&(this._pane.setIgnoreRestoreScroll(),this.clearItemInfoForItem(e),this._pane.setItemsDirty(),a.default.vmMain.updateAllItems())}}},s.a.defineBase(m),s.a.extend(m.prototype,f.a),t.a=m},,function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(4),r=i(2),o=i.n(r),l=i(12),d=i(3),u=i(39),c=i(22),h=i(15),f=i(26),p=i(14),g=i(63),m=i(11),v=i(48),_=i(69),y=i(10),S=l.a.createClass({displayName:"ReactEmailCompose",componentDisplay:n.a.ComponentDisplay.Everywhere,init:function(){var e=this.props;this._dragEnterCounter=0,this._escapedFromDrag=!1,this.to=this._createTokensFromAddressText(e.message.to),this.cc=this._createTokensFromAddressText(e.message.cc);var t=!!e.message.cc&&e.message.cc.length>0;if(this.createObservables({showSubject:e.showSubject||!0,showCc:t,showBcc:!1,isSending:!1,isDragOver:!1}),this.listenTo(m.a.onAccountsUpdated),this.props.message.inReplyTo){var i=this.props.threadAttach.getData().messages,n=i.indexOfWithProperty("messageID",this.props.message.inReplyTo);if(n>=0){var s=i[n];a.default.Assert(s.initializedForDisplay,"Message must be ready to display if being replied to"),s&&s.responseMode&&(this.modeListener=s.responseMode.listen(this.onReplyModeChanged))}}a.default.isDemoMode()&&(a.default.reactEmailCompose=this)},onReplyModeChanged:function(){this.to=this._createTokensFromAddressText(this.props.message.to),this.cc=this._createTokensFromAddressText(this.props.message.cc),this.cc&&this.cc.tokens&&this.cc.tokens.length>0&&this.showCc.set(!0),this.updateState()},_getHotkeys:function(){return[f.a.create(KeyCode.Escape,!0,n.a.Primary.Either,n.a.Shift.Either,this.onEscape),f.a.create(KeyCode.Enter,!0,n.a.Primary.Yes,n.a.Shift.Either,this.send),f.a.create(KeyCode.K,!0,n.a.Primary.Yes,n.a.Shift.No,this.insertLinkHotkey)]},getState:function(){return{attachments:this.props.threadAttach.getPlugin().getMessageDisplayAttachments(this.props.message),fromAccounts:this.getSendingAccounts()}},componentDidMount:function(){var e=this._getComposeBody(this.props.message);e&&this.refs.body.setValue(e),this.refs.container.addEventListener("cdrop",this.onItemDrop);var t=this;this.refs.picker.addEventListener("change",function(){return t.props.threadAttach.getPlugin().notifyAttachFiles(t.props.threadAttach,t.props.message,this.files,t.onAttachUpdated),this.value=null,!1},!1),this.refs.container.addEventListener("paste",function(e){var i=e&&e.clipboardData?e.clipboardData:e.synthetic?e.data:window.clipboardData;if(i&&i.items&&i.items.length>0){for(var a=0,n=[],s=0;s<i.items.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;"file"===i.items[s].kind&&n.push(i.items[s].getAsFile())}if(n.length>0)return t.props.threadAttach.getPlugin().notifyAttachFiles(t.props.threadAttach,t.props.message,n,t.onAttachUpdated),!1}},!1)},onUnmount:function(){this.modeListener&&(this.modeListener.dispose(),this.modeListener=void 0),this._clearDraftDebounce(!0,!0)},discard:function(){this.close(!1,!0,!0)},onEscape:function(){this.isDragOver.get()||(this.refs.to.getTokens().length>0||this.refs.body.getValue()||this.state.attachments.length>0?a.default.menus.confirm("Do you want to discard this draft?",function(e){e&&this.discard()}.bind(this)):this.discard())},send:function(){this.onClickSend()},onFocus:function(){this.__hotkeys||(this.__hotkeys=f.a.pushStack(this._getHotkeys())),d.a.clearSelection()},onBlur:function(){this.__hotkeys&&(f.a.popStack(this.__hotkeys),this.__hotkeys=void 0)},onClickAttach:function(){this.refs.picker.click()},onAttachUpdated:function(e){this._isMounted&&(this.onDraftChanged(),e&&this._clearDraftDebounce(!0,!0),this.updateState())},onDragEnter:function(e){e.preventDefault(),this._escapedFromDrag||(this._dragEnterCounter++,this.isDragOver.set(!0))},onDragLeave:function(){this._dragEnterCounter--,0===this._dragEnterCounter&&this.isDragOver.set(!1)},onMouseUp:function(){this._escapedFromDrag=!1,this.isDragOver.set(!1)},onKeyDown:function(e){e.keyCode===KeyCode.Escape&&this.isDragOver.get()&&(this._escapedFromDrag=!0,this.isDragOver.set(!1))},onFileDrop:function(e){if(!this._escapedFromDrag){this.isDragOver.set(!1);var t=e.dataTransfer;if(t.files&&t.files.length>0)this.props.threadAttach.getPlugin().notifyAttachFiles(this.props.threadAttach,this.props.message,t.files,this.onAttachUpdated.bind(this)),e.preventDefault(),e.stopPropagation(),p.default.stop(),p.default.finish()}},onItemDrop:function(e){if(e.item&&e.item.hasAttachmentType(n.a.PluginType.Storage)){var t=e.item.getAttachmentByType(n.a.PluginType.Storage);this.props.threadAttach.getPlugin().notifyAttachLinkedFile(this.props.threadAttach,this.props.message,t,this.onAttachUpdated.bind(this))}},close:function(e,t,i){a.default.Assert(a.default.isBoolean(e),"Must supply a valid value for sendDraft"),a.default.Assert(a.default.isBoolean(t),"Must supply a valid value for discardDraft"),a.default.Assert(a.default.isBoolean(i),"Must supply a valid value for forceFlush"),this._clearDraftDebounce(e,i),this.props.onClose(),!e&&t&&this._discardDraftUpdates()},_clearDraftDebounce:function(e,t){this._draftUpdateDebounce&&(clearTimeout(this._draftUpdateDebounce),this._draftUpdateDebounce=void 0,this._saveDraftUpdates(e,t))},openSubject:function(){this.showSubject.set(!0),setTimeout(function(){this._setFocus(this.refs.subject),this.refs.subject.selectEnd()}.bind(this),0)},openCc:function(){this.showCc.set(!0),setTimeout(function(){this._setFocus(this.refs.cc)}.bind(this),0)},openBcc:function(){this.showBcc.set(!0),setTimeout(function(){this._setFocus(this.refs.bcc)}.bind(this),0)},focusTo:function(){this._setFocus(this.refs.to)},focusBody:function(){this._setFocus(this.refs.body)},_setFocus:function(e){e.isFocused.get()||e.focus()},_createTokensFromAddressText:function(e){var t=[];if(e)for(var i=0,a=0;a<e.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=e[a];n.text?t.push(n):n.email&&t.push({email:n.email,text:n.email})}return{tokens:t}},onClickSend:function(){var e=this.props,t=this.refs,i=function(t,i){t?this.close(!1,!1,!0):(a.default.isHTTPStatusCode(i,n.a.HTTPStatusCode.Network)?a.default.toasts.pushMessage({text:"You are offline. Your message will be sent when Moo.do is open and you are online.",action:MessageAction.Okay,hold:!0}):i&&a.default.toasts.pushMessage({text:"There was an error sending your message. Please try again in a minute.",action:MessageAction.Okay}),this.isSending.set(!1)),c.a.ensureDisplayMessages(e.threadAttach)}.bind(this),s=function(t){t&&(this._clearDraftDebounce(!1,!1),h.default.clearSelection(),this.isSending.set(!0),e.threadAttach.getPlugin().sendDraft(e.threadAttach,e.message.id,e.message.draftID,void 0,i)||this.isSending.set(!1))}.bind(this);t.subject&&!t.subject.getValue()?a.default.menus.confirm("There is no email subject, send anyway?",s):t.body.getValue()?s(!0):a.default.menus.confirm("There is no email body, send anyway?",s)},onDraftChanged:function(){clearTimeout(this._draftUpdateDebounce),this._draftUpdateDebounce=void 0,this._isMounted&&(this._draftUpdateDebounce=setTimeout(this._saveDraftUpdates.bind(this,!0,!1),1e3))},_saveDraftUpdates:function(e,t){if(this._isMounted){var i=this.refs,n=this.props,s=i.to.getTokens(),r=i.cc&&i.cc.getTokens(),o=i.bcc&&i.bcc.getTokens(),l=i.subject&&i.subject.getValue()||this.props.message.subject,d=i.body.getValue()||"(no text)",u=i.body.getTextValue()||"(no text)",c={to:s,cc:r,bcc:o,subject:l,body:d};n.threadAttach.getPlugin().updateDraft(n.threadAttach,n.message.id,n.message.draftID,c,u,e,t,function(e){a.default.Assert(e,"Should always be able to update a draft")}),clearTimeout(this._draftUpdateDebounce),this._draftUpdateDebounce=void 0}},_discardDraftUpdates:function(){this.props.threadAttach.getPlugin().discardDraft(this.props.threadAttach,this.props.message.id,this.props.message.draftID,function(e){a.default.Assert(e,"Should always be able to delete a draft")})},_getComposeBody:function(e){var t;return e&&e.decoded&&(t=u.a.getComposeBody(e.decoded,e.resources)),t},onChangeFrom:function(){var e=this.refs.from.value,t=this.props.threadAttach,i=t.getPlugin(),n=i.getSyncAccount(e),s=i.getSendingAccountInfo(e),r=!!this.props.message.inReplyTo;r?this._clearDraftDebounce(!1,!1):this.close(!1,!1,!1);var o=i.changeMessageAccount(t,this.props.message.id,this.props.message.draftID,n,e,s),l=o?o.threadID:t.id;r||a.default.menus.openComposeEmail(i,l),this.refs.body.setValue(this._getComposeBody(this.props.message))},getSendingAccounts:function(){var e,t=this.props.threadAttach.getPlugin();return this.props.message.inReplyTo&&(e=this.props.threadAttach.getField("accountID")),t.getSendingAccounts(e)},getFromAccount:function(){var e=this.state.fromAccounts;return e.length<2?e[0]:this.refs.from.value},insertLinkHotkey:function(){this.refs.body.hasFocus()&&this.insertLink()},insertLink:function(){var e=h.default.getSelectedText(),t=this.refs.buttonLink.getElement();this.savedSel=h.default.getSelectionRange(),a.default.menus.openContextMenu({componentName:"ReactContextMenuInsertLink",element:t,onClosed:this.onInsertLinkClosed,onInsertLink:this.onInsertLink,text:e})},onInsertLinkClosed:function(){this.savedSel&&(this.refs.body.focus(),h.default.setSelectionRange(this.savedSel))},onInsertLink:function(e){var t=document.createElement("a");t.href=e.url,t.innerText=e.text,this.refs.body.insertNode(t)},render:function(){var e=this.state,t=this.props,i=this.to,n=this.cc,r="(no subject)"===t.message.subject?"":t.message.subject,l=this.state.showCc||this.cc&&this.cc.length>0,d=16+(l?0:28)+(e.showBcc?0:34),u=t.message.from.email,c=e.fromAccounts.slice(0),h=e.fromAccounts.length>1,f={},p=a.default.classNames("emailCompose validDropTarget flexbox flexvert",t.className);c.remove(u),c.unshift(u);var m,S=a.default.classNames("composeHeader c-border-heavy",{showingFrom:e.fromAccounts.length>1});return m={paddingBottom:s.a.getKBSize()},t.hidden&&(f.height=0,f.paddingTop=0,f.overflow="hidden"),o.a.createElement("div",{className:p,style:f,ref:"container",onFocus:this.onFocus,onBlur:this.onBlur,onDrop:this.onFileDrop,onDragEnter:this.onDragEnter,onDragLeave:this.onDragLeave},o.a.createElement("div",{className:S},o.a.createElement("div",{className:"composeButtons"},!e.showSubject&&o.a.createElement(y.a,{height:24,padding:6,onClick:this.openSubject},"Subject"),!l&&o.a.createElement(y.a,{height:24,padding:6,onClick:this.openCc},"Cc"),!e.showBcc&&o.a.createElement(y.a,{height:24,padding:6,onClick:this.openBcc},"Bcc")),o.a.createElement(v.a,{className:"toBox",height:50,floatingText:"To",display:"block",ref:"to",tokens:i.tokens,focused:"to"===this.props.focus,autocompleteMode:"email",padding:{right:0},margin:{right:d},onChange:this.onDraftChanged,onEscape:t.onEscape}),l&&o.a.createElement(v.a,{height:50,floatingText:"Cc",display:"block",ref:"cc",tokens:n.tokens,autocompleteMode:"email",padding:t.paddingInput,onChange:this.onDraftChanged,onEscape:t.onEscape}),e.showBcc&&o.a.createElement(v.a,{height:50,floatingText:"Bcc",display:"block",ref:"bcc",autocompleteMode:"email",padding:t.paddingInput,onChange:this.onDraftChanged,onEscape:t.onEscape}),e.showSubject&&o.a.createElement(v.a,{height:50,floatingText:"Subject",display:"block",ref:"subject",value:r,padding:t.paddingInput,onChange:this.onDraftChanged,onEscape:t.onEscape}),h&&o.a.createElement("div",{className:"composeFrom"},o.a.createElement("span",null,"From"),o.a.createElement("select",{ref:"from",onChange:this.onChangeFrom},c.map(function(e){return o.a.createElement("option",{key:e,value:e},e)})))),o.a.createElement(_.a,{className:"emailComposeTextarea c-border-heavy f1",ref:"body",style:m,onChange:this.onDraftChanged,spellCheck:!0,onEscape:t.onEscape,editable:!e.isSending,richText:!0}),o.a.createElement(g.a,{onUpdate:this.onAttachUpdated,threadAttach:t.threadAttach,message:t.message,editable:!0}),!1,o.a.createElement("input",{type:"file",ref:"picker",className:"hidden",multiple:!0}),e.isDragOver&&o.a.createElement("div",{className:"dropNotice flexbox flex-center"},o.a.createElement("div",{className:"dropBg absFull"}),o.a.createElement("div",{className:"f1 center"},o.a.createElement("div",{className:"icon-attach_file"}),o.a.createElement("div",null,"Drop to attach"))),e.isSending&&o.a.createElement("div",{className:"clickBlocker flexbox flex-center c-bg-faded"},o.a.createElement("div",{className:"f1 center c-foreground"},"Sending...")))}});t.a=S},function(e,t,i){"use strict";var a=function(e,t){this.target=e,this.cb=t,this._disposed=!1};a.prototype={dispose:function(){this._disposed=!0,this.target.unlisten(this.cb)},isDisposed:function(){return this._disposed}},t.a=a},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(16),r=i(11);function o(e,t,i,n,s,r){this.file=e,this.contentType=e.type,this.accountID=t,this.folder=i,this.onComplete=s||a.default.emptyFn,this.onError=r||a.default.emptyFn,this.onProgress=n||a.default.emptyFn,this._callbacks=[],this.offset=0,this.chunkSize=1048576,this._isDone=!1,this._isRunning=!1,this._hasStarted=!1,this._isCanceled=!1,this._hasError=!1;this.url=this._buildURL(void 0,{uploadType:"resumable"}),this._percent=0}o.prototype={upload:function(){var e=this;if(this._hasStarted=!0,a.default.isDemoMode())setTimeout(function(){e.onComplete()},2e3);else if(r.a.isCurrentlyAuthorized("me")){var t=r.a.getDefaultAccessToken();if(t){var i={Authorization:"Bearer "+t,"Content-Type":"application/json","X-Upload-Content-Length":this.file.size,"X-Upload-Content-Type":this.contentType};s.default.getFolder(this.folder,function(t){var s,r={title:e.file.name,mimeType:e.contentType,parents:t?[{id:t}]:[]};try{s=JSON.stringify(r)}catch(e){a.default.reportError(e)}s?a.default.XHR({url:e.url,type:"POST",headers:i,data:s,autoRetry:!0,cb:function(t){if(t.status<n.a.HTTPStatusCode.BadRequest){var i=t.getResponseHeader("Location");e.url=i,e._runUpload()}else e._onError(t)}}):e._onError()})}}else this._onError()},_runUpload:function(){a.default.Assert(this.url,"Must have a valid remote URL to run upload"),this._isRunning=!0;var e=Math.min(this.offset+this.chunkSize,this.file.size),t=this.file.slice(this.offset,e),i={"Content-Type":this.contentType,"Content-Range":"bytes "+this.offset+"-"+(e-1)+"/"+this.file.size,"X-Upload-Content-Type":this.contentType};a.default.XHR({url:this.url,type:"PUT",headers:i,data:t,autoRetry:!0,cb:function(e){if(e.status===n.a.HTTPStatusCode.Success||e.status===n.a.HTTPStatusCode.Created)this.isCanceled()||this._onComplete(e);else if(e.status===n.a.HTTPStatusCode.PermRedirect){var t=this._extractRange(e.getResponseHeader("Range"));this.offset=t,this._onProgress(this.offset/this.file.size),this.isCanceled()||this._runUpload()}else this._onError(e)}.bind(this)})},resume:function(){if(a.default.Assert(!this.isDone(),"Should not resume a completed upload"),a.default.Assert(this._hasStarted,"Must have started an upload to resume it"),a.default.Assert(this.url,"Must have a valid remote URL to resume upload"),this._hasError=!1,this._isCanceled=!1,this._isRunning)0;else if(this._isRunning=!0,this._hasStarted&&this.url){var e={"Content-Range":"bytes */"+this.file.size,"X-Upload-Content-Type":this.contentType};a.default.XHR({url:this.url,type:"PUT",headers:e,autoRetry:!0,cb:function(e){if(e.status===n.a.HTTPStatusCode.PermRedirect){var t=this._extractRange(e.getResponseHeader("Range"));this.offset=t,this._onProgress(this.offset/this.file.size),this._runUpload()}else this._onError(e)}.bind(this)})}else this.upload()},cancel:function(){a.default.Assert(!this._isDone,"Cannot cancel an upload that is already complete"),this._isCanceled=!0,this._isRunning=!1},_onError:function(e){this._hasError=!0,this._isRunning=!1,this.onError()},_onComplete:function(e){var t=0;a.default.Assert(!this._isDone,"Should not call the complete CB twice"),a.default.Assert(!this._isCanceled,"Should not be able to complete a canceled upload"),this._isDone=!0,this._isRunning=!1;var i={};if(e&&e.response)try{i=JSON.parse(e.response)}catch(e){a.default.reportError(e)}this._onProgress(1),this.onComplete(i);for(var n=0;n<this._callbacks.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;try{this._callbacks[n](i)}catch(e){a.default.reportError(e)}}this._callbacks=[]},_onProgress:function(e){a.default.Assert(!this._hasError,"Should not make forward progress when an error has occurred"),this._percent=e,this.onProgress(e)},_extractRange:function(e){return a.default.parseInt(e.match(/\d+/g).pop())+1},_buildQueryString:function(e){return e=e||{},Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")},_buildURL:function(e,t){var i="https://www.googleapis.com/upload/drive/v2/files/";e&&(i+=e);var a=this._buildQueryString(t);return a&&(i+="?"+a),i},notifyOnComplete:function(e){a.default.Assert(this._callbacks.indexOf(e)<0,"Should not include fn twice"),a.default.Assert(!this.isDone(),"Should not notify on complete after done"),a.default.Assert(!this.hasError(),"Should not notify on complete after error"),this._callbacks.push(e)},isCanceled:function(){return this._isCanceled},isDone:function(){return this._isDone},isRunning:function(){return this._isRunning},hasError:function(){return this._hasError},getPercent:function(){return this._percent}},t.a=o},function(e,t,i){"use strict";var a=i(8),n=i(35);function s(){this.isLive=!1,this.wasLive=!1,this.seenInPass=!1,this.deadNeedsNotify=!1,this.index=-1,this.width=0,this.height=0,this.offset=0,this.paneObject=void 0,this.cellChanged=new n.a,this.offsetChanged=new n.a,this.offsetX=new a.a(0),this.isAnimatingOffsetX=!1}s.prototype={kill:function(e){this.isLive=!1,this.index=-1,this.isAnimatingOffsetX=!1,e?(this.deadNeedsNotify=!1,this.cellChanged.notify()):this.deadNeedsNotify=!0},update:function(e,t,i,a,n,s){this.seenInPass=!0,this.wasLive=this.isLive,this.deadNeedsNotify=!1,this.isAnimatingOffsetX=!1;var r=!this.isLive||t!==this.width||i!==this.height||s!==this.paneObject;(r||e!==this.index||a!==this.offset)&&(this.isLive=!0,this.index=e,this.width=t,this.height=i,this.paneObject=s,this.offset=a,this.prevOffset=n,r?this.cellChanged.notify():this.offsetChanged.notify())},getState:function(){return{item:this.paneObject&&this.paneObject.id,index:this.index,height:this.height,offset:this.offset,prevOffset:this.prevOffset,deadNeedsNotify:this.deadNeedsNotify,isLive:this.isLive}}},t.a=s},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(4),r=i(2),o=i.n(r),l=i(12),d=(i(32),i(14)),u=i(22),c=i(10),h=l.a.createClass({displayName:"FancyProgressBar",componentDisplay:n.a.ComponentDisplay.Desktop,render:function(){var e=this.props,t={height:e.height},i={};i[s.a.transform.react]="scale("+e.percent+", 1)";var a={lineHeight:e.height-2+"px"};return o.a.createElement("div",{className:"fancyProgressBar",style:t},!e.error&&o.a.createElement("div",{className:"fancyProgressInside",style:i}),e.error&&o.a.createElement("div",{className:"fancyProgressError",style:a},e.errorMsg))}}),f=l.a.createClass({displayName:"ReactMessageAttachments",componentDisplay:n.a.ComponentDisplay.Everywhere,init:function(){this.props.threadAttach.subscribe(this)},onUnmount:function(){this.props.threadAttach.unsubscribe(this)},onAttachmentUpdate:function(){this.updateState()},onAttachmentIDChange:function(){},getState:function(){return{attachments:this.props.threadAttach.getPlugin().getMessageDisplayAttachments(this.props.message)}},isAttachImage:function(e){var t=e.mimeType;return"image/png"===t||"image/jpg"===t||"image/jpeg"===t||"image/gif"===t},onClickAttach:function(e,t){if(e.error)e.uploader&&!e.uploader.isDone()&&e.uploader.resume();else if(!e.uploader||e.uploader.isDone()){var i=this._getURL(e);this.props.editable?a.default.openUrl(i):e.attID?(!(s.a.mac&&t.metaKey||!s.a.mac&&t.ctrlKey)&&this.isAttachImage(e),a.default.downloadFile(i,e.cid)):a.default.openUrl(i)}t.stopPropagation()},onClickDelete:function(e,t){var i=this.props.threadAttach.getPlugin().removeAttachFiles(this.props.threadAttach,this.props.message,e);this.props.onUpdate&&this.props.onUpdate(i),t.stopPropagation()},onAttachDragStart:function(e){var t=e.target.getAttribute("data-downloadurl");e.stopPropagation(),e.dataTransfer.setData("DownloadURL",t),d.default.setExternalData(t)},_getURL:function(e){return this.props.editable||!e.attID?u.a.getPreviewURL(e):u.a.getAttachmentURL(this.props.threadAttach.getField("accountID"),this.props.message.id,e.attID)},_renderAttachment:function(e){var t=e.mimeType+":"+e.cid+":"+this._getURL(e),i=e.uploader?a.default.clamp(e.uploader.getPercent(),.05,1):1,n=this.isAttachImage(e)?"Click to open image.\n"+s.a.priModKey+" click to download image.":"Click to download image";return o.a.createElement("div",{key:e.id,className:"messageAttachment flexbox c-button-raised",draggable:!0,"data-downloadurl":t,onClick:this.onClickAttach.bind(this,e),onDragStart:this.onAttachDragStart,"data-tooltip":n},o.a.createElement("div",{className:"attachmentIcon icon-drive-file"}),o.a.createElement("div",{className:"attachmentText"},e.cid),o.a.createElement("div",{className:"f1"}),i<1&&o.a.createElement(h,{percent:i,height:22,error:e.error,errorMsg:"Click to retry"}),1===i&&e.error&&o.a.createElement("div",null,"ERROR"),o.a.createElement("div",{className:"attachmentSize"},a.default.toFileSize(e.size)),this.props.editable&&o.a.createElement(c.a,{className:"attachmentClose",icon:"icon-close",onClick:this.onClickDelete.bind(this,e),tooltip:"Remove"}))},render:function(){var e=null,t=this.state.attachments;if(t.length>0){for(var i=0,a=[],n=0;n<t.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=t[n];a.push(this._renderAttachment(s))}e=o.a.createElement("div",{className:"messageAttachments c-border"},a)}return e}});t.a=f},function(e,t,i){"use strict";var a=i(0),n=i(5),s=i(4),r=i(16),o=i(6);t.a=function(e){function t(e){window.gapiLoadError=!0,window.pendingGoogleClientLoad=!1,a.default.reportError(new Error("Google API Load Error"+arguments.length),e)}function i(e){window.gapiTimeout=!0,window.pendingGoogleClientLoad=!1,a.default.reportError(new Error("Google API Load Timeout"),e)}function l(){if(window.pendingGoogleClientLoad=!1,!gapiCalled)if(gapiCalled=!0,gapi.auth.init(),window.location.hash.indexOf("offline=true")>=0||window.location.hash.indexOf("offline%22:true")>=0||window.location.hash.indexOf('offline":true')>=0||window.location.hash.indexOf("demo=true")>=0)log("%cOffline","color: pink");else{if(ShouldLog(LogLevels.Timing)&&log("GAPI Callback - Loaded:",log.now()),ShouldLog(LogLevels.Timing)&&log("Drive-Realtime API - Loaded: ",window.performance.now()),window.gapi&&window.gapi.drive&&window.gapi.drive.realtime)a.default.blockedMessage="",e();else{var t;window.gapiCalled=!1,window.gapiLoadError=!0,t=gapi?gapi.drive?gapi.drive.realtime?"all exist":"gapi.drive.realtime":"gapi.drive":"gapi";var i=function(e){a.default.isBlocked=!0,s.a.app||e?(a.default.reportError(new Error("Error loading GAPI: "+t)),a.default.blockedMessage="There was an error loading the Google APIs."):(a.default.reportError(new Error("Extension blocked gapi from loading: "+t)),a.default.blockedMessage="An extension has blocked apis.google.com from loading."),a.default.vmMain&&a.default.vmMain.gdriveStatus(DriveStatus.Offline)};a.default.XHR({type:"GET",timeout:7e3,url:"https://api.moo.do/private/v1/info",cb:function(e){var t=!1;if(200===e.status){var a;try{!0===(a=JSON.parse(e.response)).success&&0===a.data.indexOf("Moo.do")&&(t=!0)}catch(e){}i(!t)}else i(!0)}})}if(window.gapi&&window.gapi.auth){ShouldLog(LogLevels.Timing)&&log("Goog Callback - Loaded: ",log.now()),a.default.fireCustomEvent("gapiLoaded");var l=!1;s.a.ie,l=r.default.checkTokenInHash();var d=n.a.hasURLParam("login","true"),u=n.a.hasURLParam("user"),c=l||d||u||a.default.getLoginState()==LoginState.LOGGED_IN,h=!1;if(u){var f=n.a.getURLParam("user"),p=a.default.getActiveUser();n.a.removeURLParam("user",!0),f!==p&&(a.default.setActiveUser(f),void 0!==p&&(o.default.clearData(function(){a.default.reload()},{Default:[Settings.activeUser]}),h=!0))}h||r.default.runAuthenticate(r.default.requiredScopes,!0,!1,function(t){ShouldLog(LogLevels.Timing)&&log("Goog Authorized - Callback: ",log.now()),d&&n.a.removeURLParam("login",!0),t&&!t.error?c&&(a.default.vmSetup?a.default.vmSetup.setLoginState(LoginState.LOGGED_IN):a.default.setLoginState(LoginState.LOGGED_IN),e()):a.default.vmSetup?a.default.vmSetup.setLoginState(LoginState.LOGGED_OUT):a.default.setLoginState(LoginState.LOGGED_OUT)})}else a.default.Assert(!1,"Failed to load GAPI auth lib properly")}}if(window.gapiKey="AIzaSyB9HEdSJ-nhLJG_ssSSqhI2DX74GSiKSao",window.gapiCalled=!1,window.gapiLoadError=!1,window.gapiTimeout=!1,window.gapiClientCalled=!1,window.gapiClientLoadError=!1,window.gapiClientTimeout=!1,window.pendingGoogleClientLoad=!1,window.GoogleClientAPILoaded=function(e){window.gapiClientCalled=!0,window.gapi?window.pendingGoogleClientLoad||(window.pendingGoogleClientLoad=!0,gapi.load("client:drive-realtime",{callback:l,onerror:t,timeout:2e4,ontimeout:i})):a.default.reportError(new Error("Google Client API Load Failed"),e)},window.location.hash.indexOf("demo=true")<0){var d=document.createElement("script");d.src="https://apis.google.com/js/api.js?onload=GoogleClientAPILoaded",d.async=1,d.id="gapiScript",d.onloadDone=!1;var u=setTimeout(function(){window.gapiCalled||(window.gapiClientTimeout=!0,a.default.blockedMessage||(a.default.blockedMessage="An extension has blocked apis.google.com from loading."))},2e4);d.onerror=function(e){window.gapiClientLoadError=!0,clearTimeout(u),a.default.reportGapiScriptError(d,e)},d.onload=function(e){d.onloadDone=!0,clearTimeout(u),a.default.reportGapiScriptLoad(d,e)},d.onreadystatechange=function(e){"loaded"!==d.readyState||d.onloadDone||(d.onloadDone=!0,a.default.reportGapiScriptLoad(d,e))},document.getElementsByTagName("head")[0].appendChild(d)}}},function(e,t,i){"use strict";i.r(t);var a=i(0),n=i(1),s=i(4),r=i(33),o=i(7),l=i(54),d=i(3);function u(e){if(Array.isArray(e)){for(var t=0,i=0,a=Array(e.length);i<e.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;a[i]=e[i]}return a}return Array.from(e)}function c(){}var h=n.a.Regexp.Prefix;c.prototype={init:function(){a.default.Assert("complete"===document.readyState||"interactive"===document.readyState,"Setting up copy/paste too early"),document.body.addEventListener("paste",this.handlepaste.bind(this),!1),document.body.addEventListener("cut",this.handlecut.bind(this),!1),document.body.addEventListener("copy",this.handlecopy.bind(this),!1)},killEvent:function(e){a.default.Assert(e.preventDefault,"Should always be defined"),a.default.Assert(e.stopPropagation,"Should always be defined"),e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()},parseTextForPrefix:function(e){var t,i;return h.lastIndex=0,null!==(t=h.exec(e))&&(i=t[1],e=e.substr(t[0].length)),{prefix:i,text:e}},insertToNote:function(e,t,i){a.default.Assert(e,"Must have a valid start item"),a.default.Assert(t,"Must have a valid end item");var n,s=e.getParsedText();o.a.beginAction(),n=t===e?s.substring(0,d.a.getStartOffset())+i+s.substring(d.a.getEndOffset()):s.substring(0,d.a.getStartOffset())+i,e.setText(n,!0,ChangeType.Local),o.a.endAction()},insert:function(e,t,i){if(!d.a.isValid()||a.default.elementInNonPaneEdit(t.target))return!1;var n,u,c,h="",f=a.default.focusedPane,p=s.a.ie?"Text":"text/plain";if(i===DataSource.Plugin)c={items:[{text:e}]};else if(e&&e.getData){if(o.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.Paste}),this.killEvent(t),h=s.a.ie?void 0:e.getData("moodo/html")||e.getData("text/html"),!s.a.ie&&h){if(!h)return void 0;var g,m=document.createElement("div"),v=h.replace(/[\n\t]/g," ").replace(/[\r]|<head(.|\s)*?\/head>|<script(.|\s)*?\/script>|<style(.|\s)*?\/style>/g,"").replace(/[ ]+/g," ").replace(/•/g,"").replace(/onload/gi,"never");if((g=/<body(.|\s)*?\/body>/g.exec(v))&&(v=g[0]),m.innerHTML=v,d.a.isValid()&&d.a.getStartItem().isNote())this.insertToNote(d.a.getStartItem(),d.a.getEndItem(),m.innerText);else{var _=m.children[0];2===m.children.length&&"A"===_.nodeName&&a.default.isOneNoteLink(_.href)&&(m.innerHTML=_.outerHTML),1===(c=l.a.traverseDOM({root:m,shouldPrint:!1,stripParents:!0,preserveWhitespace:!s.a.ie&&e.getData("moodo/html")})).items.length&&""===c.items[0].text&&(c=c.items[0])}}else if(h=e.getData(p)){0;var y,S=h.startsWith("<?xml "),w=h.startsWith("<?opml ")||h.startsWith("<opml ")||S&&h.indexOf("<opml ")>=0;if((S||w)&&(y=a.default.loadXML(h)),y){if(S&&!w)return a.default.toasts.pushMessage({text:"We currently do not support pasting XML, please contact support@moo.do.",action:MessageAction.Contact,hold:!0}),!1;if(w)return l.a.parseOPML(y,"OPML Import"),!1}else{if(h.startsWith("{")&&h.endsWith("}"))try{var I=JSON.parse(h);if(l.a.parseJSON(I,d.a.getStartItem().parent()))return!1}catch(e){}var b=a.default.parseEvernoteLink(h),A=a.default.isBearLink(h);if(b||A){var D=d.a.save(),T="Enter title of "+(b?"Evernote":A&&"Bear")+" document";return void a.default.menus.prompt(T,function(e){e&&(h="["+e+"]("+h+")"),d.a.restore(D),this.insert(h,t,DataSource.Plugin)}.bind(this))}a.default.isUrlImage(h)&&a.default.settings.showImagesInline()&&(h="!"+h);v=h.replace(/[\t]/g,"    ");if(d.a.getStartItem().isNote())this.insertToNote(d.a.getStartItem(),d.a.getEndItem(),v);else{var M=v.split("\n");c=l.a.parseText(M)}}}else{if(e&&e.items&&e.items.length>0)return a.default.vmMain.pluginManager.handleDropEvent(t,function(e){o.a.beginAction();var t=d.a.getStartItem(),i=t.parent(),a=f.createVMLI({text:e},{parent:i,changeType:ChangeType.AllLocal});i.insertItem(a,t.getIndex()+1),o.a.endAction()}),!1;a.default.Assert(!1,"Paste with unexpected data type",e.types)}if(!c||!c.items||0===c.items.length)return!1}if(c){o.a.beginAction(),a.default.vmMain.beginUpdateItems();var C=!0,L=d.a.getStartOffset(),P=d.a.getStartItem(),E=d.a.getEndItem(),k=d.a.getStartItem().parent(),x=d.a.getStartItem().getIndex(),R=d.a.getStartItem().getParsedText(),O=d.a.getEndItem().getParsedText();if(P!==E&&(E.isNote()&&(E=E.parent()),P!==E&&r.default.handleMultiselect({normCode:KeyCode.Backspace,preventDefault:a.default.emptyFn,stopPropagation:a.default.emptyFn,stopImmediatePropagation:a.default.emptyFn})),n=P,1!==c.items.length||c.items[0].items&&0!==c.items[0].items.length)if(f.isViewAgenda())a.default.toasts.pushMessage({text:"Pasting multiple items into the agenda is not supported. Please try pasting into an Outline pane.",actionText:"OKAY"}),C=!1;else{var F=0,N=0;ShouldLog(LogLevels.Timing)&&console.time("paste"),f.clearPreventUpdate();var B=[],U=!P.hasChildren()&&d.a.getStartOffset()>=0&&d.a.getEndOffset()<=O.length;!U&&d.a.getStartOffset()>0&&x++;for(var V=0;c&&V<c.items.length;++V){if(F++>5e3&&__infLoop&&__infLoop(F))throw new RangeError;var H=c.items[V],q=this.parseTextForPrefix(H.text);if(""!==H.text||H.items)if(0===V&&U){if(H.text=R.substring(0,L)+(L>0?q.text:H.text),P.setText(H.text,!0,ChangeType.Local),o.a.performAction(TrackerType.Insert,{itemID:P.id,position:0,text:H.text}),x++,H.items){for(var z=0,W=0;W<H.items.length;++W){if(z++>5e3&&__infLoop&&__infLoop(z))throw new RangeError;var G=H.items[W];if(""!==G.text||G.items)if(G.isNote){var j=f.createVMLI({text:G.text,isNote:!0},{parent:P,changeType:ChangeType.AllLocal});P.setNote(j,ChangeType.Local)}else{var K=f.createVMLI(G,{parent:P,changeType:ChangeType.AllLocal});P.insertItem(K),n=K}}B.indexOf(P)<0&&B.push(P)}}else{var Y=void 0;H.isNote?(Y=f.createVMLI({text:H.text,isNote:!0},{parent:k,changeType:ChangeType.AllLocal}),k.setNote(Y,ChangeType.Local)):(Y=f.createVMLI(H,{parent:k,changeType:ChangeType.AllLocal}),k.insertItem(Y,x++,!0),n=Y),B.indexOf(k)<0&&B.push(k),o.a.performAction(TrackerType.Create,{itemID:Y.id,parent:k.id,position:x-1,text:Y.getParsedText()})}}for(;n.hasChildren();){if(N++>5e3&&__infLoop&&__infLoop(N))throw new RangeError;n=n.getLastChild()}u=n.getParsedText().length,U&&n.setText(n.getParsedText()+O.substring(d.a.getEndOffset()),!0,ChangeType.Local)}else{var X=c.items[0].text,Q=L>0?this.parseTextForPrefix(X).text:X,J=R.substring(0,L),Z=O.substring(d.a.getEndOffset());!J.length||J.endsWith(" ")||Q.startsWith(" ")||(Q=" "+Q),!Z.length||Q.endsWith(" ")||Z.startsWith(" ")||(Q+=" ");var $=J+Q+Z;o.a.performAction(TrackerType.Remove,{itemID:P.id,position:0,text:P.getParsedText()}),P.setText($,!0,ChangeType.Local),o.a.performAction(TrackerType.Insert,{itemID:P.id,position:0,text:$}),u=d.a.getStartOffset()+Q.length}a.default.vmMain.commitUpdateItems(),o.a.endAction(),ShouldLog(LogLevels.Timing)&&console.timeEnd("paste")}return C&&n&&(d.a.selectItem(n,u),a.default.focusedPane.scrollItemIntoView(n,ScrollDuration.Snap)),!1},handlepaste:function(e){var t=e&&e.clipboardData?e.clipboardData:e.synthetic?e.data:window.clipboardData;return this.insert(t,e,DataSource.Paste)},handlecut:function(e){var t=!0;if(d.a.isValid()){var i=d.a.getStartIndex(),n=d.a.getStartItem(),s=i===d.a.getEndIndex()&&d.a.getStartOffset()===d.a.getEndOffset();a.default.vmMain.beginUpdateItems(),s&&d.a.setSelection(i,0,i,n.getParsedText().length),!this.handlecopy(e)&&(s?a.default.focusedPane.deleteSelected():r.default.keydown(void 0,{normCode:KeyCode.Backspace,preventDefault:a.default.emptyFn,stopPropagation:a.default.emptyFn,stopImmediatePropagation:a.default.emptyFn}),t=!1),a.default.vmMain.commitUpdateItems()}return t},padText:function(e,t){for(var i=0,a=0;a<t;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;e="    "+e}return e},printLI:function(e,t,i){var a,n=e.getParsedText(),s=e.getPrefix(),r=[],o=e.priority();if(t=t||0,n=isNaN(i)?n.substring(t):n.substr(t,i-t),t>=s.length&&(n=s+n),e.hasAttachments()){var l=0;if(!isNaN(t)&&t>0)for(var d=0,u=e.getParsedText(),c=0;c<t;++c){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;u[c]===window.AttachChar&&l++}a=e.generateExportText(n,l),n=e.generateTitleText()}else e.isNote()?(r.push("note"),a=n):a=n;o&&(o===VMLIFlag.P0?r.push("high"):o===VMLIFlag.P1?r.push("medium"):o===VMLIFlag.P2&&r.push("low")),e.isComplete()&&r.push("complete"),e.isStarred()&&r.push("starred");var h=s.length?n.substr(s.length):n;return{html:"<li"+(r.length>0?' class="'+r.join(" ")+'"':"")+">"+h+"</li>",plain:h,moodo:"<li"+(r.length>0?' class="'+r.join(" ")+'"':"")+">"+a+"</li>"}},handlecopy:function(e){var t=a.default.focusedPane,i=s.a.ie?"Text":"text/plain",n=e&&e.clipboardData?e.clipboardData:window.clipboardData;if(n){a.default.findParent(e.target,"exportedArea",10);var r=0,l=0,c=0;if(!d.a.isValid())return!0;if(!d.a.getPane().overrideCopyBehavior)return!0;var h=d.a.getStartItem(),f=d.a.getStartIndex(),p=d.a.getEndItem(),g=d.a.getEndIndex();a.default.Assert(h&&p,"Must have valid item selections"),a.default.Assert(a.default.isVMLI(h)&&a.default.isVMLI(p),"Items must be valid VMLIs");var m,v,_=!s.a.ie,y="<ul>",S="",w="<ul>",I=1,b=[],A=h,D=f,T=h;do{if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;if(T!==v&&(b.push({index:D,item:T}),T.isCollapsed(t))){var M=0;T.hasNote()&&(v=T.getNote(),b.push({item:v,index:D+1}));for(var C=T.getItems().slice(0);C.length>0;){if(M++>5e3&&__infLoop&&__infLoop(M))throw new RangeError;var L=C.shift(),P=L.getItems();b.push({item:L}),L.hasNote()&&b.push({item:L.getNote()}),C.splice.apply(C,[0,0].concat(u(P)))}}(D=t.indexOfNextVMLI(D))>=0&&(T=t.itemAtIndex(D))}while(D>=0&&D<=g);for(var E=0;E<b.length;E++){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;var k=b[E],x=(k.index,k.item);if(x){var R,O,F=0;if(A){var N=x.levelsDeep.get()-A.levelsDeep.get();x.parent()===A&&N>0&&(y+="<ul>",w+="<ul>",I++)}for(var B=0;B<Math.min(I,-N);B++){if(F++>5e3&&__infLoop&&__infLoop(F))throw new RangeError;y+="</ul>",w+="</ul>",I--}I<=0&&(y+="<ul>",w+="<ul>",I++),(b.length>1||d.a.getStartOffset()!==d.a.getEndOffset())&&(R=0===E?d.a.getStartOffset():0,O=E===b.length-1?d.a.getEndOffset():void 0),m=this.printLI(x,R,O),S+=(S?"\r\n":"")+this.padText(m.plain,I-1),y+=m.html,w+=m.moodo}A=x}for(y+="</ul>",w+="</ul>",I--;I>0;){if(c++>5e3&&__infLoop&&__infLoop(c))throw new RangeError;y+="</ul>",w+="</ul>",I--}_&&y&&n.setData("text/html",y),_&&w&&n.setData("moodo/html",w),n.setData(i,S)}return s.a.ios||this.killEvent(e),o.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.Copy}),!1}},t.default=new c},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(5),r=i(4),o=i(6),l=i(7),d=i(8),u=i(35),c=(i(13),i(3)),h=i(30),f=i(19),p=i(31),g=n.a.MatchState;function m(e,t,i){var n=0;this.callback=i,this.pane=e,this.searchArr=[],this.prevMatches={},this.matches={},this.previousSearch="",this._stickyMatches={},this._stickyMatchesAwaitingClear=[],this.itemStoreFilter=void 0,this._savedItemsArray=void 0,this._needsBatchedSearch=!1,this.UI=void 0,this.isFocused=new d.a,this._destroyed=!1,s.a.binder(this,"isMatched","checkChildrenParams","hideNonMatches","handleItemTextChanged","clearMatchForItem","update");var r={priority:{name:"priority",matchFn:this._matchFnPriority.bind(this)},starred:{name:"starred",initialValue:1,icon:"icon-star",tooltip:"starred items",matchFn:this._matchFnStarred.bind(this)},project:{name:"project",initialValue:1,icon:"icon-project",tooltip:"projects",matchFn:this._matchFnProject.bind(this)},task:{name:"task",initialValue:1,icon:"prefixTask",tooltip:"tasks",matchFn:this._matchFnTask.bind(this)},complete:{name:"complete",text:"Completed Items",initialValue:-1,defaultValue:-1,icon:"icon-check",tooltip:"completed items",matchFn:this._matchFnComplete.bind(this)},showOnlyMatches:{name:"showOnlyMatches",initialValue:1,icon:"icon-reorder",tooltip:"Flat mode: Show only matching items",canBeNegated:!1,isOption:!0},showOnlyAgendaDates:{name:"showOnlyAgendaDates",initialValue:1,icon:"icon-at",tooltip:"Show only dates on the Agenda",canBeNegated:!1,isOption:!0},showOnlyMatchingTags:{name:"showOnlyMatchingTags",initialValue:1,icon:"icon-short_text",tooltip:"Show only matching tag blocks",canBeNegated:!1,isOption:!0},showChildProjects:{name:"showChildProjects",initialValue:1,icon:"icon-project_half",tooltip:"Show all projects from anywhere in the hierarchy",canBeNegated:!1,isOption:!0}};if(t){!1===t.showHierarchy&&(t.showOnlyMatches=1);var l=t.completeOption;!isNaN(l)&&isNaN(t.complete)&&(t.complete=l<0?1:l-1),0===t.showOnlyTopLevelProjects&&(t.showChildProjects=1)}for(var c=[],p=0;p<e.searchFilters.length;p++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var g=e.searchFilters[p];a.default.isString(g)?c.push(r[g]):c.push(g)}if(this.setupFilters(c,t),this.filterDate=void 0,this.value=t&&t.text||"",this.onChanged=new u.a(i),this._updateSearchArr(),this.value){var m=h.a.parseText(this.value,null,null,null,f.a.getCurrentDateFormat(),null,null,o.default.contactManager.getContacts(),!0,!0,!0);m&&this.onParsed(m)}}m.prototype={destroy:function(){this._destroyed=!0,this.onChanged.unlisten(this.callback),this.pane=void 0,this.UI=void 0,s.a.destroy(this)},setFilterTooltip:function(e,t){this.getFilter(e).tooltip=t},getFilterTooltip:function(e){var t=e.value.get();return t?e.isOption?"<b>Click</b> to clear this option":(t>0?"Showing only":"Hiding")+" "+e.tooltip+".\n<b>Click</b> to clear this "+(e.isOption?"option":"filter."):e.isOption?e.tooltip:"<b>Click</b> to "+(e.initialValue>0?"show only ":"hide ")+e.tooltip+(t!==-e.initialValue?".\n<b>"+r.a.priModKey+" + click</b> to "+(e.initialValue<0?"show only ":"hide ")+e.tooltip+".":"")},setupFilters:function(e,t){for(var i=0,n=[],s=0;s<e.length;s++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=e[s],o=r.name,l=t?t[o]:void 0;r.value=new d.a(isNaN(l)?r.defaultValue||0:l),r.enabled=new d.a(void 0===r.enabled||r.enabled),a.default.Assert(!this.hasOwnProperty("filter_"+o),"Should not double define filter properties"),this["filter_"+o]=r,n.push(r)}this.filters=n},setFilterEnabled:function(e,t){var i=this.filters.indexOfWithProperty("name",e);i>=0&&this.filters[i].enabled.set(t)},getValue:function(){return this.value},isFiltered:function(){for(var e=0,t=0;t<this.filters.length;t++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;if(this.filters[t].value.get())return!0}return!1},getRemoteValue:function(){for(var e=0,t=this.value,i=0;i<this.filters.length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var a=this.filters[i];if(a.remoteStringFn&&a.enabled.get()){var n=a.remoteStringFn(a.value.get());n&&(t+=" "+n)}}return t.trim()},getState:function(){for(var e=0,t={text:this.getValue(),showHierarchy:this.showHierarchy()},i=0;i<this.filters.length;i++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var a=this.filters[i];t[a.name]=a.value.get()}return t},focus:function(){this.UI.focus()},blur:function(){this.UI.blur()},onParsed:function(e){var t=e.dates&&e.dates[0];t===this.filterDate||t&&a.default.isDateSoft(t.text)||(this.filterDate=t),this.searchSpecialDate=e.searchSpecialDate,this.tags=e.tags,this.contacts=e.contacts},setValue:function(e){this.updatingValue=this.value!==e,this.updatingValue&&this.pane.clearPerPaneStateSearch(),this.value=e,this._updateSearchArr(),this.pane.getItemStore().numItems>5e3?this._needsBatchedSearch||(setTimeout(this.update,150,!0),this._needsBatchedSearch=!0):this.update(!0),e&&l.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SearchChanged,data:this.getState()}),this.updatingValue=!1},addToValue:function(e){var t=this.getSelectionOffset(),i=this.value;"-"!==i[i.length-1]&&"!"!==i[i.length-1]&&(e=" "+e),i+=e,this.setValue(i),this.setSelectionOffset(t+e.length)},toggleText:function(e,t){var i=this.value.trim(),n="\\B(-*)("+a.default.escapeRegExp(e.toLowerCase())+")\\b",s=i.toLowerCase().match(n);s?(!s[1]&&t||s[1],i=(i.substr(0,s.index)+i.substr(s.index+s[0].length)).replace(/  +/g," ")):i+=" "+(t?"-":"")+e;i=i.trim(),this.setValue(i),a.default.isKeyboardOpen&&this.setSelectionOffset(i.length)},getSelectionOffset:function(){return this.UI.getSelectionOffset()},setSelectionOffset:function(e){this.UI.setSelectionOffset(e)},getSearchBox:function(){return this.UI.refs.searchBox},isSearched:function(){var e=0;if(this.value.length>0)return!0;for(var t=0;t<this.filters.length;t++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this.filters[t];if(i.enabled.get()&&i.value.get())return!0}},reset:function(){this.setValue("")},resetFilters:function(){for(var e=0,t=0;t<this.filters.length;t++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;this.filters[t].value.set(0)}this.update(!0,!0)},numUnmatchedItems:function(){var e=this,t=0,i={item:this.pane.getItem(),each:function(i){var a=i.id,n=e.matches[a];n!==g.No&&n!==g.Negated||t++}};return a.default.searchVMLIs(i),t},isFlatSearchResult:function(e){return!this.showHierarchy()&&this.matches[e.id]===g.Yes},isMatchStateMatch:function(e){return void 0===e||e===g.Yes||e===g.ChildYes||e===g.Unknown},isMatched:function(e,t){if(this.pane.supportLocalSearch){var i=this.matches[e.id];return t||void 0!==i||!e.hasText()||this.pane.isSettingText||this.pane===a.default.focusedPane||(i=this.checkItem(e)),this.isMatchStateMatch(i)}return g.Yes},handleItemChanged:function(e){if(a.default.vmMain.paneManager.isPaneActive(this.pane.id)){this.prevMatches[e.id]=this.matches[e.id];var t=this.isMatched(e,!0);this.clearMatchForItem(e);var i=this.isMatchStateMatch(this.checkItem(e,{ignoreStuck:!0}));if(!i&&t&&this.stickMatchAfterSearch(e,!0),i!=t)return!0}},handleItemTextChanged:function(e){if(this.getValue()||this.isFiltered())return this.handleItemChanged(e)},_updateSearchArr:function(){var e=0,t=this.value.toLowerCase().trim().split(/\s+/);this.searchArr=[],this.searchWords=[];for(var i=0,a=0;a<t.length;++a){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var n=t[a].startsWith("-"),s=n?t[a].substr(1):t[a];s&&"and"!==s&&"-"!==s&&"$"!==s&&(a>0&&("or"===s||"|"===s||"||"===s)?i++:(this.searchArr[i]||(this.searchArr[i]=[]),this.searchArr[i].push({text:s,isNegated:n}),n||this.searchWords.push(s)))}},toggleFilterDefault:function(e){var t=this["filter_"+e],i=t.value.get();i=i?0:t.initialValue,this.setFilter(e,i)},toggleFilter:function(e,t){var i=t?-1:1,a=this["filter_"+e].value.get();a=a===i?0:i,this.setFilter(e,a)},getFilter:function(e){return this["filter_"+e]},getFilterObs:function(e){var t=this["filter_"+e];return t?t.value:void 0},getFilterValue:function(e){var t=this["filter_"+e];return t?t.value.get():void 0},setFilter:function(e,t,i){"showOnlyMatches"===e&&this.clearListCache(),this["filter_"+e].value.set(t,i),this.update(!0,!0),l.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SearchChanged,data:this.getState()})},update:function(e,t,i){var s=this;this._needsBatchedSearch&&(this._needsBatchedSearch=!1),this.isRunningSearch=!0,a.default.vmMain.beginUpdateItems(),(e||t)&&this.clearStickyMatches(),this.pane.supportLocalSearch&&(e&&(this.prevMatches=this.matches,this.matches={}),this.isAnimatingSearch=i&&!e&&a.default.focusedPane===this.pane,this.checkChildren()),this.isUpdatingSearch=!0,this.pane.isLoaded&&e&&(a.default.vmMain.setItemAnimationMode(n.a.ItemAnimationMode.None),this.onChanged.notify(t)),a.default.vmMain.commitUpdateItems(),setTimeout(function(){s.isUpdatingSearch=!1,a.default.vmMain.resetItemAnimationMode()},0),this.isRunningSearch=!1},clearStickyMatches:function(){this._stickyMatchesAwaitingClear=[],this._stickyMatches={},clearTimeout(this._timeoutHideNonMatches)},_checkMatch:function(e,t,i){var s=!0;return this.filterDate&&i==="@"+this.filterDate.text||i===n.a.SearchDates.Overdue||i.startsWith(n.a.SearchDates.Before)||i.startsWith(n.a.SearchDates.After)?s=this._matchDate(e):i.length>0&&s&&(s=!1,a.default.isPrefixTask(i)?s=e.isPrefixTask():i!==n.a.Prefix.Bullet&&i!==n.a.Prefix.Bullet2&&i!==n.a.Prefix.Bullet3||(s=e.isPrefixBullet()),s=s||t.indexOf(i)>=0),s},_isMatchStateOk:function(e){return e===g.Yes||e===g.Unknown||e===g.ChildYes},_matchFilter:function(e,t){if(e)return t?e>0?g.Unknown:g.Negated:e>0?g.No:g.Unknown},_matchFilters:function(e){for(var t=0,i=g.Unknown,a=0;a<this.filters.length;a++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=this.filters[a];if(n.matchFn){var s=n.matchFn(n.value.get(),e);s===g.Unknown||s!==g.Negated&&!this._isMatchStateOk(i)||(i=s)}}return i===g.Yes&&(i=g.Unknown),i},_matchFnComplete:function(e,t){return 1===e?t.isComplete()?g.Unknown:g.No:-1===e&&t.isComplete()?g.Negated:g.Unknown},_matchFnStarred:function(e,t){return this._matchFilter(e,t.isStarred())},_matchFnProject:function(e,t){return this._matchFilter(e,t.isPrefixHeader())},_matchFnTask:function(e,t){return this._matchFilter(e,t.isPrefixTask())},_matchFnPriority:function(e,t){var i=t.priority();return e>0?i>=e?g.Yes:g.No:g.Unknown},_matchFnEmail:function(e,t,i){var n=t.getAttachments(),s=n&&n[0],r=s&&s.getPlugin()===a.default.vmMain.getDefaultEmailPlugin();return this._matchFilter(e,r,i)},_matchDate:function(e){var t=this.filterDate,i=this.searchSpecialDate;if(t||i===n.a.SearchDates.Overdue){var a=i===n.a.SearchDates.Overdue?Date.today():t.date;if(i){var s=e.date(),r=e.repeatDate();if(s)return i===n.a.SearchDates.After?s>a:s<a;if(r){var o=r.getStartDate();return i===n.a.SearchDates.After?o>a:o<a}}else if(e.isOnDate(a))return!0}},checkItem:function(e,t){if(void 0!==this.matches[e.id])return this.matches[e.id];var i,s=t&&t.searchExtras,r=s?s.root:a.default.vmMain.root(),o=s?s.showHierarchy:this.showHierarchy(),l=this.matches,d=t&&t.ignoreStuck,u=e.isNote(),c=e.parent();if(e.isDestroyed())return i=g.No;if(a.default.Assert(c||e.isRootItem(),"Item parent does not exist while being searched",e.isArchived(),e===r),!d&&this._stickyMatches[e.id])i=g.ChildYes;else if(e.isRootItem())i=g.Yes;else if(c)if(l[c.id]===g.Negated)i=g.Negated;else{var h,f,p,m,v,_,y=[],S=e.getSearchText(this.pane),w=(i=this._matchFilters(e))===g.Negated;if(!w&&this.searchArr.length){var I=0,b=0;for(f=0;f<this.searchArr.length;f++){var A=0;if(I++>5e3&&__infLoop&&__infLoop(I))throw new RangeError;for(_=this.searchArr[f],p=0;p<_.length;p++){if(A++>5e3&&__infLoop&&__infLoop(A))throw new RangeError;if((v=_[p]).isNegated&&(m=v.text,a.default.Assert(m,"Each value in the search array should be valid at this point"),this._checkMatch(e,S,m))){y[f]=g.Negated,w=!0,b++;break}}}b===this.searchArr.length&&(i=g.Negated)}if(this.isMatchStateMatch(i)){var D=0,T=0;for(f=0;f<this.searchArr.length;f++){if(D++>5e3&&__infLoop&&__infLoop(D))throw new RangeError;if(y[f]!==g.Negated){var M=0;for(_=this.searchArr[f],p=0;p<_.length;p++){if(M++>5e3&&__infLoop&&__infLoop(M))throw new RangeError;if(m=(v=_[p]).text,a.default.Assert(m,"Each value in the search array should be valid at this point"),!v.isNegated)if(this._checkMatch(e,S,m))y[f]=g.Yes;else if(o){var C=0;for(h=e;h;){if(C++>5e3&&__infLoop&&__infLoop(C))throw new RangeError;if(!(h=h.parent())||h===r){y[f]=g.No;break}if(this._checkMatch(h,h.getSearchText(),m))break}}else y[f]=g.No;if(y[f]===g.No)break}}}var L=!1;for(f=0;f<y.length;f++){if(T++>5e3&&__infLoop&&__infLoop(T))throw new RangeError;if(L=y[f]===g.Yes,i===g.Unknown&&y[f]===g.Negated)i=g.Negated;else if(i!==g.Yes&&y[f]===g.No)i=g.No;else if(y[f]===g.Yes||y[f]===g.Unknown){i=g.Yes;break}}if(L&&this.updatingValue&&this.getValue()){var P=0;for(h=c;h;){if(P++>5e3&&__infLoop&&__infLoop(P))throw new RangeError;h.isCollapsed(this.pane,!1,!0)&&this.pane.setPerPaneState(h.id,n.a.PerPaneStateField.CollapsedSearch,!1),h=h.parent()}}i===g.Unknown&&(i=g.Yes)}if(!w&&this.pane.shouldSearchMatchParents&&c!==r&&o&&l[c.id]===g.Yes)return l[e.id]=g.Yes,l[e.id];i===g.No&&u&&(i=l[c.id])}else i=g.No;if(this.isMatchStateMatch(i)&&this.onlyMatchDates&&!this.pane.isOkOnAgenda(e)&&(i=g.No),i===g.Yes){if(o){var E=0;for(h=c;h&&!h.isRootItem()&&l[h.id]!==g.Negated&&l[h.id]!==g.Yes;){if(E++>5e3&&__infLoop&&__infLoop(E))throw new RangeError;l[h.id]=g.ChildYes,h.hasNote()&&(l[h.getNote().id]=g.Yes),h=h.parent()}}u&&(l[c.id]=g.Yes)}return d||(l[e.id]=i),i},checkChildrenParams:function(e,t){return this.checkItem(e,t)!==g.Negated},checkChildren:function(){var e=this,t=[],i={includeArchived:this.pane.showArchived.get(),includeNotes:!0,comparator:this.checkChildrenParams,each:function(e){t.push(e)},searchExtras:{root:a.default.vmMain.root(),showHierarchy:this.showHierarchy()}};this.itemStoreFilter&&(i.itemStoreFilter=this.itemStoreFilter),i.itemStore=this.pane.getItemStore(),a.default.searchVMLIs(i),this._savedItemsArray=t.filter(function(t){return e.isMatched(t,!0)}),this.checkToStickAfterSearch()},checkToStickAfterSearch:function(){if(this.isAnimatingSearch)for(var e in this.matches)if(this.matches.hasOwnProperty(e)&&void 0!==this.prevMatches[e]&&this.isMatchStateMatch(this.prevMatches[e])&&!this.isMatchStateMatch(this.matches[e])){var t=o.default.getModel(e);t&&!this.isMatchStuck(t)&&this.stickMatchAfterSearch(t,this.prevMatches[t.id])}},_getMatchedItem:function(e){return this._stickyMatches[e.id]||e},getItemDate:function(e){var t=this._stickyMatches[e.id];return t&&t.date},getItemRepeatDate:function(e){var t=this._stickyMatches[e.id];return t&&t.repeatDate},getItemDateText:function(e){var t=this._stickyMatches[e.id];return t&&t.dateText},getItemDuration:function(e){var t=this._stickyMatches[e.id];return t&&t.duration},getItemTagsLower:function(e){var t=this._stickyMatches[e.id];return t&&t.tagsLower},getItemContacts:function(e){var t=this._stickyMatches[e.id];return t&&t.contacts},getItemSearchText:function(e){var t=this._stickyMatches[e.id];return t&&t.searchText},getItemPrefix:function(e){var t=this._stickyMatches[e.id];return t&&t.prefix},getItemPriority:function(e){var t=this._stickyMatches[e.id];return t&&t.priority},getItemStarred:function(e){var t=this._stickyMatches[e.id];return t&&t.isStarred},stickMatch:function(e,t){var i=a.default.isVMLI(e)?e:e.item,n=this._stickyMatches[i.id];n||(this.matches[i.id]=g.Yes,n=i.getStickySearchInfo(),this._stickyMatches[i.id]=n),t&&(n.isHiding=!0),a.default.vmMain.isInCompleteAction()&&(n.wasCompleted=!0)},isMatchStuck:function(e){var t=a.default.isVMLI(e)?e:e.item;return!!this._stickyMatches[t.id]},unstickMatch:function(e){var t=a.default.isVMLI(e)?e:e.item,i=this._stickyMatches[t.id],n=t.getStickySearchInfo();return delete this._stickyMatches[t.id],!a.default.areObjectsEqual(i,n)},isMatchStuckHiding:function(e){var t=a.default.isVMLI(e)?e:e.item,i=this._stickyMatches[t.id];return i&&i.isHiding},stickMatchAfterSearch:function(e,t){this.stickMatch(e,!0),t&&(this._timeoutHideNonMatches&&clearTimeout(this._timeoutHideNonMatches),this._stickyMatchesAwaitingClear.pushUnique(e),p.default.isInMultiselect()||(this._timeoutHideNonMatches=setTimeout(this.hideNonMatches,1500)))},hideNonMatches:function(){var e=this;if(!this._destroyed){var t=this.pane,i=this._stickyMatchesAwaitingClear,n=i.length,s=0;if(n>0){for(var r=0,o=0;o<n;o++){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;var l=i[o],d=this._stickyMatches[l.id];d&&d.wasCompleted&&s++,this.unstickMatch(l),this.matches[l.id]=void 0,this.prevMatches[l.id]=void 0}var u=n+(n>1?" items":" item"),h={hold:!1};this.pane===a.default.focusedPane&&(s!==n?(h.text=u+" hidden because "+(n>1?"they do":"it does")+" not match search",h.actionText="UNHIDE",h.action=function(){if(t&&t.setIgnoreRestoreScroll){var a=0,s=c.a.save();t.setIgnoreRestoreScroll();for(var r=0;r<n;r++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var o=i[r];e.stickMatch(o),e._stickyMatchesAwaitingClear.push(o)}e.pane.updateItemsImmediate(!0,void 0,void 0,!0),c.a.restore(s)}}):(h.text=u+" completed",h.actionText="UNDO",h.action=function(){var a=0,s=c.a.save();t.setIgnoreRestoreScroll();for(var r=0;r<n;r++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;i[r].isComplete(!1,ChangeType.Local)}e.pane.updateItemsImmediate(!0,void 0,void 0,!0),c.a.restore(s)}),a.default.toasts.pushMessage(h));var f=c.a.save();this._stickyMatchesAwaitingClear=[],t.setIgnoreRestoreScroll(),t.updateItemsImmediate(!0,void 0,void 0,!0),c.a.restore(f)}}},showHierarchy:function(){return this.pane.type!==PaneMode.Task||this.pane.getViewMode()!==n.a.TaskViewMode.List_Flat&&1!==this.getFilterValue("showOnlyMatches")},setShowHierarchy:function(e){this.pane.supportSearchFlat&&this.setFilter("showOnlyMatches",e?0:1)},showOnlyAgendaDates:function(){return this.pane.type===PaneMode.Task&&this.getFilterValue("showOnlyAgendaDates")},showOnlyMatchingTags:function(){return this.pane.type===PaneMode.Task&&this.getFilterValue("showOnlyMatchingTags")},showChildProjects:function(){return this.pane.type===PaneMode.Task&&this.getFilterValue("showChildProjects")},clearListCache:function(){this.pane.getInfiniteList().clearCache()},getTags:function(){return this.tags},getContacts:function(){return this.contacts},getSearchWords:function(){return this.searchWords},shouldHighlightSearch:function(){return this.isFocused.get()&&this.getValue()},clearMatchForItem:function(e,t){this.matches[e.id]=void 0,t||e.items.get().forEach(this.clearMatchForItem),e.parent()&&this.clearMatchForItem(e.parent(),!0)},getSavedItemsArray:function(){return this._savedItemsArray}},t.a=m},function(e,t,i){"use strict";i.r(t);var a=i(0),n=i(1),s=i(2),r=i.n(s),o=i(12),l=i(10),d=o.a.createClass({displayName:"ReactMobileFilterBar",componentDisplay:n.a.ComponentDisplay.Everywhere,componentDidMount:function(){this.listenTo(this.props.pane.search.onChanged)},getState:function(){for(var e=0,t=this.props.pane.search,i={},a=0;a<t.filters.length;a++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var n=t.filters[a];i[n.name]=n.value}return i},openMobileFilterMenu:function(){a.default.menus.toggleContextMenu({componentName:"ReactContextMenuMobileFilter",position:"search-right",pane:this.props.pane})},renderSearchButton:function(e){var t=this.state[e.name],i=a.default.classNames("searchFilterButton selected",e.icon,{yes:t>0},{no:t<0});return r.a.createElement("div",{key:e.name,className:i})},renderSearchPriorityButton:function(e){var t=this.state[e.name],i=a.default.classNames("searchPriorityButton",{p0:t===VMLIFlag.P0},{p1:t===VMLIFlag.P1},{p2:t===VMLIFlag.P2}),s={height:n.a.PaneHeaderRow2ButtonHeight,lineHeight:n.a.PaneHeaderRow2ButtonHeight+"px"};return r.a.createElement("div",{key:e.name,className:i,style:s})},render:function(){for(var e=0,t=this.props.pane.search,i=[],a=0;a<t.filters.length;a++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var s=t.filters[a];s.enabled.get()&&this.state[s.name]&&(s.icon?i.push(this.renderSearchButton(s)):"priority"===s.name&&i.push(this.renderSearchPriorityButton(s)))}var o=i.length>0;return r.a.createElement("div",{className:"mobileFilterBar flexbox"},r.a.createElement(l.a,{icon:o?null:"icon-filter_list",iconSize:17,fontSize:14,height:n.a.PaneHeaderRow2ButtonHeight,paddingLeft:0,paddingRight:0,onClick:this.openMobileFilterMenu,ripple:!o},i))}});t.default=d},function(e,t,i){"use strict";i.r(t);var a=i(0),n=i(13),s=i(18),r=function(){},o=function(){return{}},l=function(){return{then:r,execute:r}};function d(){this.cache={},this.loadedGapiData={},this._isRemoteHooked=!1,this.resetListener=void 0}d.prototype={setGapiData:function(e,t){for(var i in a.default.Assert(a.default.isObject(t)&&!a.default.isArray(t),"Setting malformed data",e),this.loadedGapiData[e]=[],t)t[i].id=i,this.loadedGapiData[e].push(t[i])},setGapiDataDirect:function(e,t){a.default.Assert(a.default.isArray(t),"Setting malformed data",e),this.loadedGapiData[e]||(this.loadedGapiData[e]=t)},clearGapiData:function(){this.loadedGapiData={}},loadRemoteData:function(e,t){var i=this;a.default.Assert(e&&t,"Must supply valid remote load info as well as a cb when data is loaded");var n=e.split(":");if(this.cache[n[0]])t(JSON.parse(JSON.stringify(this.cache[n[0]][n[1]])));else{var s=!n[0].endsWith(".txt"),r=s?n[0]+".json":n[0];a.default.XHR({type:"GET",url:window.location.protocol+"//"+window.location.host+"/data/"+r,cb:function(e){if(200===e.status)try{if(s){var a=JSON.parse(e.responseText);i.cache[n[0]]=a,n[1]||(n[1]="0");var r=a[n[1]];if(r){var o=JSON.parse(JSON.stringify(r));t(o)}else log("Invalid data slot")}else{var l=e.responseText.split("\n");l="tags"===n[1]?l.map(function(e){if(e.length>0){for(var t=0,i=e.split(" "),a=0;a<i.length;a++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;Math.random()<.8&&(i[a]="#"+i[a])}e=i.join(" ")}return{text:e}}):l.map(function(e){return{text:e}}),t([{text:"Outline",items:l}])}}catch(e){log("Error parsing demo data: "+e.message)}else log("Error getting demo data",e.status,e.responseText)}})}},stubGapi:function(){a.default.Assert(!window.gapi,"Should not have loaded gapi when stubbing");var e=[];n.a.listen("resetEverything",function(){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;clearTimeout(e[i])}e=[]});var t=function(t,i){var a=setTimeout(function(){e.remove(a),t({success:!0})},0);e.push(a)};window.gapi={auth:{getToken:function(){return{expires_in:3600,expires_at:Math.floor((Date.now()+a.default.minutes(60))/1e3),access_token:"InvalidToken",id_token:"InvalidIDToken",scope:[GScope.UserInfoEmail,GScope.Calendar,GScope.GmailCompose,GScope.GmailModify]}}},client:{request:function(e){return{then:function(t,i,a){return s.a.getAPIForRequest(e)(e.__rawParams).then(t,i,a)},execute:function(){}}},load:r,setApiKey:r,newBatch:function(){return{add:r,then:t}},drive:{files:{get:l,list:l,trash:l,insert:l,patch:l},permissions:{list:l,insert:l,delete:l},properties:{insert:l},parents:{insert:l},changes:{list:l}},gmail:{users:{threads:{list:l,get:l,modify:l,trash:l,untrash:l},labels:{list:l,create:l},history:{list:l},messages:{get:l,send:l,trash:l,untrash:l},drafts:{create:l,update:l,send:l,delete:l,list:l},settings:{sendAs:{list:l}}}},calendar:{settings:{list:l},events:{get:l,list:l,patch:l,insert:l,delete:l},calendars:{insert:l},calendarList:{list:l}}}}},areRemoteFunctionsHooked:function(){return this._isRemoteHooked},hookRemoteFunctions:function(){function e(e,t){var i=0;a.default.Assert(e,"Must load local or remote data to perform queries");for(var n=0;n<e.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(e[n].id===t)return e[n]}}function t(e,t,i){a.default.Assert(e,"Must load local or remote data to perform queries");var n=[];if(a.default.isArray(i));else if(e)for(var s=0,r=0;r<e.length;++r){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;e[r][t]===i&&n.push(e[r])}return n}function i(e,t,i){var n=0;a.default.Assert(e,"Must load local or remote data to perform queries");for(var s=[],r=0;r<e.length;++r){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;e[r][t].indexOf(i)>=0&&s.push(e[r])}return s}a.default.Assert(!this._isRemoteHooked,"Should not hook remote functions more than once"),this.stubGapi(),this._isRemoteHooked=!0;var s=0,r=[],l=this;function d(e){return{then:function(e){return function(t,i,n){var o;try{o=e(n)}catch(e){a.default.reportError(e)}var l=setTimeout(function(){r.remove(l),o?t.call(n,{result:o}):i.call(n,{error:!0})},s);r.push(l)}}(e),execute:function(e){return function(t,i,a){var n=e(a),o=setTimeout(function(){r.remove(o),n?t(n):i({error:!0})},s);r.push(o)}}(e)}}n.a.listen("resetEverything",function(){for(var e=0,t=0;t<r.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;clearTimeout(r[t])}r=[]}),gapi.client.drive.files.get=function(t){return d(function(i){return e(l.loadedGapiData.Drive,t.fileId)})},gapi.client.drive.files.list=function(e){return d(function(t){if("mimeType='application/vnd.google-apps.drive-sdk.597847337936' and trashed=false"===e.q)return{items:l.loadedGapiData.documents};var n=/\'(.*)\' in parents/g.exec(e.q),s=/title contains \'([^\']*)\'/g.exec(e.q),r=/mimeType contains \'([^\']*)\'/g.exec(e.q),o=l.loadedGapiData.Drive;return n&&(o=function(e,t){var i=0;a.default.Assert(e,"Must load local or remote data to perform queries");for(var n=[],s=0;s<e.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;(e[s].parents[0].id===t||"root"===t&&e[s].parents[0].isRoot)&&n.push(e[s])}return n}(o,n[1])),s&&(o=i(o,"title",s[1])),r&&(o=i(o,"mimeType",r[1])),{items:o}})},gapi.client.drive.files.trash=function(e){return d(o)},gapi.client.drive.files.insert=function(e){return d(o)},gapi.client.drive.files.patch=function(e){return d(o)},gapi.client.drive.permissions.list=function(e){return d(function(e){return{items:l.loadedGapiData.permissions}})},gapi.client.drive.permissions.insert=function(e){return d(o)},gapi.client.drive.permissions.delete=function(e){return d(o)},gapi.client.drive.properties.insert=function(e){return d(o)},gapi.client.gmail.users.threads.list=function(e){return d(function(i){return{threads:t(l.loadedGapiData.Gmail,"hideInPane",void 0).filter(function(t){return"me"===e.userId||t.accountID===e.userId})}})},gapi.client.gmail.users.threads.modify=function(t){return d(function(i){var a=e(l.loadedGapiData.Gmail,t.id)[0];if(!a)return{};if(a.labelIds||(a.labelIds=[]),t.removeLabelIds)for(var n=0,s=0;s<t.removeLabelIds.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;a.labelIds.remove(t.removeLabelIds[s])}t.addLabelIds&&a.labelids.pushOnlyUniques(t.addLabelIds)})},gapi.client.gmail.users.threads.get=function(t){return d(function(i){return e(l.loadedGapiData.Gmail,t.id)})},gapi.client.gmail.users.messages.get=function(e){return d(function(t){return function(e,t){var i=0;a.default.Assert(e,"Must load local or remote data to perform queries");for(var n=0;n<e.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=t(e[n]);if(s)return s}}(l.loadedGapiData.Gmail,function(t){for(var i=0,a=0;a<t.messages.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(t.messages[a].id===e.id)return t.messages[a]}})})},gapi.client.gmail.users.messages.send=function(e){return d(function(t){return{id:a.default.generateTempId(),threadId:e.resource.threadId||a.default.generateTempId().substr(3),labelIds:["SENT","UNREAD"]}})},gapi.client.gmail.users.labels.list=function(e){return d(function(e){return{labels:l.loadedGapiData.Gmail_Labels}})},gapi.client.gmail.users.labels.create=function(e){return d(function(i){var n=t(l.loadedGapiData.Gmail_Labels,"name",e.resource.name)[0];if(n)return n;var s=a.default.generateTempId().substr(3);return n={name:e.resource.name,id:s},l.loadedGapiData.Gmail_Labels||(l.loadedGapiData.Gmail_Labels=[]),l.loadedGapiData.Gmail_Labels.push(n),n})},gapi.client.gmail.users.settings.sendAs.list=function(e){return d(function(e){return{sendAs:[{displayName:"Demo User",isDefault:!0,isPrimary:!0,replyToAddress:"",sendAsEmail:"demo@moo.do",signature:""}]}})},gapi.client.calendar.calendarList.list=function(e){return d(function(e){return{items:l.loadedGapiData.calendarList}})},gapi.client.calendar.events.get=function(t){return d(function(i){return e(l.loadedGapiData.GCalendar,t.eventId)})}}},t.default=new d},function(e,t,i){"use strict";var a=i(0),n=i(1),s=i(4),r=i(2),o=i.n(r),l=i(12),d=i(15),u=i(10),c=i(3),h=i(36),f=["#4D4D4D","#999999","#CCCCCC","#FFFFFF","#F44E3B","#FE9200","#FCDC00","#A4DD00","#68CCCA","#73D8FF","#AEA1FF","#FDA1FF","#333333","#808080","#BBBBBB","#EEEEEE","#D33115","#E27300","#FCC400","#22AA66","#16A5A5","#0099DD","#7B64FF","#FA28FF","#000000","#666666","#AAAAAA","#DDDDDD","#AA3300","#C45100","#FB9E00","#194D33","#0C797D","#0062B1","#653294","#AB149E"],p={hex3:/^(#)([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^(#)([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/},g=l.a.createClass({displayName:"FancyColorPickerContextMenu",componentDisplay:n.a.ComponentDisplay.Everywhere,init:function(){this.createObservables({color:this.props.color,value:this.props.color,isValid:!0}),c.a.reset()},parseColor:function(e){var t;return(t=p.hex3.exec(e))?"#"+t[2]+t[2]+t[3]+t[3]+t[4]+t[4]:(t=p.hex6.exec(e))?e:void 0},onClickColor:function(e){this.color.set(e),this.value.set(e),this.props.onChange(e)},onChangeInputColor:function(e){var t=e.target.value.toUpperCase();0!==t.indexOf("#")&&(t="#"+t);var i=this.parseColor(t);i&&(this.color.set(i),this.props.onChange(i)),t.length<8&&this.value.set(t),this.isValid.set(!!this.parseColor(this.value.get()))},onChangeInputComponent:function(){var e=this.refs,t=e.r.value,i=e.g.value,n=e.b.value;if(t>=0&&t<=255&&i>=0&&i<=255&&n>=0&&n<=255){var s="#"+a.default.rgbToHex(t,i,n);this.value.set(s),this.color.set(s),this.props.onChange(s)}},render:function(){for(var e=0,t=this.state,i=this.state.color,n=a.default.hexToRgb(i),s=[],r=0;r<f.length;r++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var l=f[r],d=a.default.classNames("fancyColor",{selected:l===i},{isWhite:"#FFFFFF"===l.toUpperCase()}),u={background:l};s.push(o.a.createElement("div",{key:l,className:d,style:u,onClick:this.onClickColor.bind(this,l)}))}var c=a.default.classNames("fancyColorInputColor",{invalid:!t.isValid});return o.a.createElement(h.a,{id:"fancyColorPicker",element:this.props.element,offset:{left:-120,top:4}},o.a.createElement("div",{className:"fancyColors"},s),o.a.createElement("div",{className:"fancyColorText"},o.a.createElement("div",{key:i,className:"fancyColor",style:{background:i}}),o.a.createElement("input",{type:"text",className:c,value:t.value,onChange:this.onChangeInputColor}),o.a.createElement("span",null,"R"),o.a.createElement("input",{type:"text",ref:"r",className:"fancyColorInputComponent",value:n.r,onChange:this.onChangeInputComponent}),o.a.createElement("span",null,"G"),o.a.createElement("input",{type:"text",ref:"g",className:"fancyColorInputComponent",value:n.g,onChange:this.onChangeInputComponent}),o.a.createElement("span",null,"B"),o.a.createElement("input",{type:"text",ref:"b",className:"fancyColorInputComponent",value:n.b,onChange:this.onChangeInputComponent})))}}),m=l.a.createClass({displayName:"FancyColorPicker",componentDisplay:n.a.ComponentDisplay.Everywhere,init:function(){this.createObservables({color:this.props.color})},componentWillReceiveProps:function(e){e.color!==this.props.color&&this.color.set(e.color)},openMenu:function(e){a.default.menus.openContextMenu({fn:this.renderContextMenu,element:e.target})},onChange:function(e){this.color.set(e),this.props.onChange(e)},renderContextMenu:function(e){return o.a.createElement(g,{key:"fancyColorPicker",color:this.state.color,onChange:this.onChange,element:e.element})},render:function(){var e=a.default.extend({background:this.state.color,border:"1px solid #666"},this.props.style),t=a.default.classNames("fancyColor",{isWhite:"#FFFFFF"===this.state.color.toUpperCase()});return o.a.createElement("div",{className:t,style:e,onClick:this.openMenu})}}),v=/(^|\s|&nbsp;|<div>|<span>|<p>)((?:(?:((https?|ftps?):\/\/)|www)[^"<\s]+)(?![^<>]*>|[^"]*?<\/a))/gi,_=[n.a.KeyCode.LeftArrow,n.a.KeyCode.RightArrow,n.a.KeyCode.UpArrow,n.a.KeyCode.DownArrow,n.a.KeyCode.Enter,n.a.KeyCode.Escape,n.a.KeyCode.PageUp,n.a.KeyCode.PageDown],y=l.a.createClass({displayName:"FancyContenteditable",componentDisplay:n.a.ComponentDisplay.Everywhere,init:function(){this.createObservables({isFocused:this.props.focused||!1})},componentDidMount:function(){var e=this,t=this.props;if(t.value){var i=this.replaceHTMLLinks(t.value.replace(/\r?\n/g,"<br>"));this.setValue(i)}t.focused&&requestAnimationFrame(function(){e.refs.div&&e.refs.div.focus()})},onUnmount:function(){this.isFocused.get()&&this.onBlur()},focus:function(){a.default.isDemoRunning||this.refs.div.focus()},blur:function(){this.refs.div.blur()},setValue:function(e){this.refs.div.innerHTML=e},getValue:function(){return this.refs.div.textContent.length>0?this.refs.div.innerHTML:""},getTextValue:function(){return this.refs.div.textContent},getElement:function(){return this.refs.div},insertCharAtIndex:function(e,t){var i=this.refs.div,a=i.innerHTML;a=a.substr(0,t)+e+a.substr(t,a.length),i.innerHTML=a,d.default.selectElement(i,t+1),this.props.onChange&&this.props.onChange()},onFocus:function(e){a.default.vmMain.activeInput.set(this),this.isFocused.set(!0),this.props.onFocus&&this.props.onFocus(e)},onBlur:function(e){a.default.vmMain.activeInput.set(null),this.isFocused.set(!1),this.props.onBlur&&this.props.onBlur(e)},hasFocus:function(){return this.isFocused.get()},onEscapeKey:function(){this.props.onEscape&&this.props.onEscape()},onDrop:function(e){this.props.onDrop&&this.props.onDrop(e.dataTransfer)},onDragEnter:function(){this.props.onDrop&&a.default.addClass(this.refs.div,"dragTarget")},onDragLeave:function(){this.props.onDrop&&a.default.removeClass(this.refs.div,"dragTarget")},onKeyDown:function(e){if(s.a.mac&&e.metaKey||!s.a.mac&&e.ctrlKey)e.keyCode===n.a.KeyCode.U?this.onClickToolbarButton("underline"):e.keyCode===n.a.KeyCode.K?this.insertLink({target:this.refs.link.getElement()}):e.keyCode===n.a.KeyCode.H?(this.makeHeading(),a.default.preventDefault(e)):e.keyCode===n.a.KeyCode.V&&(this.__pasteWithShift=e.shiftKey);else if(!_.includes(e.keyCode)){var t=d.default._getSelectionRange();if(t){var i=t.startContainer,r=i.parentElement;"A"===r.nodeName&&r.textContent===r.getAttribute("href")&&t.startOffset===t.endOffset&&t.startOffset===r.textContent.length&&(r.replaceWith(i),d.default.selectAfterNode(i))}}this.props.onKeyDown&&this.props.onKeyDown(e)},insertNode:function(e){this.focus(),d.default.deleteRangeContents(),d.default.insertNode(e),d.default.selectAfterNode(e)},insertLink:function(e){var t=d.default.getSelectedText(),i=e.target;this.savedSel=d.default.getSelectionRange(),a.default.menus.openContextMenu({componentName:"ReactContextMenuInsertLink",element:i,onClosed:this.onInsertLinkClosed,onInsertLink:this.onInsertLink,text:t})},onInsertLinkClosed:function(){this.savedSel&&(this.focus(),d.default.setSelectionRange(this.savedSel))},onInsertLink:function(e){var t=document.createElement("a");t.href=e.url,t.innerText=e.text,this.insertNode(t)},makeHeading:function(){for(var e,t,i=0,a=window.getSelection(),n=a.rangeCount;n--;){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=a.getRangeAt(n),r=s.startContainer,o=s.startContainer.parentElement,l=d.default.getSelectOffsetsInElement(this.refs.div,s);"H2"===o.nodeName?(t=void 0,o.parentElement.replaceChild(r,o),d.default.selectElement(r,0,r.textContent.length)):l&&l.start!==l.end&&((t=document.createElement("h2")).appendChild(s.extractContents()),s.insertNode(t),e=t.textContent.length)}t&&e&&d.default.selectElement(t,0,e)},onClickToolbarButton:function(e,t){a.default.isString(e)?"heading"===e?this.makeHeading():document.execCommand(e):e(t)},onClick:function(e){"A"===e.target.nodeName?a.default.openUrl(e.target.href):this.props.onClick&&this.props.onClick(e)},onPaste:function(e){if(this.__pasteWithShift){var t=document.queryCommandSupported("insertText"),i=document.queryCommandSupported("paste");if(t||i){e.preventDefault();var a="";e.clipboardData||e.originalEvent.clipboardData?a=(e.originalEvent||e).clipboardData.getData("text/plain"):window.clipboardData&&(a=window.clipboardData.getData("Text")),a=a.trim();var n=t?"insertText":"paste";document.execCommand(n,!1,a)}}},replaceHTMLLinks:function(e){return e.replace(v,function(e,t,i){return t+'<a href="'+i+'">'+i+"</a>"})},onSetColor:function(e){document.execCommand("forecolor",!1,e)},onChange:function(e){var t=e.target.innerHTML,i=this.replaceHTMLLinks(t);if(t!==i){var a=d.default._getSelectionRange(),n={start:0,end:0};a&&(n=d.default.getSelectOffsetsInElement(e.target,a)),e.target.innerHTML=i,d.default.selectElement(e.target,n.start,n.end)}this.props.onChange&&this.props.onChange(e)},renderToolbarButton:function(e,t,i,a,n,r){var l=s.a.priModKey;return n="Escape"===n?n:l+" + "+n,o.a.createElement(u.a,{className:"button_"+a,icon:e,width:36,height:36,iconSize:t,onClick:this.onClickToolbarButton.bind(this,i),tooltip:a,tooltipHotkey:n,ref:r})},render:function(){var e,t=this.props,i=a.default.classNames("fancyContenteditableWrapper flexbox flexvert",t.className),n=a.default.classNames("fancyContenteditable f1 c-background",{richText:t.richText}),s=t.spellCheck?"true":null;return t.richText&&(e=o.a.createElement("div",{className:"fancyContenteditableToolbar c-bg-faded c-border-light"},this.renderToolbarButton("icon-format_bold",19,"bold","Bold","B"),this.renderToolbarButton("icon-format_italic",19,"italic","Italic","I"),this.renderToolbarButton("icon-format_underlined",18,"underline","Underline","U"),this.renderToolbarButton("icon-header",14,"heading","Heading","H","H1"),o.a.createElement("div",{className:"divider c-bg-autocomplete-highlight"}),this.renderToolbarButton("icon-numlist",14,"insertOrderedList","Numbered list","L"),this.renderToolbarButton("icon-bullet",26,"insertUnorderedList","Bulleted list","Option + L"),o.a.createElement("div",{className:"divider c-bg-autocomplete-highlight"}),o.a.createElement(m,{color:"#000000",onChange:this.onSetColor,style:{marginTop:11,verticalAlign:"top"}}),this.renderToolbarButton("icon-link",18,this.insertLink,"Link","K","link"),!1)),o.a.createElement("div",{className:i},e,o.a.createElement("div",{contentEditable:!1!==t.editable,className:n,style:this.props.style,ref:"div",spellCheck:s,onInput:this.onChange,onClick:this.onClick,onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown,onKeyPress:this.props.onKeyPress,onKeyUp:this.onKeyUp,onDrop:this.onDrop,onDragEnter:this.onDragEnter,onDragLeave:this.onDragLeave,onPaste:this.onPaste}))}});t.a=y},function(e,t,i){"use strict";i.r(t);var a=i(0),n=i(1),s=(i(4),i(2)),r=i.n(s),o=i(12),l=i(7),d=i(29),u=o.a.createClass({displayName:"ReactFile",componentDisplay:n.a.ComponentDisplay.Everywhere,getState:function(){var e=this.props.file;return{isShared:e._isShared,title:e._title,isOpen:e.isOpen()}},onClickDocumentTitle:function(){var e=this.props.file;a.default.vmMain.vmPicker.openDocument(e),l.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenDocument})},onClickDocumentSettings:function(){var e=this.props.file;a.default.vmMain.vmPicker.openSharing(e),a.default.sendEvent("Menu","OpenSharing"),l.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.OpenDocSharing})},render:function(){var e=this.state;return r.a.createElement(d.a,{icon:e.isShared?"icon-user":"icon-settings",active:e.isOpen,selected:this.props.selected,tooltip:"Open "+e.title,iconTooltip:"Share / Rename / Delete",onClick:this.onClickDocumentTitle,onClickIcon:this.onClickDocumentSettings},e.title)}}),c=(i(44),i(36)),h=Object.assign||function(e){for(var t=0,i=1;i<arguments.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=arguments[i];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},f=o.a.createClass({displayName:"ReactContextMenuDocuments",componentDisplay:n.a.ComponentDisplay.Everywhere,getState:function(){var e=a.default.vmMain.vmPicker;return{files:a.default.vmMain.docManager._docList,showError:e.showError,isLoading:e.isLoading}},render:function(){var e=a.default.vmMain.vmPicker,t=this.props,i=this.state;a.default.classNames("flexbox flexvert",{loading:i.isLoading||0===i.files.length});return i.showError?r.a.createElement(c.a,h({},t,{key:"contextMenuDocuments",id:"contextMenuDocuments",supportArrows:!0}),r.a.createElement(d.a,{onClick:e.onTapReloadDocuments.bind(e)},i.showError)):i.isLoading||0===i.files.length?r.a.createElement(c.a,h({},t,{key:"contextMenuDocuments",id:"contextMenuDocuments",loading:!0,supportArrows:!0})):r.a.createElement(c.a,h({},t,{key:"contextMenuDocuments",id:"contextMenuDocuments",supportArrows:!0,maxWidth:360,maxHeight:500}),r.a.createElement(d.a,{id:"addDocument",onClick:e.onTapAddDocument.bind(e),icon:"icon-add",iconSize:18},"New File"),r.a.createElement("hr",null),i.files.map(function(e){return r.a.createElement(u,{key:"file_"+e.id,file:e})}))}});t.default=f},,,,function(e,t,i){navigator.userAgent;"http:"===window.location.protocol&&(window.location.hash.indexOf("state=")<0||window.location.hash.indexOf("app")<0&&window.location.hash.indexOf("appv")<0)&&(window.location=window.location.href.replace(/^http:/,"https:")),Date.Config={DEBUG:!0,DisableCache:!0},Error.stackTraceLimit=1/0;try{window.__checkpoints|=1,window.__SESSION_ID=Math.round(1e4*Math.random())+"|"+Date.now(),window.__SESSION_BEGIN=Date.now();var a=function(){};window.appEvents=window.appEvents||{kbsize:a,enterBackground:a,enterForeground:a,statusBarTap:a,closeKeyboard:a,undo:a,redo:a,notifyOAuth:a,features:a,reportLowMemory:a,pokeBackground:a},window.console||(window.console={log:function(){},error:function(){}});window.log=window.console.log.bind(window.console),window.__log=window.console.log.bind(window.console),window.__warn=window.console.warn.bind(window.console),window.__error=window.console.error.bind(window.console),window.performance&&window.performance.now?(window.log.start=window.performance.now(),window.log.now=function(){return window.performance.now()-window.log.start}):(window.log.start=Date.now(),window.performance={now:function(){return Date.now()-window.log.start}},window.log.now=window.performance.now),window.console.timeStamp||(Object.defineProperty?Object.defineProperty(window.console,"timeStamp",{value:function(){}}):window.console.timeStamp=function(){}),window.console.time||(Object.defineProperty?Object.defineProperty(console,"time",{value:function(){}}):window.console.time=function(){}),window.console.timeEnd||(Object.defineProperty?Object.defineProperty(window.console,"timeEnd",{value:function(){}}):window.console.timeEnd=function(){}),window.console.trace||(Object.defineProperty?Object.defineProperty(window.console,"trace",{value:function(){}}):window.console.trace=function(){}),window.LogLevels={Off:0,Error:1,Warning:2,Timing:4,Data:8,Status:16,Search:32,Timeline:64,Input:128,Tracker:256,Profile:512,PageLoad:1024,Toolbar:2048,Picker:4096,Intro:8192,Import:16384,Version:32768,Settings:65536,Selection:131072,Edit:262144,NativeAuth:524288,DateRoll:1048576,DebugDOM:2097152,RepeatDate:4194304,Connection:8388608,Plugin:16777216,Folders:33554432,Verbose:67108864,Account:134217728,React:268435456,Autocomplete:536870912,Compose:1073741824},window.LogLevel=LogLevels.Error|LogLevels.Warning,window.ShouldLog=function(e){return window.DEBUG===e},window.inspectLocal=function(e){if(e){var t=e;return"string"==typeof e&&(t=window.getModel(e)),log("---- Inspecting Item:",t.id,"----"),log("  RawText:",t.getRawText()),log("  ParsedText:",t.getParsedText()),log("  Els:",t.els),log('  Parent: "'+t.parent().id+'"'),log("  Date:",t.date()),log("  AllDayDate:",t.allDayDate()),log("--------------------------------------------"),t}log("Must specify either an item ID or item object to inspect")}}catch(e){console.log("Error in main header",e),window.__ERRORINMAINHEADER=e}},,,function(e,t,i){"use strict";i.r(t);var a=i(0),n=i(1),s=i(5),r=i(8),o=i(41);function l(){}l.prototype={init:function(){this._isLoaded=!1,this._isSaving=!1,this._docID=void 0,this._state=void 0,this._historyOfPanes={},this.selected=new r.a({type:PaneMode.Task,viewMode:n.a.TaskViewMode.Outline}),a.default.settings.listen("settingChanged",Settings.DefaultGroup,Settings.paneHistoryMobile,this.onSettingChanged.bind(this))},getDocID:function(){return this._docID||(this.trackPaneState()?this._docID=a.default.settings.get(Settings.gdocId):this._docID="TEST"),this._docID},loadPanesFromState:function(){a.default.Assert(this.getDocID(),"Should have a docID before loading mobile panes from state"),this.load();var e=[];return a.default.vmMain.pluginManager.isGmailPaneEnabled()&&e.push(this.loadPaneFromState(PaneMode.Gmail)),e.push(this.loadPaneFromState(PaneMode.Task,n.a.TaskViewMode.Outline)),e.push(this.loadPaneFromState(PaneMode.Task,n.a.TaskViewMode.Agenda_All)),e},loadPaneFromState:function(e,t){var i,n=this.getHistoryByType(e,t);return(i=n&&n.length>0?a.default.vmMain.paneManager.loadPaneFromState(n[0]):o.a.createPane(e,{viewState:{viewMode:t}})).init(),i},hasLoadedPaneState:function(){return!!this._historyOfPanes},getPaneState:function(){this._historyOfPanes||this.load();var e=[];return a.default.vmMain.pluginManager.isGmailPaneEnabled()&&e.push(this.getHistoryByType(PaneMode.Gmail)[0]),e.push(this.getHistoryByType(PaneMode.Task)[0]),e},savePaneState:function(e){if(a.default.Assert(e&&e.length>0,"Must provide at least one valid pane"),e[0]){var t=this.getDocumentState();if(a.default.Assert(t,"Document pane state must exist"),t){var i=0;a.default.Assert(t.panes,"Panes must be defined here"),t.panes||(t.panes={});for(var n=0;n<e.length;n++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=e[n],r=this.getMobilePaneName(s.type,s.viewState.viewMode);this._historyOfPanes[r]=t.panes[r]=[s]}}}this.save()},getDocumentState:function(){var e=this.getDocID();return this._state[e]},getHistoryByType:function(e,t){var i=this.getMobilePaneName(e,t),a=this._historyOfPanes[i];return a&&a[0]||(this._historyOfPanes[i]=[]),this._historyOfPanes[i]},migrateFromPaneState:function(e){var t={};for(var i in e)if(e.hasOwnProperty(i)){var a=e[i];t[i]=this.createDefaultState(a),a[0]&&(t[i].selected={type:a[0].type,viewMode:n.a.TaskViewMode.Outline})}return t},createDefaultState:function(e){var t={selected:PaneMode.Task,panes:{}};if(e)for(var i=0,a=0;a<e.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;t.panes[e[a].type]=[e[a]]}return t},load:function(){var e,t,i=this.getDocID(),n=!1;if(i){if(this.trackPaneState()){var r=a.default.settings.get(Settings.paneHistoryMobile);if(r)try{t="A",e=JSON.parse(r),t="AA"}catch(e){a.default.reportError(e),t="AB"}else{t="B",n=!0;var o=s.a.storage.getItem("paneState");if(o){try{o=JSON.parse(o),t="BA"}catch(e){t="BB",a.default.reportError(e),o={}}e=this.migrateFromPaneState(o)}else t="C"}}else t="D";var l=(e=e||{})[i];l||(l=e[i]=this.createDefaultState([]),n=!0),l.selected||(l.selected=PaneMode.Task),a.default.Assert(l.panes,"Should have panes set by now",t),l.panes||(l.panes={}),this._state=e,this._historyOfPanes=l.panes||{},this.selected.set(l.selected),n&&this.save()}else this._state={},this.selected.set(PaneMode.Task);this._isLoaded=!0},save:function(){if(this.trackPaneState()){this._isSaving=!0;var e=this.getDocumentState();a.default.Assert(e,"Document pane state must exist"),e&&(e.selected=this.selected.get());try{a.default.settings.set(Settings.paneHistoryMobile,JSON.stringify(this._state))}catch(e){a.default.reportError(e)}this._isSaving=!1}},trackPaneState:function(){return!a.default.isRunningScript()&&!a.default.isDemoMode()},onSettingChanged:function(){this._isSaving||this.load()},getMobilePaneName:function(e,t){return e+(e===PaneMode.Task&&t?"_"+t:"")}},t.default=new l},function(e,t,i){"use strict";i.r(t);i(74);var a,n,s=i(6),r=i(0),o=i(5),l=i(1),d=i(40);function u(){this._versions={},this._values={},this._changeListeners=[],this._apiNotifications={},this._localLoaded=!1,this._localLoadError=!1,this._localWriteError=!1,this._remoteLoaded=!1,this._remoteLoadError=!1,this._remoteSettings=void 0,a=window.Settings.DefaultGroup="Default",n=window.Settings.UISettingsGroup="UISettings",this.init()}u.prototype={init:function(){this._testLocalWrites(),this.registerGroup(a),this.registerGroup(n),this.registerSetting(Settings.theme,a,!0,"light"),this.registerSetting(Settings.syncContacts,a,!0),this.registerSetting(Settings.shownTutorial,a,!0),this.registerSetting(Settings.rootFolderId,a,!0),this.registerSetting(Settings.attachFolderId,a,!0),this.registerSetting(Settings.backupFolderId,a,!0),this.registerSetting(Settings.enableOfflineAuth,a,!0,!0),this.registerSetting(Settings.trialOverHidden,a,!0),this.registerSetting(Settings.helpState,a,!0),this.registerSetting(Settings.helpPaneState,a,!0),this.registerSetting(Settings.closedImport,a,!0),this.registerSetting(Settings.closedHelps,a,!0),this.registerSetting(Settings.inTooltipIntro,a,!0),this.registerSetting(Settings.closedVideo,a,!0),this.registerSetting(Settings.workspaces,a,!0),this.registerSetting(Settings.paneHistoryMobile,a,!0),this.registerSetting(Settings.notificationDelay,a,!0,30),this.registerSetting(Settings.openEvernoteApp,a,!0),this.registerSetting(Settings.dateFormat,a,!0,l.a.DateFormat.MDY),this.registerSetting(Settings.dayWeekStart,a,!0,0),this.registerSetting(Settings.defaultItemPrefix,a,!0,""),this.registerSetting(Settings.agendaSort,a,!0),this.registerSetting(Settings.showMarkdown,a,!0),this.registerSetting(Settings.calendarCustomDays,a,!0,3),this.registerSetting(Settings.selectFullItems,a,!0,!1),this.registerSetting(Settings.showFormattingToolbar,a,!0,1),this.registerSetting(Settings.showImagesInline,a,!0,!0),this.registerSetting(Settings.lastBackup,a,!0),this.registerSetting(Settings.needsBackup,a,!0),this.registerSetting(Settings.backupFrequency,a,!0),this.registerSetting(Settings.showBullets,n,!0,!1),this.registerSetting(Settings.lastContactSync),this.registerSetting(Settings.lastTaskSync),this.registerSetting(Settings.lastQuickAddSync),this.registerSetting(Settings.disableNotifications),this.registerSetting(Settings.authScopes),this.registerSetting(Settings.localIntegrity),this.registerSetting(Settings.localDataVersion),this.registerSetting(Settings.localRecoverVersion),this.registerSetting(Settings.gdocId),this.registerSetting(Settings.gdocTitle),this.registerSetting(Settings.activeUser),this.registerSetting(Settings.userId),this.registerSetting(Settings.displayName),this.registerSetting(Settings.lastServerVersion),this.registerSetting(Settings.oauthScheme),this.registerSetting(Settings.premiumStatus),this.registerSetting(Settings.trialStart),this.registerSetting(Settings.trialDuration),this.registerSetting(Settings.trialExtended),this.registerSetting(Settings.premiumEndDate),this.registerSetting(Settings.notifiedTrialOver),this.registerSetting(Settings.notifiedTrialEndSoon),this.registerSetting(Settings.localPaneState),this.registerSetting(Settings.selectedWorkspace),this.registerSetting(Settings.monthlyInvoice),this.registerSetting(Settings.invoiceEmail),this.registerSetting(Settings.invoiceCompany),this.registerSetting(Settings.invoiceAddress),this.registerSetting(Settings.isUnsubscribed),this.registerSetting(Settings.keyboardToolbarScroll),this.registerSetting(Settings.showSidebar,a,!1,!1),this.registerSetting(Settings.sidebarWidth,a,!1,l.a.DesktopMenuWidth),this.registerSetting(Settings.cacheSizeRatio,a,!1,1),this.registerSetting(Settings.bulletOpacity,n,!0,30),this.registerSetting(Settings.projectOpacity,n,!0,30),this.registerSetting(Settings.checkboxOpacity,n,!0,30),this.registerSetting(Settings.checkboxBackgroundOpacity,n,!0,0),this.registerSetting(Settings.showVerticalLines,n,!0,!0),this.registerSetting(Settings.verticalLinesOpacity,n,!0,6),this.registerSetting(Settings.boldHeaders,n,!0,!1),this.registerSetting(Settings.itemPadding,n,!0,5),this.registerSetting(Settings.notePadding,n,!0,0),this.registerSetting(Settings.itemLineHeight,n,!0,18),this.registerSetting(Settings.noteLineHeight,n,!0,18),this.registerSetting(Settings.fontSize,n,!0,14),this.registerSetting(Settings.fontSizeHeader,n,!0,16),this.registerSetting(Settings.fontSizeHeaderTopLevel,n,!0,18),this.registerSetting(Settings.noteFontSize,n,!0,12),this.registerSetting(Settings.itemIndentSize,n,!0,30),this.registerSetting(Settings.tagColor,n,!0,"#0099DD"),this.registerSetting(Settings.dateColor,n,!0,"#AA3300"),this.registerSetting(Settings.contactColor,n,!0,"#22AA66"),this.registerSetting(Settings.linkColor,n,!0,"#3333BB"),this.registerSetting(Settings.underlineP,n,!0,!1),this.registerSetting(Settings.displaySpacing,n,!0,l.a.DisplayTheme.SpacingComfortable),this.registerSetting(Settings.displayPrefixes,n,!0,l.a.DisplayTheme.PrefixesFaded),this.registerSetting(Settings.grayscale,n,!0,!1),this._setupLocalNotifications(),this._ensureLocalLoaded(),this._ensureRemoteSettings()},_setupLocalNotifications:function(){r.default.shouldWriteLocal()&&window.addEventListener("storage",function(e){if(e||(e=window.event),"localSettings"===e.key){var t,i;try{if(e.oldValue&&(t=this._deserializeSettings(e.oldValue)),e.newValue&&(i=this._deserializeSettings(e.newValue)),t&&i){var a=0;r.default.Assert(t.values,"Must have a valid set of old settings"),r.default.Assert(i.values,"Must have a valid set of new settings");for(var n=0;n<this._changeListeners.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=this._changeListeners[n];r.default.Assert(s,"Each listener must have a valid entry");var o=t.values[s.groupID],l=i.values[s.groupID],d=void 0,u=void 0;if(o&&l?(d=o[s.key],u=l[s.key]):!o&&l?(d=void 0,u=l[s.key]):o&&!l&&(d=o[s.key],u=void 0),d!==u)try{s.fn(d,u)}catch(e){r.default.reportError(e)}}for(var c in i.versions)if(i.versions.hasOwnProperty(c)){var h=i.versions[c],f=t.versions[c];if(h)for(var p in h)if(h.hasOwnProperty(p)){var g=h[p],m=f?f[p]:void 0;if(!f||m<g){var v=i.values[c][p],_=f?t.values[c][p]:void 0;this.fireEvent("settingChanged",c,p,[_,v])}}}}}catch(e){r.default.reportError(e)}this._localLoaded=!1,i?this._loadLocalSettings(i):r.default.Assert(!1,"Unable to update settings to be empty")}}.bind(this),!1)},registerForChangeNotification:function(e,t,i){r.default.Assert(e,"Must provide a valid key to watch"),r.default.Assert(i&&r.default.isFunction(i),"Must provide a valid callback fn",i),t=t||a,this._changeListeners.push({key:e,groupID:t,fn:i})},_testLocalWrites:function(){var e=!1;try{o.a.storage.setItem("poke",0),e=!0}catch(e){r.default.preventLocalWrites(l.a.LocalWriteReason.NoPermission)}return e},registerGroup:function(e){this._versions[e]||(this._versions[e]={},this._values[e]={})},registerSetting:function(e,t,i,n){t=t||a,i=i||!1,r.default.Assert(this._versions[t],"Must first register a group before a setting in the group"),this._versions[t][e]||(this._versions[t][e]={version:-1,syncRemote:i}),void 0!==n&&void 0===this._values[t][e]&&(this._values[t][e]=n)},registerAPIServerNotification:function(e,t){t=t||a,this._apiNotifications[t]||(this._apiNotifications[t]={}),this._apiNotifications[t][e]=!0},get:function(e,t){return t=t||a,r.default.Assert(e,"Must specify a valid setting to get"),r.default.Assert(this._versions[t],"Must first register a group before getting a setting from it"),r.default.Assert(!this._versions[t]||void 0!==this._versions[t][e],"Must first register a setting before getting a value from it: "+e),this._ensureLocalLoaded(),this._values[t][e]},set:function(e,t,i){i=i||a,r.default.Assert(e,"Must specify a valid setting to get"),r.default.Assert(this._versions[i],"Must first register a group before getting a setting from it"),r.default.Assert(!this._versions[i]||void 0!==this._versions[i][e],"Must first register a setting before setting a value to it");var n=!1;this._ensureLocalLoaded();var s=this._values[i][e],o=this._versions[i][e].version;if((s!==t||r.default.isObject(t)||r.default.isArray(t))&&(n=!0),n){var l=o+1;this._versions[i][e].syncRemote&&this._remoteLoaded&&this._setRemoteValue(e,t,l,i),(this._values[i][e]!==t||this._versions[i][e].version!==l)&&(this._values[i][e]=t,this._versions[i][e].version=l,this._writeLocalSettings(),this._sendChangeNotification(i,e,s,t,ChangeType.Local))}},reset:function(e,t){t=t||a,r.default.Assert(e,"Must specify a valid setting to get"),r.default.Assert(void 0!==this._versions[t],"Must first register a group before getting a setting from it"),r.default.Assert(!1===this._versions[t][e].syncRemote,"Currently do not support resetting remote syncd settings"),this._ensureLocalLoaded();var i=this._values[t][e];delete this._values[t][e],this._writeLocalSettings(),this._sendChangeNotification(t,e,i,void 0,ChangeType.Local)},resetAll:function(e){if(r.default.Assert(!r.default.isArray(e),"Must pass in a valid settings object to skip"),r.default.isArray(e)){var t=e;(e={})[a]=t}for(var i in this._versions)if(this._versions.hasOwnProperty(i)){var n=this._versions[i],s=e?e[i]:void 0;for(var l in n)(!s||s.indexOf(l)<0)&&(this._versions[i][l].version=-1,this._values[i][l]=void 0)}if(e)this._writeLocalSettings();else if(r.default.shouldWriteLocal())try{o.a.storage.setItem("localSettings","{}")}catch(e){r.default.reportError(e)}},_ensureLocalLoaded:function(){if(r.default.shouldWriteLocal()&&!this._localLoaded)try{var e=o.a.storage.getItem("localSettings");e||(r.default.isFirstRun=!0),this._loadLocalSettings(this._deserializeSettings(e))}catch(e){r.default.reportError(e),this._localLoadError=!0}},_serializeSettings:function(){var e={__version:1,versions:{},values:{}};for(var t in this._versions)if(this._versions.hasOwnProperty(t)){var i=this._versions[t];for(var a in i)if(i.hasOwnProperty(a)){var n=this._versions[t][a].version,s=this._values[t][a];this._versions[t][a].syncRemote&&(e.versions[t]||(e.versions[t]={}),e.versions[t][a]=n),e.values[t]||(e.values[t]={}),void 0!==s&&(e.values[t][a]=s)}}return e},_deserializeSettings:function(e){var t={versions:{},values:{}};if(e)try{var i=JSON.parse(e);if(void 0===i.__version){for(var n in t.versions[a]={},t.values[a]={},i)if(n.startsWith("V~")){var s=i[n];t.versions[a][n.substr("V~".length)]=s}else{var o=i[n];t.values[a][n]=o}}else 1===i.__version?(t.versions=i.versions,t.values=i.values):r.default.Assert(!1,"Invalid settings version")}catch(e){r.default.reportError(e)}return t},_loadLocalSettings:function(e){r.default.Assert(!this._localLoaded,"Should not load settings from local twice"),r.default.Assert(e,"Must supply some valid parsed settings"),r.default.Assert(!e||e.versions,"Must have a valid constructed parsed settings - versions"),r.default.Assert(!e||e.values,"Must have a valid constructed parsed settings - values");var t=e.versions,i=e.values;for(var a in t)if(t.hasOwnProperty(a)){var n=t[a];for(var s in this._versions[a]||(this._versions[a]={}),n)n.hasOwnProperty(s)&&(this._versions[a][s]={version:n[s],syncRemote:!0})}for(var o in i)if(i.hasOwnProperty(o)){var l=i[o];for(var d in this._values[o]||(this._values[o]={}),l)l.hasOwnProperty(d)&&(this._values[o][d]=l[d])}this._localLoaded=!0,this._localLoadError=!1},_writeLocalSettings:function(){if(r.default.shouldWriteLocal()||r.default.isLocalWriteReason(l.a.LocalWriteReason.QuotaError))try{var e=this._serializeSettings();0,o.a.storage.setItem("localSettings",JSON.stringify(e))}catch(e){r.default.reportError(e);try{o.a.storage.setItem("localSettings","{}")}catch(e){r.default.reportError(e)}this._localWriteError=!0}},_ensureRemoteSettings:function(){this._remoteRequested||this._remoteLoaded||r.default.vmMain&&r.default.vmMain.realtimeDocManager&&(this._remoteRequested=!0,r.default.vmMain.realtimeDocManager.registerForReadyNotification(l.a.DocType.GAppData,function(){this._remoteSettings=r.default.vmMain.realtimeDocManager.createDocument(l.a.DocType.GAppData,"RemoteSettings"),this._remoteSettings.open("RemoteSettings",this._onRemoteLoad.bind(this),this._onRemoteInit.bind(this),this._onRemoteError.bind(this))}.bind(this)))},_getRemoteEntry:function(e,t){if(this._remoteLoaded){var i=this._remoteSettings.getModel().getRoot().get("settings").get(t);if(i)return i.get(e)}},_getRemoteValue:function(e,t){var i=this._getRemoteEntry(e,t);if(i)return i.value},_getRemoteVersion:function(e,t){var i=this._getRemoteEntry(e,t);return i?i.ver:-1},_setRemoteValue:function(e,t,i,n){if(n=n||a,this._remoteLoaded){var s=this._remoteSettings.getModel(),r=s.getRoot().get("settings"),o=r.get(n);o||(o=s.createMap(),r.set(n,o)),o.set(e,{value:t,ver:i})}},_sendChangeNotification:function(e,t,i,a,n){var s=0;this.fireEvent("settingChanged",e,t,[a,i]);for(var o=0;o<this._changeListeners.length;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var l=this._changeListeners[o];if(e===l.groupID&&t===l.key)try{l.fn(i,a)}catch(e){r.default.reportError(e)}}!r.default.isDemoMode()&&r.default.isLocalChange(n)&&this._shouldNotifyAPIServer(e,t)&&this._notifyAPISever(e,t,a)},_findGroupForMap:function(e,t){for(var i=0,a=e.items(),n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(a[n][1]===t)return a[n][0]}},_onRemoteSettingsChange:function(e){for(var t=0,i=0;i<e.events.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=e.events[i];if(!a.isLocal){0;var n=this._findGroupForMap(e.currentTarget,a.target);n&&a.newValue&&this._remoteSettingLoaded(a.property,a.newValue.value,a.newValue.ver,n)}}},_remoteSettingLoaded:function(e,t,i,a){r.default.Assert(a,"Must specify a valid groupID at this point"),this._versions[a]||this.registerGroup(a),this._versions[a][e]||this.registerSetting(e,a,!0);var n=this._values[a][e],s=this._versions[a][e].version;i>s?(this._values[a][e]=t,this._versions[a][e].version=i,this._sendChangeNotification(a,e,n,t,ChangeType.Remote)):i<s?(this._setRemoteValue(e,n,s,a),this._shouldNotifyAPIServer(a,e)&&this._notifyAPISever(a,e,n)):i===s?r.default.isArray(n)?(r.default.Assert(r.default.isArray(t),"Must both be arrays or neither arrays"),r.default.Assert(n.equals(t),"Arrays must match")):r.default.isObject(n)?r.default.Assert(r.default.areObjectsEqual(n,t),"Should match if the versions are the same: "+e+" - "+a):r.default.Assert(n===t,"Should match if the versions are the same: "+e+" - "+a):r.default.Assert(!1,"What - remote and local versions are messed up",i,s)},_onRemoteLoad:function(e){r.default.Assert(this._localLoaded,"Local settings must be loaded before remote"),r.default.Assert(this._remoteRequested,"Remote document must have been requested"),this._remoteLoaded=!0;var t=!1,i=!1,a=e.getModel(),n=a.getRoot(),s=n.get("settings");n.get("info");try{for(var o=0,l=s.items(),d=0;d<l.length;++d){var u=0;if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;for(var c=l[d][0],h=l[d][1].items(),f=0;f<h.length;++f){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;var p=h[f][0],g=h[f][1],m=g.value,v=g.ver;t=t||this._remoteSettingLoaded(p,m,v,c)}}for(var _ in this._versions)if(this._versions.hasOwnProperty(_)){var y=this._versions[_];for(var S in y)if(y.hasOwnProperty(S)&&this._versions[_][S].syncRemote&&-1!==this._versions[_][S].version){var w=s.get(_);w||(i||(a.beginCompoundOperation("Sync Settings",!1),i=!0),w=a.createMap(),s.set(_,w));var I=w.get(S);I||(i||(a.beginCompoundOperation("Sync Settings",!1),i=!0),I={value:this._values[_][S],ver:this._versions[_][S].version},w.set(S,I))}}}catch(e){r.default.reportError(e)}i&&a.endCompoundOperation(),s.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,this._onRemoteSettingsChange.bind(this)),t&&this._writeLocalSettings()},_onRemoteError:function(e){r.default.Assert(this._localLoaded,"Local settings must be loaded before remote"),r.default.Assert(this._remoteRequested,"Remote document must have been requested"),this._remoteLoaded=!1,this._remoteLoadError=!0},_onRemoteInit:function(e){r.default.Assert(this._localLoaded,"Local settings must be loaded before remote"),r.default.Assert(this._remoteRequested,"Remote document must have been requested");var t=e.getRoot(),i=e.createMap(),a=e.createMap();a.set("settingsVer",1),t.set("settings",i),t.set("info",a)},_shouldNotifyAPIServer:function(e,t){return this._apiNotifications[e]&&this._apiNotifications[e][t]},_notifyAPISever:function(e,t,i){r.default.billingManager.onConnected(function(){r.default.billingManager.onBillingIdentifierAvailable(function(){r.default.XHR_PrivateAPI({type:"POST",path:"/user/settings/set",data:{email:r.default.billingManager.getBillingIdentifier(),groupID:e,key:t,value:i},requireAuth:!0,autoRetry:!0,cb:function(a){200!==a.status&&r.default.reportError(new Error("Unable to notify API server of remote setting: "+a.status+" "+e+" "+t+" "+i))}})})})},getRawSettings:function(){var e;if(r.default.shouldWriteLocal())try{e=o.a.storage.getItem("localSettings")}catch(e){r.default.reportError(e)}else try{return JSON.stringify(this._serializeSettings())}catch(e){return r.default.reportError(e),'{m:"Invalid Settings"}'}return e},hasLoadedRemote:function(){return this._remoteLoaded},_dumpSettings:function(){log("---- Settings ----"),log("Versions: ",this._versions),log("Values: ",this._values)},selectFullItems:function(){return this.get(Settings.selectFullItems)},showImagesInline:function(){return this.get(Settings.showImagesInline)}},o.a.defineBase(u),o.a.extend(u.prototype,d.a),r.default.settings=new u;i(64);var c=i(45),h=i(21),f=i(16),p=i(4),g=i(13),m=i(50),v=i(9),_=i(65),y=i(7),S=i(41),w=i(8),I=i(18);function b(e,t){this._remoteData=t?e:void 0,e=e||{},this.id=e.id,this._title=new w.a(e.title||""),this._isShared=new w.a(e.shared||!1),this._isOwned=new w.a(!this._remoteData),this._isOpen=new w.a(!1),this._isDeleted=!1,this._isTrashed=this._isRemoteTrashed(this._remoteData),this._docFolderID=void 0,this._realtimeDoc=void 0,this._remoteData&&this.updateData(this._remoteData)}b.prototype={_isRemoteTrashed:function(e){var t=!1;return e&&e.labels?t=!!e.labels.trashed:e||(t=!0),t},updateData:function(e,t){if(r.default.Assert(e,"Must supply remote data to update doc"),e){if(this._remoteData)for(var i in r.default.Assert(!e.id||e.id===this.id,"ID must either not exist or be the same"),e)e.hasOwnProperty(i)&&(this._remoteData[i]=e[i]);else this._remoteData=e,this.id=e.id;r.default.settings.get(Settings.gdocId)===this._remoteData.id&&r.default.settings.set(Settings.gdocTitle,this._remoteData.title),this._title.set(this._remoteData.title),this._isShared.set(this._remoteData.shared);var a=this._remoteData.userPermission;a&&"me"===a.id&&"owner"===a.role?this._isOwned.set(!0):this._isOwned.set(!1)}this._isTrashed=this._isRemoteTrashed(this._remoteData)},setRealtimeDoc:function(e){r.default.Assert(!this._realtimeDoc,"Must only have a single realtime doc instance per doc"),this._realtimeDoc=e},hasDriveBacking:function(){return!!this._remoteData},generateShareInfo:function(e){var t,i={};i.fromUser=r.default.getUserIdentifier(),e&&(i.toUser=e);try{var a=JSON.stringify(i);t=r.default.utf8_to_b64(a)}catch(e){r.default.reportError(e)}return t},insertPermission:function(e,t){r.default.Assert(this._remoteData,"Must have remote data to add permissions"),r.default.Assert(this.id,"Must specify a valid document ID to operate on"),r.default.Assert(e,"Must specify a valid email to add");var i="https://www.moo.do/web/#login=true&file="+this.id+"&sinfo="+this.generateShareInfo(e),a=function(a){r.default.XHR_PrivateAPI({type:"POST",path:"/sharing/shareDoc",data:{fromUser:r.default.getUserIdentifier(),toEmail:e,docURL:i},requireAuth:!0,cb:function(e){e.status}}),this.getDocumentFolder(function(t){r.default.vmMain.remoteAPI().drivePermissionsInsert(t,e,!1,function(e){},function(e){})}),a&&(this._remoteData.permissions.push(a),this._remoteData.shared=!0,this._isShared.set(!0)),t(!!a)}.bind(this),n=function(i){var s=!1;if(i.error&&400===i.error.code)for(var o=0,l=i.error.errors,d=0;d<l.length;++d){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;"invalidSharingRequest"===l[d].reason&&(r.default.vmMain.remoteAPI().drivePermissionsInsert(this.id,e,!0,a,n),s=!0)}s||t(!1)}.bind(this);r.default.vmMain.remoteAPI().drivePermissionsInsert(this.id,e,!1,a,n)},deletePermission:function(e,t){r.default.Assert(this._remoteData,"Must have valid remote data to remove permissions"),r.default.Assert(this.id,"Must specify a valid document ID to operate on"),r.default.Assert(e,"Must specify a valid permissionID to remove");var i=function(i){for(var a=0,n=0;n<this._remoteData.permissions.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(this._remoteData.permissions[n].id===e){this._remoteData.permissions.removeAt(n);break}}1===this._remoteData.permissions.length&&(this._remoteData.shared=!1,this._isShared.set(!1)),t(!0)}.bind(this);r.default.vmMain.remoteAPI().drivePermissionsDelete(this.id,e,i,function(e){t(!1)}),this.getDocumentFolder(function(t){r.default.vmMain.remoteAPI().drivePermissionsDelete(t,e,function(e){},function(e){})})},listPermissions:function(e){r.default.Assert(this._remoteData,"Must have valid remote data to list permissions");r.default.vmMain.remoteAPI().drivePermissionsList(this.id,function(t){e(t.items)},function(t){e(void 0)})},getDocumentFolder:function(e){if(r.default.Assert(!r.default.isDemoMode(),"Should not be creating file structure in demo mode"),r.default.Assert(e,"Must provide a valid callback when getting the doc folder"),r.default.Assert(this.id,"Must have a valid id"),r.default.Assert(this.getTitle(),"Must have a valid doc title"),this._docFolderID)return e(this._docFolderID);var t=function(){this.createDocumentFileStructure(function(t){return t?(this._docFolderID=t,e(t)):e(void 0)})}.bind(this),i=f.default.DocFolderPropertyPrefix+this.id;try{var a="properties has {key='"+f.default.DocFolderProperty+"' and value='"+i+"' and visibility='PRIVATE'} and trashed=false",n=function(i){if(0!==i.length){r.default.Assert(1===i.length,"Must have only a single document folder");var a=i[0];return this._docFolderID=a.id,this.updateDocumentFolderProps(a),e(a.id)}t()}.bind(this),s=function(t){return e()};r.default.vmMain.remoteAPI().driveFilesList(a,n,s,{getAllPages:!0})}catch(t){return r.default.reportError(t),e()}},updateDocumentFolderProps:function(e){if(r.default.Assert(e,"Must provide valid doc folder info"),this.getTitle()){var t=!1,i=!1;if(e.properties)for(var a=0,n=0;n<e.properties.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(e.properties[n].key===f.default.DocFolderTitleProperty){e.properties[n].value!==this.getTitle()&&(t=!0);break}}else i=!0;if(i){var s=function(){},o=function(e){r.default.reportError(new Error("Unable to update drive folder title property"))};r.default.vmMain.remoteAPI().drivePropertiesInsert(e.id,f.default.DocFolderTitleProperty,this.getTitle(),s,o)}else if(t){s=function(){},o=function(e){r.default.reportError(new Error("Unable to update drive folder title property"))};r.default.vmMain.remoteAPI().drivePropertiesUpdate(e.id,f.default.DocFolderTitleProperty,this.getTitle(),s,o)}}f.default.getRootFolder(function(t){if(t){var i=!1;if(e.parents)for(var a=0,n=0;n<e.parents.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(e.parents[n].id===t){i=!0;break}}if(!i){r.default.vmMain.remoteAPI().driveParentsInsert(e.id,t,function(){},function(e){r.default.reportError(new Error("Unable to add shared doc folder to root folder"))})}}}),this.hasDriveBacking()&&this.ensureFolderPermissions(e)},createDocumentFileStructure:function(e){r.default.Assert(this.id,"In order to create a valid folder structure we must have a valid document ID"),r.default.Assert(this.getTitle(),"Must provide a valid document title"),f.default.getRootFolder(function(t){if(!t)return e();var i=[{key:f.default.DocFolderProperty,value:f.default.DocFolderPropertyPrefix+this.id,visibility:"PRIVATE"}];this.getTitle()&&i.push({key:f.default.DocFolderTitleProperty,value:this.getTitle(),visibility:"PRIVATE"});var a=I.a.fns("drive").files.insert.packedFn,n={resource:{fields:"createdDate,id,mimeType,owners(displayName,isAuthenticatedUser,permissionId,emailAddress),parents(id,isRoot),permissions(id,name,emailAddress,role,type),properties,shared,appDataContents,sharedWithMeDate,sharingUser(displayName,permissionId,emailAddress),title,userPermission(id,role,type)",mimeType:f.default.FOLDER_MIMETYPE,title:f.default.DocFolderTitlePrefix+this.id,writersCanShare:!1,parents:[{id:t}],properties:i}},s=function(t){return this._docFolderID=t.id,this.hasDriveBacking()&&this.ensureFolderPermissions(t),e(t.id)}.bind(this);r.default.vmMain.remoteAPI().runRemoteSingleRequest(a,n,s,function(t){return e()})}.bind(this))},ensureFolderPermissions:function(e){r.default.Assert(this._remoteData,"Must have valid remote data to take permissions from"),r.default.Assert(e,"Must supply a valid folder ID to set permissions on");var t=function(e){},i=function(e){},a=e.permissions,n=this._remoteData.permissions;function s(e){var t=!1;if(a)for(var i=0,n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(a[n].emailAddress===e){t=!0;break}}return t}if(r.default.Assert(n,"Must always have a valid list of permissions for this doc"),n)for(var o=0,l=0;l<n.length;++l){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var d=n[l];if("anyone"===d.type);else{var u=d.emailAddress;u&&"owner"!==d.role&&(s(u)||r.default.vmMain.remoteAPI().drivePermissionsInsert(e.id,u,!1,t,i))}}},rename:function(e,t){if(this._remoteData||this.getTitle()){r.default.Assert(e,"Must specify a valid title to rename to"),r.default.Assert(r.default.isFunction(t),"Must supply a valid callback fn"),r.default.Assert(this.getTitle(),"Must have a valid title set already"),r.default.Assert(this.getTitle()!==e,"Should always be setting to a different title");var i=I.a.fns("drive").files.patch.packedFn,a={fileId:this.id,resource:{title:e}},n=function(i){this.getDocumentFolder(function(t){r.default.vmMain.remoteAPI().drivePropertiesUpdate(t,f.default.DocFolderTitleProperty,e,function(e){},function(e){r.default.reportError(new Error("Unable to update drive folder title property"))})}.bind(this)),this._title.set(e),this._remoteData.title=e,this.isOpen()&&f.default.setDocInfo(this.id,e),log("File renamed to:"+e),t(!0)}.bind(this);r.default.vmMain.remoteAPI().runRemoteSingleRequest(i,a,n,function(e){t(!1)})}else this._title.set(e),t(!0)},shareFile:function(e,t){r.default.Assert(e,"Must specify a valid fileID to share"),r.default.Assert(t,"Must specify a valid callback for sharing"),this.getDocumentFolder(function(i){r.default.vmMain.remoteAPI().driveParentsInsert(e,i,function(e){t(!0,e)},function(e){t(!1,e)})})},unshareFile:function(e,t){r.default.Assert(e,"Must specify a valid fileID to unshare"),r.default.Assert(t,"Must specify a valid callback for unsharing"),this.getDocumentFolder(function(i){r.default.vmMain.remoteAPI().driveParentsDelete(e,i,function(e){t(!0)},function(e){t(!1)})})},deleteData:function(e){var t=0,i=!1,a=function(){t--,s()},n=function(){i=!0,t--,s()},s=function(){0!==t||i||this.getDocumentFolder(function(e){r.default.vmMain.remoteAPI().driveFilesTrash(e,function(){this._docFolderID=void 0},function(){})})}.bind(this),o=function(i){this.getDocumentFolder(function(e){r.default.vmMain.remoteAPI().driveChildrenList(e,function(i){for(var s=0,o=0;o<i.length;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var l=I.a.fns("drive").children.delete.packedFn,d={folderId:e,childId:i[o].id};t++,r.default.vmMain.remoteAPI().runRemoteSingleRequest(l,d,a,n)}},function(e){},{getAllPages:!0,maxPageResults:500})}),this._isDeleted=!0,this._isTrashed=!0,this._remoteData&&(this._remoteData.trashed=!0),e(!0)}.bind(this);r.default.vmMain.remoteAPI().driveFilesTrash(this.id,o,function(t){e(!1)})},isShared:function(){return this._isShared.get()},isOwned:function(){return this._isOwned.get()},isTrashed:function(){return this._isTrashed&&!this.isShared()},open:function(){r.default.Assert(!this._isOpen.get(),"Document must be closed to be opened"),this._isOpen.set(!0),r.default.vmMain.docManager.setDocOpened(this.id)},close:function(){r.default.Assert(this._isOpen.get(),"Document must be opened to be closed"),this._isOpen.set(!1),r.default.vmMain.docManager.setDocClosed(this.id)},isOpen:function(){return this._isOpen.get()},getTitle:function(){return this._title.get()},getData:function(){return this._remoteData}};var A=b;function D(){this.fileMap={},this.isLoading=new w.a(!1),this.showError=new w.a(!1),this.listHeight=void 0,this.scrollDebounced=!1,this._openFile=void 0,this.loadCallbacks=[],this.init()}D.prototype={init:function(){setTimeout(function(){r.default.vmMain.docManager.getDocList().listen(function(){g.a.fireEvent("documentsLoaded",[])}.bind(this))}.bind(this),0)},hasFiles:function(){return r.default.vmMain.docManager.getDocList().get().length>0},showLoading:function(){return!this.hasFiles()&&!this.showError.get()},refreshFiles:function(){this.loadFileList()},runLoad:function(){r.default.vmMain.docManager.loadDocList(function(e){e||this.showError.set("Refresh Documents List"),this.isLoading.set(!1)}.bind(this))},loadFileList:function(){this.isLoading.get()||(this.isLoading.set(!0),this.showError.set(!1),this.runLoad())},requestOpenDocument:function(e){var t=r.default.vmMain.docManager.getDoc(e);t?this.openDocument(t):this.openDocumentFromId(e)},openDocumentFromId:function(e,t){r.default.Assert(e,"Document should always have a valid id"),r.default.Assert(t,"Document should always have a valid title"),f.default.getDocId()!==e&&(v.a.hasPotentialUnsavedData()&&!r.default.hasPageDataBeenCleared()?r.default.toasts.pushMessage({text:"You have made changes that have not been saved to the server. Go online to sync.",actionText:"OKAY"}):r.default.isOffline()?r.default.toasts.pushMessage({text:"You are currently offline. Connect to the internet to switch files.",actionText:"OKAY"}):s.default.clearData(function(){f.default.setDocInfo(e,t),o.a.hasURLParam("file")?o.a.removeURLParam("file",!0):o.a.hasURLParam("state")&&o.a.removeURLParam("state",!0),setTimeout(function(){r.default.reload()},500)},s.default.defaultSkipSettings,!0))},openDocument:function(e){r.default.localDocChangeRequested=!0,this.openDocumentFromId(e.id,e.getTitle())},onTapReloadDocuments:function(e){this.loadFileList()},openSharing:function(e,t){r.default.menus.openModalNew(Modals.ShareDoc,{doc:e,callback:t})},onTapAddDocument:function(){if(r.default.vmMain&&r.default.vmMain.isOnline()){var e=r.default.vmMain.docManager.createNewDoc();r.default.sendEvent("Menu","AddDocument"),this.openSharing(e,function(t){t&&r.default.vmMain.docManager.setDoc(e)}),y.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.AddDocument})}else r.default.toasts.pushMessage({text:"You must be online to create a new document."})},onTapRefresh:{onStart:r.default.stopPropagation,onClick:function(){r.default.vmMain&&r.default.vmMain.isOnline()&&!this.isLoading.get()&&this.refreshFiles()}}};var T=D,M=i(3);function C(){this.isVisible=new w.a(!1),this.mode=new w.a,this.aboutToShow=void 0,this.bottomPosition=new w.a(0),this.topBarHidden=!1,this.init()}C.prototype={init:function(){g.a.listen("closeKeyboard",this.hide.bind(this)),g.a.listen("itemsUpdated",M.a.closeKeyboardIfNoSelection)},preShow:function(){this.aboutToShow=!0,setTimeout(function(){this.aboutToShow=!1}.bind(this),100)},show:function(e){this.aboutToShow=!1,this.updatePosition(),this.mode.set(e),r.default.isKeyboardOpen=!0,(!p.a.ie||p.a.ie&&(p.a.mobro||p.a.winphone))&&this.isVisible.set(!0),setTimeout(function(){y.a.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.OpenKeyboard}),r.default.fireCustomEvent("keyboardOpened")},0)},hide:function(){!this.aboutToShow&&r.default.isKeyboardOpen&&(r.default.isKeyboardOpen=!1,r.default.focusedPane.removePadding(),r.default.onCloseKeyboard(),this.hideTopBarIfLandscape(),this.isVisible.set(!1),y.a.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.CloseKeyboard}))},shouldHideTopBar:function(){return p.a.orientation===Orientation.Landscape&&(r.default.isKeyboardOpen||this.aboutToShow)&&!r.default.getActiveSearch().UI.isFocused},hideTopBarIfLandscape:function(){this.shouldHideTopBar()?(r.default.setTransform(r.default.element("outerWrapper"),0,-r.default.topBarHeight),this.topBarHidden=!0):this.topBarHidden&&(this.topBarHidden=!1,r.default.setTransform(r.default.element("outerWrapper"),0,0))},updatePosition:function(){var e=p.a.getKBSize()-(this.shouldHideTopBar()?r.default.topBarHeight:0);e!==this.bottomPosition.get()&&this.bottomPosition.set(e),r.default.isKeyboardOpen&&r.default.focusedPane.addPadding()},getScroll:function(){return r.default.settings.get(Settings.keyboardToolbarScroll)},setScroll:function(e){r.default.settings.set(Settings.keyboardToolbarScroll,e)}};var L=new C,P=i(2),E=i.n(P),k=i(23),x=i(49);function R(e,t,i){this.isComplete=new w.a(!1),this.id=e,this.text=t,this.noRender=i,this.items=[],this.inOrder=!1,this.enforceOrder=!1,this.owner=void 0,this.numComplete=0,this.next=0}R.prototype={defaultShow:function(){this.isDisabled.set(!1)},loadFromSaveData:function(e){var t=0;this.numComplete=0;for(var i=0,a=0;a<this.items.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=this.items[a];e[n.id]&&(n.isComplete.set(!0),this.numComplete++,this.inOrder&&(this.next=Math.max(this.next,a+1))),n.hiddenObservable&&n.hiddenObservable.get()||n.visibleObservable&&!n.visibleObservable.get()||i++}if((this.numComplete===i||e[this.id])&&this.isComplete.set(!0),this.inOrder&&0!==this.next&&this.next<i){var s=this.items[this.next];s&&(s.show(),!r.default.isKeyboardOpen&&this.owner.needsKeyboardOpen&&r.default.tooltip.hideTip())}},saveData:function(e,t){for(var i=0,a=0;a<this.items.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=this.items[a];r.default.Assert(n,"Item entries must exist"),n.isComplete.get()&&(e[n.id]=1)}t&&this.isComplete.get()&&(e[this.id]=1)},addStep:function(e){r.default.Assert(!!e.id==!!e.check,"Invalid help step"),!1!==e.if&&(e.isComplete||(e.isComplete=new w.a(!1)),this.inOrder,e.isDisabled=new w.a(!1),e.isHotkeyOr=e.isHotkeyOr,e.show||(e.show=this.defaultShow.bind(e)),this.items.push(e))},complete:function(e){e.isComplete.get()||(e.isComplete.set(!0),this.numComplete++,this.numComplete===this.items.length&&this.isComplete.set(!0),this.owner.notifyOfChange(e))},forceComplete:function(){this.isComplete.set(!0),this.numComplete=this.items.length,this.owner.notifyOfChange()},check:function(e){var t=0;r.default.Assert(!this.isComplete.get(),"Should never be checking items in a completed section");for(var i=0;i<this.items.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=this.items[i];if(!a.isComplete.get()&&((!0===e||a.check&&a.check(e))&&(this.complete(a),this.inOrder&&i===this.next&&(this.next++,this.next<this.items.length&&this.items[this.next].show())),this.enforceOrder))break}}};var O=R,F=i(10),N={display:"inline-block",height:"24px"};function B(){r.default.menus.openSettings(l.a.SettingsSections.Plugins)}function U(){0}U.prototype={init:function(){this.mode=new w.a(l.a.HelpMode.None),this.position=new w.a,this.sections=new k.a,this.isVisible=new x.a([this.mode],function(){return this.isHelpShowing()}.bind(this)),this.priKey=p.a.priModKey,this.secKey=p.a.secModKey,this.secKeyForce=p.a.secModKeyForce,this.tooltipIntroSection=void 0;var e=r.default.settings.get(Settings.helpPaneState);void 0===e&&(e=l.a.HelpMode.None),this.initItemsDesktop(),r.default.isDemoMode()||this.initState(e),r.default.settings.registerForChangeNotification(Settings.helpPaneState,void 0,function(e,t){void 0!==t&&t!==e&&this.initState(t)}.bind(this)),r.default.settings.registerForChangeNotification(Settings.helpState,void 0,function(e,t){t&&t!==e&&this.loadState()}.bind(this)),y.a.addListener(this.onAction.bind(this))},isHelpShowing:function(){return this.mode.get()!==l.a.HelpMode.None},initState:function(e){r.default.Assert(void 0!==e,"Must pass in a valid intro mode"),this.sections.clear(),this.mode.set(e),this.isHotkeyMode()||this.initHelp(),this.loadStateLegacy(),this.loadState()},initItemsDesktop:function(){this.itemIndent={id:"458052715",text:'Press <span class="hHotkey">Tab</span> to indent an item into a list and <span class="hHotkey">Shift + Tab</span> to unindent out of a list',check:this.checkIndent},this.itemDateTime={id:"321249113",text:"Add a date/time by typing @ in the text of an item",check:this.checkDate},this.itemRightClick={id:"3288459206",text:"Right click an item to explore more options",check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.RightClick}};var e=r.default.vmMain.getDefaultEmailPlugin(),t=r.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar),i=r.default.vmMain.pluginManager.getPlugin(PluginID.Drive);this.itemPluginSettings={id:"ep",jsx:E.a.createElement("span",null,E.a.createElement("span",{style:N},E.a.createElement(F.a,{raised:!0,primary:!0,marginRight:8,onClick:B},"Enable plugins")),"to connect to your other services"),hiddenObservable:new x.a([e.isActiveObs,t.isActiveObs,i.isActiveObs]),check:function(){}},this.itemOpenEmail={id:"dblE",text:"Double click an email to open it",check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenEmail&&e.data.pane.type===PaneMode.Gmail}},this.itemDragEmail={id:"drgEm",text:"Drag an email to your Tasks to organize it",check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.DropItem&&e.data.fromPane&&e.data.fromPane.type===PaneMode.Gmail}},this.itemRightClickEmail={id:"rcE",text:"Right click an email to explore more options",check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.RightClick&&e.data.pane.type===PaneMode.Gmail}},this.itemGmailLabels={id:"lbls",text:'Click <i class="overviewButtonNormal icon-menu g"></i> in the top left to access your labels',check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.ToggleOverview&&e.data.pane.type===PaneMode.Gmail}},this.itemGmailCompose={id:"cmp",text:'Click <i class="icon-edit2 g"></i> in the sidebar to compose a new email',check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.ComposeEmail}}},setMode:function(e){this.mode.set(e),r.default.settings.set(Settings.helpPaneState,e)},show:function(e){this.setMode(e||l.a.HelpMode.Normal)},toggle:function(e){!this.isHelpShowing()||e&&this.mode.get()!==e?this.show(e):this.close()},close:function(){r.default.tooltip.hideTip(),this.setMode(l.a.HelpMode.None),r.default.sendEvent("Menu","CloseHelp")},isHotkeyMode:function(){return this.mode.get()===l.a.HelpMode.Hotkeys},loadStateLegacy:function(){if(r.default.shouldWriteLocal())try{var e=o.a.storage.getItem("help");if(e){var t=JSON.parse(e);if(t){for(var i=0,a=0;a<this.sections.get().length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;this.sections.get()[a].loadFromSaveData(t)}console.log("found old data and migrating it"),this.saveState(),o.a.storage.removeItem("help")}}}catch(e){r.default.reportError(e)}},_getHelpStateObj:function(){var e={},t=r.default.settings.get(Settings.helpState);if(t)try{(e=JSON.parse(t))&&!r.default.isString(e)||(e={})}catch(e){r.default.reportError(e)}return e||{}},loadState:function(){var e=this._getHelpStateObj();if(e)for(var t=0,i=0;i<this.sections.get().length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this.sections.get()[i].loadFromSaveData(e)}},saveState:function(){if(r.default.shouldWriteLocal())try{var e=this.getState();0,r.default.settings.set(Settings.helpState,JSON.stringify(e))}catch(e){r.default.reportError(e)}},getState:function(){for(var e=0,t=this._getHelpStateObj(),i=0;i<this.sections.get().length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;this.sections.get()[i].saveData(t)}return t},notifyOfChange:function(){this.saveState()},createSection:function(e,t,i,a){var n=0,s=new O(e,t,a);s.owner=this;for(var r=0;r<i.length;r++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;s.addStep(i[r])}return s},addSection:function(e,t,i,a){var n=this.createSection(e,t,i,a);return this.sections.push(n),n},checkAddItem:function(e){if(e.type===TrackerType.Create){var t=s.default.getModel(e.data[0].itemID);return!(!t||t.parent()===s.default.getRootModel()&&0===e.data[0].position)}},checkIndent:function(e){if(e.type===TrackerType.Move){var t=s.default.getItem(e.data[0].oldParent);if(t&&t.items.indexOf(e.data[0].newParent)>=0)return!0}},checkSearch:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged},checkComplete:function(e){if(e.type===TrackerType.Update){var t=e.data[0];return"isComplete"===t.field&&t.newValue}},checkOverview:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.ToggleOverview},checkZoom:function(e){return e.type===TrackerType.Zoom&&!e.data[0].zoomOut&&r.default.focusedPane.overview.isVisible.get()},checkPriority:function(e){var t=e.data[0];return e.type===TrackerType.Update&&"priority"===t.field&&t.newValue>0},checkDate:function(e){return e.type===TrackerType.Insert&&"@"===e.data[0].text},checkGoogleCalendar:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.AddToGCal},checkGoogleDrive:function(){},initHelp:function(){function e(){r.default.menus.openContextMenu({componentName:"ReactContextMenuOptions",element:"optionsButton"})}this.sections.clear(),this.addSection("2102025841","Organization",[this.itemIndent,{id:"3825397189",text:"Click and drag on the left edge of an item to move it",check:function(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.DropItem&&r.default.vmMain.isLoaded)return!0}},{id:"441256378",text:'Click the left edge of a list or press <span class="hHotkey">'+this.secKey+" + ,</span> to collapse its subitems",check:function(e){if(e.type===TrackerType.Update){var t=e.data[0];return"isCollapsed"===t.field&&t.newValue}}}]),this.addSection("prefixes","Item Prefixes",[{id:"header",text:"Start a line with "+l.a.Prefix.Header+" to create a project",check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SetPrefix&&e.data.prefix===l.a.Prefix.Header}},{id:"task",text:"Start a line with [ to create a task",check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SetPrefix&&e.data.prefix===l.a.Prefix.Task}},{id:"bullet",text:"Start a line with - to create a bullet",check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SetPrefix&&(e.data.prefix===l.a.Prefix.Bullet||e.data.prefix===l.a.Prefix.Bullet2||e.data.prefix===l.a.Prefix.Bullet3)}},{id:"numlist",text:"Start a line with 1. to create a numbered list",check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SetPrefix&&e.data.prefix===l.a.Prefix.NumList}}]),this.addSection("3980400482","Dates",[this.itemDateTime,{id:"2538562480",text:'Write dates in plain English like <span class="date c-date">@tomorrow</span>',check:function(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&r.default.vmMain.isLoaded)return!!e.data.date}},{id:"745092254",text:'Schedule a full date and time like <span class="date c-date">@today 2:30pm</span> or <span class="date c-date">@5/25 6:00</span>',check:function(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&r.default.vmMain.isLoaded){var t=e.data.date;if(t)return t.hasTimeOfDay()}}},{id:"3023653298",text:'Describe urgency with <span class="date c-date">@now</span>, <span class="date c-date">@soon</span>, or <span class="date c-date">@later</span>',check:function(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&r.default.vmMain.isLoaded){var t=s.default.getModel(e.data.itemID);return!!t&&r.default.isDateSoft(t.getDateText())}}},{id:"1941003875",text:'Create a repeating date like <span class="date c-date">@every friday</span> or <span class="date c-date">@every other tuesday</span>',check:function(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&r.default.vmMain.isLoaded){var t=e.data.date;if(t)return t.isRepeatDate()}}},{id:"766730775",text:'Create a repeating date with a beginning or end <span class="date c-date">@every friday from tomorrow</span> or <span class="date c-date">@every other tuesday until october</span>',check:function(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&r.default.vmMain.isLoaded){var t=e.data.date;if(t&&t.isRepeatDate())return!t.getStartDate().equals(Date.today())||!!t.getEndDate()}}}]),this.addSection("cal","Google Calendar (Premium)",[{id:"enableCalendar",jsx:E.a.createElement("span",null,E.a.createElement(F.a,{raised:!0,primary:!0,marginRight:8,onClick:B},"Enable Google Calendar"),"to sync Google Calendar."),hiddenObservable:r.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar).isActiveObs,check:function(){}},{id:"adc2",text:'Add an item with a date to Google Calendar by pressing <span class="hHotkey">'+this.secKeyForce+' + C</span> or right clicking the date.<span style="color: #777;"></span>',check:this.checkGoogleCalendar}]),this.addSection("3971635305","Priority",[this.itemRightClick,{id:"215510164",text:'Set a priority with the right click menu or <span class="hHotkey">'+this.secKey+" + 1|2|3</span>",check:this.checkPriority},{id:"2165585377",text:'Click the right edge of an item or <span class="hHotkey">'+this.secKey+" + /</span> to complete it",check:this.checkComplete},{id:"4286506454",text:'Press <span class="hHotkey">'+this.secKey+" + 8</span> to star an item and highlight it in yellow",check:function(e){if(e.type===TrackerType.Update){var t=e.data[0];return"isStarred"===t.field&&t.newValue}}}]),this.addSection("4240025947","Contacts",[{id:"9158366",text:"Add a contact by typing + in the text of an item",check:function(e){return e.type===TrackerType.Insert&&"+"===e.data[0].text}},{id:"1594166733",text:'Click on a <span class="contact c-contact">+contact</span> to start a call or email',check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenContact}}]),this.addSection("1493247039","Zooming",[{id:"1829655333",text:'To zoom in on an item, right click it and select Zoom In, press <span class="hHotkey">'+this.priKey+' + Enter</span>, or hold <span class="hHotkey">'+this.priKey+"</span> and click its left edge",check:function(e){return e.type===TrackerType.Zoom&&!e.data[0].zoomOut}},{id:"3440644647",text:"To zoom back out, click the title of the list in the top of the pane",check:function(e){return e.type===TrackerType.Zoom&&e.data[0].zoomOut}},{id:"801492595",text:'Press <i class="overviewButtonNormal icon-menu g"></i> in the top left of a pane to open the overview',check:this.checkOverview},{id:"1720747864",text:'Click an item in the Overview to scroll to it or click <i class="icon-zoom-in g"></i> to zoom into it',check:this.checkZoom}]),this.addSection("1393893782","Search",[{id:"3689209442",text:'Mark similar items with a <span class="tag">#tag</span> to easily search for all items matching that tag',check:function(e){return e.type===TrackerType.Insert&&e.data[0].text===l.a.TagPrefix}},{id:"2783340419",text:'Filter by priority by clicking the <span class="searchPriority searchP0 hovered"></span> <span class="searchPriority searchP1 hovered"></span> <span class="searchPriority searchP2 hovered"></span> buttons',check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&0!==e.data.priority}},{id:"923656242",text:'Show only starred items by clicking the <span class="c-foreground-faded icon-star"></span> button',check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&0!==e.data.starred}},{id:"2227925102",text:'Hide completed items by clicking the <span class="c-foreground-faded icon-check"></span> button',check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&0!==e.data.complete}},{id:"457209713",text:"Hide items you're not interested in by starting a search with - (dash)",check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged&&e.data.text.indexOf("-")>=0}}]),this.addSection("gm","Gmail",[{id:"eG",jsx:E.a.createElement("span",null,E.a.createElement(F.a,{raised:!0,primary:!0,marginRight:8,onClick:B},"Enable Gmail"),"to sync Gmail."),hiddenObservable:r.default.vmMain.pluginManager.getPlugin(PluginID.Gmail).isActiveObs,check:function(){}},this.itemOpenEmail,this.itemDragEmail,this.itemRightClickEmail,this.itemGmailLabels]),this.addSection("formatting","Formatting",[{id:"format",text:"Format text like <i>*italic*</i>, <b>**bold**</b>, or <b><i>***both***</i></b>",check:function(e){}},{id:"link",text:"Insert links like [title](http://address.com)",check:function(e){}},{id:"hr",text:"--- to insert a horizontal line",check:function(e){}}]),this.addSection("327865517","Collaboration",[{id:"3453735943",jsx:E.a.createElement("span",null,E.a.createElement("span",{style:N},"Click the ",E.a.createElement(F.a,{icon:"icon-folder",iconSize:18},"File"))," in the options button to open the Files menu"),check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenDocumentsMenu}},{id:"4176091097",text:'Click <i class="icon-settings f18 g"></i> to change the sharing settings',check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenDocSharing}}]),this.addSection("drv","Google Drive (Premium)",[{id:"eD",jsx:E.a.createElement("span",null,E.a.createElement(F.a,{raised:!0,primary:!0,marginRight:8,onClick:B},"Enable Google Drive"),"to sync Google Drive."),hiddenObservable:r.default.vmMain.pluginManager.getPlugin(PluginID.Drive).isActiveObs,check:function(){}},{id:"drL",text:"Drag a file from the Google Drive Pane to an Task Pane to add it to a list",check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.DropItem&&e.data.fromPane&&e.data.fromPane.type===PaneMode.Drive}},{id:"drDr",text:"Drag a file from your "+(p.a.mac?"Finder":"Explorer")+" to your Tasks to upload it to Drive and add it to a list",check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.DriveUpload}}]),this.addSection("set","Settings",[{id:"oS",jsx:E.a.createElement("span",null,"Click ",E.a.createElement("span",{style:N},E.a.createElement(F.a,{icon:"icon-settings",iconSize:18,onClick:e}))," in the sidebar, then Settings, to access plugin and account settings."),check:function(e){return e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.OpenSettingsMenu}},{id:"oDS",jsx:E.a.createElement("span",null,"Click ",E.a.createElement("span",{style:N},E.a.createElement(F.a,{icon:"icon-settings",iconSize:18,onClick:e}))," in the sidebar, then Display Settings, to change display settings."),check:function(e){return e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.OpenDisplaySettings}}]),this.addSection("3926176240","Data",[{id:"1927292896",jsx:E.a.createElement("span",null,"Click on Import Data in the options menu in the sidebar, then choose the app to import from and follow the instructions. If you do not see your app, try using copy and paste to paste it in to Moo.do. If that does not work, please ",E.a.createElement(F.a,{primary:!0,onClick:function(){r.default.menus.openModalNew(Modals.ReportBug)}},"contact us")," and tell us what app you want to import from."),check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenImport}},{id:"67562060",text:"Click on Export Data in the options menu in the sidebar, then choose the format you'd like.",check:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenExport}}])},onAction:function(e){if(!r.default.menus.isModalOpen(Modals.ImportData))try{for(var t=0,i=this.sections.get(),a=0;a<i.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;i[a].isComplete.get()||i[a].check(e)}}catch(e){r.default.reportError(e)}},runTooltipIntro:function(){r.default.settings.set(Settings.inTooltipIntro,!0),this.initTooltipIntro()},initTooltipIntro:function(){function e(){return r.default.vmMain.pluginManager.isGmailPaneEnabled()}function t(e){r.default.Assert(e,"Must supply a valid tooltip descriptor"),r.default.Assert(!e||e.element,"Must specify a valid target tooltip element"),r.default.tooltip.hideSticky(e.text),e.blue=!0,"top"===e.arrowDirection&&(e.offset={top:15}),r.default.tooltip.displayTipSticky(e)}var i,a,n,s=[];function o(e){var i=!1;s.push({id:e.id,check:function(a){return!(!e.check2Invalidates1||!e.check2(a))||(e.check1(a)?(setTimeout(function(){var a=r.default.isFunction(e.element)?e.element():e.element,n=r.default.isFunction(e.text)?e.text():e.text;a&&(i=!0,t({text:n,element:a,arrowDirection:e.arrowDirection,onRight:e.onRight}))},1e3),!0):void 0)}}),s.push({id:e.id+"_complete",check:function(t){if(e.check2(t)){if(i){var a=r.default.isFunction(e.text)?e.text():e.text;r.default.tooltip.hideSticky(a)}return!0}}})}if(o({id:"tipAddPaneMenu",text:"Click here to add a new pane",element:function(){return r.default.element("addPaneButton")},arrowDirection:"left",check2Invalidates1:!0,check1:this.checkAddItem,check2:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenAddPaneMenu}}),o({id:"tipAddPane",text:function(){return e()?"Add a Gmail pane to organize your email":"Add another Task pane to get another view on your tasks."},element:function(){return e()?r.default.element("addPane_PaneGmail"):r.default.element("addPane_PaneTask")},arrowDirection:"left",check2Invalidates1:!0,onRight:!0,check1:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.OpenAddPaneMenu},check2:function(t){return t.type===TrackerType.UIAction&&t.data[0].type===TrackerUIAction.AddPane&&t.data[0].data.type===(e()?PaneMode.Gmail:PaneMode.Task)}}),o({id:"tipNewTaskPane",text:"Each Task pane is a unique view on the same data. Customize your view by searching and filtering.",element:function(){if(i){var e=i.element;if(e)return e.getElementsByClassName("searchWrap")[0]}},arrowDirection:"top",check1:function(e){if(e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.AddPane&&e.data[0].data.type===PaneMode.Task)return i=e.data[0].data.pane,!0},check2:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.SearchChanged}}),o({id:"tipNewGmailPane",text:"Try dragging an email to your Task Pane",element:function(){if(a){var e=a.element;if(e)return e.getElementsByClassName("paneContent")[0]}},arrowDirection:"bottom",check2Invalidates1:!0,check1:function(e){if(e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.AddPane&&e.data[0].data.type===PaneMode.Gmail&&r.default.vmMain.paneManager.getPanesByType(PaneMode.Task).length>0)return a=e.data[0].data.pane,!0},check2:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.DropItem&&e.data.fromPane&&e.data.fromPane.type===PaneMode.Gmail}}),o({id:"tipNewGmailPane",text:"Each board is a different set of panes. Add a new pane to start setting up your new board.",element:function(){return r.default.element("addPaneButton")},arrowDirection:"left",onRight:!0,check1:function(e){return e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.AddBoard},check2:function(e){return e.type===TrackerType.UIAction&&e.data[0].type===TrackerUIAction.AddPane}}),o({id:"tipAddToCalendar",text:function(){return"Sync items with dates to Google Calendar by pressing "+p.a.secModKeyForce+" + C"},element:function(){var e=M.a.getStartElement();if(e)return e.getElementsByClassName("date")[0]},arrowDirection:"top",check1:function(e){if(e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate&&r.default.vmMain.isLoaded&&r.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar).isActive())return!0},check2:function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.AddToGCal}}),o({id:"tipOverviewButton",text:"Toggle the Overview open and closed",element:function(){var e=n.element;if(e)return e.getElementsByClassName("overviewButton")[0]},arrowDirection:"top",check1:function(e){if(e.type===TrackerType.Zoom)return n=e.data[0].pane,!0},check2:this.checkOverview,check2Invalidates1:!0}),r.default.vmMain.shouldShowHelp("helpTooltip")){setTimeout(function e(){if(r.default.tooltip.isOpenSticky())setTimeout(e,5e3);else if(r.default.vmMain.closeHelp("helpTooltip"),r.default.element("helpButton")){var i={text:"See the Help to learn more",element:r.default.element("helpButton"),arrowDirection:"left",onRight:!0};g.a.listen("helpOpened",function e(){r.default.tooltip.hideSticky(i.text),g.a.unlisten("helpOpened",e)}),t(i)}},9e4)}this.tooltipIntroSection=this.addSection("tooltipIntro","Tooltip Intro",s,!0)}};new U;var V=i(24),H=i(19),q=i(30);function z(){this._registeredRenderers=[],this._registeredRenderers[PluginRenderTypes.Generic]={},this._registeredRenderers[PluginRenderTypes.StyledText]={},this._registeredRenderers[PluginRenderTypes.UnstyledText]={},this._registeredRenderers[PluginRenderTypes.Measure]={}}z.prototype={registerDefaultRenderers:function(){var e=this;this.registerRenderer(PluginRenderTypes.StyledText,PluginRenderers.DriveFile,function(e,t,i){if(e.isLoaded()){var a=e.getField("title");return i&&(a=q.a.replaceTextWithSearch(a,t)),e.hasField("isDeleted")&&e.getField("isDeleted")?a+"  (Deleted)":a}return e.hasField("title")?e.getField("title")+"  (Loading...)":"Loading..."},["title"]),this.registerRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.DriveFile,function(e){return e.hasField("title")?e.getField("title"):"Loading..."},["title"]),this.registerRenderer(PluginRenderTypes.Measure,PluginRenderers.DriveFile,function(t,i,a){var n=e.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.DriveFile);return V.default.measureWord(i,n(t),a,!1)},["title"]),this.registerRenderer(PluginRenderTypes.StyledText,PluginRenderers.EmailThread,function(e,t,i){var a="";if(e&&e.isLoaded()){var n=e.getField("count"),s=e.getField("subject");if(s&&""!==s||(s="(no subject)"),i&&(s=q.a.replaceTextWithSearch(s,t)),s='<span class="subject c-foreground'+(n>1?" hasCount":"")+'">'+s+"</span>",t&&t.type===PaneMode.Gmail){var r=e.getPlugin().getDisplayTags(e,t);a+='<span class="line1"><span class="from">'+e.getPlugin().getDisplayParticipants(e)+"</span>";var o,l=e.getField("date");if(o=l.isToday()?H.a.getFormat(DFormat.ShortTime):l.getYear()!==(new Date).getYear()?H.a.getFormat(DFormat.MonthDayYearShort):H.a.getFormat(DFormat.MonthDay),a+='<span class="emailDate c-foreground-faded">'+l.toString(o)+"</span></span>",a+='<span class="line2">'+s,(e.getField("hasAttachments")||n>1)&&(a+='<span class="line2Right">',e.getField("hasAttachments")&&(a+='<span class="attach icon-attach_file"></span>'),n>1&&(a+='<span class="count">'+n+"</span>"),a+="</span>"),a+="</span>",e.hasField("snippet")||r.length){if(a+='<span class="line3">',e.hasField("snippet")&&(a+='<span class="snippet c-foreground-faded">'+e.getField("snippet")+"</span>"),r.length){var d=0;a+='<span class="tags">';for(var u=0;u<r.length;++u){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;a+='<span class="emailLabel c-tag">'+r[u]+"</span>"}a+="</span>"}a+="</span>"}}else a=s}else a="Loading...";return a},["from","subject","snippet","count","date"]),this.registerRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.EmailThread,function(e){if(e.isLoaded()){var t=e.getField("subject");return t&&""!==t||(t="(no subject)")," "+t+" "}return"Loading..."},["from","subject"]),this.registerRenderer(PluginRenderTypes.Measure,PluginRenderers.EmailThread,function(e,t,i){var a;e.isLoaded()?(a=e.getField("subject"))&&""!==a||(a="(no subject)"):a="Loading...";return V.default.measureWord(t,a,i,!1)},[]),this.registerRenderer(PluginRenderTypes.StyledText,PluginRenderers.CalendarEvent,function(e){return""},[]),this.registerRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.CalendarEvent,function(e){return""},[]),this.registerRenderer(PluginRenderTypes.Measure,PluginRenderers.CalendarEvent,function(t,i,a){var n=e.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.CalendarEvent);return V.default.measureWord(i,n(t),a,!1)},[]),this.registerRenderer(PluginRenderTypes.StyledText,PluginRenderers.Unknown,function(e){return"Unknown Plugin"},[]),this.registerRenderer(PluginRenderTypes.Measure,PluginRenderers.Unknown,function(e,t,i){return V.default.measureWord(t,"Unknown Plugin",i,!0)},[])},registerRenderer:function(e,t,i,a){r.default.Assert(this._registeredRenderers[e],"Invalid renderer type",e,t),r.default.Assert(!this._registeredRenderers[e][t],"Cannot register a renderer twice",e,t),this._registeredRenderers[e][t]={fn:i,fields:a}},useRenderer:function(e,t){return r.default.Assert(this._registeredRenderers[e],"Invalid renderer type",e,t),r.default.Assert(this._registeredRenderers[e][t],"Renderer has not been registered yet",e,t),this._registeredRenderers[e][t].fn},ensureRendererFields:function(e,t,i){}};var W=z,G=i(38),j=i(11);function K(e){this._cb=e,this._pageToken=void 0,this._validToken=!1}var Y={hasPaginationToken:function(){return this._validToken},needsPaginationToken:function(){return!this.hasPaginationToken()&&!this._pageToken},setPaginationToken:function(e){this._pageToken=e,this._validToken=!0,this._cb&&this._cb(this)},beginDataPageLoad:function(){return this._pageToken.notifyBeginUse(),this._pageToken},endDataPageLoad:function(e){e?this._pageToken.notifyEndUse():this._validToken=!1},notifyPaginationUpdate:function(){log("Pagination Update")}};o.a.defineBase(K),o.a.extend(K.prototype,Y);var X=K;function Q(e,t,i){this._super.constructor.call(this),this._searchQuery=e,this._invalid=!1,this._hasError=!1,this._remoteRequestCB=i,this._activePageRequest=void 0,this._lastPageRequest=void 0,this._cachedResults=[],this._localPageOffset=0,this._automaticPageRequests=0,this._pageSize=t,o.a.forceBind("onEntry",this)}var J={invalidate:function(){this._invalid=!0},isValid:function(){return!this._invalid},hasError:function(){return this._hasError},getNextPage:function(e,t){if(r.default.Assert(r.default.isFunction(e)&&r.default.isFunction(t)||this._lastPageRequest,"Must provide valid callbacks"),r.default.Assert(!this._invalid,"Should never request another page from an invalidated search"),r.default.Assert(this.hasMoreResults(),"Should never request another page if there are no possible results"),r.default.Assert(!this._activePageRequest,"Should only run a single request at a time"),e||t||!this._lastPageRequest||(e=this._lastPageRequest.entryCB,t=this._lastPageRequest.doneCB),this._activePageRequest)t(!1);else if(this._cachedResults.length>this._localPageOffset+this._pageSize){for(var i=0,a=0;a<this._pageSize;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=this._cachedResults[this._localPageOffset+a];try{e(n)}catch(e){r.default.reportError(e)}}this._localPageOffset+=this._pageSize,t(!0)}else if(this.hasPaginationToken()&&this._automaticPageRequests<5)this._activePageRequest={entryCB:e,doneCB:t},this._automaticPageRequests++,this._remoteRequestCB(this);else if(this._localPageOffset<this._cachedResults.length){var s=0;for(a=this._localPageOffset;a<this._cachedResults.length;++a){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;n=this._cachedResults[a];try{e(n)}catch(e){r.default.reportError(e)}this._localPageOffset++}t(!0)}},onEntry:function(e){this._invalid||this._cachedResults.push(e)},onDone:function(e){this._invalid||this._activePageRequest&&(this._lastPageRequest=this._activePageRequest,this._activePageRequest=void 0,e?this.getNextPage(this._lastPageRequest.entryCB,this._lastPageRequest.doneCB):(this._invalid=!0,this._hasError=!0,this._lastPageRequest.doneCB(e)))},hasResults:function(){return this._cachedResults.length>0},hasMoreResults:function(){return this._cachedResults.length>this._localPageOffset||this.hasPaginationToken()}};o.a.inherit(X,Q),o.a.extend(Q.prototype,J);var Z=Q,$={Unloaded:1,Waiting:2,Requesting:3,LoadedPreview:4,LoadedFull:5,FailedRequest:6,Updating:7};function ee(e,t,i){this.id=t,this._oldLocalID=void 0,this._plugin=e,this._loadState=$.Unloaded,this._subscribers=[],this._countInUse=0,this._iteratingSubscribers=!1,this._numRemoteRequests=0,this._inlineData=i,this.load()}ee.prototype={load:function(e){this._loadState=$.Waiting,this._plugin.requestData(this,e)},notifyDataRequested:function(){r.default.Assert(!this.isLoaded(),"Should not request additional data once loaded"),this._numRemoteRequests++,this._loadState=$.Requesting},notifyDataLoaded:function(e,t,i,a){r.default.Assert(t||this._loadState!==$.LoadedFull||r.default.isFlagSet(e,PluginLoad.Full),"Should not load preview data after full data has been loaded"),r.default.Assert(!t||this._loadState===$.LoadedPreview||r.default.isFlagSet(e,PluginLoad.Full),"Incoming update much match previous type"),this._loadState=r.default.isFlagSet(e,PluginLoad.Full)?$.LoadedFull:$.LoadedPreview,this.onUpdate(!0,i,a)},notifyDataMutated:function(e,t){r.default.Assert(e&&r.default.isArray(e),"Must specify valid update fields when mutating attachment state manually"),this.onUpdate(!0,e,t)},notifyDataRequestFailed:function(){r.default.Assert(this._loadState===$.FailedRequest||this._loadState===$.Requesting||this._loadState===$.LoadedPreview,"Must be requesting remote data or a preview cache was able to service after the request was sent"),this._loadState===$.FailedRequest||(this._loadState===$.Requesting?this._loadState=$.FailedRequest:this._loadState===$.LoadedPreview?r.default.Assert(!1,"Failed remote reuqest but serviced by preview cache, should not have made the request?"):r.default.Assert(!1,"Invalid loadstate when remote request failed: ",this._loadState))},isLoaded:function(){return this._loadState===$.LoadedPreview||this._loadState===$.LoadedFull},needsRemoteData:function(){return this._loadState!==$.LoadedFull},getOldID:function(){return this._oldLocalID},changeID:function(e){if(r.default.Assert(this.id!==e,"Change the ID of an attachment to the same value"),this.id!==e){var t=0,i=this.id;this.id=e,this._oldLocalID=i,r.default.Assert(!this._iteratingSubscribers,"Should not nest subscriber iterations"),this._iteratingSubscribers=!0;for(var a=0;a<this._subscribers.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;try{this._subscribers[a].onAttachmentIDChange(this,i)}catch(e){r.default.reportError(e)}}this._iteratingSubscribers=!1,this._oldLocalID=void 0}},delayChangeID:function(){var e=0;r.default.Assert(!this._iteratingSubscribers,"Should not nest subscriber iterations"),this._iteratingSubscribers=!0;for(var t=0;t<this._subscribers.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this._subscribers[t];try{var a=i.onAttachmentIDChange.bind(i,this,this.id);setTimeout(a,0)}catch(e){r.default.reportError(e)}}this._iteratingSubscribers=!1},isFieldDefined:function(e){return this._plugin.isFieldDefined(e)},hasField:function(e){return this._plugin.hasAttachField(this,e)},getField:function(e){return this._plugin.getAttachField(this,e)},updateField:function(e,t,i){return this._plugin.updateAttachField(this,e,t,i)},fieldsHaveParseEffect:function(e){return this._plugin.fieldsHaveParseEffect(e)},isFieldDefault:function(e){return this._plugin.isAttachFieldDefault(this,e)},fieldNeedsWrite:function(e,t){return this._plugin.fieldNeedsWrite(this,e,t)},getFieldAsDate:function(e){var t=this._plugin.getAttachField(this,e);if(t)return new Date(t).toString(H.a.getFormat(DFormat.MonthDay));r.default.Assert(!1,"Invalid attachment date field: ",this._plugin.id,e)},getPlugin:function(){return this._plugin},getData:function(){return this._plugin.getCacheData(this.id)},getExportString:function(){return this._plugin.getAttachmentExportString(this)},getEmbedString:function(){return this._plugin.getAttachmentEmbedString(this)},getTitleString:function(){return this._plugin.getAttachmentTitleString(this)},unload:function(){this._loadState=$.Unloaded,this._plugin.releaseAttachment(this)},match:function(e){return!!this.isLoaded()&&this._plugin.matchAttachment(this,e)},markInUse:function(e){0===this._countInUse&&this._plugin.notifyAttachmentInUse(this,e),this._countInUse++},markUnused:function(e){this._countInUse--,0===this._countInUse&&this._plugin.notifyAttachmentUnused(this,e),r.default.Assert(this._countInUse>=0,"Should never have negative users of the attachment")},isInUse:function(){return this._countInUse>0},subscribe:function(e){r.default.Assert(this._subscribers.indexOf(e)<0,"Must not double subscribe"),r.default.Assert(!this._iteratingSubscribers,"Should not modify subscriptions during iteration"),r.default.Assert(e.onAttachmentUpdate,"Must specify a valid subscriber callback"),this._subscribers.push(e)},unsubscribe:function(e){r.default.Assert(this._subscribers.indexOf(e)>=0,"Subscriber should be active"),r.default.Assert(!this._iteratingSubscribers,"Should not modify subscriptions during iteration"),this._subscribers.remove(e)},forEachItem:function(e,t){var i=0;r.default.Assert(!this._iteratingSubscribers,"Should not nest subscriber iterations"),this._iteratingSubscribers=!0;for(var a=0;a<this._subscribers.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(r.default.isVMLI(this._subscribers[a])&&(!e||this._subscribers[a].belongsToItemStore(e)))try{t(this._subscribers[a])}catch(e){r.default.reportError(e)}}this._iteratingSubscribers=!1},onUpdate:function(e,t,i){var a=0;if(r.default.Assert(!t||r.default.isArray(t),"Must supply a valid value for updateFields:",t),i=i||ChangeType.Remote,e&&this.isInUse())try{this._plugin.notifyAttachmentUpdated(this)}catch(e){r.default.reportError(e)}if(e||(i|=ChangeType.PluginLoad),t)for(var n=0,s=0;s<t.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;r.default.Assert(this._plugin.isFieldDefined(t[s]),"Invalid field supplied to be updated: ",t[s])}r.default.Assert(!this._iteratingSubscribers,"Should not nest subscriber iterations"),this._iteratingSubscribers=!0;for(s=0;s<this._subscribers.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;try{this._subscribers[s].onAttachmentUpdate(this,t,i)}catch(e){r.default.reportError(e)}}this._iteratingSubscribers=!1},notifyItemNoteChanged:function(e){this._plugin.notifyItemNoteChanged(this,e)},notifyItemTextChanged:function(e,t){this._plugin.notifyItemTextChanged(this,e,t)},notifyItemPropertyChanged:function(e,t,i){this._plugin.notifyItemPropertyChanged(this,e,t,i)},isLocalOnlyAttachment:function(){return r.default.isTempId(this.id)},isType:function(e){return this._plugin.getType()===e},isPlugin:function(e){return this._plugin.id===e},shouldBeDeleted:function(){return this.isFieldDefined("isDeleted")&&this.hasField("isDeleted")&&this.getField("isDeleted")&&this.isLocalOnlyAttachment()},hasFatalError:function(){return this._loadState===$.FailedRequest&&this._numRemoteRequests>3},hasInlineData:function(){return!!this._inlineData},getInlineData:function(){return this._inlineData},clearInlineData:function(){this._inlineData=void 0}};var te=ee;function ie(e){this._taskCB=e,this._isRunning=!1,this._disabled=!1,this._workAvailable=!1,this._runCount=0,o.a.forceBind("handleLowImpactBegin",this),o.a.forceBind("_onTaskEndRun",this),g.a.listen("lowImpactBegin",this.handleLowImpactBegin)}ie.prototype={getStats:function(){return{runCount:this._runCount,isRunning:this._isRunning,isDisabled:this._disabled}},disable:function(){this._disabled=!0},enable:function(){this._disabled=!1},handleLowImpactBegin:function(){this._startTaskRun()},requestRun:function(){this._forceRun=!0,this._startTaskRun()},notifyWorkAvailable:function(){this._workAvailable=!0,r.default.vmMain.isLowImpact()&&!this._isRunning&&this._startTaskRun()},_startTaskRun:function(){this._isRunning||this._disabled||!this._workAvailable||(r.default.Assert(this._forceRun||r.default.vmMain.isLowImpact(),"Must always run a task during a low impact timeframe"),this._workAvailable=!1,this._isRunning=!0,this._runCount++,this._taskCB(this._onTaskEndRun))},_onTaskEndRun:function(e){r.default.Assert(this._isRunning,"Must be currently running task to finish"),this._isRunning=!1,this._forceRun=!1,(e||this._workAvailable)&&(this._workAvailable=!0,r.default.vmMain.isLowImpact()&&this._startTaskRun())}};var ae=ie;function ne(e,t,i,a,n,s){r.default.Assert(r.default.isFunction(n),"Must supply a valid entry CB"),r.default.Assert(r.default.isFunction(s),"Must supply a valid done CB"),this._nextPageToken=e,this._inUse=!1,this._q=t,this._info=i,this._maxResults=a,this._entryCB=n,this._doneCB=s}var se={updateToken:function(e){r.default.Assert(this._nextPageToken!==e,"Should never update token to be same value"),this._nextPageToken=e},getNextPageToken:function(){return this._nextPageToken},getInfo:function(){return this._info},getQuery:function(){return this._q},getEntryCB:function(){return this._entryCB},getDoneCB:function(){return this._doneCB},getMaxResults:function(){return this._maxResults},hasMorePages:function(){return!!this._nextPageToken},notifyBeginUse:function(){r.default.Assert(!this._inUse,"Should not currently be in use"),this._inUse=!0},notifyEndUse:function(){r.default.Assert(this._inUse,"Should always be using token when done"),this._inUse=!1},isInUse:function(){return this._inUse}};o.a.defineBase(ne),o.a.extend(ne.prototype,se);var re=ne,oe=i(27),le=[1,5,20,40,80,170],de=[l.a.HTTPStatusCode.Network,l.a.HTTPStatusCode.Timeout,l.a.HTTPStatusCode.TooMany,l.a.HTTPStatusCode.ServerError,l.a.HTTPStatusCode.BadGateway,l.a.HTTPStatusCode.Unavailable,l.a.HTTPStatusCode.GatewayTimeout,null],ue=[l.a.HTTPStatusCode.Forbidden,l.a.HTTPStatusCode.TooMany],ce={};function he(e,t){var i=this;r.default.Assert(e,"Must supply a valid id"),r.default.Assert(t,"Must supply a valid name"),this.id=e,this.name=t,this.DefaultRequestTimeout=r.default.seconds(15),this.LongWaitThreshold=r.default.seconds(7),this._previewCache="p_"+e,this._offlineCache="ocache_"+e,this._paneType="Pane"+e,this._rootId=e+"Root",this._acProviderId="AC"+e,this._settingsGroup="plugin"+this.id,this.loadedEvent="Plugin_"+e+"_Loaded",this.pluginMargin=12,this.pluginPadding=24,this.isActiveObs=new w.a(!1),this._isReady=!1,this._hasDeactivated=!1,this._propertyDescriptors={},this._propertySets={},this._registeredAutocomplete=!1,this._attachKeys=[],this._attachCache={},this._dataKeys=[],this._dataCache={},this._scorchOfflineCache=!1,this._defaultItemStore=void 0,this._activeItemStore={},this._defaultZoomItems={},this._searchBuckets={},this._activeSearchBucket={},this._numOutstandingReqs=0,this._pendingRequests=[],this._outstandingRequests=[],this._isRateLimited=!1,this._lastRateLimitTime=void 0,this._numLongWaitRequests=0,this._numSendRequests=0,this._numHandledRequests=0,this._totalRequestSendTime=0,this._totalRequestHandleTime=0,this._requiresOfflineAuth=!1,this._activeAttachments=[],this._numActivePanes=0,this._requestCounter=0,this._unloadedDependencies=this.getDependencies(),this._isFirstLoad=!0,this._hasRunOfflineLoad=!1,this._loadedInitialData=!1,this._hasLoadedCaches=!1,this._hasServicedPreviewCache=!1,this._registeredCaches={},this._registeredModals={},this._createdModals={},this._recurringTasks=[],this._lowImpactTasks={},this._batchedResponses={},this.Settings={},window.PluginSettingsID[this.id]={},o.a.binder(this,"_retryRemoteRequest","_onGoogleAuthorized","_reqSortFn"),r.default.settings.registerGroup(this._settingsGroup),this.registerSetting("IsEnabled","isEnabled",!0,!1,!this._isBuiltin),this.getDataPane()&&S.a.registerPaneType(this,this._paneType,this.name,this.getDataPane(),this.getPaneIcon(),this.getPanePriority()),this.onSettingChanged(this.Settings.IsEnabled,function(e,t){t&&r.default.vmMain.pluginManager.activatePlugin(i)})}ce[PluginDependency.DemoMode]={online:!1},ce[PluginDependency.GoogleLogin]={online:!0},ce[PluginDependency.PremiumSub]={online:!1},ce[PluginDependency.EarlyAccess]={online:!1},ce[PluginDependency.LocalLoaded]={online:!1},he.prototype={getType:function(){return l.a.PluginType.Unknown},sendEvent:function(e,t){return r.default.sendEvent(this.id,e,t)},getSetting:function(e){return r.default.settings.get(e,this._settingsGroup)},setSetting:function(e,t){return r.default.settings.set(e,t,this._settingsGroup)},onAuthorizedSetting:function(){},registerSetting:function(e,t,i,a,n){window.PluginSettingsID[this.id][e]=t,this.Settings[e]=t,r.default.settings.registerSetting(t,this._settingsGroup,i,a),n&&r.default.settings.registerAPIServerNotification(t,this._settingsGroup),s.default.addDefaultSkipSetting(t,this._settingsGroup)},onSettingChanged:function(e,t){r.default.settings.registerForChangeNotification(e,this._settingsGroup,t)},getCacheStats:function(e){var t={};if(this.supportOfflineCache()&&r.default.shouldWriteLocal()){var i={},a=o.a.storage.getItem(this.getOfflineCacheName());if(a){i.size=a.length;try{var n=JSON.parse(a);if(n){i.props=n.props;var s=n.data;i.count=Object.keys(s).length}}catch(e){r.default.reportError(e)}}t.Offline=i}var l=Object.keys(this._registeredCaches).length,d=0,u=function(i){t[i.id]=i,l===++d&&e(t)};if(l>0)for(var c in this._registeredCaches){if(this._registeredCaches.hasOwnProperty(c))this._registeredCaches[c].getStats(u)}else e()},getCacheState:function(){var e={};for(var t in this._registeredCaches)if(this._registeredCaches.hasOwnProperty(t)){var i=this._registeredCaches[t];e[t]=i.getState()}return e},registerLocalCache:function(e,t,i,a){var n;n=i?this.id:this.id+"_"+e;var s=r.default.vmMain.cacheManager.registerLocalCache(n,e,t,a);return this._registeredCaches[n]=s,s},registerDeferredTaskType:function(e,t,i,a){r.default.Assert(e,"Must specify a valid deferred task type"),r.default.vmMain.deferredTaskManager.registerTaskType(e,t,i,a)},scheduleDeferredTask:function(e,t,i,a){r.default.Assert(e,"Must supply a valid local ID for deferred task"),r.default.Assert(t,"Must specify a valid deferred task type"),r.default.vmMain.deferredTaskManager.scheduleTask(e,t,i,!1,void 0,a)},cancelDeferredTask:function(e,t){r.default.vmMain.deferredTaskManager.cancelTask(e,t)},createRecurringTask:function(e,t){var i,a=this.id+"_"+e,n=r.default.vmMain.recurringTaskManager;return this.hasRecurringTask(e)?i=n.getRecurringTask(a):(this._recurringTasks.push(e),i=r.default.vmMain.recurringTaskManager.createRecurringTask(a,t)),i},getRecurringTask:function(e){return r.default.vmMain.recurringTaskManager.getRecurringTask(this.id+"_"+e)},hasRecurringTask:function(e){return r.default.vmMain.recurringTaskManager.hasRecurringTask(this.id+"_"+e)},cancelRecurringTask:function(e){var t=this.id+"_"+e;return this._recurringTasks.remove(e),r.default.vmMain.recurringTaskManager.cancelRecurringTask(t)},cancelRecurringTasks:function(){for(var e=0;this._recurringTasks.length>0;){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;this.cancelRecurringTask(this._recurringTasks[0])}},getRecurringStats:function(){for(var e=0,t={},i=0;i<this._recurringTasks.length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var a=this._recurringTasks[i],n=this.getRecurringTask(a);t[a]=n.getStats()}return t},registerLowImpactTask:function(e,t){r.default.Assert(!this._lowImpactTasks[e],"Must specify different IDs for each task: ",e);var i=new ae(t);return this._lowImpactTasks[e]=i,i},getLowImpactStats:function(){var e={};for(var t in this._lowImpactTasks)if(this._lowImpactTasks.hasOwnProperty(t)){var i=this._lowImpactTasks[t];e[t]=i.getStats()}return e},getTrackedStat:function(e){0},addTrackedStat:function(e){0},reportTrackedStat:function(e){0},getStats:function(){return{fnCalls:void 0,tracked:void 0,remoteReqs:void 0,numItems:this._defaultItemStore?this._defaultItemStore.getCount():-1,activeAttachments:this._activeAttachments.length,numAttach:this._attachKeys.length,numDataCache:this._dataKeys.length,numSendRequests:this._numSendRequests,numHandledRequests:this._numHandledRequests,numLongWaitRequests:this._numLongWaitRequests,avgRequestSendTime:this._totalRequestSendTime/this._numSendRequests,avgRequestHandleTime:this._totalRequestHandleTime/this._numHandledRequests,lowImpact:this.getLowImpactStats(),recurring:this.getRecurringStats()}},getState:function(){return{isActive:this.isActiveObs.get(),isReady:this._isReady,isRateLimited:this._isRateLimited,hasDeactivated:this._hasDeactivated,scorchedCaches:this._scorchOfflineCache,numOutstandingReqs:this._numOutstandingReqs,numPendingReqs:this._pendingRequests.length,numActivePanes:this._numActivePanes,unloadedDeps:this._unloadedDependencies,isFirstLoad:this._isFirstLoad,hasRunOfflineLoad:this._hasRunOfflineLoad,loadedInitialData:this._loadedInitialData,hasLoadedCaches:this._hasLoadedCaches,cacheState:this.getCacheState(),isPreviewCacheAvailable:this.isPreviewCacheAvailable(),hasServicedPreviewCache:this._hasServicedPreviewCache}},isPluginPane:function(e){return e.type===this._paneType},getPaneType:function(){return this._paneType},activate:function(e){var t=this,i=this.isActiveObs.get();if(!i){if(this.isActiveObs.set(!0),this.useItemStore()){this._defaultItemStore=r.default.vmMain.itemStoreManager.registerItemStore(this.id,this,this.itemStoreOptions());var a=this._defaultItemStore.createRoot(this._rootId,"");setTimeout(function(){t.isActive()&&a.setText(t.useItemStore(),!0,ChangeType.Auto)},0)}this._hasLoadedCaches||(this.usesPreviewCache()&&this.registerPreviewCache(),this.supportOfflineCache()&&r.default.shouldWriteLocal()&&this.loadOfflineCache(),this._hasLoadedCaches=!0),this.ensurePaneTypeIsActive(),this.registerAutocomplete()}if(this._unloadedDependencies)for(var n in e)e.hasOwnProperty(n)&&this.onDependencyLoaded(n,e[n]);return this._unloadedDependencies||this.onAllDependenciesLoaded(),this._activate&&this._activate(),i||r.default.vmMain.pluginManager.fireEvent("pluginActiveChanged",this.id,"activated",[this,!0]),!i},deactivate:function(){return r.default.Assert(this.isActiveObs.get(),"Must be active in order to deactivate pane"),this.isActiveObs.set(!1),r.default.vmMain.pluginManager.fireEvent("pluginActiveChanged",this.id,"deactivated",[this,!1]),this.unregisterAutocomplete(),this.getDataPane()&&r.default.vmMain.paneFactory.deactivatePaneType(this._paneType),this.useItemStore()&&(r.default.vmMain.itemStoreManager.unregisterItemStore(this.id),this._defaultItemStore=void 0),this.cancelRecurringTasks(),this._loadedInitialData=!1,this._isFirstLoad=!0,this._hasRunOfflineLoad=!1,this._hasDeactivated=!0,this._deactivate&&this._deactivate(),!0},ensurePaneTypeIsActive:function(){(!this.hasDependency(PluginDependency.PremiumSub)||r.default.billingManager.hasPremiumFeatures())&&this.getDataPane()&&!S.a.isPaneTypeActive(this._paneType)&&(this.getSetting(this.Settings.IsEnabled)||r.default.isDemoMode())&&S.a.activatePaneType(this._paneType)},isActive:function(){return this.isActiveObs.get()},isReady:function(){return this._isReady},isEnabled:function(){return r.default.isDemoMode()||this.isAvailable()&&this.getSetting(this.Settings.IsEnabled)},isAvailable:function(){var e=!1,t=this.hasDependency(PluginDependency.EarlyAccess),i=this.hasDependency(PluginDependency.PremiumSub);r.default.Assert(!i||!t,"Must not require both early access and premium sub: "+this.id);var a=r.default.billingManager.hasEarlyAccess(),n=r.default.billingManager.hasPremiumFeatures();return t&&a?e=!0:i&&n?e=!0:t||i?r.default.isDemoMode()&&(e=!0):e=!0,e},hasSettingsError:function(){return!1},isCurrentlyAuthorized:function(e){return j.a.isCurrentlyAuthorized(e,this._requiresOfflineAuth)},_onGoogleAuthorized:function(e){r.default.Assert("me"===e||j.a.isCurrentlyAuthorized(e),"Must have a valid access token"),this.onAuthorized(e)},onAuthorized:function(e){this._pendingRequests.length>0&&r.default.vmMain.pluginManager.notifyHasPendingRemoteRequest()},verifyAuthorization:function(e){return!0},notifyUnauthorized:function(e,t){},isOnline:function(){return r.default.vmMain.pluginManager.isOnline()},goOnline:function(){},goOffline:function(){},onDocumentShared:function(e){},onShutdown:function(){},onDependencyLoaded:function(e,t){if(this._unloadedDependencies){var i=this._unloadedDependencies.indexOf(e);if(i>=0&&(this.isDependencyLoaded(e,t)&&this._unloadedDependencies.removeAt(i),e===PluginDependency.PremiumSub&&this.ensurePaneTypeIsActive()),0===this._unloadedDependencies.length)this._unloadedDependencies=void 0,this.onAllDependenciesLoaded();else if(this.supportOfflineLoad()&&!this._hasRunOfflineLoad){for(var a=0,n=!1,s=0;s<this._unloadedDependencies.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var r=this._unloadedDependencies[s];ce[r].online||(n=!0)}!n&&this.isActiveObs.get()&&this.offlineLoad()}}},onAllDependenciesLoaded:function(){var e=this;this.isActiveObs.get()&&setTimeout(function(){e._isReady=!0,e._updateAttachmentStates(),e.offlineLoad(),e.load()},0)},areDependenciesLoaded:function(){return void 0===this._unloadedDependencies},hasDependencyBeenLoaded:function(e){var t=!1;return this.hasDependency(e)&&(this.getUnloadedDependencies()?this.getUnloadedDependencies().indexOf(e)<0&&(t=!0):t=!0),t},isDependencyLoaded:function(e,t){return!0},getUnloadedDependencies:function(){return this._unloadedDependencies},loadRemoteAPIs:function(e,t){e&&e()},areRemoteAPIsLoaded:function(){return!0},forceLoad:function(){this._loadedInitialData=!1,this.activate(),this._unloadedDependencies&&(this._unloadedDependencies=void 0,this.onAllDependenciesLoaded())},authorize:function(e,t,i){r.default.Assert(i&&r.default.isFunction(i),"Must provide a valid authoirzation callback"),this.googleScopes()?this._authorizeGoogle(e,t,i):i(!0)},_authorizeGoogle:function(e,t,i){r.default.Assert(this.googleScopes(),"Must have a valid google scope to request"),r.default.Assert(i&&r.default.isFunction(i),"Must provide a valid authoirzation callback"),e?f.default.runAuthenticateOffline(this.googleScopes(),t,function(e){i(e&&!e.error)}):f.default.runAuthenticate(this.googleScopes(),!1,!1,function(e){i(e&&!e.error)})},googleScopes:function(){},getDependencies:function(){},hasDependency:function(e){var t=this.getDependencies();return!!t&&t.indexOf(e)>=0},getOfflineCacheName:function(){return this._offlineCache},loadOfflineCache:function(){if(r.default.Assert(0===this._dataKeys.length,"Must have no data already loaded"),this.supportOfflineCache()&&r.default.shouldWriteLocal()){var e=o.a.storage.getItem(this.getOfflineCacheName());if(e)try{var t=JSON.parse(e);t&&this.loadDataFromObject(t)}catch(e){r.default.reportError(e)}else 0}},loadDataFromObject:function(e){var t=0;r.default.Assert(e,"Must provide a valid dataset to load");e.props;var i=e.data;r.default.Assert(i,"Load object must contain valid data"),this._dataKeys=Object.keys(i);for(var a=0;a<this._dataKeys.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=this._dataKeys[a];this._dataCache[n]=this.createEntryFromLocal(n,i[n]),this._dataCache[n].id=n}},saveOfflineCache:function(){if(this.supportOfflineCache()&&r.default.shouldWriteLocal())if(this._scorchOfflineCache)0;else{for(var e=0,t=0,i={},a=0;a<this._activeAttachments.length;++a){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var n=this._activeAttachments[a];if(r.default.Assert(n.isInUse(),"Attachments in the active list should always be in use"),n.isInUse()){var s=this.serializeEntry(n.id);s&&(i[n.id]=s,t++)}}var l={data:i,info:{writeDate:Date.now(),entries:t}};try{var d=JSON.stringify(l);0,o.a.storage.setItem(this.getOfflineCacheName(),d)}catch(e){r.default.reportError(e)}}},clearOfflineCache:function(e){this.supportOfflineCache()&&r.default.shouldWriteLocal()&&(o.a.storage.removeItem(this.getOfflineCacheName()),e&&(this._scorchOfflineCache=!0))},supportOfflineLoad:function(){return!1},supportOfflineCache:function(){return!1},createEntryFromLocal:function(e,t){r.default.Assert(!1,"SubClass must override")},clearData:function(){for(var e=0,t=0;t<this._attachKeys.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;this._attachCache[this._attachKeys[t]].unload()}this._attachKeys=[],this._attachCache={},this._dataKeys=[],this._dataCache={},this.useItemStore()&&(this.getDefaultItemStore().clearStore(),this._activeItemStore={}),this._searchBuckets={},this._activeSearchBucket={},this._numOutstandingReqs=0,this._pendingRequests=[],this._outstandingRequests=[],this._activeAttachments=[]},onCacheLimitExceeded:function(){for(var e in this._registeredCaches)if(this._registeredCaches.hasOwnProperty(e)){var t=this._registeredCaches[e];t.usesDiskSpace()&&t.clearCache()}},changeID:function(e,t,i){if(r.default.Assert(t!==i,"Should never be switching to the same ID"),this._attachCache[i])e.delayChangeID(i),this._attachCache[t]=void 0,this._attachKeys.remove(t),this._dataCache[t]=void 0,this._dataKeys.remove(t);else{var a=this._attachCache[t];r.default.Assert(e===a,"Attach entries must match"),a&&(this._attachCache[t]=void 0,this._attachCache[i]=a,this._attachKeys.remove(t),this._attachKeys.push(i));var n=this._dataCache[t];this._dataCache[t]=void 0,n?(n.id===t&&(n.id=i),this._dataCache[i]=n,this._dataKeys.remove(t),this._dataKeys.push(i)):r.default.Assert(this._dataKeys.indexOf(i)>=0,"Should have already changed the ID");var s=e.isLocalOnlyAttachment();e.changeID(i),e.isInUse()&&s&&this.notifyAttachmentUpdated(e)}},_isPreviewData:function(e){for(var t=0,i=this.getPropertySet(PluginLoad.Preview),a=0;a<i.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(!this.getPropertyDescriptor(i[a]).isOpt&&!e.hasOwnProperty(i[a]))return!1}return!0},_isFullData:function(e){for(var t=0,i=this.getPropertySet(PluginLoad.Full),a=0;a<i.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(!this.getPropertyDescriptor(i[a]).isOpt&&!e.hasOwnProperty(i[a]))return!1}return!0},_addPreviewEntry:function(e,t){var i=this.createEntryFromLocal(e,t);return this.cacheData(e,i),i},cacheData:function(e,t,i,a,n){r.default.Assert(e,"Must supply a valid key for data");var s=this._dataCache[e];if(this._dataCache[e]=t,s||this._dataKeys.push(e),this._attachCache[e]){var o=this._attachCache[e],l=this._getPluginLoadType(t);r.default.Assert(l,"Must either contain valid preview or full data"),o.notifyDataLoaded(l,i,a,n)}},getCacheData:function(e){return this._dataCache[e]},_attachMetadataFields:function(){},fieldsHaveParseEffect:function(e){var t=!1;if(e){var i=this._attachMetadataFields();if(i)for(var a=0,n=0;n<e.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(i.indexOf(e[n])<0){t=!0;break}}else t=!0}else t=!0;return t},isFieldDefined:function(e){return!!this.getPropertyDescriptor(e)},hasAttachField:function(e,t){var i=!1,a=this._dataCache[e.id];if(a&&a.hasOwnProperty(t))i=!0;else{var n=this.getPropertyDescriptor(t);if(r.default.Assert(n,"Must have a valid field descriptor",t),n&&n.isOpt)i=!0;else{var s=e.getInlineData();s&&s.hasOwnProperty(t)&&(i=!0)}}return i},getAttachField:function(e,t){var i,a=this._dataCache[e.id];if(a&&a.hasOwnProperty(t))i=a[t];else{var n=this.getPropertyDescriptor(t);r.default.Assert(n,"Must have a valid field descriptor",t);var s=e.getInlineData();s&&s.hasOwnProperty(t)?i=s[t]:(r.default.Assert(!n||n.isOpt,"Field must be optional if it is not defined",t),i=n?n.defaultValue:void 0)}return i},updateAttachField:function(e,t,i,a){var n=!1;r.default.Assert(this.isFieldDefined(t),"Must be updating a valid attachment field");var s=this._dataCache[e.id];(r.default.Assert(s,"Invalid field request: ",this.id,t),s)&&(this.dataFieldNeedsWrite(s,t,i)&&(s[t]=i,this.cacheData(e.id,s,!0,[t])),n=!0);var o=e.getInlineData();return o&&o.hasOwnProperty(t)&&!a&&r.default.Assert(o[t]===i,"Should never change inline field value"),n},isAttachFieldDefault:function(e,t){var i=!1,a=this._dataCache[e.id];if(r.default.Assert(a,"Invalid field request: ",this.id,t),a){var n=this.getPropertyDescriptor(t);r.default.Assert(n,"Must have a valid field descriptor",t),a.hasOwnProperty(t)?n&&n.isOpt&&n.defaultValue===a[t]&&(i=!0):n&&n.isOpt&&(i=!0)}return i},fieldNeedsWrite:function(e,t,i){var a=this._dataCache[e.id];return r.default.Assert(a,"Invalid field request: ",this.id,t),this.dataFieldNeedsWrite(a,t,i)},dataFieldNeedsWrite:function(e,t,i){var a=!1;if(e){var n=this.getPropertyDescriptor(t);r.default.Assert(n,"Must have a valid field descriptor",t);var s=this.compactCacheField(e,t);e.hasOwnProperty(t)?void 0===i&&s===n.defaultValue||(n&&n.comparator?n.comparator(s,i)||(a=!0):s!==i?a=!0:(r.default.isObject(s)||r.default.isObject(i)||r.default.isArray(s)||r.default.isArray(i))&&(a=!0)):void 0!==i&&(n&&n.isOpt&&n.defaultValue===i||(a=!0))}return a},hasCacheData:function(e){return!!this._dataCache[e]},findCachedItemsByField:function(e,t,i){var a=0;for(var n=[],s=0;s<this._dataKeys.length;s++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var r=this._dataCache[this._dataKeys[s]];if(r[e]===t&&(n.push(r),n.length>=i))break}return n},findCachedItemsByFn:function(e,t){var i=0;r.default.Assert(e,"Must supply a valid match function"),r.default.Assert(r.default.isFunction(e),"Match function must be a valid function");for(var a=[],n=0;n<this._dataKeys.length;n++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this._dataCache[this._dataKeys[n]];if(e(s)&&(a.push(s),a.length>=t))break}return a},notifyAttachmentInUse:function(e,t){r.default.Assert(this._activeAttachments.indexOf(e)<0,"Attachment should not already be active"),this._activeAttachments.push(e),r.default.isLocalChange(t)&&this.usesPreviewCache()&&e.isLoaded()&&!e.isLocalOnlyAttachment()&&this.writeAttachmentToPreviewCache(e)},notifyAttachmentUpdated:function(e){this.usesPreviewCache()&&e.isLoaded()&&!e.isLocalOnlyAttachment()&&this.writeAttachmentToPreviewCache(e)},notifyAttachmentUnused:function(e,t){r.default.Assert(this._activeAttachments.indexOf(e)>=0,"Attachment should be marked active"),this._activeAttachments.remove(e),r.default.isLocalChange(t)&&this.usesPreviewCache()&&e.isLoaded()&&!e.isLocalOnlyAttachment()&&this.updatePreviewCache(e.id,void 0)},notifyItemNoteChanged:function(e,t){},notifyItemTextChanged:function(e,t,i){},notifyItemPropertyChanged:function(e,t,i){},getAttachment:function(e,t){return r.default.Assert(e,"Must provide a valid key"),e&&!this._attachCache[e]&&(this._attachCache[e]=this._requestAttachment(e,t),this._attachKeys.push(e)),this._attachCache[e]},hasAttachment:function(e){return!!this._attachCache[e]},forEachActiveAttachment:function(e){for(var t=0,i=0;i<this._activeAttachments.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;e(this._activeAttachments[i])}},forEachAttachment:function(e){for(var t=0,i=0;i<this._attachKeys.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;e(this._attachCache[this._attachKeys[i]])}},numActiveAttachments:function(){return this._activeAttachments.length},getAttachmentExportString:function(e){for(var t=0,i=window.EmbedAttachChar+"p:"+this.id+",id:"+e.id,a=this.getPropertySet(PluginLoad.Inline),n=0;n<a.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=a[n],o=this.getPropertyDescriptor(s),l=e.getField(s);r.default.Assert(o.isOpt||l&&l.indexOf(":")<0&&l.indexOf(" ")<0,"Property value is invalid: "+s+", "+l),void 0!==l&&(i+=","+s+":"+l)}return i+=window.EmbedAttachChar},getAttachmentEmbedString:function(e,t){return this._getTextForItem(e,t)},getAttachmentTitleString:function(e){return this.getUnstyledText(e)},_getTextForItem:function(e,t){return r.default.Assert(e,"Must pass in a valid item to get text for"),window.EmbedAttachChar+"p:"+this.id+",id:"+e.id+(t?","+t:"")+window.EmbedAttachChar},_requestAttachment:function(e,t){return r.default.Assert(e,"Must provide a valid key"),new te(this,e,t)},releaseAttachment:function(e){},registerPreviewCache:function(){var e=v.a.ensureCache(this._previewCache);v.a.requestNotifyWhenAvailable(this.serviceRemoteRequestsFromPreview.bind(this)),e||v.a.requestNotifyWhenAvailable(this.writeActiveAttachmentsToPreviewCache.bind(this))},isPreviewCacheAvailable:function(){return v.a.isCacheAvailable(this._previewCache)},updatePreviewCache:function(e,t){return r.default.Assert(r.default.isString(e),"Key must be a valid string"),v.a.updateCache(this._previewCache,e,t)},queryPreviewCache:function(e){return r.default.Assert(r.default.isString(e),"Key must be a valid string"),v.a.queryCache(this._previewCache,e)},onPreviewCacheChange:function(e,t,i){switch(e){case DataChangeType.Add:case DataChangeType.Remove:case DataChangeType.Change:break;default:r.default.Assert(!1,"Invalid or unhandled DataChangeType: ",e)}log("Preview Cache Change: ",arguments)},writeActiveAttachmentsToPreviewCache:function(){var e=0;v.a.ensureCache(this._previewCache);for(var t=0;t<this._activeAttachments.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this._activeAttachments[t];i.isLoaded()&&!i.isLocalOnlyAttachment()&&this.writeAttachmentToPreviewCache(i)}},writeAttachmentToPreviewCache:function(e){r.default.Assert(e.isLoaded(),"Attachments should have data before saving them"),r.default.Assert(!e.isLocalOnlyAttachment(),"Should never write a local-only attachment to the preview cache");var t=!1,i=this.getPropertySet(PluginLoad.Preview);if(this.isPreviewCacheAvailable()){var a=0,n=this.queryPreviewCache(e.id);t=!n;for(var s=0;!t&&s<i.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var o=i[s];e.fieldNeedsWrite(o,n[o])&&(t=!0)}}else 0;t&&this.updatePreviewCache(e.id,this.serializePreview(e))},dataHasChanged:function(e,t){for(var i=0,a=!e,n=this.getPropertySet(PluginLoad.Full),s=0;!a&&s<n.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=n[s];this.dataFieldNeedsWrite(e,r,t[r])&&(a=!0)}return a},getChangedFields:function(e,t){for(var i=0,a=[],n=this.getPropertySet(PluginLoad.Full),s=0;s<n.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=n[s];this.dataFieldNeedsWrite(e,r,t[r])&&a.push(r)}return a},serviceRemoteRequestsFromPreview:function(){for(var e=0,t=0,i=0;i<this._pendingRequests.length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var a=this._pendingRequests[i];if(a.attach)for(var n=0,s=0;s<a.attach.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var r=this.queryPreviewCache(a.attach[s].id);r&&this._addPreviewEntry(a.attach[s].id,r)}}for(var o=0;o<this._activeAttachments.length;++o){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var l=this._activeAttachments[o];if(!l.isLoaded()&&!l.isLocalOnlyAttachment()){var d=this.queryPreviewCache(l.id);d&&this._addPreviewEntry(l.id,d)}}this._hasServicedPreviewCache=!0},usesPreviewCache:function(){return!1},matchAttachment:function(e,t){r.default.Assert(!1,"SubClass must override")},getStyledText:function(e){r.default.Assert(!1,"SubClass must override")},getUnstyledText:function(e){r.default.Assert(!1,"SubClass must override")},getBlockedText:function(e){return"Blocked"},useRenderer:function(e,t){var i,a=r.default.vmMain.pluginManager.useRenderer(e,t);switch(e){case PluginRenderTypes.StyledText:i="getStyledText";break;case PluginRenderTypes.UnstyledText:i="getUnstyledText";break;case PluginRenderTypes.Measure:i="getAttachMeasure";break;default:r.default.Assert(!1,"Unknown plugin renderer type")}i&&(this[i]=a)},_getDisplayText:function(e,t,i){return this.isPluginBlocked()?this.getBlockedText(e,t):this.getStyledText(e,t,i)},createDisplayElement:function(e){var t=this.getAttachmentClass(e);r.default.Assert(r.default.isArray(t),"Must have a valid class list"),r.default.Assert(t.indexOf("plugin")<0,"Should not already have plugin as a class"),t.push("plugin"),this.isPluginBlocked()&&t.push("blocked");var i=this._getDisplayText(e),a={attrs:{cls:t,plugin:this.id,"plugin-id":e.id},text:i},n=this.getAttachmentTooltip(e);return n&&(a.attrs["data-tooltip"]=n),a},measureAttachment:function(e,t){var i;if(r.default.Assert(t&&t.attrs&&t.attrs["plugin-id"],"Must have a valid word style obj with attachment ID"),t.attrs&&!t.attrs.isUnknown){var a=this.getAttachment(t.attrs["plugin-id"]);r.default.Assert(a,"Must have valid attachment to measure: ",t.attrs["plugin-id"]),i=this.isPluginBlocked()?V.default.measureWord(e,this.getBlockedText(a),t):this.getAttachMeasure(a,e,t)}else i=V.default.measureWord(e,"Unknown Plugin",t);if(t.attrs&&t.attrs.cls){var n=t.attrs.cls;i+=this.pluginMargin,n.indexOf("padB")>=0&&(i+=this.pluginMargin)}return i+=this.pluginPadding},getAttachmentClass:function(e){return""},getAttachmentTooltip:function(e){},isPluginBlocked:function(){var e=!1;return r.default.billingManager.hasPremiumFeatures()||!this.hasDependency(PluginDependency.PremiumSub)&&!this.hasDependency(PluginDependency.EarlyAccess)||(e=!0),e},_displayMissingProperties:function(e,t,i){var a=0,n=!1,s=this.getPropertySet(i);log("Displaying Missing Properties: ",e);for(var o=0;o<s.length;++o){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;this.getPropertyDescriptor(s[o]).isOpt||t.hasOwnProperty(s[o])||(log(" Missing Property: ",s[o]),n=!0)}r.default.Assert(n,"Must be missing props to run this")},_getPluginLoadType:function(e){r.default.Assert(e,"Must be querying loaded data for load state with valid data");var t=PluginLoad.None;return this._isPreviewData(e)&&(t|=PluginLoad.Preview,this._isFullData(e)&&(t|=PluginLoad.Full)),t},requestData:function(e,t){var i=this;t=t||PluginLoad.Preview|PluginLoad.Full;var a,n=this.getCacheData(e.id);n?(a=this._getPluginLoadType(n),r.default.isFlagSet(a,t)?e.notifyDataLoaded(a,!1,void 0,ChangeType.Remote):(r.default.forEachFlagSet(t,function(t){i._displayMissingProperties(e.id,n,t)}),!e.isLocalOnlyAttachment()&&this.allowRemoteRequests()&&this._getRemoteAttachmentData(e,t))):e.isLocalOnlyAttachment()||(a=PluginLoad.None,this.isPreviewCacheAvailable()&&this._loadPreviewData(e,t),this.allowRemoteRequests()&&!r.default.isFlagSet(a,t)&&this._getRemoteAttachmentData(e,t))},_loadPreviewData:function(e,t){r.default.Assert(this.isPreviewCacheAvailable(),"Preview cache must always be available after gdata cb");var i=!1,a=this.queryPreviewCache(e.id);if(a){a=this.createEntryFromLocal(e.id,a),this.cacheData(e.id,a);var n=this._getPluginLoadType(a);r.default.isFlagSet(n,t)&&e.notifyDataLoaded(n,!1,void 0,ChangeType.Remote),i=!0}return i},_getRemoteAttachmentData:function(e,t){var i=this;this.usesPreviewCache()&&!r.default.isDemoMode()?v.a.requestNotifyWhenAvailable(function(){i._loadPreviewData(e,t),i.getRemoteAttachmentData(e,t)}):this.getRemoteAttachmentData(e,t)},getRemoteAttachmentData:function(e,t){r.default.Assert(!1,"SubClass must override")},_appendDupeRequest:function(e,t){r.default.Assert(e,"Must provide a valid queued request"),r.default.Assert(t,"Must provide a valid duped request"),r.default.Assert(!e.duped,"Must never use an already duped request as a dupe for another request"),t.attach&&(e.attach||(e.attach=[]),e.attach.pushOnlyUniques(t.attach)),e.successCB.pushOnlyUniques(t.successCB),e.failureCB.pushOnlyUniques(t.failureCB)},_areRequestFnsEqual:function(e,t){var i=!1;return e===t?i=!0:r.default.isArray(e)&&r.default.isArray(t)&&(i=e.equals(t)),i},_areRequestsEqual:function(e,t){r.default.Assert(e,"Must have a valid request A"),r.default.Assert(t,"Must have a valid request B");var i=!0;if(e.accountID!==t.accountID)i=!1;else if(e.forceNoDupe||t.forceNoDupe)i=!1;else if(e.id!==t.id&&this._areRequestFnsEqual(e.requestFn,t.requestFn))if(e.data===t.data)i=!0;else{for(var a in e.data){if(!e.data.hasOwnProperty(a)||!t.data.hasOwnProperty(a)){i=!1;break}if(e.data[a]!==t.data[a]){i=!1;break}}if(i)for(var n in t.data){if(!e.data.hasOwnProperty(n)||!t.data.hasOwnProperty(n)){i=!1;break}if(e.data[n]!==t.data[n]){i=!1;break}}}else i=!1;return i},_getDupeRequest:function(e){for(var t,i=0,a=0,n=0;!t&&n<this._outstandingRequests.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;!this._outstandingRequests[n].duped&&this._areRequestsEqual(this._outstandingRequests[n],e)&&(t=this._outstandingRequests[n])}for(var s=0;!t&&s<this._pendingRequests.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;!this._pendingRequests[s].duped&&this._areRequestsEqual(this._pendingRequests[s],e)&&(t=this._pendingRequests[s])}return t},_combineRequest:function(e,t){r.default.Assert(e,"Must provide a valid queued request"),r.default.Assert(t,"Must provide a valid combine request"),r.default.Assert(!e.combined,"Must never use an already combined request as a target for another request"),e.data=r.default.mergeObjects(e.data,t.data),e.successCB.pushOnlyUniques(t.successCB),e.failureCB.pushOnlyUniques(t.failureCB)},_areRequestsCombinable:function(e,t){r.default.Assert(e,"Must have a valid request A"),r.default.Assert(t,"Must have a valid request B");var i=!1;return e.id!==t.id&&e.combinable&&t.combinable&&e.accountID===t.accountID&&this._areRequestFnsEqual(e.requestFn,t.requestFn)&&e.type===t.type&&(e.attach||t.attach?e.attach&&t.attach&&e.attach.equals(t.attach)&&(i=!0):i=!0),i},_getCombineRequest:function(e){var t;if(e.combinable)for(var i=0,a=0;!t&&a<this._pendingRequests.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;!this._pendingRequests[a].combined&&this._areRequestsCombinable(this._pendingRequests[a],e)&&(t=this._pendingRequests[a])}return t},_handleBatchRequestResponse:function(e){this._numOutstandingReqs--,r.default.Assert(this._numOutstandingReqs>=0,"Outstanding requests cannot be negative")},_handleRequestResponse:function(e,t){t||(this._numOutstandingReqs--,r.default.Assert(this._numOutstandingReqs>=0,"Outstanding requests cannot be negative"))},_handleRequestTimeout:function(e){if(this._pendingRequests.indexOf(e)>=0){var t=0;e.timedOut=!0;for(var i={error:{code:l.a.HTTPStatusCode.Network,message:"Internal request timeout"}},a=0;a<e.failureCB.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;try{e.failureCB[a](i)}catch(e){r.default.reportError(e)}}0,this._pendingRequests.remove(e)}},_queueRemoteRequestMulti:function(e,t,i,a,n,s,o,l){r.default.Assert(e,"Missing accountID parameter"),r.default.Assert(!r.default.isArray(e),"Missing accountID paramter"),r.default.Assert(!r.default.isFunction(e),"Missing accountID parameter"),r.default.Assert(!l||void 0===l.accountID,"AccountID is specified as a separate param");var d=l?r.default.clone(l):{};return d.accountID=e,this._queueRemoteRequest(t,i,a,n,s,o,d)},_computeTimeoutMS:function(e){var t;return e&&void 0!==e.timeoutMS&&(0===e.timeoutMS?t=this.DefaultRequestTimeout:e.timeoutMS>=1e3&&(t=e.timeoutMS)),t},_updateRequestTimeout:function(e){e.timeoutMS&&(this._clearRequestTimeout(e),e.timeout=setTimeout(this._handleRequestTimeout.bind(this,e),e.timeoutMS))},_clearRequestTimeout:function(e){e.timeout&&(clearTimeout(e.timeout),e.timeout=void 0)},_queueRemoteRequest:function(e,t,i,a,n,s,o){r.default.Assert(e&&r.default.isArray(e),"RequestFn must be a valid packed function"),r.default.Assert(t,"Must provide valid data for the request"),r.default.Assert(i,"Must supply a callback for request success"),r.default.Assert(r.default.isFunction(i),"Success callback must be a valid function"),r.default.Assert(a,"Must supply a callback for request failure"),r.default.Assert(r.default.isFunction(a),"Failure callback must be a valid function"),r.default.Assert(s,"Request type must be specified"),r.default.Assert(!o||!o.combinable,"Combinable is not currently a valid option. Do not use."),r.default.Assert(!n||!n.isLocalOnlyAttachment(),"Must either specify a valid remote attachment or none at all",n?n.id:"UNDEFINED");var d={id:++this._requestCounter,plugin:this,attach:n?[n]:void 0,request:void 0,requestFn:e,data:t,successCB:[i],failureCB:[a],type:s,queueTime:Date.now(),sendTimes:[],handleTimes:[],handled:!1,failed:!1,duped:!1,canceled:!1,timedOut:!1,wasBatched:!1,batchID:void 0,batchRequestID:void 0,requestsBehind:this._pendingRequests.length,accountID:o&&o.accountID?o.accountID:j.a.getDefaultEmail(),combinable:o&&o.combinable,autoRetry:!o||void 0===o.autoRetry||o.autoRetry,timeoutMS:this._computeTimeoutMS(o),forceNoDupe:o&&o.forceNoDupe,priority:o&&o.priority?o.priority:l.a.RequestPriority.Default};d.autoRetry&&(d.numRetries=o&&o.numRetries?o.numRetries:2,d.currentRetries=0),this._updateRequestTimeout(d);var u=this._insertPendingRequest(d);d.priority>l.a.RequestPriority.Default&&log("Insert Index: ",u,this._pendingRequests.length,d),r.default.vmMain.pluginManager.notifyHasPendingRemoteRequest()},_insertPendingRequest:function(e){e.priority++;var t=this._pendingRequests.insertSorted(e,this._reqSortFn);return e.priority--,t},_reqSortFn:function(e,t){return e.priority===t.priority?0:e.priority<t.priority?-1:1},_queuePagedRemoteRequestMulti:function(e,t,i,a,n,s,o,l){r.default.Assert(e,"Missing accountID parameter"),r.default.Assert(!r.default.isArray(e),"Missing accountID paramter"),r.default.Assert(!r.default.isFunction(e),"Missing accountID parameter"),r.default.Assert(!l||void 0===l.accountID,"AccountID is specified as a separate param");var d=l?r.default.clone(l):{};return d.accountID=e,this._queuePagedRemoteRequest(t,i,a,n,s,o,d)},_queuePagedRemoteRequest:function(e,t,i,a,n,s,o){var l=this;r.default.Assert(o,"Must supply a valid options param"),r.default.Assert(!o.getAllPages||!o.maxPages,"Should only define either maxPages or getAllPages: ",o.getAllPages,o.maxPages),o.maxPages=o.maxPages||1,o.getAllPages=o.getAllPages||!1,o.maxPageResults=o.maxPageResults||100,o.maxResults=o.maxResults||1/0,o.resultsField=o.resultsField||"items";var d,u=0,c=[],h=r.default.clone(t);h.maxResults=o.maxPageResults;var f=function(e){e[o.resultsField]?c.pushArray(e[o.resultsField]):e.items?c.pushArray(e.items):e.history&&c.pushArray(e.history),e.nextPageToken&&(o.getAllPages||o.maxPages>u)&&c.length<o.maxResults?d(e.nextPageToken):e.nextPageToken||e.nextSyncToken||e.historyId?i(c,t,e):i(c)},p=function(e){a(e,c)};(d=function(t){t&&(h.pageToken=t),u++,l._queueRemoteRequest(e,h,f,p,void 0,s,o)})()},_retryRemoteRequest:function(e,t){var i=this;e.request=void 0,e.wasBatched=void 0,e.batchID=void 0,e.batchRequestID=void 0,setTimeout(function(){e.currentRetries=e.currentRetries?e.currentRetries+1:1,i._insertPendingRequest(e),r.default.vmMain.pluginManager.notifyHasPendingRemoteRequest()},this._getRetryDelay(e,t))},getNumOutstandingReqs:function(){return this._numOutstandingReqs},_pumpRequestQueue:function(e,t,i,a){var n=0,s=0;r.default.Assert(this.areRemoteAPIsLoaded(),"Must have loaded remote APIs before pumping the request queue"),r.default.Assert(!this.hasDependency(PluginDependency.GoogleLogin)||this.hasDependencyBeenLoaded(PluginDependency.GoogleLogin),"Must be authorized to make remote requests");var o=0,d=0,u=0,c=0,h=0,f=0,p=0;r.default.Assert(this._numOutstandingReqs>=0,"Should never have fewer than zero outstanding requests");var g,m=t;r.default.Assert(m>0,"Should never have more than max outstanding requests for a given plugin"),m>1&&this._pendingRequests.length>1&&(g=this.createBatch());for(var v=[],_=0;m>0&&_<this._pendingRequests.length&&p<l.a.MaxBatchSize;++_){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var y=this._pendingRequests[_];if(y.priority<e)f++;else{0,r.default.Assert(!r.default.isFunction(y),"Should never use a deferred request"),r.default.Assert(!1===y.handled,"Should never service a request that has already been handled");var S=this._getDupeRequest(y);if(S)y.duped=!0,v.push(y),u++,this._appendDupeRequest(S,y);else{var w=this._getCombineRequest(y);if(w)y.combined=!0,v.push(y),c++,this._combineRequest(w,y);else{var I=!1;if(y.attach)for(var b=0,A=0;A<y.attach.length;++A){if(b++>5e3&&__infLoop&&__infLoop(b))throw new RangeError;y.attach[A].needsRemoteData()&&(y.attach[A].notifyDataRequested(),I=!0)}else I=!0;if(I)if(this.isCurrentlyAuthorized(y.accountID)){var D=this._runRemoteRequest(g,y,i);0,(D.isNewRequest||0===p)&&(r.default.Assert(t>o,"Should not be making more requests for plugin than allowed"),o++,m--,this._numOutstandingReqs++),D.wasBatched&&p++,v.push(y)}else j.a.notifyUnauthorizedRequest(y.accountID),h++;else y.canceled=!0,d++,v.push(y)}}}}this._pendingRequests=this._pendingRequests.removeArray(v);for(var T=0;T<v.length;++T){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;v[T].canceled||v[T].duped||this._addRequest(this._outstandingRequests,v[T])}return r.default.Assert(!g||p+d+u+c+h+f>1,"Batches should always have multiple items in them"),g&&p>0&&this.commitBatch(g,a),o},_clearRequestQueue:function(){log("Clear Request Queue: ",this.id),this._pendingRequests=[],this._outstandingRequests=[],this._numOutstandingReqs=0},_addRequest:function(e,t){return r.default.Assert(e.indexOf(t)<0,"Should never re-add a request to a queue without removing it first"),e.push(t)},_removeRequest:function(e,t){return e.remove(t)},isRateLimited:function(){return this._isRateLimited},_notifyRateLimitedOver:function(){this._isRateLimited=!1},_notifyRateLimited:function(e){this._isRateLimited=!0,this._lastRateLimitTime=new Date},isRateLimitError:function(e){var t=!1;return e&&ue.indexOf(e.status)>=0&&(e.status===l.a.HTTPStatusCode.Forbidden?r.default.hasGoogleError(e,l.a.GoogleErrorDomain.UsageLimits,l.a.GoogleError.UserRateLimitExceeded)?t=!0:r.default.hasGoogleError(e,l.a.GoogleErrorDomain.UsageLimits,l.a.GoogleError.RateLimitExceeded)?t=!0:r.default.hasGoogleError(e,l.a.GoogleErrorDomain.UsageLimits,l.a.GoogleError.QuotaExceeded)&&(t=!0):t=!0),t},_getRetryDelay:function(e,t){var i=e.currentRetries;return t&&(i=Math.max(2,e.currentRetries)),r.default.seconds(le[i])},_notifyRequestSuccess:function(e,t){var i={cbList:e.successCB,result:t};e.wasBatched?(this._batchedResponses[e.batchID]||(this._batchedResponses[e.batchID]=[]),this._batchedResponses[e.batchID].push(i)):this._handleResponse(i)},_notifyRequestFailure:function(e,t){var i={cbList:e.failureCB,result:t};e.wasBatched?(this._batchedResponses[e.batchID]||(this._batchedResponses[e.batchID]=[]),this._batchedResponses[e.batchID].push(i)):this._handleResponse(i)},_handleResponse:function(e){for(var t=0,i=0;i<e.cbList.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;try{e.cbList[i](e.result)}catch(e){r.default.reportError(e)}}},_notifyBatchCompleted:function(e){var t=this._batchedResponses[e.getBatchID()];if(delete this._batchedResponses[e.getBatchID()],t){var i=0;r.default.vmMain.beginUpdateItems();for(var a=0;a<t.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;this._handleResponse(t[a])}r.default.vmMain.commitUpdateItems()}},computeBatchGroupID:function(e){return e.accountID},computeRequestID:function(e){return e.id+"-"+Date.now()},_setSendTime:function(e){var t=Date.now();if(0===e.sendTimes.length){var i=t-e.queueTime;this._numSendRequests++,this._totalRequestSendTime+=i,i>this.LongWaitThreshold&&this._numLongWaitRequests++}e.sendTimes.push(t)},_setHandleTime:function(e){var t=Date.now();if(0===e.handleTimes.length){var i=t-e.queueTime;this._numHandledRequests++,this._totalRequestHandleTime+=i}e.handleTimes.push(t)},_runRemoteRequest:function(e,t,i){var a=this,n={wasBatched:!1,isNewRequest:!1};if(I.a.canConstruct(t.requestFn))t.request=I.a.createRequest(t.accountID,t.requestFn,t.data);else{var s=r.default.unpackFn(t.requestFn);r.default.Assert(r.default.isFunction(s,"Must specify a valid packed function: ",t.requestFn)),s&&(t.request=s(t.data))}if(t.request){if(r.default.Assert(t.request.then,"Remote request must be thenable"),e){var o=this.computeBatchGroupID(t),l=this.computeRequestID(t);n.isNewRequest=e.add(t.request,o,l),r.default.Assert(r.default.isBoolean(n.isNewRequest),"Add must return whether it will create a new remote request for this request"),n.wasBatched=!0,t.wasBatched=!0,t.batchID=e.getBatchID(),t.batchRequestID=l}else t.wasBatched=!1,t.batchID=void 0,t.batchRequestID=void 0;0,r.default.Assert(this.isCurrentlyAuthorized(t.accountID),"Must be currently authorized to make this request"),this._clearRequestTimeout(t),this._setSendTime(t),t.request.then(function(e){r.default.Assert(!1===t.handled,"Must not handle the same request multiple times"),a._setHandleTime(t),t.handled=!0,a._notifyRateLimitedOver(),a._notifyRequestSuccess(t,e.result),i(t.attach,t.plugin,t.wasBatched),a._removeRequest(a._outstandingRequests,t)},function(e){r.default.Assert(!1===t.handled,"Must not handle the same request multiple times"),a._setHandleTime(t);var n=a.isRateLimitError(e);if(n&&a._notifyRateLimited(e),(n||de.indexOf(e.status)>=0)&&t.autoRetry&&t.currentRetries<t.numRetries)i(t.attach,t.plugin,t.wasBatched),a._removeRequest(a._outstandingRequests,t),a._retryRemoteRequest(t,n);else{if(t.handled=!0,t.failed=!0,t.attach)for(var s=0,o=0;o<t.attach.length;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;t.attach[o].notifyDataRequestFailed()}a._notifyRequestFailure(t,e.result),i(t.attach,t.plugin,t.wasBatched),a._removeRequest(a._outstandingRequests,t)}},this)}return n},createPaginationToken:function(e,t,i,a,n,s){return new re(e,t,i,a,n,s)},updatePaginationToken:function(e,t){return r.default.Assert(e,"Must specify a valid token to update"),r.default.Assert(t,"Must update the pagination token with a valid next page token"),e.updateToken(t),e},createBatch:function(e){return I.a.createBatch(e)},commitBatch:function(e,t){var i=this;r.default.Assert(e,"Batch to commit must be specified"),e.then(function(a){i._notifyBatchCompleted(e),t(i,!0)},function(){i._notifyBatchCompleted(e),t(i,!1)})},addModifiedOffline:function(e,t){if(r.default.Assert(e,"Must have a valid cache entry to update"),r.default.Assert(r.default.isBoolean(t)||r.default.isArray(t),"Incoming fields must be valid"),r.default.Assert(!1!==t,"Use removeModifiedOffline to clear data instead"),e){var i=e.modifiedOffline||!1;r.default.Assert(r.default.isBoolean(i)||r.default.isArray(i),"Previous fields must be valid"),!1===i?e.modifiedOffline=t:!0===i||(!0===t?e.modifiedOffline=!0:e.modifiedOffline.pushOnlyUniques(t))}},removeModifiedOffline:function(e,t){if(r.default.Assert(e,"Must have a valid cache entry to update"),r.default.Assert(r.default.isBoolean(t)||r.default.isArray(t),"Incoming fields must be valid"),r.default.Assert(!0!==t,"Use addModifiedOffline to add data instead"),e){var i=e.modifiedOffline||!1;r.default.Assert(r.default.isBoolean(i)||r.default.isArray(i),"Previous fields must be valid"),!1===i||(!0===i?!1===t&&(e.modifiedOffline=!1):!1===t?e.modifiedOffline=!1:(e.modifiedOffline=e.modifiedOffline.removeArray(t),0===e.modifiedOffline.length&&(e.modifiedOffline=!1)))}},compactCacheField:function(e,t){return e[t]},_serializeObj:function(e,t){var i=0;r.default.Assert(e,"Must specify a valid entry to serialize"),r.default.Assert(t,"Must provide a valid property list");for(var a={},n=0;n<t.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=t[n],o=this.getPropertyDescriptor(s);if(!o.isOpt||o.defaultValue!==e[s]){var l=this.compactCacheField(e,s);void 0!==l&&(a[s]=l)}}var d=this.getBlobData(e);return d&&(a._blob=d),a},serializeEntry:function(e){var t=this.getPropertySet(PluginLoad.Full),i=this.getCacheData(e);if(i)return this._serializeObj(i,t)},serializeExternalData:function(e){r.default.Assert(e,"Must supply valid data to serialize");var t=this.getPropertySet(PluginLoad.Full),i=this._serializeObj(e,t);return i.id=e.id,e.parents&&(i.parents=e.parents),i},serializePreview:function(e){var t=this.getPropertySet(PluginLoad.Preview),i=this.getCacheData(e.id);if(i)return this._serializeObj(i,t)},registerAutocomplete:function(){if(!this._registeredAutocomplete){var e=this.getAutocompletePrefixes();if(e){var t=0;oe.a.registerProvider(this._acProviderId,this);for(var i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;oe.a.registerPrefix(this._acProviderId,e[i])}}this._registeredAutocomplete=!0}},unregisterAutocomplete:function(){this._registeredAutocomplete},declareProperty:function(e,t,i,a,n){var s=this;r.default.Assert(!this._propertyDescriptors[e],"Should not declare the same property twice"),t=t||PluginLoad.Preview|PluginLoad.Full,i=i||!1,r.default.forEachFlagSet(t,function(t){s._propertySets[t]||(s._propertySets[t]=[]),s._propertySets[t].push(e)}),this._propertyDescriptors[e]={isOpt:i,defaultValue:a,comparator:n}},getPropertySet:function(e){return this._propertySets[e]||[]},getPropertyDescriptor:function(e){return this._propertyDescriptors[e]},getBlobData:function(e){},_updateAttachmentStates:function(){try{var e=0;r.default.vmMain.beginUpdateItems();for(var t=0;t<this._attachKeys.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this._attachCache[this._attachKeys[t]];i.isInUse()&&i.onUpdate(!1,void 0,ChangeType.Auto)}r.default.vmMain.commitUpdateItems()}catch(e){r.default.reportError(e)}},offlineLoad:function(){if(!this._hasRunOfflineLoad&&this.supportOfflineLoad())try{this._offlineLoad&&(this._hasRunOfflineLoad=this._offlineLoad())}catch(e){r.default.reportError(e)}},load:function(){if(this._isFirstLoad){this._isFirstLoad=!1;try{this._load&&this._load()}catch(e){r.default.reportError(e)}}this._loadedInitialData||!r.default.isDemoMode()&&!this.hasActiveDataPanes()||this.isPluginBlocked()||this.loadInitialData()},loadInitialData:function(){r.default.Assert(!this._loadedInitialData,"Do not make multiple requests for initial data load"),r.default.Assert(!this.isPluginBlocked(),"Should not load data for blocked plugins"),this._loadedInitialData=!0},finishedLoading:function(){r.default.fireCustomEvent(this.loadedEvent)},getDataPane:function(){},getPaneIcon:function(){return"icon-question"},getPanePriority:function(){return 0},getDefaultDisplayItem:function(){},useItemStore:function(){},itemStoreOptions:function(){},getDefaultItemStore:function(){return r.default.Assert(this.useItemStore(),"Must request an item store"),this._defaultItemStore},getActiveItemStore:function(e){r.default.Assert(e,"Must specify a valid paneID to get the item store for"),r.default.Assert(this.useItemStore(),"Must request item store usage");var t=this._activeItemStore[e];return t||this._defaultItemStore},getBucketItemStore:function(e){return this._searchBuckets[e]},allowRemoteRequests:function(){return!1},handleDropEvent:function(e,t){return!1},handleTapClick:function(e,t,i,a){return!1},handleDoubleTap:function(e,t,i,a){return!1},getAutocompletePrefixes:function(){},notifyPaneCreated:function(){this._numActivePanes++,!this.isActive()||this._loadedInitialData||this.isPluginBlocked()||(this.areDependenciesLoaded()?this.loadInitialData():this.loadRemoteAPIs())},notifyPaneDestroyed:function(){this._numActivePanes--,r.default.Assert(this._numActivePanes>=0,"Should never have negative active panes")},notifyPanesReadyForLoad:function(){r.default.vmMain.paneManager.runForEachPane(function(e){e.notifyPluginLoaded()},this.getPaneType())},hasActiveDataPanes:function(){return this._numActivePanes>0},allowTextEditing:function(e,t){return!0},_createSearchBucket:function(e,t){var i;i=r.default.generateTempId();var a=r.default.vmMain.itemStoreManager.registerItemStore(i,this,{trackGlobally:!1});return a.createRoot(t||r.default.generateTempId(),"Search Results"),this._searchBuckets[i]=a,i},_destroySearchBucket:function(e){this._searchBuckets[e].clearStore()},swapInSearchBucket:function(e,t){if(r.default.Assert(this.useItemStore(),"Must be marked as using an item store to support searches"),r.default.vmMain.paneManager.isPaneActive(t)){var i=r.default.vmMain.paneManager.getPaneById(t),a=this._searchBuckets[e];if(!this._activeSearchBucket[t]||this._activeSearchBucket[t].id!==e){var n=a.getRoot();this._activeSearchBucket[t]||(this._defaultZoomItems[t]=i.getItem()),this._activeItemStore[t]=a,this._activeSearchBucket[t]=a,i.setRootItem(n,!0),i.useItemStore(a)}}},swapOutSearchBucket:function(e,t){r.default.Assert(this.useItemStore(),"Must be marked as using an item store to support searches");var i=this._activeSearchBucket[e].id;var a=r.default.vmMain.paneManager.getPaneById(e),n=this._searchBuckets[i];r.default.Assert(n,"Must have a valid bucket we are swapping from");var s=a.getRootItem();r.default.Assert(s===n.getRoot(),"Current root for pane should match bucket root"),t=t||this._defaultZoomItems[e],r.default.Assert(t,"Must always be able to get a valid default zoom item"),this._activeItemStore[e]=void 0,this._activeSearchBucket[e]=void 0,this._defaultZoomItems[e]=void 0,a.setItem(t,!0),a.stopUsingItemStore(n),this._destroySearchBucket(i)},runSearch:function(e,t,i,a,n){var s;return r.default.Assert(this.useItemStore(),"Must be marked as using an item store to support searches"),a&&(s=this._createSearchBucket(e,i)),this.runRemoteSearch(e,t,s,n)},getSearchRoot:function(e){var t=this._searchBuckets[e];return r.default.Assert(t,"Should always reference a valid search bucket"),t.getRoot()},runRemoteSearch:function(e,t,i){r.default.Assert(!1,"SubClass must override")},isRemoteSearchBucketActive:function(e){return!!this._activeSearchBucket[e]},clearSearch:function(e,t){this._activeSearchBucket[e]&&this.swapOutSearchBucket(e,t)},refreshCurrentView:function(e){r.default.Assert(!1,"SubClass must override")},dumpRequestQueue:function(e){var t=0,i=0;console.log("---- Outstanding Requests ["+this._numOutstandingReqs+"] ----");for(var a=0;a<this._outstandingRequests.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=this._outstandingRequests[a];console.log("  ",n.requestFn,":",n.id," - ",n.data)}console.log("---- Pending Requests ["+this._pendingRequests.length+"] ----");for(var s=0;s<this._pendingRequests.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var o=this._pendingRequests[s];console.log("  ",o.requestFn,":",o.id," - ",o.data)}if(e){var l=0;r.default.Assert(!1,"Must be in DEBUG mode to display info on handled requests"),console.log("---- Handled Requests ["+this._handledRequests.length+"] ----");for(var d=0;d<this._handledRequests.length;++d){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;var u=this._handledRequests[d];u.failed?console.log(" !",u.requestFn,":",u.id," - ",u.data):console.log("  ",u.requestFn,":",u.id," - ",u.data)}}},dumpQueueStats:function(){console.log("  Rate Limited: "+this._isRateLimited),console.log("  Long Wait Requests: "+this._numLongWaitRequests),console.log("  Num Requests: ",this._numSendRequests,this._numHandledRequests),console.log("  Num Pending Requests: ",this._pendingRequests.length),console.log("  Avg. Send Time: ",this._totalRequestSendTime/this._numSendRequests),console.log("  Avg. Handle Time: ",this._totalRequestHandleTime/this._numHandledRequests)},getCssClass:function(e){return""}},o.a.defineBase(he);var fe,pe=he,ge=i(37);function me(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function ve(e){this.plugin=r.default.vmMain.pluginManager.getPlugin(PluginID.Drive),this.type=this.plugin._paneType,this.title="Files",this.paneClass="paneOutline panePlugin paneDrive noComplete",this.paneEmptyMessage="Loading Google Drive...",this.paneEmptySearchMessage="",this.titleContextMenuHeader="Open folder",this.dropEffect=function(){return l.a.DropEffect.Copy},this.isWriteable=!1,this.isDropTarget=!1,this.overrideCopyBehavior=!1,this.canAddItem=!1,this.supportCollapsing=!0,this.supportCompleting=!1,this.supportCheckbox=!1,this.supportOffline=!1,this.supportPerformArchive=!1,this.supportDataRefresh=!0,this.supportPagination=!0,this.supportSearchListenTextChanges=!1,this.supportSearchFlat=!1,this.supportClickOverviewScroll=!1,this.supportClone=!1,this.supportDates=!1,this.shouldUpdateOnTextChanged=!1,this.overviewTracksScroll=!1,this.hasMoreButtons=!0,this.searchFilters=[],this._super.constructor.call(this,e),this._isSearchingRemote=new w.a(!1),this._currentSearch=void 0,this.initDrive()}var _e=(me(fe={initDrive:function(){this.search.onChanged.listen(o.a.forceBind("notifySearchChanged",this)),this._searchTimeout=void 0,this._lastSearchValue=void 0,this._lastSearchTime=0},destroy:function(){this.search.onChanged.unlisten(this.notifySearchChanged),clearTimeout(this._searchTimeout),this._searchTimeout=void 0,this._super.destroy.call(this)},_getNotReadyStatus:function(){var e="Unknown Error: Unable to load pane data.",t=this.plugin.getUnloadedDependencies();return t&&(t.indexOf(PluginDependency.PremiumSub)>=0?e="Only available to premium subscribers.":t.indexOf(PluginDependency.GoogleLogin)>=0&&(e="Missing permissions for Google Drive access.")),e},getItemStore:function(){return this.plugin.getActiveItemStore(this.id)},getRootItem:function(){var e=this.getItemStore();return e?e.getRoot():void 0},bottomListMessage:function(){var e;return!this.isSearched()&&this.getItem().hasPaginationToken()&&(e="LOAD MORE"),{text:e,clickable:!0}},searchACName:function(){},getPaneIcon:function(){return this.plugin.getPaneIcon()},requestDemandLoadData:function(e){this.plugin.requestDemandLoadData(this.id,e)},requestDataPage:function(e){this.plugin.requestDataPage(e)},updateContents:function(){this._super.updateContents.call(this)},onAfterLoaded:function(){this._super.onAfterLoaded.call(this)},onClose:function(){this._super.onClose.call(this)},_runRemoteSearch:function(){if(r.default.vmMain.paneManager.isPaneActive(this.id)){clearTimeout(this._searchTimeout),this._searchTimeout=void 0;var e=this.search.getValue();this._lastSearchValue=e,this._lastSearchTime=Date.now(),this.isLoading.set(!0),this.paneTopText.set("Searching..."),this._isSearchingRemote.set(!0),this._currentSearch&&(this._currentSearch.invalidate(),this._currentSearch=void 0),this._currentSearch=this.plugin.runSearch(e,this.id,void 0,!1,function(e){switch(this.isLoading.set(!1),e){case SearchResultStatus.Done:this.paneTopText.set("");break;case SearchResultStatus.TooMany:this.paneTopText.set("Too many search results! Be more specific.");break;case SearchResultStatus.None:this.paneTopText.set("There were no search results");break;case SearchResultStatus.Error:this.paneTopText.set("There was an error running your search, try again.");break;default:r.default.Assert(!1,"Invalid search state: ",e)}}.bind(this))}},notifySearchChanged:function(e){var t=this.search.getValue();if(t!==this._lastSearchValue||Date.now()-this._lastSearchTime>5e3)if(clearTimeout(this._searchTimeout),this._searchTimeout=void 0,t){var i=e?0:2500;this._searchTimeout=setTimeout(this._runRemoteSearch.bind(this),i)}else this._isSearchingRemote.set(!1),this.plugin.clearSearch(this.id),this.isLoading.set(!1),this.paneTopText.set("")},refreshPaneData:function(){this.plugin.refreshCurrentView(this.id)},notifyDropFrom:function(e,t){this.plugin.notifyDropFrom(e,t)},notifyDropFromToEdit:function(e,t){return this.plugin.notifyDropFromToEdit(e,t)},applyDropOnBlock:function(e,t){if(e.isDate){var i,a=e.dateTime||e.date;i=r.default.isString(a)?H.a.parseDate(a,l.a.DateFormat.MDY):a,r.default.Assert(r.default.isDateValid(i),"Must provide a valid date when scheduling an email",e.dateTime,e.date),r.default.isDateValid(i)&&this.plugin.scheduleFile(t,i)}},dropEffectCopyBehavior:function(e,t){return this._super.dropEffectCopyBehavior.call(this,e,t)}},"refreshPaneData",function(){this.plugin.refreshCurrentView(this.id)}),me(fe,"isSearchingRemote",function(){return this._isSearchingRemote.get()}),me(fe,"_onRemoteDataLoaded",function(){}),me(fe,"isItemHeader",function(e,t){if(t){var i=this.plugin,a=e.getAttachmentByPlugin(i.id),n=a&&i.getCacheData(a.id);return!n||i.isFolder(n)}return e.isHeader()}),fe);o.a.inherit(ge.a,ve),o.a.extend(ve.prototype,_e);var ye=ve;function Se(){this._super.constructor.call(this,PluginID.Drive,"Files"),this.displaySharedWithMe=!r.default.isDemoMode(),this._requiresOfflineAuth=!0,o.a.forceBind("sortFn",this),this.registerSetting("WriteAccess","writeAccess",!0),this.registerSetting("LastChangeId","lastChangeId"),this.registerSetting("DriveRootId","driveRootId"),this._folderCache=this.registerLocalCache("FolderCache",StorageType.IndexedDB,!0),this.declareProperty("showInline",PluginLoad.Preview|PluginLoad.Full|PluginLoad.Inline,!0),this.declareProperty("imageWidth",PluginLoad.Preview|PluginLoad.Full|PluginLoad.Inline,!0),this.declareProperty("titleLower",PluginLoad.Runtime,!1,""),this.declareProperty("dataUrl",PluginLoad.Preview|PluginLoad.Runtime,!0),this.declareProperty("pinToTop",PluginLoad.Runtime,!0,!1),this.declareProperty("title"),this.declareProperty("mimeType"),this.declareProperty("fileSize",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("alternateLink",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("webContentLink",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("isDeleted",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("modifiedDate",PluginLoad.Autocomplete,!0),this.declareProperty("parents",PluginLoad.Autocomplete,!0),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.DriveFile),this.useRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.DriveFile),this.useRenderer(PluginRenderTypes.Measure,PluginRenderers.DriveFile)}var we="application/octet-stream",Ie="application/vnd.google-apps.folder",be="application/vnd.google-apps.spreadsheet",Ae="application/vnd.google-apps.presentation",De="application/vnd.google-apps.document",Te=f.default.REALTIME_MIMETYPE+"."+f.default.APP_ID,Me="image/png",Ce="image/jpg",Le="image/jpeg",Pe="image/gif",Ee=1,ke=2,xe=3,Re=4,Oe=5,Fe=6,Ne=7,Be="S~SharedWithMe",Ue="https://drive.google.com/open?id=",Ve="-------314159265358979323846",He="\r\n--"+Ve+"\r\n",qe={getType:function(){return l.a.PluginType.Storage},getDataPane:function(){return r.default.Assert(!!this.getPaneIcon(),"Should have a pane icon specified"),ye},getPaneIcon:function(){return"icon-drive-file"},getPanePriority:function(){return 96},useItemStore:function(){return"Google Drive"},itemStoreOptions:function(){return{requireStoredEls:!1,parserFn:q.a.runParseSinglePlugin.bind(q.a)}},allowRemoteRequests:function(){return!0},onAuthorizedSetting:function(e,t){switch(e){case this.Settings.WriteAccess:t&&this._ensureAttachmentsAreShared()}},_ensureSpecialFolders:function(){var e=this.getDefaultItemStore();if(e){var t=e.getRoot();if(this.displaySharedWithMe&&!e.hasItem(Be)){var i=r.default.generateTempId();this.cacheData(i,{title:"Shared With Me",titleLower:"shared with me",mimeType:Ie,pinToTop:!0});var a=this.getAttachment(i),n=e.createItem(Be,this.getAttachmentEmbedString(a),t.id,{demandLoadChildren:!0});t.insertSorted(n,this.sortFn)}}},_load:function(){this._ensureSpecialFolders(),r.default.isDemoMode()||this.createRecurringTask("ChangeListUpdates",{delay:r.default.minutes(15),minDelay:r.default.minutes(2),runOnCreate:!0,pauseWhileIdle:!0,task:this.performChangeListUpdate.bind(this)})},_notifyFailedRequest:function(e){e&&e.error&&r.default.reportError(new Error("Failed Drive request: ",e.error.code),e)},refreshCurrentView:function(){this.hasRecurringTask("ChangeListUpdates")&&this.getRecurringTask("ChangeListUpdates").forceUpdate()},loadInitialData:function(){this._super.loadInitialData.call(this),this._ensureSpecialFolders();var e=new X(function(e){}.bind(this));setTimeout(function(){this._folderCache.onCacheMetadataReady(function(){this._folderCache.getMetadata("isSyncd",function(t){t||(log("Folder cache unsyncd - running folder sync"),this._folderCache.onCacheReady(function(){var t="trashed=false and mimeType contains '"+Ie+"'";this._requestRemoteFiles(ke,e,t,999,function(e){this._folderCache.cacheEntry(e.id,this.serializeExternalData(e)),0}.bind(this),function(e){0}.bind(this)),this._folderCache.setMetadata("isSyncd",!0)}.bind(this)))}.bind(this))}.bind(this))}.bind(this),100);var t=!1,i=this.getDefaultItemStore(),a=i.getRoot(),n="trashed=false and 'root' in parents and mimeType != '"+Te+"'";this._requestRemoteFiles(xe,a,n,70,function(e){if(this.hasCacheData(e.id)||this._addRemoteEntry(e),!this._hasSameItem(e.id,a.id,i)){var t=i.createItem(this._createItemID(e.id,i),this._getTextForItem(e),a.id,{demandLoadChildren:e.mimeType===Ie});a.insertSorted(t,this.sortFn)}if(!this.getSetting(this.Settings.DriveRootId)&&e.parents)for(var n=0,s=0;s<e.parents.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;e.parents[s].isRoot&&this.setSetting(this.Settings.DriveRootId,e.parents[s].id)}}.bind(this),function(){t||(t=!0,this.finishedLoading())}.bind(this))},performChangeListUpdate:function(){var e=-1,t=this.getSetting(this.Settings.LastChangeId);this._requestChangeList(t,function(i){r.default.Assert(!t||parseInt(i.id)>parseInt(t),"Must have correctly ordered change entry"),e=i.id;try{!i.fileId||i.file&&i.file.mimeType===Te||this._handleChange(i)}catch(e){r.default.reportError(e)}}.bind(this),function(t){t&&-1!=e&&this.setSetting(this.Settings.LastChangeId,e)}.bind(this))},_deleteFile:function(e){e.forEachItem(this.getDefaultItemStore(),function(e){e.parent().removeChild(e,ChangeType.Remote),e.parent(void 0)}),e.updateField("isDeleted",!0)},_handleChange:function(e){if(r.default.Assert(e&&(e.deleted||e.file),"Must have a valid formed change entry to handle"),(e.deleted||e.file.mimeType===Ie)&&(e.deleted?this._folderCache.hasEntry(e.fileId,function(t){t&&this._folderCache.removeEntry(e.fileId)}.bind(this)):this._folderCache.cacheEntry(e.fileId,this.serializeExternalData(e.file))),!this.hasCacheData(e.fileId)&&!e.deleted&&e.file){for(var t=0,i=e.file.parents,a=!1,n=0;n<i.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(this.hasCacheData(i[n].id)||i[n].isRoot){a=!0;break}}a&&this._addRemoteEntry(e.file)}var s=this.getCacheData(e.fileId);if(s){e.deleted||this.dataHasChanged(s,e.file)&&this._addRemoteEntry(e.file);var o=this.getDefaultItemStore();if(e.deleted){var l=this.getAttachment(e.fileId);this._deleteFile(l)}else{var d=0,u=[];(l=this.getAttachment(e.fileId)).forEachItem(o,function(t){for(var i=0,a=!1,n=0;n<e.file.parents.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=e.file.parents[n];if(s.isRoot&&t.parent()&&t.parent().isRootItem()||t.parent()&&t.parent().hasAttachment(s.id)){a=!0,u.push(s.id);break}}t.parent()&&this._isSpecialFolder(t.parent().id)&&(a=!0,u.push(t.parent().id)),!a&&t.parent()&&(t.parent().removeChild(t,ChangeType.Remote),t.parent(void 0))}.bind(this));for(n=0;n<e.file.parents.length;++n){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;var c=e.file.parents[n];if(u.indexOf(c.id)<0)if(c.isRoot){var h=o.getRoot(),f=o.createItem(this._createItemID(e.fileId,o),this._getTextForItem(e.file),h.id,{demandLoadChildren:e.file.mimeType===Ie});h.insertSorted(f,this.sortFn)}else{this.getAttachment(c.id).forEachItem(o,function(t){var i=o.createItem(this._createItemID(e.fileId,o),this._getTextForItem(e.file),t.id,{demandLoadChildren:e.file.mimeType===Ie});t.insertSorted(i,this.sortFn)}.bind(this))}}if(this.displaySharedWithMe&&e.file.sharedWithMeDate&&u.indexOf(Be)<0){var p=o.getItem(Be);f=o.createItem(this._createItemID(e.fileId,o),this._getTextForItem(e.file),p.id,{demandLoadChildren:e.file.mimeType===Ie});p.insertSorted(f,this.sortFn)}}}},_isValidFileID:function(e){return e.indexOf("~")<0},_createItemID:function(e,t){var i=0;r.default.Assert(e,"Must provide a fileID"),r.default.Assert(this._isValidFileID(e),"Invalid fileID - "+e),r.default.Assert(t,"Must provide a valid itemStore");for(var a=e,n=0;t.hasItem(a)&&n<50;){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;a=e+"~"+ ++n}return r.default.Assert(n<50,"SANITY: Should not have items with 50+ parents"),a},_hasSameItem:function(e,t,i){for(var a=0,n=!1,s=e,r=0;i.hasItem(s)&&r<50;){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var o=i.getItem(s);if(o&&o.parent()&&o.parent().id===t){n=!0;break}s=e+"~"+ ++r}return n},_isSpecialFolder:function(e){return e.startsWith("S~")},requestDemandLoadData:function(e,t){r.default.Assert(1===t.getNumAttachments(),"Should only have a single attachment for Drive Pane VMLIs");var i,a=r.default.vmMain.paneManager.getPaneById(e),n=t.getAttachmentByPlugin(this.id);if(this._isSpecialFolder(t.id))switch(t.id){case Be:i="trashed=false and sharedWithMe and mimeType != '"+Te+"'";break;default:r.default.Assert(!1,"Invalid special folder ID")}i||(i="trashed=false and '"+n.id+"' in parents and mimeType != '"+Te+"'");var s=this.getActiveItemStore(e);this._requestRemoteFiles(xe,t,i,70,function(e){if(this.hasCacheData(e.id)||this._addRemoteEntry(e),!this._hasSameItem(e.id,t.id,s)){var i=s.createItem(this._createItemID(e.id,s),this._getTextForItem(e),t.id,{demandLoadChildren:e.mimeType===Ie});t.insertSorted(i,this.sortFn)}}.bind(this),function(e){e||t.hasPaginationToken()||t.notifyLoadDataFailed(a)}.bind(this)),this.sendEvent("RequestDemandLoadData")},requestDataPage:function(e){this._requestRemoteFiles(Oe,e)},_ensureAncestorChain:function(e,t,i,a){if(r.default.Assert(i,"Must provide a valid success callback"),r.default.Assert(a,"Must provide a valid error callback"),t.parents&&t.parents.length)for(var n=0,s=t.parents.length,o=0,l=function(){++o===s&&i()},d=function(t){r.default.Assert(t,"Must provide valid fileInfo up ancestor chain"),this.hasCacheData(t.id)||this._addRemoteEntry(t),this._ensureAncestorChain(e,t,l,a)}.bind(this),u=function(e){if(e){var t=this.serializeExternalData(e);this._folderCache.cacheEntry(t.id,t),d(t)}else a({error:"Undefined success result."})}.bind(this),c=function(e,t){if(e)d(e);else{var i=I.a.fns("drive").files.get.packedFn,n={fileId:t};this._queueRemoteRequest(i,n,u,a,void 0,Ne)}}.bind(this),h=0;h<t.parents.length;++h){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var f=t.parents[h].id;r.default.Assert(f,"Must supply a valid parent ID to query"),this._folderCache.getEntry(f,c)}else i()},_hasAttachmentChild:function(e,t){for(var i=0,a=!1,n=0;n<e.numItems();++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(e.itemAtIndex(n).hasAttachment(t)){a=!0;break}}return a},_attachAncestorChain:function(e,t){if(r.default.Assert(t,"Must provide a valid cache entry to create items for"),t.parents&&t.parents.length>0)for(var i=0,a=0;a<t.parents.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=t.parents[a];if(r.default.Assert(n&&n.id,"Must supply a valid parent ID to query"),n.isRoot){var s=e.getRoot();if(!this._hasAttachmentChild(s,t.id)){var o=e.createItem(this._createItemID(t.id,e),this._getTextForItem(t),s.id,{demandLoadChildren:t.mimeType===Ie});s.insertSorted(o,this.sortFn)}}else this._folderCache.getEntry(n.id,function(i){this._attachAncestorChain(e,i),this.getAttachment(i.id).forEachItem(e,function(i){if(!this._hasAttachmentChild(i,t.id)){var a=e.createItem(this._createItemID(t.id,e),this._getTextForItem(t),i.id,{demandLoadChildren:t.mimeType===Ie});i.insertSorted(a,this.sortFn)}}.bind(this))}.bind(this))}},getNextSearchPage:function(){this._lastCompletedSearch&&this._lastCompletedSearch.isValid()&&this._lastCompletedSearch.getNextPage()},runRemoteSearch:function(e,t,i,a){r.default.Assert(e,"Must provide a valid search"),r.default.Assert(t,"Must provide a valid pane"),r.default.Assert(r.default.isFunction(a),"Must provide a valid search callback");var n=!1,s=0,o=0,l=0,d=new Z(e,10,this.requestDataPage.bind(this)),u=function(){if(s===o&&n){log("Done Searching! "+s);var e=SearchResultStatus.Done;if(d.isValid())r.default.vmMain.paneManager.getPaneById(t).search.update(!0),d.isValid()&&d.hasMoreResults()?(log("Too many search results"),e=SearchResultStatus.TooMany):d.hasError()||l>0?e=SearchResultStatus.Error:0===s&&(e=SearchResultStatus.None),this._lastCompletedSearch=d;a(e)}}.bind(this),c=function(e){s++,this.hasCacheData(e.id)||this._addRemoteEntry(e);var i=this.getActiveItemStore(t);this._ensureAncestorChain(i,e,function(){d.isValid()&&this._attachAncestorChain(i,e),o++,u()}.bind(this),function(e){r.default.reportError(new Error("Error during remote search: ",e)),o++,l++,u()}.bind(this))}.bind(this),h=function(e){n=!0,u()}.bind(this),f=!1,p="trashed=false and (fullText contains '"+e+"')";return this._requestRemoteFiles(Re,d,p,100,d.onEntry,function(e){d.onDone(e),f||(f=!0,d.isValid()&&(d.hasResults()?d.getNextPage(c,h):h(e)))}),this.sendEvent("RemoteSearch"),d},_requestRemoteFiles:function(e,t,i,a,n,s){var o;t&&t.hasPaginationToken()&&!t.paginationTokenInUse()?(i=(o=t.beginDataPageLoad()).getQuery(),a=o.getMaxResults(),n=o.getEntryCB(),s=o.getDoneCB()):t&&t.needsPaginationToken()&&(o=this.createPaginationToken(void 0,i,{},a,n,s),t.setPaginationToken(o),t.beginDataPageLoad()),a=a||70,r.default.Assert(n&&r.default.isFunction(n),"Must define a valid entry callback"),r.default.Assert(s&&r.default.isFunction(s),"Must define a valid done callback");var l,d,u=I.a.fns("drive").files.list.packedFn,c={fields:"items,nextPageToken",maxResults:a,q:i,pageToken:o&&o.hasMorePages()?o.getNextPageToken():void 0};o||!t?(l=function(e){if(e.items){var i=0;r.default.vmMain.beginUpdateItems();for(var a=0;a<e.items.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;n(e.items[a])}r.default.vmMain.commitUpdateItems()}e.nextPageToken&&o&&this.updatePaginationToken(o,e.nextPageToken),t&&o&&t.endDataPageLoad(!!e.nextPageToken),s(!0)}.bind(this),d=function(){o&&t.endDataPageLoad(!!o),s(!1)}.bind(this)):(l=function(){s(!0)},d=function(){s(!1)}),this._queueRemoteRequest(u,c,l,d,void 0,e)},getRemoteAttachmentData:function(e){var t=I.a.fns("drive").files.get.packedFn,i={fileId:e.id},a=function(t){r.default.Assert(!t||t.id===e.id,"If valid result, attachment should match remote file ID"),t&&(this._addRemoteEntry(t),(t.deleted||t.mimeType===Ie)&&(t.deleted?this._folderCache.hasEntry(t.id,function(e){e&&this._folderCache.removeEntry(t.id)}.bind(this)):this._folderCache.cacheEntry(t.id,this.serializeExternalData(t))))}.bind(this),n=function(t){if(r.default.isHTTPStatusCode(t,l.a.HTTPStatusCode.NotFound)){var i={id:e.id,mimeType:we,title:"Unknown",titleLower:"unknown",fileSize:0};this._addRemoteEntry(i),this._deleteFile(e)}else e.notifyDataRequestFailed(),this._notifyFailedRequest(t)}.bind(this);this._queueRemoteRequest(t,i,a,n,e,Ee)},_requestChangeList:function(e,t,i){if(e){r.default.Assert(t,"Must supply a valid entry CB"),r.default.Assert(i,"Must provide a valid done CB");var a=I.a.fns("drive").changes.list.packedFn,n={includeDeleted:!0,includeSubscribed:!0,maxResults:500,startChangeId:+e+1,fields:"items,nextPageToken"},s=function(a){var n=0,s=e;r.default.vmMain.beginUpdateItems();for(var o=0;o<a.items.length;++o){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var l=a.items[o];r.default.Assert(l,"Must have a valid change entry"),r.default.Assert(parseInt(l.id)<1e8,"Must have a valid entry ID"),r.default.Assert(parseInt(l.id)>parseInt(s),"Must be ordered monotonic increasing"),s=l.id,t(l)}r.default.vmMain.commitUpdateItems(),a.nextPageToken?this._requestChangeList(s,t,i):i(!0)}.bind(this),o=function(e){i(!1)}}else a=I.a.fns("drive").changes.list.packedFn,n={includeDeleted:!0,includeSubscribed:!0,maxResults:1,startChangeId:1e8},s=function(e){var a=e.largestChangeId;t({id:a}),i(!0)},o=function(e){i(!1)};this._queueRemoteRequest(a,n,s,o,void 0,Fe)},_createRemoteEntry:function(e){var t={id:e.id,mimeType:e.mimeType,title:e.title,titleLower:e.title.toLowerCase(),alternateLink:e.alternateLink,webContentLink:e.webContentLink,dataUrl:e.dataUrl,fileSize:+e.fileSize,parents:e.parents,modifiedDate:e.modifiedDate?new Date(e.modifiedDate):void 0};if(t.parents)for(var i=0,a=0;a<t.parents.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;this._updateParentsEntry(t.parents[a])}if(e.properties){var n=0;for(a=0;a<e.properties.length;++a){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(e.properties[a].key===f.default.DocFolderTitleProperty){t.title=e.properties[a].value;break}if(e.properties[a].key===f.default.DefaultRootFolderProperty){t.title="Shared Files",t.pinToTop=!0;break}}}return this.isFolder(t)&&(t.items=[]),t},_addRemoteEntry:function(e){var t=this._createRemoteEntry(e);this.cacheData(t.id,t)},createEntryFromLocal:function(e,t){if(this.isFolder(t)&&(t.items=[]),t.titleLower=t.title.toLowerCase(),t.modifiedDate=t.modifiedDate?new Date(t.modifiedDate):void 0,t.isDeleted=t.isDeleted||r.default.isTempId(e),t.parents)for(var i=0,a=0;a<t.parents.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;this._updateParentsEntry(t.parents[a])}return t},_updateParentsEntry:function(e){this._folderCache.getEntry(e.id,function(t){t&&(e.title=t.title)})},isFolder:function(e){return e.mimeType===Ie},_getCompStringForItem:function(e){return e.hasPluginAttachment(this.id)?e.getAttachmentByPlugin(this.id).getTitleString():e.getParsedText()},_isItemPinnedToTop:function(e){return!!e.hasPluginAttachment(this.id)&&e.getAttachmentByPlugin(this.id).getField("pinToTop")},sortFn:function(e,t){return this._isItemPinnedToTop(e)?-1:this._isItemPinnedToTop(t)?1:this._getCompStringForItem(e).localeCompare(this._getCompStringForItem(t))},getAttachmentClass:function(e){var t=["plugin_drive"];return e.hasField("mimeType")?t.push(this.getMimetypeClass(e)):t.push("plugin_drive_unk"),e.hasField("isDeleted")&&e.getField("isDeleted")&&t.push("fileDeleted"),t},getMimetypeClass:function(e){var t=e.getField("mimeType");if(this.isMimetypeImage(t))return e.getField("showInline")?"plugin_drive_image_inline":"plugin_drive_image";switch(t){case Ie:return"plugin_drive_folder";case be:return"plugin_drive_sheet";case Ae:return"plugin_drive_slide";case De:return"plugin_drive_doc";default:return"plugin_drive_unk"}},isMimetypeImage:function(e){switch(e){case Me:case Pe:case Ce:case Le:return!0}},isImage:function(e){var t=this.getMimetypeClass(e);return e.hasField("mimeType")&&("plugin_drive_image"===t||"plugin_drive_image_inline"===t)},googleScopes:function(e){return e||this.getSetting(this.Settings.WriteAccess)?[GScope.DriveFull]:[GScope.DriveMetadataRO]},getDependencies:function(){return[PluginDependency.LocalLoaded,PluginDependency.PremiumSub,PluginDependency.GoogleLogin]},verifyAuthorization:function(e){if(e===j.a.getDefaultEmail()&&this.getSetting(this.Settings.IsEnabled)){var t=[GScope.DriveFull];return this.getSetting(this.Settings.WriteAccess)||t.push(GScope.DriveMetadataRO),t.some(function(t){return j.a.hasLinkedAccessToScope(e,t)})}return!0},isDependencyLoaded:function(e,t){var i=!1;switch(e){case PluginDependency.GoogleLogin:t&&(t.indexOf(GScope.DriveMetadataRO)>=0||t.indexOf(GScope.DriveFull)>=0)&&(i=!0);break;default:i=!0}return i},handleDropEvent:function(e,t){var i=e.dataTransfer?e.dataTransfer.getData("text/uri-list"):void 0,a=r.default.getPaneForElement(e.target);if(i&&i.startsWith(Ue)){var n=i.replace(Ue,""),s=n.indexOf("&"),o=n.substr(0,s);return t(this.getAttachment(o).getEmbedString()),!0}if(e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0){for(var l=0,d=0;d<e.dataTransfer.files.length;++d){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;var u=e.dataTransfer.files[d];this.handleDropFile(u,a,e,t)}return y.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.DriveUpload}),!0}if(e.clipboardData&&e.clipboardData.items&&e.clipboardData.items.length>0){var c=0;for(d=0;d<e.clipboardData.items.length;++d){if(c++>5e3&&__infLoop&&__infLoop(c))throw new RangeError;var h=e.clipboardData.items[d];(u=h?h.getAsFile():void 0)&&(u.customName="Moo.do Upload "+Date.now(),this.handleDropFile(u,a,e,t))}return y.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.DriveUpload}),!0}return!1},highlightItem:function(e){e.highlight()},handleDropFile:function(e,t,i,a){for(var n=0,s=this,o=e.customName||e.name,l=this.findCachedItemsByField("title",o),d=this.getDefaultItemStore(),u=t.type===PaneMode.Task&&this.isMimetypeImage(e.type)&&r.default.settings.showImagesInline()?{showInline:!0}:void 0,c=!1,h=0;h<l.length;++h){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var f=l[h];if(f.fileSize===e.size&&!f.isDeleted){var p=this.getAttachment(f.id,u);if(t&&t.isWriteable&&t.plugin!==this)a(this.getAttachmentEmbedString(p),!1);else if(t&&t.plugin===this){var g=this.getDefaultItemStore();p.forEachItem(g,this.highlightItem)}c=!0;break}}if(!c){var m=r.default.generateTempId();this.cacheData(m,{title:o,titleLower:o.toLowerCase(),mimeType:e.type});var v,_,y=this.getAttachment(m,u),S=t&&t.isWriteable&&t.plugin!==this,w=!1;if(t&&t.isWriteable&&t.plugin!==this)w=!0;else if(i&&this.getSetting(this.Settings.WriteAccess)){var I=i.target;(v=r.default.hasClass(I,"paneContent")?t.getItem():r.default.getItemForElement(I))&&!v.isHeader()&&(v=v.parent())}if(v){if(!v.isRootItem()){var b=v.getAttachmentByPlugin(this.id);r.default.Assert(b,"Drive items must have valid attachments"),_=b.id}}else v=d.getRoot(),_=this.getSetting(this.Settings.DriveRootId);this._upload(e,y,S,t.getPaneDoc(),_,function(){r.default.Assert(!d.hasItem(y.id),"When uploading a new file, should never have duplicated items");var e=d.createItem(y.id,s.getAttachmentEmbedString(y),v.id);v.insertSorted(e,s.sortFn),w&&a(s.getAttachmentEmbedString(y),!0)})}},notifyDropFrom:function(e,t){if(r.default.Assert(e,"Must have a valid item that was dropped"),r.default.Assert(t,"Must have a valid pane the item was dropped on"),!r.default.isDemoMode()){var i=e.getAttachmentByPlugin(this.id),a=t.getPaneDoc();a.shareFile(i.id,function(e,t){e||(this.getSetting(this.Settings.WriteAccess)&&t.code===l.a.HTTPStatusCode.Unauthorized&&this.setSetting(this.Settings.WriteAccess,!1),a.isShared()&&r.default.toasts.pushMessage(MessageID.ShareFailure))}.bind(this)),this.sendEvent("AttachmentDropped")}},notifyDropFromToEdit:function(e,t){if(!r.default.isDemoMode())if(this.getSetting(this.Settings.WriteAccess)){if(e.getAttachmentByPlugin(this.id)){var i=document.createEvent("Event");i.item=e,i.initEvent("cdrop",!0,!0),t.dispatchEvent(i)}this.sendEvent("AttachmentDroppedEdit")}else r.default.toasts.pushMessage(MessageID.NeedDrivePermission)},getAttachUrl:function(e){var t=this.getCacheData(e.id);if(t)return t.webContentLink&&t.webContentLink.replace("export=download","")||t.dataUrl},getAttachDataUrl:function(e){var t=this.getCacheData(e.id);return t&&t.dataUrl},handleTapStart:function(e,t,i,a){return!0},handleTapClick:function(e,t,i,a){var n=this.getAttachment(i);return this.openAttach(n,e,t,!0,a)},openAttach:function(e,t,i,a,n){var s=this.getCacheData(e.id);if(s){if(this.isPluginPane(i)&&this.isFolder(s))r.default.vmMain.zoomin(t),this.sendEvent("Tap_FolderZoom");else{var o=this.createDisplayElement(e).text;r.default.preventDefault(n),r.default.preventClick(),r.default.menus.openMenuExternalApp(o,function(){s.alternateLink?r.default.openUrl(s.alternateLink,n):s.id?r.default.openUrl(this._createDriveURL(s.id,s.mimeType),n):r.default.toasts.pushMessage({text:"Your file is still uploading, please try again in a minute.",action:MessageAction.Okay})}.bind(this)),this.sendEvent("Tap_OpenFileMobile")}return!0}return!1},createFolderURL:function(e){return"https://drive.google.com/drive/folders/"+e},_createDriveURL:function(e,t){var i="https://docs.google.com/";switch(t){case Ie:return i+"folderview?id="+e+"&usp=drivesdk";case be:return i+"spreadsheets/d/"+e+"/edit?usp=drivesdk";case De:return i+"document/d/"+e+"/edit?usp=drivesdk";case Ae:return i+"presentation/d/"+e+"/edit?usp=drivesdk";default:return i+"file/d/"+e+"/edit?usp=drivesdk"}},compactCacheField:function(e,t){var i;switch(t){case"alternateLink":e[t]!==this._createDriveURL(e.id,e.mimeType)&&(i=e[t]);break;default:i=e[t]}return i},supportOfflineCache:function(){return!0},usesPreviewCache:function(){return!0},matchAttachment:function(e,t){return e.getField("titleLower").indexOf(t)>=0},getBlockedText:function(e){return"Go Premium to view Drive files"},onDocumentShared:function(e){this.getSetting(this.Settings.WriteAccess)?e&&this._ensureAttachmentsAreShared():this.numActiveAttachments()>0&&r.default.toasts.pushMessage(MessageID.NoSharingWarning)},_ensureAttachmentsAreShared:function(){var e=r.default.vmMain.docManager.getOpenDoc();this.forEachActiveAttachment(function(t){e.shareFile(t.id,function(e){0})})},notifyAttachmentUnused:function(e,t){(this._super.notifyAttachmentUnused.call(this,e,t),r.default.isDemoMode())||r.default.vmMain.docManager.getOpenDoc().unshareFile(e.id,function(e){0})},_upload:function(e,t,i,a,n,s){var o=this;e.size>20971520?(r.default.toasts.pushMessage(MessageID.WarnLargeFile),this.sendEvent("Upload_Large")):this.sendEvent("Upload");var l=this.isMimetypeImage(e.type)&&r.default.settings.showImagesInline();if(l){var d=new FileReader;d.onload=function(e){var i=o.getCacheData(t.id);i.dataUrl=e.target.result,o.cacheData(t.id,i),s(e)},d.readAsDataURL(e)}var u=new FileReader;u.readAsBinaryString(e),u.onload=function(s){var l=e.type||we;r.default.Assert(a,"Must supply a valid paneDoc if uploading a file"),a.getDocumentFolder(function(a){!function(a){var s={title:e.customName||e.name,mimeType:l,parents:n?[{id:n}]:[]};i&&a&&s.parents.push({id:a});var r=btoa(u.result),d=He+"Content-Type: application/json\r\n\r\n"+JSON.stringify(s)+He+"Content-Type: "+l+"\r\nContent-Transfer-Encoding: base64\r\n\r\n"+r+"\r\n---------314159265358979323846--";gapi.client.request({path:"/upload/drive/v2/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+Ve+'"'},body:d}).execute(function(e){o.changeID(t,t.id,e.id);var i=o.getAttachDataUrl(t);i&&(e.dataUrl=i),o._addRemoteEntry(e)})}(a)})},l||s()},scheduleFile:function(e,t){y.a.beginAction();var i=e.getAttachmentByPlugin(this.id);r.default.Assert(i,"Must be able to get a valid attachment from item");var a=l.a.MSPerHour,n=r.default.vmMain.getDefaultCalendarPlugin();if(n){var o=n.getDefaultExportCalendarID();if(o&&(r.default.isDemoMode()||n.getSetting(n.Settings.WriteAccess))){var d=i.getField("title"),u=this._createDriveURL(i.id,i.getField("mimeType"));n.createEventForEmail(o,d,u,t,a,function(e,t,i,a){e||t?t||r.default.toasts.pushMessage({text:"There was an error adding the file to your Google Calendar.",action:MessageAction.Okay}):r.default.toasts.pushMessage({text:"There was an error adding the file to your Google Calendar, and it was not saved locally.",actionText:"LEARN MORE",action:function(){s.default.overQuota?r.default.toasts.pushMessage({text:"You are offline and your computer's storage quota has been exceeded. Please free up space on your device. Please contact support@moo.do if you have questions.",action:MessageAction.Okay}):r.default.toasts.pushMessage({text:"You are offline and we were unable to save your event information to your device. Please contact support@moo.do if you have questions.",action:MessageAction.Okay})}})})}else r.default.toasts.pushMessage({text:"You must select an export calendar to enable scheduling and editing of events.",action:MessageAction.OpenCalendarSettings})}else r.default.toasts.pushMessage({text:"The Google Calendar plugin must be enabled to schedule files.",action:MessageAction.OpenSettings});y.a.endAction()},findMatchExact:function(e){},findMatchLike:function(e,t){var i=e.toLowerCase(),a=this.findCachedItemsByFn(function(e){return e.titleLower.indexOf(i)>=0},t);return a.sort(function(e,t){return e.modifiedDate&&t.modifiedDate?Date.compare(e.modifiedDate,t.modifiedDate):e.modifiedDate?-1:t.modifiedDate?1:e.titleLower.localeCompare(t.titleLower)}),a},getAttachmentEmbedString:function(e){return this._super.getAttachmentEmbedString.call(this,e,e.getField("showInline")?"showInline:true":void 0)},getAttachWidth:function(e){return e.hasField("imageWidth")&&e.getField("imageWidth")?+e.getField("imageWidth"):void 0},setAttachWidth:function(e,t){e.updateField("imageWidth",t,!0)},setShowInline:function(e,t){e.updateField("showInline",t,!0)}};o.a.inherit(pe,Se),o.a.extend(Se.prototype,qe);var ze=Se,We=i(14),Ge="Gmail";function je(){if(this._isBuiltin=!0,this._super.constructor.call(this,PluginID.Mailbird,"Mailbird"),this.declareProperty("subject",PluginLoad.Preview|PluginLoad.Full,!1,""),this.declareProperty("from",PluginLoad.Preview|PluginLoad.Full,!1,""),this.declareProperty("date",PluginLoad.Preview|PluginLoad.Full,!0,new Date),this.declareProperty("subjectLower",PluginLoad.Runtime,!1,""),this.declareProperty("fromLower",PluginLoad.Runtime,!1,""),this.declareProperty("unread",PluginLoad.Runtime,!0,!1),this.declareProperty("snippet",PluginLoad.Runtime,!0,""),this.declareProperty("count",PluginLoad.Runtime,!0,1),this.declareProperty("latestMessageAt",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("provider",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("threadID",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("hasAttachments",PluginLoad.Full,!0,!1),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.Measure,PluginRenderers.EmailThread),this.isMailbirdEmbed=p.a.embed===EmbedApps.Mailbird,this.isMailbirdEmbed){this.setSetting(this.Settings.IsEnabled,!0),r.default.nativeBridge.registerEmbedBridge(this);var e=r.default.nativeBridge.registerInboundAPI("mailbird");r.default.Assert(e,"Error creating native inbound API for mailbird"),e&&(e.registerVariable("_prevX"),e.registerVariable("_prevY"),e.registerFunction("dragOver",Ke.dragOver,!0),e.registerFunction("drop",Ke.drop,!0),e.registerFunction("dragLeave",Ke.dragLeave,!0),e.registerFunction("reportError",Ke.reportError,!0)),this._mailbirdOutAPI=r.default.nativeBridge.registerOutboundAPI("mailbird"),r.default.Assert(this._mailbirdOutAPI,"Error creating native outbound API for mailbird"),this._mailbirdOutAPI&&(this._mailbirdOutAPI.requireFunction("selectConversation"),this._mailbirdOutAPI.requireFunction("selectConversationEx",!0),this._mailbirdOutAPI.requireFunction("scheduleNotifications",!0))}}var Ke={dragOver:function(e){var t=r.default.elementFromPoint(e.x,e.y);if(t){var i=void 0!==this._prevX?e.x-this._prevX:0,a=void 0!==this._prevY?e.y-this._prevY:0;this._prevX=e.x,this._prevY=e.y;var n={clientX:e.x,clientY:e.y,diffX:i,diffY:a,target:t,dataTransfer:{}};We.default.handleDragOver(n)}},drop:function(e){var t=r.default.elementFromPoint(e.x,e.y);var i={clientX:e.x,clientY:e.y,target:t,dataTransfer:{getData:function(t){if("mailbird/email"===t){var i={subject:e.subject||"",from:e.from||"",id:e.mailMessageId?e.mailMessageId:"mailbird_"+e.id,latestMessageAt:e.latestMessageAt};return e.gmailID&&(i.provider="Gmail",i.threadID=e.gmailID),i}}},preventDefault:r.default.emptyFn,stopPropagation:r.default.emptyFn};setTimeout(function(){We.default.handleDrop(i)},0)},dragLeave:function(){We.default.handleDragLeave({target:document.getElementById("container")})},reportError:function(e){r.default.reportError(new Error(e))}},Ye={getPaneIcon:function(){return"icon-envelope"},useItemStore:function(){return"Mailbird"},_addRemoteEntry:function(e){var t={id:e.id,provider:e.provider,threadID:e.threadID,subject:e.subject,subjectLower:e.subject.toLowerCase(),from:e.from,fromLower:e.from.toLowerCase(),latestMessageAt:e.latestMessageAt};return this.cacheData(t.id,t),t},createEntryFromLocal:function(e,t){return t.subjectLower=t.subject.toLowerCase(),t.fromLower=t.from.toLowerCase(),t},getAttachmentClass:function(e){return["plugin_mailbird"]},isPluginBlocked:function(){return!1},handleEmbedMessage:function(e,t){switch(e){case"scheduledItems":if(this._mailbirdOutAPI.hasOptionalFunction("scheduleNotifications"))try{var i=JSON.stringify(t);this._mailbirdOutAPI.call("scheduleNotifications",i)}catch(e){r.default.reportError(e)}break;default:r.default.Assert(!1,"Unknown embed message: "+e)}},handleDropEvent:function(e,t){if(r.default.Assert(t,"Must provide a valid callback to the drop event"),e.dataTransfer){var i=e.dataTransfer.getData("mailbird/email");if(i){var a=this._addRemoteEntry(i);t(this._getTextForItem(a));var n=this.getAttachment(a.id);return r.default.Assert(n.isLoaded(),"Mailbird attachments must always be loaded after creation"),this.writeAttachmentToPreviewCache(n),!0}}return!1},handleTapStart:function(e,t,i,a){return!0},handleTapClick:function(e,t,i,a){var n=this.getCacheData(i);if(n){if(this.isMailbirdEmbed){var s;if(!n.id.startsWith("mailbird_")&&this._mailbirdOutAPI.hasOptionalFunction("selectConversationEx")){var o=null;"Gmail"===n.provider&&(r.default.Assert(n.threadID,"Must provide a valid Gmail ID if it is defined as the provider"),o=parseInt(n.threadID));i=n.id;s=this._mailbirdOutAPI.call("selectConversationEx",o,i,n.latestMessageAt)}else{i=n.id.replace("mailbird_","");s=this._mailbirdOutAPI.call("selectConversation",i)}r.default.Assert(void 0!==s,"Must always receive a value back from Mailbird"),!0===s||!1===s?r.default.Assert(s,"Must have successfully selected the email conversation in Mailbird: ",n.id,n.provider):(r.default.Assert(s&&s.then,"Must have a valid promise object returned"),s.then(function(e){r.default.Assert(e,"Must have successfully selected the email conversation in Mailbird: ",n.id,n.provider)},function(e){r.default.Assert(!1,"Failed to successfully select the email conversation in Mailbird: ",n.id,n.provider)}))}else switch(n.provider){case Ge:r.default.openUrl("https://mail.google.com/mail/u/0/#inbox/"+n.threadID);break;default:r.default.toasts.pushMessage(MessageID.MailbirdClick)}return!0}return!1},getDisplayTags:function(e){return[]},getDisplayParticipants:function(e){return""},matchAttachment:function(e,t){return e.getField("fromLower").indexOf(t)>=0||e.getField("subjectLower").indexOf(t)>=0},findMatchExact:function(e){},findMatchLike:function(e,t){var i=e.toLowerCase();return this.findCachedItemsByFn(function(e){return e.subjectLower.indexOf(i)>=0||e.fromLower.indexOf(i)>=0},t)},supportOfflineCache:function(){return!0},usesPreviewCache:function(){return!0}};o.a.inherit(pe,je),o.a.extend(je.prototype,Ye);var Xe=je;function Qe(e){this._maxSize=e,this._groups=[],this._groupID=0,this._cursor=-1,this._performingActions=!1,this._actionsPreventUndo=!1,this._aggregateActions=0,this._currentAction=[],this._registeredOwners={},this._registeredActions={}}Qe.prototype={registerOwner:function(e,t){r.default.Assert(e,"Must supply a valid owner object"),r.default.Assert(!this._registeredOwners[t],"Must not double define an owner"),this._registeredOwners[t]=e,this._registeredActions[t]={}},registerAction:function(e,t,i){r.default.Assert(e,"Must provide a valid owner"),r.default.Assert(t,"Must provide a valid action ID"),r.default.Assert(this._registeredOwners[e],"Must have already registered a valid owner"),r.default.Assert(!this._registeredActions[e][t],"Must not double define an action for an owner"),r.default.Assert(i,"Must pass in a valid undo/redo descriptor"),r.default.Assert(r.default.isFunction(i.undo),"Must provide a valid undo fn"),r.default.Assert(r.default.isFunction(i.redo),"Must provide a valid redo fn"),this._registeredActions[e][t]=i},_getOwner:function(e){return r.default.Assert(this._registeredOwners[e.ownerID],"Must have previously registered owner"),this._registeredOwners[e.ownerID]},_getActionData:function(e){return r.default.Assert(this._registeredOwners[e.ownerID],"Must have previously registered owner"),r.default.Assert(this._registeredActions[e.ownerID][e.actionID],"Must have previously registered action for owner"),this._registeredActions[e.ownerID][e.actionID]},_useNextGroupID:function(){return++this._groupID},_getCurrentGroup:function(){return this._groups[this._cursor]},_createGroup:function(e){return{id:this._useNextGroupID(),events:e||[]}},_pushNewGroup:function(e){var t=this._createGroup(e);this._groups.length>this._cursor+1&&(this._groups=this._groups.slice(0,this._cursor+1)),this._groups.push(t),this._cursor<this._maxSize-1&&this._cursor++,this._groups.length>this._maxSize&&this._trimAction()},_trimAction:function(){this._groups.shift()},isUndoableAction:function(){return!this._actionsPreventUndo},beginAction:function(e){0===this._aggregateActions&&(r.default.Assert(0===this._currentAction.length,"Current actions should be flushed"),this._actionsPreventUndo=!!e),this._aggregateActions++},runAction:function(e,t,i){var a={ownerID:e,actionID:t},n=this._getOwner(a);return this._getActionData(a).redo.apply(n,i)},performAction:function(e,t,i){r.default.Assert(this._aggregateActions>0,"Must be in a begin/end action block"),r.default.Assert(i,"Must provide valid data for the action"),this._currentAction.push({ownerID:e,actionID:t,data:i})},performActions:function(e){if(e&&e.length>0){var t=0;this.beginAction();for(var i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=e[i];this.performAction(a.ownerID,a.actionID,a.data)}this.endAction()}},endAction:function(){1===this._aggregateActions&&(this._currentAction.length>0&&(this._pushNewGroup(this._currentAction),this._currentAction=[]),this._actionsPreventUndo=!1),this._aggregateActions=Math.max(0,this._aggregateActions-1)},undoAction:function(){if(this._cursor>=0)for(var e=0,t=this._groups[this._cursor--],i=t.events.length-1;i>=0;i--){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var a=t.events[i],n=this._getOwner(a);this._getActionData(a).undo.apply(n,a.data.undoParams)}},redoAction:function(){if(this._cursor>=-1&&this._cursor<this._groups.length-1)for(var e=0,t=this._groups[++this._cursor],i=0;i<t.events.length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var a=t.events[i],n=this._getOwner(a);this._getActionData(a).redo.apply(n,a.data.redoParams)}}};var Je=Qe;function Ze(e,t,i,a,n,s){r.default.Assert(e,"Must specify a valid account ID"),r.default.Assert(t,"Must specify a valid label ID"),r.default.Assert(!a||r.default.isDateValid(a),"Must provide a valid oldestSync date"),r.default.Assert(s,"Must supply a valid label store this label belongs to"),this._labelStore=s,this._accountID=e,this._labelID=t,this._fullName=i,this._minName=void 0,this._matchName=i?i.toUpperCase():void 0,this._oldestSync=a,this._numUnread=0,this._ancestors=[],this._isDeleted=!(!n||!n.isDeleted),this._labelListVisibility=n&&n.labelListVisibility?n.labelListVisibility:l.a.LabelListVisibility.Show,this._messageListVisibility=n&&n.messageListVisibility?n.messageListVisibility:l.a.MessageListVisibility.Show,this._origLabelID=void 0}var $e={INBOX:"Inbox",SPAM:"Spam",TRASH:"Trash",UNREAD:"Unread",STARRED:"Starred",IMPORTANT:"Important",SENT:"Sent Mail",DRAFT:"Draft",CHAT:"Chat",CATEGORY_PERSONAL:"Primary",CATEGORY_SOCIAL:"Social",CATEGORY_PROMOTIONS:"Promotions",CATEGORY_UPDATES:"Updates",CATEGORY_FORUMS:"Forums"},et={INBOX:100,UNREAD:99,STARRED:98,IMPORTANT:97,SENT:96,DRAFT:95,"==MOODO_ARCHIVED==":94,"==MOODO_ALLMAIL==":93,TRASH:92,CATEGORY_PERSONAL:80,CATEGORY_SOCIAL:79,CATEGORY_PROMOTIONS:78,CATEGORY_UPDATES:77,CATEGORY_FORUMS:76},tt={"==MOODO_ARCHIVED==":"Archived","==MOODO_ALLMAIL==":"All Mail"},it={CATEGORY_PERSONAL:!0,CATEGORY_SOCIAL:!0,CATEGORY_PROMOTIONS:!0,CATEGORY_UPDATES:!0,CATEGORY_FORUMS:!0},at={DRAFT:!0,CHAT:!0,SENT:!0,SPAM:!0,"==MOODO_ALLMAIL==":!0};Ze.prototype={_getDisplayPriority:function(){return et[this.getLabelID()]||-1},displayCompare:function(e){var t=this.isSystemOrSpecialLabel(),i=e.isSystemOrSpecialLabel();return t&&i?this._getDisplayPriority()<e._getDisplayPriority()?1:-1:t?-1:i?1:this.getName().localeCompare(e.getName())},isDropTarget:function(){return!at[this.getLabelID()]},_getStoreLabel:function(e){var t,i=e.toUpperCase();for(var a in this._labelStore){var n=this._labelStore[a].getRawName();if(n&&n.toUpperCase()===i){t=this._labelStore[a];break}}return t},_computeAncestors:function(){if(r.default.Assert(this._fullName||this.isSystemLabel()||this.isSpecialLabel(),"Must specify a valid fullName to run _computeAncestors"),this._ancestors=[],!this.isSystemLabel()&&!this.isSpecialLabel()&&this._fullName&&this._fullName.indexOf("/")>0){for(var e=0,t=this._fullName.split("/"),i="",a=0;a<t.length-1;++a){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;i+=t[a];var n=this._getStoreLabel(i);n&&n!==this&&this._ancestors.push(n),i+="/"}this._computeMinName()}r.default.Assert(this._ancestors.indexOf(this)<0,"Self should never be in the ancestors list")},_computeMinName:function(){for(var e=0,t=this.getRawName(),i=0;i<this._ancestors.length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var a=this._ancestors[i].getMinName()+"/",n=t.indexOf(a);t=t.substr(n+a.length)}this._minName=t},getAccountID:function(){return this._accountID},getLabelID:function(){return this._labelID},getRawName:function(){return this._fullName},getMinName:function(){return this._minName?this._minName:this._fullName},getMatchName:function(){return this._matchName},isMatched:function(e){r.default.Assert(r.default.isString(e),"Must pass in a valid string for label name");var t=!1,i=this.getMatchName();return e&&i&&i.indexOf(e.toUpperCase())>=0&&(t=!0),t},isNamed:function(e){r.default.Assert(r.default.isString(e),"Must pass in a valid string for label name");var t=!1,i=this.getMatchName();return e&&i&&i===e.toUpperCase()&&(t=!0),t},getName:function(e){var t;return $e[this.getLabelID()]?t=$e[this.getLabelID()]:tt[this.getLabelID()]?t=tt[this.getLabelID()]:e&&this._minName?t=this.getMinName():this._fullName?t=this._fullName:(r.default.Assert(!this.isLocalOnly(),"Should not have a local-only label without a name"),t=this.getLabelID()),t||""},hasName:function(){return $e[this.getLabelID()]||tt[this.getLabelID()]||!!this._fullName},clearOldestSync:function(){this._oldestSync=void 0},getOldestSync:function(){return this._oldestSync},setOldestSync:function(e){r.default.Assert(r.default.isDateValid(e),"Must provide a valid oldestSync date"),this._oldestSync=e},getMessageListVisibility:function(){return this._messageListVisibility},getLabelListVisibility:function(){return this._labelListVisibility},isLocalOnly:function(){return r.default.isTempId(this.getLabelID())},updateLabelID:function(e){r.default.Assert(this.isLocalOnly(),"Should only ever modify local labels"),this._origLabelID=this.getLabelID(),this._labelID=e},updateLabelName:function(e){this._fullName=e,this._matchName=e.toUpperCase(),this._computeAncestors()},getSaveData:function(){return{id:this.getLabelID(),name:this._fullName,oldestSync:this.getOldestSync(),messageListvisibility:this.getMessageListVisibility(),labelListVisibility:this.getLabelListVisibility(),isDeleted:this._isDeleted}},getDisplayText:function(e){var t;return this.getName()&&(t=this.getName().startsWith("Moo.do/")?this.getName().substr("Moo.do".length+1):this.getName(e)),t},getOutlineText:function(){var e=this.getDisplayText();return e?e.replace(/ /g,"_"):void 0},matchesText:function(e){return this.getDisplayText().toLowerCase().indexOf(e)>=0},hasAncestors:function(){return!!this._fullName&&this.getAncestors().length>0},getAncestors:function(){return this._computeAncestors(),this._ancestors},getParent:function(){var e=this.getAncestors();return e[e.length-1]},isSystemLabel:function(){return!!$e[this.getLabelID()]},isSpecialLabel:function(){return!!tt[this.getLabelID()]},isSystemOrSpecialLabel:function(){return this.isSystemLabel()||this.isSpecialLabel()},isCategoryLabel:function(){return!!it[this.getLabelID()]},isArchived:function(){return"Archived"===this.getName()},isStarred:function(){return"Starred"===this.getName()},isInbox:function(){return"Inbox"===this.getName()},isDraft:function(){return"Draft"===this.getName()},isTrash:function(){return"Trash"===this.getName()},isCustom:function(){return!this.isSystemLabel()&&!this.isSpecialLabel()},getUnreadCount:function(){return this._numUnread},shouldDisplayInLabelList:function(){var e=!1;return this._isDeleted||(this.getLabelListVisibility()===l.a.LabelListVisibility.Show?e=!0:this.getLabelListVisibility()===l.a.LabelListVisibility.ShowIfUnread&&this.getUnreadCount()>0&&(e=!0)),e},shouldDisplayInMessageList:function(){return this._messageListVisibility===l.a.MessageListVisibility.Show},delete:function(){r.default.Assert(!this.isSystemOrSpecialLabel(),"Should never delete a special or system label"),this._isDeleted=!0}};var nt=Ze,st=i(39);function rt(e){this._plugin=e,this._headers=[],this._mimeTree=void 0}var ot=0;rt.prototype={reset:function(){this._headers=[],this._mimeTree=void 0},getMessageText:function(e,t){return e.decoded},updateFromDraft:function(e,t,i,a,n,s){var o,l;if(this.reset(),this.addHeader("From",this._plugin._formatAddressText(i,a,!0)),this.addHeader("To",this._plugin._createAddressTextFromTokens(t.to,!0)),t.cc&&this.addHeader("Cc",this._plugin._createAddressTextFromTokens(t.cc,!0)),t.bcc&&this.addHeader("Bcc",this._plugin._createAddressTextFromTokens(t.bcc,!0)),this.addHeader("X-Mailer","Moo.do (https://moo.do)"),this.addHeader("Subject",r.default.encodeMIMEHeader(t.subject||"(no subject)")),t.inReplyTo){this.addHeader("In-Reply-To",t.inReplyTo.trim());var d=e.messages.indexOfWithProperty("messageID",t.inReplyTo);r.default.Assert(d>=0,"Must always be able to find the message being replied to"),o=e.messages[d]}t.references?l=t.references:o&&(l=(r.default.isTempId(o.messageID)?"":o.messageID)+(o.references?" "+o.references:"")),l&&this.addHeader("References",l.trim());var u,c=st.a.generatePlaintext(this.getMessageText(t,n),{}),h=this._getAttachedResources(t);if(h.length>0&&(u=this.createMimePart("multipart/mixed"),this.addMimePart(u)),c){var f=this.createMimePart("multipart/alternative");this.addMimePart(f,u);var p=this.createMimePart("text/plain",c,"7bit");this.addMimePart(p,f);var g=this._getInlineResources(t);if(g.length>0){var m=0,v=this.createMimePart("multipart/related");this.addMimePart(v,f);var _=this.createMimePart("text/html",this.getMessageText(t,n),"7bit");this.addMimePart(_,v);for(var y=0;y<g.length;++y){if(m++>5e3&&__infLoop&&__infLoop(m))throw new RangeError;var S=g[y],w=this.createResourcePart(S);w&&this.addMimePart(w,v)}}else{_=this.createMimePart("text/html",this.getMessageText(t,n),"7bit");this.addMimePart(_,f)}}else{f=this.createMimePart(t.contentType||"text/html",this.getMessageText(t,n),"7bit");this.addMimePart(f,u)}if(u&&n){var I=0,b=0,A=function(){if(++b===h.length){for(var e=0,t=0;t<h.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=h[t],a=this.createResourcePart(i);a&&this.addMimePart(a,u)}s()}}.bind(this);for(y=0;y<h.length;++y){if(I++>5e3&&__infLoop&&__infLoop(I))throw new RangeError;this._plugin.loadResource(e.id,t.id,h[y].cid,A)}}else setTimeout(s,0)},_getInlineResources:function(e){var t=[];return e.resources.forEachResource(function(e){"inline"===e.disposition&&t.push(e)}),t},_getAttachedResources:function(e){var t=[];return e.resources.forEachResource(function(e){"attachment"===e.disposition&&e.id&&t.push(e)}),t},addHeader:function(e,t){r.default.Assert(t.indexOf("\n")<0,"Header should not have a newline: "+e);var i=t.trim().replace(/[\r\n]/g,"");this._headers.push(e+": "+i)},_generateBoundary:function(){return"=========3141592653589moodo"+Date.now()+ ++ot},createMimePart:function(e,t,i,a){return r.default.Assert(e,"Must supply a valid content type"),r.default.Assert(void 0===t||i,"Must supply a valid content encoding"),{boundary:this._generateBoundary(),contentType:e,content:t,contentEncoding:i,contentDisposition:a,children:[]}},createResourcePart:function(e){var t;if(r.default.Assert(e&&e.data,"Must have valid data loaded for resource to embed it in message"),e&&e.data){var i=e.mimeType+'; name="'+e.cid+'"',a=e.disposition+'; filename="'+e.cid+'"';(t=this.createMimePart(i,e.data,e.contentEncoding,a)).contentID=e.cid}return t},addMimePart:function(e,t){r.default.Assert(e,"Must supply a valid mime part"),t?t.children.push(e):(r.default.Assert(!this._mimeTree,"Must not yet have a valid mime tree root"),this._mimeTree=e)},_mimePartToBlob:function(e){var t="\r\n",i=[];function a(e,t){if(t){r.default.Assert(t.indexOf("\n")<0,"Header should not have a newline: "+e);var a=t.trim().replace(/[\r\n]/g,"");i.push(e+": "+a)}}var n=e.contentType;(e.content||(n+='; boundary="'+e.boundary+'"'),a("MIME-Version","1.0"),a("Content-Type",n),a("Content-Transfer-Encoding",e.contentEncoding),a("Content-Disposition",e.contentDisposition),e.contentID)&&a("Content-ID","<"+e.contentID+">");if(t=i.join("\r\n").trim(),t+="\r\n",e.content)t+="\r\n"+e.content+"\r\n";else if(e.children&&e.children.length>0){for(var s=0,o=0;o<e.children.length;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;t+="\r\n--"+e.boundary+"\r\n",t+=this._mimePartToBlob(e.children[o])}t+="--"+e.boundary+"--\r\n"}else t+="\r\n(no text)\r\n";return t},generateBlob:function(){var e=this._headers.join("\r\n").trim();return e+="\r\n"+this._mimePartToBlob(this._mimeTree)}};var lt=rt,dt=i(42),ut=i(22),ct=i(17),ht=i(31).default;function ft(e){this.isInitializing=!0,this.plugin=r.default.vmMain.pluginManager.getPlugin(PluginID.Gmail),this._lines=[{text:" ",start:0,length:1,width:0}],this.searchFilters=[{name:"unread",initialValue:1,icon:"icon-drafts",tooltip:"unread emails",remoteStringFn:this._remoteFnEmailUnread.bind(this),matchFn:this._matchFnEmailUnread.bind(this)},{name:"starred",initialValue:1,icon:"icon-star",tooltip:"starred emails",remoteStringFn:this._remoteFnStarred.bind(this),matchFn:this._matchFnStarred.bind(this)},{name:"priority",remoteStringFn:this._remoteFnPriority.bind(this),matchFn:this._matchFnPriority.bind(this)},{name:"category",remoteStringFn:this._remoteFnCategory.bind(this),matchFn:this._matchFnCategory.bind(this)}],this.type=this.plugin._paneType,this.title="Email",this.paneClass="panePlugin paneGmail",this.contextMenuMode=l.a.ContextMenuMode.Gmail,this.paneEmptyMessage="No emails here",this.paneEmptySearchMessageDefault="Press enter to search",this.paneEmptySearchMessage=this.paneEmptySearchMessageDefault,this.titleContextMenuHeader="Open label",this.dropEffect=function(){return l.a.DropEffect.Copy},this.isWriteable=!1,this.overrideCopyBehavior=!1,this.supportCollapsing=!1,this.supportCompleting=!0,this.supportCheckbox=!0,this.supportOffline=!1,this.supportPerformArchive=!1,this.supportDataRefresh=!0,this.supportReportError=!0,this.supportCompose=!0,this.supportPagination=!0,this.supportVertLines=!1,this.supportSearchItemAutocomplete=!1,this.supportSearchListenTextChanges=!1,this.supportSearchFlat=!1,this.supportLocalSearch=!1,this.supportClone=!1,this.supportDeferredItemLoad=!0,this.supportCellTransition=!1,this.useLineCache=!1,this.shouldSearchMatchParents=!1,this.noOverviewStyle=!0,this.supportStarClick=!0,this.supportClickOverviewScroll=!1,this.shouldUpdateOnTextChanged=!1,this.overviewTracksScroll=!1,this.overviewHasPaneItems=!1,this.overviewPadLevels=-1,this.showRootOnRow2=!0,this.maxWidthFlex=l.a.ExpandedPaneWidth,this.maxWidth=l.a.ExpandedPaneWidth+200,this.maxWidthSingle=l.a.ExpandedPaneWidth,this.widthBiggerInSingle=!1,this._topBoxHeight=0,this._super.constructor.call(this,e),this.dragMarginTop=25,this.blocks=[],this.blocksByKey={},this._focusedTrash=!1,this.shouldCheckHeight=!0,this.maxScrollOffset=0,this.selectedIndex=new w.a(-1,this.onSelectedIndexChanged.bind(this)),this._isSearchingRemote=new w.a(!1),this._overviewAccount=new w.a,this._currentSearch=void 0,this._ignoreRestoreScroll=!0,this._failedPageRequest=new w.a(!1),this.viewState=new w.a(e.viewState&&e.viewState.viewMode?e.viewState:{viewMode:l.a.GmailViewMode.Date}),this.item.listen(this._onItemChange.bind(this)),this.viewState.listen(this._onViewStateChange.bind(this)),o.a.binder(this,"onScroll","_runRemoteSearch","searchCompare","onTopTextChanged","headerSearchCompare","onMultiselectReset","changeView","openViewMenu","onEmailComposeClosed","onEmailPreviewClosed"),this.initGmail(),this._firstSelectedItem=void 0,this.isInitializing=void 0}var pt={initGmail:function(){ct.a.listen("reset",this.onMultiselectReset),this.search.isSearched()&&this.onSearchChanged(!0),this._onItemChange(this.getItem()),this._searchTimeout=void 0,this._lastSearchValue=void 0,this._lastSearchTime=0,this.paneTopText.listen(this.onTopTextChanged),g.a.listen("EmailCompose","onClosed",this.onEmailComposeClosed),g.a.listen("EmailPreview","onClosed",this.onEmailPreviewClosed)},destroy:function(){clearTimeout(this._searchTimeout),this._searchTimeout=void 0,this.paneTopText.unlisten(this.onTopTextChanged),g.a.unlisten("EmailCompose","onClosed",this.onEmailComposeClosed),g.a.unlisten("EmailPreview","onClosed",this.onEmailPreviewClosed),ct.a.unlisten("reset",this.onMultiselectReset),this._super.destroy.call(this)},onLoad:function(e){this._super.onLoad.call(this,e),this.addScrollListener(this.onScroll)},notifyPluginLoaded:function(){var e=this.deferredItemState;if(e){var t=this.getItemStore().getItem(e.itemID);t&&this.setItem(t,!0)}},getItemStore:function(){return this.plugin.getActiveItemStore(this.id)},getRootItem:function(){var e=this.getItemStore();return e?e.getRoot():void 0},getDefaultDisplayItem:function(e){return this.plugin.getDefaultDisplayItem(e)},searchCompare:function(e){var t=!1;return r.default.vmMain.isOnline()?(!this.isSearched()||!this.isLoading.get()&&this.paneTopText.get()||this.isRemoteSearchActive())&&this.plugin.isDisplayItem(e,this._focusedTrash)&&(t=!0):this.search.isMatched(e,!1)&&this.plugin.isDisplayItem(e,this._focusedTrash)&&(t=!0),t},runItemSearch:function(e){return r.default.Assert(e,"Must supply a valid param set for local item search"),r.default.Assert(e.item,"Gmail pane always expects a valid item when running local item search"),e.item.belongsToItemStore(this.plugin.getDefaultItemStore())?this.plugin.runLocalItemSearch(e):this._super.runItemSearch.call(this,e)},getItemSearchParams:function(){var e=this.plugin.getLabelForVMLI(this.getItem());return this._focusedTrash=e&&e.isTrash(),{item:this.getItem(),comparator:this.searchCompare,pane:this}},setOverviewAccount:function(e){this._overviewAccount.set(e),this.updateHeaders(!0)},headerSearchCompare:function(e){if(this.plugin.isLabelItem(e)){var t=this.plugin.getLabelForVMLI(e);return!t||t.shouldDisplayInLabelList()}return!!this.plugin.isAccountItem(e)},getHeaderSearchParams:function(){return{item:this.plugin.getDefaultItemStore().getRoot(),comparator:this.headerSearchCompare,noCollapsed:!0,collapseAfterDepth:this.plugin.numSyncAccounts()>1?1:NaN,overview:!0,pane:this}},saveSelection:function(){return ct.a.getSelectedItems(this)},restoreSelection:function(e){if(e.length>0){for(var t=0,i=[],a=0;a<e.length;a++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;(n=this.indexOfItem(e[a]))>=0&&i.push(n)}if(i.length>1)this.selectedIndex.set(i[0],!1),ct.a.setSelected(i,this);else if(1===i.length)this.selectIndex(i[0]);else{var n;(n=this.selectedIndex.get())>=this.numItems()&&(n=this.numItems()-1),this.selectIndex(n,!0)}}},_setItems:function(e,t){for(var i,a=0,n=this.saveSelection(),s=[],r={},o=this.getViewMode()===l.a.GmailViewMode.Date?this.plugin.threadSortFn:this.plugin.threadSortPriorityFn,d=0;d<e.length;++d){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var u=e[d],c=this.plugin._getThreadIDFromItem(u);c&&!r[c]&&(s.insertSorted(u,o),this._firstSelectedItem&&u.id===this._firstSelectedItem&&(i=u),r[c]=!0)}if(this.updateOutline(s),this.restoreSelection(n),i&&e.length>0){var h=this.indexOfItem(i);h>=0&&(this.selectIndex(h),requestAnimationFrame(function(){this.setScrollOffset(this.getScrollTop(),ScrollDuration.Snap)}.bind(this))),this._firstSelectedItem=void 0}},setHeaders:function(e,t){var i=0;if(!this._overviewAccount.get()){var a=this.plugin.getDescriptorForItem(this.getItem());this._overviewAccount.set(a.accountID)}this._allHeaders=e;for(var n=[],s={},o={},l=0;l<this._allHeaders.length;++l){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var d,u=this._allHeaders[l];if(s[d=this.plugin._getAccountIDFromItem(u)]||(s[d]=[]),this.plugin.isAccountItem(u))o[d]=u;else{var c=s[d];this.plugin.isDisplayHeader(u)&&c.insertSorted(u,this.plugin.labelVMLISortFn)}}var h=s[this._overviewAccount.get()];if(h){var f=o[d];if(r.default.Assert(f,"Must have valid account item"),f){var p=0;for(l=0;l<h.length;++l){if(p++>5e3&&__infLoop&&__infLoop(p))throw new RangeError;if(l>0){var g=this.plugin.getLabelForVMLI(h[l-1]),m=this.plugin.getLabelForVMLI(h[l]);(g.isSystemOrSpecialLabel()&&!m.isSystemOrSpecialLabel()||!g.isCategoryLabel()&&m.isCategoryLabel())&&n.push({type:"hr",id:"hr"+d+l,sizeInPane:this.heightOverviewHR})}n.push(h[l])}}}this.headers.set(n)},heightOverviewHR:function(){return 4},getTitleList:function(){if(this.getItem().isDescendantOf(this.getRootItem())){var e=this.plugin.getDescriptorForItem(this.getItem()),t=this.plugin.getVMLIForAccount(e.accountID);return t===this.getItem()?[this.getItem(),"Everything"]:this.plugin.numSyncAccounts()>1?[t,this.getItem()]:[this.getItem()]}return[this.getItem()]},onClickTitle:function(e){this.plugin.isAccountItem(e)?e=this.plugin.getDefaultDisplayItem(this.plugin._getAccountIDFromItem(e)):e===this.getRootItem()?e=this.plugin.getDefaultDisplayItem(this.plugin._getAccountIDFromItem(this.getItem())):this.plugin.isLabelItem(e)||(e=this.plugin.getDefaultDisplayItem()),this._super.onClickTitle.call(this,e)},onTopTextChanged:function(){this.topBoxHeight.set(this.paneTopText.get()?36:0)},searchACName:function(){},getPaneIcon:function(){return this.plugin.getPaneIcon()},requestDataPage:function(e){this.isLoadingNewPage.set(!0),this.plugin.requestDataPage(e,this.onDataPagedIn.bind(this))},dropEffectCopyBehavior:function(e,t){return r.default.Assert(!e.belongsToSameItemStore(t),"Dropping onto a Gmail pane is not supported"),this.plugin.createOutlinePaneItem(e,t)},refreshPaneData:function(){this.plugin.refreshCurrentView(this.id)},reportPaneError:function(){r.default.menus.openModalNew(Modals.ReportBug)},_onItemChange:function(e){ct.a.reset(this),this._clearCurrentSearch();var t=this.plugin.getLabelForVMLI(e);this._focusedTrash=t&&t.isTrash(),e.hasPaginationToken()||this.plugin.handleItemChange(e,function(){this.isLoading.set(!1)}.bind(this)),this.numItems()>0&&this.selectIndex(0)},_onViewStateChange:function(){ct.a.reset(this),this.plugin.handleViewModeChange(this.getItem(),this.getViewMode()),this.updateItemsImmediate(!0,void 0,void 0,!0),r.default.vmMain.paneManager.updatePaneStateForPane(this),this.setScrollOffset(0)},getItemLabel:function(e){var t=e?this.getActualPaneItem():this.getItem();return this.plugin.getLabelForVMLI(t)},onDataPagedIn:function(e){e?this._failedPageRequest.set(!1):this._failedPageRequest.set(!0),this.isLoadingNewPage.set(!1)},onScroll:function(){if(!this.isLoadingNewPage.get()&&!this.isSearched()){var e=this._infiniteList.getMaxScrollOffset();this.getScrollOffset()>=e&&this.requestDataPage(this.getItem())}},_matchFnEmailUnread:function(e,t){var i=this.plugin.isItemUnread(t);if(e)return i&&e>0||!i&&e<0?l.a.MatchState.Yes:l.a.MatchState.No},_matchFnStarred:function(e,t){var i=this.plugin.isItemStarred(t);if(e)return i&&e>0||!i&&e<0?l.a.MatchState.Yes:l.a.MatchState.No},_matchFnPriority:function(e,t){return this.plugin.getItemPriority(t)>=e?l.a.MatchState.Yes:l.a.MatchState.No},_matchFnCategory:function(e,t){return e?this.plugin.itemHasLabel(t,e)?l.a.MatchState.Yes:l.a.MatchState.No:l.a.MatchState.Yes},_remoteFnEmailUnread:function(e){var t;switch(e){case-1:t="-in:trash -is:unread";break;case 1:t="-in:trash is:unread";break;default:t=""}return t},_remoteFnStarred:function(e){var t;switch(e){case-1:t="-is:starred";break;case 1:t="is:starred";break;default:t=""}return t},_remoteFnPriority:function(e){var t;switch(e){case VMLIFlag.P0:t="label:Moo.do/Priority High";break;case VMLIFlag.P1:t="label:Moo.do/Priority Medium";break;case VMLIFlag.P2:t="label:Moo.do/Priority Low";break;default:t=""}return t},_remoteFnCategory:function(e){return e?"category:"+e:""},handleStatusClick:function(){var e=this.plugin._getAccountIDFromItem(this.getItem());(j.a.getAccountError(e)&&j.a._hasLinkedAccount(e)||j.a.verifyLinkedTokenScopes(e,[GScope.GmailModify]).length>0)&&r.default.vmMain.pluginManager.verifyAuthorization(e,!0)},_getLoadingMessage:function(){var e,t=this.plugin._getAccountIDFromItem(this.getItem());j.a.isAuthorized(t,GScope.GmailModify)?e="Loading...":e=j.a.getAccountError(t)&&j.a._hasLinkedAccount(t)||j.a.verifyLinkedTokenScopes(t,[GScope.GmailModify]).length>0?"Error Authorizing. Click here to fix.":"Authorizing...";return e},bottomListMessage:function(){var e;return this.getItem().hasPaginationToken()&&(e=this._failedPageRequest.get()?"RETRY LOAD":this.isLoadingNewPage.get()||this.getItem().paginationTokenInUse()?"Loading...":"Click to load more emails"),{text:e,clickable:!0}},_onRemoteDataLoaded:function(){},sizeOfItem:function(e,t,i){if("blockHeader"===e.type)return 40;if(i)return this._super.sizeOfItem.call(this,e,t,i);var a=this.objectAtIndex(t);return i?V.default.lineItemHeight(a,e,this,1):l.a.EmailItemHeight},onClickItem:function(e,t,i,a){r.default.vmMain.activeInput.get()&&r.default.vmMain.activeInput.get().blur();var n=!0;if(ht.isInMultiselect()||(p.a.mac&&a.metaKey||!p.a.mac&&a.ctrlKey)&&ct.a.getSelected(this).length>0)ct.a.toggleSelected(e,this),n=!1;else if(a.shiftKey){var s=ct.a.getFirstSelectedIndex(this),o=ct.a.getLastSelectedIndex(this);e<s?s=e:e>o&&(o=e),ct.a.selectInOrder(s,o,this),n=!1}else if(r.default.hasClass(a.target,"emailLabel")){var l=a.target.textContent,d=t.getAttachmentByPlugin(this.plugin.id).getField("accountID"),u=this.plugin._getLabelByName(d,l);if(r.default.Assert(u,"Must be able to get a valid label if clicking a valid label: ",l),u){var c=this.plugin.getVMLIForLabel(d,u);r.default.vmMain.zoomin(c),n=!1}}else r.default.hasClass(a.target,"itemCheckbox")||this.selectIndex(e);n&&t.onClick(e,i,a)},onRightClickItem:function(e,t,i){(ct.a.numSelectedInPane(this)<=1||!ct.a.isSelected(e,this))&&this.selectIndex(e),this._super.onRightClickItem.call(this,e,t,i),i.preventDefault(),i.stopPropagation()},handleLeftSideTap:function(e,t){var i=e.item;r.default.vmMain.pluginManager.handleTapClick(i,this,t)},handleRightSideTap:function(e,t){e&&e.hasPluginAttachment(this.plugin.id)&&r.default.vmMain.pluginManager.handleTapClick(e,this,t)},onMultiselectReset:function(e){this===e&&this.selectedIndex.set(-1)},selectIndex:function(e,t){var i=this.selectedIndex.get();this.selectedIndex.set(e,t),e>=0?ct.a.setSelected([e],this):ct.a.reset(this),(t||i!==e)&&this.selectedIndex.notify(),this.isLoading.get()||r.default.vmMain.paneManager.updatePaneStateForPane(this)},selectItem:function(e,t){if(e){var i=this.indexOfItem(e);i>=0&&this.selectIndex(i,t)}else this.selectIndex(-1,t)},onSelectedIndexChanged:function(e){if(ut.a.isOpenOnPane(this))if(e>=0){var t=this.itemAtIndex(e);this.openEmailByItem(t)}else e<0&&ut.a.reset()},_runRemoteSearch:function(){if(r.default.vmMain.paneManager.isPaneActive(this.id)){clearTimeout(this._searchTimeout),this._searchTimeout=void 0;var e=this.search.getRemoteValue(),t=this.plugin.getDescriptorForItem(this.item.get());if(t.labelID){var i=this.plugin._getLabelByID(t.accountID,t.labelID);i.isSpecialLabel()||i.isInbox()||!i.hasName()||(e+=" label:"+i.getName())}this._lastSearchValue=e,this._lastSearchTime=Date.now(),this.paneEmptySearchMessage="",this.paneTopText.set("Searching..."),this._isSearchingRemote.set(!0),this._clearCurrentSearch();var a="R~"+this.getActualPaneItem().id+"~"+r.default.generateTempId();log("Gmail Remote Search ItemID: ",a),this._currentSearch=this.plugin.runSearch(e,this.id,a,!0,function(e){if(!this._destroyed&&this._isSearchingRemote.get())switch(this.paneEmptySearchMessage=e===SearchResultStatus.Done?this.paneEmptySearchMessageDefault:"",this.isLoading.set(!1),e){case SearchResultStatus.Done:this.paneTopText.set(""),this.setScrollOffset(0);break;case SearchResultStatus.TooMany:this.paneTopText.set("Too many search results! Be more specific.");break;case SearchResultStatus.None:this.paneTopText.set("There were no search results");break;case SearchResultStatus.Error:this.paneTopText.set("There was an error running your search, try again.");break;default:r.default.Assert(!1,"Invalid search state: ",e)}}.bind(this))}},_clearCurrentSearch:function(){this._currentSearch&&(this._currentSearch.invalidate(),this._currentSearch=void 0)},onSearchChanged:function(e){var t=this.search.getRemoteValue();if(t!==this._lastSearchValue||Date.now()-this._lastSearchTime>5e3)if(clearTimeout(this._searchTimeout),this._searchTimeout=void 0,t){var i=e?0:2500;this._searchTimeout=setTimeout(this._runRemoteSearch,i)}else this._isSearchingRemote.set(!1),this.plugin.clearSearch(this.id),this._clearCurrentSearch(),this.isLoading.set(!1),this.paneTopText.set("")},isSearchingRemote:function(){return this._isSearchingRemote.get()},isRemoteSearchActive:function(){return this.plugin.isRemoteSearchBucketActive(this.id)},onEmailComposeClosed:function(){var e=this.plugin,t=e.getDefaultAccount(),i=e._getLabelByID(t,e.SystemLabels.DRAFT),a=e.getVMLIForLabel(t,i);this.item.get()===a&&this.selectIndex(-1)},onEmailPreviewClosed:function(){this.selectIndex(-1)},applyToSelection:function(e){var t=this.saveSelection();ct.a.applyFnToSelected(e,this),this.restoreSelection(t)},_autocompletePopup:function(e,t,i){if(!e.elementDisplay){var a=ct.a.getFirstSelectedIndex(this),n=this.elementAtIndex(a);e.elementDisplay=n}var s=[];ct.a.applyFnToSelected(function(e){s.push(e)}),e.items=s,e.onSelected=function(a){this.plugin.beginAction(),e.item?t(e.item,a):ct.a.applyFnToSelected(function(e){t(e,a)},this),i&&i(),this.plugin.endAction()}.bind(this),oe.a.showPopup(e)},getPaddingForPaneObject:function(e,t){return t?this._super.getPaddingForPaneObject.call(this,e,t):24},getWidth:function(){return this.rect.get().width},getFirstSelectedItem:function(){return ct.a.getFirstSelectedItem()},getFirstSelectedIndex:function(){return ct.a.getFirstSelectedIndex()},moveItem:function(e,t,i){this.plugin.beginAction(),i||(e=e.clone(t,ChangeType.Local));var a=e.getAttachmentByPlugin(this.plugin.id);r.default.Assert(a,"Must be able to get a valid attachment"),this.plugin.performAction(l.a.PluginAction.Gmail.Move,!1,a,e,t),this.plugin.getSetting(this.plugin.Settings.ArchiveOnOrganize)&&this.plugin.performAction(l.a.PluginAction.Gmail.Archive,!1,a),this.plugin.attachmentHasLabel(a,"Moo.do/Handled")||this.plugin.performAction(l.a.PluginAction.Gmail.AddLabel,!1,a,"Moo.do/Handled"),this.plugin.endAction()},autocompleteSchedule:function(e,t){var i=this.selectedIndex.get();this._super.autocompleteSchedule.call(this,e,function(){i>=this.numItems()&&(i=this.numItems()-1),this.selectIndex(i,!0),t&&t()}.bind(this))},autocompleteSnooze:function(e,t,i){var a=this.selectedIndex.get();this._super.autocompleteSnooze.call(this,e,t,function(){a>=this.numItems()&&(a=this.numItems()-1),this.selectIndex(a,!0),i&&i()}.bind(this))},autocompleteMove:function(e,t){e=e||{};var i=this.selectedIndex.get();e.positionOffset={left:40},this._super.autocompleteMove.call(this,e,function(){i>=this.numItems()&&(i=this.numItems()-1),this.selectIndex(i,!0),t&&t()}.bind(this))},autocompleteCreateTask:function(){var e=this,t=this.selectedIndex.get();if(!isNaN(t)){var i=this.elementAtIndex(t),a=ct.a.getSelectedItems(this);r.default.menus.openItemEditor({element:i,pane:this,selectIndex:0,addOnSave:!0,side:"bottom",children:a,positionOffset:{left:10},options:[{text:"Archive email",value:r.default.vmMain.pluginManager.getSetting(PluginID.Gmail,PluginSettingsID.Gmail.ArchiveOnOrganize),cb:function(){for(var t=0,i=0;i<a.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=a[i].getAttachmentByPlugin(e.plugin.id);e.plugin.performAction(l.a.PluginAction.Gmail.Archive,!1,n)}}}],beginSave:function(){var t=0;r.default.vmMain.beginUpdateItems(),e.plugin.beginAction();for(var i=0;i<a.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=a[i].getAttachmentByPlugin(e.plugin.id);e.plugin.attachmentHasLabel(n,"Moo.do/Handled")||e.plugin.performAction(l.a.PluginAction.Gmail.AddLabel,!1,n,"Moo.do/Handled")}},endSave:function(t){e.plugin.endAction(),r.default.vmMain.commitUpdateItems()}})}},toggleStarSelected:function(){this._super.toggleStarSelected.call(this),this.updateItems()},toggleStar:function(e){var t=e.getAttachmentByPlugin(this.plugin.id);r.default.Assert(t,"Must be able to get a valid attachment");var i=t.getPlugin();i.isItemStarred(e)?i.performAction(l.a.PluginAction.Gmail.Unstar,!1,t):i.performAction(l.a.PluginAction.Gmail.Star,!1,t),this.updateItems()},_openSelectedInMode:function(e){var t=ct.a.getFirstSelectedIndex(this);this.selectIndex(t);var i=this.itemAtIndex(t);this.openEmailByItem(i,e)},replySelected:function(){this._openSelectedInMode(l.a.EmailResponseMode.Reply)},replyAllSelected:function(){this._openSelectedInMode(l.a.EmailResponseMode.ReplyAll)},forwardSelected:function(){this._openSelectedInMode(l.a.EmailResponseMode.Forward)},archiveSelected:function(e){this.plugin.beginAction(),this.applyToSelection(this.archiveItem.bind(this,e)),this.plugin.endAction()},archiveItem:function(e,t){var i=t.getAttachmentByPlugin(this.plugin.id);r.default.Assert(i,"Must be able to get a valid attachment"),!e&&this.plugin.isItemArchived(t)?this.plugin.performAction(l.a.PluginAction.Gmail.Unarchive,!1,i):e&&!this.plugin.isItemArchived(t)&&this.plugin.performAction(l.a.PluginAction.Gmail.Archive,!1,i)},deleteSelected:function(e,t){this.plugin.beginAction(),this.applyToSelection(this._deleteItem.bind(this,t)),this.plugin.endAction()},_deleteItem:function(e,t){var i=t.getAttachmentByPlugin(this.plugin.id);r.default.Assert(i,"Must be able to get a valid attachment");var a=this.plugin.getLabelForVMLI(this.getItem());e&&a&&a.isDraft()&&this.plugin.itemHasDraft(t)?this.plugin.performAction(l.a.PluginAction.Gmail.DiscardDraft,!0,i):!e&&this.plugin.isItemFullTrashed(t)?this.plugin.performAction(l.a.PluginAction.Gmail.Untrash,!1,i):e&&!this.plugin.isItemFullTrashed(t)&&this.plugin.performAction(l.a.PluginAction.Gmail.Trash,!1,i)},applyPriorityToSelection:function(e,t){var i=e,a=!0;this.plugin.beginAction(),this.applyToSelection(function(n){var s=n.getAttachmentByPlugin(this.plugin.id);r.default.Assert(s,"Must be able to get a valid attachment"),t&&a&&(this.plugin.getAttachmentPriority(s)===e&&(i=VMLIFlag.None),a=!1),this.plugin.performAction(l.a.PluginAction.Gmail.SetPriority,!1,s,i),this.updateItems()}.bind(this)),this.plugin.endAction()},handleUndo:function(){this.plugin.handleUndo()},handleRedo:function(){this.plugin.handleRedo()},keyMoveDown:function(e){var t;-1===this.selectedIndex.get()?this.selectIndex(0):e&&e.shiftKey?(ct.a.isInverted(this)&&1===ct.a.numSelectedInPane(this)&&ct.a.setInverted(!1,this),ct.a.isInverted(this)?(t=ct.a.getFirstSelectedIndex(this),ct.a.removeSelected(t,this)):(t=this.indexOfNextVMLI(ct.a.getLastSelectedIndex(this)))>=0&&t<this.numItems()&&(ct.a.addSelected(t,this),this.scrollIndexIntoView(t,ScrollDuration.Default))):(t=this.indexOfNextVMLI(ct.a.getLastSelectedIndex(this)))>=0&&t<this.numItems()&&(this.selectIndex(t),this.scrollIndexIntoView(t,ScrollDuration.Default))},keyMoveUp:function(e){var t;-1===this.selectedIndex.get()?this.selectIndex(0):e&&e.shiftKey?(ct.a.isInverted(this)||1!==ct.a.numSelectedInPane(this)||ct.a.setInverted(!0,this),ct.a.isInverted(this)?(t=this.indexOfPrevVMLI(ct.a.getFirstSelectedIndex(this)))>=0&&(ct.a.addSelected(t,this),this.scrollIndexIntoView(t,ScrollDuration.Default)):(t=ct.a.getLastSelectedIndex(this),ct.a.removeSelected(t,this))):(t=this.indexOfPrevVMLI(ct.a.getFirstSelectedIndex(this)))>=0&&(this.selectIndex(t),this.scrollIndexIntoView(t,ScrollDuration.Default))},onHotkey:function(e,t,i){if(this.selectedIndex.get()>=0&&!r.default.menus.isContextMenuOpen()&&"Email"===e){var a=this.itemAtIndex(this.selectedIndex.get()),n=!0;if(a){if("Up"===t)this.keyMoveUp(i);else if("Down"===t)this.keyMoveDown(i);else if("Open"===t)ut.a.isOpenOnPane(this)||this.openEmailByItem(a);else if("Archive"===t){i.shiftKey&&ut.a.isOpenOnPane(this)&&ut.a.close();var s=!this.getItemLabel(!0).isArchived();this.archiveSelected(s)}else if("Delete"===t)this.deleteSelected(this.plugin.isGmailItem,!0);else if("Schedule"===t)this.autocompleteSchedule();else if("Snooze"===t)this.autocompleteSnooze();else if("Move"===t)this.autocompleteMove();else if("Task"===t)this.autocompleteCreateTask();else if("Label"===t)this.autocompleteLabel({item:a});else if("MarkRead"===t)this.markReadSelected(!0);else if("MarkUnread"===t)this.markReadSelected(!1);else if("Star"===t)this.toggleStarSelected();else if("Reply"===t)this.replySelected();else if("ReplyAll"===t)this.replyAllSelected();else if("Forward"===t)this.forwardSelected();else if("Priority1"===t)this.applyPriorityToSelection(VMLIFlag.P0,!0);else if("Priority2"===t)this.applyPriorityToSelection(VMLIFlag.P1,!0);else if("Priority3"===t)this.applyPriorityToSelection(VMLIFlag.P2,!0);else if("RemoveFromLabel"===t)this.search.isSearched()||(this.plugin.beginAction(),this.applyToSelection(this.removeItemFromCurrentLabel.bind(this)),this.plugin.endAction());else if("Undo"===t)this.handleUndo();else if("Print"===t){if(1===ct.a.numSelectedInPane(this)){var o=ct.a.getFirstSelectedItem(this),l=this.plugin.createPrintURLForThread(o.getAttachmentByPlugin(this.plugin.id));r.default.printPage(l)}}else if("OpenInGmail"===t){if(1===ct.a.numSelectedInPane(this)){var d=ct.a.getFirstSelectedItem(this),u=this.plugin.createURLForThread(d.getAttachmentByPlugin(this.plugin.id));r.default.openUrl(u)}}else n=!1;n&&r.default.preventDefault(i)}}},removeItemFromCurrentLabel:function(e){var t=this.getItemLabel(!0);r.default.Assert(t,"Must be able to find a valid label for pane");var i=e.getAttachmentByPlugin(this.plugin.id);r.default.Assert(i,"Must be able to get a valid attachment"),t&&(t.isCustom()?this.plugin.performAction(l.a.PluginAction.Gmail.RemoveLabel,!1,i,t.getName()):t.isInbox()?this.plugin.performAction(l.a.PluginAction.Gmail.Archive,!1,i):t.isArchived()?this.plugin.performAction(l.a.PluginAction.Gmail.Unarchive,!1,i):t.isStarred()&&this.plugin.performAction(l.a.PluginAction.Gmail.Unstar,!1,i))},canAcceptDragOver:function(e,t,i,a){if(e&&this.type===e.type&&(a||e&&this!==e)){var n,s=e.getItemLabel();if(a){var o=r.default.getElementParent(i);n=o&&r.default.getItemForElement(o)}else n=this.getItem();if(n&&this.plugin.isLabelItem(n)&&this.plugin.areItemsFromSameAccount(t,n)){var l=this.plugin.getLabelForVMLI(n);if(l!==s&&l.isDropTarget())return!0}}return!1},_handleDragOverPane:function(e,t,i,a,n,s,r){return{targetElement:i,targetItem:this.getItem()}},_handleDragDrop:function(e,t,i,a,n){if(i){var s,o=t.pane,d=o.getItemLabel(),u=i.targetItem,c=this.plugin.getLabelForVMLI(u);e.hasPluginAttachment(this.plugin.id)&&this.plugin.areItemsFromSameAccount(e,u)&&(s=e.getAttachmentByPlugin(this.plugin.id),r.default.Assert(s,"Must be able to get a valid attachment"),this.plugin.beginAction(),this.plugin.performAction(l.a.PluginAction.Gmail.RemoveLabel,!1,s,d.getName()),this.plugin.attachmentHasLabel(s,c.getName())||this.plugin.performAction(l.a.PluginAction.Gmail.AddLabel,!1,s,c.getName()),o.notifyDropFrom(e,this),this.plugin.endAction())}},notifyDropFrom:function(e,t){if(this.selectIndex(-1),t.type===PaneMode.Task){var i=e.getAttachmentByPlugin(this.plugin.id);r.default.Assert(i,"Must be able to get a valid attachment"),this.plugin.attachmentHasLabel(i,"Moo.do/Handled")||(this.plugin.beginAction(),this.plugin.getSetting(this.plugin.Settings.ArchiveOnOrganize)&&this.plugin.performAction(l.a.PluginAction.Gmail.RemoveLabel,!1,i,"Inbox"),this.plugin.performAction(l.a.PluginAction.Gmail.AddLabel,!1,i,"Moo.do/Handled"),this.plugin.endAction());var a=this.plugin.getAttachmentPriority(i);a!==VMLIFlag.None&&e.priority(a,ChangeType.Local),this.plugin.attachmentHasLabelByID(i,"STARRED")&&e.isStarred(!0,ChangeType.Local)}},maxWidthOfPaneObject:function(){return this.getWidth()-36},allowZoom:function(e){var t=!1;return this.plugin.isLabelItem(e)&&(t=!0),t},performOverviewAction:function(e){if(this.plugin.isAccountItem(e)){e.setCollapsed(!e.isCollapsed(this,!0),this,!0);var t=e=this.plugin.getDefaultDisplayItem(this.plugin._getAccountIDFromItem(e));r.default.vmMain.zoomin(t),r.default.sendEvent("Menu","OverviewZoom_Gmail")}},setItem:function(e,t){return this.isLoading.set(!0),this.selectIndex(-1),this._super.setItem.call(this,e,t)},isItemHeader:function(e,t){if(!t)return e.isHeader();for(var i=0,a=this.plugin,n=e.getItems(),s=0;s<n.length;s++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(a.isLabelItem(n[s])||a.isAccountItem(n[s]))return!0}},getActualPaneItem:function(){return this.plugin._defaultZoomItems[this.id]||this.item.get()},canResetMultiselect:function(){return!ut.a.isOpenOnPane(this)||0===this.numItems()},setExpanded:function(e,t){this._super.setExpanded.call(this,e,t),e||this===r.default.focusedPane||ct.a.reset(this)},applyDropOnBlock:function(e,t){var i=e,a=t.getAttachmentByPlugin(this.plugin.id);if(r.default.Assert(a,"Must be able to get a valid attachment"),i.isDate){var n,s=i.dateTime||i.date;n=r.default.isString(s)?H.a.parseDate(s,l.a.DateFormat.MDY):s,r.default.Assert(r.default.isDateValid(n),"Must provide a valid date when scheduling an email",i.dateTime,i.date),r.default.isDateValid(n)&&this.plugin.scheduleEmail(t,n)}else{var o;i.isStarred?this.plugin.performAction(l.a.PluginAction.Gmail.Star,!1,a):i.p0||i.isImportant?o=VMLIFlag.P0:i.p1?o=VMLIFlag.P1:i.p2&&(o=VMLIFlag.P2),o&&this.plugin.performAction(l.a.PluginAction.Gmail.SetPriority,!1,a,o)}},getSaveInfo:function(){var e=this._super.getSaveInfo.call(this);return e.viewState=this.viewState.get(),e},setIgnoreRestoreScroll:function(){},getSwipeMenuItems:function(){var e=this;return{leftOuter:{text:"Add to Outline",icon:"icon-align-left",color:"#09d",fn:function(t){e.autocompleteMove({item:t,position:"autocomplete"})}},leftInner:{text:"Snooze",icon:"icon-access_time",color:"#2a6",fn:function(t){e.autocompleteSnooze({item:t,position:"autocomplete"})}},rightInner:{text:"Archive",icon:"icon-check",color:"#0c0",fn:function(t){var i=e.getItemLabel(!0),a=!i.isArchived();e.archiveItem(a,t),i.isInbox()||i.isArchived()||e.removeItemFromCurrentLabel(t)}},rightOuter:{text:"Delete",icon:"icon-delete",color:"#a30",fn:function(t){e._deleteItem(!0,t)}}}},onTapAddItem:function(e){r.default.menus.openComposeEmail(r.default.vmMain.getDefaultEmailPlugin())},isOverviewVisibleInPane:function(){return!0},getMinItemSize:function(){return l.a.EmailItemHeight},widthOfDrag:function(e){return this.getWidth()},getStyledLinesForPaneObject:function(e,t){if(t)return this._super.getStyledLinesForPaneObject.call(this,e,t);var i=e.item;return i.els||r.default.vmMain.runSingleParse(i,ChangeType.Auto),q.a.generateStyledLines(i.els,this._lines,this)},viewModeIcon:function(){return"Date"===this.getViewMode()?"icon-access_time":"icon-exclamation"},openViewMenu:function(e){r.default.menus.openContextMenu({componentName:"ReactContextMenuGmailSort",element:e.target,pane:this,onSelected:this.changeView})},changeView:function(e){this.viewMode.set(e),this.updateItems(!1,!0)},getViewMode:function(){return this.viewState.get().viewMode},setViewMode:function(e){var t=this.viewState.get();t.viewMode!==e&&(t.viewMode=e,this.viewState.set(t,!this.isFakePane))},becomeReal:function(){this.getItem()&&this.setItem(this.getItem(),!0)}};o.a.inherit(ge.a,ft),o.a.extend(ft.prototype,pt);var gt=ft;function mt(){this._favMap={}}mt.prototype={_ensureGroup:function(e){var t=[];return this._favMap[e]||(this._favMap[e]=t),t},notifyAdd:function(e,t){var i=this._ensureGroup(t);r.default.Assert(i.indexOf(e)<0,"Should not double add item to group"),i.push(e)},notifyRemove:function(e,t){var i=this._ensureGroup(t);r.default.Assert(i.indexOf(e)>=0,"Must have been added to group before removing"),i.remove(e)},getItems:function(e){return this._favMap[e]},hasItems:function(e){var t=this.getItems(e);return t&&t.length>0}};var vt=new mt,_t=5e3;function yt(e,t,i){r.default.Assert(r.default.isFunction(e),"Must provide a valid entry callback"),r.default.Assert(r.default.isFunction(t),"Must provide a valid done callback"),this._entryCB=e,this._doneCB=t,this._delay=i||_t,this._flushTimeout=void 0,this._entries=[],o.a.binder(this,"_onEntry","_onDone","_flushEntries","_flushEntriesWatchdog")}yt.prototype={getEntryCB:function(){return this._onEntry},getDoneCB:function(){return this._onDone},_onEntry:function(e){e&&this._entries.push(e),this._flushTimeout||(this._flushTimeout=setTimeout(this._flushEntriesWatchdog,this._delay))},_onDone:function(e,t){r.default.vmMain.beginUpdateItems(),this._flushEntries();try{this._doneCB(e,t)}catch(e){r.default.reportError(e)}r.default.vmMain.commitUpdateItems()},_flushEntriesWatchdog:function(){0},_flushEntries:function(){var e=0;this._flushTimeout&&(clearTimeout(this._flushTimeout),this._flushTimeout=void 0),r.default.vmMain.beginUpdateItems();for(var t=0;t<this._entries.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;try{this._entryCB(this._entries[t])}catch(e){r.default.reportError(e)}}this._entries=[],r.default.vmMain.commitUpdateItems()}};var St=yt,wt=i(61),It={EnsureLabelVMLI:"EnsureLabelVMLI",CreateLabelVMLI:"CreateLabelVMLI",MergeThread:"MergeThread",SyncdMessage:"SyncdMessage",ErrorSyncdMessage:"ErrorSyncdMessage",UnsyncdMessage:"UnsyncdMessage",OldUnsyncdMessage:"OldUnsyncdMessage",MessagesSyncd:"MessagesSyncd",MessageDataCached:"MessageDataCached"},bt={Snooze:"snoozemail",SendMail:"sendmail"},At=1,Dt=2,Tt=3,Mt=4,Ct=5,Lt=6,Pt=7,Et=8,kt=9,xt=10,Rt=11,Ot=12,Ft=13,Nt=14,Bt=15,Ut=16,Vt=17,Ht=18,qt=19,zt=20,Wt="historyIDs",Gt="labels",jt="sendAs",Kt={INBOX:"INBOX",SPAM:"SPAM",TRASH:"TRASH",UNREAD:"UNREAD",STARRED:"STARRED",IMPORTANT:"IMPORTANT",SENT:"SENT",DRAFT:"DRAFT",CHAT:"CHAT",CATEGORY_PERSONAL:"CATEGORY_PERSONAL",CATEGORY_SOCIAL:"CATEGORY_SOCIAL",CATEGORY_PROMOTIONS:"CATEGORY_PROMOTIONS",CATEGORY_UPDATES:"CATEGORY_UPDATES",CATEGORY_FORUMS:"CATEGORY_FORUMS"},Yt={INBOX:"Inbox",SPAM:"Spam",TRASH:"Trash",UNREAD:"Unread",STARRED:"Starred",IMPORTANT:"Important",SENT:"Sent Mail",DRAFT:"Draft",CHAT:"Chat",CATEGORY_PERSONAL:"Primary",CATEGORY_SOCIAL:"Social",CATEGORY_PROMOTIONS:"Promotions",CATEGORY_UPDATES:"Updates",CATEGORY_FORUMS:"Forums"},Xt={ARCHIVED:"==MOODO_ARCHIVED==",ALLMAIL:"==MOODO_ALLMAIL=="},Qt={PRI0:"Moo.do/Priority High",PRI1:"Moo.do/Priority Medium",PRI2:"Moo.do/Priority Low"},Jt=["id","labelIds","messageID","draftID","decoded","mimeType","contentType","from","replyTo","to","cc","bcc","snippet","subject","date","internalDate","references","inReplyTo","listUnsubscribe","resources","cached","cachedError"],Zt="multipart/signed",$t="multipart/related",ei="message/partial",ti="multipart/mixed",ii="multipart/report",ai="multipart/parallel",ni="multipart/alternative",si="multipart/digest",ri="multipart/encrypted",oi="multipart/voice-message",li="text/calendar",di="text/plain",ui="text/html",ci="text/watch-html",hi="text/x-watch-html",fi="inline",pi="attachment",gi=["application","audio","example","image","message","model","video","text"],mi=[ni,ti,di,ui,ii],vi=[di,ui],_i=[li,oi,ri,ti],yi=["modifiedOffline","pendingSend","isDeleted","dataLoaded"],Si=/(?:[\"]?([^\"]*)[\"]?\s)?<(.*)>/g,wi=/\'(.*)\'/g;function Ii(){this._super.constructor.call(this,PluginID.Gmail,"Email"),this.SystemLabels=Kt,this.SpecialLabels=Xt,this._lastSyncTime=void 0,this._requiresOfflineAuth=!0,o.a.binder(this,"threadSortFn","threadSortPriorityFn","labelSortFn","labelVMLISortFn","sortFn","_fromComparator","_toComparator","_dateComparator","_messagesComparator","_shallowObjComparator","isGmailItem","_flushPendingDraftUpdates","driveMessageContentSync","_cleanupLocalCaches","_handleDeferredSnoozeTask","_cancelDeferredSnoozeTask","_persistRemoteSnoozeTask","_handleDeferredSendMailTask","_cancelDeferredSendMailTask","_persistRemoteSendMailTask"),this._emailCache={},this._labelsByID={},this._labelsByName={},this._priorityLabels={},this._creatingDrafts={},this._pendingDraftUpdates={},this._pendingThreadLoads={},this._loadThreadMutex=0,this._activeDraftUpdates=0,this._accountSettings={},this._pendingSends={},this._draftCache={},this._unsyncdMessages={},this._pendingSyncdMessages={},this._numUnsyncdMessages=0,this._numSyncdMessages=0,this._outstandingContentSync=!1,this._undoStack=new Je(10),this._generateUndoRedo(),this._syncingOfflineChanges=!1,this._draftFlushTimer=void 0,this.registerSetting("WriteAccess","writeAccess",!0),this.registerSetting("SyncTime","syncTime",!0,l.a.MaxGmailSyncTime.Free),this.registerSetting("SyncAccounts","syncAccounts",!0,["me"]),this.registerSetting("ArchiveOnSchedule","archiveOnSchedule",!0,!1),this.registerSetting("ArchiveOnOrganize","archiveOnOrganize",!0,!1),this.registerSetting("InsertSignatureAboveReplies","insertSignatureAboveReplies",!0,!1),this.addTrackedStat(It.EnsureLabelVMLI),this.addTrackedStat(It.CreateLabelVMLI),this.addTrackedStat(It.MergeThread),this.addTrackedStat(It.SyncdMessage),this.addTrackedStat(It.ErrorSyncdMessage),this.addTrackedStat(It.UnsyncdMessage),this.addTrackedStat(It.OldUnsyncdMessage),this.addTrackedStat(It.MessagesSyncd),this.addTrackedStat(It.MessageDataCached),this._threadCache=this.registerLocalCache("GmailThreadCache",StorageType.IndexedDB,!0,{noInMemoryCache:!0}),this._rawCache=this.registerLocalCache("RawCache",StorageType.IndexedDB,!1,{noInMemoryCache:!0}),this.registerDeferredTaskType(bt.Snooze,this._handleDeferredSnoozeTask,this._cancelDeferredSnoozeTask,this._persistRemoteSnoozeTask),this.registerDeferredTaskType(bt.SendMail,this._handleDeferredSendMailTask,this._cancelDeferredSendMailTask,this._persistRemoteSendMailTask),this._contentSyncTask=this.registerLowImpactTask("ContentSync",this.driveMessageContentSync),this._cacheCleanup=this.registerLowImpactTask("CacheCleanup",this._cleanupLocalCaches),this._lastCacheCleanup=0,r.default.isDemoMode()?this.declareProperty("accountID",PluginLoad.Preview|PluginLoad.Full|PluginLoad.Inline,!0,"me"):this.declareProperty("accountID",PluginLoad.Preview|PluginLoad.Full|PluginLoad.Inline),this.declareProperty("from",PluginLoad.Preview|PluginLoad.Full,!1,void 0,this._fromComparator),this.declareProperty("to",PluginLoad.Preview|PluginLoad.Full,!1,void 0,this._toComparator),this.declareProperty("subject",PluginLoad.Preview|PluginLoad.Full),this.declareProperty("date",PluginLoad.Preview|PluginLoad.Full,!0,new Date(0),this._dateComparator),this.declareProperty("lastModifiedDate",PluginLoad.Full,!0,void 0,this._dateComparator),this.declareProperty("modifiedOffline",PluginLoad.Full,!0,!1),this.declareProperty("pendingSend",PluginLoad.Full,!0,!1),this.declareProperty("messages",PluginLoad.Full,!0,[],this._messagesComparator),this.declareProperty("snippet",PluginLoad.Full),this.declareProperty("participants",PluginLoad.Runtime,!0,[]),this.declareProperty("subjectLower",PluginLoad.Runtime),this.declareProperty("count",PluginLoad.Runtime),this.declareProperty("dataLoaded",PluginLoad.Runtime,!0,!1),this.declareProperty("isDeleted",PluginLoad.Runtime,!0,!1),this.declareProperty("labelIds",PluginLoad.Runtime,!0,[]),this.declareProperty("hasAttachments",PluginLoad.Full,!0,!1),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.EmailThread),this.useRenderer(PluginRenderTypes.Measure,PluginRenderers.EmailThread)}var bi={getType:function(){return l.a.PluginType.Email},_attachMetadataFields:function(){return yi},getDataPane:function(){return r.default.Assert(!!this.getPaneIcon(),"Should have a pane icon specified"),gt},getPaneIcon:function(){return"icon-mail_outline"},getPanePriority:function(){return 97},useItemStore:function(){return"Gmail"},itemStoreOptions:function(){return{requireStoredEls:!1,enabledFilters:l.a.ItemStoreFilter.Priority,parserFn:q.a.runParseSinglePlugin.bind(q.a)}},allowRemoteRequests:function(){return!0},ensureAccountEmail:function(e){return"me"===e?this.getDefaultAccount():e},getDefaultAccount:function(){var e,t=r.default.getUserIdentifier();return t?(r.default.Assert(r.default.isDemoMode()||"me"!==t,'Should never return "me" as a valid user'),e=t):(r.default.Assert(!1,'Unable to get default account name, returning "me"'),e="me"),e},isSameAccount:function(e,t){return"me"===e&&(e=this.getDefaultAccount()),"me"===t&&(t=this.getDefaultAccount()),e===t},areItemsFromSameAccount:function(e,t){var i=this._getAccountIDFromItem(e),a=this._getAccountIDFromItem(t);return this.isSameAccount(i,a)},_handleAccountChanges:function(){var e=0,t=[];r.default.vmMain.paneManager.runForEachPane(function(e){var i=this._getAccountIDFromItem(e.getItem());r.default.Assert(i,"Missing Account ID: ",e.id,e.getItem().id),this.hasSyncAccount(i)||t.push(e)}.bind(this),this.getPaneType());for(var i=0;i<t.length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;r.default.vmMain.paneManager.removePane(t[i])}0===t.length&&r.default.vmMain.paneManager.notifyPanes()},addSyncAccount:function(e,t){var i=this.getSetting(this.Settings.SyncAccounts).slice(0);r.default.Assert(i.indexOf(e)<0,"Must not double add sync accounts to list"),i.indexOf(e)<0&&i.push(e),this.setSetting(this.Settings.SyncAccounts,i),this.isActive()?(this._ensureLabel(e,Kt.INBOX,"Inbox",void 0,void 0,ChangeType.Local),this._ensureLabel(e,Kt.UNREAD,"Unread",void 0,void 0,ChangeType.Local),this._ensureLabel(e,Xt.ARCHIVED,"Archived",void 0,void 0,ChangeType.Local),this._ensureLabel(e,Xt.ALLMAIL,"All Mail",void 0,void 0,ChangeType.Local),this._forceLabelSync(function(){this._forceThreadSync(t)}.bind(this))):t(!0),this._handleAccountChanges()},removeSyncAccount:function(e,t){var i=this.getSetting(this.Settings.SyncAccounts).slice(0);if(r.default.Assert(i.indexOf(e)>=0,"Must be able to find sync account if removing"),i.remove(e),this.setSetting(this.Settings.SyncAccounts,i),this._clearCachedData(e,t),this.getDefaultItemStore()){var a=this.getVMLIForAccount(e);a&&(a.deleteSelf(ChangeType.Local),a.getItemStore().destroyItem(a.id))}this._handleAccountChanges()},_iterateSendAs:function(e){for(var t=0,i=this.getSyncAccounts(),a=!1,n=0;!a&&n<i.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=this.getAccountSetting(i[n],"sendAs");if(s)for(var r=0,o=0;o<s.length;++o){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;var l=s[o];if(e(i[n],l)){a=!0;break}}else e(i[n])}},getSignature:function(e){var t;return this._iterateSendAs(function(i,a){if(a&&a.sendAsEmail===e)return t=a.signature,!0}),t},getReplyToAddress:function(e){var t;return this._iterateSendAs(function(i,a){if(a&&a.sendAsEmail===e&&a.replyToAddress)return t=a.replyToAddress,!0}),t},_computeDisplayName:function(e,t){return!t.displayName&&t.isPrimary?j.a.getAccountName(e):t.displayName},getDisplayName:function(e){var t;return this._iterateSendAs(function(i,a){if(a&&a.sendAsEmail===e)return t=this._computeDisplayName(i,a),!0}.bind(this)),t},getDefaultSendingAccount:function(e){var t;return this._iterateSendAs(function(i,a){if(i===e&&a&&a.isDefault)return t=a.sendAsEmail,!0}),t||(t=e),t},getDefaultFromInfo:function(e){var t=this.getDefaultSendingAccount(e);return r.default.Assert(t,"Must have found a valid account to send from"),{text:this.getDisplayName(t),email:t}},getSendingAccounts:function(e){var t=[];return this._iterateSendAs(function(i,a){e&&e!==i||(a?"pending"!==a.verificationStatus&&t.push(a.sendAsEmail):t.push(i))}),t},getSyncAccount:function(e){var t;return this._iterateSendAs(function(i,a){if(a){if(a.sendAsEmail===e)return t=i,!0}else if(e===i)return t=i,!0}),t},getSendingAccountInfo:function(e){var t;return this._iterateSendAs(function(i,a){if(a){if(a.sendAsEmail===e)return t={text:this._computeDisplayName(i,a),email:e},!0}else if(e===i)return t={text:j.a.getAccountName(i),email:i},!0}.bind(this)),t},getSyncAccounts:function(){for(var e=0,t=this.getSetting(this.Settings.SyncAccounts)||["me"],i=[],a=0;a<t.length;++a){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;"me"===t[a]?i.push(this.getDefaultAccount()):i.push(t[a])}return r.default.Assert(r.default.isDemoMode()||i.indexOf("me")<0,'Must not contain "me" as an account'),r.default.arrayUniques(i)},numSyncAccounts:function(){return this.getSyncAccounts().length},hasSyncAccount:function(e){return this.getSyncAccounts().indexOf(e)>=0},_getSettingsSendAs:function(e){for(var t=0,i=this.getSyncAccounts(),a=i.length,n=0,s={},r=function(t,i,r){t&&(s[i]=r.sendAs),++n===a&&e(s)},o=0;o<i.length;++o){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this._requestSettings(i[o],r)}},_requestSettings:function(e,t){var i=I.a.fns("gmail").users.settings.sendAs.list.packedFn,a={userId:e},n=function(i){t(!1,e,i),this._notifyFailedRequest(e,i)}.bind(this);this._queueRemoteRequestMulti(e,i,a,function(i){t(!0,e,i)},n,void 0,zt)},_fromComparator:function(e,t){var i=!1;return e||t?e&&t&&(r.default.Assert(!r.default.isString(e),"Old from must not be a string"),r.default.Assert(!r.default.isString(t),"New from must not be a string"),e.text===t.text&&e.email===t.email&&(i=!0)):i=!0,i},_toComparator:function(e,t){var i=!1;return e||t?e&&t&&(r.default.Assert(r.default.isArray(e),"Old to must be an array"),r.default.Assert(r.default.isArray(t),"New to must be an array"),i=t.equals(e)):i=!0,i},_dateComparator:function(e,t){var i=!1;return e||t?e&&t&&(r.default.isString(e)&&(e=this.parseDateHeader(e)),r.default.isString(t)&&(t=this.parseDateHeader(t)),r.default.Assert(r.default.isDateValid(e),"Must be an old valid date to compare"),r.default.Assert(r.default.isDateValid(t),"Must be a new valid date to compare"),r.default.isDateValid(e)&&r.default.isDateValid(t)&&(i=e.equals(t))):i=!0,i},_messagesComparator:function(e,t){var i=!0;if(e&&t)if(e.length===t.length)for(var a=0,n=0;i&&n<t.length;++n){var s=0;if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;for(var r=e[n],o=t[n],l=0;l<Jt.length;++l){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var d=Jt[l],u=!0;switch(d){case"from":u=this._fromComparator(r[d],o[d]);break;case"to":u=this._toComparator(r[d],o[d]);break;case"resources":case"listUnsubscribe":u=this._shallowObjComparator(r[d],o[d]);break;case"labelIds":u=o[d].equals(r[d]);break;case"date":case"internalDate":u=this._dateComparator(r[d],o[d]);break;default:u=r[d]===o[d]}u||(i=!1)}0}else i=!1;else i=!1;return i},_shallowObjComparator:function(e,t){var i=!1;if(e||t){if(e&&t)if(e===t)i=!0;else for(var a in i=!0,e)if(!t.hasOwnProperty(a)){i=!1;break}}else i=!0;return i},_offlineLoad:function(){var e=this;return this._threadCache.onCacheReady(function(){e._threadCache.onCacheMetadataReady(function(){r.default.isDemoMode()||e._threadCache.getMetadata(jt,function(t){if(t)for(var i in t)t.hasOwnProperty(i)&&e.setAccountSetting(i,"sendAs",t[i])}),e._threadCache.getMetadata(Gt,function(t){r.default.batchRenderUpdates(function(){var i=0,a=e.getSyncAccounts();!r.default.isDemoMode()&&t||(t={}),t.me&&!t[e.getDefaultAccount()]&&(t[e.getDefaultAccount()]=t.me),r.default.vmMain.beginUpdateItems();for(var n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=a[n];e._ensureLabel(s,Kt.INBOX,"Inbox",void 0,void 0,ChangeType.Local),e._ensureLabel(s,Kt.UNREAD,"Unread",void 0,void 0,ChangeType.Local),e._ensureLabel(s,Xt.ARCHIVED,"Archived",void 0,void 0,ChangeType.Local),e._ensureLabel(s,Xt.ALLMAIL,"All Mail",void 0,void 0,ChangeType.Local);var o=t[s];if(o){for(var l in o)if(o.hasOwnProperty(l)){var d=o[l];if(!Kt[d.id]){var u=d.name||"LocalLabel"+Date.now();e._ensureLabel(s,l,u,d.oldestSync,d,ChangeType.Local)}}for(var c in Kt)if(Kt.hasOwnProperty(c)){var h=Yt[c];e._ensureLabel(s,c,h,void 0,void 0,ChangeType.Local)}}e._ensureLabelVMLIsForAccount(s)}var f=e._getMetadataSyncTime(),p=e._getUnreadSyncTime(),g=function(e){return a.indexOf(e.accountID)>=0&&e.date.isAfter(p)},m=function(t,i,a){if(t&&t.length>0){var n=function(){var a=0;r.default.vmMain.beginUpdateItems();for(var n=0;n<t.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=t[n];if(r.default.Assert(s,"Must always contain a valid entry when retreiving data from preload"),s&&(!i||g(s))){var o=e.createEntryFromLocal(s.id,s);(e.isPriorityData(o)||s.date.isAfter(f))&&(e.cacheData(o.id,o),e._updateSpecialLabels(o))}}r.default.vmMain.commitUpdateItems()};a?n():r.default.batchRenderUpdates(n)}};e._threadCache.requestPreloadData(function(t){r.default.isArray(t)?m(t,!0,!0):e._threadCache.getFilterEntries(g,m)}),r.default.vmMain.commitUpdateItems(),e.notifyPanesReadyForLoad()})})})}),!0},isPriorityData:function(e){var t=!1;return e.labelIds.indexOf(Kt.UNREAD)>=0?t=!0:e.labelIds.indexOf(Qt.PRI0)>=0?t=!0:e.labelIds.indexOf(Qt.PRI1)>=0?t=!0:e.labelIds.indexOf(Qt.PRI2)>=0&&(t=!0),t},_load:function(){r.default.isDemoMode()||this.createRecurringTask("GmailThreadSync",{delay:r.default.minutes(15),minDelay:r.default.seconds(90),runOnCreate:!0,pauseWhileIdle:!0,minDelayOnResume:!0,async:!0,asyncTimeout:r.default.minutes(2),task:this.runThreadSync.bind(this)}),this.runSettingsSync(),this.createRecurringTask("GmailLabelSync",{delay:r.default.minutes(30),minDelay:r.default.minutes(15),runOnCreate:!0,pauseWhileIdle:!0,async:!0,task:this.runLabelSync.bind(this)})},_notifyFailedRequest:function(e,t){if(r.default.Assert(r.default.isString(e),"Must supply a valid accountID string"),t&&t.error)if(t.error.code===l.a.HTTPStatusCode.Unauthorized)r.default.vmMain.pluginManager.verifyAuthorization(e);else if(t.error.code===l.a.HTTPStatusCode.BadRequest)for(var i=0,a=t.error.errors,n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;a[n].reason===l.a.GoogleError.FailedPrecondition&&(r.default.toasts.pushMessage(MessageID.GmailDisabled),this.setSetting(this.Settings.IsEnabled,!1))}else if(t.error.code===l.a.HTTPStatusCode.Forbidden)for(var s=0,o=t.error.errors,d=0;d<o.length;++d){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;o[d].reason===l.a.GoogleError.InsufficientPermissions&&(r.default.toasts.pushMessage(MessageID.GmailDisabled),this.setSetting(this.Settings.IsEnabled,!1))}else t.error.code>=400&&t.error.code<500&&this._reportErrorCode(t.error.code)&&r.default.reportError(new Error("Failed Gmail request: "+t.error.code),t)},_reportErrorCode:function(e){var t=!1;return e!==l.a.HTTPStatusCode.NotFound&&(t=!0),t},_notifySendFailed:function(){r.default.toasts.pushMessage(MessageID.EmailSendFail)},_createResourceCID:function(e,t){var i=0;t||(t="UnnamedFile");for(var a=t,n=1;e.has(a);){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=t.split(".");if(a=s[0]+"_"+n,s[1]&&(a+="."+s[1]),n++,r.default.checkLoopLength(n))break}return a},_createResource:function(e,t){return r.default.Assert(e,"Must have valid resources lib to add to"),{cid:this._createResourceCID(e,t.name),id:r.default.generateTempId(),attID:void 0,realAttrID:void 0,data:void 0,size:void 0,thumbnail:void 0,uploader:void 0,link:void 0,error:!1,disposition:pi,parentType:ti,mimeType:t.type,contentEncoding:void 0}},_getLinkedResourceString:function(e){return'<a cid="'+e.cid+'" style="background-color:#f3f3f3;border:1px solid #dddddd;padding:8px;width:396px;font-weight:bold;min-height:18px;display:block;border-radius:3px;margin-bottom:8px;" href="'+e.link+'"><img style="vertical-align:top;border:none;margin-right:8px;" src="https://ssl.gstatic.com/docs/doclist/images/icon_10_generic_list.png">'+e.cid+"</a>"},_removeAttachContent:function(e,t,i){var a,n=st.a.removeElementsByAttribute(t.decoded,"cid",i.cid);return a=n!==t.decoded,t.decoded=n,a},notifyAttachLinkedFile:function(e,t,i,a){var n={name:i.getField("title"),type:i.getField("mimeType")},s=this._createResource(t.resources,n);s.size=i.getField("fileSize"),s.link=i.getField("alternateLink"),this._shareAttachment(e,i.id,s,a),t.resources.add(s),e.notifyDataMutated(["hasAttachments"],ChangeType.Local)},notifyAttachFiles:function(e,t,i,a){for(var n=0,s=e.getField("accountID"),o=0;o<i.length;++o){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var d=i[o],u=this._createResource(t.resources,d),c=function(t,i){t.error=!1,t.link=i.alternateLink,t.thumbnail=i.thumbnailLink,this._shareAttachment(e,i.id,t,a)}.bind(this,u),h=function(t){t.error=!0,r.default.toasts.pushMessage({text:"There was an error uploading your attachment.",actionText:"RETRY",action:function(){t.uploader.resume()}}),e.notifyDataMutated(["hasAttachments"],ChangeType.Local),a&&a(!1)}.bind(this,u);u.size=d.size,u.uploader=new wt.a(d,s,l.a.DriveFolder.Attach,function(){e.notifyDataMutated(["hasAttachments"],ChangeType.Local)},c,h),u.uploader.upload(),t.resources.add(u)}e.notifyDataMutated(["messages"],ChangeType.Local)},_shareAttachment:function(e,t,i,a){var n=this;r.default.Assert(t,"Must supply a valid fileID to share"),r.default.Assert(i,"Must supply a valid resource object to share"),r.default.vmMain.remoteAPI().drivePermissionsPublic(t,function(){i.error=!1,e.notifyDataMutated(["messages"],ChangeType.Local),a&&a(!0)},function(s){i.error=!0,r.default.isHTTPStatusCode(s,l.a.HTTPStatusCode.Forbidden)?r.default.toasts.pushMessage({text:"Sharing files/attachments in Google Drive is disabled on your domain. Please contact your domain administrator.",actionText:"OKAY",hold:!0}):r.default.toasts.pushMessage({text:"There was an error sharing your attachment.",actionText:"RETRY",action:function(){this._shareAttachment(e,t,i,a)}.bind(n)}),e.notifyDataMutated(["hasAttachments"],ChangeType.Local),a&&a(!1)})},removeAttachFiles:function(e,t,i){r.default.Assert(i,"Must always specify a valid resource to remove from the message");var a=!1;return i.uploader&&!i.uploader.isDone()&&(i.uploader.cancel(),a=!0),t.resources.has(i.cid)&&t.resources.remove(i),a=this._removeAttachContent(e,t,i)||a,e.notifyDataMutated(["messages"],ChangeType.Local),a},notifyItemPropertyChanged:function(e,t,i,a){var n=this.attachmentIsArchived(e);t.belongsToItemStore(this.getDefaultItemStore())&&(t.dateCompleted&&!n&&this.archiveAttachment(e));"priority"===a?this.getAttachmentPriority(e)!==t.priority()&&this.setAttachmentPriority(e,t.priority()):"isArchived"===a&&(n&&!t.isArchived()?this.unarchiveAttachment(e):!n&&t.isArchived()&&(this.archiveAttachment(e),ut.a.isOpenOnThread(e)&&ut.a.reset()))},createLabelString:function(e){if(!Yt[e.toUpperCase()])return e},isDisplayTag:function(e,t){var i=!1;if(e&&e.shouldDisplayInMessageList()){var a=e.isCustom()||e.getLabelID()===Kt.DRAFT,n=t&&!t.isInbox()&&e.isInbox();if(a||n)switch(i=!0,e.getName()){case Qt.PRI0:case Qt.PRI1:case Qt.PRI2:case"Moo.do/Handled":case Yt.STARRED:i=!1}}return i},isDisplayHeader:function(e){var t=!1;this.isLabelItem(e)&&(this._getLabelIDFromItem(e)!==Kt.UNREAD&&(t=!0));return t},isMessageDraft:function(e){return e&&e.labelIds&&e.labelIds.indexOf(Kt.DRAFT)>=0},getDisplayTags:function(e,t,i){var a,n=0,s=e.getField("labelIds"),r=e.getField("accountID"),o=[];t&&(a=t.getItemLabel(!0));for(var l=0;l<s.length;++l){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var d=this._getLabelByID(r,s[l]);if(this.isDisplayTag(d,a)){var u=i?d.getOutlineText():d.getDisplayText();u&&o.push(u)}}return o},_getParticipantDisplayName:function(e,t){var i;if(this.isMyAccountID(e.email))i="me";else if(e.text)if(1===t)i=e.text;else{var a=e.text.split(" ");i=a&&a.length>0?a[0]:e.email}else i=e.email;return i},getDisplayParticipants:function(e){for(var t=0,i=e.getField("participants"),a=[],n=0;n<i.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;a.push(this._getParticipantDisplayName(i[n],i.length))}return a.join(", ")},getDefaultDisplayItem:function(e){e=e||this.getDefaultAccount();var t=this._getLabelByID(e,Kt.INBOX);return this.getVMLIForLabel(e,t)},getEmailRootItem:function(){return vt.getItems(l.a.FavoriteGroup.EmailRoot)[0]},hasEmailRootItem:function(){return vt.hasItems(l.a.FavoriteGroup.EmailRoot)},createEmailRootItem:function(){r.default.Assert(!this.hasEmailRootItem(),"Should not create email root if it already exists");var e=r.default.vmMain.itemStoreManager.getDefaultItemStore().getRoot(),t=s.default.createVMLI({text:"Email",favorites:[l.a.FavoriteGroup.EmailRoot]},{parent:e,changeType:ChangeType.AllLocal});return e.insertItem(t,0),r.default.toasts.pushMessage({text:'A new "Email" item was created at the top of your document for snoozed emails.',action:MessageAction.Okay,hold:!0}),t},ensureEmailItem:function(e){var t=0;y.a.beginAction(),this.hasEmailRootItem()||this.createEmailRootItem();for(var i,a=this.getEmailRootItem(),n=a.getItems(),r=0;r<n.length;++r){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(n[r].getRawText()===e){i=n[r];break}}return i||(i=s.default.createVMLI({text:e},{parent:a,changeType:ChangeType.AllLocal}),a.insertItem(i,0)),y.a.endAction(),i},getWaitingItem:function(e){e(this.ensureEmailItem("Waiting"))},allowTextEditing:function(e){var t=!0,i=this.getDefaultItemStore();return e.belongsToItemStore(i)&&(t=!1),t},getDraftForMessage:function(e,t,i,a){var n;r.default.Assert(t,"Must have a valid thread ID"),r.default.Assert(i,"Must have a valid message ID");var s=this.getAttachment(t),o=s.getField("messages").indexOfWithProperty("id",i);r.default.Assert(o>=0,"Must be able to find the requested message");var l=s.getField("messages")[o+1];return l&&l.labelIds.indexOf(Kt.DRAFT)>=0?n=l:(this.createDraft(e,t,i,{from:a}),n=s.getField("messages")[o+1]),r.default.Assert(n.labelIds.indexOf(Kt.DRAFT)>=0,"Must return a valid draft"),n},getDraftByID:function(e,t,i,a){var n,s;if(t)n=this.getAttachment(t),s=i?this._getMessageFromAttachment(n,i):n.getField("messages")[0],r.default.Assert(s.labelIds.indexOf(Kt.DRAFT)>=0,"Must be a valid draft");else{var o=this.createDraft(e,void 0,void 0,a);s=(n=this.getAttachment(o.threadID)).getField("messages")[0]}return{attach:n,draftMsg:s}},_notifyDraftMessage:function(e,t,i){var a=this;r.default.Assert(e,"Must supply a valid accountID"),r.default.Assert(t&&!r.default.isTempId(t),"Must supply a valid threadID: ",t),r.default.Assert(i&&!r.default.isTempId(i),"Must supply a valid messageID: ",i),setTimeout(function(){a.hasCacheData(t)&&a._getRemoteDraftID(e,t,i,function(e,i){i&&(log("DraftID: ",e),a.cacheData(t,a.getCacheData(t),!0,["messages"]))})},0)},_notifyLocalDraftDelete:function(){},_getInlineResources:function(e){var t=new dt.a;return e.resources.forEachResource(function(e){e.disposition===fi&&t.add(r.default.clone(e))}),t},createDraft:function(e,t,i,a){a=a||{},r.default.Assert(!a.body||!a.decoded,"Must not supply both a decoded field and a body"),this.sendEvent("CreateDraft");var n=r.default.generateTempId(),s=a.from||this.getDefaultFromInfo(e),o=a.body||a.decoded||"";""===o&&(o=this.createSignature(s.email));var l,d,u={id:n,modifiedOffline:!0,labelIds:[Kt.DRAFT],messageID:void 0,raw:"",decoded:o,mimeType:ui,contentType:"text/html;charset=utf-8",from:s,replyTo:this.getReplyToAddress(s.email),to:a.to||[],cc:a.cc||[],bcc:a.bcc||[],snippet:"",subject:a.subject||"",date:new Date,references:void 0,inReplyTo:void 0,resources:new dt.a};if(t){l=this.getCacheData(t),r.default.Assert(i,"When supplying a thread ID, must also supply a valid message ID");var c=l.messages.indexOfWithProperty("id",i);r.default.Assert(c>=0,"If requesting a reply to a message, it must exist in the thread");var h=l.messages[c];if(h&&(u.references=(r.default.isTempId(h.messageID)?"":h.messageID)+(h.references?" "+h.references:""),r.default.isTempId(h.messageID)||(u.inReplyTo=h.messageID),u.resources=this._getInlineResources(h)),l.messages.splice(c+1,0,u),this.hasAttachment(t)){var f=this.getAttachment(t);this._updateAttachmentFromMessages(f,ChangeType.Local),f.notifyDataMutated(["messages"],ChangeType.Local)}this.addModifiedOffline(l,["messages"]),d=l}else l={id:n,accountID:e,modifiedOffline:!0,messages:[u],labelIds:[Kt.DRAFT],subject:a.subject||"",from:e},d=this.createEntryFromLocal(n,l),this.cacheData(d.id,d);return this.cacheThreadData(d.id,this.serializeExternalData(d)),{threadID:d.id,draftID:n,messageID:i}},_updateDraftID:function(e,t,i){r.default.Assert(i,"Must provide a valid set of draft info"),r.default.Assert(i.id&&i.message,"Draft info must contain valid data");var a=e.isLocalOnlyAttachment();a&&(this._handleThreadLabelUpdates(e.getData(),void 0,e.getData().labelIds),this.changeID(e,e.id,i.message.threadId),this._threadCache.removeEntry(t));var n=this._findDraft(e,t,i.id);n&&(n.id=i.message.id,r.default.Assert(n.draftID===i.id,"Should have valid draft ID associated with the message"),this._draftCache[n.id]=i.id,a&&this.cacheData(e.id,e.getData()),this._pendingDraftUpdates[t]&&(this._pendingDraftUpdates[n.id]=this._pendingDraftUpdates[t],delete this._pendingDraftUpdates[t]),this._pendingSends[t]&&(this._pendingSends[n.id]=this._pendingSends[t],delete this._pendingSends[t]),e.notifyDataMutated(["messages"],ChangeType.Local),this.cacheThreadData(e.id,this.serializeExternalData(e.getData())))},_updateDraftFromSend:function(e,t,i){r.default.Assert(i,"Must provide a valid set of draft info"),r.default.Assert(i.id&&i.threadId,"Draft info must contain valid data"),e.isLocalOnlyAttachment()&&(this._handleThreadLabelUpdates(e.getData(),void 0,e.getData().labelIds),this.changeID(e,e.id,i.threadId),r.default.Assert(!r.default.isTempId(e.id),"After an ID change, should never be a temp ID"),this._threadCache.removeEntry(t));var a=this._getMessageFromAttachment(e,t);a.id=i.id,a.labelIds=i.labelIds||[],this._updateAttachmentFromMessages(e,ChangeType.Remote),this._draftCache[a.id]=i.id,this._pendingDraftUpdates[t]&&(this._pendingDraftUpdates[a.id]=this._pendingDraftUpdates[t],delete this._pendingDraftUpdates[t]),this._pendingSends[t]&&(this._pendingSends[a.id]=this._pendingSends[t],delete this._pendingSends[t]),e.notifyDataMutated(["messages"],ChangeType.Local),this.cacheThreadData(e.id,this.serializeExternalData(e.getData()))},_createRemoteDraft:function(e,t,i){var a=this;if(this._creatingDrafts[t])i(!1,{msg:"Already creating remote draft for given message"});else{this._creatingDrafts[t]=!0;var n=this._getMessageFromAttachment(e,t);if(n)this._createRFC822Message(e.getData(),n,!1,function(s){var r={raw:s};e.isLocalOnlyAttachment()||(r.threadId=e.id);var o=I.a.fns("gmail").users.drafts.create.packedFn,l={userId:e.getField("accountID"),resource:{message:r}};a._queueRemoteRequestMulti(e.getField("accountID"),o,l,function(s){a._attachmentHasMessage(e,t)&&(delete a._creatingDrafts[t],n.draftID=s.id,a.removeModifiedOffline(e.getData(),!1),a.removeModifiedOffline(n,!1),a._pendingDraftUpdates[t]&&a._notifyPendingDraftUpdate(),a._updateDraftID(e,t,s),a._updateIsSavingDrafts()),i(!0)},function(n){delete a._creatingDrafts[t],a._updateIsSavingDrafts(),i(!1,n),a._notifyFailedRequest(e.getField("accountID"),n)},void 0,Ft)});else{try{var s={length:e.getField("messages").length};r.default.reportError(new Error("Unable to find valid draft for creation"),s)}catch(e){r.default.reportError(e)}i(!1,{msg:"Unable to find requested message in thread"})}}},_updateIsSavingDrafts:function(){r.default.isSavingDrafts=this._activeDraftUpdates>0||!r.default.isEmpty(this._pendingDraftUpdates)||!r.default.isEmpty(this._creatingDrafts)},_notifyPendingDraftUpdate:function(e,t,i,a){e&&t&&(this._pendingDraftUpdates[t]={attach:e,draftID:i,lastUpdate:Date.now()},a&&this._runDraftUpdate(t)),this._draftFlushTimer&&clearTimeout(this._draftFlushTimer),this._draftFlushTimer=setTimeout(this._flushPendingDraftUpdates,12e3),this._updateIsSavingDrafts()},_flushPendingDraftUpdates:function(){if(this.isOnline()){for(var e in this._pendingDraftUpdates)this._pendingDraftUpdates.hasOwnProperty(e)&&this._runDraftUpdate(e);this._draftFlushTimer=void 0}},_runDraftUpdate:function(e){var t=this;if(!this._creatingDrafts[e]){var i=this._pendingDraftUpdates[e];r.default.Assert(i,"Must be able to find valid draft info for pending draft update"),this._updateRemoteDraft(i.attach,e,i.draftID,!1,function(e,i){e?r.default.toasts.clearMessage(MessageID.EmailUpdateFail):r.default.isHTTPStatusCode(i,l.a.HTTPStatusCode.NotFound)?r.default.toasts.clearMessage(MessageID.EmailUpdateFail):r.default.toasts.pushMessage(MessageID.EmailUpdateFail),t._updateIsSavingDrafts()}),delete this._pendingDraftUpdates[e],this.sendEvent("UpdateDraft")}},_clearPendingDraftUpdate:function(e,t){var i=this._pendingDraftUpdates[t];i&&(r.default.Assert(i.attach===e,"Must have the correct attachment for the draft update"),delete this._pendingDraftUpdates[t])},hasPendingSends:function(){return this._pendingSends.length>0},notifyPendingSend:function(e,t){r.default.Assert(!this._pendingSends[t],"Must not have an already pending send for a message"),this._pendingSends[t]=e,r.default.isSendingEmail=!0},notifySent:function(e,t){r.default.Assert(this._pendingSends[t],"Must have a pending send to be sent"),delete this._pendingSends[t],this.hasPendingSends()||(r.default.isSendingEmail=!1)},notifySendError:function(e,t){r.default.Assert(this._pendingSends[t],"Must have a pending send to have an error"),delete this._pendingSends[t],this.hasPendingSends()||(r.default.isSendingEmail=!1)},onShutdown:function(){clearTimeout(this._draftFlushTimer),this._draftFlushTimer=void 0,this._flushPendingDraftUpdates(),this._updateIsSavingDrafts()},_getLinkedResources:function(e){var t=[];return e.forEachResource(function(e){"attachment"===e.disposition&&e.link&&t.push(e)}),t},_createDraftBody:function(e,t){var i;if(t){var a=this._getLinkedResources(t);if(a.length>0){for(var n=0,s="<br/><br/>",r=0;r<a.length;++r){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;s+=this._getLinkedResourceString(a[r])}i=e+'<var id="moodoAttach" moodoAttach="true">'+s+"</var>"}else i=e}else i=e;return i},updateDraft:function(e,t,i,a,n,s,o,l){r.default.Assert(r.default.isBoolean(s),"Must supply a valid bool for updateRemoteDraft"),r.default.Assert(r.default.isBoolean(o),"Must supply a valid bool for forceFlush"),r.default.Assert(r.default.isFunction(l),"Must supply a valid bool for cb");var d=this._findDraft(e,t,i);return d?(d.to=a.to,d.from=a.from||d.from,d.cc=a.cc,d.bcc=a.bcc,d.subject=a.subject,d.decoded=this._createDraftBody(a.body||a.decoded,d.resources),d.snippet=n?r.default.escape(n.substring(0,30)):"",a.hasOwnProperty("resources")&&(r.default.Assert(d.resources instanceof dt.a,"Resources must always be a valid resource lib"),d.resources=a.resources),this._updateAttachmentFromMessages(e,ChangeType.Local),e.notifyDataMutated(["messages"],ChangeType.Local),this.cacheThreadData(e.id,this.serializeExternalData(this.getCacheData(e.id))),!this._creatingDrafts[d.id]&&s?r.default.isTempId(d.id)?this._createRemoteDraft(e,d.id,function(e,t){e||r.default.toasts.pushMessage(MessageID.EmailUpdateFail),l(e,t)}):(this._notifyPendingDraftUpdate(e,d.id,d.draftID,o),l(!0)):(s&&this._notifyPendingDraftUpdate(e,d.id,d.draftID,o),l(!0)),this._updateIsSavingDrafts()):(r.default.Assert(!1,"Unable to update draft as expected from compose window"),l(!1)),{threadID:e.id,draftID:d.draftID,messageID:d.id}},_updateRemoteDraft:function(e,t,i,a,n){var s=this;r.default.Assert(t&&i,"Must specify both a valid messageID and draftID"+t+"."+i);var o=this._findDraft(e,t,i);r.default.Assert(o&&o.labelIds.indexOf(Kt.DRAFT)>=0,"Must be updating a valid draft"+!!o),r.default.Assert(!this._creatingDrafts[o.id],"Should not send a remote update while the original draft is being created"),this._activeDraftUpdates++,this._getRemoteDraftID(e.getField("accountID"),e.id,o.id,function(t){t?s._createRFC822Message(e.getData(),o,a,function(i){var a=I.a.fns("gmail").users.drafts.update.packedFn,r={userId:e.getField("accountID"),id:t,resource:{message:{raw:i,threadId:e.id}}};s._queueRemoteRequestMulti(e.getField("accountID"),a,r,function(t){s._updateDraftID(e,o.id,t),s._activeDraftUpdates--,n(t)},function(t){n(void 0,t),s._activeDraftUpdates--,s._notifyFailedRequest(e.getField("accountID"),t)},void 0,Nt)}):(r.default.Assert(!1,"Must always be able to get a valid draft ID when updating"),n(!1))})},sendDraft:function(e,t,i,a,n){var s=this;r.default.Assert(!e.getField("pendingSend"),"Should not try to re-send a message after it has already been sent");var o=!0,d=this._findDraft(e,t,i),u=function(t,i){t?(e.updateField("pendingSend",!1),s.removeModifiedOffline(e.getData(),!1),s.removeModifiedOffline(d,!1),s.notifySent(e,d.id)):(r.default.isHTTPStatusCode(i,l.a.HTTPStatusCode.Network)||e.updateField("pendingSend",!1),s.notifySendError(e,d.id)),n(t,i)},c=this._verifyEmailRecipients(e,d.id,d.draftID);if(c||(c=this._verifyEmailAttachments(e,d.id,d.draftID)),c){o=!1;var h=r.default.toasts.pushMessage({text:c.message,action:MessageAction.Okay});c.handleMessageFn&&c.handleMessageFn(h),this.notifyPendingSend(e,d.id),u(!1)}else if(!a){e.updateField("pendingSend",!0),this.notifyPendingSend(e,d.id);var f=!1;this.onEmailReadyToSend(d,function(){r.default.Assert(!f,"Should not send an email twice"),f||(f=!0,e.isLocalOnlyAttachment()||r.default.isTempId(d.id)?this._sendEmail(e,d.id,d.draftID,u):this._sendRemoteDraft(e,d.id,u))}.bind(this))}return o},onEmailReadyToSend:function(e,t){var i=!0;e.resources.forEachResource(function(a){a.uploader&&!a.uploader.isDone()&&(i=!1,a.uploader.hasError()?r.default.Assert(!1,"Attachment has error when sending."):a.uploader.notifyOnComplete(this.onEmailReadyToSend.bind(this,e,t)))}.bind(this)),i&&setTimeout(t,0)},_sendRemoteDraft:function(e,t,i){this.sendEvent("SendDraft"),this._clearPendingDraftUpdate(e,t),this._getRemoteDraftID(e.getField("accountID"),e.id,t,function(a){a?this._updateRemoteDraft(e,t,a,!0,function(t){if(t&&t.message){var n=I.a.fns("gmail").users.drafts.send.packedFn,s={userId:e.getField("accountID"),resource:{id:a}},o=function(a){this._updateLocalDraftFromSend(e,t.message.id,a,i)}.bind(this),l=function(t){this._notifySendFailed(),i(!1,t),this._notifyFailedRequest(e.getField("accountID"),t)}.bind(this);this._queueRemoteRequestMulti(e.getField("accountID"),n,s,o,l,void 0,Ut)}else r.default.toasts.pushMessage(MessageID.EmailUpdateFail),i(!1)}.bind(this)):(r.default.Assert(!1,"Must always be able to get a valid draft ID when sending"),r.default.toasts.pushMessage(MessageID.EmailUpdateFail),i(!1))}.bind(this))},_updateLocalDraftFromSend:function(e,t,i,a){r.default.Assert(i,"Must have a valid draft result");var n=this._getMessageFromAttachment(e,t);r.default.Assert(n,"Must always be able to find the sent message"),n&&(this.removeModifiedOffline(e.getData(),!1),this.removeModifiedOffline(n,!1),this._updateDraftFromSend(e,t,i)),r.default.isDemoMode()||this._requestRemoteMessageData(e,i.id,function(e){r.default.Assert(e,"Should always be able to update message data after send")}),a(!0)},runDiscardDraft:function(e){var t=this._getDraftFromAttachment(e);this.discardDraft(e,t.id,t.draftID,function(e){r.default.Assert(e,"Must be able to discard message draft")})},discardDraft:function(e,t,i,a){var n=e.getData(),s=this._findDraft(e,t,i),o=n.messages.indexOf(s);r.default.isTempId(t)?a(!0):this._deleteRemoteDraft(e,t,a);var l=n.messages[o];n.messages.splice(o,1),this._removeRemoteResources(l),this._updateAttachmentFromMessages(e,ChangeType.Local),this._clearPendingDraftUpdate(e,t),e.notifyDataMutated(["messages"],ChangeType.Local),this.cacheThreadData(n.id,this.serializeExternalData(n)),this.sendEvent("DiscardDraft")},_removeRemoteResources:function(e){e&&e.resources.forEachResource(function(e){e.uploader&&!e.uploader.isDone()&&e.uploader.cancel()})},_deleteRemoteDraft:function(e,t,i){r.default.Assert(!r.default.isTempId(t),"Should not try to remotely delete a local message"),this._getRemoteDraftID(e.getField("accountID"),e.id,t,function(t){var a=this;if(t){var n=I.a.fns("gmail").users.drafts.delete.packedFn,s={userId:e.getField("accountID"),id:t};this._queueRemoteRequestMulti(e.getField("accountID"),n,s,function(){i(!0)},function(t){r.default.isHTTPStatusCode(t,l.a.HTTPStatusCode.NotFound)?i(!0):i(!1,t),a._notifyFailedRequest(e.getField("accountID"),t)},void 0,Bt)}else r.default.Assert(!1,"Must always be able to get a valid draft ID when deleting"),r.default.toasts.pushMessage(MessageID.EmailUpdateFail),i(!1)}.bind(this))},_getRemoteDraftIDRaw:function(e,t,i,a){var n=I.a.fns("gmail").users.drafts.list.packedFn,s={userId:e,q:"rfc822msgid:"+t};this._queuePagedRemoteRequestMulti(e,n,s,i,a,void 0,Vt,{getAllPages:!0,resultsField:"drafts"})},_getRemoteDraftID:function(e,t,i,a){var n=this;r.default.Assert(r.default.isString(e),"Must provide a valid accountID"),r.default.Assert(r.default.isString(t)&&!r.default.isTempId(t),"Should not try to remotely get the draft ID of a local thread: ",t),r.default.Assert(r.default.isString(i)&&!r.default.isTempId(i),"Should not try to remotely get the draft ID of a local draft: ",i);var s=this.getAttachment(t);if(r.default.Assert(s,"Must be able to find a valid attachment for the requested thread"),!s)return setTimeout(a,0,void 0,!1);var o=this._getMessageFromAttachment(s,i);if(r.default.Assert(o,"Must be able to find a valid message for the requested draft"),!o)return setTimeout(a,0,void 0,!1);if(o.draftID)setTimeout(a,0,o.draftID,!1);else{if(r.default.Assert(o.messageID&&!r.default.isTempId(o.messageID),"Must have a valid messageID for the draft being queried"),!o.messageID||r.default.isTempId(o.messageID))return setTimeout(a,0,void 0,!1);this._getRemoteDraftIDRaw(e,o.messageID,function(d){if(r.default.Assert(d&&d.length<=1,"Must find only a single draft ID for a given message: ",d.length,o.messageID),d){for(var u=0,c=0;c<d.length;++c){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;var h=d[c];1!==d.length&&h.message.threadId!==t||(r.default.Assert(!o.draftID||o.draftID===h.id,"Draft ID must either match or not be known yet"),o.draftID=h.id)}r.default.Assert(0===d.length||o.draftID,"Draft returned but IDs dont match: ",d[0]?d[0].message.threadId:"NO RESULT",t,d[0]?d[0].message.id:"NO RESULT",i)}return o.draftID?a(o.draftID,!0):o.contentType&&o.mimeType&&o.decoded?void n._createRemoteDraft(s,o.id,function(i,s){return i?a(o.draftID,!0):(r.default.isHTTPStatusCode(s,l.a.HTTPStatusCode.NotFound)&&n._deleteCachedThread(e,t),a(void 0,!1))}):(n._notifyLocalDraftDelete(e,t,i),a(void 0,!1))},function(t){return n._notifyFailedRequest(e,t),a(void 0,!1)})}},_attachmentHasMessage:function(e,t){return e.getField("messages").indexOfWithProperty("id",t)>=0},_getMessageFromAttachment:function(e,t){var i=e.getField("messages"),a=i.indexOfWithProperty("id",t);return r.default.Assert(a>=0,"Must have a vald draft"),i[a]},_getDraftFromAttachment:function(e,t){for(var i,a=0,n=e.getField("messages"),s=0;s<n.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(n[s].labelIds.indexOf(Kt.DRAFT)>=0){t&&t!==n[s].draftID||(i=n[s]);break}}return i},_findDraft:function(e,t,i){var a,n=e.getField("messages"),s=n.indexOfWithProperty("id",t);if(s>=0)a=n[s];else if(i){var o=n.indexOfWithProperty("draftID",i);o>=0&&(a=n[o])}return r.default.Assert(a,"Must be able to find a valid draft for given messageID/draftID"),a},isAttachmentDraftOnly:function(e){return this.attachmentHasLabel(e,Yt.DRAFT)&&1===e.getField("messages").length},archiveAttachment:function(e){return r.default.Assert(!this.attachmentIsArchived(e),"Should not archive a thread that is already archived"),this.sendEvent("ArchiveMail"),this.removeLabelFromAttachment(e,Yt.INBOX)},unarchiveAttachment:function(e){return r.default.Assert(this.attachmentIsArchived(e),"Thread must be unarchived to archive it"),this.sendEvent("UnarchiveMail"),this.addLabelToAttachment(e,Yt.INBOX)},trashAttachment:function(e){return this.sendEvent("TrashMail"),this.trashMail(e.getField("accountID"),e.id,void 0,function(e){r.default.Assert(e,"Must have successfully trashed remote thread")})},untrashAttachment:function(e){return this.sendEvent("UntrashMail"),this.untrashMail(e.getField("accountID"),e.id,void 0,function(e){r.default.Assert(e,"Must have successfully untrashed remote thread")})},markAttachmentRead:function(e){return this.sendEvent("MarkMailRead"),this.removeLabelFromAttachment(e,Yt.UNREAD)},markAttachmentUnread:function(e){return this.sendEvent("MarkMailUnread"),this.addLabelToAttachment(e,Yt.UNREAD)},snoozeAttachment:function(e,t){this.sendEvent("SnoozeThread");var i=this._getLabelByName(e.getField("accountID"),"Moo.do/Snoozed");if(i&&!i.isLocalOnly()){var a=Date.now()+t,n=new Date(a);this.addLabelToAttachment(e,"Moo.do/Snoozed"),this.attachmentHasLabel(e,Yt.INBOX)&&this.removeLabelFromAttachment(e,Yt.INBOX),this.attachmentHasLabel(e,Yt.UNREAD)&&this.removeLabelFromAttachment(e,Yt.UNREAD);var s={scheduleDate:n.toISOString(),gidLinked:j.a.getAccountGID(e.getField("accountID")),threadID:e.id,labelID:i.getLabelID()};this.scheduleDeferredTask(e.id,bt.Snooze,n,s)}else r.default.toasts.pushMessage({text:"Please restart the app and try again. There was an error syncing your labels with Gmail.",action:MessageAction.Okay})},unsnoozeAttachment:function(e){this.sendEvent("UnsnoozeThread"),this.removeLabelFromAttachment(e,"Moo.do/Snoozed"),this.addLabelToAttachment(e,Yt.INBOX),this.addLabelToAttachment(e,Yt.UNREAD),this.cancelDeferredTask(e.id,bt.Snooze)},_handleDeferredSnoozeTask:function(e){var t=e.getData();r.default.Assert(t.gidLinked,"Must have valid accountID"),r.default.Assert(t.threadID,"Must have a valid threadID"),log("Handling deferred snooze: ",e);var i=j.a.getAccountEmail(t.gidLinked),a=new Date(t.scheduleDate);this.setLastModifiedDate(i,t.threadID,a),e.isPersistedRemote()?(this.removeLabelsFromMessage(i,t.threadID,void 0,[t.labelID],ChangeType.Auto),this.addLabelsToMessage(i,t.threadID,void 0,[Kt.INBOX,Kt.UNREAD],ChangeType.Auto)):(this.removeLabel(i,t.threadID,void 0,"Moo.do/Snoozed"),this.addLabel(i,t.threadID,void 0,Yt.INBOX),this.addLabel(i,t.threadID,void 0,Yt.UNREAD))},scheduleSendMessage:function(e,t,i){this.sendEvent("ScheduleMail");var a=Date.now()+i,n=new Date(a);this._getRemoteDraftID(e.getField("accountID"),e.id,t,function(t){if(t){this.addLabelFromAttachment(e,"Moo.do/ScheduledSend");var a={delay:i,scheduleDate:n.toISOString(),gidLinked:j.a.getAccountGID(e.getField("accountID")),threadID:e.id,draftID:t,labelID:this._getLabelByName(e.getField("accountID"),"Moo.do/ScheduledSend").getLabelID()};this.scheduleDeferredTask(t,bt.SendMail,n,a)}}.bind(this))},cancelSendMessage:function(e,t){this.sendEvent("UnscheduleMail"),this.removeLabelFromAttachment(e,"Moo.do/ScheduledSend"),this._getRemoteDraftID(e.getField("accountID"),e.id,t,function(e){e&&this.cancelDeferredTask(e,bt.SendMail)}.bind(this))},_handleDeferredSendMailTask:function(e){var t=e.getData();r.default.Assert(t.gidLinked,"Must have valid gidLinked"),r.default.Assert(t.threadID,"Must have a valid threadID"),log("Handling deferred send mail: ",t)},_ensureNoPriority:function(e){var t=VMLIFlag.None;return this.attachmentHasLabel(e,Qt.PRI0)&&(this.removeLabelFromAttachment(e,Qt.PRI0),t=VMLIFlag.P0),this.attachmentHasLabel(e,Qt.PRI1)&&(this.removeLabelFromAttachment(e,Qt.PRI1),t=VMLIFlag.P1),this.attachmentHasLabel(e,Qt.PRI2)&&(this.removeLabelFromAttachment(e,Qt.PRI2),t=VMLIFlag.P2),t},getAttachmentPriority:function(e){return this._attachmentHasPriorityLabel(e,VMLIFlag.P0)&&VMLIFlag.P0||this._attachmentHasPriorityLabel(e,VMLIFlag.P1)&&VMLIFlag.P1||this._attachmentHasPriorityLabel(e,VMLIFlag.P2)&&VMLIFlag.P2||VMLIFlag.None},setAttachmentPriority:function(e,t){this.sendEvent("SetMailPriority");var i=this._ensureNoPriority(e);switch(t){case VMLIFlag.None:break;case VMLIFlag.P0:this.addLabelToAttachment(e,Qt.PRI0);break;case VMLIFlag.P1:this.addLabelToAttachment(e,Qt.PRI1);break;case VMLIFlag.P2:this.addLabelToAttachment(e,Qt.PRI2);break;default:r.default.Assert(!1,"Invalid priority for email attachment")}return i},markAttachmentStarred:function(e){return this.sendEvent("StarMail"),this.addLabelToAttachment(e,Yt.STARRED)},markAttachmentUnstarred:function(e){return this.sendEvent("UnstarMail"),this.removeLabelFromAttachment(e,Yt.STARRED)},attachmentHasLabelByID:function(e,t){return this.hasLabelByID(e.getField("accountID"),e.id,void 0,t)},attachmentHasLabel:function(e,t){return this.hasLabel(e.getField("accountID"),e.id,void 0,t)},attachmentHasFullLabel:function(e,t){return this.hasFullLabel(e.getField("accountID"),e.id,t)},attachmentIsArchived:function(e){return this._threadIsArchived(e.getData())},addLabelToAttachment:function(e,t){return this.addLabel(e.getField("accountID"),e.id,void 0,t)},removeLabelFromAttachment:function(e,t){return this.removeLabel(e.getField("accountID"),e.id,void 0,t)},trashMail:function(e,t,i,a){var n=this.getAttachment(t);if(this.isAttachmentDraftOnly(n)){var s=n.getField("messages")[0];this.discardDraft(n,s.id,s.draftID,a)}else this.removeLabelsFromMessage(e,t,i,[Kt.INBOX],ChangeType.Local),this.addLabelsToMessage(e,t,i,[Kt.TRASH],ChangeType.Local),r.default.isTempId(t)?a(!0):this._trashRemoteMail(e,t,i,a)},untrashMail:function(e,t,i,a){this.removeLabelsFromMessage(e,t,i,[Kt.TRASH],ChangeType.Local),r.default.isTempId(t)?(this.addLabelsToMessage(e,t,i,[Kt.INBOX],ChangeType.Local),a(!0)):(this.addLabel(e,t,i,Yt.INBOX),this._untrashRemoteMail(e,t,i,a))},moveItem:function(e,t,i){return i.insertItem(t,0),[t,i]},unmoveItem:function(e,t,i){return i.removeChild(t,ChangeType.Local),[t,i]},hasLabelByID:function(e,t,i,a){return r.default.Assert(!i,"We don't support individual queries on messages, only threads"),this.getAttachment(t).getField("labelIds").indexOf(a)>=0},hasLabel:function(e,t,i,a){r.default.Assert(!i,"We don't support individual queries on messages, only threads");var n=!1;if(!i){var s=this._getLabelByName(e,a,!0);s&&(n=this.hasLabelByID(e,t,i,s.getLabelID()))}return n},hasFullLabel:function(e,t,i){var a=!1,n=this.getCacheData(t),s=this._getLabelByName(e,i,!0);if(s&&n){var r=0,o=n.messages;a=!0;for(var l=0;l<o.length;++l){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;if(o[l].labelIds.indexOf(s.getLabelID())<0){a=!1;break}}}return a},hasLabelLike:function(e,t,i){var a=!1,n=this.getAttachment(t);if(n){var s=n.getField("labelIds"),r=this._getAccountLib(e,this._labelsByID);if(r)for(var o=0,l=0;l<s.length;++l){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var d=r[s[l]];d&&d.isMatched(i)&&(a=!0)}}return a},addLabel:function(e,t,i,a){var n=this;r.default.Assert(!i,"We currently do not support setting labels on single messages"),r.default.Assert(!this.hasLabel(e,t,i,a),"Should not add the same label to a thread/message twice");var s=this._getLabelByName(e,a,!0);if(s)s.isLocalOnly()?this._createRemoteLabel(e,a,function(i){i&&(r.default.Assert(i,"Should have successfully created the remote label"),n._changeLabelID(e,s.getLabelID(),i.id),n._modifyRemoteThreadLabels(e,t,[i.id],void 0))}):this._modifyRemoteThreadLabels(e,t,[s.getLabelID()],void 0);else{var o=r.default.generateTempId();s=this._ensureLabel(e,o,a,void 0,void 0,ChangeType.Local),this._ensureVMLIsForLabel(e,s),this._writeLabelsToCache(function(i){i&&this._createRemoteLabel(e,a,function(i){r.default.Assert(i,"Should have successfully created the remote label"),i&&(this._changeLabelID(e,o,i.id),this._modifyRemoteThreadLabels(e,t,[i.id],void 0))}.bind(this))}.bind(this))}return this.addLabelsToMessage(e,t,i,[s.getLabelID()],ChangeType.Local),a},removeLabel:function(e,t,i,a){r.default.Assert(!i,"We currently do not support setting labels on single messages");var n=this._getLabelByName(e,a);return r.default.Assert(n,"Must have valid label for gmail in order to remove"),n&&(n.isLocalOnly()||this._modifyRemoteThreadLabels(e,t,void 0,[n.getLabelID()]),this.removeLabelsFromMessage(e,t,i,[n.getLabelID()],ChangeType.Local)),a},_threadIsArchived:function(e){if(e){var t=e.labelIds.indexOf(Kt.INBOX)>=0,i=this.hasFullLabel(e.accountID,e.id,Yt.TRASH),a=e.labelIds.indexOf(Kt.SPAM)>=0,n=this.hasFullLabel(e.accountID,e.id,Yt.DRAFT);return!(r.default.isTempId(e.id)||t||i||a||n)}return!1},_trashRemoteMail:function(e,t,i,a){var n,s,o=this;r.default.Assert(!r.default.isTempId(t),"Should not try to trash local only threads"),r.default.Assert(!i||!r.default.isTempId(i),"Should not try to trash local only messages"),i?(n=I.a.fns("gmail").users.messages.trash.packedFn,s={userId:e,id:i}):(n=I.a.fns("gmail").users.threads.trash.packedFn,s={userId:e,id:t});this._queueRemoteRequestMulti(e,n,s,function(){a(!0)},function(t){a(!1,t),o._notifyFailedRequest(e,t)},void 0,Rt)},_untrashRemoteMail:function(e,t,i,a){var n,s,o=this;r.default.Assert(!r.default.isTempId(t),"Should not try to untrash local only threads"),r.default.Assert(!i||!r.default.isTempId(i),"Should not try to untrash local only messages"),i?(n=I.a.fns("gmail").users.messages.untrash.packedFn,s={userId:e,id:i}):(n=I.a.fns("gmail").users.threads.untrash.packedFn,s={userId:e,id:t});this._queueRemoteRequestMulti(e,n,s,function(){a(!0)},function(t){a(!1,t),o._notifyFailedRequest(e,t)},void 0,Rt)},_createRemoteLabel:function(e,t,i){var a=this,n=I.a.fns("gmail").users.labels.create.packedFn,s={userId:e,resource:{name:t,labelListVisibility:"labelHide",messageListVisibility:"hide"}};this._queueRemoteRequestMulti(e,n,s,function(e){i&&i(e)},function(t){r.default.isHTTPStatusCode(t,l.a.HTTPStatusCode.Conflict)?i&&i(void 0,t):(i&&i(void 0,t),a._notifyFailedRequest(e,t))},void 0,kt)},_modifyRemoteThreadLabels:function(e,t,i,a,n){var s=this,r=I.a.fns("gmail").users.threads.modify.packedFn,o={userId:e,id:t,resource:{addLabelIds:i,removeLabelIds:a}};this._queueRemoteRequestMulti(e,r,o,function(e){n&&n(e)},function(t){n&&n(void 0,t),s._notifyFailedRequest(e,t)},void 0,xt)},_ensureRemoteLabel:function(e,t,i,a){this._getLabelByName(e,t,!0)?a&&a(!0):(this._ensureLabel(e,r.default.generateTempId(),t,void 0,void 0,i),this._createRemoteLabel(e,t,function(e,t){r.default.Assert(e||r.default.isHTTPStatusCode(t,l.a.HTTPStatusCode.Conflict),"Should have successful root label creation"),a&&a(!!e)}))},_createInMemoryLabel:function(e,t,i,a,n,s){var r=new nt(e,t,i,this._clampSyncTime(a),n,s);s[t]=r,this._ensureAccountLib(e,this._labelsByName)[i]=r},_updateLabelName:function(e,t){var i=e.getAccountID(),a=this._getAccountLib(i,this._labelsByName);r.default.Assert(a,"Must have valid label name bucket"),r.default.Assert(a[e.getRawName()],"Must have valid label in bucket"),e.updateLabelName(t),delete a[e.getRawName()],a[t]=e},_ensureLabel:function(e,t,i,a,n,s){var o=this._ensureAccountLib(e,this._labelsByID);if(o[t])!r.default.isRemoteChange(s)&&o[t].hasName()||o[t].isSystemLabel()||this._updateLabelName(o[t],i);else{var l=this._getLabelByName(e,i,!0);l?l.isLocalOnly()&&!r.default.isTempId(t)?this._changeLabelID(e,l.getLabelID(),t):l.isLocalOnly()||(o[t]=l):(r.default.Assert(i||!r.default.isTempId(t),"All local labels must have a valid name"),this._createInMemoryLabel(e,t,i,a,n,o))}return o[t]},_clampSyncTime:function(e){return e&&e.isBefore(this._getMetadataSyncTime())?this._getMetadataSyncTime():e},_ensureLabelVMLIsForAccount:function(e){var t=this._getAccountLib(e,this._labelsByID);for(var i in t)t.hasOwnProperty(i)&&this._ensureVMLIsForLabel(e,t[i])},_changeLabelID:function(e,t,i){var a=this._getLabelByID(e,t,!0);r.default.vmMain.beginUpdateItems(),a.updateLabelID(i),this._getAccountLib(e,this._labelsByID)[i]=a,this._ensureVMLIsForLabel(e,a),r.default.vmMain.commitUpdateItems(),this.forEachAttachment(function(e){var a=e.getField("labelIds");if(a.remove(t)>=0){for(var n=0,s=e.getField("messages"),r=0;r<s.length;++r){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;s[r].labelIds.remove(t)>=0&&s[r].labelIds.push(i)}a.push(i),e.updateField("labelIds",a)}});var n=this.getDefaultItemStore(),s="L~"+e+"~"+t;n.hasItem(s)&&n.destroyItem(s)},labelExists:function(e,t){var i=this._getAccountLib(e,this._labelsByID);return i&&i[t]},_getLabelByID:function(e,t){r.default.Assert(e,"Must supply a valid accountID"),r.default.Assert(t,"Must supply a valid labelID");var i=this._ensureAccountLib(e,this._labelsByID);if(!i[t]){var a=Yt[t];this._createInMemoryLabel(e,t,a,void 0,void 0,i)}return i[t]},_getLabelByName:function(e,t,i){r.default.Assert(this.hasSyncAccount(e),"Must provide a valid accountID with a matching sync account: "+e);var a,n=this._getAccountLib(e,this._labelsByName);return r.default.Assert(i||n,"Unable to find labelsByName for given account: "+e),n&&(a=n[t]),a},_getPriorityLabel:function(e,t){var i=this._ensureAccountLib(e,this._priorityLabels);if(!i[t]){var a;switch(t){case VMLIFlag.P0:a=Qt.PRI0;break;case VMLIFlag.P1:a=Qt.PRI1;break;case VMLIFlag.P2:a=Qt.PRI2;break;default:r.default.Assert(!1,"Invalid priority for email attachment")}i[t]=this._getLabelByName(e,a)}return i[t]},_getAccountLib:function(e,t){var i;if(r.default.Assert(e,"Must provide valid accountID"),r.default.Assert(t,"Must provide valid lib object"),e)if(t[e])i=t[e];else for(var a in t)a.toUpperCase()===e.toUpperCase()&&r.default.Assert(!1,"Mismatch case request found for accountIDs: "+e,a);return i},_ensureAccountLib:function(e,t){var i;if(r.default.Assert(e,"Must provide valid accountID"),r.default.Assert(t,"Must provide valid lib object"),e)if(t[e])i=t[e];else{for(var a in t)t.hasOwnProperty(a)&&r.default.Assert(!e||!a||a.toUpperCase()!==e.toUpperCase(),"Dupe accountID found with non-matching case: "+e,a);i=t[e]={}}return i},_deleteAccountLib:function(e,t){r.default.Assert(e,"Must provide valid accountID"),r.default.Assert(t,"Must provide valid lib object"),r.default.Assert(t[e],"Trying to delete an account lib that doesnt exist: ",e),delete t[e]},_attachmentHasPriorityLabel:function(e,t){var i=this._getPriorityLabel(e.getField("accountID"),t);return!!i&&e.getField("labelIds").indexOf(i.getLabelID())>=0},getLabels:function(e,t,i){var a=[],n=t.toLowerCase(),s=0,r=this._labelsByID[e];for(var o in r)if(r.hasOwnProperty(o)){var l=r[o];if(l.matchesText(n)&&this.isDisplayTag(l)&&a.indexOf(l)<0&&(a.push(l),s++),i&&s>=i)break}return a},_writeLabelsToCache:function(e){var t={};for(var i in this._labelsByID)if(this._labelsByID.hasOwnProperty(i)){t[i]={};var a=this._labelsByID[i];for(var n in a)a.hasOwnProperty(n)&&(t[i][n]=a[n].getSaveData())}this._threadCache.setMetadata(Gt,t,e)},_writeSendAsToCache:function(e){var t={};this._iterateSendAs(function(e,i){t[e]||(t[e]=[]),t[e].push(i)}),this._threadCache.setMetadata(jt,t,e)},runLabelSync:function(e){this._threadCache.onCacheMetadataReady(function(){for(var t=this,i=0,a=this.getSyncAccounts(),n=a.length,s=0,o=0,l=function(i,a){r.default.vmMain.beginUpdateItems();var l={};if(a)for(var d=0,u=0;u<a.length;++u){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;var c,h=a[u];l[h.id]=!0,c="system"===h.type&&Yt[h.id]?Yt[h.id]:h.name,t._ensureLabel(i,h.id,c,void 0,h,ChangeType.Remote)}t._ensureLabelVMLIsForAccount(i),t._ensureRemoteLabel(i,"Moo.do",ChangeType.Local),t._ensureRemoteLabel(i,Qt.PRI0,ChangeType.Local),t._ensureRemoteLabel(i,Qt.PRI1,ChangeType.Local),t._ensureRemoteLabel(i,Qt.PRI2,ChangeType.Local),t._ensureRemoteLabel(i,"Moo.do/Snoozed",ChangeType.Local),t._ensureRemoteLabel(i,"Moo.do/Handled",ChangeType.Local),t._ensureRemoteLabel(i,"Moo.do/Scheduled",ChangeType.Local);var f=t._getAccountLib(i,t._labelsByID);if(f)for(var p in f)if(f.hasOwnProperty(p)){var g=f[p];g.isLocalOnly()?(r.default.Assert(g.hasName(),"Label must have a valid name to be created on remote"),t._createRemoteLabel(i,g.getName(),function(e,t){t&&this._changeLabelID(i,e,t.id)}.bind(t,p))):0!==o||l[p]||g.isSystemOrSpecialLabel()||r.default.isDemoMode()||g.delete()}r.default.vmMain.commitUpdateItems(),t._writeLabelsToCache(),o+s===n&&e&&e()},d=function(e,t){s++,l(e,t.labels)},u=function(e,i){o++,l(e),t._notifyFailedRequest(e,i)},c=0;c<a.length;++c){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var h=I.a.fns("gmail").users.labels.list.packedFn,f={userId:a[c],timeoutMS:0};this._queueRemoteRequestMulti(a[c],h,f,d.bind(this,a[c]),u.bind(this,a[c]),void 0,Et)}}.bind(this))},getDescriptorForItem:function(e){r.default.Assert(e,"Must have a valid item to get a description for");var t=this._getAccountIDFromItem(e),i=this._getLabelIDFromItem(e),a={accountID:t,labelID:i,threadID:this._getThreadIDFromItem(e)};if(t&&i){var n=this._getLabelByID(t,i);a.labelName=n.getName()}return a},handleItemChange:function(e,t){var i=this;this._threadCache.onCacheReady(function(){i._threadCache.onCacheMetadataReady(function(){var a=i.getDescriptorForItem(e);a.labelID&&(r.default.Assert(a.accountID,"Must specify a valid accountID"),i._getThreadsForLabel(a.accountID,i._getLabelByID(a.accountID,a.labelID),e,function(e){r.default.Assert(e,"Expected success when querying for remote threads"),t&&t()}))})})},handleViewModeChange:function(e,t){t===l.a.GmailViewMode.Priority&&this._threadCache.onCacheReady(function(){var t=this._getAccountIDFromItem(e);r.default.Assert(t,"Missing Account ID: ",e.id);var i=this._getLabelByName(t,Qt.PRI0);i&&this._getThreadsForLabel(t,i,void 0,function(e){r.default.Assert(e,"Expected success when querying for remote PRI0 threads")});var a=this._getLabelByName(t,Qt.PRI1);a&&this._getThreadsForLabel(t,a,void 0,function(e){r.default.Assert(e,"Expected success when querying for remote PRI1 threads")});var n=this._getLabelByName(t,Qt.PRI2);n&&this._getThreadsForLabel(t,n,void 0,function(e){r.default.Assert(e,"Expected success when querying for remote PRI2 threads")})}.bind(this))},_getThreadsForLabel:function(e,t,i,a){r.default.Assert(t,"Must provide a valid label to get thrads for");var n="-in:chats -in:spam label:"+t.getName(),s=t.getOldestSync();r.default.isDateValid(s)&&(n+=" before:"+Math.floor(s.getTime()/1e3));var o=new Date,l=function(t){if(t){var i=this._addRemoteEntry(e,t);i.internalDate.isBefore(o)&&(o=i.internalDate),this.cacheThreadData(i.id,this.serializeExternalData(i))}}.bind(this),d=function(e){t.setOldestSync(o),this._writeLabelsToCache(),a(e)}.bind(this),u=new St(l,d);this._requestRemoteThreads(e,Ot,i,n,25,void 0,u.getEntryCB(),u.getDoneCB())},createOutlinePaneItem:function(e,t){for(var i=0,a=t.getItemStore(),n=e.getRawText(),s=e.getAttachmentByPlugin(this.id),o=this.getDisplayTags(s,void 0,!0),l=0;l<o.length;++l){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;n+=" #"+o[l]}return a.createItem(r.default.generateTempId(),n,t.id,void 0,ChangeType.Local)},refreshCurrentView:function(){this._forceThreadSync()},goOnline:function(){this._forceThreadSync(this._notifyPendingDraftUpdate.bind(this))},loadInitialData:function(){this._super.loadInitialData.call(this),r.default.isDemoMode()&&this._forceThreadSync()},_forceThreadSync:function(e){this.hasRecurringTask("GmailThreadSync")&&this.getRecurringTask("GmailThreadSync").forceUpdate(e)},_forceLabelSync:function(e){this.hasRecurringTask("GmailLabelSync")&&this.getRecurringTask("GmailLabelSync").forceUpdate(e)},_syncOfflineChanges:function(){r.default.Assert(!1,"Currently we do not perform a sync offline step for Gmail changes"),this._syncingOfflineChanges||(this._syncingOfflineChanges=!0)},_cleanupLocalCaches:function(e){r.default.Assert(r.default.isFunction(e),"Must have a valid callback when cleaning local caches");var t=0,i=0,a=this._getFullSyncTime(),n=this._getUnreadSyncTime(),s=this._getMetadataSyncTime();this._threadCache.getFilterEntries(function(e){return e&&e.date&&e.date.isBefore(a)},function(a){if(a)for(var r=0,o=0;o<a.length;++o){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;var l=a[o],d=!0;if(!l.date.isBefore(n))for(var u=0,c=0;d&&c<l.messages.length;++c){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;var h=l.messages[c];if(this.isPriorityData(h)){d=!1;break}}if(d){var f=0;l.date.isBefore(s)&&(this._threadCache.removeEntry(l.id),t++);for(var p=0;p<l.messages.length;++p){if(f++>5e3&&__infLoop&&__infLoop(f))throw new RangeError;var g=l.messages[p];this._rawCache.removeEntry(g.id),i++}}}log("Gmail Cache Pruned: ",t,i),e(!1)}.bind(this))},_cleanupRawCache:function(e){r.default.Assert(r.default.isFunction(e),"Must have a valid callback when cleaning local caches");var t=0,i=this._getUnreadSyncTime();this._rawCache.getFilterEntries(function(e){return!e.internalDate||new Date(parseInt(e.internalDate)).isBefore(i)},function(i){if(i)for(var a=0,n=0;n<i.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=i[n];this._rawCache.removeEntry(s.id),t++}log("Raw Cache Pruned: ",t),e()}.bind(this))},getAccountSetting:function(e,t){var i,a=this._getAccountLib(e,this._accountSettings);return a&&(i=a[t]),i},setAccountSetting:function(e,t,i){var a,n=this._ensureAccountLib(e,this._accountSettings);return a=n[t],n[t]=i,a},runSettingsSync:function(){this._getSettingsSendAs(function(e){for(var t in e)e.hasOwnProperty(t)&&this.setAccountSetting(t,"sendAs",e[t]);this._writeSendAsToCache(function(){})}.bind(this))},_getSyncDays:function(){var e=this.getSetting(this.Settings.SyncTime);r.default.billingManager.isTrialOver()&&(e=l.a.MaxGmailSyncTime.Free);var t=r.default.vmMain.pluginManager.getCacheSizeRatio();return t<1&&t>0&&(e=Math.round(e*t)),e},_getMetadataSyncDays:function(){var e=Math.max(this.getSetting(this.Settings.SyncTime),15),t=r.default.vmMain.pluginManager.getCacheSizeRatio();return t<.5&&(e=Math.max(Math.round(e*t),7)),e},_getUnreadSyncTime:function(){var e=this._getSyncDays();return(new Date).addDays(-1.5*e)},_getFullSyncTime:function(){var e=this._getSyncDays();return(new Date).addDays(-e)},_getMetadataSyncTime:function(){var e=this._getMetadataSyncDays();return(new Date).addDays(-e)},_getFullSyncTimeStr:function(){return this._getSyncDays()+"d"},_getMetadataSyncTimeStr:function(){return this._getMetadataSyncDays()+"d"},runThreadSync:function(e){var t,i=0,a=0,n=[],s=[],o=function(o,d,u){o?(i++,n.push(d)):(a++,!r.default.isHTTPStatusCode(u,l.a.HTTPStatusCode.Network)&&r.default.vmMain.isOnline()&&s.push(d)),a+i===t&&(s.length>0?r.default.toasts.pushMessage(MessageID.EmailSyncFail):r.default.toasts.clearMessage(MessageID.EmailSyncFail),n.length>0&&this._contentSyncTask.requestRun(),e&&e(0===s.length))}.bind(this),d=!1,u=this._getSyncDays();void 0!==this._lastSyncTime&&this._lastSyncTime<u&&(d=!0,log("Forcing full gmail sync")),this._lastSyncTime=u,this._threadCache.onCacheMetadataReady(function(){this._threadCache.getMetadata(Wt,function(e){var i=0,a=this.getSyncAccounts();t=a.length;for(var n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s;if(!d){var r=e?e[a[n]]:void 0;s=r?r.historyID:void 0}this.performThreadSync(a[n],s,o)}}.bind(this))}.bind(this))},performThreadSync:function(e,t,i){t?(Date.now()-this._lastCacheCleanup>r.default.hours(12)&&(this._lastCacheCleanup=Date.now(),this._cacheCleanup.notifyWorkAvailable()),this._performThreadSyncPartial(e,t,i)):this._performThreadSyncFull(e,i)},_performThreadSyncFull:function(e,t){var i,a=this,n="-in:chats -in:spam newer_than:"+this._getMetadataSyncTimeStr(),s=this.getDefaultItemStore(),o=this._ensureVMLIsForAccount(e,s);o.clearPaginationToken();var l=new St(function(t){if(t&&(!i&&t.historyId&&(i=t.historyId,a.setHistoryID(e,i)),a._shouldCacheThread(t))){var n=a._addRemoteEntry(e,t);a.cacheThreadData(n.id,a.serializeExternalData(n))}},function(i){t(i,e)});this._requestRemoteThreads(e,At,o,n,999,0,l.getEntryCB(),l.getDoneCB()),this._getThreadsForLabel(e,this._getLabelByID(e,Kt.UNREAD),void 0,function(e){r.default.Assert(e,"Expect to be able to get all unread messages")})},_compactHistoryEntries:function(e){for(var t=0,i={messages:{},messagesAdded:{},messagesDeleted:{},labelsAdded:{},labelsRemoved:{}},a=0;a<e.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e[a],s=0;if(n.messagesAdded){for(var o=0,l=0;l<n.messagesAdded.length;++l){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var d=n.messagesAdded[l].message,u=i.messagesAdded[d.threadId];u||(u=i.messagesAdded[d.threadId]=[]),u.indexOf(d.id)<0&&u.push(d.id)}s+=n.messagesAdded.length}if(n.messagesDeleted){for(var c=0,h=0;h<n.messagesDeleted.length;++h){if(c++>5e3&&__infLoop&&__infLoop(c))throw new RangeError;var f=n.messagesDeleted[h].message,p=i.messagesDeleted[f.threadId];p||(p=i.messagesDeleted[f.threadId]=[]),p.indexOf(f.id)<0&&p.push(f.id)}s+=n.messagesDeleted.length}if(n.labelsAdded){for(var g=0,m=0;m<n.labelsAdded.length;++m){if(g++>5e3&&__infLoop&&__infLoop(g))throw new RangeError;var v=n.labelsAdded[m].message,_=i.labelsAdded[v.threadId];_||(_=i.labelsAdded[v.threadId]={}),_[v.id]||(_[v.id]=[]),_[v.id].pushOnlyUniques(n.labelsAdded[m].labelIds)}s+=n.labelsAdded.length}if(n.labelsRemoved){for(var y=0,S=0;S<n.labelsRemoved.length;++S){if(y++>5e3&&__infLoop&&__infLoop(y))throw new RangeError;var w=n.labelsRemoved[S].message,I=i.labelsRemoved[w.threadId];I||(I=i.labelsRemoved[w.threadId]={}),I[w.id]||(I[w.id]=[]),I[w.id].pushOnlyUniques(n.labelsRemoved[S].labelIds)}s+=n.labelsRemoved.length}if(r.default.Assert(0===s||s===n.messages.length,"Must have handled all or none of the generic messages"),0===s)for(var b=0,A=0;A<n.messages.length;++A){if(b++>5e3&&__infLoop&&__infLoop(b))throw new RangeError;var D=n.messages[A],T=i.messages[D.threadId];T||(T=i.messages[D.threadId]=[]),T.indexOf(D.id)<0&&T.push(D.id)}}var M={messages:[],messagesAdded:[],messagesDeleted:[],labelsAdded:[],labelsRemoved:[]};for(var C in i.messages)i.messages.hasOwnProperty(C)&&M.messages.push({id:C,msgIDs:i.messages[C]});for(var L in i.messagesAdded)i.messagesAdded.hasOwnProperty(L)&&!i.messages[L]&&M.messagesAdded.push({id:L,msgIDs:i.messagesAdded[L]});for(var P in i.messagesDeleted)i.messagesDeleted.hasOwnProperty(P)&&!i.messages[P]&&M.messagesDeleted.push({id:P,msgIDs:i.messagesDeleted[P]});for(var E in i.labelsAdded)if(i.labelsAdded.hasOwnProperty(E)&&!i.labelsAdded[E])for(var k in i.labelsAdded[E])i.labelsAdded[E].hasOwnProperty(k)&&M.labelsAdded.push({id:E,msgID:k,labelIDs:i.labelsAdded[E][k]});for(var x in i.labelsRemoved)if(i.labelsRemoved.hasOwnProperty(x)&&!i.messages[x])for(var R in i.labelsRemoved[x])i.labelsRemoved[x].hasOwnProperty(R)&&M.labelsRemoved.push({id:x,msgID:R,labelIDs:i.labelsRemoved[x][R]});return M},_performThreadSyncPartial:function(e,t,i){var a=this,n=I.a.fns("gmail").users.history.list.packedFn,s={userId:e,startHistoryId:t},o={getAllPages:!0,maxPageResults:999,resultsField:"history",timeoutMS:0},d=function(e,t){log("History Sync Request Failed: ",e,t)},u=function(t){t&&t.error&&t.error.code===l.a.HTTPStatusCode.NotFound?this._clearCachedData(e,function(a){a?this.performThreadSync(e,void 0,i):i(!1,e,t)}.bind(this)):(i(!1,e,t),this._notifyFailedRequest(e,t))}.bind(this);this._queuePagedRemoteRequestMulti(e,n,s,function(t,n,s){var o;s&&(o=s.historyId,a.setHistoryID(e,o)),r.default.vmMain.beginUpdateItems();var l=a._compactHistoryEntries(t);a._handleCompactHistory(e,l,d),r.default.vmMain.commitUpdateItems(),i(!0,e)},u,void 0,Dt,o)},_handleCompactHistory:function(e,t,i){for(var a=0,n=0,s=0,r=0,o=0,l=0,d=0;d<t.messages.length;++d){var u=0;if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;for(var c=t.messages[d],h=0;h<c.msgIDs.length;++h){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;this._handleMessageUpdated(e,c.id,c.msgIDs[h],i),l++}}for(var f=0;f<t.messagesAdded.length;++f){var p=0;if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;for(var g=t.messagesAdded[f],m=0;m<g.msgIDs.length;++m){if(p++>5e3&&__infLoop&&__infLoop(p))throw new RangeError;this._handleMessageAdded(e,g.id,g.msgIDs[m],i),l++}}for(var v=0;v<t.messagesDeleted.length;++v){var _=0;if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;for(var y=t.messagesDeleted[v],S=0;S<y.msgIDs.length;++S){if(_++>5e3&&__infLoop&&__infLoop(_))throw new RangeError;this._handleMessageDeleted(e,y.id,y.msgIDs[S]),l++}}for(var w=0;w<t.labelsAdded.length;++w){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;var I=t.labelsAdded[w];this._handleLabelsAdded(e,I.id,I.msgID,I.labelIDs),l++}for(var b=0;b<t.labelsRemoved.length;++b){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var A=t.labelsRemoved[b];this._handleLabelsRemoved(e,A.id,A.msgID,A.labelIDs),l++}return l},_handleMessageAdded:function(e,t,i,a){this.refreshThreadCacheData(e,t,i,a)},_handleMessageDeleted:function(e,t,i){this._deleteCachedMessage(e,t,i)},_handleLabelsAdded:function(e,t,i,a){this.addLabelsToMessage(e,t,i,a,ChangeType.Remote)},_handleLabelsRemoved:function(e,t,i,a){this.removeLabelsFromMessage(e,t,i,a,ChangeType.Remote)},_handleMessageUpdated:function(e,t,i,a){this.refreshThreadCacheData(e,t,i,a)},getLastSyncTime:function(e,t){this._threadCache.getMetadata(Wt,function(i){var a;if(i){var n=i[e];n&&n.date&&(a=new Date(n.date))}t(a)})},getAllLastSyncTimes:function(e){this._threadCache.getMetadata(Wt,function(t){for(var i=0,a={},n=this.getSyncAccounts(),s=0;s<n.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=n[s],o=t?t[r]:void 0;o&&o.date?a[r]=new Date(o.date):a[r]=void 0}e(a)}.bind(this))},setHistoryID:function(e,t,i){r.default.Assert(r.default.isString(e),"Must provide a valid account ID to set history ID"),r.default.Assert(r.default.isString(t),"Must provide a valid history ID to set"),this._threadCache.getMetadata(Wt,function(a){(a=a||{})[e]={historyID:t,date:Date.now()},this._threadCache.setMetadata(Wt,a,i)}.bind(this))},clearHistoryID:function(e,t){r.default.Assert(r.default.isString(e),"Must provide a valid account ID to clear history ID for"),r.default.Assert(r.default.isFunction(t),"Must provide valid CB function when clearing history ID"),this._threadCache.getMetadata(Wt,function(i){i?(delete i[e],this._threadCache.setMetadata(Wt,i,t)):t(!1)}.bind(this))},clearCachedLabel:function(e,t){r.default.Assert(r.default.isString(e),"Must provide a valid account ID to clear history ID for"),r.default.Assert(r.default.isFunction(t),"Must provide valid CB function when clearing history ID"),this._threadCache.getMetadata(Gt,function(i){i?(delete i[e],this._threadCache.setMetadata(Gt,i,t)):t(!1)}.bind(this))},_clearCachedData:function(e,t){this.clearHistoryID(e,function(i){i?this.clearCachedLabel(e,function(i){i?this.clearAccountThreadCache(e,t):t(!1)}.bind(this)):t(!1)}.bind(this))},clearAccountThreadCache:function(e,t){r.default.Assert(r.default.isString(e),"Must provide a valid account ID to clear thread cache for"),r.default.Assert(r.default.isFunction(t),"Must provide valid CB function when clearing thread cache");this._threadCache.getFilterEntries(function(t){return t.accountID===e},function(i){if(i){var a=0;log("Clearing account thread cache: "+e);for(var n=0;n<i.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=i[n];if(this._threadCache.removeEntry(s.id),s.messages)for(var r=0,o=0;o<s.messages.length;++o){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;this._rawCache.removeEntry(s.messages[o].id)}}t(!0)}else t(!1)}.bind(this))},requestDataPage:function(e,t){log("Data Page: ",e.hasPaginationToken()),e.hasPaginationToken()&&!e.paginationTokenInUse()?this._requestRemoteThreads(void 0,Lt,e,void 0,25,void 0,void 0,t):t(!0)},_requestRemoteThreads:function(e,t,i,a,n,s,o,l){var d;if(i&&i.hasPaginationToken()&&!i.paginationTokenInUse()){if(d=i.beginDataPageLoad(),r.default.Assert(!a,"Should not define a new q for paged token"),r.default.Assert(!o,"Should not define a new entryCB for paged token"),a=d.getQuery(),n=d.getMaxResults(),o=d.getEntryCB(),l){var u=l;l=function(){d.getDoneCB().apply(null,arguments),u.apply(null,arguments)}}else l=d.getDoneCB();e=e||d.getInfo().accountID}else i&&i.needsPaginationToken()&&(d=this.createPaginationToken(void 0,a,{accountID:e},n,o,l),i.setPaginationToken(d),i.beginDataPageLoad());n=n||25,r.default.Assert(o&&r.default.isFunction(o),"Must define a valid entry callback"),r.default.Assert(l&&r.default.isFunction(l),"Must define a valid done callback");var c,h,f=I.a.fns("gmail").users.threads.list.packedFn,p={userId:e,maxResults:n,timeoutMS:s,q:a,pageToken:d&&d.hasMorePages()?d.getNextPageToken():void 0};d||!i?(c=function(t){if(t.nextPageToken&&d&&this.updatePaginationToken(d,t.nextPageToken),i&&d&&i.endDataPageLoad(!!t.nextPageToken),t.threads)for(var a=0,n=t.threads.length,s=0,r=0,u=function(e){e?(o(e),s++):(o(void 0),r++),s+r===n&&l(!0)},c=0;c<t.threads.length;++c){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var h=t.threads[c];this._requestRemoteThreadMetadata(e,h.id,void 0,u)}else l(!0)}.bind(this),h=function(t){i&&d&&i.endDataPageLoad(d),l(!1),this._notifyFailedRequest(e,t)}.bind(this)):(c=function(){l(!0)},h=function(t){l(!1),this._notifyFailedRequest(e,t)}.bind(this)),this._queueRemoteRequestMulti(e,f,p,c,h,void 0,t)},_requestRemoteMessageData:function(e,t,i){r.default.Assert(!e.isLocalOnlyAttachment(),"Should never request remote data for a local only attachment");var a=I.a.fns("gmail").users.messages.get.packedFn,n={userId:e.getField("accountID"),id:t,format:"full"},s=function(a){var n=this._parseMailMessage(a);r.default.Assert(n,"Must be able to parse message"),this._updateMessageData(e,t,n),i(!0)}.bind(this),o=function(t){i(!1,t),this._notifyFailedRequest(e.getField("accountID"),t)}.bind(this);this._queueRemoteRequestMulti(e.getField("accountID"),a,n,s,o,void 0,qt)},_requestRemoteMessageDataRaw:function(e,t,i,a){var n=I.a.fns("gmail").users.messages.get.packedFn,s={userId:e,id:i,format:"full"},r=function(t){a(void 0,t),this._notifyFailedRequest(e,t)}.bind(this);this._queueRemoteRequestMulti(e,n,s,a,r,void 0,qt)},_requestRemoteThreadDataRaw:function(e,t,i){var a=I.a.fns("gmail").users.threads.get.packedFn,n={userId:e,id:t,format:"full"},s=function(t){i(void 0,t),this._notifyFailedRequest(e,t)}.bind(this);this._queueRemoteRequestMulti(e,a,n,i,s,void 0,Tt)},_requestRemoteThreadMetadata:function(e,t,i,a){var n=I.a.fns("gmail").users.threads.get.packedFn,s={userId:e,id:t,format:"metadata"},r=function(t){a(void 0,t),this._notifyFailedRequest(e,t)}.bind(this);this._queueRemoteRequestMulti(e,n,s,function(e){a(e)},r,i,Mt)},_persistRemoteSnoozeTask:function(e,t){var i=e.getData();r.default.XHR_PrivateAPI({type:"POST",path:"/tasks/snoozeMail",data:i,requireAuth:!0,autoRetry:!1,cb:this._handleRemotePersist.bind(this,t)})},_cancelDeferredSnoozeTask:function(e,t){var i=e.getData();r.default.XHR_PrivateAPI({type:"POST",path:"/tasks/snoozeMail/cancel",data:i,requireAuth:!0,autoRetry:!1,cb:function(e){t(e.status===l.a.HTTPStatusCode.Success)}})},_persistRemoteSendMailTask:function(e,t){var i=e.getData();r.default.XHR_PrivateAPI({type:"POST",path:"/tasks/sendMail",data:i,requireAuth:!0,autoRetry:!1,cb:this._handleRemotePersist.bind(this,t)})},_cancelDeferredSendMailTask:function(e,t){var i=e.getData();r.default.XHR_PrivateAPI({type:"POST",path:"/tasks/sendMail/cancel",data:i,requireAuth:!0,autoRetry:!1,cb:function(e){t(e.status===l.a.HTTPStatusCode.Success)}})},_handleRemotePersist:function(e,t){if(t.status!==l.a.HTTPStatusCode.Success)return e(!1);try{return e(!0,JSON.parse(t.response).data.messageID)}catch(t){return r.default.reportError(t),e(!1)}},_parseMailThread:function(e,t){for(var i=0,a=[],n=0;n<t.messages.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this._parseMailMessage(t.messages[n]);r.default.Assert(s,"Must be able to parse each message"),s&&a.push(s)}var o=e.getField("messages");this._mergeMessagesData(o,a,["labelIds","draftID"]),e.updateField("dataLoaded",!0),e.updateField("messages",a),this._updateAttachmentFromMessages(e,ChangeType.Remote)},getAttachmentURL:function(e,t,i){return"https://mail.google.com/mail/b/"+e+"/?ui=2&view=att&disp=safe&zw"+("&th="+t)+("&attid="+i)},getPreviewURL:function(e){return e.link},reportMessage:function(e,t,i,a,n){var s=I.a.fns("gmail").users.messages.get.packedFn,o={userId:e,id:i,format:"full",forceNoDupe:!0};this._queueRemoteRequestMulti(e,s,o,this._sendReport.bind(this,n,a),function(){r.default.Assert(!1,"Failed to report message")},void 0,qt)},dumpMessage:function(e,t,i){var a=this.getAttachment(t),n=this._getMessageFromAttachment(a,i);console.log("Message Dump: ",n)},_sanitizeMessage:function(e){if(e.parts)for(var t=0,i=0;i<e.parts.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this._sanitizeMessage(e.parts[i])}if(e.body&&e.body.data){var a=this._runDecodeEmail(e);a&&a.mimeType===ui?e.body.data=this._encodeEmail(st.a.sanitizeContent(a.decoded)):e.body.data=this._encodeEmail(st.a.sanitizePlaintext(a.decoded))}if(e.headers)for(var n=0,s=0;s<e.headers.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var r=e.headers[s];switch(r.name.toUpperCase()){case"TO":case"CC":case"BCC":case"FROM":r.value=r.value.replace(/[A-Za-z0-9]/g,"#");break;case"SUBJECT":case"SNIPPET":r.value=new Array(r.name.length+1).join("#")}}},_sendReport:function(e,t,i){r.default.Assert(r.default.isBoolean(e),"Must provide a valid boolean for sendContent"),r.default.Assert(r.default.isString(t),"Must provide a valid description string"),r.default.Assert(r.default.isObject(i),"Must provide valid raw data");try{log("Sending Message Report",i),e||this._sanitizeMessage(i.payload);var a={description:t,payload:i.payload};r.default.reportError(new Error("Report Message"),a)}catch(e){r.default.reportError(e)}},loadResource:function(e,t,i,a){if(this.hasCacheData(e)){var n=this.getAttachment(e),s=this._getMessageFromAttachment(n,t).resources.find(i);s?(s.data?a(s,i):this._requestRemoteAttachment(n.getField("accountID"),t,s.id,function(e,t){e&&(s.data=e,s.size=t),a(s,i)}),this.sendEvent("FetchAttachment")):a(void 0,i)}else a(void 0,i)},_requestRemoteAttachment:function(e,t,i,a){var n=I.a.fns("gmail").users.messages.attachments.get.packedFn,s={id:i,messageId:t,userId:e},r=function(t){a(void 0),this._notifyFailedRequest(e,t)}.bind(this);this._queueRemoteRequestMulti(e,n,s,function(e){a(e.data.replace(/-/g,"+").replace(/_/g,"/"),e.size)},r,void 0,Ht)},_parseAttachment:function(e,t,i){var a,n,s,o,l;r.default.Assert(e,"Must have valid multipart lib"),r.default.Assert(i.body,"Must have a valid attachment body"),r.default.Assert(i.body.attachmentId,"Must have a valid attachment ID");var d="0."+i.partId;if(i.headers)for(var u=0,c=0;c<i.headers.length;++c){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;var h=i.headers[c];switch(h.name.toUpperCase()){case"CONTENT-ID":var f=/^<(.*)>$/.exec(h.value);n=a=f?f[1]:h.value;break;case"CONTENT-TRANSFER-ENCODING":l=h.value;break;case"CONTENT-DISPOSITION":var p=h.value.split(";");o=p[0]?p[0].toLowerCase():void 0;break;case"X-ATTACHMENT-ID":s=h.value}}a&&o!==pi||!i.filename?!a&&i.body.attachmentId&&(a=i.body.attachmentId):a=i.filename,r.default.Assert(a,"Must be able to find a valid resource ID");var g={cid:a,rawContentID:n,id:i.body.attachmentId,attID:d,realAttrID:s,data:void 0,size:i.body.size,uploader:void 0,disposition:o,parentType:t.mimeType,mimeType:i.mimeType,contentEncoding:l};e.add(g)},_decodeFlowed:function(e,t){return e.split(/\r?\n/).reduce(function(e,i,a){var n=e;return t&&(n=n.replace(/[ ]+$/,"")),/ $/.test(e)&&!/(^|\n)\-\- $/.test(e)||1===a?n+i:n+"\n"+i}).replace(/^ /gm,"")},_decodeEmail:function(e,t,i){var a;if(r.default.Assert(r.default.isString(e),"Passing in an invalid string to decode"),e)try{a=r.default.b64_to_utf8(e),"FLOWED"===i.format&&(a=this._decodeFlowed(a,i.delSp))}catch(e){r.default.reportError(e)}return a},_encodeEmail:function(e){var t;try{t=r.default.utf8_to_b64(e)}catch(e){r.default.reportError(e)}return t},_runDecodeEmail:function(e){r.default.Assert(e&&e.body,"Must pass in a valid part");var t,i=this._getHeader(e,"Content-Transfer-Encoding"),a=!1;if(_i.indexOf(e.mimeType)>=0)return{decoded:t=this._generateMessageDisplayNode(e),mimeType:ui,contentType:"text/html;charset=utf-8",name:"GeneratedContent",hasError:a};var n=this._getHeader(e,"Content-Type")||"text/html;charset=utf-8";r.default.Assert(n,"Must have a valid contentType");var s=this._sanitizeContentType(n);return e.body&&e.body.data?t=this._decodeEmail(e.body.data,i,s):e.body&&e.body.attachmentId?t='<a href="attach:'+e.body.attachmentId+'">Load Message</a>':(t="Unable to decode email content",a=!0),{decoded:t,mimeType:e.mimeType,contentType:s.type,name:s.name,hasError:a}},_runDecodeMessage:function(e){var t=this._decodeMessagePart(e);return 0===t.length&&e?mi.indexOf(e.mimeType)>=0?[this._runDecodeEmail(e)]:_i.indexOf(e.mimeType)>=0?[this._runDecodeEmail(e)]:[]:t},_decodeMessagePart:function(e){var t=[];if(e)if(e.mimeType===ti||e.mimeType===ii||e.mimeType===ei)for(var i=0,a=0;a<e.parts.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=this._decodeMessagePart(e.parts[a]);t.pushArray(n)}else if(e.mimeType===$t||e.mimeType===Zt||e.mimeType===Zt||e.mimeType===ni)for(var s=0,r=e.parts.length-1;r>=0;r--){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;if(this._isValidDisplayPart(e.parts[r])){var o=this._decodeMessagePart(e.parts[r]);if(o.length>0){t.pushArray(o);break}}}else this._isValidDisplayPart(e)&&t.push(this._runDecodeEmail(e));return t},_combineMessageParts:function(e){var t="",i=di,a="text/html;charset=utf-8",n=!1;if(e&&e.length>0){var s=0;i=e[0].mimeType,a=e[0].contentType;for(var r=0;r<e.length;++r){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;vi.indexOf(e[r].mimeType)<0&&(n=!0)}t=st.a.combineParts(e)}else t=" ";return i===di&&(i=ui,a=ui+";charset="+a.split(";charset=")[1]),{decoded:t,mimeType:i,contentType:a,reportMessage:n}},_isValidDisplayPart:function(e){var t=!1;return!this._isResourcePart(e)&&mi.indexOf(e.mimeType)>=0&&(t=!0),t},_isResourcePart:function(e){var t=!1;return e.filename?t=!0:this._getHeader(e,"CONTENT-ID")&&(this._getHeader(e,"CONTENT-DISPOSITION")||mi.indexOf(e.mimeType)<0)&&(t=!0),t},_parseMessagePart:function(e,t){var i=0,a=0,n={parent:t,raw:e,mimeType:e.mimeType,children:[],resources:[]};switch(e.mimeType){case di:case ui:case si:break;case Zt:case ei:case ri:case $t:case ai:case ii:case oi:case ti:for(var s=0;s<e.parts.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var o=e.parts[s],l=this._parseMessagePart(o,n);this._isResourcePart(o)?n.resources.push(l):n.children.push(l)}break;case ni:for(var d=0;d<e.parts.length;++d){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var u=this._parseMessagePart(e.parts[d],n);n.children.push(u)}break;default:var c=e.mimeType.split("/")[0];gi.indexOf(c)<0&&(log("Unknown Part Mimetype: ",e),r.default.reportError(new Error("Unknown attachment mimetype: "+e.mimeType)))}return n},_getMessageDisplay:function(e,t){var i=0;switch(e.mimeType){case di:case ui:case ti:case ii:case ai:t.push(e);break;case $t:case Zt:case ni:case ei:for(var a=0;a<e.children.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;this._getMessageDisplay(e.children[a],t)}break;case ci:case hi:break;case ri:case li:case oi:t.push(e);break;default:r.default.Assert(!1,"Should never have an unknown multipart mimetype in the tree: ",e.mimeType)}},_getResourcesForNode:function(e,t){for(var i=0,a=e.resources,n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=a[n].raw;this._parseAttachment(t,e,s)}e.raw&&e.raw.body&&e.raw.body.attachmentId&&this._parseAttachment(t,e.parent,e.raw)},_getResourcesForPart:function(e){var t=0,i=new dt.a;if(e.mimeType===ti||e.mimeType===ii)for(var a=0,n=0;n<e.children.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;this._getResourcesForNode(e.children[n],i)}for(;e;){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this._getResourcesForNode(e,i),e=e.parent}return i},_displayAttachment:function(e,t){var i=!1;return e.cid===t&&(e.disposition===pi?i=!0:e.disposition===fi&&e.parentType===ti&&(i=!0)),i},getMessageAttachments:function(e){var t=this,i=[];return e.resources.forEachResource(function(e){t._displayAttachment(e,e.cid)&&i.push(e)}),i},getMessageDisplayAttachments:function(e){var t,i=0,a=this.getMessageAttachments(e);if(e.initializedForDisplay)t=e.specialLinks?e.specialLinks.attachments:[];else{var n={ignoreQuotedAttachments:!!(e.labelIds.indexOf(Kt.DRAFT)>=0)};t=st.a.getAttachmentLinks(e.decoded,n)}for(var s=0;s<t.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=t[s];if(!e.resources.has(r.name)){var o=this._createResource(e.resources,r);o.link=r.href,a.push(o)}}return a},_verifyDKIM:function(e){var t;if(e)for(var i=0,a=e.split(";"),n=/([a-z]+)[=](.*)/i,s=0;s<a.length;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=a[s].trim();if(r){var o=n.exec(r);if(o)switch(t={},o[1]){case"d":t.domain=o[2];break;case"h":t.headers=o[2].split(":").map(Function.prototype.call,String.prototype.trim)}}}return t},_sanitizeContentType:function(e){var t="text/html;charset=utf-8";try{var i,a,n,s,o=0,l=e.replace(/[\"\']/g,"").split(";"),d=l[0].trim().toLowerCase();r.default.Assert(d===di||d===ui,"Unknown ContentType MediaType: "+d);for(var u=1;u<l.length;++u){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var c=l[u].trim();if(c){var h=c.indexOf("=");if(h>=1){var f=c.substr(0,h).trim(),p=c.substr(h+1).trim();if(f&&p)switch(f.toUpperCase()){case"CHARSET":i=p;break;case"FORMAT":a=p.toUpperCase();break;case"DELSP":n="YES"===p.toUpperCase();break;case"NAME":s=p;break;case"BOUNDARY":break;default:r.default.Assert(!1,"Unknown param in ContentType: "+c)}else r.default.Assert(!1,"Malformed contentType part: ",e)}else r.default.Assert(!1,"Invalid contentType part: ",e)}}i||(i="utf-8"),d&&i&&(t=d+";charset="+i)}catch(e){r.default.reportError(e)}return{type:t,format:a,delSp:n,name:s}},_getHeader:function(e,t){var i;if(e&&e.headers)for(var a=0,n=0;n<e.headers.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(e.headers[n].name.toUpperCase()===t.toUpperCase()){i=e.headers[n].value;break}}return i},_generateMessageDisplayNode:function(e){var t;if(r.default.Assert(_i.indexOf(e.mimeType)>=0,"Must be a valid mimeType to generate content from"),e.body&&e.body.attachmentId)t='<a href="attach:'+e.body.attachmentId+'">Load Message</a>';else{var i;switch(e.mimeType){case li:case oi:case ti:i="&nbsp;";break;case ri:i="Unable to display encrypted message content.";break;default:i="Unable to display unknown content type: "+e.mimeType}t="<html><body>"+i+"</body></html>"}return t},_parseMailMessage:function(e){var t;try{t=this._parseMailMessageInternal(e)}catch(e){r.default.reportError(e)}return t},_parseMailMessageInternal:function(e){var t=0,i={},a=e.payload,n=!!a.body&&a.body.size>0;r.default.Assert(n!==a.mimeType.startsWith("multipart/")||a.mimeType===ei,"Checking the body size should be the same as checking whether this is a multipart message"),this._verifyDKIM(this._getHeader(e.payload,"DKIM-Signature"));for(var s,o,l=e.payload.headers,d=0;d<l.length;++d){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var u=l[d];switch(u.name.toUpperCase()){case"FROM":e.from=this.parseEmailAddress(u.value);break;case"REPLY-TO":e.replyTo=this.parseEmailAddress(u.value);break;case"TO":e.to=this.parseEmailAddresses(u.value);break;case"CC":e.cc=this.parseEmailAddresses(u.value);break;case"BCC":e.bcc=this.parseEmailAddresses(u.value);break;case"SUBJECT":e.subject=u.value;break;case"DATE":e.date=this.parseDateHeader(u.value),r.default.Assert(r.default.isDateValid(e.date),"Must have a valid message date: ",e.date);break;case"MESSAGE-ID":e.messageID=u.value;break;case"REFERENCES":e.references=u.value;break;case"IN-REPLY-TO":e.inReplyTo=u.value;break;case"LIST-UNSUBSCRIBE":e.listUnsubscribe=u.value;break;default:0}}if(e.messageID||(e.messageID=r.default.generateTempId()),n)o=a;else{var c,h=0,f=this._parseMessagePart(a),p=[];this._getMessageDisplay(f,p);for(var g=p.length-1;!c&&g>=0;g--){if(h++>5e3&&__infLoop&&__infLoop(h))throw new RangeError;mi.indexOf(p[g].mimeType)>=0?c=p[g]:_i.indexOf(p[g].mimeType)>=0?c=p[g]:(log("Unknown bestNode mimepart: ",p[g]),r.default.Assert(!1,"Unknown mimePart display type: ",p[g].mimeType))}c?(s=this._getResourcesForPart(c),o=c.raw):this._sendReport(!1,"Missing bestNode",e)}r.default.Assert(o,"Must have found a valid message part to display");var m=this._runDecodeMessage(o);if(r.default.Assert(m.length>0,"Should have at least one decoded message part available"),0===m.length)try{var v=JSON.parse(JSON.stringify(e));this._sendReport(!0,"No valid decoded part",v)}catch(e){r.default.reportError(e)}var _=this._combineMessageParts(m);_&&(i={id:e.id,labelIds:e.labelIds,messageID:e.messageID,decoded:_.decoded,mimeType:_.mimeType,contentType:_.contentType,from:e.from,to:e.to||[],cc:e.cc,bcc:e.bcc,snippet:e.snippet,subject:e.subject||"",date:e.date,internalDate:e.internalDate?new Date(r.default.parseInt(e.internalDate)):new Date,references:e.references,inReplyTo:e.inReplyTo,listUnsubscribe:e.listUnsubscribe,resources:s||new dt.a},_.reportMessage&&this._sendReport(!1,"Mismatch mimeType/contentType",e));return i},parseEmailAddress:function(e){Si.lastIndex=0;var t=Si.exec(e),i={};if(t){var a=wi.exec(t[1]);i.text=a?a[1]:t[1],i.email=t[2]}else i.email=e;return i.email&&(i.email=i.email.replace(/[\r\n]/g,"")),i.text&&(i.text=i.text.replace(/[\r\n]/g,"")),i},parseEmailAddresses:function(e){for(var t=0,i=[],a=r.default.parseEmailAddresses(e),n=0;n<a.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=a[n];"contact"===s.type&&s.email&&i.push(s)}return i},parseDateHeader:function(e){var t=new Date(e);return r.default.isDateValid(t)||(t=H.a.parseDate(e,l.a.DateFormat.MDY)),t},runRemoteSearch:function(e,t,i,a){var n=this;r.default.Assert(e,"Must provide a valid search"),r.default.Assert(t,"Must provide a valid pane"),r.default.Assert(i,"Must provide a valid bucket ID"),r.default.Assert(r.default.isFunction(a),"Must provide a valid search callback");var s="-in:chats -in:spam "+e,o=r.default.vmMain.paneManager.getPaneById(t),l=this._getAccountIDFromItem(o.getItem())||this.getDefaultAccount(),d=!1,u=0,c=0,h=new Z(e,25,this.requestDataPage.bind(this)),f=function(e){if(u===c&&d){log("Done Searching: ",u);var s=e?SearchResultStatus.Error:u>0?SearchResultStatus.Done:SearchResultStatus.None;h.isValid()&&n.swapInSearchBucket(i,t),a(s)}},p=function(e){if(u++,e){var t=n._addRemoteEntry(l,e),a=n.getBucketItemStore(i);n._ensureVMLIsForSearchResult(t,a),c++}else c++;f()},g=function(e){d=!0,f(!e)},m=!1,v=new St(h.onEntry,function(e){h.onDone(e),m||(m=!0,h.isValid()&&h.hasResults()?h.getNextPage(p,g):g(e))});return this._requestRemoteThreads(l,Ct,void 0,s,25,void 0,v.getEntryCB(),v.getDoneCB()),h},_addSearchCacheEntryInternal:function(e,t,i){var a=!1,n=this._ensureAccountLib(e,this._emailCache);return n[t]||(n[t]={}),n[t][i]||(n[t][i]=!0,a=!0),a},_removeSearchCacheEntryInternal:function(e,t,i){var a,n=this._getAccountLib(e,this._emailCache);return n&&n[t]&&(a=n[t][i],delete n[t][i]),a},_getSearchCacheLabelEntryInternal:function(e,t){var i,a=this._getAccountLib(e,this._emailCache);return a&&a[t]&&(i=a[t]),i},_addEmailToSearchCache:function(e,t){var i=!1;if(t&&r.default.isArray(t.labelIds))for(var a=0,n=0;n<t.labelIds.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;i|=this._addSearchCacheEntryInternal(t.accountID,t.labelIds[n],e)}return i},_removeEmailFromSearchCache:function(e,t){var i=!1;if(t&&r.default.isArray(t.labelIds))for(var a=0,n=0;n<t.labelIds.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=!!this._removeSearchCacheEntryInternal(t.accountID,t.labelIds[n],e);i|=s,s&&this._removeThreadLabelVMLI(t.accountID,e,t.labelIds[n])}return i},_addEmailLabelToSearchCache:function(e,t,i){return this._addSearchCacheEntryInternal(e,i,t)},_removeEmailLabelFromSearchCache:function(e,t,i){var a=!!this._removeSearchCacheEntryInternal(e,i,t);return a&&this._removeThreadLabelVMLI(e,t,i),a},runLocalItemSearch:function(e){var t=this.getDescriptorForItem(e.item),i=this._getSearchCacheLabelEntryInternal(t.accountID,t.labelID);if(i)for(var a in i)if(i.hasOwnProperty(a)){var n=this.getCacheData(a);if(r.default.Assert(n,"Must have valid data for search entry"),n){var s=this._ensureThreadLabelVMLI(n,t.labelID);e.comparator&&!e.comparator(s)||e.each&&e.each(s)}}},getRemoteAttachmentData:function(e){var t=this;if(r.default.Assert(e.hasField("accountID"),"Must have a valid accountID for a thread"),e.hasField("accountID")){this._requestRemoteThreadMetadata(e.getField("accountID"),e.id,e,function(i,a){i?t._addRemoteEntry(e.getField("accountID"),i):(e.notifyDataRequestFailed(),t._notifyFailedRequest(e.getField("accountID"),a))})}else e.notifyDataRequestFailed()},_updateThreadFromMessages:function(e){var t=0;r.default.Assert(!e.isDeleted||0===e.messages.length,"Should never run an update on a deleted thread with messages");var i=e.labelIds,a=r.default.getUserIdentifier();"me"===e.accountID&&"me"!==a&&(e.accountID=a),e.labelIds=[],e.date=void 0,e.participants=[],e.count=e.messages.length,e.snippet=e.count>0?e.messages[e.messages.length-1].snippet:"",e.hasPriority=!1;for(var n=0;n<e.messages.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=e.messages[n];r.default.Assert(s.id,"Each message must have a valid ID"),e.labelIds.pushOnlyUniques(s.labelIds);var o=s.labelIds.indexOf(Kt.DRAFT)>=0,l=!1;if(s.labelIds.indexOf(Kt.SENT)>=0)for(var d=0,u=0;u<s.to.length;++u){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;var c=s.to[u];if(this.isMyAccountID(c.email)){l=!0;break}}else l=!0;(!e.date||s.date&&e.date.isBefore(s.date)&&!o&&l)&&(e.date=s.date),(!e.internalDate||s.internalDate&&e.internalDate.isBefore(s.internalDate))&&(e.internalDate=s.internalDate),s.from&&e.participants.indexOfWithProperty("email",s.from.email)<0&&e.participants.push(s.from),s.resources instanceof dt.a?s.resources.forEachResource(function(t){this._displayAttachment(t,t.cid)&&(e.hasAttachments=!0)}.bind(this)):r.default.Assert(!1,"Message must always be a resource lib")}return e.date=e.date?new Date(e.date):new Date(0),r.default.isDateValid(e.date)||(e.date=new Date(0)),e.internalDate=e.internalDate?new Date(e.internalDate):new Date,r.default.isDateValid(e.internalDate)||(e.internalDate=new Date),e.lastModifiedDate=e.lastModifiedDate?new Date(e.lastModifiedDate):e.date,r.default.isDateValid(e.lastModifiedDate)&&!e.lastModifiedDate.isBefore(e.date)||(e.lastModifiedDate=e.date),e.messages.length>0&&(e.subject=e.messages[0].subject,e.subjectLower=e.subject.toLowerCase(),e.from=e.messages[e.messages.length-1].from,e.to=e.messages[0].to),{labelsAdded:i?e.labelIds.removeArray(i):e.labelIds,labelsRemoved:i?i.removeArray(e.labelIds):void 0}},_updateAttachmentFromMessages:function(e,t){var i=this._updateThreadFromMessages(e.getData());this._handleThreadLabelUpdates(e.getData(),i.labelsAdded,i.labelsRemoved),e.notifyDataMutated(["labelIds","date","lastModifiedDate","count","snippet","subject","subjectLower","hasAttachments","from","to"],t)},_createRemoteEntry:function(e,t){for(var i=0,a={id:t.id,accountID:e,messages:[],labelIds:[]},n=0;n<t.messages.length;++n){var s=0;if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var o=t.messages[n];r.default.Assert(o.id,"Message must have a valid id"),r.default.Assert(!o.labelIds||o.labelIds.indexOf(Kt.CHAT)<0,"Should never receive a chat message"),o.labelIds&&o.labelIds.indexOf(Kt.DRAFT)>=0&&this._notifyDraftMessage(e,t.id,o.id);for(var l={id:o.id,messageID:void 0,internalDate:o.internalDate?new Date(r.default.parseInt(o.internalDate)):new Date,snippet:o.snippet,labelIds:o.labelIds||[],to:[],resources:new dt.a,subject:""},d=0;d<o.payload.headers.length;++d){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var u=o.payload.headers[d];switch(u.name.toUpperCase()){case"TO":l.to=this.parseEmailAddresses(u.value);break;case"FROM":l.from=this.parseEmailAddress(u.value);break;case"SUBJECT":l.subject=u.value;break;case"MESSAGE-ID":l.messageID=u.value;break;case"IN-REPLY-TO":l.inReplyTo=u.value;break;case"DATE":l.date=this.parseDateHeader(u.value),r.default.Assert(r.default.isDateValid(l.date),"Must have a valid message date: ",u.value)}}r.default.isDateValid(l.date)||(l.date=l.internalDate),l.subject||(l.subject=""),l.messageID||(l.messageID=r.default.generateTempId()),a.messages.push(l)}return this._updateThreadFromMessages(a),a},_addRemoteEntry:function(e,t){var i=this._createRemoteEntry(e,t);if(this.hasCacheData(i.id)){var a=this.getCacheData(i.id);if(a){this._mergeThreadData(a,i);var n=this._updateThreadFromMessages(i);this._handleThreadLabelUpdates(i,n.labelsAdded,n.labelsRemoved)}var s=this.getChangedFields(a,i);if(this.cacheData(i.id,i,!!a,s),this.fieldsHaveParseEffect(s))if(this.hasAttachment(i.id))this.getAttachment(i.id).notifyDataMutated(s,ChangeType.Remote)}else this.cacheData(i.id,i),this._updateSearchPanes(i,i.labelIds,[]);return i},cacheData:function(e,t,i,a){this._verifyMessageState(t,!1);var n=this._addEmailToSearchCache(e,t);if(this._super.cacheData.call(this,e,t,i,a),t.messages&&this._checkUnsyncdMessageContent(t),n){var s=this.getDefaultItemStore();s&&s.updateItems()}},cacheThreadData:function(e,t){this._verifyMessageState(t,!0),this._threadCache.cacheEntry(e,t)},_verifyMessageState:function(e,t){},createEntryFromLocal:function(e,t){var i=0;t.subjectLower=t.subject.toLowerCase(),t.messages=t.messages||[];for(var a=0;a<t.messages.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=t.messages[a];if(r.default.isString(n.date)?n.date=this.parseDateHeader(n.date):n.date||(n.date=new Date),r.default.isString(n.internalDate)?n.internalDate=new Date(n.internalDate):n.internalDate||(n.internalDate=new Date),n.to||(n.to=[]),n.resources){var s=n.resources;if(s instanceof dt.a)n.resources=s.clone();else for(var o in n.resources=new dt.a,s)s.hasOwnProperty(o)&&n.resources.add(s[o])}else n.resources=new dt.a;r.default.Assert(n.draftID||n.messageID||r.default.isTempId(n.id),"Remotely saved messages must have a valid message ID"),r.default.Assert(r.default.isDateValid(n.date),"Must have a valid message date: ",n.date),r.default.Assert(r.default.isDateValid(n.internalDate),"Must have a valid internal message date: ",n.internalDate),!r.default.isTempId(n.id)&&!n.draftID&&n.labelIds&&n.labelIds.indexOf(Kt.DRAFT)>=0&&this._notifyDraftMessage(t.accountID,e,n.id),n.decoded&&this.reportTrackedStat(It.MessageDataCached)}return this._updateThreadFromMessages(t),t},_updateMessageData:function(e,t,i){var a=e.getField("messages"),n=a.indexOfWithProperty("id",t);r.default.Assert(n>=0,"Must always be able to find the message being updated"),n>=0&&(this._mergeMessageData(a[n],i,["labelIds"]),a[n]=i,e.updateField("messages",a),this._updateAttachmentFromMessages(e,ChangeType.Remote))},_mergeMessageData:function(e,t,i){if(r.default.Assert(r.default.isObject(e),"Must pass in a valid old message"),r.default.Assert(r.default.isObject(t),"Must pass in a valid new message"),e.modifiedOffline){var a=0,n=e.modifiedOffline;r.default.Assert(r.default.isArray(n),"Should not be receiving an update for an event that was created locally");for(var s=0;s<n.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;t[n[s]]=e[n[s]]}t.modifiedOffline=e.modifiedOffline}if(i)for(var o=0,l=0;l<i.length;++l){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;e.hasOwnProperty(i[l])&&(t[i[l]]=e[i[l]])}for(var d in e)if(e.hasOwnProperty(d))switch(d){case"snippet":this._pendingDraftUpdates[e.id]&&(t[d]=e[d]);break;default:t.hasOwnProperty(d)||(t[d]=e[d])}},_mergeMessagesData:function(e,t,i){var a=0;r.default.Assert(r.default.isArray(e),"Must have a valid old messages array"),r.default.Assert(r.default.isArray(t),"Must have a valid new messages array"),r.default.Assert(e!==t,"Should not pass in the same array for old and new");for(var n=0;n<e.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=e[n],o=t.indexOfWithProperty("id",s.id);if(o>=0){var l=t[o];r.default.Assert(l,"Must have a valid new message"),this._mergeMessageData(s,l,i)}else if(s.labelIds.indexOf(Kt.DRAFT)>=0)if(r.default.isTempId(s.id)){var d=t.indexOfWithProperty("messageID",s.inReplyTo);r.default.Assert(d>=0,"Must be able to find the message being replied to"),d>=0&&t.splice(d+1,0,s)}else if(s.inReplyTo){var u=t.indexOfWithProperty("inReplyTo",s.inReplyTo);if(u>=0){var c=t[u];r.default.Assert(c,"Must have a valid new message"),this._mergeMessageData(s,c,i)}}}},_mergeThreadData:function(e,t){if(this.reportTrackedStat(It.MergeThread),r.default.Assert(!e.isDeleted,"Should never merge message data in a deleted thread"),this._mergeMessagesData(e.messages,t.messages,["resources","draftID"]),e.modifiedOffline){var i=0,a=e.modifiedOffline;r.default.Assert(r.default.isArray(a),"Should not be receiving an update for an event that was created locally");for(var n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=a[n];switch(s){case"messages":break;default:t[s]=e[s]}}t.modifiedOffline=e.modifiedOffline}for(var o in e)t.hasOwnProperty(o)||(t[o]=e[o]);t.labelIds=e.labelIds},_shouldCacheThread:function(e){for(var t=0,i=!0,a=0;a<e.messages.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=e.messages[a];if(n.labelIds&&(n.labelIds.indexOf(Kt.SPAM)>=0||n.labelIds.indexOf(Kt.CHAT)>=0)){i=!1;break}}return i},_shouldCacheMessageData:function(e){var t=!1,i=this._getFullSyncTime(),a=this._getUnreadSyncTime();if(e.date.isAfter(i))t=!0;else if(e.date.isAfter(a))for(var n=0,s=0;s<e.messages.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var r=e.messages[s];if(this.isPriorityData(r)){t=!0;break}}return t},refreshThreadCacheData:function(e,t,i,a,n){var s=this;this._requestRemoteThreadMetadata(e,t,void 0,function(i,r){if(i)if(s._shouldCacheThread(i)){var o=s._addRemoteEntry(e,i);s.cacheThreadData(t,s.serializeExternalData(o),n)}else s._deleteCachedThread(e,t,n);else r&&r.error&&r.error.code===l.a.HTTPStatusCode.NotFound?s._deleteCachedThread(e,t,n):(a(e,t),n&&n(!1))})},_deleteCachedThread:function(e,t,i){if(this.hasCacheData(t)){for(var a=0,n=this.getAttachment(t),s=n.getField("messages"),o=0;o<s.length;++o){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;r.default.menus.isComposeOpenForEmail(s[o].id)&&(this._clearPendingDraftUpdate(n,s[o].id),g.a.fireEvent("EmailCompose","onClosed",[]),r.default.menus.closeComposeEmail(n,s[o])),this._rawCache.removeEntry(s[o].id)}n.updateField("isDeleted",!0),n.updateField("messages",[]),this._updateAttachmentFromMessages(n,ChangeType.Remote)}this._threadCache.removeEntry(t,function(e){r.default.Assert(e,"Should be able to delete the thread from the local thread cache"),i&&i(e)})},_deleteCachedMessage:function(e,t,i){if(r.default.Assert(i,"Must specify a valid message ID to remove from thread"),this.hasCacheData(t))for(var a=0,n=this.getAttachment(t),s=n.getField("messages"),o=0;o<s.length;++o){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(s[o].id===i){s.removeAt(o),this._updateAttachmentFromMessages(n,ChangeType.Remote),n.updateField("messages",s);break}}this._threadCache.getEntry(t,function(e){if(e)for(var a=0,n=0;n<e.messages.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(e.messages[n].id===i){e.messages.removeAt(n),this.cacheThreadData(t,e);break}}}.bind(this)),this._rawCache.removeEntry(i)},setLastModifiedDate:function(e,t,i){var a=this;this.hasCacheData(t)&&this.getAttachment(t).updateField("lastModifiedDate",i);this._threadCache.getEntry(t,function(e){e&&(e.lastModifiedDate=i,a.cacheThreadData(t,e))})},addLabelsToMessage:function(e,t,i,a,n){if(this.hasCacheData(t)){for(var s=0,o=this.getAttachment(t),l=o.getField("messages"),d=0;d<l.length;++d){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;if((!i||l[d].id===i)&&(l[d].labelIds.pushOnlyUniques(a),i))break}this._updateAttachmentFromMessages(o,n),o.updateField("messages",l)}this._threadCache.getEntry(t,function(e){if(e){for(var n=0,s=!1,o=0;o<e.messages.length;++o){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(!i||e.messages[o].id===i){e.messages[o].labelIds.pushOnlyUniques(a),this.cacheThreadData(t,e),s=!0;break}}r.default.Assert(s,"Must have found message to add labels to")}}.bind(this))},removeLabelsFromMessage:function(e,t,i,a,n){if(this.hasCacheData(t)){for(var s=0,o=this.getAttachment(t),l=o.getField("messages"),d=0;d<l.length;++d){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;if(!i||l[d].id===i){for(var u=0,c=0;c<a.length;++c){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;l[d].labelIds.remove(a[c])}if(i)break}}this._updateAttachmentFromMessages(o,n),o.updateField("messages",l)}this._threadCache.getEntry(t,function(e){if(e){for(var n=0,s=!1,o=0;o<e.messages.length;++o){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(!i||e.messages[o].id===i){for(var l=0,d=0;d<a.length;++d){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;e.messages[o].labelIds.remove(a[d])}this.cacheThreadData(t,e),s=!0;break}}r.default.Assert(s,"Must have found message to remove labels from")}}.bind(this))},changeMessageAccount:function(e,t,i,a,n,s){r.default.Assert(s,"Must supply a valid from contact");var o=a!==e.getField("accountID"),l=this._findDraft(e,t,i);return o&&this.discardDraft(e,l.id,l.draftID,function(e){r.default.Assert(e,"Must successfully delete remote draft")}),l.from=s,l.replyTo=this.getReplyToAddress(s.email),l.decoded=st.a.replaceSignature(l.decoded,this.getSignature(n)),o?this.createDraft(a,void 0,void 0,l):this.updateDraft(e,l.id,l.draftID,l,l.snippet,!0,!0,function(e){r.default.Assert(e,"Must be able to successfully update the draft when swiching sending accounts")})},_ensureVMLIsForSearchResult:function(e,t){r.default.Assert(t,"Should never be ensuring a search VMLI in the default item store");var i="S~"+e.accountID,a=this._ensureVMLIsForAccount(i,t),n=this._createThreadID(i,"",e.id);if(!t.hasItem(n)){var s=t.createItem(n,this._getTextForItem(e),a.id);a.insertSorted(s,this.sortFn)}},_removeVMLIFromSearchResult:function(e,t){r.default.Assert(t,"Should never be ensuring a search VMLI in the default item store");var i="S~"+e.accountID,a=this._createThreadID(i,"",e.id);t.hasItem(a)&&t.destroyItem(a)},_createThreadID:function(e,t,i){return"T~"+e+"~"+t+"~"+i},_getItemProps:function(e,t){var i;return t.isNamed(Qt.PRI0)?i={priority:VMLIFlag.P0}:t.isNamed(Qt.PRI1)?i={priority:VMLIFlag.P1}:t.isNamed(Qt.PRI2)&&(i={priority:VMLIFlag.P2}),i},_ensureThreadLabelVMLI:function(e,t,i){i=i||this.getDefaultItemStore();var a,n=this._getLabelByID(e.accountID,t),s=this._ensureVMLIsForLabel(e.accountID,n,i),r=this._createThreadID(e.accountID,t,e.id);if(this.reportTrackedStat(It.EnsureLabelVMLI),i.hasItem(r))a=i.getItem(r);else{this.reportTrackedStat(It.CreateLabelVMLI);var o=this._getItemProps(e,n);a=i.createItem(r,this._getTextForItem(e),s.id,o),s.insertSorted(a,this.threadSortFn,!1)}return a},_removeThreadLabelVMLI:function(e,t,i,a){a=a||this.getDefaultItemStore();var n=this._createThreadID(e,i,t);a.hasItem(n)&&a.destroyItem(n)},_getRequiredSearchLabels:function(e){for(var t=0,i=[Kt.INBOX],a=e.split(" "),n=0;n<a.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=a[n].split(":");s&&2===s.length&&("label"!==s[0]&&"category"!==s[0]&&"is"!==s[0]||i.push(s[1].toUpperCase()))}return i},_handleThreadLabelUpdates:function(e,t,i){r.default.vmMain.beginUpdateItems();var a=!1;if(t)for(var n=0,s=0;s<t.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;a|=this._addEmailLabelToSearchCache(e.accountID,e.id,t[s])}if(i)for(var o=0,l=0;l<i.length;++l){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;a|=this._removeEmailLabelFromSearchCache(e.accountID,e.id,i[l])}this._updateSpecialLabels(e),this._updateSearchPanes(e,t,i),a&&this.getDefaultItemStore().updateItems(),r.default.vmMain.commitUpdateItems()},_updateSearchPanes:function(e,t,i){r.default.vmMain.beginUpdateItems(),r.default.vmMain.paneManager.runForEachPane(function(a){if(a.isSearchingRemote()){var n=this.getActiveItemStore(a.id),s=a.search.getRemoteValue(),o=!1,l=!1;this._getRequiredSearchLabels(s).forEach(function(e){i&&i.indexOf(e)>=0?o=!0:t&&t.indexOf(e)>=0&&(l=!0)}),o?n!==this.getDefaultItemStore()&&(r.default.focusedPane===a&&0===t.length&&i&&1===i.length&&i[0]===Kt.UNREAD||this._removeVMLIFromSearchResult(e,n)):l&&n!==this.getDefaultItemStore()&&this._ensureVMLIsForSearchResult(e,n)}}.bind(this),this.getPaneType()),r.default.vmMain.commitUpdateItems()},_updateSpecialLabels:function(e){this._threadIsArchived(e)?this._addEmailLabelToSearchCache(e.accountID,e.id,Xt.ARCHIVED):this._removeEmailLabelFromSearchCache(e.accountID,e.id,Xt.ARCHIVED),this._addEmailLabelToSearchCache(e.accountID,e.id,Xt.ALLMAIL)},_ensureVMLIsForAccount:function(e,t){r.default.Assert(e,"Must specify a valid account ID");var i="A~"+e,a=(t=t||this.getDefaultItemStore()).getItem(i);if(!a){var n=t.getRoot();a=t.createItem(i,e,n.id),n.insertSorted(a,this.sortFn)}return a},_ensureVMLIsForLabel:function(e,t,i){r.default.Assert(t,"Must specify a valid label"),r.default.Assert(t instanceof nt,"Must pass in a valid label object"),i=i||this.getDefaultItemStore();var a="L~"+e+"~"+t.getLabelID(),n=i.getItem(a),s=t.getDisplayText(!0);if(n)n.getParsedText()!==s&&n.setText(s,!0,ChangeType.Auto);else{var o;if(t.hasAncestors()){var l=this._getLabelByName(e,t.getParent().getRawName(),!0);o=l?this._ensureVMLIsForLabel(e,l,i):this._ensureVMLIsForAccount(e,i)}else o=this._ensureVMLIsForAccount(e,i);n=i.createItem(a,s,o.id),o.insertSorted(n,this.sortFn)}return n},getVMLIForAccount:function(e){return this._ensureVMLIsForAccount(e)},getVMLIForLabel:function(e,t){return this._ensureVMLIsForLabel(e,t)},getLabelForVMLI:function(e){var t,i=this.getDescriptorForItem(e);return i.accountID&&i.labelID&&(t=this._getLabelByID(i.accountID,i.labelID)),t},_getAccountIDFromItem:function(e){var t,i=e.id;return i.startsWith("R~")&&(i=i.substr(2)),i.startsWith("A~")?(t=i.substr(2)).startsWith("S~")&&(t=t.substr(2)):i.startsWith("L~")?t=i.substring(2,i.indexOf("~",2)):i.startsWith("T~")&&(t=i.substring(2,i.indexOf("~",2))),r.default.Assert(!t||t.indexOf("~")<0,"Should not contain delim in label ID"),t},_getLabelIDFromItem:function(e){var t,i=e.id;return i.startsWith("L~")?t=i.substr(i.indexOf("~",2)+1):i.startsWith("T~")&&(t=i.substr(i.indexOf("~",2)+1)),r.default.Assert(!t||r.default.isTempId(t)||t.indexOf("~")<0,"Should not contain delim in label ID"),r.default.Assert(!t||t.length>3,"Label ID should be longer than a couple of chars"),t},_getThreadIDFromItem:function(e){return this._getThreadID(e.id)},_getThreadID:function(e){var t;return e.startsWith("T~")?t=e.substr(e.lastIndexOf("~")+1):e.startsWith("A~")||e.startsWith("L~")||e.startsWith("R~")||(t=e),r.default.Assert(!t||r.default.isTempId(t)||t.indexOf("~")<0,"Should not contain delim in thread ID"),r.default.Assert(!t||t.length>3,"Thread ID should be longer than a couple of chars"),t},isAccountItem:function(e){return e.id.startsWith("A~")},isLabelItem:function(e){return e.id.startsWith("L~")},isThreadItem:function(e){return e.id.startsWith("T~")},getAttachmentClass:function(){return["plugin_gmail"]},googleScopes:function(){return[GScope.GmailModify,GScope.GmailCompose]},getDependencies:function(){return[PluginDependency.LocalLoaded,PluginDependency.GoogleLogin]},isDependencyLoaded:function(e,t){var i=!1;switch(e){case PluginDependency.GoogleLogin:t&&t.indexOf(GScope.GmailModify)>=0&&(i=!0);break;default:i=!0}return i},verifyAuthorization:function(e){return!this.getSetting(this.Settings.IsEnabled)||this.googleScopes().some(function(t){return j.a.hasLinkedAccessToScope(e,t)})},handleUnauthorized:function(e){this.isDefaultEmail(e)?this.setSetting(this.Settings.IsEnabled,!1):this.removeSyncAccount(e)},_activate:function(){var e=this.getDefaultAccount();this.hasSyncAccount(e)||this.addSyncAccount(e)},_deactivate:function(){},handleTapStart:function(){return!0},handleTapClick:function(e,t,i,a){var n=a.target;if(r.default.Assert(t,"Gmail tapped but is not actually a pane",r.default.getElementPath(n)),t)return this.openEmailByItem(e,t)},handleDoubleTap:function(e,t,i,a){this.openEmailByItem(e,t),a.preventDefault(),r.default.preventClick()},isMyAccountID:function(e){r.default.Assert("me"!==e||r.default.isDemoMode(),"Should not be checking me");var t=r.default.getUserIdentifier();return r.default.Assert(r.default.isDemoMode()||"me"!==t,"Should not be checking against current account until loaded"),e===t},createURLForThread:function(e){var t=e.getField("accountID");return"me"===t&&(t=r.default.getUserIdentifier()),"https://mail.google.com/mail/b/"+t+"#all/"+e.id},createPrintURLForThread:function(e){var t=e.getField("accountID");return"me"===t&&(t=r.default.getUserIdentifier()),"https://mail.google.com/mail/b/"+t+"/?ui=2&view=pt&search=all&th="+e.id},openEmailByItem:function(e,t,i){var a=this,n=e.getAttachmentByPlugin(PluginID.Gmail);if((n&&n!==ut.a.getThreadAttach()||!ut.a.isOpenOnPane(this)||i)&&this.getCacheData(n.id))return this.isAttachmentDraftOnly(n)?(this.sendEvent("Tap_DesktopDraft"),this.loadThread(n,function(){r.default.menus.openComposeEmail(a,n.id)})):ut.a.open(e,n,t,i),!0},_convertRawMessage:function(e,t,i,a){var n={id:t,payload:i},s=this._getMessageFromAttachment(e,t);r.default.Assert(s,"Must be able to get message metadata"),n.labelIds=s.labelIds,n.messageID=s.messageID,n.snippet=s.snippet,n.internalDate=i.internalDate,a(n)},getThreadData:function(e,t,i){if(0!==e.getField("messages").length)return this._getThreadData(e,t,i);this._requestRemoteThreadMetadata(e.getField("accountID"),e.id,void 0,function(a,n){var s=!0;a?this._addRemoteEntry(e.getField("accountID"),a):n&&n.error&&n.error.code===l.a.HTTPStatusCode.NotFound&&(s=!1),s?this._getThreadData(e,t,i):t(!1,"The conversation that you requested no longer exists.")}.bind(this))},_getThreadData:function(e,t,i){for(var a=0,n=e.getField("messages"),s=n.length,o=0,l=!1,d={},u=function(){if(o===s&&l){for(var e=0,i={messages:[]},a=0,u=0;u<n.length;++u){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var c=d[n[u].id];c?i.messages.push(c):++a}r.default.Assert(i.messages.length+a===n.length,"Messages should always be found for thread"),0===n.length?t(void 0,"This message is not cached locally and we could not contact the remote server."):t(i)}},c=function(e){e&&(d[e.id]=e),++o,u()},h=0;h<n.length;++h){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var f=n[h];this.getMessageData(e,f.id,c,i)}l=!0,setTimeout(u.bind(this),0)},getMessageData:function(e,t,i){var a=this;this._rawCache.getEntry(t,function(n){n?a._convertRawMessage(e,t,n,i):(log("Warning: Local message cache missing email display data: ",e.id,t),a._requestRemoteMessageDataRaw(e.getField("accountID"),e.id,t,i))})},_handleThreadLoaded:function(e,t,i,a){var n=this._pendingThreadLoads[e];if(r.default.Assert(n,"Must always have a valid pending load when handling laod"),delete this._pendingThreadLoads[e],n)for(var s=0,o=0;o<n.length;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;try{n[o](t,i,a)}catch(e){r.default.reportError(e)}}},loadThread:function(e,t){r.default.Assert(0===this._loadThreadMutex,"Should never have an outstanding lock on thread load"),this._loadThreadMutex++;var i=e.getField("accountID");j.a.isAuthorized(i,GScope.GmailModify)?this._loadThread(e,t,8e3):j.a.onUserAuthorized(i,"loadThread",function(){j.a.isAuthorized(i,GScope.GmailModify)?this._loadThread(e,t,8e3):t(!1,!1,"This thread belongs to an account ("+e.getField("accountID")+") you are not authorized to access.")}.bind(this),8e3),this._loadThreadMutex--},_loadThread:function(e,t,i){var a=this,n=this.isAttachmentDraftOnly(e),s=this._pendingThreadLoads[e.id];if(s)log("Duped pending thread load: ",e.id),s.push(t);else if(this._pendingThreadLoads[e.id]=[t],e.getField("dataLoaded")||e.isLocalOnlyAttachment()){for(var o=0,l=e.getField("messages"),d=!1,u=!1,c=0,h=0,f=l.length,p=0,g=function(){d&&c===h&&(f===p&&(u=!0),setTimeout(function(){this._handleThreadLoaded(e.id,!0,u)}.bind(this),0))}.bind(this),m=function(t){if(h++,t){""===t.decoded&&(t.decoded=void 0);var i=a._parseMailMessage(t);r.default.Assert(i,"Must be able to parse message"),a._updateMessageData(e,i.id,i),u=!0}g()},v=0;v<l.length;++v){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var _=l[v];void 0===_.decoded?(_.decoded="",c++,this.getMessageData(e,_.id,m,i)):(_.decoded||_.labelIds.indexOf(Kt.DRAFT)>=0)&&p++}d=!0,g()}else if(n){var y=e.getField("messages")[0];this.getMessageData(e,y.id,function(t){if(t){var i=a._parseMailMessage(t);r.default.Assert(i,"Must be able to parse message"),a._updateMessageData(e,i.id,i)}u=!0,a._handleThreadLoaded(e.id,!0,u)},i)}else this.getThreadData(e,function(t,i){t&&a._parseMailThread(e,t),u=!0,a._handleThreadLoaded(e.id,!!e.getField("dataLoaded"),u,i)},i)},forceReloadMessage:function(e,t,i){this._requestRemoteMessageData(e,t,i)},_verifyEmailAttachments:function(e,t,i){var a,n,s=this,o=this._findDraft(e,t,i);return o?o.resources.forEachResource(function(e){e.uploader&&(e.uploader.hasError()?a="There was an error uploading one or more attachments. Please remove them or try uploading again.":e.uploader.isDone()||(a="One or more of your attachments is still uploading.",n=function(e){s.onEmailReadyToSend(o,function(){r.default.toasts.clearMessage(e)})}))}):a="Could not find message to verify attachments.",a?{message:a,handleMessageFn:n}:void 0},_verifyEmailRecipients:function(e,t,i){var a,n=this._findDraft(e,t,i);if(n)if(n.to&&0!==n.to.length)for(var s=0,o=0;o<n.to.length;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var l=n.to[o];l&&l.email?r.default.isEmail(l.email)||(a="You have entered an invalid email"):a="You have entered a contact with an invalid email address"}else a="You must enter at least one person to send this email to";else a="Unable to find the message you are trying to send";return a?{message:a}:void 0},_formatAddressText:function(e,t,i){return e?i?'"'+r.default.encodeMIMEHeader(e)+'" <'+t+">":'"'+e+'" <'+t+">":t},_createAddressTextFromTokens:function(e,t){var i="";if(e)for(var a=0,n=0;n<e.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=e[n];r.default.isEmail(s.email)&&(0!==n&&(i+=", "),i+=this._formatAddressText(s.text,s.email,t))}return r.default.Assert(!i.startsWith(","),"Should not start with a comma"),r.default.Assert(!i.endsWith(","),"Should not end with a comma"),r.default.Assert(i.indexOf(",,")<0,"Should not have two commas in a row"),i.trim()},_createRFC822Message:function(e,t,i,a){r.default.Assert(t,"Must specify a valid draft"),r.default.Assert(t.contentType,"Must specify a valid content type for the draft"),r.default.Assert(t.from,"Must be able to get the from information for a user."),r.default.Assert(!t.inReplyTo||t.inReplyTo.indexOf("undefined")<0,"Should not have an undefined message id in reply-to: "+t.inReplyTo),r.default.Assert(!t.references||t.references.indexOf("undefined")<0,"Should not have an undefined message id in references: "+t.references);var n=t.from.text,s=t.from.email,o=new lt(this);o.updateFromDraft(e,t,n,s,i,function(){var e=o.generateBlob();a(this._encodeEmail(e))}.bind(this))},createSignature:function(e){var t=this.getSignature(e);return t?this.getSetting(this.Settings.InsertSignatureAboveReplies)?'<br/><br/><div class="gmail_signature">'+t+"</div><br/>":'<br/><br/>--<br/><div class="gmail_signature">'+t+"</div>":'<div class="gmail_signature"></div>'},createReplyQuote:function(e){var t;e&&(t='<br>\n<div class="gmail_extra">\n<br>\n<div class="gmail_quote">'+("On "+e.date.toString("MMM dd, y")+" at "+e.date.toString("hh:mm tt")+", "+r.default.escape(this._createAddressTextFromTokens([e.from]))+" wrote:")+'\n<br>\n<blockquote class="gmail_quote" style="margin:0 0 0 0.8ex;border-left:1px #ccc solid;padding-left:1ex">\n'+e.decoded+"\n</blockquote>\n</div>\n<br>\n</div>\n");return t},createForwardQuote:function(e){var t,i=r.default.isArray(e.to)?e.to:[e.to];return e&&(t='<br>\n<div class="gmail_quote">\n<br>\n---------- Forwarded message ----------<br>\nFrom: '+r.default.escape(this._createAddressTextFromTokens([e.from]))+"<br>\nDate: "+e.date.toString("ddd, MMM dd, y")+" at "+e.date.toString("hh:mm tt")+"<br>\nSubject: "+e.subject+"<br>\nTo: "+r.default.escape(this._createAddressTextFromTokens(i))+"\n<br>\n<br>\n"+e.decoded+"\n</div>\n<br>\n"),t},createMessageBody:function(e,t,i){var a,n=this.createSignature(t);return i===l.a.EmailResponseMode.Reply||i===l.a.EmailResponseMode.ReplyAll?a=this.createReplyQuote(e):i===l.a.EmailResponseMode.Forward?a=this.createForwardQuote(e):r.default.Assert(!1,"Invalid email response mode: "+i),this.getSetting(this.Settings.InsertSignatureAboveReplies)?n+a:a+n},_sendEmail:function(e,t,i,a){var n=this;this.sendEvent("SendDraft"),this._clearPendingDraftUpdate(e,t);var s=this._findDraft(e,t,i);this._createRFC822Message(e.getData(),s,!0,function(t){var i={raw:t};e.isLocalOnlyAttachment()||(i.threadId=e.id);var r=I.a.fns("gmail").users.messages.send.packedFn,o={userId:e.getField("accountID"),resource:i};n._queueRemoteRequestMulti(e.getField("accountID"),r,o,function(t){n._updateLocalDraftFromSend(e,s.id,t,a)},function(t){n._notifySendFailed(),a(!1,t),n._notifyFailedRequest(e.getField("accountID"),t)},void 0,Pt)})},_shouldSaveMessageContent:function(e,t){return t.labelIds.indexOf(Kt.DRAFT)>=0},compactCacheField:function(e,t){var i,a=0;switch(t){case"messages":i=[];for(var n=e[t],s={},o=function(e){var t=r.default.clone(e);delete t.data,delete t.size,delete t.uploader,s[e.id]=t},l=0;l<n.length;++l){var d=0;if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;for(var u=n[l],c={},h=0;h<Jt.length;++h){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;c[Jt[h]]=u[Jt[h]]}this._shouldSaveMessageContent(e,u)||(delete c.decoded,delete c.mimeType,delete c.contentType,delete c.listUnsubscribe),c.resources.forEachResource(o),c.resources=s,i.push(c)}break;default:i=e[t]}return i},_generateUndoRedo:function(){this._undoStack.registerOwner(this,this.id),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.Archive,{undo:this.unarchiveAttachment,redo:this.archiveAttachment}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.Unarchive,{undo:this.archiveAttachment,redo:this.unarchiveAttachment}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.Trash,{undo:this.untrashAttachment,redo:this.trashAttachment}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.Untrash,{undo:this.trashAttachment,redo:this.untrashAttachment}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.AddLabel,{undo:this.removeLabelFromAttachment,redo:this.addLabelToAttachment}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.RemoveLabel,{undo:this.addLabelToAttachment,redo:this.removeLabelFromAttachment}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.MarkRead,{undo:this.markAttachmentUnread,redo:this.markAttachmentRead}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.MarkUnread,{undo:this.markAttachmentRead,redo:this.markAttachmentUnread}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.Star,{undo:this.markAttachmentUnstarred,redo:this.markAttachmentStarred}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.Unstar,{undo:this.markAttachmentStarred,redo:this.markAttachmentUnstarred}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.SetPriority,{undo:this.setAttachmentPriority,redo:this.setAttachmentPriority}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.Move,{undo:this.unmoveItem,redo:this.moveItem}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.Snooze,{undo:this.unsnoozeAttachment,redo:this.snoozeAttachment}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.ScheduleSend,{undo:this.cancelSendMessage,redo:this.scheduleSendMessage}),this._undoStack.registerAction(this.id,l.a.PluginAction.Gmail.DiscardDraft,{undo:r.default.emptyFn,redo:this.runDiscardDraft})},performAction:function(e,t,i,a,n){var s;r.default.Assert(e,"Must supply a valid action"),r.default.Assert(r.default.isBoolean(t),"Invalid preventUndo param"),this.beginAction(t);var o=[i,a,n];try{s=this._undoStack.runAction(this.id,e,o)}catch(e){r.default.reportError(e)}if(this._undoStack.isUndoableAction()){var l=[i];r.default.isArray(s)?l.pushArray(s):l.push(s),this._undoStack.performAction(this.id,e,{undoParams:l,redoParams:o})}this.endAction()},performActions:function(e,t){var i=0;this.beginAction(t);for(var a=0;a<e.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;this.performAction(e[a].action,e[a].attach,e[a].param)}this.endAction()},beginAction:function(e){this._undoStack.beginAction(e),y.a.beginAction()},endAction:function(){this._undoStack.endAction(),y.a.endAction()},handleUndo:function(){y.a.beginAction(),this._undoStack.undoAction(),y.a.endAction()},handleRedo:function(){y.a.beginAction(),this._undoStack.redoAction(),y.a.endAction()},supportOfflineCache:function(){return!0},supportOfflineLoad:function(){return!0},usesPreviewCache:function(){return!0},_matchParticipant:function(e,t){var i=!1;return e&&(e.text&&(i=e.text.toLowerCase().indexOf(t)>=0),!i&&e.email&&(i=e.email.toLowerCase().indexOf(t)>=0)),i},_matchLabels:function(e,t){return this.hasLabelLike(e.accountID,e.id,t)},_matchEntry:function(e,t){return e.subjectLower.indexOf(t)>=0||this._matchParticipant(e.from,t)||this._matchLabels(e,t)},matchAttachment:function(e,t){return this._matchEntry(e.getData(),t)},findMatchExact:function(){},findMatchLike:function(e,t){var i=e.toLowerCase();return this.findCachedItemsByFn(function(e){return this._matchEntry(e,i)}.bind(this),t)},isGmailItem:function(e){return!!e.getAttachmentByPlugin(this.id)},itemHasLabelByID:function(e,t){var i=e.getAttachmentByPlugin(this.id);return!!i&&this.attachmentHasLabelByID(i,t)},itemHasLabel:function(e,t){var i=e.getAttachmentByPlugin(this.id);return!!i&&this.attachmentHasLabel(i,t)},itemHasFullLabel:function(e,t){var i=e.getAttachmentByPlugin(this.id);return!!i&&this.attachmentHasFullLabel(i,t)},itemHasDraft:function(e){return this.itemHasLabelByID(e,Kt.DRAFT)},isItemUnread:function(e){return this.itemHasLabelByID(e,Kt.UNREAD)},isItemImportant:function(e){return this.itemHasLabelByID(e,Kt.IMPORTANT)},isItemStarred:function(e){return this.itemHasLabelByID(e,Kt.STARRED)},isItemArchived:function(e){var t=e.getAttachmentByPlugin(this.id);return!!t&&this.attachmentIsArchived(t)},isItemTrashed:function(e){return this.itemHasLabelByID(e,Kt.TRASH)},isItemFullTrashed:function(e){return this.itemHasFullLabel(e,Yt.TRASH)},isItemSpam:function(e){return this.itemHasLabelByID(e,Kt.SPAM)},isDisplayItem:function(e,t){var i=!1;return this.isItemSpam(e)||!this.isThreadItem(e)||this.isItemFullTrashed(e)&&!t||(i=!0),i},getItemPriority:function(e){return e.hasPluginAttachment(this.id)?this.getAttachmentPriority(e.getAttachmentByPlugin(this.id)):0},_getCompDateForItem:function(e){var t=0,i=e.getAttachmentByPlugin(this.id);if(i){var a=i.getField("lastModifiedDate");if(a)t=a.getTime();else{var n=i.getField("internalDate");n&&(t=n.getTime())}}return t},_timeCompare:function(e,t){return e>t?1:e<t?-1:0},threadSortFn:function(e,t){return this._timeCompare(this._getCompDateForItem(t),this._getCompDateForItem(e))},threadSortPriorityFn:function(e,t){var i=e.getAttachmentByPlugin(this.id),a=t.getAttachmentByPlugin(this.id),n=this.getAttachmentPriority(i),s=this.getAttachmentPriority(a),r=this.attachmentHasLabelByID(i,Kt.STARRED),o=this.attachmentHasLabelByID(a,Kt.STARRED);return n>s?-1:n<s?1:r&&!o?-1:o&&!r?1:this._timeCompare(this._getCompDateForItem(t),this._getCompDateForItem(e))},labelSortFn:function(e,t){return e.displayCompare(t)},labelVMLISortFn:function(e,t){var i=this._getLabelByID(this._getAccountIDFromItem(e),this._getLabelIDFromItem(e)),a=this._getLabelByID(this._getAccountIDFromItem(t),this._getLabelIDFromItem(t));return this.labelSortFn(i,a)},sortFn:function(e,t){return e.getParsedText().localeCompare(t.getParsedText())},getCssClass:function(e,t){if(t&&t.type===this.getPaneType())return r.default.classNames({starred:this.attachmentHasLabelByID(e,Kt.STARRED)},{unread:this.attachmentHasLabelByID(e,Kt.UNREAD)},{p0:this.attachmentHasLabel(e,Qt.PRI0)},{p1:this.attachmentHasLabel(e,Qt.PRI1)},{p2:this.attachmentHasLabel(e,Qt.PRI2)})},getTotalMessageCount:function(e){var t=this._threadCache;t.onCacheReady(function(){t.count(e)})},getUnsyncdMessageCount:function(){return this._numUnsyncdMessages},getSyncdMessageCount:function(){return this._numSyncdMessages},_checkUnsyncdMessageContent:function(e){for(var t=0,i=0;i<e.messages.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=e.messages[i];a.cached?(this.reportTrackedStat(It.SyncdMessage),this._numSyncdMessages++):a.cachedError?this.reportTrackedStat(It.ErrorSyncdMessage):this._shouldCacheMessageData(e)?(this.reportTrackedStat(It.UnsyncdMessage),this._notifyUnsyncdMessage(e.accountID,e.id,a.id)):this.reportTrackedStat(It.OldUnsyncdMessage)}},_notifyUnsyncdMessage:function(e,t,i){r.default.isTempId(t)||r.default.isTempId(i)||(this._handleSyncContentCacheOp(this._unsyncdMessages,e,t,i),this._numUnsyncdMessages++,this._contentSyncTask.notifyWorkAvailable())},_notifyContentCached:function(e,t,i){this._numSyncdMessages++,this._handleSyncContentCacheOp(this._pendingSyncdMessages,e,t,i)},_handleSyncContentCacheOp:function(e,t,i,a){var n=this._ensureAccountLib(t,e);n[i]?!0!==n[i]&&n[i].indexOf(a)<0&&n[i].push(a):n[i]=!a||[a]},_removeUnsyncdMessage:function(e,t,i){this.reportTrackedStat(It.MessagesSyncd),this._numUnsyncdMessages--;var a=this._getAccountLib(e,this._unsyncdMessages);if(i){var n=a[t];n.remove(i),0===n.length&&delete a[t]}else delete a[t];r.default.isEmpty(a)&&this._deleteAccountLib(e,this._unsyncdMessages)},_setCachedFieldForMessage:function(e,t,i){if(this.hasCacheData(t))for(var a=0,n=this.getAttachment(t).getField("messages"),s=0;s<n.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;(!0===i||i.indexOf(n[s].id)>=0)&&(n[s].cached=!0)}this._threadCache.getEntry(t,function(e){if(e){for(var a=0,n=0;n<e.messages.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=e.messages[n];(!0===i||i.indexOf(s.id)>=0)&&(s.cached=!0)}this.cacheThreadData(t,e)}}.bind(this))},_updateCachedErrorFieldForMessage:function(e,t,i){if(this.hasCacheData(t))for(var a=0,n=this.getAttachment(t).getField("messages"),s=0;s<n.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;(!0===i||i.indexOf(n[s].id)>=0)&&(n[s].cachedError?n[s].cachedError++:n[s].cachedError=1)}this._threadCache.getEntry(t,function(e){if(e){for(var a=0,n=0;n<e.messages.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=e.messages[n];(!0===i||i.indexOf(s.id)>=0)&&(s.cached?s.cachedError++:s.cachedError=1)}this.cacheThreadData(t,e)}}.bind(this))},_processSyncdContent:function(){for(var e in this._pendingSyncdMessages)if(this._pendingSyncdMessages.hasOwnProperty(e)){var t=this._pendingSyncdMessages[e];for(var i in t)if(t.hasOwnProperty(i)){var a=t[i];if(r.default.isArray(a)){for(var n=0,s=0;s<a.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var o=a[s];this._removeUnsyncdMessage(e,i,o)}this._setCachedFieldForMessage(e,i,a)}else!0===a&&this._removeUnsyncdMessage(e,i)}}this._pendingSyncdMessages={}},_processSyncErrors:function(e){for(var t in log("Process Sync Errors: ",e),e)if(e.hasOwnProperty(e)){var i=e[t];for(var a in i)if(i.hasOwnProperty(a)){var n=0,s=i[a];r.default.Assert(r.default.isArray(s),"Must have a valid message ID list");for(var o=0;o<s.length;++o){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var l=s[o];this._removeUnsyncdMessage(t,a,l)}this._updateCachedErrorFieldForMessage(t,a,s)}}},driveMessageContentSync:function(e){var t=this;this._rawCache.onCacheReady(function(){if(r.default.vmMain.cacheManager.hasReportedQuotaError())return e(!1);t._outstandingContentSync=!0,t._runMessageContentSync(35,function(i,a){if(!i)try{t._processSyncErrors(a)}catch(e){r.default.reportError(e)}return t._processSyncdContent(),t._outstandingContentSync=!1,e(!r.default.isEmpty(t._unsyncdMessages))})})},_runMessageContentSync:function(e,t){var i=0,a=0,n=!1,s=0,r=0,o={};function l(e,i,l){if(e?s++:(r++,o[i]=l),n&&s+r===a){var d=0===r;t(d,d?void 0:o)}}var d=this.getSyncAccounts();for(var u in this._unsyncdMessages)if(d.indexOf(u)>=0&&(i+=this._syncMessageContentForAccount(u,this._unsyncdMessages[u],e-i,l),a++,i>=e))break;return n=!0,0===i&&setTimeout(function(){t(!0)},0),i},_syncMessageContentForAccount:function(e,t,i,a){var n=0,s=0,r=0,o=0,l={},d=function(t,i,n){if(t?r++:(o++,l[i]=n),r+o===s){var d=0===o;a(d,e,d?void 0:l)}};for(var u in t)if(t.hasOwnProperty(u)&&(n+=this._syncMessageContentForThread(e,u,t[u],i-n,d),s++,n>=i))break;return n},_syncMessageContentForThread:function(e,t,i,a,n){var s=this,o=0;if(r.default.isArray(i)){for(var l=0,d=!1,u=0,c=[],h=function(i,a){if(a?(u++,s._notifyContentCached(e,t,i)):c.push(i),d&&u+c.length===o){var r=0===c.length;n(r,t,r?void 0:c)}},f=0;f<i.length&&o<a;++f){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;this._requestRemoteMessageDataRaw(e,t,i[f],function(i,a,n){a?this._handleContentSyncdMessage(e,t,a,h.bind(this,i)):h.call(this,i,!1)}.bind(this,i[f])),o++}d=!0}else this._requestRemoteThreadDataRaw(e,t,function(i,a){i?s._handleContentSyncdThread(e,i,function(i){s._notifyContentCached(e,t),n(i,t)}):n(!1,t,!0)}),o++;return o},_handleContentSyncdMessage:function(e,t,i,a){i.payload.id=i.id,i.payload.internalDate=i.internalDate,this._rawCache.cacheEntry(i.id,i.payload,a)},_handleContentSyncdThread:function(e,t,i){for(var a=0,n=0;n<t.messages.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=t.messages[n];this._handleContentSyncdMessage(e,t.id,s,i)}},scheduleEmail:function(e,t){y.a.beginAction();var i=e.getAttachmentByPlugin(this.id);r.default.Assert(i,"Must be able to get a valid attachment from item");var a=i.getField("subject"),n=this.createURLForThread(i),o=l.a.MSPerHour,d=r.default.vmMain.getDefaultCalendarPlugin();if(d){var u=d.getDefaultExportCalendarID();u&&(r.default.isDemoMode()||d.getSetting(d.Settings.WriteAccess))?d.createEventForEmail(u,a,n,t,o,function(e,t){e||t?t?(this.addLabelToAttachment(i,"Moo.do/Scheduled"),this.getSetting(this.Settings.ArchiveOnSchedule)&&this.archiveAttachment(i)):t||r.default.toasts.pushMessage({text:"There was an error adding the event to your Google Calendar.",action:MessageAction.Okay}):r.default.toasts.pushMessage({text:"There was an error adding the email to your Google Calendar, and it was not saved locally.",actionText:"LEARN MORE",action:function(){s.default.overQuota?r.default.toasts.pushMessage({text:"You are offline and your computer's storage quota has been exceeded. Please free up space on your device. Please contact support@moo.do if you have questions.",action:MessageAction.Okay}):r.default.toasts.pushMessage({text:"You are offline and we were unable to save your event information to your device. Please contact support@moo.do if you have questions.",action:MessageAction.Okay})}})}.bind(this)):r.default.toasts.pushMessage({text:"You must select an export calendar to enable scheduling and editing of events.",action:MessageAction.OpenCalendarSettings})}else r.default.toasts.pushMessage({text:"The Google Calendar plugin must be enabled to schedule emails.",action:MessageAction.OpenSettings});y.a.endAction()},getIconForLabel:function(e){switch(e.getParsedText()){case"Inbox":return"inbox2";case"Starred":return"star";case"Important":return"exclamation";case"Sent Mail":return"send";case"Draft":return"drafts";case"Archived":return"inbox";case"Trash":return"delete";case"Primary":return"user";case"Social":return"group";case"Promotions":return"tag";case"Updates":return"flag";case"Forums":return"question_answer";case"Chat":return"chat";case"Spam":return"warning"}}};o.a.inherit(pe,Ii),o.a.extend(Ii.prototype,bi);var Ai=Ii;function Di(){this._isBuiltin=!0,this._super.constructor.call(this,PluginID.Moodo,"Moodo"),this.setSetting(this.Settings.IsEnabled,!0),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.Unknown),this.useRenderer(PluginRenderTypes.Measure,PluginRenderers.Unknown)}var Ti=1,Mi=3,Ci=4,Li=5,Pi=6,Ei=7,ki=8,xi=9,Ri=10,Oi=11,Fi=12,Ni=13,Bi="createdDate,lastViewedByMeDate,id,mimeType,owners(displayName,isAuthenticatedUser,permissionId,emailAddress),parents(id,isRoot),permissions(id,name,emailAddress,role,type),properties,shared,appDataContents,sharedWithMeDate,sharingUser(displayName,permissionId,emailAddress),title,labels,userPermission(id,role,type)",Ui={isPluginBlocked:function(){return!1},allowRemoteRequests:function(){return!0},getRemoteAttachmentData:function(e){this.cacheData(e.id,{})},runRemoteSingleRequest:function(e,t,i,a){this._queueRemoteRequest(e,t,i,a,void 0,Ti)},runRemotePagedRequest:function(e,t,i,a,n,s){this._queuePagedRemoteRequest(e,t,i,a,void 0,s,n)},drivePermissionsInsert:function(e,t,i,a,n){r.default.Assert(r.default.isEmail(t),"Should pass in a valid email address");var s=I.a.fns("drive").permissions.insert.packedFn,o={fileId:e,sendNotificationEmails:i,resource:{value:t,type:"user",role:"writer",withLink:!1}};this._queueRemoteRequest(s,o,a,n,void 0,Mi)},drivePermissionsDelete:function(e,t,i,a){var n=I.a.fns("drive").permissions.delete.packedFn,s={fileId:e,permissionId:t};this._queueRemoteRequest(n,s,i,a,void 0,Ci)},drivePermissionsList:function(e,t,i){var a=I.a.fns("drive").permissions.list.packedFn,n={fileId:e,fields:"items(id,name,role,type,emailAddress)"};this._queueRemoteRequest(a,n,t,i,void 0,Li)},drivePermissionsPublic:function(e,t,i){var a=I.a.fns("drive").permissions.insert.packedFn,n={fileId:e,sendNotificationEmails:!1,resource:{type:"anyone",role:"reader",withLink:!0}};this._queueRemoteRequest(a,n,t,i,void 0,Mi)},driveFilesGet:function(e,t,i){var a=I.a.fns("drive").files.get.packedFn,n={fileId:e,fields:Bi};this._queueRemoteRequest(a,n,t,i,void 0,Pi)},driveFilesList:function(e,t,i,a){var n=I.a.fns("drive").files.list.packedFn,s={q:e,fields:"items(createdDate,lastViewedByMeDate,id,mimeType,owners(displayName,isAuthenticatedUser,permissionId,emailAddress),parents(id,isRoot),permissions(id,name,emailAddress,role,type),properties,shared,appDataContents,sharedWithMeDate,sharingUser(displayName,permissionId,emailAddress),title,labels,userPermission(id,role,type)),nextPageToken"};this.runRemotePagedRequest(n,s,t,i,a,Ei)},driveFilesTrash:function(e,t,i){var a=I.a.fns("drive").files.trash.packedFn,n={fileId:e};this._queueRemoteRequest(a,n,t,i,void 0,ki)},driveFilesUntrash:function(e,t,i){var a=I.a.fns("drive").files.untrash.packedFn,n={fileId:e};this._queueRemoteRequest(a,n,t,i,void 0,ki)},drivePropertiesInsert:function(e,t,i,a,n){var s=I.a.fns("drive").properties.insert.packedFn,r={fileId:e,resource:{key:t,value:i,visibility:"PRIVATE"}};this._queueRemoteRequest(s,r,a,n,void 0,xi)},drivePropertiesUpdate:function(e,t,i,a,n){var s=I.a.fns("drive").properties.update.packedFn,r={fileId:e,propertyKey:t,resource:{key:t,value:i,visibility:"PRIVATE"}};this._queueRemoteRequest(s,r,a,n,void 0,Ri)},driveParentsInsert:function(e,t,i,a){var n=I.a.fns("drive").parents.insert.packedFn,s={fileId:e,resource:{id:t}};this._queueRemoteRequest(n,s,i,a,void 0,Oi)},driveParentsDelete:function(e,t,i,a){var n=I.a.fns("drive").parents.delete.packedFn,s={fileId:e,parentId:t};this._queueRemoteRequest(n,s,i,a,void 0,Fi)},driveChildrenList:function(e,t,i,a){var n=I.a.fns("drive").children.list.packedFn,s={folderId:e,fields:"items(id),nextPageToken"};this.runRemotePagedRequest(n,s,t,i,a,Ni)}};o.a.inherit(pe,Di),o.a.extend(Di.prototype,Ui);var Vi=Di,Hi=["SU","MO","TU","WE","TH","FR","SA"],qi=500,zi=new Date(1401606e6);function Wi(e){this._valid=!0,this._initData=e,this._maxCount=qi,r.default.isString(e)?this.fromString(e):r.default.isArray(e)?this.fromICal(e):e instanceof Wi?(this._startDate=new Date(e._startDate),this._endDate=e._endDate?new Date(e._endDate):void 0,this._frequency=e._frequency,this._separation=e._separation,this._offsets=e._offsets?e._offsets.slice():void 0):r.default.isObject(e)?(r.default.Assert(e.type===DateType.Repeat,"Must have a valid date type set"),this._startDate=new Date(e.startDate),this._endDate=e.endDate?new Date(e.endDate):void 0,this._frequency=e.frequency,this._separation=e.separation||1,this._offsets=e.offsets):(r.default.Assert(!1,"Invalid object passed to RepeatDate constructor",e),this._valid=!1),this._startDate?(r.default.Assert(this._startDate instanceof Date,"Must be a valid date instance"),r.default.Assert(this._startDate.isAfter(zi),"Start date must be after the minimum start date"),r.default.Assert(!this._endDate||this._endDate instanceof Date,"Must be a valid date instance"),r.default.Assert(!this._offsets||this._offsets.length>=1,"Must always store at least one offset if _offsets is defined",this._offsets),this._endDate&&(this._startDate.isBefore(this._endDate)||this._startDate.equals(this._endDate)||(this._valid=!1,r.default.Assert(!1,"Start date must always be before the end date")))):this._valid=!1,this._doneGenerating=!this._valid,this._cache=[],this._cacheDate=new Date(this._startDate)}Wi.prototype={isValid:function(){return this._valid},_isValidDate:function(e){return e&&e instanceof Date},setStartDate:function(e){r.default.Assert(e,"Must provide a valid date"),this._startDate=new Date(e),this._endDate&&(this._startDate.isBefore(this._endDate)||this._startDate.equals(this._endDate)||(this._valid=!1,r.default.Assert(!1,"Start date must always be before the end date"))),this._resetCache()},getStartDate:function(){return this._startDate},getEndDate:function(){return this._endDate},_isBeforeEnd:function(e){r.default.Assert(this._isValidDate(e),"Must provide a valid date: ",e);var t=this._cache.length<this._maxCount,i=!this._endDate||(e.isBefore(this._endDate)||e.equals(this._endDate));return t&&i},_resetCache:function(){this._cache=[],this._cacheDate=new Date(this._startDate),this._doneGenerating=!this._valid},_getNext:function(e){return this._cache.length<e&&this._generate(e),this._cache.slice(0,e)},_generateUntil:function(e){var t=0;r.default.Assert(this._isValidDate(e),"Must provide a valid date to generate until: ",e);for(var i=!1,a=0;!this._doneGenerating&&(!this._getLastCachedDate()||this._getLastCachedDate().isBefore(e))&&a<50;){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this._generateNext(1),i=!0,a++}return i},_generateNext:function(e){r.default.Assert(e>0,"Must request a valid number of additional dates"),this._generate(this._cache.length+e)},_doGenerateInstance:function(e,t,i){var a=!1;switch(t){case RepeatFreq.Weekly:a=e.getDay()<=i;break;case RepeatFreq.DayOfMonth:a=e.getDate()<=i;break;default:r.default.Assert(!1,"Invalid repeat frequency for offset dates",t)}return a},_generate:function(e){var t=0,i=0;r.default.Assert(e>0,"Must request a valid number of dates"),r.default.Assert(e<this._maxCount,"Must request less than maxCount dates");var a=new Date(this._cacheDate);e=Math.min(e,this._maxCount);for(var n=0;n<e&&this._cache.length<e&&this._isBeforeEnd(a);){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(this._offsets)for(var s=0,o=0;o<this._offsets.length&&this._cache.length<e;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var l=this._offsets[o],d=new Date(a);if(this._doGenerateInstance(d,this._frequency,l)){switch(this._frequency){case RepeatFreq.Weekly:d.addDays(l-d.getDay());break;case RepeatFreq.DayOfMonth:d.addDays(l-d.getDate());break;default:r.default.Assert(!1,"Invalid repeat frequency for offset dates",this._frequency)}var u=this._cache[this._cache.length-1];!this._isBeforeEnd(d)||u&&!d.isAfter(u)?this._isBeforeEnd(d)||(this._doneGenerating=!0):this._cache.push(d)}}else{d=new Date(a),u=this._cache[this._cache.length-1];if(!this._isBeforeEnd(d)||u&&!d.isAfter(u))return void(this._isBeforeEnd(d)||(this._doneGenerating=!0));this._cache.push(d)}switch(this._frequency){case RepeatFreq.Daily:a.addDays(this._separation);break;case RepeatFreq.Weekly:this._offsets&&this._offsets.length>1&&a.getDay()!==this._offsets[0]&&a.moveToDayOfWeek(this._offsets[0],-1),a.addWeeks(this._separation);break;case RepeatFreq.Monthly:a.addMonths(this._separation);break;case RepeatFreq.NthMonthInst:var c=this._startDate.getDay(),h=Math.ceil(this._startDate.getDate()/7);a.addMonths(this._separation),4!==h&&5!==h||(h=-1),a.moveToNthOccurrence(c,h);break;case RepeatFreq.Yearly:a.addYears(this._separation);break;case RepeatFreq.EndOfMonthOffset:a.addMonths(this._separation);var f=this._startDate.getDate(),p=this._startDate.getDaysInMonth()-f;a.setDate(a.getDaysInMonth()-p);break;case RepeatFreq.DayOfMonth:for(o=0;o<this._separation;++o){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;this.getNextValidMonth(a,this._startDate.getDate())}break;case RepeatFreq.Once:default:return r.default.Assert(!1,"Invalid repeat frequency"),void(this._doneGenerating=!0)}this._cacheDate=a,n++}this._isBeforeEnd(a)||(this._doneGenerating=!0)},getNextValidMonth:function(e,t){(r.default.Assert(this._isValidDate(e),"Must provide a valid date: ",e),e.addMonths(1),e.getDate()!==t)&&(t>e.getDaysInMonth()&&(e.addMonths(1),e.setDate(t)))},includesDate:function(e){for(var t=0,i=this.getDates(!1),a=0;a<i.length;a++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(i[a].clone().clearTime().equals(e))return!0}return!1},getDates:function(e){r.default.Assert(this._valid,"Must not call getDates with invalid RepeatDate: ",this._initData);var t=new Date;this._generate(4),this._generateUntil(t);var i=this._cache.findInsertIndex(t,Date.compare),a=this._cache.length-i;a<4&&this._generateNext(4-a);var n=e?Math.max(i,0):Math.max(i-3,0),s=Math.min(i+4,this._cache.length);return this._cache.slice(n,s)},getDateOnDay:function(e){if(r.default.Assert(r.default.isDateValid(e),"Day is not valid",e),e){var t=this._cache.findInsertIndex(e,Date.compare);return this._cache[t]}},next:function(e){if(e>0)return this._getNext(e)},nextIndex:function(e){r.default.Assert(this._valid,"Must not call nextIndex with invalid RepeatDate: ",this._initData),r.default.Assert(!e||this._isValidDate(e),"Must provide a valid from date",e);var t=e?new Date(e):this._startDate;if(this._generateUntil(t))return this._cache.length-1;for(var i=0,a=0;a<this._cache.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(this._cache[a].isAfter(t)||this._cache[a].equals(t))return a}return this._generateNext(1),this._cache.length-1},nextComplete:function(e){r.default.Assert(this._valid,"Must not call nextComplete with invalid RepeatDate: ",this._initData),r.default.Assert(!e||this._isValidDate(e),"Must provide a valid from date",e);var t=this.nextIndex(e);return this._cache[t]},nextActive:function(e){r.default.Assert(this._valid,"Must not call nextActive with invalid RepeatDate: ",this._initData),r.default.Assert(!e||this._isValidDate(e),"Must provide a valid from date",e);var t=this.nextIndex(e);return this._cache.length<=t+1&&this._generateNext(1),this._cache[t+1]},_getLastCachedDate:function(){return this._cache[this._cache.length-1]},hasTimeOfDay:function(){return!!this._valid&&this._startDate.hasTimeOfDay()},isRepeatDate:function(){return!0},getTimeOfDay:function(){return this._valid?this._startDate.getTimeOfDay():0},getTime:function(e){return this._valid?this._startDate.toString(e):""},equals:function(e){if(this._valid){if(r.default.isString(e))return this.toString()===e;if(e instanceof Wi){if(e._valid){var t=!isNaN(this._startDate)&&!isNaN(e._startDate)&&this._startDate.equals(e._startDate),i=this._endDate?this._endDate.equals(e._endDate):this._endDate===e._endDate,a=this._frequency===e._frequency,n=this._separation===e._separation,s=this._offsets?this._offsets.equals(e._offsets):this._offsets===e._offsets;return t&&i&&a&&n&&s}}else if(r.default.isObject(e)){r.default.Assert(e.type===DateType.Repeat,"Must have a valid date type set");var o=new Date(e.startDate);r.default.Assert(this._isValidDate(o),"Must provide a valid comp date",o);t=!isNaN(this._startDate)&&!isNaN(o)&&this._startDate.equals(o),i=this._endDate==(e._endDate?new Date(e._endDate):void 0),a=this._frequency===e.frequency,n=this._separation===e._separation,s=this._offsets?this._offsets.equals(e._offsets):this._offsets===e._offsets;return t&&i&&a&&n&&s}}return!1},fromString:function(e){try{var t=e.split("|"),i=t[0];if("1"===i){if(this._startDate=new Date(parseInt(t[1])),this._endDate=t[2]?new Date(parseInt(t[2])):void 0,this._frequency=parseInt(t[3]),this._separation=parseInt(t[4]),r.default.Assert(r.default.isNumber(this._frequency),"Invalid frequency",t[3]),r.default.Assert(r.default.isNumber(this._separation),"Invalid frequency",t[4]),this._offsets=void 0,t[5]){var a=t[5].split(",");if(a.length>0){var n=0;this._offsets=[];for(var s=0;s<a.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var o=parseInt(a[s]);r.default.Assert(r.default.isNumber(o),"Date offsets must be valid numbers",a[s]),this._offsets.push(o)}}}(!this._isValidDate(this._startDate)||this._endDate&&!this._isValidDate(this._endDate))&&(r.default.Assert(!1,"Invalid start or end date parsing from string",this._startDate,this._endDate),this._valid=!1)}else r.default.Assert(!1,"Unknown repeated date version: ",i),this._valid=!1}catch(e){this._valid=!1,r.default.reportError(e)}this._resetCache()},toString:function(){if(this._valid){var e=this._startDate.getTime(),t=this._endDate?this._endDate.getTime():"",i=this._offsets&&this._offsets.length>1?this._offsets.join(","):"";return"1|"+e+"|"+t+"|"+this._frequency+"|"+this._separation+"|"+i}},toICal:function(){var e=0,t=[],i={};if(this._valid){switch(this._startDate&&t.push("DTSTART:"+this._startDate.getTime()+"Z"),this._endDate&&(i.UNTIL=this._endDate.getTime()+"Z"),this._frequency){case RepeatFreq.Daily:i.FREQ="DAILY";break;case RepeatFreq.Weekly:i.FREQ="WEEKLY";for(var a=this._startDate.clone(),n=[Hi[a.getDay()]],s=0;s<this._offsets.length;++s){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;a.moveToDayOfWeek(this._offsets[s]),n.push(Hi[a.getDay()])}i.BYDAY=n.toString();break;case RepeatFreq.Monthly:i.FREQ="MONTHLY";break;case RepeatFreq.DayOfMonth:i.FREQ="MONTHLY",i.BYMONTHDAY=this._startDate.getDate();break;case RepeatFreq.Yearly:i.FREQ="YEARLY";break;case RepeatFreq.EndOfMonthOffset:i.FREQ="MONTHLY",i.BYMONTHDAY=-this._startDate.getDate();break;case RepeatFreq.NthMonthInst:i.FREQ="MONTHLY",i.BYDAY=Hi[this._getStartDate.getDay()],i.BYSETPOS=Math.ceil(this._getStartDate.getDate()/7);break;default:r.default.Assert(!1,"Invalid repeat date frequencey: "+this._frequency)}i.INTERVAL=this._separation;var o="RRULE:";for(var l in i)o+=l+"="+i[l]+";";t.push(o)}return t},_handleICalString:function(e,t){for(var i=0,a=e.split(";"),n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=a[n].split("=");t(s[0],s[1])}},_handleDTSTART:function(e){r.default.Assert(e.endsWith("Z"),"Timestamp must be in UTC time: "+e),log("DTSTART: ",e),this._startDate=new Date(parseInt(e.slice(0,-1))),r.default.Assert(this._startDate,"Must have a valid start date: "+e)},_handleRRULE:function(e){this._handleICalString(e,function(e,t){var i=0;switch(log("RRULE: ",e,"->",t),e){case"FREQ":switch(t){case"DAILY":this._frequency=RepeatFreq.Daily;break;case"WEEKLY":this._frequency=RepeatFreq.Weekly;break;case"MONTHLY":this._frequency=RepeatFreq.Monthly;break;case"YEARLY":this._frequency=RepeatFreq.Yearly;break;case"SECONDLY":case"MINUTELY":case"HOURLY":default:r.default.Assert(!1,"Invalid RRULE FREQ value: ",t)}break;case"UNTIL":r.default.Assert(t.indexOf("T")<0,"Do not currently support date-time");var a=t.substring(0,4),n=t.substring(4,6),s=t.substring(6,8);this._endDate=new Date(a,n,s);break;case"COUNT":this._maxCount=parseInt(t);break;case"INTERVAL":this._separation=parseInt(t);break;case"BYDAY":var o=t.split(",");this._offsets=[];for(var l=0;l<o.length;++l){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var d=Hi.indexOf(o[l]);d>=0?this._offsets.push(d):this._offsets.push(parseInt(o[l]))}break;case"BYMONTHDAY":case"BYYEARDAY":case"BYWEEKNO":case"BYMONTH":case"BYSETPOS":case"WKST":break;case"BYSECOND":case"BYMINUTE":case"BYHOUR":default:r.default.Assert(!1,"Invalid RRULE action: ",e)}})},_handleEXRULE:function(e){this._handleICalString(e,function(e,t){log("EXRULE: ",e,"->",t)})},_handleRDATE:function(e){this._handleICalString(e,function(e,t){log("RDATE: ",e,"->",t)})},_handleEXDATE:function(e){this._handleICalString(e,function(e,t){log("EXDATE: ",e,"->",t)})},fromICal:function(e){var t=0;r.default.Assert(2===e.length,"Only handle single instance RRULE with added DTSTART");for(var i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=e[i].split(":"),n=a[0],s=a[1];switch(n){case"DTSTART":this._handleDTSTART(s);break;case"RRULE":this._handleRRULE(s);break;case"EXRULE":this._handleEXRULE(s);break;case"RDATE":this._handleRDATE(s);break;case"EXDATE":this._handleEXDATE(s);break;default:r.default.Assert(!1,"Invalid recurrence rule: "+n)}}},getHours:function(){return this._startDate.getHours()},getMinutes:function(){return this._startDate.getMinutes()}};var Gi=Wi,ji=i(26),Ki=1,Yi=4,Xi=["description","end","start","status","summary","extendedProperties"],Qi="syncTokens",Ji="calendarList",Zi={IsComplete:"isComplete",Priority:"priority",IsStarred:"isStarred",IsArchived:"isArchived"},$i=["modifiedOffline"],ea=2,ta=3,ia=4,aa=6,na=7,sa=8,ra=9,oa=10,la=11,da=12,ua=13;function ca(){this._super.constructor.call(this,PluginID.GCalendar,"Calendar"),this.pluginMargin=4,this.pluginPadding=14,this._requiresOfflineAuth=!0,this._numEntriesSyncd=0,this._calendarList={},o.a.binder(this,"_flushEventUpdateQueue","_purgeOldData","parsePriority","runCalendarListSync","runCalendarSync","createEventForItem"),this.registerSetting("WriteAccess","writeAccess",!0,!0),this.registerSetting("ImportCalendars","importCalendars",!0),this.registerSetting("ExportCalendar","exportCalendar",!0),this.registerSetting("WeeksPast","weeksPast",!0,Ki),this.registerSetting("WeeksFuture","weeksFuture",!0,Yi),this.registerSetting("DisplayOverdueInAgenda","displayOverdueInAgenda",!0,!1),this.registerSetting("SyncNewEvents","syncNewEvents",!0,!0),this.registerSetting("SyncDraggedEvents","syncDraggedEvents",!0,!0),this.registerSetting("CreateLocalEvents","createLocalEvents",!0,!0),this._updateSyncTimes(),this._eventCache=this.registerLocalCache("EventCache",StorageType.IndexedDB,!0),this._cacheCleanup=this.registerLowImpactTask("CacheCleanup",this._purgeOldData),this.declareProperty("isInvalid",PluginLoad.Runtime,!0,!1),r.default.isDemoMode()?this.declareProperty("calendarID",PluginLoad.Preview|PluginLoad.Full|PluginLoad.Inline,!0,"me"):this.declareProperty("calendarID",PluginLoad.Preview|PluginLoad.Full|PluginLoad.Inline),this.declareProperty("summary",PluginLoad.Preview|PluginLoad.Full),this.declareProperty("status",PluginLoad.Preview|PluginLoad.Full,!0,"confirmed"),this.declareProperty("startTime",PluginLoad.Preview|PluginLoad.Full),this.declareProperty("endTime",PluginLoad.Preview|PluginLoad.Full),this.declareProperty("allDayEvent",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("recurringEventId",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("eid",PluginLoad.Preview|PluginLoad.Full,!0),this.declareProperty("isComplete",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("isArchived",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("isStarred",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("priority",PluginLoad.Preview|PluginLoad.Full,!0,VMLIFlag.None),this.declareProperty("locked",PluginLoad.Preview|PluginLoad.Full,!0,!1),this.declareProperty("modifiedOffline",PluginLoad.Full,!0,!1),this.declareProperty("source",PluginLoad.Full,!0),this.declareProperty("location",PluginLoad.Full,!0),this.declareProperty("description",PluginLoad.Full,!0),this.declareProperty("attendees",PluginLoad.Full,!0),this.declareProperty("organizer",PluginLoad.Full,!0),this.useRenderer(PluginRenderTypes.StyledText,PluginRenderers.CalendarEvent),this.useRenderer(PluginRenderTypes.UnstyledText,PluginRenderers.CalendarEvent),this.useRenderer(PluginRenderTypes.Measure,PluginRenderers.CalendarEvent),this._pendingCreates={},this._syncingOfflineChanges=!1,this._hasInitializedTasks=!1,this._purgeOldDataTimeout=void 0,this._eventUpdateTimeout=void 0,this._eventUpdateQueue={},this._propConverter={},this._propConverter[Zi.IsComplete]=r.default.parseDate,this._propConverter[Zi.IsArchived]=r.default.parseBoolean,this._propConverter[Zi.IsStarred]=r.default.parseBoolean,this._propConverter[Zi.Priority]=this.parsePriority}var ha={getType:function(){return l.a.PluginType.Calendar},_attachMetadataFields:function(){return $i},allowRemoteRequests:function(){return!0},useItemStore:function(){return"Google Calendar"},itemStoreOptions:function(){return{listenToItemStateChanged:!0,enabledFilters:l.a.ItemStoreFilter.Dates}},supportOfflineLoad:function(){return!0},supportOfflineCache:function(){return!0},usesPreviewCache:function(){return!0},googleScopes:function(){return this.getSetting(this.Settings.WriteAccess)?[GScope.Calendar]:[GScope.CalendarRO]},getDependencies:function(){return[PluginDependency.LocalLoaded,PluginDependency.PremiumSub,PluginDependency.GoogleLogin]},hasSettingsError:function(){return!this.verifyAuthorization(j.a.getDefaultEmail())},verifyAuthorization:function(e){if(e===j.a.getDefaultEmail()&&this.getSetting(this.Settings.IsEnabled)&&this.getSetting(this.Settings.IsEnabled))return this.googleScopes().some(function(t){return j.a.hasLinkedAccessToScope(e,t)});return!0},isDependencyLoaded:function(e,t){var i=!1;switch(e){case PluginDependency.GoogleLogin:t&&(t.indexOf(GScope.CalendarRO)>=0||t.indexOf(GScope.Calendar)>=0)&&(i=!0);break;default:i=!0}return i},getBlockedText:function(){return""},computeBatchGroupID:function(e){var t="me";return e.data&&e.data.calendarId&&(t=e.data.calendarId),t},_serializeDate:function(e){return e instanceof Date?e.toISOString():r.default.isNumber(e)?new Date(e).toISOString():e},compactCacheField:function(e,t){var i;switch(t){case"startTime":case"endTime":i=this._serializeDate(e[t]);break;default:i=e[t]}return i},_updateSyncTimes:function(){var e=-(this.getSetting(this.Settings.WeeksPast)||Ki),t=this.getSetting(this.Settings.WeeksFuture)||Yi;r.default.Assert(r.default.isNumber(e)&&e<=0,"Invalid value for weeksPast: ",e),r.default.Assert(r.default.isNumber(t)&&t>=0,"Invalid valid for weeksFuture: ",t);var i=Math.min(-7,e),a=Math.max(20,t);this._minSyncStartTime=(new Date).clearTime().addWeeks(i),this._maxSyncStartTime=(new Date).clearTime().addWeeks(a),this._syncTokenDuration=r.default.weeks(10),this._minDisplayStartTime=(new Date).clearTime().addWeeks(e),this._maxDisplayStartTime=(new Date).clearTime().addWeeks(t),r.default.Assert(this._minDisplayStartTime.isBefore(this._maxDisplayStartTime),"Must have a valid start display date")},_shouldDisplayTime:function(e,t){return t>=this._minDisplayStartTime&&t<=this._maxDisplayStartTime||e>=this._minDisplayStartTime&&e<=this._maxDisplayStartTime},_filterDates:function(e,t,i){return function(a){var n=new Date(a[e]);return n>=t&&n<=i}},_getEndClearTime:function(){return this._minDisplayStartTime.clone().addDays(-1)},_purgeOldData:function(e){var t=this;this._eventCache.onCacheReady(function(){t._eventCache.getFilterEntries(t._filterDates("startTime",new Date(0),t._getEndClearTime()),function(i){if(i){var a=0;log("Removing "+i.length+" old calendar entries.");for(var n=0;n<i.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;t._eventCache.removeEntry(i[n].id)}}e&&e(!1)})})},_offlineLoad:function(){var e=this;if(this.isEnabled())return this._eventCache.onCacheMetadataReady(function(){e._eventCache.getMetadata(Ji,function(t){r.default.isEmpty(e._calendarList)&&(e._calendarList=t||{}),e._eventCache.onCacheReady(function(){var t=e._filterDates("startTime",e._minDisplayStartTime,e._maxDisplayStartTime),i=function(i,a){r.default.batchRenderUpdates(function(){var n=0;r.default.vmMain.beginUpdateItems();for(var s=e.getDefaultItemStore(),o=s.getRoot(),l=0;l<i.length;++l){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var d=i[l];if(!a||t(d)){var u=e.createEntryFromLocal(d.id,d);if(e.cacheData(u.id,u,void 0,void 0,ChangeType.Auto),r.default.Assert(!s.hasItem(u.id),"Load should never try to create a VMLI that has already been created"),e._eventNeedsItem(u)){if(u.source){var c=r.default.vmMain.pluginManager.parseEmailURL(u.source.url);if(c.plugin&&!c.plugin.hasCacheData(c.threadID)){var h=c.plugin.createEntryFromLocal(c.threadID,{accountID:c.accountID,subject:u.source.title});c.plugin.cacheData(c.threadID,h)}}var f=e._createItem(s,u,o.id);o.insertItem(f)}}}r.default.vmMain.commitUpdateItems(),e._cacheCleanup.notifyWorkAvailable()})};e._eventCache.requestPreloadData(function(a){r.default.isArray(a)?i(a,!0):e._eventCache.getFilterEntries(t,i)})})})}),!0},_activate:function(){},_deactivate:function(){r.default.vmMain.beginUpdateItems(),this._hasInitializedTasks=!1,r.default.vmMain.updateAllItems(!0,!0),r.default.vmMain.commitUpdateItems()},_load:function(){!r.default.isDemoMode()&&this.isEnabled()&&(this.createRecurringTask("CalendarListSync",{delay:r.default.hours(2),minDelay:r.default.hours(1),runOnCreate:!0,pauseWhileIdle:!0,async:!0,asyncTimeout:r.default.minutes(2),task:this.runCalendarListSync}),this.createRecurringTask("CalendarEventSync",{delay:r.default.minutes(15),minDelay:r.default.seconds(90),runOnCreate:!0,pauseWhileIdle:!0,minDelayOnResume:!0,async:!0,asyncTimeout:r.default.minutes(2),task:this.runCalendarSync}),this._hasInitializedTasks=!0)},goOnline:function(){this._hasInitializedTasks&&this.getRecurringTask("CalendarEventSync").forceUpdate()},handleTapStart:function(e,t,i,a){return a.preventDefault(),!0},handleTapClick:function(e,t,i,a){var n=this.getCacheData(i);if(n){var s=this.getAttachment(i),o="https://www.google.com/calendar/event?eid="+n.eid+"&authuser="+j.a.getDefaultEmail();if(n.eid){var l=this.createDisplayElement(s).text;a.preventDefault(),r.default.preventClick(),r.default.menus.openMenuExternalApp(l,function(){r.default.openUrl(o,a)}),this.sendEvent("Tap_OpenGCalendarMobile")}return!0}return!1},_durationToString:function(e){var t=Math.round(e/6e4),i=0,a=0;t>0&&(t-=60*(i=Math.floor(t/60)),i>0&&(i-=24*(a=Math.floor(i/24))));var n="";return a>0&&(n+=a+"d "),i>0&&(n+=i+"h "),t>0&&(n+=t+"m "),n.trim()},_createItemDateText:function(e){return e.allDayEvent?e.startTime.toString(H.a.getFormat(DFormat.MonthDayYear)):e.startTime.toString(H.a.getFormat(DFormat.DayYearTime))},_createItemDurationText:function(e){var t,i=e.endTime-e.startTime;if(e.allDayEvent)if(i>r.default.days(1)){var a=e.endTime.clone();a.addMilliseconds(-1),t="until "+a.toString(H.a.getFormat(DFormat.MonthDayYear))}else t="";else t=this._durationToString(i);return t},_createItemSummaryText:function(e){var t;if(e.source&&e.source.url){var i=r.default.vmMain.pluginManager.parseEmailURL(e.source.url);i.plugin&&(t=i.plugin._getTextForItem({id:i.threadID}))}return t||(t=e.summary?e.summary.replace(/\u2000/g,""):""),t},_createItemText:function(e){r.default.Assert(e,"Must specify a valid attachment");var t=this._createItemDateText(e),i=this._createItemDurationText(e),a=this._createItemSummaryText(e);return this._assembleItemText(e,t,i,a)},_assembleItemText:function(e,t,i,a){return a+" "+l.a.DatePrefix+t+" "+(i?i+" ":"")+this._getTextForItem(e)},_eventNeedsItem:function(e){return"cancelled"!==e.status&&!e.isArchived},_createItem:function(e,t,i){var a;r.default.Assert(this._eventNeedsItem(t),"Item must always be required to cause create"),r.default.isDateValid(t.isComplete)&&(a=t.isComplete);var n={date:t.startTime.getTime(),dateText:this._createItemDateText(t),dateFormat:H.a.getCurrentDateFormat(),priority:t.priority,isComplete:!!t.isComplete,isArchived:t.isArchived,dateCompleted:a,isStarred:t.isStarred,duration:void 0,durationText:void 0};t.allDayEvent||(n.duration=t.endTime-t.startTime,n.durationText=this._createItemDurationText(t));var s=e.createItem(t.id,this._createItemText(t),i,n,ChangeType.Auto);if(t.description){var o=e.createItem(t.id+"_note",t.description,s.id,{isNote:!0},ChangeType.Auto);s.setNote(o,ChangeType.Auto)}return s},getRemoteAttachmentData:function(e){var t=this;if(r.default.Assert(e.hasField("calendarID"),"Must have a valid calendarID for an event"),e.hasField("calendarID")){var i=e.getField("calendarID"),a=I.a.fns("calendar").events.get.packedFn,n={eventId:e.id,calendarId:i};this._queueRemoteRequest(a,n,function(a){if(r.default.Assert(!a||a.id===e.id,"If valid result, attachment should match remote event ID"),a){var n=t._addRemoteEntry(i,a);t._eventCache.cacheEntry(a.id,t.serializeExternalData(n))}},function(){e.notifyDataRequestFailed()},e,aa)}else e.updateField("status","cancelled")},_createRemoteEntry:function(e,t){var i,a,n,s=!1;if(r.default.Assert(t.start,"Must always have valid start data"),t.start.dateTime)r.default.Assert(t.end.dateTime,"End date format should always match start"),i=new Date(t.start.dateTime),a=new Date(t.end.dateTime);else if(t.start.date){r.default.Assert(t.end.date,"End date format should always match start");var o=t.start.date.split("-"),l=t.end.date.split("-");i=new Date(o[0],o[1]-1,o[2]),a=new Date(l[0],l[1]-1,l[2]),s=!0}t.htmlLink&&(n=t.htmlLink.split("?eid=")[1]);var d={id:t.id,calendarID:e,status:t.status,summary:t.summary,startTime:i,endTime:a,allDayEvent:s,recurringEventId:t.recurringEventId,eid:n,isComplete:this._getRemoteProperty(t,Zi.IsComplete),isArchived:this._getRemoteProperty(t,Zi.IsArchived),isStarred:this._getRemoteProperty(t,Zi.IsStarred),priority:this._getRemoteProperty(t,Zi.Priority),locked:t.locked||!1,attendees:t.attendees,location:t.location,description:t.description,organizer:t.organizer?t.organizer.displayName||t.organizer.email||t.organizer.id:"Unknown"};return t.source&&(d.source={title:t.source.title,url:t.source.url}),d},_addRemoteEntry:function(e,t){var i=this._createRemoteEntry(e,t);return this.cacheData(i.id,i),i},createEntryFromLocal:function(e,t){return t.startTime=t.startTime?new Date(t.startTime):void 0,t.endTime=t.endTime?new Date(t.endTime):void 0,t.isComplete=this._propConverter[Zi.IsComplete](t.isComplete),t.isArchived=this._propConverter[Zi.IsArchived](t.isArchived),t.isStarred=this._propConverter[Zi.IsStarred](t.isStarred),t.priority=this._propConverter[Zi.Priority](t.priority),t},_notifyFailedRequest:function(e){e&&e.error&&(e.error.code===l.a.HTTPStatusCode.Unauthorized?(r.default.toasts.pushMessage(MessageID.LostPermission),j.a.notifyUnauthorizedAccount("me",[GScope.CalendarRO,GScope.Calendar],e.error.message)):e.error.code>=400&&e.error.code<500&&r.default.reportError(new Error("Failed GCalendar request: "+e.error.code),e))},_getRemoteProperty:function(e,t){var i;return r.default.Assert(e,"Must provide valid event info"),r.default.Assert(t,"Must provide valid remote prop"),r.default.Assert(this._propConverter[t],"Missing prop converter: ",t),e.extendedProperties&&e.extendedProperties.private&&(i=e.extendedProperties.private["MDCProp_"+t]),this._propConverter[t]&&(i=this._propConverter[t](i)),i},_updateAttachFromData:function(e,t){var i=[];for(var a in t)t.hasOwnProperty(a)&&e.isFieldDefined(a)&&(e.updateField(a,t[a]),i.push(a));return i},_runRemoteUpdate:function(e,t,i,a,n,s){var o,l,d,u,c=this,h=arguments;r.default.Assert(this.getSetting(this.Settings.WriteAccess),"Should not be calling _runRemoteUpdate without proper permission"),r.default.Assert(!e.getField("locked"),"Should never try to modify an event that is locked"),r.default.Assert(r.default.isBoolean(t)||r.default.isArray(t),"Must specify a boolean or list of fields for modified value"),r.default.Assert(r.default.isFunction(a),"Must provide a valid localDoneCB"),r.default.Assert(r.default.isFunction(n),"Must provide a valid remoteDoneCB"),r.default.Assert(r.default.isFunction(s),"Must provide a valid allDoneCB");var f=function(e,t,i){r.default.Assert(r.default.isFunction(e),"Must supply a valid CB function"),r.default.Assert(void 0!==t,"Must always pass success back from CB"),e.apply(c,Array.prototype.slice.call(h,1)),e===a?(r.default.Assert(void 0===o,"Local CB called twice"),o=t,d=i):e===n&&(r.default.Assert(void 0===l,"Remote CB called twice"),l=t,u=i),void 0!==o&&void 0!==l&&s(o,l,d,u)},p=this.getCacheData(e.id);r.default.Assert(p,"Performing update on event that does not have local data"),p?(this.addModifiedOffline(p,t),this._eventCache.cacheEntry(e.id,this.serializeExternalData(p),function(s){s||f(a,!1),i(function(i,r){if(i){var o=c.getCacheData(e.id),l=!0!==t&&t;c.removeModifiedOffline(o,l),s&&c._eventCache.cacheEntry(e.id,c.serializeExternalData(o),function(e){f(a,e)}),f(n,!0)}else s&&f(a,!1),f(n,!1,r)})})):(f(a,!1),f(n,!1))},_updateEvent:function(e,t,i,a,n,s){var r=this,o=this._updateAttachFromData(e,t);this._runRemoteUpdate(e,o,function(a){r._updateRemoteEvent(e.getField("calendarID"),e.id,t,i,a)},a,n,s)},_updateRemoteEvent:function(e,t,i,a,n){var s=this;r.default.Assert(this.getSetting(this.Settings.WriteAccess),"Should not be calling _updateRemoteEvent without proper permission"),r.default.Assert(this.hasWritePermissionForCalendar(e),"Should not be calling _updateRemoteEvent for a read-only calendar");var o=this._createEventUpdateInfo(i),d=I.a.fns("calendar").events.patch.packedFn,u={calendarId:e,eventId:t,resource:o};this._queueRemoteRequest(d,u,function(){n(!0)},function(i){if(i&&i.error&&i.error.code===l.a.HTTPStatusCode.NotFound)s._eventCache.removeEntry(t),n(!0);else{var a=Object.keys(o);if(log("Failed Update: ",e,t,a),r.default.isHTTPStatusCode(i,l.a.HTTPStatusCode.Forbidden)&&!s.isRateLimitError(i)){var d=s.getCacheData(t);d&&(d.locked=!0),s.cacheData(t,d,!0,["locked"])}n(!1,i),s._notifyFailedRequest(i,e)}},void 0,sa||a)},_updateRemoteProperty:function(e,t,i,a,n,s){var r=this;e.updateField(t,i);var o={},l=void 0===i?null:i;o["MDCProp_"+t]=l;var d={extendedProperties:{private:o}};this._runRemoteUpdate(e,[t],function(t){r._updateRemoteEvent(e.getField("calendarID"),e.id,d,ta,t)},a,n,s)},_getStartEndFromDateInfo:function(e,t){var i,a,n,s=!1;return e instanceof Date?(e.hasTimeOfDay()||(s=!0),i=e,a=e.clone().addMilliseconds(t)):e instanceof Gi?(i=e.getStartDate(),a=e.getEndDate(),n=e.toICal()):r.default.Assert(!1,"Should always have a valid date"),{startTime:i,endTime:a,allDayEvent:s,recurrence:n}},deleteCalendarEventForItem:function(e,t,i,a,n){var s=this;this.sendEvent("DeleteEvent");this._runRemoteUpdate(t,["status"],function(i){var a=e.getRawText().replace(t.getEmbedString(),"");e.setText(a,!0,ChangeType.Local),t.isLocalOnlyAttachment()?(t.updateField("status","cancelled"),i(!0)):s.deleteCalendarEvent(t,i)},i,a,n)},deleteCalendarEvent:function(e,t){var i=this;r.default.Assert(!e.isLocalOnlyAttachment(),"Should never make a remote request to delete a local-only event");var a=I.a.fns("calendar").events.delete.packedFn,n={calendarId:e.getField("calendarID"),eventId:e.id},s=function(){var a=i.getDefaultItemStore();e.updateField("status","cancelled"),e.forEachItem(a,function(e){e.parent()&&(e.parent().removeChild(e),e.parent(void 0))}),i._eventCache.cacheEntry(e.id,i.serializeExternalData(e.getData())),t(!0)};this._queueRemoteRequest(a,n,function(){s()},function(a){a&&a.error&&a.error.code===l.a.HTTPStatusCode.Gone?s():a&&a.error&&a.error.code===l.a.HTTPStatusCode.NotFound?s():(t(!1,a),i._notifyFailedRequest(a,e.getField("calendarID")))},void 0,oa)},forceRemoteEventSync:function(){if(!r.default.isDemoMode()&&this._hasInitializedTasks){if(this.hasRecurringTask("CalendarEventSync"))this.getRecurringTask("CalendarEventSync").forceUpdate();if(this.hasRecurringTask("CalendarListSync"))this.getRecurringTask("CalendarListSync").forceUpdate()}},getDefaultExportCalendarID:function(){return r.default.isDemoMode()?"DemoCal":this.getSetting(this.Settings.ExportCalendar)},isExportCalendarID:function(e){return this.getSetting(this.settings.ExportCalendar)===e},hasWritePermissionForAttach:function(e){var t=!1;if(this.getSetting(this.Settings.WriteAccess)){var i=e.getField("calendarID"),a=this._getCalendarInfo(i);a&&("writer"!==a.accessRole&&"owner"!==a.accessRole||(t=!0))}return t},hasWritePermissionForCalendar:function(e){var t=!1;if(this.getSetting(this.Settings.WriteAccess)){var i=this._getCalendarInfo(e);i&&("writer"!==i.accessRole&&"owner"!==i.accessRole||(t=!0))}return t},getCalendarBackgroundColor:function(e){var t="rgba(0, 120, 255, 0.85)",i=this._getCalendarInfo(e);return i&&i.backgroundColor&&(t=i.backgroundColor),t},getCalendarForegroundColor:function(e){var t="#000000",i=this._getCalendarInfo(e);return i&&i.foregroundColor&&(t=i.foregroundColor),t},getCalendarDisplayProps:function(e){var t,i=this._getCalendarInfo(e);return i&&"reader"===i.accessRole&&(t={style:{backgroundImage:"url(/img/stripe.png)",backgroundRepeat:"repeat"}}),t},shouldDisplayOverdueInAgenda:function(){return this.getSetting(this.Settings.DisplayOverdueInAgenda)},createEventForEmail:function(e,t,i,a,n,s){var o=this;r.default.Assert(r.default.isString(e),"Must provide a valid calendarID for email"),r.default.Assert(r.default.isString(t),"Must provide a valid subject"),r.default.Assert(r.default.isString(i),"Must provide a valid email url"),r.default.Assert(r.default.isDateValid(a),"Must provide a valid schedule date"),r.default.Assert(r.default.isNumber(n),"Must provide a valid event duration"),this.sendEvent("AddEmailEvent");var l={duration:n,summary:t,date:a,source:{title:t,url:i}};this.createNewCalendarEvent(e,l,function(e){if(e){var t=o.getDefaultItemStore();if(!t.hasItem(e.id)){r.default.vmMain.beginUpdateItems();var i=t.getRoot(),a=o._createItem(t,e,i.id);i.insertItem(a),r.default.vmMain.commitUpdateItems()}}},r.default.newEmptyFn(),s)},createEventForItem:function(e){if(!r.default.isDateSoft(e.getDateText())&&!e.hasPluginAttachment(this.id)&&(e.date()||e.repeatDate())){var t=this.getDefaultExportCalendarID();t?e.date()?(this.sendEvent("AddSingleEvent"),this.newCalendarEventForItem(t,e,function(t,i,a,n){t||i?i?y.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.AddToGCal,data:{item:e}}):n&&n.error&&-1===n.error.code?y.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.AddToGCal,data:{item:e}}):r.default.toasts.pushMessage({text:"There was an error adding the event to your Google Calendar.",action:MessageAction.Okay}):a&&!1===a.isValid?r.default.toasts.pushMessage({text:"The event you are trying to create is not valid.",action:MessageAction.Okay}):s.default.overQuota?r.default.toasts.pushMessage({text:"There was an error creating your calendar event. It has not been properly saved. You computer's storage quota may have been exceeded. Please free up space on your device and contact support@moo.do if you have questions.",action:MessageAction.Okay}):r.default.toasts.pushMessage({text:'There was an error creating your calendar event. There may be a problem with your authorization. Please try toggling your "Save To" calendar off and back on, or try toggling the Google Calendar plugin off and on. Contact support@moo.do if you have questions',action:MessageAction.OpenCalendarSettings})})):(this.sendEvent("AddRepeatEvent"),r.default.toasts.pushMessage({text:"Moo.do does not currently support adding repeated dates to Google Calendar.",action:MessageAction.Okay})):r.default.toasts.pushMessage({text:"Please select a valid Google Calendar to save your events to.",action:MessageAction.OpenSettings})}},newCalendarEventForItem:function(e,t,i){var a=this;r.default.Assert(t,"Must provide a valid item"),r.default.Assert(t.date()||t.repeatDate(),"Item must have a valid date"),r.default.Assert(!t.hasPluginAttachment(PluginID.GCalendar),"Must not already have a valid calendar attachment associated with the item");var n=!0,s=t.getDuration();s||(s=t.allDayDate()?r.default.days(1):36e5);var o={duration:s,summary:t.getCalendarParsedText()};if(t.date()?o.date=t.date():t.repeatDate()&&(r.default.Assert(!1,"Repeated dates are not yet supported"),n=!1),t.hasNote()&&(o.description=t.getNote().getParsedText()),t.hasAttachmentType(l.a.PluginType.Email)){var d=t.getAttachmentByType(l.a.PluginType.Email);o.source={title:d.getField("subject"),url:d.getPlugin().createURLForThread(d)}}n?this.createNewCalendarEvent(e,o,function(e){if(e)if(t.isDestroyed()){var i=a.getDefaultItemStore();if(!i.hasItem(e.id)){r.default.vmMain.beginUpdateItems();var n=i.getRoot(),s=a._createItem(i,e,n.id);n.insertItem(s),r.default.vmMain.commitUpdateItems()}}else{var o=t.getCalendarRawText()+" "+l.a.DatePrefix+t.getDateText();t.getDurationText()?o+=" "+t.getDurationText():t.allDayDate()||(o+=" 1hr"),o+=" "+a._getTextForItem(e),t.setText(o,!0,ChangeType.Local)}},r.default.newEmptyFn(),i):i(!1,!1,{isValid:!1})},createNewCalendarEvent:function(e,t,i,a,n){var s=this;r.default.Assert(t,"Must have valid event info passed in"),r.default.Assert(t.date,"Must have valid date for event"),r.default.Assert(void 0!==t.duration,"Must have a valid event duration"),r.default.Assert(t.summary,"Must have a valid event summary"),r.default.Assert(r.default.isFunction(i),"Must supply a valid local done CB"),r.default.Assert(r.default.isFunction(a),"Must supply a valid remote done CB");var o=r.default.generateTempId(),l=this._getStartEndFromDateInfo(t.date,t.duration),d={id:o,calendarID:e,status:"confirmed",summary:t.summary,source:t.source,description:t.description,startTime:l.startTime,endTime:l.endTime,allDayEvent:l.allDayEvent,recurrence:l.recurrence,organizer:j.a.getDefaultEmail(),modifiedOffline:!0};this.cacheData(o,d),this._eventCache.cacheEntry(o,d,function(t){i(d,t);var o=s.getAttachment(d.id);r.default.isDemoMode()?(a(!0),n(t,!0)):s._runRemoteUpdate(o,!0,function(t){s._createRemoteEventFromCacheData(e,d,r.default.newEmptyFn(),t,n)},r.default.newEmptyFn(),a,function(){s.getDefaultItemStore().updateItems()})})},_createRemoteEventFromCacheData:function(e,t,i,a,n){var s,o,l,d,u=this,c=arguments;r.default.Assert(!this._pendingCreates[t.id],"Should never try and double create a calendar event"),this._pendingCreates[t.id]=!0;var h=function(e,t,h){r.default.Assert(r.default.isFunction(e),"Must supply a valid CB function"),r.default.Assert(void 0!==t,"Must always pass success back from CB"),e.apply(u,Array.prototype.slice.call(c,1)),e===i?(r.default.Assert(void 0===s,"Local CB called twice"),s=t,l=h):e===a&&(r.default.Assert(void 0===o,"Remote CB called twice"),o=t,d=h),void 0!==s&&void 0!==o&&n(s,o,l,d)};this._createNewRemoteEvent(e,t,function(n,s){delete u._pendingCreates[t.id],r.default.vmMain.beginUpdateItems();var o=u.getAttachment(t.id);if(n){var l=t.id;u.changeID(o,o.id,n.id);var d=u.getDefaultItemStore(),c=d.getRoot();d.hasItem(l)&&d.destroyItem(l),u._eventCache.removeEntry(l,function(e){r.default.Assert(e,"Must always successfully remove the temp cached event: "+t.id)});var f=u._addRemoteEntry(e,n),p=u._createItem(d,f,c.id);c.insertItem(p),u._eventCache.cacheEntry(n.id,u.serializeExternalData(f),h.bind(u,i)),o.updateField("isInvalid",!1),h(a,!0)}else o.updateField("isInvalid",!0),h(i,!1),h(a,!1,s);r.default.vmMain.commitUpdateItems()})},_createNewRemoteEvent:function(e,t,i){var a,n,s=this;r.default.Assert(t,"Must specify valid event info"),r.default.Assert(t.startTime instanceof Date,"Must have a valid start time"),r.default.Assert(t.endTime instanceof Date,"Must have a valid end time"),r.default.Assert(t.summary,"Must have a valid event title"),t.allDayEvent?(a={date:t.startTime.toString("yyyy-MM-dd")},n={date:t.endTime.toString("yyyy-MM-dd")}):(a={dateTime:t.startTime.toISOString()},n={dateTime:t.endTime.toISOString()});var o=I.a.fns("calendar").events.insert.packedFn,l={calendarId:e,resource:{start:a,end:n,recurrence:t.recurrence,summary:t.summary,description:t.description,status:t.status,source:t.source}};this._queueRemoteRequest(o,l,function(e){i(e)},function(t){i(void 0,t),s._notifyFailedRequest(t,e)},void 0,na)},getImportCalendarList:function(){return this.getSetting(this.Settings.ImportCalendars)||[]},getReadableCalendarList:function(e){return this._getCalendarList("reader",e)},getWritableCalendarList:function(e){return this._getCalendarList("writer",e)},getFullCalendarList:function(e){var t=this.getSetting(this.Settings.ImportCalendars);this.getReadableCalendarList(function(i){if(t&&i){var a=t.map(function(e){if(!r.default.isObject(e))return{id:e,accessRole:"none"};var t=r.default.clone(e);return t.accessRole="none",t}).filter(function(e){for(var t=0,a=0;a<i.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(i[a].id===e.id)return!1}return!0});i.pushArray(a)}e(i)})},createCalendar:function(e,t){var i=this,a=I.a.fns("calendar").calendars.insert.packedFn,n={resource:{summary:e}};this._queueRemoteRequest(a,n,function(e){t(e)},function(e){t(),i._notifyFailedRequest(e,void 0)},void 0,la),this.sendEvent("CreateCalendar")},_getCalendarList:function(e,t){var i=this,a=I.a.fns("calendar").calendarList.list.packedFn,n={minAccessRole:e,userId:"me"};this._queuePagedRemoteRequest(a,n,function(e){t(e)},function(e){t(),i._notifyFailedRequest(e,void 0)},void 0,ia,{getAllPages:!0,timeoutMS:0})},handleEventUpdate:function(e,t){this._numEntriesSyncd++;var i=this.getDefaultItemStore();if("cancelled"===t.status){if(this._eventCache.removeEntry(t.id),this.hasCacheData(t.id)){var a=this.getAttachment(t.id);a.updateField("status","cancelled"),a.forEachItem(i,function(e){e.parent()&&(e.parent().removeChild(e,ChangeType.Remote),e.parent(void 0))})}}else{var n=this.getCacheData(t.id),s=this._createRemoteEntry(e,t);n&&n.modifiedOffline&&this._mergeEventData(n,s),this.cacheData(s.id,s),this._eventCache.cacheEntry(t.id,this.serializeExternalData(s));var o=i.getRoot(),l=this.getAttachment(t.id);this._beginIgnorePropertyChanges();try{this.updateVMLIsFromUpdate(l,n,s)}catch(e){r.default.reportError(e)}if(this._endIgnorePropertyChanges(),!i.hasItem(s.id)&&this._shouldDisplayTime(s.startTime,s.endTime)&&this._eventNeedsItem(s)){var d=this._createItem(i,s,o.id);o.insertItem(d)}}},_mergeEventData:function(e,t){var i=0;r.default.Assert(e.modifiedOffline,"Should only merge events that were locally modified");var a=e.modifiedOffline;r.default.Assert(r.default.isArray(a),"Should not be receiving an update for an event that was created locally");for(var n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=a[n];0,t[s]=e[s]}t.modifiedOffline=e.modifiedOffline},updateVMLIsFromUpdate:function(e,t,i){var a=this;if(r.default.Assert(e,"Must provide a valid attachment"),r.default.Assert(i,"Must provide valid new data"),t)e.forEachItem(void 0,function(e){var n,s,r=!1,o=e.getParsedText();if(a.areDatesEqual(t.startTime,i.startTime)||(n=a._createItemDateText(i),o=o.replace(l.a.DatePrefix+e.getDateText(),l.a.DatePrefix+n),r=!0),t.endTime-t.startTime!=i.endTime-i.startTime){if(s=a._createItemDurationText(i),e.getDurationText())o=o.replace(e.getDurationText(),s);else{var d=l.a.DatePrefix+(n||e.getDateText());o=o.replace(d,d+" "+s)}r=!0}if(t.summary!==i.summary&&!e.hasAttachmentType(l.a.PluginType.Email)){var u=n||e.getDateText(),c=s||e.getDurationText(),h=i.summary?i.summary.replace(/\u2000/g,""):"";o=a._assembleItemText(i,u,c,h),r=!0}if(t.description!==i.description&&e.belongsToItemStore(a.getDefaultItemStore()))if(e.hasNote())i.description?e.getNote().setText(i.description,!0,ChangeType.Remote):e.setNote(void 0,ChangeType.Remote);else if(i.description){var f=i.id+"_note",p=void 0;a.getDefaultItemStore().hasItem(f)?(p=a.getDefaultItemStore().getItem(f)).setText(i.description,!0,ChangeType.Remote):p=a.getDefaultItemStore().createItem(f,i.description,e.id,{isNote:!0},ChangeType.Remote),e.setNote(p,ChangeType.Remote)}if(a.areDatesEqual(t.isComplete,i.isComplete)||e.isComplete(!!i.isComplete,ChangeType.Remote),t.isArchived!==i.isArchived&&e.isArchived(i.isArchived,ChangeType.Remote),t.isStarred!==i.isStarred&&e.isStarred(i.isStarred,ChangeType.Remote),t.priority!==i.priority&&e.priority(i.priority,ChangeType.Remote),r){var g=e.generateSaveText(o);e.setText(g,!0,ChangeType.Remote)}});else{var n=this._createItemText(i);e.forEachItem(void 0,function(e){e.setText(n,!0,ChangeType.Remote)})}},setSyncToken:function(e,t,i){var a=this;r.default.Assert(r.default.isString(e),"Must provide a valid calendar ID to clear sync token for"),r.default.Assert(r.default.isString(t),"Must provide a valid calendar ID to clear sync token for"),this._eventCache.getMetadata(Qi,function(n){n=n||{};var s=Date.now()+a._syncTokenDuration;n[e]={token:t,date:Date.now(),expires:s},a._eventCache.setMetadata(Qi,n,i)})},clearSyncToken:function(e,t){var i=this;r.default.Assert(r.default.isString(e),"Must provide a valid calendar ID to clear sync token for"),r.default.Assert(r.default.isFunction(t),"Must provide valid CB function when clearing sync token"),this._eventCache.getMetadata(Qi,function(a){a?(delete a[e],i._eventCache.setMetadata(Qi,a,t)):t(!1)})},clearCalendarEventCache:function(e,t){var i=this;r.default.Assert(r.default.isString(e),"Must provide a valid calendar ID to clear event cache for"),r.default.Assert(r.default.isFunction(t),"Must provide valid CB function when clearing event cache");this._eventCache.getFilterEntries(function(t){return t.calendarID===e},function(e){if(e){for(var a=0,n=0;n<e.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;i._eventCache.removeEntry(e[n].id)}t(!0)}else t(!1)})},_calendarSyncComplete:function(e,t){t.length>0?G.a.notifySyncError(t):(G.a.notifySyncError(void 0),r.default.toasts.clearMessage(MessageID.CalendarSync));var i=this.getSetting(this.Settings.ExportCalendar);if(i){for(var a=0,n=!1,s=0;s<t.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(t[s].id===i){n=!0;break}}n||this._syncOfflineChanges(this._notifyOfflineSyncFailures)}},_shouldExpireToken:function(e){var t=!0;return e&&(e.expires?t=e.expires<Date.now():e.date&&(t=e.date+this._syncTokenDuration<Date.now())),t},_getCalendarInfo:function(e){return this._calendarList[e]},allowTextEditing:function(e,t){var i=!1;if(this.getSetting(this.Settings.WriteAccess)){var a=t.getField("calendarID");(this.hasWritePermissionForCalendar(a)||t.isLocalOnlyAttachment())&&(i=!0)}return i},_createCalendarFromRemote:function(e){var t={id:e.id,summary:e.summary,accessRole:e.accessRole};return r.default.isValidColor(e.backgroundColor)&&(t.backgroundColor=e.backgroundColor),r.default.isValidColor(e.foregroundColor)&&(t.foregroundColor=e.foregroundColor),t},runCalendarListSync:function(e){var t=this;this.getReadableCalendarList(function(i){if(i){var a=0;t._calendarList={};for(var n=0;n<i.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=i[n];t._calendarList[s.id]=t._createCalendarFromRemote(s)}r.default.toasts.clearMessage(MessageID.CalendarSync);var o=t.getDefaultExportCalendarID();o&&!t._calendarList[o]&&(t.setSetting(t.Settings.ExportCalendar,void 0),r.default.toasts.pushMessage({text:"Your export calendar no longer exists, please select another.",action:MessageAction.OpenSettings})),t._eventCache.onCacheMetadataReady(function(){t._eventCache.setMetadata(Ji,t._calendarList)})}else 0;e&&e()})},_notifyTokenExpired:function(){this._purgeOldDataTimeout&&clearTimeout(this._purgeOldDataTimeout),this._purgeOldDataTimeout=setTimeout(this._purgeOldData,0)},_notifyCalendarUnsyncd:function(e){log("Detected calendar "+e+" is no longer syncd"),this._clearCachedData(e,function(t){t||log("Failure unsyncing calendar "+e)}),this._clearCalendarItems(e)},_clearCalendarItems:function(e){var t=this.getDefaultItemStore();r.default.vmMain.beginUpdateItems(),t.forEach(function(i){i.hasAttachments()&&(i.getAttachment(0).getField("calendarID")===e&&t.destroyItem(i.id))}),r.default.vmMain.commitUpdateItems()},_getSyncResultFromResult:function(e,t){var i=l.a.SyncResult.Success;if(t&&t.error&&t.error.code){var a=t.error.code;if(a===l.a.HTTPStatusCode.Unauthorized){var n=this._getCalendarInfo(e);i=n&&"owner"===n.accessRole?l.a.SyncResult.FailureOAuth:n&&"writer"===n.accessRole?l.a.SyncResult.FailureNoWrite:l.a.SyncResult.FailureNoRead}else i=a===l.a.HTTPStatusCode.NotFound?l.a.SyncResult.FailureNoRead:a===l.a.HTTPStatusCode.Network?l.a.SyncResult.FailureNetwork:a===l.a.HTTPStatusCode.Forbidden?l.a.SyncResult.FailureNoRead:l.a.SyncResult.FailureUnknown}return i},runCalendarSync:function(e){var t=this,i=0,a=0,n=[],s=[],o=function(o,d,u){r.default.Assert(a<i,"Should never have more calendars syncd than we tried to sync"),o?n.push({id:d,result:l.a.SyncResult.Success}):s.push({id:d,result:t._getSyncResultFromResult(d,u)}),++a===i&&(t._calendarSyncComplete(n,s),e&&e())};this._eventCache.onCacheMetadataReady(function(){t._eventCache.getMetadata(Qi,function(a){t._updateSyncTimes();var n=t.getSetting(t.Settings.ImportCalendars);if(n&&n.length>0){var s=0;i=n.length;for(var l=0;l<n.length;++l){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var d=n[l];r.default.isObject(d)||(d={id:n[l]});var u,c=a?a[d.id]:void 0;t._shouldExpireToken(c)?(t._notifyTokenExpired(d.id),u=void 0):u=c.token,t.performCalendarSync(d.id,u,o)}for(var h in a)if(a.hasOwnProperty(h)){var f=0,p=!1;for(l=0;l<n.length;++l){if(f++>5e3&&__infLoop&&__infLoop(f))throw new RangeError;d=n[l];if(r.default.isObject(d)||(d={id:n[l]}),d.id===h){p=!0;break}}p||t._notifyCalendarUnsyncd(h)}}else t._clearAllData(),t._calendarSyncComplete([],[]),e&&e()})})},performCalendarSync:function(e,t,i){var a=this;r.default.Assert(r.default.isString(e),"Must provide a valid calendar ID for each sync op");var n=I.a.fns("calendar").events.list.packedFn,s={calendarId:e,singleEvents:!0};t?s.syncToken=t:(s.timeMin=this._minSyncStartTime.toISOString(),s.timeMax=this._maxSyncStartTime.toISOString());this._queuePagedRemoteRequest(n,s,function(t,n,s){var o,l=0;s&&(o=s.nextSyncToken,a.setSyncToken(e,o)),r.default.vmMain.beginUpdateItems();for(var d=0;d<t.length;++d){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;a.handleEventUpdate(e,t[d])}r.default.vmMain.commitUpdateItems(),i(!0,e)},function(t){t&&t.error&&t.error.code===l.a.HTTPStatusCode.Gone?a._clearCachedData(e,function(n){n?a.performCalendarSync(e,void 0,i):i(!1,e,t)}):(i(!1,e,t),a._notifyFailedRequest(t,e))},void 0,ea,{getAllPages:!0,timeoutMS:0})},_createEventUpdateInfo:function(e){var t={};for(var i in e)e.hasOwnProperty(i)&&Xi.indexOf(i)>=0&&(t[i]=e[i]);return t},_notifyOfflineSyncFailures:function(e,t,i){t>0&&(G.a.notifySyncError(i),log("Failed to sync offlineChanges: ",t))},_syncOfflineChanges:function(e){var t=this;if(!this._syncingOfflineChanges){this._syncingOfflineChanges=!0;var i=0,a=0,n=0,s=[],o=function(r,o){o===l.a.SyncResult.Success?a++:(n++,s.push({id:r,result:o})),i===a+n&&(t._syncingOfflineChanges=!1,e(a,n,s))};this._eventCache.getFilterEntries(function(e){return!!e.modifiedOffline},function(e){var a=0;i=e.length;for(var n=0;n<e.length;++n){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=t.createEntryFromLocal(e[n].id,e[n]);s.isInvalid||(r.default.isTempId(s.id)&&!t._pendingCreates[s.id]?t._createRemoteEventFromCacheData(s.calendarID,s,r.default.newEmptyFn(),function(e,t,i){o(e,this._getSyncResultFromResult(e,i))}.bind(t,s.calendarID),r.default.newEmptyFn()):t.hasWritePermissionForCalendar(s.calendarID)?t._updateRemoteEvent(s.calendarID,s.id,s,ra,function(e,t,i){t?(delete s.modifiedOffline,this._eventCache.cacheEntry(s.id,s,function(t){o(e,t?l.a.SyncResult.Success:l.a.SyncResult.FailureUnknown)})):o(e,this._getSyncResultFromResult(e,i))}.bind(t,s.calendarID)):(delete s.modifiedOffline,t._eventCache.cacheEntry(s.id,s,function(e,t){o(e,t?l.a.SyncResult.Success:l.a.SyncResult.FailureUnknown)}.bind(t,s.calendarID))))}})}},_getEventDuration:function(e){r.default.Assert(!e.getField("allDayEvent"),"All day events do not have valid durations");var t=e.getField("startTime"),i=e.getField("endTime");return r.default.Assert(t&&i,"Must always have valid start and end times"),i-t},_computeItemDates:function(e,t){var i,a;r.default.Assert(t.getDate()||t.getRepeatDateString(),"Must have a valid date"),t.getDate()&&(a=(i=t.getDate().clone()).clone().addMilliseconds(t.getDuration())),i&&a&&(t.allDayDate()?(e.start={date:i.toString("yyyy-MM-dd"),dateTime:null},e.end={date:a.toString("yyyy-MM-dd"),dateTime:null}):(e.start={dateTime:i.toISOString(),date:null},e.end={dateTime:a.toISOString(),date:null})),e.startTime=i,e.endTime=a},_queueEventUpdate:function(e,t){if(this._updateAttachFromData(e,t),this._eventUpdateTimeout&&clearTimeout(this._eventUpdateTimeout),this._eventUpdateTimeout=setTimeout(this._flushEventUpdateQueue,2e3),!e.isLocalOnlyAttachment()){var i=this._eventUpdateQueue[e.id];if(i)for(var a in t)t.hasOwnProperty(a)&&(i.info[a]=t[a]);else this._eventUpdateQueue[e.id]={attach:e,info:t}}},onShutdown:function(){if(s.default.overQuota&&!r.default.isEmpty(this._pendingCreates))return"Some of your calendar events may have not been fully saved. Continue?"},_flushEventUpdateQueue:function(){this._eventUpdateTimeout=void 0;var e=function(e,t){e||t?r.default.toasts.clearMessage(MessageID.CalendarSaveFail):r.default.toasts.pushMessage(MessageID.CalendarSaveFail)};for(var t in this._eventUpdateQueue)if(this._eventUpdateQueue.hasOwnProperty(t)){var i=this._eventUpdateQueue[t];this._updateEvent(i.attach,i.info,da,r.default.newEmptyFn(),r.default.newEmptyFn(),e)}this._eventUpdateQueue={}},_handleAttachDeleted:function(e,t){var i=this;if(t.belongsToItemStore(this.getDefaultItemStore())){var a=e.getField("status");this.deleteCalendarEvent(e,function(n){if(n){r.default.toasts.pushMessage({text:"Event removed from your calendar.",actionText:"UNDO",action:function n(){i._updateEvent(e,{status:a},ua,r.default.newEmptyFn(),function(e){e||r.default.toasts.pushMessage({text:"There was an error re-adding the event to your calendar",actionText:"RETRY",action:n,timeout:1e4})},r.default.newEmptyFn());var s=i._createItemText(e.getData());t.setText(s,!0,ChangeType.Local),t.parent()||t.parent(i.getDefaultItemStore().getRoot()),t.getIndex()<0&&t.parent().insertItem(t)},timeout:1e4})}else r.default.toasts.pushMessage({text:"There was an error removing the event from your calendar.",actionText:"RETRY",action:i._handleAttachDeleted.bind(i,e,t),timeout:1e4})})}},notifyItemNoteChanged:function(e,t){this._queueEventUpdate(e,{description:t.getRawText()})},notifyItemTextChanged:function(e,t,i){if(i)this._handleAttachDeleted(e,t);else if(e.getField("recurringEventId")&&t.getCalendarParsedText()===e.getField("summary"))r.default.toasts.pushMessage({text:"Moo.do does not currently support modifying repeated events.",actionText:"OKAY"});else if(!r.default.isDemoMode())if(t.getDate()){var a,n=t.getCalendarParsedText(),s=e.getField("summary"),o=e.getField("source");if(t.hasAttachmentType(l.a.PluginType.Email)){var d=t.getAttachmentByType(l.a.PluginType.Email);a={title:d.getField("subject"),url:d.getPlugin().createURLForThread(d)}}var u={summary:n,start:void 0,end:void 0,source:void 0},c=!1;n!==s&&(c=!0),o&&!a||!o&&a?c=!0:o&&a&&(o.title===a.title&&o.url===a.url||(c=!0));var h=t.getDate(),f=e.getField("startTime");this.areDatesEqual(f,h)||(c=!0);var p=t.getEndDate(),g=e.getField("endTime");this.areDatesEqual(g,p)||(c=!0),c&&(this._computeItemDates(u,t,e),u.source=a,this._queueEventUpdate(e,u)),e.updateField("isInvalid",!1)}else e.updateField("isInvalid",!0)},_beginIgnorePropertyChanges:function(){this._ignoringPropertyChanges=!0},_endIgnorePropertyChanges:function(){this._ignoringPropertyChanges=!1},_isIgnoringPropertyChanges:function(){return this._ignoringPropertyChanges},notifyItemPropertyChanged:function(e,t,i){if(this.getSetting(this.Settings.WriteAccess)&&!e.getField("locked")&&this.hasWritePermissionForCalendar(e.getField("calendarID"))&&(!r.default.isRemoteChange(i)||!this._isIgnoringPropertyChanges())){var a=e.getField("isComplete"),n=e.getField("isArchived"),s=e.getField("isStarred"),o=e.getField("priority"),l=t.dateCompleted,d=t.isArchived(),u=t.isStarred(),c=t.priority(),h=r.default.newEmptyFn(),f=r.default.newEmptyFn(),p=function(e,t,i,a){e||t?r.default.toasts.clearMessage(MessageID.CalendarSaveFail):r.default.toasts.pushMessage(MessageID.CalendarSaveFail)};this.areDatesEqual(a,l)||(r.default.isLocalChange(i)?this._updateRemoteProperty(e,"isComplete",l,h,f,p):e.updateField("isComplete",l)),n!==d&&(r.default.isLocalChange(i)?this._updateRemoteProperty(e,"isArchived",d,h,f,p):e.updateField("isArchived",d)),s!==u&&(r.default.isLocalChange(i)?this._updateRemoteProperty(e,"isStarred",u,h,f,p):e.updateField("isStarred",u)),o!==c&&(r.default.isLocalChange(i)?this._updateRemoteProperty(e,"priority",c,h,f,p):e.updateField("priority",c))}},_clearCachedData:function(e,t){var i=this;this.clearSyncToken(e,function(a){a?i.clearCalendarEventCache(e,t):t&&t(!1)})},_clearAllData:function(e){var t=this;this._eventCache.clearMetadata(function(i){i?t._eventCache.clearCache(function(t){e&&e(t)}):e&&e(!1)}),this.getDefaultItemStore().clearStore()},getAttachmentClass:function(e){var t=["plugin_gcalendar","c-date"];return e.isLoaded()&&(e.getField("isInvalid")&&t.push("invalid"),"cancelled"===e.getField("status")&&t.push("eventDeleted")),t},getAttachmentTooltip:function(e){var t;return this.isPluginBlocked()?t="Go premium to view calendar events":e.isLoaded()?(e.isLocalOnlyAttachment()?t="Syncing event...":e.getField("isInvalid")&&(t="Item has an invalid date"),"cancelled"===e.getField("status")&&(t="Item was deleted from Google Calendar")):t="Plugin is loading data",t},matchAttachment:function(e,t){var i=l.a.DatePrefix+e.getField("startTime").toString(H.a.getFormat(DFormat.ShortDayTime));return(e.getField("summary")||"").indexOf(t)>=0||i.indexOf(t)>=0},areDatesEqual:function(e,t){var i=!1;return e&&t?r.default.isDateValid(e)&&r.default.isDateValid(t)&&(i=e.equals(t)):i=!e&&!t,i},parsePriority:function(e){var t=r.default.parseInt(e);return isNaN(t)&&(t=VMLIFlag.None),t},fieldsHaveParseEffect:function(e){return(!e||1!==e.length||"isComplete"!==e[0])&&this._super.fieldsHaveParseEffect.call(this,e)}};o.a.inherit(pe,ca),o.a.extend(ca.prototype,ha);var fa=ca,pa=r.default.seconds(30);function ma(){this._plugins={},this._activePlugins=[],this._loadedDependencies={},this._isOnline=navigator.onLine,this._iteratingPlugins=!1,this._hasAdjustedCacheSizeRatio=!1,this._queueTimeout=void 0,this._forcedLastPossible=!1,this._numOutstandingReqs=0,this._pluginRenderer=new W,this.init()}ma.prototype={init:function(){o.a.forceBind("_pumpRequestQueues",this),o.a.forceBind("_handleRequestResponse",this),o.a.forceBind("_handleBatchRequestResponse",this),this._setupRequestQueues(),this._pluginRenderer.registerDefaultRenderers(),r.default.billingManager.hasPremiumFeatures()?(this.notifyDependencyLoad(PluginDependency.EarlyAccess),this.notifyDependencyLoad(PluginDependency.PremiumSub)):r.default.billingManager.hasEarlyAccess()&&this.notifyDependencyLoad(PluginDependency.EarlyAccess),r.default.isDemoMode()&&this.notifyDependencyLoad(PluginDependency.DemoMode),window.addEventListener("offline",this.goOffline.bind(this)),window.addEventListener("online",this.goOnline.bind(this)),g.a.listen("resetEverything",this._clearRequestQueues.bind(this)),log("Cache Size Ratio: ",this.getCacheSizeRatio())},printStats:function(e){if(log("---- Plugin Stats ----"),void 0!==e){var t=this._plugins[e];log(t.name),log(" Stats: ",t.getStats())}else for(var i=0,a=Object.keys(this._plugins),n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this._plugins[a[n]],r=s.getStats();log(s.name),log(" Stats: ",r)}log("----------------------")},dumpQueueState:function(){var e=0,t=Object.keys(this._plugins);console.log("Queue State: ["+this._numOutstandingReqs+"]");for(var i=0;i<t.length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var a=this._plugins[t[i]];console.log(a.name),a.dumpRequestQueue(!1)}},dumpQueueStats:function(){for(var e=0,t=Object.keys(this._plugins),i=0;i<t.length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var a=this._plugins[t[i]];console.log(a.name),a.dumpQueueStats()}},getStats:function(e){var t={};if(void 0!==e)t[e]=this._plugins[e].getStats();else for(var i=0,a=Object.keys(this._plugins),n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this._plugins[a[n]];t[s.id]=s.getStats()}return t},getCacheStats:function(e,t){var i={};if(void 0!==e)this._plugins[e].getCacheStats(t);else for(var a=0,n=Object.keys(this._plugins),s=0,r=0;r<n.length;++r){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;this._plugins[n[r]].getCacheStats(function(e,a){a&&(i[e]=a),n.length===++s&&t(i)}.bind(this,n[r]))}},getState:function(e){var t={};if(void 0!==e)t[e]=this._plugins[e].getState();else for(var i=0,a=Object.keys(this._plugins),n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this._plugins[a[n]];t[s.id]=s.getState()}return t},registerPlugins:function(){try{this.registerPlugin(new Vi)}catch(e){r.default.reportError(e)}try{this.registerPlugin(new ze)}catch(e){r.default.reportError(e)}try{this.registerPlugin(new Ai)}catch(e){r.default.reportError(e)}try{this.registerPlugin(new fa)}catch(e){r.default.reportError(e)}try{this.registerPlugin(new Xe)}catch(e){r.default.reportError(e)}},registerPlugin:function(e){r.default.Assert(!this._plugins[e.id],"Should never double-register a plguin"),this._plugins[e.id]=e,this.isAuthorized(e.id)&&this.loadPlugin(e.id)},getPlugin:function(e){return this._plugins[e]},getPluginFromPreviewCache:function(e){for(var t in this._plugins)if(this._plugins.hasOwnProperty(t)){var i=this._plugins[t];if(i._previewCache===e)return i}},loadPlugin:function(e){var t=this.getPlugin(e);r.default.Assert(t,"Must register a plugin before loading it"),this.activatePlugin(t)},unloadPlugin:function(e){},authorizePlugin:function(e,t,i){var a=this;r.default.Assert(i&&r.default.isFunction(i),"Must provide a valid callback fn");var n=this.getPlugin(e);r.default.Assert(n,"Must register a plugin before loading it"),n.authorize(t,!1,function(e){a.onPluginAuthorized(n,e),i(e)})},deauthorizePlugin:function(e,t){r.default.Assert(t&&r.default.isFunction(t),"Must provide a valid callback fn");var i=this.getPlugin(e);r.default.Assert(i,"Must register a plugin before loading it"),i.setSetting(i.Settings.IsEnabled,!1),this.deactivatePlugin(i),t(!0)},onPluginAuthorized:function(e,t){e.setSetting(e.Settings.IsEnabled,t),t&&this.activatePlugin(e)},activatePlugin:function(e){r.default.Assert(e,"Plugin must be valid to be activated"),e.activate(this._loadedDependencies)&&this._activePlugins.indexOf(e.id)<0&&this._activePlugins.push(e.id),e.ensurePaneTypeIsActive()},deactivatePlugin:function(e){(r.default.Assert(e,"Plugin must be valid to be deactivated"),this._activePlugins.indexOf(e.id)>=0)&&(e.deactivate()&&this._activePlugins.remove(e.id))},isOnline:function(){return this._isOnline||r.default.isDemoMode()},goOnline:function(){var e=this;this._isOnline=!0,setTimeout(function(){var t=0;e._setupRequestQueues(!0);for(var i=0;i<e._activePlugins.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=e._plugins[e._activePlugins[i]];try{a.goOnline()}catch(t){e._reportPluginError(t)}}},2500)},goOffline:function(){var e=0;this._isOnline=!1;for(var t=0;t<this._activePlugins.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this._plugins[this._activePlugins[t]];try{i.goOffline()}catch(e){this._reportPluginError(e)}}},onDocumentShared:function(e){for(var t=0,i=0;i<this._activePlugins.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=this._plugins[this._activePlugins[i]];try{a.onDocumentShared(e)}catch(e){this._reportPluginError(e)}}},writeCaches:function(){for(var e=0,t=0;t<this._activePlugins.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this._plugins[this._activePlugins[t]];try{i.saveOfflineCache()}catch(e){this._reportPluginError(e)}}},onShutdown:function(e){var t=0;e&&this.writeCaches();for(var i=[],a=0;a<this._activePlugins.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var n=this._plugins[this._activePlugins[a]];try{var s=n.onShutdown();s&&i.push(s)}catch(e){this._reportPluginError(e)}}return i.length>0?i:void 0},onPurgeData:function(){for(var e=0,t=0;t<this._activePlugins.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this._plugins[this._activePlugins[t]];try{i.clearOfflineCache(!0)}catch(e){this._reportPluginError(e)}}},onClearData:function(){for(var e=0,t=0;t<this._activePlugins.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this._plugins[this._activePlugins[t]];try{i.clearData()}catch(e){this._reportPluginError(e)}}},getCacheSizeRatio:function(){var e=r.default.settings.get(Settings.cacheSizeRatio)||1;return r.default.Assert(e>=0&&e<=1,"Invalid ratio value: ",e),e},hasAdjustedCacheSizeRatio:function(){return this._hasAdjustedCacheSizeRatio},_adjustCacheSizeRatio:function(){var e=this.getCacheSizeRatio();1===e&&r.default.sendEvent("CacheRatioChange","FromDefault");e>.35?e-=.1:r.default.sendEvent("CacheRatioChange","Minimum"),r.default.sendEvent("CacheRatioChange","Change",e),r.default.settings.set(Settings.cacheSizeRatio,e)},onCacheLimitExceeded:function(){if(!this._hasAdjustedCacheSizeRatio){var e=0;this._hasAdjustedCacheSizeRatio=!0,this._adjustCacheSizeRatio();for(var t=0;t<this._activePlugins.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this._plugins[this._activePlugins[t]];try{i.onCacheLimitExceeded()}catch(e){this._reportPluginError(e)}}}},getPluginsForType:function(e){var t;switch(e){case l.a.PluginType.Calendar:t=[PluginID.GCalendar];break;case l.a.PluginType.Email:t=[PluginID.Gmail];break;case l.a.PluginType.Storage:t=[PluginID.Drive];break;case l.a.PluginType.Unknown:t=[PluginID.Mailbird,PluginID.Moodo]}return t},hasAttachmentType:function(e,t){var i=!1;if(e.hasAttachments())for(var a=0,n=this.getPluginsForType(t),s=0;s<n.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(e.hasPluginAttachment(n[s])){i=!0;break}}return i},allowTextEditing:function(e){var t=!0;if(e&&e.hasAttachments())for(var i=0,a=e.getAttachments(),n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(!a[n].getPlugin().allowTextEditing(e,a[n])){t=!1;break}}return t},validatePlugin:function(e){},runForEachPlugin:function(e){var t=0;this._iteratingPlugins=!0;for(var i=0;i<this._activePlugins.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;try{e(this.getPlugin(this._activePlugins[i]))}catch(e){r.default.reportError(e)}}this._iteratingPlugins=!1},getAttachment:function(e,t){r.default.Assert(e.p,"Must specify the plugin string to be used: ",e),r.default.Assert(e.id,"Must specify the ID of the data to use from the plugin: ",e);var i=this.getPlugin(e.p);if(r.default.Assert(i,"Must specify a valid plugin: ",e),i)return i.isActive()||this.activatePlugin(i),i.getAttachment(e.id,t?e:void 0)},createDisplayElement:function(e,t){var i;r.default.Assert(e.p,"Must specify the plugin string to be used"),r.default.Assert(e.id,"Must specify the ID of the data to use from the plugin");var a=this.getPlugin(e.p);if(a){var n=this.getAttachment(e,t);if(n)try{i=a.createDisplayElement(n)}catch(t){this._reportPluginError(t),i=this.createUnknownPluginElement(e.p)}else i=this.createUnknownPluginElement(e.p)}else i=this.createUnknownPluginElement(e.p);return i},createUnknownPluginElement:function(e){return{attrs:{cls:[],isUnknown:!0,plugin:PluginID.Moodo,"plugin-id":"Invalid"}}},measureAttachment:function(e,t){r.default.Assert(t&&t.attrs&&t.attrs.plugin,"Must have a valid plugin ID for measuring");var i=0,a=this.getPlugin(t.attrs.plugin);return r.default.Assert(a,"Should always be able to find a valid plugin: ",t.attrs.plugin),a&&(i=a.measureAttachment(e,t)),i},parseAttachmentEmbedString:function(e,t){r.default.Assert(e,"Must provide a valid string to parse");var i=e.replace(/&quot;/g,'"').split(","),a={};if(i.forEach(function(e){var t=e.indexOf(":"),i=e.substr(0,t),n=e.substr(t+1,e.length-t-1);a[i]=n}),t){var n=i.length>2;a.displayElement=this.createDisplayElement(a,n)}return a},createSimpleAttachment:function(e){return e.isSimpleAttachment=!0,e},handleDropEvent:function(e,t){for(var i=0,a=!1,n=0;n<this._activePlugins.length&&!a;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this._activePlugins[n],o=this.getPlugin(s);try{a=o.handleDropEvent(e,t)}catch(e){this._reportPluginError(e)}}return a||(e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0||e.clipboardData&&e.clipboardData.items&&e.clipboardData.items.length>0)&&r.default.toasts.pushMessage({text:"Attaching files is a Premium feature, using the Drive plugin. Please enable Drive in the settings.",action:MessageAction.OpenSettings}),a},handleTapEvent:function(e,t,i,a){var n=!1,s=r.default.getPluginForElement(i.target);if(s){var o=s.getAttribute("plugin"),l=this.getPlugin(o);if(r.default.Assert(l,"Must be able to get a valid plugin from a plugin element"),l.isPluginBlocked())r.default.toasts.pushMessage(MessageID.PremiumRequired),n=!0;else{var d=s.getAttribute("plugin-id");r.default.Assert(d,"Must have a valid item ID for a plugin element");try{n=l[a](e,t,d,i)}catch(e){this._reportPluginError(e)}}}return n},handleTapStart:function(e,t,i){return this.handleTapEvent(e,t,i,"handleTapStart")},handleTapClick:function(e,t,i){if(!t.isEditable||p.a.mac&&i.metaKey||!p.a.mac&&i.ctrlKey||r.default.hasClass(i.target,"plugin")||r.default.findParent(i.target,"plugin"))return this.handleTapEvent(e,t,i,"handleTapClick")},handleDoubleTap:function(e,t,i){return this.handleTapEvent(e,t,i,"handleDoubleTap")},isAuthorized:function(e){return!!r.default.isDemoMode()||!!this.getPlugin(e)&&!!this.getSetting(e,this.getPlugin(e).Settings.IsEnabled)},getSetting:function(e,t){return this.getPlugin(e).getSetting(t)},setSetting:function(e,t,i){return this.getPlugin(e).setSetting(t,i)},onAuthorizedSetting:function(e,t,i){this.getPlugin(e).onAuthorizedSetting(t,i)},isDependencyLoaded:function(e){return!!this._loadedDependencies[e]},notifyDependencyLoad:function(e,t){for(var i in this._loadedDependencies[e]=t||!0,this._plugins)if(this._plugins.hasOwnProperty(i))try{this.getPlugin(i).onDependencyLoaded(e,t)}catch(e){this._reportPluginError(e)}},notifyDependencyUnload:function(e,t){},_handleBatchRequestResponse:function(e,t){r.default.Assert(e,"Plugin must be passed to response to know who is handling it"),this._numOutstandingReqs--,r.default.Assert(this._numOutstandingReqs>=0,"Outstanding requests cannot be negative");try{e._handleBatchRequestResponse(t)}catch(e){this._reportPluginError(e)}0===this._numOutstandingReqs&&this.notifyNoOutstandingReqs()},_handleRequestResponse:function(e,t,i){r.default.Assert(t,"Plugin must be passed to response to know who is handling it"),i||(this._numOutstandingReqs--,r.default.Assert(this._numOutstandingReqs>=0,"Outstanding requests cannot be negative"));try{t._handleRequestResponse(e,i)}catch(e){this._reportPluginError(e)}0===this._numOutstandingReqs&&this.notifyNoOutstandingReqs()},notifyNoOutstandingReqs:function(){r.default.Assert(0===this._numOutstandingReqs,"Should only notify when there are no outstanding reqs left"),0===this._numOutstandingReqs&&this._setupRequestQueues(!0)},notifyHasPendingRemoteRequest:function(){this._numOutstandingReqs<6&&this._setupRequestQueues(!0)},notifyAuthorizationAdded:function(e){this._numOutstandingReqs<6&&this._setupRequestQueues(!0),this.verifyAuthorization(e)},verifyAuthorization:function(e,t){for(var i,a,n=0,s=0;s<this._activePlugins.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var o=this._activePlugins[s],l=this.getPlugin(o);if(l.isEnabled())!l.verifyAuthorization(e)&&(a=(a||[]).concat(l.googleScopes())),i=i||!l.verifyAuthorization(e)}if(i){var d=function(){f.default.linkAccount(e,[GScope.UserInfoEmail].concat(a))};t?d():r.default.toasts.pushMessage({text:"We are missing authorization for your account ("+e+"). Please reauthorize.",actionText:"REAUTHORIZE",action:d})}},_reportInvalidScopes:function(e,t){r.default.settings.get(Settings.enableOfflineAuth)?(r.default.toasts.pushMessage(MessageID.MissingOfflineMobile),r.default.toasts.clearMessage(MessageID.LostPermission)):r.default.toasts.isMessageVisible(MessageID.MissingOffline)||r.default.toasts.isMessageVisible(MessageID.MissingOfflineMobile)||r.default.toasts.pushMessage(MessageID.LostPermission),r.default.reportError(new Error("Invalid scopes reported"),{accountID:e,scopes:t})},_setupRequestQueues:function(e){var t=e?1:pa;this._forcedLastPossible||(clearTimeout(this._queueTimeout),this._queueTimeout=setTimeout(this._pumpRequestQueues,t)),this._forcedLastPossible=this._forcedLastPossible||!!e},_pumpRequestQueues:function(){this._runPumpRequestQueues(l.a.RequestPriority.UserBlocking),this._runPumpRequestQueues(l.a.RequestPriority.Default),this._runPumpRequestQueues(l.a.RequestPriority.Low)},_runPumpRequestQueues:function(e){var t=0;if(this.isOnline()){var i=0,a=6-this._numOutstandingReqs;r.default.Assert(a>=0,"Should never have more than max outstanding requests at any given point in time");for(var n=0;a>0&&n<this._activePlugins.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this._activePlugins[n],o=this.getPlugin(s),l=4-o.getNumOutstandingReqs();r.default.Assert(l>=0,"Must always have a postiive number of available plugin reqs");var d=Math.min(a,l);if(d>0&&o.isReady()){var u=0;try{u=o._pumpRequestQueue(e,d,this._handleRequestResponse,this._handleBatchRequestResponse),r.default.Assert(u>=0,"Number of requests sent can never be negative")}catch(e){this._reportPluginError(e)}r.default.Assert(a-u>=0,"Too Many requests sent"),t+=u,a-=u,this._numOutstandingReqs+=u}}}else 0;return this._forcedLastPossible=!1,this._setupRequestQueues(),t},_clearRequestQueues:function(){var e=0;this._numOutstandingReqs=0;for(var t=0;t<this._activePlugins.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this._activePlugins[t],a=this.getPlugin(i);try{a._clearRequestQueue()}catch(e){this._reportPluginError(e)}}},useRenderer:function(e,t){return this._pluginRenderer.useRenderer(e,t)},_reportPluginError:function(e){r.default.reportError(e)},parseEmailURL:function(e){var t={accountID:void 0,threadID:void 0,plugin:void 0},i=/https:\/\/mail.google.com\/mail\/b\/(.*)#all\/(.*)/g.exec(e);return i&&(t.accountID=i[1],t.threadID=i[2],t.plugin=this.getPlugin(PluginID.Gmail)),t},isAvailable:function(e){return this.getPlugin(e).isAvailable()},isActive:function(e){return this.getPlugin(e).isActive()},isEnabled:function(e){return this.getPlugin(e).isEnabled()},isGmailPaneEnabled:function(){return this.isEnabled(PluginID.Gmail)}},o.a.defineBase(ma),o.a.extend(ma.prototype,d.a);var va=ma,_a=i(34),ya=i(32),Sa=i(31).default,wa=i(77).default;window.__TOTAL_PANES=0;function Ia(){this.enableTempPanePosition=!1,this.totalWidth=new w.a(0),this._panesById={},this._panes=new k.a,this.displayPanes=new k.a,this.isLoading=new w.a(!0),this._isInitialStateLoaded=!1,this.animatePaneSwap=!1,this._iteratingPanes=!1,this._savedPaneState=void 0,r.default.getLoginState()===LoginState.LOGGED_IN&&this.setupInitialTimeout(),this.init()}Ia.prototype={init:function(){wa.init(),this.mobilePaneSelected=wa.selected,o.a.forceBind("onResize",this),o.a.forceBind("updateDisplayPanes",this),this._panes.listen(this.updateDisplayPanes),ya.a.sidebarChanged.listen(this.onResize),p.a.onResize.listen(this.onResize),g.a.listen("panesChanged",this.updateDisplayPanes),this.onResize()},onPluginGmailToggled:function(){this.savePaneState(),this.loadPanesFromState()},loadInitialState:function(){var e=r.default.vmMain.pluginManager.getPlugin(PluginID.Gmail);e.onSettingChanged(e.Settings.IsEnabled,this.onPluginGmailToggled.bind(this));var t=r.default.isDemoMode()&&o.a.getURLParam("panes");t&&t.split(":");this.loadPanesFromState(),this._isInitialStateLoaded=!0},loadDemoPanes:function(e){var t=0;this.clearPanes();for(var i=0;i<e.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=e[i].split(",");if("help"===a[0])r.default.vmMain.showHelp();else{var n=a[0],o={};if("1"===n||"Outline"===n?(n=PaneMode.Task,o.viewState={viewMode:l.a.TaskViewMode.Outline}):("2"===n||"Calendar"===n)&&(n=PaneMode.Task,o.viewState={viewMode:l.a.TaskViewMode.Calendar_Week}),a.length>1){if(a[1]){for(var d=0,u={text:a[1]},c=a[1].split(" "),h=0;h<c.length;h++){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;var f=!1,p="-"===c[h][0],g=c[h].replace("-","");if(g.indexOf("//")>=0)f=!0,u.complete=p?-1:1;else if(g.indexOf("*")>=0)f=!0,u.starred=p?-1:1;else if(g.indexOf("!")>=0){var m;f=!0,3===g.length?m=VMLIFlag.P0:2===g.length?m=VMLIFlag.P1:1===g.length&&(m=VMLIFlag.P2),u.priority=m}f&&(u.text=u.text.replace(c[h],""))}o.search=u}var v=void 0;a[2]&&(v=s.default.getModel(a[2])),o.item=v||s.default.getRootModel()}var _=S.a.createPane(n,o);_&&this.addPaneAtIndex(_)}}var y=this.getPaneAtIndex(0);r.default.Assert(y,"Must always have at least one valid pane in demo mode"),y&&(M.a.setFocusedPane(y),r.default.vmMain.zoomin(y.getItem(),!0))},getStats:function(e){var t={};return void 0===e?this.runForEachPane(function(e){t[e.id]=e.getStats()}):t=this.getPaneById(e).getStats(),t},setupInitialTimeout:function(){0===this._panes.length()&&(this._initialTimeout=setTimeout(this._timeoutLoadFailed.bind(this),3e4))},_timeoutLoadFailed:function(){r.default.reportError(new Error("Pane Load Timeout")),r.default.toasts.pushMessage({text:"The file is taking an unusually long time to load. Please try loading again.",actionText:"RELOAD",action:r.default.reload}),this._initialTimeout=void 0},notifyPanes:function(){this._panes.notify()},getPaneTopPadding:function(){return r.default.topBarHeight},onResize:function(){this.updatePaneRects()},getNextPaneID:function(){return++window.__TOTAL_PANES+"P"+Date.now()},getAllPerPaneState:function(e,t){for(var i=0,a=[],n=this.paneCount(),s=0;s<n;++s){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=this.getPaneAtIndex(s);a.push(r.getPerPaneState(e,t))}return a},setAllPerPaneState:function(e,t,i){for(var a=0,n=this.paneCount(),s=0;s<n;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;this.getPaneAtIndex(s).setPerPaneState(e,t,i)}},deletePerPaneState:function(e,t){var i=this.getPaneById(e);i&&i.deletePerPaneState(t)},addWorkspace:function(){r.default.Assert(!1,"Should never add a new workspace on mobile");var e=_a.a.add();return this.switchToWorkspace(e),e},switchToWorkspace:function(e){this.savePaneState(!0),_a.a.switchTo(e)},getPaneState:function(){return wa.getPaneState()},hasLoadedPaneState:function(){return wa.hasLoadedPaneState()},savePaneState:function(e){if(r.default.Assert(!this._isLoading,"Bad stuff! Saving pane state during load"),this._isInitialStateLoaded){var t=this.recreatePaneState();wa.savePaneState(t,e)}},updatePaneStateForPane:function(e){r.default.Assert(e,"Must pass in a valid pane to update"),this.savePaneState()},recreatePaneState:function(){var e=[];return this.runForEachPane(function(t){e.push(t.getSaveInfo())}),e},loadPaneFromState:function(e){if(e.id&&this.isPaneActive(e.id))return this._panesById[e.id];var t=e.item||e.focus,i=t&&s.default.getModel(t);i&&i.isDeleted()&&(i=void 0);var a,n=e.type||"PaneTask",o=r.default.clone(e);return o.item=i,o.deferredItemID=i?void 0:t,o.offset=e.offset,o.id&&this.isPaneActive(o.id)||(a=S.a.createPane(n,o))&&(e.id=a.id,e.showarch&&a.showArchived.set(!0),a.applyItemState(e.itemState)),a},loadPanesFromState:function(){for(var e=0,t=wa.loadPanesFromState(),i=0;i<t.length;i++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var a=t[i];this._panesById[a.id]=a}this._panes.set(t,!1),r.default.Assert(this.mobilePaneSelected.get(),"Mobile pane selected should be set");var n=this.mobilePaneSelected.get(),s=this.indexOfPaneType(n.type,n.viewMode);if(!t[s]){var o={type:PaneMode.Task,viewMode:l.a.TaskViewMode.Outline};this.mobilePaneSelected.set(o),s=this.indexOfPaneType(o.type,o.viewMode)}r.default.Assert(s>=0&&t[s],"Mobile selected pane does not exist",{selected:this.mobilePaneSelected.get(),isGmailEnabled:r.default.vmMain.pluginManager.isGmailPaneEnabled(),numPanes:t.length,outlineIsSomething:!!t[this.indexOfPaneType(PaneMode.Task,l.a.TaskViewMode.Outline)]}),M.a.setFocusedPane(t[s]),this.notifyPanes()},isPaneActive:function(e){return!!this._panesById[e]},createDefaultPane:function(){var e=S.a.createPane(PaneMode.Task,{id:this.getNextPaneID(),isDefaultPane:!0,isOverviewVisible:!0});this.addPaneAtIndex(e),M.a.setFocusedPane(this.getPaneAtIndex(0)),r.default.vmMain.zoomin(r.default.vmMain.root(),!0)},createPaneAtIndex:function(e,t,i,a){r.default.Assert(e,"Must supply a valid pane type"),r.default.Assert(!this._iteratingPanes,"Should not change pane array while iterating"),isNaN(t)&&(t=this.paneCount()),(i=i||{}).id=i.id||this.getNextPaneID(),r.default.isString(i.item)&&(i.item=s.default.getModel(i.item));var n=S.a.createPane(e,i);return n?this.addPaneAtIndex(n,t,!1,a):r.default.reportError(new Error("Invalid pane created: "+e+" | "+t)),n},addPaneAtIndex:function(e,t,i,a){if(r.default.Assert(e,"Must supply a valid pane"),r.default.Assert(!this._panesById[e.id],"Should never add the same pane twice"),this._panesById[e.id]=e,this.enableTempPanePosition&&this._panes.length()>0&&t===this._panes.length()){var n=this._panes.get()[this._panes.length()-1];this.tempPositionForNewPane={pane:n,left:n.rect.get().left+l.a.PaneSpaceSize}}if(isNaN(t)?this._panes.push(e,a):this._panes.splice(t,0,e,a),e.init(),e.isExpanded.listen(this.onResize),this.tempPositionForNewPane&&(this.tempPositionForNewPane=null,setTimeout(this.onResize.bind(this),0)),this.ensurePaneInView(e),!i){var s=this.getPaneState();isNaN(t)?s.push(e.getSaveInfo()):s.splice(t,0,e.getSaveInfo()),this.savePaneState()}},unloadPane:function(e){e.unload(),e.isExpanded.unlisten(this.onResize),g.a.fireEvent("paneRemoved",[e]),r.default.Assert(this._panesById[e.id],"Should never add the same pane twice"),this._panesById[e.id]=void 0,e.destroy()},removePaneAtIndex:function(e,t){var i;r.default.Assert(!isNaN(e),"Must supply a valid index to remove from"),r.default.Assert(!this._iteratingPanes,"Should not change pane array while iterating");var a=this._panes.splice(e,1,void 0,t)[0];return r.default.Assert(a,"Must have removed a valid pane"),this.unloadPane(a),this.getPaneState().splice(e,1),this.savePaneState(),i=a.id,this.ensurePaneInView(),i},removePanesByType:function(e){r.default.Assert(e,"Must supply a valid pane type to remove"),r.default.focusedPane&&r.default.focusedPane.type!==e||this.swapToPane(PaneMode.Task)},indexOfPaneType:function(e,t){return this._panes.get().findIndex(function(i){return e!==PaneMode.Task?i.type===e:t===l.a.TaskViewMode.Outline?i.isViewOutline():i.isViewAgenda()})},swapToPane:function(e,t,i){r.default.Assert(!0,"We only perform pane swapping on mobile"),r.default.Assert(!this._iteratingPanes,"Should not change pane array while iterating"),Sa.setOverviewVisibility(r.default.focusedPane,!1);var a=this.indexOfPaneType(e,t);a<0&&(this.loadPanesFromState(),a=this.indexOfPaneType(e,t));var n=this._panes.get()[a];return this.animatePaneSwap=i,r.default.Assert(n,"Swapping to undefined pane",e,this._panes.length()),M.a.setFocusedPane(n),this.mobilePaneSelected.set({type:e,viewMode:t}),this.savePaneState(),n},removeFocusedPane:function(){return this.removePane(r.default.focusedPane)},removePane:function(e){var t=this.getPaneIndex(e);return this.removePaneAtIndex(t)},clearPanes:function(e){r.default.Assert(r.default.isDemoMode(),"Should only be clearing panes in demo mode"),M.a.setFocusedPane(void 0),this.runForEachPane(function(e){e.destroy()}),this._panesById={},this._panes.set([],e)},clearPaneCaches:function(){this.runForEachPane(function(e){e.getInfiniteList().clearCache()})},getPaneAtIndex:function(e){return this._panes.get()[e]},getPaneIndex:function(e){return this._panes.get().indexOf(e)},getFocusedPaneIndex:function(){return this.getPaneIndex(r.default.focusedPane)},getPaneById:function(e){return r.default.Assert(this._panesById[e],"Should never request a pane that is not currently loaded"),this._panesById[e]},getPanesByType:function(e){for(var t=0,i=[],a=this.paneCount(),n=0;n<a;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=this.getPaneAtIndex(n);e&&s.type!==e||i.push(s)}return i},paneCount:function(){return this._panes.get().length},runForEachPane:function(e,t){var i=0;this._iteratingPanes=!0;for(var a=this.paneCount(),n=0;n<a;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this.getPaneAtIndex(n);if(r.default.Assert(!s.isDestroyed(),"Should never have a destroyed pane in pane list"),!t||s.type===t)try{e(s)}catch(e){r.default.reportError(e)}}this._iteratingPanes=!1},applyFnToPanes:function(e,t){var i=0;this._iteratingPanes=!0;for(var a=this.paneCount(),n=0;n<a;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this.getPaneAtIndex(n);if(r.default.Assert(!s.isDestroyed(),"Should never have a destroyed pane in pane list"),!t||s.type===t){var o=s[e];r.default.Assert(o,"Must provide a valid function name for the given pane type");try{o.apply(s,Array.prototype.slice.call(arguments,2))}catch(e){r.default.reportError(e)}}}this._iteratingPanes=!1},dragPaneTo:function(e,t,i){for(var a,n=0,s=this._panes.get(),r=s.indexOf(e),o=-1,l=Number.MAX_VALUE,d=this.paneCount(),u=0;u<d;++u){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var c=this.getPaneAtIndex(u).rect.get(),h=Math.abs(u<=r?c.left-t:c.right-i);h<l&&(l=h,o=u)}if(o>=0){var f=s.indexOf(e);f!==o&&(s.splice(o,0,s.splice(f,1)[0]),this._panes.set(s),this.savePaneState(),a=!0)}return a},paneSortFn:function(e,t){return e.uniquePaneID-t.uniquePaneID},clearLoadTimeout:function(){clearTimeout(this._initialTimeout),this._initialTimeout=void 0},updateDisplayPanes:function(){var e=0;this._initialTimeout&&this.clearLoadTimeout();for(var t=this._panes.get().slice(0).sort(this.paneSortFn),i=[],a=0;a<t.length;++a){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var n=t[a];n.isOverviewVisible()&&i.push({type:"overview",pane:n}),i.push({type:"pane",pane:n}),n.isExpanded.get()&&i.push({type:"emailPreview",pane:n})}this.updatePaneRects(),this.displayPanes.set(i),this.isLoading.set(!1)},updatePaneRects:function(e){this.isResizingPane=e;var t,i,a=this._panes.get(),n=(ya.a.getSidebarWidth(),p.a.windowWidth()-0),s=p.a.windowHeight()-this.getPaneTopPadding()-ya.a.topBarHeight();r.default.isDemoInIframe()&&(n-=5);var o=0;for(t=0;t<a.length;t++){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var l={left:t*p.a.windowWidth(),top:0,width:n,height:s,right:n,bottom:s},d=a[t];r.default.areObjectsEqual(d.rect.get(),l)||d.rect.set(l)}if(this.mobilePaneSelected.notify(),this.tempPositionForNewPane){var u=a[a.length-1].rect.get(),c=this.tempPositionForNewPane;u.left=c.left+c.pane.rect.get().width}this.totalWidth.set(i),e||g.a.fireEvent("paneSizeChanged",[])},ensurePaneInView:function(e){if(r.default.vmMain.panesContainer){if(!e){var t=this._panes.get();e=t[t.length-1]}if(e){var i=e.rect.get();if(i){var a=i.width+(e.isExpanded.get()?i.widthExpanded:0),n=p.a.windowWidth()-0,s=r.default.vmMain.getScrollOffset(),o=i.left-s,l=i.left+a-s;(o<0||l>n)&&r.default.vmMain.setScrollOffset(i.left+a-n)}}}},hasScrollbar:function(){return this.totalWidth.get()>p.a.windowWidth()},onWorkspaceChanged:function(){this.loadPanesFromState()},_addPaneByButton:function(e,t,i,a){var n=this.createPaneAtIndex(e,void 0,{viewState:{viewMode:t},item:i});n&&(y.a.performAction(TrackerType.UIAction,{type:TrackerUIAction.AddPane,data:{type:e,pane:n}}),r.default.sendEvent("Menu","AddPane_"+e)),M.a.setFocusedPane(n),n.onAdded(a)},addPaneByButton:function(e,t,i){r.default.vmMain.paneFactory.canCreatePane(e)&&this._addPaneByButton(e,t,i)},emailPreviewSize:function(e){var t=this._panes.length()>1?l.a.EmailPreviewSizeMaxFlex:l.a.EmailPreviewSizeMax,i=e.widthManual||l.a.ExpandedPaneWidth;return e.getOverview().isVisible.get()&&(i+=l.a.OverviewWidth),Math.max(Math.min(t,p.a.windowWidth()-i),l.a.EmailPreviewSizeMin)}},o.a.defineBase(Ia);var ba=Ia;function Aa(e,t){this._type=e,this._name=t,this._doc=void 0,this._loadFn=void 0,this._errorFn=void 0,this._initFn=void 0}Aa.prototype={open:function(e,t,i,a){r.default.Assert(!1,"SubClass must override")},close:function(){r.default.Assert(!1,"SubClass must override")},_getDocument:function(){return this._doc},getModel:function(){return this._doc.getModel()},setLoadFn:function(e){return this._loadFn=e,this._onLoad.bind(this)},setInitFn:function(e){return this._initFn=e,this._onInit.bind(this)},setErrorFn:function(e){return this._errorFn=e,this._onError.bind(this)},_onLoad:function(e){this._doc=e;try{this._loadFn(e)}catch(e){r.default.reportError(e)}},_onError:function(e){this._errorFn(e)},_onInit:function(e){try{this._initFn(e)}catch(e){r.default.reportError(e)}}},o.a.defineBase(Aa);var Da=Aa;function Ta(e){this._super.constructor.call(this,l.a.DocType.GRealtime,e),this.init()}var Ma={init:function(){},open:function(e,t,i,a){v.a.driveRealtimeLoad(e,this.setLoadFn(t),this.setInitFn(i),this.setErrorFn(a))},close:function(){}};o.a.inherit(Da,Ta),o.a.extend(Ta.prototype,Ma);var Ca=Ta;function La(e){this._super.constructor.call(this,l.a.DocType.GAppData,e),this.init()}var Pa={init:function(){},open:function(e,t,i,a){gapi.drive.realtime.loadAppDataDocument(this.setLoadFn(t),this.setInitFn(i),this.setErrorFn(a))},close:function(){}};o.a.inherit(Da,La),o.a.extend(La.prototype,Pa);var Ea=La;function ka(){this._activeDocuments={},this._activeTypes={},this._authorizedTypes={},this._listeners=[],this.init()}ka.prototype={init:function(){var e=function(){window.gapi.drive?(this._activateType(l.a.DocType.GRealtime),this._activateType(l.a.DocType.GAppData)):(r.default.reportError(new Error("Fatal error while loading google drive - did not add self to gapi")),window.addEventListener("gapiDriveLoaded",e.bind(this)))}.bind(this);window.gapi&&window.gapi.drive?e():window.addEventListener("gapiDriveLoaded",e.bind(this))},_activateType:function(e){this._activeTypes[e]?r.default.Assert(!1,"Should only be activating a doc type once"):(this._activeTypes[e]=!0,this._authorizedTypes[e]&&this._notifyListeners(e))},_authorizeType:function(e){this._authorizedTypes[e]||(this._authorizedTypes[e]=!0,this._activeTypes[e]&&this._notifyListeners(e))},registerForReadyNotification:function(e,t){r.default.isArray(this._listeners[e])?this._listeners[e].push(t):void 0===this._listeners[e]?this._listeners[e]=[t]:(r.default.Assert(-1===this._listeners[e],"After a type is loaded, do not queue listners"),t())},_notifyListeners:function(e){if(r.default.isArray(this._listeners[e]))for(var t=0,i=0;i<this._listeners[e].length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this._listeners[e][i]()}this._listeners[e]=-1},notifyGoogleAuthorization:function(){for(var e=0,t=f.default.getAuthorizedScopes(),i=0;i<t.length;++i){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;switch(t[i]){case GScope.Drive:case GScope.DriveFull:this._authorizeType(l.a.DocType.GRealtime);break;case GScope.DriveAppData:this._authorizeType(l.a.DocType.GAppData)}}},createDocument:function(e,t){var i;switch(r.default.Assert(e,"Must provide a document type"),t=t||r.default.generateTempId(),r.default.Assert(!this._activeDocuments[t],"Should not name two documents the same thing"),e){case l.a.DocType.GRealtime:i=new Ca(t);break;case l.a.DocType.GAppData:i=new Ea(t);break;default:r.default.Assert(!1,"Invalid document type requested",e)}return this._activeDocuments[t]=i,i}};var xa=ka,Ra=i(47),Oa="Suspend",Fa="Resume",Na="AsyncSkip",Ba="SyncSkip",Ua="Run",Va="AsyncBegin",Ha="AsyncComplete",qa="AsyncAbort",za="AsyncTimeout";function Wa(e,t){r.default.Assert(t,"Must provide a valid set of task options: "+e),this._id=e,this._iterationID=void 0,this._isAsync=t.async,this._isAsyncRunning=!1,r.default.Assert(t.task&&r.default.isFunction(t.task),"Must provide a valid task function"),this._task=t.task,this._delay=t.delay,r.default.Assert(void 0===t.asyncTimeout||t.async,"Should never specify an async timeout for a non-async task"),this._asyncTimeout=t.asyncTimeout||0,this._pauseWhileIdle=t.pauseWhileIdle||!1,this._minDelayOnResume=t.minDelayOnResume||!1,r.default.Assert(this._pauseWhileIdle||!this._minDelayOnResume,"Must use pauseWhileIdle to support minDelayOnResume"),this._suspended=!1,this._remainingTime=0,this._lastUpdate=t.runOnCreate?0:Date.now(),this._asyncStartTime=-1,this._numUpdatesRun=0,this._numUpdatesSkipped=0,this._numUpdatesAsyncSkipped=0,this._numAsyncAborts=0,this._numAsyncTimeouts=0,this._minDelay=t.minDelay||0,this._lastSetDelay=this._delay,this._runningTimeout=void 0,this._asyncAbortTimeout=void 0,this._updateIsRunning=!1,this._isCancelled=!1,this._updateTimes=new Ra.a(10),this._actions=new Ra.a(20),this.init()}var Ga={init:function(){o.a.forceBind("_runUpdate",this),o.a.forceBind("_notifyAsyncComplete",this),o.a.forceBind("_handleAsyncAbortTimeout",this),this._lastUpdate>0?(clearTimeout(this._runningTimeout),this._runningTimeout=setTimeout(this._runUpdate,this._delay)):this._runUpdate()},getStats:function(){return{numUpdatesRun:this._numUpdatesRun,numUpdatesSkipped:this._numUpdatesSkipped,numUpdatesAsyncSkipped:this._numUpdatesAsyncSkipped,numAsyncAborts:this._numAsyncAborts,numAsyncTimeouts:this._numAsyncTimeouts,updateIsRunning:this._updateIsRunning,isAsync:this._isAsync,isAsyncRunning:this._isAsyncRunning,cancelled:this._isCancelled,suspended:this._suspended,lastUpdate:this._lastUpdate,asyncRunTime:this._asyncRunTime(),timeSinceLastUpdate:this._timeSinceLastUpdate(),updateTimes:this._updateTimes.ordered(),actions:this._actions.ordered()}},cancel:function(){this._isCancelled=!0,clearTimeout(this._runningTimeout),this._runningTimeout=void 0},abortAsync:function(){this._numAsyncAborts++,this.performAction(qa),this._notifyAsyncAborted()},performAction:function(e){r.default.Assert(e,"Invalid action reported"),this._actions.push({action:e,time:Date.now()})},notifyOfSuspend:function(){this._pauseWhileIdle&&(this.performAction(Oa),this._suspended=!0,this._remainingTime=Math.max(0,this._lastSetDelay-this._timeSinceLastUpdate()),clearTimeout(this._runningTimeout),this._runningTimeout=void 0)},notifyOfResume:function(){if(this._pauseWhileIdle){this.performAction(Fa);var e,t=!this._suspended;this._suspended=!1,this._minDelayOnResume?e=Math.max(0,this._minDelay-this._timeSinceLastUpdate()):(r.default.Assert(t||this._remainingTime>=0,"Must have a valid remaining time set for task"),e=this._remainingTime,this._remainingTime=-1),e=Math.max(500,e),clearTimeout(this._runningTimeout),this._runningTimeout=setTimeout(this._runUpdate,e)}},isAsync:function(){return this._isAsync},isAsyncRunning:function(){return this.isAsync()&&this._isAsyncRunning},_notifyUpdateAsyncSkipped:function(){this._numUpdatesAsyncSkipped++,this.performAction(Na)},_notifyUpdateSkipped:function(){this._numUpdatesSkipped++,this.performAction(Ba)},_notifyUpdateRun:function(){this._lastUpdate=Date.now(),this._updateTimes.push(this._lastUpdate),this._numUpdatesRun++,this.performAction(Ua)},_timeSinceLastUpdate:function(){return Date.now()-this._lastUpdate},_asyncRunTime:function(){var e=0;return this._asyncStartTime>0&&(e=Date.now()-this._asyncStartTime),e},_notifyAsyncBegin:function(){return this.performAction(Va),this._isAsyncRunning=!0,this._iterationID=r.default.generateTempId(),this._asyncStartTime=Date.now(),this._asyncTimeout&&(this._asyncAbortTimeout=setTimeout(this._handleAsyncAbortTimeout,this._asyncTimeout)),this._iterationID},_notifyAsyncComplete:function(){this.performAction(Ha),this._isAsyncRunning=!1,this._asyncStartTime=-1,this._iterationID=void 0,this._asyncAbortTimeout&&(clearTimeout(this._asyncAbortTimeout),this._asyncAbortTimeout=void 0)},_notifyAsyncAborted:function(){this._isAsyncRunning=!1,this._asyncStartTime=-1,this._asyncAbortTimeout&&(clearTimeout(this._asyncAbortTimeout),this._asyncAbortTimeout=void 0)},_handleAsyncAbortTimeout:function(){this._numAsyncTimeouts++,this.performAction(za),this._notifyAsyncAborted()},_runUpdate:function(e){if(r.default.Assert(!this._isCancelled,"Should never run a cancelled task"),r.default.Assert(!this._updateIsRunning,"Should not run another update while already running one: "+this._id),!this._updateIsRunning){if(this._updateIsRunning=!0,clearTimeout(this._runningTimeout),this._runningTimeout=void 0,this._notifyUpdateRun(),this.isAsync())if(this.isAsyncRunning())this._asyncTimeout&&this._asyncTimeout<this._asyncRunTime()?(this.abortAsync(),setTimeout(this._runUpdate.bind(this,e),0)):this._notifyUpdateAsyncSkipped();else{var t=this._notifyAsyncBegin();try{this._task(function(){r.default.Assert(t===this._iterationID,"Callback is only valid while task is considered running"),this._notifyAsyncComplete(),e&&e.apply(this,arguments)}.bind(this))}catch(e){r.default.reportError(e),this._notifyAsyncComplete()}}else try{this._task()}catch(e){r.default.reportError(e)}this._runningTimeout=setTimeout(this._runUpdate,this._delay),this._lastSetDelay=this._delay,this._remainingTime=this._delay,this._updateIsRunning=!1}},requestUpdate:function(){if(this._timeSinceLastUpdate()>this._minDelay)this._runUpdate();else{this._notifyUpdateSkipped();var e=this._minDelay-this._timeSinceLastUpdate();clearTimeout(this._runningTimeout),this._runningTimeout=setTimeout(this._runUpdate,e),this._lastSetDelay=this._minDelay}},forceUpdate:function(e){this._runUpdate(e)},breakOnNextUpdate:function(){0}};o.a.extend(Wa.prototype,Ga);var ja=Wa;function Ka(){this._tasks={},this.init()}var Ya={init:function(){window.addEventListener("focus",this._handleFocus.bind(this)),window.addEventListener("blur",this._handleBlur.bind(this))},getStats:function(){var e={};for(var t in this._tasks)e[t]=this._tasks[t].getStats();return e},createRecurringTask:function(e,t){r.default.Assert(!this._tasks[e],"Must not register multiple tasks with the same ID");var i=new ja(e,t);return this._tasks[e]=i,i},getRecurringTask:function(e){return r.default.Assert(this._tasks[e],"Must only retreive a valid recurring task"),this._tasks[e]},hasRecurringTask:function(e){return!!this._tasks[e]},cancelRecurringTask:function(e){r.default.Assert(this._tasks[e],"Must only cancel a valid recurring task"),this._tasks[e].cancel(),delete this._tasks[e]},_handleFocus:function(){for(var e in this._tasks)this._tasks[e].notifyOfResume()},_handleBlur:function(){for(var e in this._tasks)this._tasks[e].notifyOfSuspend()}};o.a.extend(Ka.prototype,Ya);var Xa=Ka;function Qa(e,t,i,a,n,s,l,d,u){this._id=e,this._remoteID=n,this._type=t,r.default.Assert(r.default.isDateValid(i),"Must specify a valid schedule date for deferred task"),this._scheduleDate=i,this._timeout=void 0,this._data=s,this._cbRun=l,this._cbCancel=d,this._cbPersistRemote=u,this._hasRun=!1,this._isCanceled=a,this._destroyed=!1,o.a.forceBind("runTask",this),o.a.forceBind("_onCanceled",this),o.a.forceBind("_onPersistedRemote",this)}Qa.prototype={schedule:function(){r.default.Assert(!this._timeout,"Should not schedule the same task multiple times"),r.default.Assert(!this._hasRun,"Should not schedule a task once it has already run once"),r.default.Assert(!this._isCanceled,"Should not schedule canceled tasks");var e=Math.max(0,this._scheduleDate.getTime()-Date.now());this._timeout=setTimeout(this.runTask,e),!this._remoteID&&e>0&&j.a.onUserAuthorized("me","DeferredTask_schedule",function(){try{this._cbPersistRemote(this,this._onPersistedRemote)}catch(e){r.default.reportError(e)}}.bind(this))},_onCanceled:function(e){e&&(this._destroyed=!0,r.default.vmMain.deferredTaskManager._notifyTaskComplete(this._id))},_onPersistedRemote:function(e,t){e&&(this._remoteID=t,r.default.vmMain.deferredTaskManager._updateTask(this._id))},reschedule:function(e){r.default.Assert(!this._hasRun,"Should never reschedule a task that has already run"),r.default.Assert(!this._isCanceled,"Should not reschedule canceled tasks"),r.default.Assert(this._timeout,"Must always have already schedule a task that is being rescheduled"),clearTimeout(this._timeout),this._timeout=void 0,this._scheduleDate=e,this.schedule()},cancel:function(){r.default.Assert(this._timeout||this._remoteID,"Must always have already scheduled (locally or remotely) a task that is being canceled"),r.default.Assert(!this._hasRun,"Should not cancel tasks that have already been run"),this._isCanceled=!0,clearTimeout(this._timeout),this._timeout=void 0,this._remoteID&&j.a.onUserAuthorized("me","DeferredTask_cancel",function(){try{this._cbCancel(this,this._onCanceled)}catch(e){r.default.reportError(e)}}.bind(this)),r.default.vmMain.deferredTaskManager._updateTask(this._id)},runTask:function(){this._timeout=void 0,this._hasRun=!0;try{this._cbRun(this)}catch(e){r.default.reportError(e)}r.default.vmMain.deferredTaskManager._notifyTaskComplete(this._id)},getData:function(){return this._data},getType:function(){return this._type},getScheduleDate:function(){return this._scheduleDate},getSaveData:function(){return{id:this._id,remoteID:this._remoteID,type:this._type,scheduleDate:this._scheduleDate,data:this._data,isCanceled:this._isCanceled}},isPersistedRemote:function(){return!!this._remoteID}};var Ja=Qa;function Za(){this._taskCache=m.a.registerLocalCache("DeferredTasks","DeferredTasks",StorageType.LocalStorage),this._registeredTypes={},this._deferredTasks={},this._stats={},this.init()}Za.prototype={init:function(){this._taskCache.onCacheReady(function(){this._taskCache.loadAll(function(e){r.default.Assert(e,"Must be able to load task cache");this._taskCache.getFilterEntries(function(){return!0},function(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=e[i];this.scheduleTask(a.id,a.type,new Date(a.scheduleDate),a.isCanceled,a.remoteID,a.data,!0)}}.bind(this))}.bind(this))}.bind(this))},getLastSyncDate:function(){var e=r.default.settings.get(Settings.lastTaskSync);return r.default.Assert(!e||r.default.isString(e),"Must have a valid string sync date"),e},getStats:function(){return{}},notifyRemoteTasks:function(e){for(var t=0,i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;this._handleRemoteTask(e[i])}r.default.settings.set(Settings.lastTaskSync,new Date)},_handleRemoteTask:function(e){log("Remote Task: ",e),this.scheduleTask(e.data.threadID,e.type,new Date(e.data.scheduleDate),!1,e.messageID,e.data)},registerTaskType:function(e,t,i,a){r.default.Assert(!this._registeredTypes[e],"Must not double register task type"),r.default.Assert(r.default.isFunction(t),"Must register a valid run callback"),r.default.Assert(r.default.isFunction(i),"Must register a valid cancel callback"),r.default.Assert(r.default.isFunction(a),"Must register a valid persist callback"),this._registeredTypes[e]={cbRun:t,cbCancel:i,cbPersistRemote:a}},_notifyTaskComplete:function(e){this._removeTask(e)},scheduleTask:function(e,t,i,a,n,s,o){r.default.Assert(e,"Must supply a valid task ID"),r.default.Assert(t,"Must supply a valid task type"),r.default.Assert(r.default.isDateValid(i),"Must always have a valid scheduled date available"),this._taskCache.onCacheReady(function(){if(r.default.Assert(this._registeredTypes[t],"Must request a valid registered task type"),this._deferredTasks[e]){var l=this._deferredTasks[e];return r.default.Assert(l.getType()===t,"Task types must match"),void r.default.Assert(l.getScheduleDate().equals(i),"Task schedule dates must match")}var d=this._registeredTypes[t];if(d){var u=new Ja(e,t,i,a,n,s,d.cbRun,d.cbCancel,d.cbPersistRemote);this._deferredTasks[e]&&(log("Overriding existing task"),r.default.Assert(this._deferredTasks[e].type===t,"Should only update deferred tasks of the same type")),this._addTask(e,u,o),a?u.cancel():u.schedule()}}.bind(this))},cancelTask:function(e,t){this._deferredTasks[e].cancel()},_updateTask:function(e){var t=this._deferredTasks[e];this._taskCache.cacheEntry(e,t.getSaveData())},_addTask:function(e,t,i){this._deferredTasks[e]=t,i||this._updateTask(e)},_removeTask:function(e){this._deferredTasks[e]=void 0,this._taskCache.removeEntry(e)}};var $a=Za;function en(){this._openDocuments={},this._docMap={},this._docList=new k.a,this._docListTrashed=new k.a,this._isLoading=!1,this._hasError=!1,this._hasLoadedDocList=!1,this._hasTrashedDocuments=!1,this._loadingCallbacks=[],this.init()}en.prototype={init:function(){0},hasTrashedDocuments:function(){return this._hasTrashedDocuments},loadDocList:function(e){if(r.default.Assert(this._loadingCallbacks.indexOf(e)<0,"Should never add the same callback twice to doc list load"),this._loadingCallbacks.push(e),!this._isLoading){this._isLoading=!0,this._hasTrashedDocuments=!1;var t=[],i="mimeType='"+f.default.MoodoMimetype+"'",a={maxPageResults:999,maxPages:12},n=function(e,i){var a=0,n=0;r.default.Assert(!i,"Should not have additional results when requesting a file list");for(var s=0;s<e.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;e[s].appDataContents||e[s].labels.trashed?e[s].labels.trashed&&(this._hasTrashedDocuments=!0,t.push(new A(e[s],!0))):this.loadDocFromData(e[s],!0,!1)}this._docListTrashed.set(t),this._docList.notify();for(var o=0;o<this._loadingCallbacks.length;++o){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;try{this._loadingCallbacks[o](!0)}catch(e){r.default.reportError(e)}}this._loadingCallbacks=[],this._isLoading=!1,this._hasLoadedDocList=!0,this.isOpenDocTrashed()&&(r.default.menus.confirm("Your document is in the Trash in Google Drive. If it gets deleted from Drive, your data will be lost, so we recommend restoring it. Do you want to restore it now?",function(e){if(e){var t=this.getOpenDoc();r.default.vmMain.remoteAPI().driveFilesUntrash(t.id,function(){r.default.toasts.pushMessage({text:"Successfully removed your document from the trash.",action:MessageAction.Okay})},function(e){var t=r.default.vmMain.getUserEmail();r.default.toasts.pushMessage({text:"There was an error moving your document out of the trash. Click to try manually removing.",action:MessageAction.OpenURL,actionText:"UNTRASH",data:{url:"https://drive.google.com/drive/u/"+t+"/search?q=mimetype=application/vnd.google-apps.drive-sdk.597847337936%20is:trashed"}}),r.default.reportError(new Error("Failed to untrash doc: "+e.error.code),e)})}}.bind(this)),r.default.reportError(new Error("Open doc trashed: "+this.getOpenDoc().id)))}.bind(this),s=function(e,t){var i=0;this._hasError=!0;for(var a=0;a<this._loadingCallbacks.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;try{this._loadingCallbacks[a](!1,e)}catch(e){r.default.reportError(e)}this._loadingCallbacks=[],this._isLoading=!1}}.bind(this);r.default.vmMain.remoteAPI().driveFilesList(i,n,s,a)}},loadDocFromData:function(e,t,i){r.default.Assert(e,"Must provide valid data to load doc from"),r.default.Assert(e.id,"Must have valid doc id in data");var a=this._docMap[e.id];return a?a.updateData(e,t):(a=new A(e,t),this.setDoc(a,i)),a},setDoc:function(e,t){r.default.Assert(e,"Must supply a valid doc to set"),r.default.Assert(!this._docMap[e.id],"Should never override an existing doc with a new one"),this._docMap[e.id]=e,this._docList.insertSorted(e,this.sortFn,t)},sortFn:function(e,t){return e.getTitle().localeCompare(t.getTitle())},getAutoDefaultDoc:function(){var e;try{for(var t in this._docMap)if(this._docMap.hasOwnProperty(t)){var i=this._docMap[t];if(e){var a=new Date(e.getData().lastViewedByMeDate);new Date(i.getData().lastViewedByMeDate).isAfter(a)&&(e=i)}else e=i}}catch(e){r.default.reportError(e)}return e},getDoc:function(e){return this._docMap[e]},hasDoc:function(e){return!!this._docMap[e]},getDocList:function(){return this._docList},isOpenDocTrashed:function(){var e=!1;if(this._hasLoadedDocList){var t=this.getOpenDoc();t&&(e=t.isTrashed())}return e},deleteDoc:function(e,t){var i=this._docMap[e];r.default.Assert(i,"Must be deleting a document that we know about"),i.deleteData(function(a){a&&(delete this._docMap[e],this._docList.remove(i),i.isOpen()&&(delete this._openDocuments[e],s.default.clearDataAndReload(!0))),t(a)}.bind(this))},deleteAllDocs:function(e){f.default.deleteAllFiles(this._docList.get(),e)},createNewDoc:function(){return new A},isLoading:function(){return this._isLoading},getOpenDoc:function(){var e;for(var t in this._openDocuments)if(this._openDocuments.hasOwnProperty(t)){e=this._openDocuments[t];break}return e},isDocOpen:function(e){return!!this._openDocuments[e]},setDocOpened:function(e){r.default.Assert(e,"Must specify a valid ID when opening a doc"),r.default.Assert(!this._openDocuments[e],"Document must not have already been opened");var t=this._docMap[e];r.default.Assert(t,"Must supply a valid ID matching a created doc"),this._openDocuments[e]=t},setDocClosed:function(e){var t=this._openDocuments[e];r.default.Assert(t,"Must have a valid opened doc"),delete this._openDocuments[e]}},o.a.defineBase(en);var tn=en,an=i(15),nn=i(31).default,sn={dragStart:function(e,t){var i=e.pane||r.default.focusedPane;r.default.Assert(i.isItemDraggable(this),"Should not be able to drag/drop on timeline on mobile"),r.default.Assert(i.isItemDraggable(this),"Pane must be draggable in order to start a drag"),r.default.Assert(We.default.startDragItem,"Should always have a valid item to start dragging from");var a=r.default.getElementParent(e.startSrc||e.target);if(r.default.Assert(a,"Must have a valid target node"),a){var n,s;if(We.default.startDragItem=void 0,We.default.dragItem=this,i.isViewCalendar()||t||r.default.findParent(a,"itemNotInPane"))n=[{item:this,levelsDeep:0}];else{var o=r.default.getPaneObjectForElement(a),l=this.levelsDeep.get(),d=o.levelsDeep;if(n=[o],s=o.block,!this.isCollapsed(i)){var u=0,c=this.getVisibleChildren(i),h={},f=[];h[this.id]=o;for(var p=0;p<c.length;p++){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;var g=c[p],m={item:g,levelsDeep:g.levelsDeep.get()-l+d,index:o.index+p+1,parentObject:h[g.parent().id]};h[g.id]=m,f.push(m)}n=n.concat(f)}}var v=r.default.offset(a),_=v.left,y=v.top;i.addScrollListener(this.dragScroll);var S={x:e.eventX,y:e.eventY,items:n},w={dropEffect:i.dropEffect(this),item:this,element:a,block:s,pane:i};We.default.start(this,n,_,y,i,S,w,t),r.default.disableMouseMove=!0}},dragMove:function(e){if(r.default.Assert(We.default.startInfo,"Must have started a drag to be valid"),We.default.startInfo){if("touchmove"===e.type){if(!e.cancelable)return void this.dragEnd(e);e.returnValue=!1,e.returnFalse=!0,e.preventDefault(),e.stopPropagation()}var t=e.eventX-We.default.startInfo.x,i=e.eventY-We.default.startInfo.y,a=r.default.elementFromPoint(e.eventX,e.eventY);We.default.setTransform(t,i),a&&We.default.handleDragOver({item:this,target:a,dataTransfer:We.default.dataTransfer,diffY:e.diffY,clientX:e.eventX,clientY:e.eventY,preventDefault:r.default.emptyFn,stopPropagation:r.default.emptyFn,stopImmediatePropagation:r.default.emptyFn})}},dragScroll:function(e){if(We.default.isDragging&&!isNaN(M.a.mousePos.x)&&!isNaN(M.a.mousePos.y)){var t={eventX:M.a.mousePos.x,eventY:M.a.mousePos.y,preventDefault:r.default.emptyFn,stopPropagation:r.default.emptyFn,diffY:0};this.dragMove(t)}},dragEnd:function(e){var t=this;r.default.disableMouseMove=!1,We.default.stop(),e&&e.target!==document.documentElement&&We.default.handleDrop({target:e.target,clientX:e.clientX,clientY:e.clientY,dataTransfer:We.default.dataTransfer,fromDropBucket:e.fromDropBucket,ctrlKey:e.ctrlKey,altKey:e.altKey,preventDefault:r.default.emptyFn,stopPropagation:r.default.emptyFn,stopImmediatePropagation:r.default.emptyFn}),We.default.finish(),r.default.vmMain.paneManager.runForEachPane(function(e){e.getInfiniteList().hasScrollListener(t.dragScroll)&&e.removeScrollListener(t.dragScroll)}),r.default.disableMouseMove=!1},onTouchHoldTimeout:function(e){this._destroyed||(r.default.isKeyboardOpen?this.isLoupeOpen=!0:r.default.focusedPane&&r.default.focusedPane.isDropTarget&&this.isDraggable()&&r.default.focusedPane.isItemDraggable(this)&&!r.default.findParent(e.target,"androidInput")&&(this.isEditable.set(!1),We.default.startDragItem=this,this.dragStart(e),this.dragMove(e)))},checkDragOnStart:function(e){We.default.escapedDragging=!1,We.default.startDragItem=this,r.default.preventDefault(e),r.default.stopPropagation(e)},checkDragOnMove:function(e,t){if(We.default.startDragItem&&!We.default.escapedDragging&&(!p.a.touch||Math.abs(e.distanceY)>r.default.ClickThreshold&&Math.abs(e.distanceX)<r.default.ClickThreshold)){var i=e.pane||r.default.focusedPane;We.default.startDragItem===this&&this.isDraggable()&&i.isItemDraggable(this)&&this.dragStart(e,t)}We.default.isDragging&&(this.dragMove(e),r.default.preventDefault(e),r.default.stopPropagation(e))},checkDragOnEnd:function(e){We.default.startDragItem=void 0,We.default.isDragging&&this.dragEnd(e)},onStart:function(e,t,i){var a=r.default.focusedPane,n=!1;(r.default.scrollAtTouchStart=a.getScrollOffset(),r.default.isKeyboardOpen||this.isEditable.set(!1),!r.default.isKeyboardOpen&&p.a.useCustomScroller&&r.default.preventAndStop(i),r.default.hasClass(i.target,"paneScroller"))?p.a.useCustomScroller&&(n=!0):(p.a.ie||"UL"===i.target.tagName||!a.isItemDraggable(this)||g.a.isListening("touchHoldTimeout",this.onTouchHoldTimeout)||g.a.listen("touchHoldTimeout",this.onTouchHoldTimeout),i.clientX>a.getWidth()-r.default.SPThresholdRight||r.default.vmMain.pluginManager.handleTapStart(this,a,i));return n},onMove:function(e,t){this.checkDragOnMove(e,!1)},onClick:function(e,t,i){var a=r.default.focusedPane,n=We.default.draggingToOutline.get();if(We.default.isDragging)r.default.preventAndStop(i),this.isEditable.set(!1);else if(r.default.hasClass(i.target,"prefixTask"))a.supportCompleting&&(r.default.vmMain.beginCompleteAction(),this.isComplete(!this.isComplete(),ChangeType.Local),r.default.vmMain.endCompleteAction());else if(nn.isInMultiselect()){var o;if(ct.a.toggleSelected(e),this.isNote()?o=e-1:this.hasNote()&&(o=e+1),!isNaN(o)){var d=ct.a.isSelected(e,a);ct.a.toggleSelected(o,a,d)}}else if(n)n.pane.moveItem(n.item,this),We.default.stopDraggingToOutline();else if(r.default.hasClass("blockCollapser"))t.block.toggleCollapsed();else if(i.clientX<a.getPaddingForPaneObject(t))a.handleLeftSideTap(t,i),r.default.preventAndStop(i);else if(r.default.hasClass(i.target,"link")&&!r.default.isKeyboardOpen){var u=i.target.getAttribute("data-href");r.default.openUrl(u,i),r.default.preventAndStop(i)}else{if("SPAN"===i.target.tagName&&r.default.hasClass(i.target,"itemDataPageLoad"))this.notifyPaginationUpdate();else if((r.default.hasClass(i.target,"tag")||r.default.hasClass(i.target,"date")||r.default.hasClass(i.target,"duration"))&&!r.default.isKeyboardOpen){var c=i.target.textContent,h=p.a.mac&&i.metaKey||!p.a.mac&&i.ctrlKey,f=i.altKey;if((h||f)&&(M.a.reset(),ct.a.reset()),h)a.search.toggleText(c,i.shiftKey);else if(f){y.a.beginAction(),r.default.vmMain.beginUpdateItems();var g=this.getRawText();r.default.hasClass(i.target,"date")||r.default.hasClass(i.target,"duration")?this.setDateDuration("",""):(g=g.replace(new RegExp(c,"g"),"").replace(/  +/g," "),this.setText(g,!0,ChangeType.Local)),r.default.vmMain.commitUpdateItems(),y.a.endAction()}r.default.preventAndStop(i)}else if(r.default.hasClass(i.target,"contact")&&!r.default.isKeyboardOpen){if(p.a.mac&&i.metaKey||!p.a.mac&&i.ctrlKey){M.a.reset();var m=i.target.textContent;i.shiftKey?a.search.setValue(m):a.search.addToValue(m)}else if(!r.default.isKeyboardOpen){var v=i.target.textContent,_=s.default.contactManager.findMatchExact(v[0]===l.a.ContactPrefix?v.substr(1):v);_&&r.default.menus.openContextMenu({componentName:"ReactContextMenuContactDetails",position:"bottom",element:i.target,contact:_})}r.default.preventAndStop(i)}else{if(r.default.vmMain.pluginManager.handleTapClick(this,a,i))r.default.preventAndStop(i);else{oe.a.hide();var S=document.activeElement,w=a.getScrollOffset(),I=Math.abs(w-r.default.scrollAtTouchStart)>0;if(this.allowTextEditing()){if(a.isWriteable&&!I){var b,A=this;if(p.a.ios&&this.isEditable.set(!0),this===a.getItem())A=a.getLastItem(),b=A.getParsedText().length;else if(r.default.getElementParent(i.target))if(i.clientX<this.getPadding(a))b=0;else{var D=an.default.getSelectOffsetsForMouseEvent(i);b=D?D.start:0}else b=A.getParsedText().length;p.a.android&&this.isEditable.set(!0),r.default.Assert(A,"Click on undefined item should not happen");r.default.isKeyboardOpen&&S&&!r.default.findParentID(S,"search")||r.default.openKeyboardOnIndex(i,a,e,function(){a.setFocused(!0),M.a.selectIndex(e,b)},function(){}),M.a.selectIndex(e,b),setTimeout(function(){ct.a.setSelected([e],a)},100)}}else i.preventDefault()}}}},onEnd:function(e){g.a.isListening("touchHoldTimeout",this.onTouchHoldTimeout)&&g.a.unlisten("touchHoldTimeout",this.onTouchHoldTimeout),this.checkDragOnEnd(e),r.default.itemMenuOpenedOn===this&&r.default.menus.menuItemSelected(e.target),nn.isInMultiselect()&&(r.default.preventAndStop(e),e.returnFalse=!0),this.isLoupeOpen=!1,r.default.vmMain.updateCursorFromEvent(e)},onCancel:function(e){We.default.isDragging&&this.dragEnd(e)},openItemMenu:function(e){r.default.menus.openContextMenu({componentName:"ReactContextMenuItem",key:"menu"+this.id+e.clientX+e.clientY,element:e.target,item:this,pane:r.default.focusedPane,pos:{left:e.pageX,top:e.pageY}})},onRightClick:function(e,t){this.openItemMenu(t),t.preventDefault(),t.stopPropagation()},onDoubleClick:function(e,t){r.default.focusedPane},onAutocompleteTapped:function(e,t,i){r.default.Assert(i,"Must be tracking the current AC tag");var a=this.getParsedText(),n=M.a.getStartOffset()-i.length,s=a.substr(0,n)+e+a.substr(M.a.getStartOffset()+1);M.a.getPane().focus(),this.setText(s,!0,ChangeType.Local),M.a.selectIndex(M.a.getStartIndex(),n+t)}},rn=i(25),on={_runAndGetSaveData:function(e,t,i){if(r.default.Assert(t,"We do not support deferred text paring"),this.shouldSave())var a=this.getMetaTextSaveData();if(this.setRawText(this.generateSaveText(e)),this.parseText(t,i),this.shouldSave()){var n=this.getMetaTextSaveData(),s={};for(var o in n)a[o]!==n[o]&&(s[o]=n[o])}return s},setText:function(e,t,i){r.default.Assert(r.default.isLocalChange(i)||!e||e.indexOf(window.AttachChar)<0,"Should never be setting text with an attach char in it"),r.default.Assert(this.isNote()||!e||e.indexOf("\n")<0,"Non-notes should never have newlines"),r.default.Assert(!e||r.default.isRemoteChange(i)||e.indexOf(window.TextSpace)<0,"Should never insert text space into item when editing locally"),i|=ChangeType.Text;var a=this.isPrefixHeader();!this.isNote()&&e&&e.indexOf("\n")>=0&&(e=e.replace(/\n/g," ")),this.isInitialized&&V.default.clearCacheForItem(this.id),rn.a.beginBatch(this);var n=this._runAndGetSaveData(e,t,i);if(this.shouldSave()){n.text=this.generateSaveText(e);var s={dateText:this.getDateText(),durationText:this.getDurationText()};h.a.saveItem(this,n,i,SaveFlag.Text,s)}this.isPrefixHeader()!==a&&rn.a.itemFontChanged(this),rn.a.commitBatch(this)},metricsInPane:function(e,t){var i;try{var a=t>=0&&M.a.isSelected(t,e),n=e.objectAtIndex(t);i=e.getMetricsForPaneObject(n,!1,a)}catch(e){r.default.reportError(e)}return i},sizeInPane:function(e,t,i){if(i)return l.a.OverviewItemHeightMobile;if(this.isNote()){var a=e.objectAtIndex(t);return V.default.lineItemHeight(a,this,e,1)}var n=e.objectAtIndex(t),s=this.metricsInPane(e,t).height;return this.shouldShowParents(n,e)&&(s+=l.a.HeightAgendaParents),s},shouldShowParents:function(e,t){return t.type===PaneMode.Task&&e.item&&!t.isSearchedFlat()&&(t.isViewTag()||t.isViewAgenda()||t.isViewContact()||t.isViewPriority())&&!e.item.isNote()&&0===e.levelsDeep&&e.item.parent()!==t.getItem()},generateExportText:function(e,t){return void 0!==e&&null!==e?this._generateUsableText(e,"getExportString",t):null},generateSaveText:function(e,t){return void 0!==e&&null!==e?this._generateUsableText(e,"getEmbedString",t):null},generateTitleText:function(e){var t="";if(e&&!this.parent())return e.titleOfFirstItem();if(e&&this.els&&this.els.length>0)for(var i=0,a=0;a<this.els.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=this.els[a];n.hasClass("mdMarkup")||n.hasClass("itemPrefix")||(t+=r.default.unescape(n.getUnstyledText(e)))}else t=this.getParsedTextWithoutPrefix();return(this.hasAttachments()?this._generateUsableText(t,"getTitleString").replace(/[\*_]/g,""):t).trim()},_generateUsableText:function(e,t,i){r.default.Assert(this.hasAttachments()||e.indexOf(window.AttachChar)<0,"Should either have attachments or no embedded attachment chars");var a=e;if(this.hasAttachments()&&e.indexOf(window.AttachChar)>=0){var n=i||0,s=this.getNumAttachments();a=e.replace(/\u2000/g,function(){if(n<s){var e=this.getAttachment(n);return n++,e.isLoaded()?e[t]():""}return r.default.Assert(!1,"Unable to find valid attachment for AttachChar"),""}.bind(this)),r.default.Assert(a.indexOf(window.AttachChar)<0,"Should convert all attachments to their string form")}return a},splitUsableText:function(e,t,i){r.default.Assert(this.hasAttachments()||e.indexOf(window.AttachChar)<0,"Should either have attachments or no embedded attachment chars");var a=e.substring(0,t)+e.substring(i),n=t;if(this.hasAttachments()&&e.indexOf(window.AttachChar)>=0){var s=0,o=this.getNumAttachments();a=e.replace(/\u2000/g,function(e,i){if(s<o){var a=this.getAttachment(s);s++;var r=a.getEmbedString();return i<t&&(n+=Math.max(r.length-1,0)),r}return window.AttachChar}.bind(this)),r.default.Assert(a.indexOf(window.AttachChar)<0,"Should convert all attachments to their string form")}return{before:a.substring(0,n),after:a.substring(n)}},parseText:function(e,t,i){var a;if(r.default.Assert(!this.isDestroyed(),"Must not parse a destroyed VMLI"),r.default.Assert(e,"Currently we only support immediate parsing"),r.default.Assert(r.default.isValidChangeType(t),"Must specify a valid changetype"),this.__TEMP_ParseCalled=!0,e){if(this.isNote())a=q.a.parseNote(this);else{var n=this.getParser();if(r.default.Assert(n,"Must be able to get valid parse function for item"),!n)return;a=n(this,t)}r.default.isFlagSet(t,ChangeType.Local)&&a.numContacts>0&&y.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.AddContact,data:[{itemID:this.id}]})}else r.default.Assert(!1,"Should always be using immediate parse");var s=this.isPrefixNumList(),o=this.styleText(a,e,t,i);return this.itemChanged.notify(),this.isInitialized&&this.isPrefixNumList()!==s&&g.a.fireEvent("numListChanged",[]),o},styleText:function(e,t,i,a){r.default.Assert(t,"Currently we only support full parses"),r.default.Assert(r.default.isValidChangeType(i),"Must specify a valid changetype"),r.default.Assert(!(!e&&t),"In a full parse, styleInfo should always be defined");var n=!1,s=!1,o=[];if(e){if(this.prefix=e.prefix,e.attachments||this.hasAttachments()){for(var l=0,d=[],u=0;e.attachments&&u<e.attachments.length;++u){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;var c=r.default.vmMain.pluginManager.getAttachment(e.attachments[u]);c&&(d.push(c),r.default.isLocalChange(i)&&!c.getOldID()&&o.push(c))}s=!0,this.setAttachments(d,i,!1)}if(t&&this.setParsedText(e.parsedText),r.default.Assert(e.els||r.default.isFlagSet(i,ChangeType.ItemLoad),"Must always return an els list"),e.els&&(this.els=e.els),this.prefix&&y.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.SetPrefix,data:{itemID:this.id,prefix:this.prefix}}),e.dates){var h=0;0===e.dates.length&&(this.date()||this.repeatDate())&&(this.setDateText(void 0),this.setDurationText(void 0),this.repeatDate()&&!this.isForceCompleted()&&(this.dateCompleted=void 0,a&&(n=!0,a.dateCompleted=void 0)),this.setDateFormat(void 0),this.date(null,i),this.setRepeatDate(null,i),this.setDuration(0,i),a&&(n=!0,a.date=void 0,a.dateText=void 0,a.dateFormat=void 0,a.repeatDate=void 0,a.duration=void 0,a.durationText=void 0));for(u=0;u<e.dates.length;++u){if(h++>5e3&&__infLoop&&__infLoop(h))throw new RangeError;var f=e.dates[u];if(f.type===DateType.Once){var p=this.getDateText()!==f.origText;p&&(this.setDateText(f.origText),a&&(n=!0,a.dateText=f.origText)),!p&&this.getDateText()&&r.default.isDateSoft(this.getDateText())||f.date&&this.date()&&f.date==this.date()||(!!f.date^!!this.date()||f.dateFormat!==this.getDateFormat()||this.date()&&f.date.getTime()!==this.date().getTime())&&(this.setDateFormat(f.dateFormat),this.date(f.date,i),a&&(n=!0,a.date=f.date?f.date.getTime():void 0,a.dateFormat=f.dateFormat)),this.repeatDate()&&(this.setRepeatDate(null,i),a&&(n=!0,a.repeatDate=void 0))}else if(f.type===DateType.Repeat){var g=f.oldText||f.text;this.getDateText()!==g&&(this.setDateText(g),a&&(n=!0,a.dateText=g));var m=new Gi(f);m.isValid()?(!this.repeatDate()||f.dateFormat!==this.getDateFormat()||!m.equals(this.repeatDate())||!!m^!!this.repeatDate())&&((!m||this.repeatDate()&&!this.repeatDate().getStartDate().equals(m.getStartDate()))&&(this.isForceCompleted()||(this.dateCompleted=void 0,a&&(n=!0,a.dateCompleted=void 0))),this.setDateFormat(f.dateFormat),this.setRepeatDate(m,i),a&&(n=!0,a.repeatDate=m.toString())):r.default.reportError(new Error("Local invalid repeat date: "+f)),this.date()&&(this.date(null,i),a&&(n=!0,a.date=void 0))}}}else(this.date()||this.repeatDate())&&t&&(this.setDateText(void 0),this.setDurationText(void 0),this.repeatDate()&&!this.isForceCompleted()&&(this.dateCompleted=void 0,a&&(n=!0,a.dateCompleted=void 0)),this.setDateFormat(void 0),this.date(null,i),this.setRepeatDate(null,i),this.setDuration(0,i),a&&(n=!0,a.date=void 0,a.dateText=void 0,a.dateFormat=void 0,a.repeatDate=void 0,a.duration=void 0,a.durationText=void 0));if(e.durations&&e.durations.length>0){var v=0;for(u=0;u<e.durations.length;++u){if(v++>5e3&&__infLoop&&__infLoop(v))throw new RangeError;var _=e.durations[u];this.setDuration(_.duration,i),this.setDurationText(_.durationText)}}else this.getDuration()>0&&(this.setDuration(0,i),this.setDurationText(void 0),a&&(n=!0,a.duration=void 0,a.durationText=void 0));(e.tags||this._activeTags)&&this.setTags(e.tags,i),(e.contacts||this._activeContacts)&&this.setContacts(e.contacts,i)}if(o.length>0){var S=0;for(u=0;u<o.length;u++){if(S++>5e3&&__infLoop&&__infLoop(S))throw new RangeError;o[u].notifyItemTextChanged(this,!1)}}if(r.default.isLocalChange(i)&&this.isNote()&&this.parent().hasAttachments()){var w=0,I=this.parent().getAttachments();for(u=0;u<I.length;++u){if(w++>5e3&&__infLoop&&__infLoop(w))throw new RangeError;I[u].notifyItemNoteChanged(this)}}return s&&this.itemChanged.notify(),n},getCalendarRawText:function(){return this.getRawText().replace(this.getItemDateString(),"").replace(/^ +/g,"").replace(/ +$/g,"")},getCalendarParsedText:function(){var e;this.hasAttachmentType(l.a.PluginType.Email)?e=this.getAttachmentByType(l.a.PluginType.Email).getField("subject"):e=this.getParsedTextWithoutPrefix().replace(this.getItemDateString(),"").replace(/\u2000/g,"");return e.trim()},getStyledTextAsOneLine:function(e,t){var i;return t&&(i='<span class="numChildren c-foreground-super-faded">'+this.numItems()+"</span>"),q.a.generateHTML(this.els,{convertSpaces:!1,noPrefix:e,suffix:i})},hasText:function(){var e=this.getParsedText();return this.getDateText()&&(e=e.replace(l.a.DatePrefix+this.getDateText(),"")),(e=e.replace(/ /g,"")).length>0},setPrefix:function(e){var t=this.getRawText(),i=this.getPrefix();i&&(t=t.substr(i.length)),this.prefix=e,t=(e?e+" ":"")+t,this.setText(t,!0,ChangeType.Local)},getPrefix:function(){return this.prefix?this.prefix+" ":""},getPrefixLength:function(){return this.prefix?this.prefix.length+1:0},isPrefixHeader:function(e){var t;return e&&(t=e.search.getItemPrefix(this)),void 0===t&&(t=this.prefix),t&&(t[0]===l.a.Prefix.Header||t[0]===l.a.Prefix.Header2)},isPrefixTask:function(){return this.prefix&&r.default.isPrefixTask(this.prefix)},isPrefixBullet:function(){return this.prefix&&this.prefix===l.a.Prefix.Bullet||this.prefix===l.a.Prefix.Bullet2||this.prefix===l.a.Prefix.Bullet3},isPrefixNumList:function(){return this.prefix&&this.prefix[0]>=0&&this.prefix[0]<10},hasPrefix:function(){return!!this.prefix},numListNumber:function(){if(this.isPrefixNumList()){for(var e=0,t=1,i=this.parent(),a=this.getIndex()-1;a>=0;--a,++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var n=i.getChild(a);if(!n||!n.isPrefixNumList())break}return t}},shouldCopyPrefix:function(){return this.isPrefixTask()||this.isPrefixBullet()||this.isPrefixNumList()},getParsedTextWithoutPrefix:function(){var e=this.getPrefix(),t=this.getParsedText();return e?t.substr(e.length):t},applyFormatToSelection:function(e,t,i,a){var n,s,r,o=0,d=0,u=this.getParsedText(),c=t,h=i,f=!1;for(t===i&&(t=0,i=u.length),t<this.getPrefixLength()&&(t=this.getPrefixLength()),i<this.getPrefixLength()&&(i=this.getPrefixLength()),r=t;r>=Math.max(t-e.length,0);r--){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;if(u.substr(r,e.length)===e){n=r;break}}for(r=i-e.length;r<=i;r++){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;if(u.substr(r,e.length)===e){s=r;break}}return isNaN(n)||isNaN(s)||a===l.a.SetMode.Yes?a!==l.a.SetMode.No&&(c+=e.length,h+=e.length,u=u.substr(0,t)+e+u.substr(t,i-t)+e+u.substr(i),f=!0):(c-=e.length,h-=e.length,u=u.substr(0,n)+u.substr(n+e.length,s-n-e.length)+u.substr(s+e.length)),this.setText(u,!0,ChangeType.Local),{didSet:f,selStart:c,selEnd:h}},insertLinkAtSelection:function(){var e=M.a.getStartIndex();if(M.a.isValid()&&e===M.a.getEndIndex()){var t,i=M.a.getStartOffset(),a=M.a.getEndOffset(),n=this.getRawText();if(i!==a)t=n.substr(i,a-i);else if(i>0&&a<n.length){for(var s,o,l=0,d=this.getEls(),u=0,c=-1,h=0;h<d.length;h++){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;if(d[h].hasClass("mdMarkupStart")&&"["===d[h].getParsedText())c=u;else if(d[h].hasClass("mdMarkupEnd")&&")"===d[h].getParsedText()&&c>=0){var f=u+d[h].getOrigTextLength();if(i>=c&&a<=f){s=c,o=f;break}c=-1}u+=d[h].getOrigTextLength()}s||o||" "===n[i-1]||" "===n[i]||(s=n.prevIndexOf(" ",i)+1,(o=n.indexOf(" ",a))<0&&(o=n.length)),isNaN(s)||isNaN(o)||s===i||o===a||(t=n.substr(s,o-s),M.a.selectIndices(e,s,e,o))}r.default.menus.openContextMenu({componentName:"ReactContextMenuInsertLink",element:M.a.getEndElement(),onInsertLink:this.onInsertLink,text:t})}},onInsertLink:function(e,t){if(M.a.isValid()&&M.a.getStartIndex()===M.a.getEndIndex()){t&&!e.text&&(e.text=e.url);var i=M.a.getStartOffset(),a=M.a.getEndOffset(),n=this.getRawText(),s=n.substr(i,a-i),r=e.url?e.text?(t?"!":"")+"["+e.text+"]("+e.url+")":e.url:e.text,o=a+r.length-s.length;n=n.substr(0,i)+r+n.substr(a),this.setText(n,!0,ChangeType.Local),M.a.selectIndex(M.a.getStartIndex(),o)}},getTextLength:function(){return this.getParsedText().length},getNotePreviewText:function(){var e=this.getParsedText();if(e){var t=(e=e.substr(0,Math.min(e.length,400))).match(/[^\r\n]+/);if(t){for(var i=0,a=(e=t[0]).split(/<\/?(?:div|p|br)[^>]*>\s*/im),n=0;n<a.length;n++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(a[n]){var s=document.createElement("div");if(s.innerHTML=a[n],e=r.default.escape(s.textContent||s.innerText))break}}e=e.substr(0,Math.min(e.length,200))}}return e}},ln=function(e){function t(e,a){var n,o=0;if(a)for(var l=0;l<a.length;++l){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var d=a.get(l);if(r.default.Assert(d,"Item must exist to get it from the array"),d&&d.id){v.a.setItemParent(d,e);var u=s.default.getModel(d.id);u?u.linkToGDrive(d):(n=d,v.a.cacheItem(n),i(n,v.a.get(n,"note")),t(n,v.a.get(n,"items")),t(n,v.a.get(n,"archivedItems")))}else{if(d)try{r.default.reportError(new Error("Item in list without defined ID: "+r.default.getObjectInfo(d)+" : "+JSON.stringify(d)))}catch(e){r.default.reportError(e)}else r.default.reportError(new Error("Removing undefined/null value form remote list"));a.remove(l),l--}}}function i(e,t){if(t){v.a.setItemParent(t,e);var i=s.default.getModel(t.id);i?i.linkToGDrive(t):v.a.cacheItem(t)}}return{changeTypeFromEvent:function(e){var t;return this.isLocalEvent(e)?(t=ChangeType.Local,y.a.undoRedoActive&&(t|=ChangeType.UndoRedo)):t=ChangeType.Remote,t},linkToGDrive:function(e,a){r.default.Assert(e,"Must be passing in valid data"),this.data||(e&&(r.default.Assert(void 0===e.connectIdentifier,"Should never have a connect identifier present during link"),e.connectIdentifier=v.a.connectIdentifier(),this.data=e,v.a.cacheItem(e)),this.setRemoteVersion(VersionType.Structure,v.a.getVersion(e,VersionType.Structure)),this.setRemoteVersion(VersionType.Text,v.a.getVersion(e,VersionType.Text)),a&&(this.setVersion(VersionType.Structure,this.getRemoteVersion(VersionType.Structure)),this.setVersion(VersionType.Text,this.getRemoteVersion(VersionType.Text))),r.default.isString(v.a.get(e,"note"))||i(e,v.a.get(e,"note")),t(e,v.a.get(e,"items")),t(e,v.a.get(e,"archivedItems")))},initFromGDrive:function(e){if(r.default.Assert(e,"To initialize from gdrive a valid remote data object must be passed in"),r.default.Assert(!y.a.undoRedoActive,"Should not be initializing new VMLIs from gdrive during undo/redo"),e){this.data=e,e.connectIdentifier?r.default.Assert(e.connectIdentifier===v.a.connectIdentifier(),"Should never have a connect identifier present during link"):e.connectIdentifier=v.a.connectIdentifier(),v.a.getItemParent(this.data)?r.default.Assert(v.a.getItemParent(this.data).id===this.parent().id,"Item parent must match"):this.parent()&&v.a.setItemParent(this.data,this.parent().data),v.a.cacheItem(this.data);var t=void 0===this.id||this.forceModifiedItems,i=t?void 0:{},a=!1;this.id=e.id;try{a=this.resolveMisc(i)||a,(a=this.resolveText(i)||a)&&r.default.vmMain.addParseItem(this,ChangeType.Remote|ChangeType.DocLoad|ChangeType.All),this.computeDisplayComplete(),this.isNote()||this.resolveItems(i)}catch(e){r.default.reportError(e)}t?(r.default.Assert(void 0===i,"If doing a full save, remoteChanges should always be undefined"),this.setVersion(VersionType.Structure,this.getRemoteVersion(VersionType.Structure)),this.setVersion(VersionType.Text,this.getRemoteVersion(VersionType.Text)),h.a.saveItemLocal(this,null,SaveFlag.None)):r.default.isEmpty(i)||(!0!==i.isDeleted&&(i.isDeleted=void 0),r.default.Assert(i.hasOwnProperty("version")||i.hasOwnProperty("versionText"),"If making remote changes, the version should have changed"),i.hasOwnProperty("version")&&this.setVersion(VersionType.Structure,i.version),i.hasOwnProperty("versionText")&&this.setVersion(VersionType.Text,i.versionText),h.a.saveItemLocal(this,i,SaveFlag.None)),v.a.attachEventsToItem(this)}else r.default.reportError(new Error("FATAL ERROR - No remote data for item"))},resolveText:function(e){var t=!1;if(this.modifiedOfflineText&&!this.forceModifiedItems)if(this.isLocalVersionNewer(VersionType.Text))h.a.saveItemRemote(this,{text:this.getRawText()});else{var i=v.a.get(this.data,"text");r.default.Assert(void 0!==i,"Every item should have text associated with it from gdrive");var a=!1;if(this.getRawText()!==i&&(a=!0),a)if(this.isNote())this.setText(i,!0,ChangeType.Remote|ChangeType.DocLoad|ChangeType.Text),r.default.vmMain.addModifiedItem(this,ChangeType.Remote|ChangeType.DocLoad|ChangeType.Text),e&&(e.text=this.getRawText(),e.modifiedOfflineText=!1);else{var n=this.getIndex(),o=s.default.createVMLI({text:this.getRawText()},{parent:this.parent(),changeType:ChangeType.Local|ChangeType.DocLoad});this.parent().insertItem(o,n+1),this.setText(i,!0,ChangeType.Remote|ChangeType.DocLoad),r.default.vmMain.addModifiedItem(this,ChangeType.Remote|ChangeType.Text|ChangeType.DocLoad),e&&(e.text=this.getRawText(),e.dateText=this.getDateText(),e.dateFormat=this.getDateFormat(),e.durationText=this.getDurationText())}else e&&(e.modifiedOfflineText=!1);e&&(e.versionText=this.getRemoteVersion(VersionType.Text),r.default.vmMain.addModifiedItem(this,ChangeType.Remote|ChangeType.Text|ChangeType.DocLoad,e))}else this.isRemoteVersionNewer(VersionType.Text)&&(i=v.a.get(this.data,"text"),r.default.Assert(void 0!==i,"Every item should have text associated with it from gdrive"),this.getRawText()!==i&&(this.setText(i,!0,ChangeType.Remote|ChangeType.DocLoad),e&&(e.text=this.getRawText(),e.dateText=this.getDateText(),e.dateFormat=this.getDateFormat(),e.durationText=this.getDurationText()),this.isVersionUninitialized(VersionType.Text)||(t=!0)),e&&this.getVersion(VersionType.Text)!==this.getRemoteVersion(VersionType.Text)&&(e.versionText=this.getRemoteVersion(VersionType.Text),r.default.vmMain.addModifiedItem(this,ChangeType.Remote|ChangeType.Text|ChangeType.DocLoad,e)));return t},resolveMisc:function(e){var t=this.modifiedOfflineText&&this.isLocalVersionNewer(VersionType.Text),i=!1,a=!1;if(t||this.isRemoteVersionNewer(VersionType.Structure)||this.isRemoteVersionNewer(VersionType.Text)){var n={},s=v.a.get(this.data,"dateFormat");(s||this.getDateFormat())&&this.getDateFormat()!==s&&(t?(n.dateFormat=this.getDateFormat(),a=!0):(this.setDateFormat(s,ChangeType.Remote|ChangeType.Property|ChangeType.DocLoad),e&&(e.dateFormat=this.getDateFormat())));var o=v.a.get(this.data,"date");if((o||this.date())&&(!this.date()||this.date().getTime()!==o))if(t&&this.date())n.date=this.date().getTime(),a=!0;else{if(o){var l=new Date(o);this.date(l,ChangeType.Remote|ChangeType.Property|ChangeType.DocLoad)}else this.date(null,ChangeType.Remote|ChangeType.Property|ChangeType.DocLoad);e&&(e.date=this.getDateTime()),this.isVersionUninitialized(VersionType.Text)||(i=!0)}var d=v.a.get(this.data,"dateCompleted");if((d||this.dateCompleted)&&(!this.dateCompleted||!d||this.dateCompleted.getTime()!==d))if(t)n.dateCompleted=this.dateCompleted?this.dateCompleted.getTime():void 0,a=!0;else{var u=d;r.default.Assert("string"!=typeof d,"Invalid date format stored"),this.dateCompleted=new Date(u),e&&(e.dateCompleted=u)}var c=v.a.get(this.data,"repeatDate");if((c||this.repeatDate())&&(!this.repeatDate()||!this.repeatDate().equals(c)))if(t&&this.repeatDate())n.repeatDate=this.repeatDate().toString(),a=!0;else{if(c){var f=new Gi(c);f.isValid()?this.setRepeatDate(f,ChangeType.Remote|ChangeType.Property|ChangeType.DocLoad):r.default.reportError(new Error("Remote init invalid repeat date: "+c))}else this.setRepeatDate(null,ChangeType.Remote|ChangeType.Property|ChangeType.DocLoad);e&&(e.repeatDate=this.getRepeatDateString()),this.isVersionUninitialized(VersionType.Text)||(i=!0)}var p=v.a.get(this.data,"dateCreated");this.dateCreated&&p&&this.dateCreated.getTime()===p||(t?(n.dateCreated=this.dateCreated?this.dateCreated.getTime():void 0,a=!0):(u=p,r.default.Assert("string"!=typeof p,"Invalid date format stored"),this.dateCreated=new Date(u),e&&(e.dateCreated=u)));var g=v.a.get(this.data,"priority");(g||this.priority())&&this.priority()!==g&&(t?(n.priority=this.priority(),a=!0):(null===g&&(g=VMLIFlag.None),this.priority(g,ChangeType.Remote|ChangeType.Property|ChangeType.DocLoad)));var m=v.a.get(this.data,"isStarred");(m||this.isStarred())&&this.isStarred()!==m&&(t?(n.isStarred=this.isStarred(),a=!0):(null===m&&(m=!1),this.isStarred(m,ChangeType.Remote|ChangeType.Property|ChangeType.DocLoad)));var _=v.a.get(this.data,"isComplete");(_||this.isComplete())&&this.isComplete()!==_&&(t?(n.isComplete=this.isComplete(),a=!0):(null===_&&(_=!1),this.isComplete(_,ChangeType.Remote|ChangeType.Property|ChangeType.DocLoad)));var y=v.a.get(this.data,"favorites");(y||this.getFavorites())&&y!=this.getFavorites()&&(t?(n.favorites=this.getFavorites(),a=!0):(null===y&&(y=void 0),this.setFavorites(y,ChangeType.Remote|ChangeType.Property|ChangeType.DocLoad))),t&&(r.default.Assert(a===!r.default.isEmpty(n),"Verify modLocal is computed properly. It should track any changes to localChanges"),!0===a&&h.a.saveItemRemote(this,n))}return i},resolveNote:function(e){var t=v.a.get(this.data,"note"),i=this.hasNote()?this.getNote():void 0;if(t)if(i)i.initFromGDrive(t);else{var a=s.default.getItem(t.id);a?a.isDeleted&&(r.default.Assert(r.default.isReconnected||!i,"The local model should never exist when an item has been marked as deleted locally"),r.default.Assert(a.modifiedOffline,"How did the note get deleted if it wasn't modified offline?"),v.a.getVersion(t,VersionType.Structure)==a.version?v.a.noteSet(this,void 0):(i=s.default.createVMLI({data:t,isNote:!0},{parent:this,changeType:ChangeType.Remote|ChangeType.DocLoad}),s.default.undeleteItem(i,ChangeType.AllRemote|ChangeType.DocLoad),this.setNote(i,ChangeType.AllRemote|ChangeType.DocLoad),r.default.vmMain.addModifiedItem(i,ChangeType.AllRemote|ChangeType.DocLoad))):(i=s.default.createVMLI({data:t,isNote:!0},{parent:this,changeType:ChangeType.Remote|ChangeType.DocLoad}),this.setNote(i,ChangeType.AllRemote),r.default.vmMain.addModifiedItem(i,ChangeType.AllRemote|ChangeType.DocLoad))}else i&&(s.default.initializeItem(i),v.a.noteSet(this,i))},resolveItemsHelper:function(e,t){var i,a,n,o,l,d=0,u=v.a.getItemList(this.data,e);for(l=e?this.hasArchivedChildren()?this.archivedItems(!0):[]:this.getItems(),r.default.Assert(l,"Item arrays must exist"),i=0;u&&i<u.length;i++){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;(a=u.get(i))?(r.default.Assert(void 0===v.a.loadSeen[a.id]||!1===v.a.loadSeen[a.id],"Items can only be seen once on the remote."),v.a.loadSeen[a.id]=this.id,(k=this.getIndexOf(a.id,e))>=0?(n=l[k]).initFromGDrive(a):(F=s.default.getItem(a.id),n=s.default.getModel(a.id),F?F.isDeleted?(r.default.Assert(F.modifiedOffline,"How did the item get deleted if it wasn't modified offline?"),v.a.getVersion(a,VersionType.Structure)==F.version?(v.a.itemRemoved({item:this,index:i,numToRemove:1,isArchived:e}),i--):(n?(r.default.Assert(void 0===n.parent(),"Should never have a parent if deleted"),r.default.Assert(n.data===a,"Local model should match remote data"),n.parent(this)):n=s.default.createVMLI({data:a,isArchived:e},{parent:this,changeType:ChangeType.Remote|ChangeType.DocLoad}),s.default.undeleteItem(n,ChangeType.Remote|ChangeType.DocLoad),l.splice(i,0,n),o=!0,r.default.vmMain.addModifiedItem(n,ChangeType.Remote|ChangeType.Structure|ChangeType.DocLoad))):n&&n.modifiedOffline?n.isLocalVersionNewer(VersionType.Structure)?(r.default.Assert(v.a.loadSeen[a.id]===this.id),v.a.loadSeen[a.id]=!1):(n.moveTo({parent:this,index:i,shouldBeArchived:e},ChangeType.Remote|ChangeType.DocLoad),n.initFromGDrive(a),o=!0,r.default.vmMain.addModifiedItem(n,ChangeType.Remote|ChangeType.Structure|ChangeType.DocLoad)):n?(n.moveTo({parent:this,index:i,shouldBeArchived:e},ChangeType.Remote|ChangeType.DocLoad),n.initFromGDrive(a),o=!0,r.default.vmMain.addModifiedItem(n,ChangeType.Remote|ChangeType.Structure|ChangeType.DocLoad)):r.default.reportError(new Error("Local model does not exist for local item that was not deleted.")):(r.default.Assert(!n,"The local model should never exist if there is no corresponding item entry"),n=s.default.createVMLI({data:a,isArchived:e},{parent:this,changeType:ChangeType.Remote|ChangeType.DocLoad}),l.splice(i,0,n),o=!0,r.default.vmMain.addModifiedItem(n,ChangeType.AllRemote|ChangeType.DocLoad)))):r.default.Assert(a,"Item in remote list does not exist")}if(s.default.hasLocalData){var c=0;for(i=0;i<l.length;i++){if(c++>5e3&&__infLoop&&__infLoop(c))throw new RangeError;if(n=l[i],v.a.loadSeen[n.id]!==this.id)if(a=n.data){if(n.modifiedOffline&&n.isLocalVersionNewer(VersionType.Structure)){if(y=v.a.findInTree(a))v.a.itemMoved({item:n,newInfo:{index:i,isArchived:e},oldParent:y.parent,oldInfo:y});else{var h=v.a.getDeletedCacheItem(a.id);h&&(r.default.Assert(!v.a.getItemParent(h),"Deleted items should never have parents"),v.a.restoreDeletedItem(a.id),v.a.itemAdded({item:this,addedItem:a,index:i,isArchived:e}))}n.initFromGDrive(a)}}else if(n.modifiedOfflineText){var f,p=0,g=[];if(e?n.hasArchivedChildren()&&(f=n.archivedItems(!0)):f=n.getItems(),f)for(var m=0,_=0;_<f.length;++_){if(m++>5e3&&__infLoop&&__infLoop(m))throw new RangeError;if(f[_].data&&f[_].isLocalVersionNewer(VersionType.Structure)){var y=v.a.findInTree(f[_].data);r.default.Assert(y,"Item should be found in tree"),y&&g.push({parent:y.parent,child:f[_]})}}for(s.default.initializeItem(n),v.a.itemAdded({item:this,addedItem:n,index:i,isArchived:e}),_=0;_<g.length;++_){if(p++>5e3&&__infLoop&&__infLoop(p))throw new RangeError;var S=g[_];r.default.Assert(S,"Must have valid data to remove");var w=S.child.isArchived(),I=v.a.getItemList(S.parent,w);r.default.Assert(I,"The item has children, it must have a list");var b=I.indexOf(S.child.data);r.default.Assert(b>=0,"Remote item must be in the parents list"),v.a.itemRemoved({item:S.parent,index:b,numToRemove:1,isArchived:w})}n.initFromGDrive(n.data)}else r.default.Assert(s.default.getItem(n.id),"Trying to delete an item locally that doesn't exist locally"),this.deleteChild(n,void 0,void 0,ChangeType.Remote|ChangeType.DocLoad),i--,o=!0,r.default.vmMain.addModifiedItem(n,ChangeType.Remote|ChangeType.Structure|ChangeType.DocLoad)}if(!e&&u&&(u.length>0||l.length>0)){var A,D=0,T=[],M=[],C=u.asArray(),L=!1;for(i=0;i<C.length;++i){if(D++>5e3&&__infLoop&&__infLoop(D))throw new RangeError;var P=C[i].id;P||r.default.Assert(P,"Item in list without an ID defined: "+JSON.stringify(C[i]));var E=s.default.getModel(P);r.default.Assert(E,"If the remote ID exists the local item should have been created.");var k=this.getIndexOf(P);E&&E.modifiedOffline&&E.isLocalVersionNewer(VersionType.Structure)?k>=0?T.push(k):(A||(A=[]),log(this.id+": Item in remote array not found in local array: ",P),A.push(P)):k>=0?(M.push(P),k!==i&&(L=!0)):(A||(A=[]),log(this.id+": Item in remote array not found in local array: ",P),A.push(P))}if(L||T.length>0){var x=0,R=0,O=0;for(T.sort(r.default.numberComparator),i=0;i<T.length;i++){if(x++>5e3&&__infLoop&&__infLoop(x))throw new RangeError;var F;(F=l[T[i]])&&M.splice(T[i],0,F.id)}for(A&&A.length>0&&(M=M.concat(A)),i=0;i<M.length;++i){var N=0;if(R++>5e3&&__infLoop&&__infLoop(R))throw new RangeError;var B=M[i];for(_=i;_<u.length;++_){if(N++>5e3&&__infLoop&&__infLoop(N))throw new RangeError;if(B===(z=u.get(_)).id){if(i!==_){var U=s.default.getModel(z.id),V={index:_,isArchived:!1},H={index:i,isArchived:!1};v.a.itemMoved({item:U,newInfo:H,oldParent:this,oldInfo:V}),o=!0,r.default.vmMain.addModifiedItem(U,ChangeType.Remote|ChangeType.Structure)}break}}}for(i=0;i<M.length;++i){var q=0;if(O++>5e3&&__infLoop&&__infLoop(O))throw new RangeError;for(B=M[i],_=i;_<l.length;++_){if(q++>5e3&&__infLoop&&__infLoop(q))throw new RangeError;var z;if(B===(z=l[_]).id){i!==_&&(z.moveTo({parent:this,index:i,shouldBeArchived:!1},ChangeType.Remote),o=!0,r.default.vmMain.addModifiedItem(z,ChangeType.Remote|ChangeType.Structure));break}}}}}}o&&(e?this.hasArchivedChildren()&&this.archivedItems().notify():this.getItemStore().updateItems(this),e&&!this.hasArchivedChildren()&&this.archivedItems().set(l),t&&(t.items=this.getItemsArrayForSave(),t.version=this.getRemoteVersion(VersionType.Structure)))},resolveItems:function(e){r.default.Assert(!this.isNote(),"Should never resolve items on a note"),this.resolveItemsHelper(!1,e),this.resolveItemsHelper(!0,e),this.resolveNote(e)},isMoveEvent:function(e){var t=!1;return e.type===gapi.drive.realtime.EventType.VALUES_ADDED?t=void 0!==e.movedFromList&&null!==e.movedFromList:e.type===gapi.drive.realtime.EventType.VALUES_REMOVED&&(t=void 0!==e.movedToList&&null!==e.movedToList),t},isLocalEvent:function(e){var t=e.isLocal;return y.a.undoRedoActive&&r.default.Assert(t,"Must be a local event during undo/redo"),t},onValueChanged:function(e){if(!e.isLocal||y.a.undoRedoActive){var t=r.default.translateFieldOut(e.property);if(this.id===e.target.id){var i=this.changeTypeFromEvent(e)|ChangeType.Property,a=!1;switch(t){case"version":case"versionText":var n="_"+t,s=v.a.get(this.data,t);if(s>this[n]||void 0===this[n]){var o={};"version"===t?o.modifiedOffline=!1:"versionText"===t&&(o.modifiedOfflineText=!1),o[t]=this[n]=s,h.a.saveItemLocal(this,o,SaveFlag.None)}break;case"priority":this.priority(e.newValue,i);break;case"isComplete":this.isComplete(e.newValue,i);break;case"isStarred":this.isStarred(e.newValue,i);break;case"dateCompleted":this.dateCompleted=e.newValue?new Date(e.newValue):null,h.a.saveItemLocal(this,{dateCompleted:e.newValue},SaveFlag.None),a=!0;break;case"isArchived":this.isArchived(e.newValue,i),h.a.saveItemLocal(this,{isArchived:e.newValue},SaveFlag.None);break;case"dateFormat":this.setDateFormat(e.newValue),h.a.saveItemLocal(this,{dateFormat:e.newValue},SaveFlag.None);break;case"date":this.date(e.newValue?new Date(e.newValue):null,i),h.a.saveItemLocal(this,{date:e.newValue},SaveFlag.None);break;case"repeatDate":var l=e.newValue?new Gi(e.newValue):null;!l||l.isValid()?(this.setRepeatDate(l,i),h.a.saveItemLocal(this,{repeatDate:e.newValue},SaveFlag.None)):r.default.reportError(new Error("Remote invalid repeat date: "+e.newValue));break;case"allDayDate":break;case"note":e.newValue?this.addRemoteNote(e.newValue,i):this.hasNote()&&this.removeRemoteNote(i);break;case"items":case"archivedItems":var d=!("items"===t);if(e.newValue)for(var u=0,c=0;c<e.newValue.length;++c){if(u++>5e3&&__infLoop&&__infLoop(u))throw new RangeError;var f=e.newValue.get(c);this.addRemoteItem(f,c,d,i)}else r.default.Assert(0===e.oldValue.length,"Expected no items in list"),this.removeAllRemoteItems(d);h.a.saveItemLocal(this,{items:this.getItemsArrayForSave()},SaveFlag.None);break;case"dateCreated":break;case"text":this.onTextChanged(e);break;default:ShouldLog(LogLevels.Error)&&log("Unhandled value changed remotely: ",t,e)}a&&this.parseText(!0,i)}}},onTextChanged:function(e){if(!e.isLocal||y.a.undoRedoActive){var t=this.changeTypeFromEvent(e)|ChangeType.Text,i=v.a.get(this.data,"text");if(i!==this.getRawText()&&(this.setText(i,!0,t),y.a.undoRedoActive)){var a=TrackerType.SetText;y.a.notifyStateChangedFromUndoRedo(a,{itemID:this.id,position:r.default.findFirstDiff(e.newValue,e.oldValue,!1,!0),text:e.newValue})}}},addRemoteItem:function(e,t,i,a){v.a.cacheItem(e);var n=e.id,r=i?this.archivedItems():this.items,o=r.get();if(t<o.length&&o[t].id===n)log("Skipping addRemoteItem - "+t+" vs. "+o.length);else{var l=s.default.getModel(n);l||(l=s.default.createVMLI({data:e},{parent:this,changeType:a})),v.a.setItemParent(e,this.data),l.isDeleted()&&(l.isDeleted(!1,a),l.save(null,SaveFlag.None)),l.isArchived()!==i&&(l.isArchived(i,ChangeType.Remote),l.save({isArchived:i},SaveFlag.None)),l.parent(this),r.splice(t,0,l),y.a.undoRedoActive&&y.a.notifyStateChangedFromUndoRedo(TrackerType.Create,{itemID:l.id,parent:this.id,position:t,text:v.a.get(e,"text")})}},removeAllRemoteItems:function(e){var t;if(e?this.hasArchivedChildren()&&(t=this.archivedItems()).set([]):(t=this.items).set([]),t)for(var i=0,a=0;a<t.get().length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;v.a.setItemParent(t.get()[a],void 0)}},removeRemoteItem:function(e,t,i,a,n){var o;i?(r.default.Assert(this.hasArchivedChildren(),"Must have a valid item list to remove from"),o=this.archivedItems()):o=this.items;var l=o.get()[t];if(l&&l.id===e.id){if(r.default.Assert(l,"Expect a valid local item to remove"),r.default.Assert(e.id===l.id,"Remote item should match local items"),a&&(v.a.setItemParent(e,void 0),v.a.removeItemFromCache(e.id)),y.a.undoRedoActive){var d=r.default.getPreviousItem(l);y.a.notifyStateChangedFromUndoRedo(TrackerType.Delete,{itemID:l.id,parent:this.id,position:t,previous:d?d.id:void 0})}o.splice(t,1),a&&s.default.deleteItem(l,n)}},addRemoteNote:function(e,t){r.default.Assert(!this.hasNote(),"State of note should always match when adding");var i=e.id;v.a.cacheItem(e);var a=s.default.getModel(i);a||(a=s.default.createVMLI({data:e,isNote:!0},{parent:this,changeType:t})),r.default.Assert(a.isNote(),"Must always be a valid note"),a.parent(this),a.isDeleted()&&(a.isDeleted(!1,t),a.save(null,SaveFlag.None)),this.setNote(a,t)},removeRemoteNote:function(e){r.default.Assert(this.hasNote(),"State of note should always match when removing");var t=this.getNote();this.setNote(void 0,e),t.isDeleted()||s.default.deleteItem(t,e)},onListAdded:function(e){var t=0;if(!e.isLocal||y.a.undoRedoActive){v.a.numChanges++;var i=this.changeTypeFromEvent(e),a=!1,n=!0,s=v.a.get(this.data,"items");if(s&&e.target.id===s.id)n=e.target.id===s.id;else{var o=v.a.get(this.data,"archivedItems");o&&e.target.id===o.id&&(a=!0),n=o&&e.target.id===o.id}if(n){var l,d,u;e.values.length>0?(u=(d=e.index)+e.values.length,l=function(t){return e.values[t]}):(d=0,u=e.target.length,l=function(t){return e.target.get(t)}),this.isMoveEvent(e);for(var c=d;c<u;++c){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var f=l(c-d);r.default.Assert(f,"Always expect a valid item at each index"),this.addRemoteItem(f,c,a,i)}h.a.saveItemLocal(this,{items:this.getItemsArrayForSave()},SaveFlag.None),this._selectionBeforeBlur=void 0}else log("Skipping list add due to invalid target")}},onListRemoved:function(e){var t=0;if(!e.isLocal||y.a.undoRedoActive){var i=this.changeTypeFromEvent(e);v.a.numChanges++;var a=!1,n=!0,s=v.a.get(this.data,"items");if(s&&e.target.id===s.id)n=e.target.id===s.id;else{var o=v.a.get(this.data,"archivedItems");o&&e.target.id===o.id&&(a=!0),n=o&&e.target.id===o.id}if(n){for(var l=e.index,d=l+e.values.length,u=this.isMoveEvent(e),c=d-1;c>=l;c--){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var f=c-l;r.default.Assert(!!e.values[f],"Always expect a valid item at each index");var p=e.values[f];this.removeRemoteItem(p,c,a,!u,i)}h.a.saveItemLocal(this,{items:this.getItemsArrayForSave()},SaveFlag.None),this._selectionBeforeBlur=void 0}else log("Skipping list remove due to invalid target")}},onListSet:function(e){r.default.Assert(!1,"What? This shouldn't happen!",e)},onObjectChanged:function(e){var t=0;if(e.ocHandled)return ShouldLog(LogLevels.Warning|LogLevels.Verbose)&&log("Event Already Handled: ",e.ocHandled,"-",this.id,e.events[0].type),!1;if(v.a.numChanges++,e.ocHandled=this.id,e.stopPropagation(),e.isLocal&&!y.a.undoRedoActive)return!1;v.a.lastChangeTime.set(Date.now()),rn.a.beginBatch(this,!0);for(var i=0;i<e.events.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=e.events[i];if(a.ocHandled)log("Sub-Event Already Handled: ",a.ocHandled,"-",this.id,a.type);else{a.ocHandled=this.id;try{switch(a.type){case gapi.drive.realtime.EventType.TEXT_DELETED:case gapi.drive.realtime.EventType.TEXT_INSERTED:this.onTextChanged(a);break;case gapi.drive.realtime.EventType.VALUES_ADDED:this.onListAdded(a);break;case gapi.drive.realtime.EventType.VALUES_REMOVED:this.onListRemoved(a);break;case gapi.drive.realtime.EventType.VALUE_CHANGED:this.onValueChanged(a);break;case gapi.drive.realtime.EventType.VALUES_SET:r.default.Assert(!1,"VALUES_SET should never be triggered");break;default:r.default.Assert(!1,"Unexpected event type")}}catch(e){r.default.reportError(e)}}}return!1}}},dn=i(35),un=i(20),cn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};window.__TOTAL_ITEMS=0,window.__TOTAL_ARCHIVED_ITEMS=0,window.__TOTAL_ARCHIVE_PARENTS=0;var hn=new Date(9e12);function fn(e,t){this.__ISVMLI=!0,this.isInitialized=!1,r.default.Assert(t,"Each VMLI must be given a set of additional info"),r.default.Assert(r.default.isValidChangeType(t.changeType),"Must specify a valid change type when creating a VMLI"),r.default.Assert(t.store,"Must supply a valid itemStore for each VMLI"),r.default.Assert(!t.parent||t.parent._store===t.store,"All VMLIs in a tree must share the same owner"),this.__TEMP_InitCalled=!1,this.__TEMP_InitParseCalled=!1,this.__TEMP_ParseCalled=!1,this.__TEMP_SkippedInitParsed=!1,!e.id&&e.data&&e.data.id?e.id=e.data.id:e.id&&e.data&&r.default.Assert(e.id===e.data.id,"If passing in a local id and a remote ID, they should match"),r.default.Assert(void 0===e.v,"We should never be passing in 'v'"),r.default.Assert(void 0===e.extern,"We should never be passing in 'extern'"),r.default.Assert(t.store,"Must specify a valid item store this item belongs to"),this._store=t.store,this._parent=t?t.parent:void 0,this._rawText=e.data?"":e.text,this._searchText=e.data?"":e.text?e.text.toLowerCase():"",this._parsedText=void 0,this._notePreviewText=void 0,this.els=void 0,this._isArchived=e.isArchived||!1,this._numArchivedAncestors=this._parent?this._parent._numArchivedAncestors+(this._parent.isArchived()?1:0):0,this._numArchivedDescendants=0,this._isArchived&&this._notifyAncestorsArchived(!0),o.a.forceBind("itemsHasMutated",this),this.items=new k.a([],this.itemsHasMutated),this._note=void 0,this.itemChanged=new dn.a,this._archivedItems=void 0,this._demandLoadChildren=e.demandLoadChildren||!1,this._loadedOnDemandData=!this._demandLoadChildren,this._paginationToken=void 0,this._canDestroy=t.canDestroy||!1,this._destroyed=!1,this._date=void 0,this._dateFormat=e.dateFormat,this._repeatDate=void 0,this._attachments=void 0,this.draggedInPane=new w.a(!1);var i=VMLIFlag.None;e.isComplete&&(i|=VMLIFlag.Complete),e.isStarred&&(i|=VMLIFlag.Starred),e.isNote&&(i|=VMLIFlag.Note),e.isArchived&&(i|=VMLIFlag.Archived),e.priority&&(i|=e.priority),this.flags=new w.a(i),this.prefix=void 0,this._favorites=void 0,this._dateText=e.dateText,this.dateCreated=e.dateCreated?new Date(e.dateCreated):new Date,this.dateCompleted=e.dateCompleted?new Date(e.dateCompleted):void 0,this._durationMS=e.duration,this._durationText=e.durationText,this._activeTags=void 0,this._isDeleted=e.isDeleted||!1,this.modifiedOffline=void 0,this.modifiedOfflineText=void 0,this.highlightTimeout=void 0,this.data=void 0,this._version=window.UninitializedVersion,this._versionText=window.UninitializedVersion,this._versionRemote=void 0,this._versionRemoteText=void 0,this.lastFindPass=0,this.isEditable=new w.a(t.isEditable||!1),this.levelsDeep=new w.a(this._parent?this._parent.levelsDeep.get()+1:0),this.isHighlighted=new w.a,window.__TOTAL_ITEMS++,e.isArchived&&window.__TOTAL_ARCHIVED_ITEMS++,this._needsParse=!1,this.isLoaded=void 0,this.init(e,t),o.a.binder(this,"dragScroll","onTouchHoldTimeout","sizeInPane","onInsertLink"),this.isInitialized=!0}fn.prototype={getReactKey:function(){return this._store.id+this.id},notifyDemandLoadUpdate:function(e,t){e&&!this._loadedOnDemandData&&(t.requestDemandLoadData(this),this.notifyLoadedData())},notifyLoadedData:function(){this._loadedOnDemandData=!0},notifyLoadDataFailed:function(e){this.setCollapsed(!1,e,!1),this._loadedOnDemandData=!1},isDemandLoad:function(){return this._demandLoadChildren},isDemandNotYetLoaded:function(){return this._demandLoadChildren&&!this._loadedOnDemandData},showInOverview:function(e){return this.numItems()>0||this._demandLoadChildren||e&&this.hasArchivedChildren()},paginationTokenInUse:function(){return r.default.Assert(this._paginationToken,"Should always have a valid pagination token when beginning to load a data page"),this._paginationToken.isInUse()},hasPaginationToken:function(){return!!(this.flags.get()&VMLIFlag.HasPageToken)},needsPaginationToken:function(){return!this.hasPaginationToken()&&!this._paginationToken},setPaginationToken:function(e){r.default.Assert(e,"Should never be setting an undefined token - use clear instead"),r.default.Assert(!this._paginationToken,"Should never be overriding a pagination token - clear then set"),this._paginationToken=e,this.setFlags(this.flags.get()|VMLIFlag.HasPageToken)},clearPaginationToken:function(){this._paginationToken&&this._paginationToken.isInUse()&&this._paginationToken.notifyEndUse(),this._paginationToken=void 0,this.setFlags(this.flags.get()&~VMLIFlag.HasPageToken)},beginDataPageLoad:function(){return r.default.Assert(this._paginationToken,"Should always have a valid pagination token when beginning to load a data page"),r.default.Assert(!this._paginationToken.isInUse(),"Token should not already be in use when beginning a page load"),this._paginationToken.notifyBeginUse(),this._paginationToken},endDataPageLoad:function(e){r.default.Assert(this._paginationToken,"Should always have a valid pagination token when done loading a data page"),r.default.Assert(this._paginationToken.isInUse(),"Token should always be in use when running a request"),e?this._paginationToken.notifyEndUse():this.setFlags(this.flags.get()&~VMLIFlag.HasPageToken)},notifyPaginationUpdate:function(){r.default.Assert(this._paginationToken,"Must have a valid token to get next page of data"),this._paginationToken&&r.default.focusedPane.requestDataPage(this)},canHaveNote:function(){var e=this.belongsToItemStore(r.default.vmMain.itemStoreManager.getDefaultItemStore()),t=this.belongsToItemStore(r.default.vmMain.itemStoreManager.getTempItemStore());return e||t},createNote:function(){var e;return r.default.Assert(!this.isNote(),"Should never create a note on a note item"),this.hasNote()?e=this.getNote():(e=this.getItemStore().createItem(r.default.generateTempId(),"",this.id,{isNote:!0,forceSave:!0},ChangeType.AllLocal),this.setNote(e,ChangeType.Local)),e},editNote:function(){var e=r.default.focusedPane,t=M.a.getStartObject();if(this.isNote())M.a.selectIndex(M.a.getStartIndex(),0);else{this.hasNote()||(y.a.beginAction(),this.createNote(),y.a.endAction());this.getNote();var i=e.indexOfObject(t);setTimeout(function(){M.a.selectIndex(i+1,0)},0)}},hasNote:function(){return void 0!==this._note},getNote:function(){return r.default.Assert(this.hasNote(),"Must have a note to get one"),this._note},setNote:function(e,t){r.default.Assert(r.default.isValidChangeType(t),"Must supply a valid changeType"),r.default.Assert(!e||this.belongsToSameItemStore(e),"Note must belong to the same item store"),r.default.Assert(!this.isNote(),"Should never set a note on a note"),r.default.Assert(!this._note||!e,"Should never set a note multiple times on a single item"),r.default.Assert(!e||e.isNote(),"Should only set items that are notes as notes"),r.default.Assert(!e||!e.isDeleted(),"Should note set a deleted note"),r.default.Assert(!e||e instanceof fn,"Note must be a valid VMLI"),r.default.Assert(!e||e.parent()===this,"Should always have a valid parent set before setting note on item");var i=this._note;if(this._note=e,this.shouldSave()){var a=e?e.id:void 0;h.a.saveItemLocal(this,{note:a},SaveFlag.Prop),r.default.isLocalChange(t)&&!r.default.isUndoRedoChange(t)&&(y.a.beginAction(),v.a.noteSet(this,e),y.a.endAction()),e||!i||i.isDeleted()||s.default.deleteItem(i,t)}g.a.fireEvent("itemNoteSet",[{item:this}]),this.itemsHasMutated()},isNote:function(e){if(void 0===e)return this._isFlagHelper(VMLIFlag.Note);if(e!==this._isFlagHelper(VMLIFlag.Note)){var t=e?this.flags.get()|VMLIFlag.Note:this.flags.get()&~VMLIFlag.Note;this.setFlags(t)}},addFavorite:function(e,t){if(this._favorites||(this._favorites=[]),r.default.Assert(this._favorites.indexOf(e)>=0,"Must not already be in the favorites group"),this._favorites.push(e),vt.notifyAdd(this,e),this.shouldSave()){var i={favorites:this._favorites};h.a.saveItem(this,i,t,SaveFlag.Prop)}},removeFavorite:function(e,t){if(r.default.Assert(this._favorites,"Must always have favorites defined before removing from item"),r.default.Assert(!this._favorites.indexOf(e)>=0,"Must already be in the favorites group"),this._favorites.remove(e),vt.notifyRemove(this,e),this.shouldSave()){var i={favorites:this._favorites};h.a.saveItem(this,i,t,SaveFlag.Prop)}},setFavorites:function(e,t){for(var i=0,a=0,n=(e||[]).removeArray(this._favorites),s=(this._favorites||[]).removeArray(e),o=0;o<s.length;++o){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;vt.notifyRemove(this,s[o])}for(o=0;o<n.length;++o){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;vt.notifyAdd(this,n[o])}if(this._favorites=e,this.shouldSave()){var l=0,d=[];for(o=0;o<e.length;o++){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;d[o]=r.default.clone(e[o],!0)}var u={favorites:d};h.a.saveItem(this,u,t,SaveFlag.Prop)}},getFavorites:function(){return this._favorites},shouldSave:function(){return this._shouldSave},canDestroy:function(){return this._canDestroy},_getLineStyle:function(){return this.flags.get()&r.default.LSMask},_getPriority:function(){return this.flags.get()&r.default.PMask},getPriority:function(e){if(e){var t=e.search.getItemPriority(this);if(void 0!==t)return t}return this._getPriority()},getPadding:function(e,t,i){if(r.default.Assert(e&&e.getItem(),"Invalid pane"),this.isNote())return this.parent().getPadding(e,t,i);if(isNaN(i)){var a;if(t)a=1;else if(e.isSearchedFlat()){for(var n=0,s=this;s;){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(e.search.isFlatSearchResult(s)){a=s.levelsDeep.get()-1;break}s=s.parent()}r.default.Assert(!isNaN(a),"Item has no root depth",!!this.parent()),isNaN(a)&&(a=1)}else a=e.getItem().levelsDeep.get();i=this.levelsDeep.get()-a-(t?e.overviewPadLevels:1)}return this.getPaddingForLevel(i,e,t)},getPaddingForLevel:function(e,t,i){var a;return e=Math.max(e,0),a=i?r.default.overviewPaddingStart+e*r.default.overviewPaddingIncrement:un.a.itemIndentStart(t)+e*un.a.itemIndentSize(t),r.default.Assert(r.default.isNumber(a),"Must have a valid padding"),a},_updateStylePadding:function(e,t){r.default.Assert(this._parent,"Must have a valid parent to update padding, root should never change");var i=e+(this.isNote()?0:1),a=this.levelsDeep.get()!==i;if(a||t){var n=0;a&&this.levelsDeep.set(i);for(var s=this.getItems(),o=0;o<s.length;++o){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;s[o]._updateStylePadding(i,t)}}},setFlags:function(e){this.flags.set(e)},getPriorityProps:function(){var e=this.flags.get();return r.default.priorityMapOut[e&r.default.PMask]+" "},styleProps:function(e,t){var i=this.flags.get(),a=this.isHeader()&&!t.isSearchedFlat()?"pHeader ":"";i&VMLIFlag.Highlighted&&t!==r.default.focusedPane&&(a+="highlight "),this.isArchived()&&(a+="archived "),this.isPrefixHeader()?a+="itemHeader ":this.isPrefixTask()?a+="itemTask ":this.isPrefixBullet()?a+="itemBullet ":this.isPrefixNumList()&&(a+="itemNumList "),this.prefix&&(a+="hasPrefix "),t.isItemTopLevel(e,this)&&(a+="topLevel ");var n=!1;if(i&VMLIFlag.Complete?(!this.repeatDate()||this.dateCompleted&&this.dateCompleted.getTime()===hn.getTime())&&(n=!0):!(i&VMLIFlag.Note)&&i&VMLIFlag.DisplayComplete&&(n=!0),n?(a+="pComplete ",t.search.isMatchStuckHiding(this)||(a+="pDisplayComplete c-foreground-super-faded c-before-super-faded ")):i&r.default.PMask?a+=r.default.priorityMapOut[i&r.default.PMask]+" ":a+="pNormal ",i&VMLIFlag.Starred&&!(i&VMLIFlag.Complete||i&VMLIFlag.DisplayComplete)&&(a+="pStar c-star "),i&VMLIFlag.Note){a+="pNote c-foreground-faded ";var s=this.parent().flags.get();(s&VMLIFlag.Complete||s&VMLIFlag.DisplayComplete)&&(a+="pComplete c-foreground-super-faded c-before-super-faded "),s&r.default.PMask&&(a+=r.default.priorityMapOut[s&r.default.PMask]+" "),s&VMLIFlag.Starred&&!(s&VMLIFlag.Complete||s&VMLIFlag.DisplayComplete)&&(a+="pStar c-star "),i&VMLIFlag.Multiline&&(a+="multiline ")}var o=this.getAttachments();if(o)for(var l=0,d=0;d<o.length;++d){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;var u=o[d];if(u.isLoaded()){var c=u.getPlugin().getCssClass(u,t);c&&(a+=c)}}return a},onAttachmentIDChange:function(e,t){this.setText(this.getParsedText(),!0,ChangeType.Local)},onAttachmentUpdate:function(e,t,i){e.fieldsHaveParseEffect(t)&&(V.default.clearCacheForItem(this.id),this.parseText(!0,i),rn.a.beginBatch(this),rn.a.itemTextChanged(this))},setAttachments:function(e,t,i){var a=!1;if(!this._attachments&&e&&(this._attachments=[]),this._attachments){for(var n=0,s=0,r=this._attachments,o=0;o<r.length;++o){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;e.indexOf(r[o])<0&&(r[o].unsubscribe(this),r[o].notifyItemTextChanged(this,!0),this.shouldSave()&&r[o].markUnused(t),a=!0)}for(o=0;o<e.length;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var l=e[o];if(r.indexOf(l)<0){if(l.shouldBeDeleted()){var d=l.getEmbedString(),u=this.getRawText().replace(d,"File failed to upload");return void this.setText(u,!0,ChangeType.Local)}l.subscribe(this),this.shouldSave()&&l.markInUse(t),a=!0}}a&&(this._attachments=e)}a&&!1!==i&&this.itemChanged.notify()},getAttachment:function(e){if(r.default.Assert(this._attachments,"Must have valid attachments in order to query"),this._attachments)return this._attachments[e]},hasAttachment:function(e){if(this._attachments)for(var t=0,i=0;i<this._attachments.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(this._attachments[i].id===e)return!0}return!1},hasPluginAttachment:function(e){if(r.default.Assert(e,"Must provide a valid plugin type to query"),this._attachments)for(var t=0,i=0;i<this._attachments.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(this._attachments[i].getPlugin().id===e)return!0}return!1},getAttachmentById:function(e){if(r.default.Assert(this._attachments,"Must have valid attachments in order to query"),this._attachments)for(var t=0,i=0;i<this._attachments.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(this._attachments[i].id===e)return this._attachments[i]}},getAttachmentByType:function(e){if(r.default.Assert(e,"Must provide a valid plugin type to query"),this._attachments)for(var t=0,i=0;i<this._attachments.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=this._attachments[i];if(a.isType(e))return a}},getAttachmentByPlugin:function(e){if(r.default.Assert(e,"Must provide a valid plugin type to query"),this._attachments)for(var t=0,i=0;i<this._attachments.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=this._attachments[i];if(a.isPlugin(e))return a}},getAttachments:function(){if(this._attachments&&this._attachments.length>0)return this._attachments},hasAttachments:function(){return this._attachments&&this._attachments.length>0},getNumAttachments:function(){return this._attachments?this._attachments.length:0},hasAttachmentType:function(e){return r.default.vmMain.pluginManager.hasAttachmentType(this,e)},copyProperties:function(e){this.isStarred(e.isStarred(),ChangeType.Auto),this.isComplete(e.isComplete(),ChangeType.Auto),this.priority(e.priority(),ChangeType.Auto)},moveNote:function(e,t){r.default.Assert(e.hasNote(),"Must have a note to move"),r.default.Assert(!this.hasNote(),"Must not already have a note");var i=e.getNote();e.setNote(void 0,t),i&&(i.parent(this),this.setNote(i,t))},parent:function(){if(1===arguments.length){r.default.Assert(arguments[0]instanceof fn||void 0===arguments[0],"Parent must be a VMLI");var e=arguments[0],t=this._parent;if(r.default.Assert(!e||e._store===this._store,"All VMLIs in the same tree must share the same owner"),e!==t)if(void 0!==e){var i=this._numArchivedDescendants+(this.isArchived()?1:0);this._notifyAncestorsArchived(!1,i),this._parent=e,this._notifyAncestorsArchived(!0,i),this._numArchivedAncestors=this._parent._numArchivedAncestors+(this._parent.isArchived()?1:0),this._notifyDescendantsArchived(!0,this._numArchivedAncestors),this._updateStylePadding(this._parent.levelsDeep.get(),!1)}else{this._parent=e;var a=t._numArchivedAncestors+(t.isArchived()?1:0);this._numArchivedAncestors-=a,this._notifyDescendantsArchived(!1,a);i=this._numArchivedDescendants+(this.isArchived()?1:0);this._notifyAncestorsArchived(!1,i)}}return this._parent},getParser:function(){var e,t=this.getItemStore();return t&&(e=t.getParser()),e},requireStoredEls:function(){var e=this.getItemStore();return!!e&&e.requireStoredEls()},getItemStore:function(){return r.default.Assert(this._store,"Should never be getting the item store from a destroyed VMLI"),this._store},belongsToSameItemStore:function(e){return this.getItemStore()===e.getItemStore()},belongsToItemStore:function(e){return this.getItemStore()===e},archivedItems:function(e){return this._archivedItems||(this._archivedItems=new k.a,window.__TOTAL_ARCHIVE_PARENTS++),e?this._archivedItems.get():this._archivedItems},hasArchivedChildren:function(){return void 0!==this._archivedItems&&this._archivedItems.get().length>0},notifyItemPropertyChanged:function(e,t){if(this.hasAttachments())for(var i=0,a=this.getAttachments(),n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;a[n].notifyItemPropertyChanged(this,e,t)}},_notifyAncestorsArchived:function(e,t){var i=this.parent();if(r.default.Assert(void 0===t||t>=0,"Must not specify a zero or negative number"),(t=void 0===t?1:t)>0)for(var a=0;i;){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;e?i._numArchivedDescendants+=t:i._numArchivedDescendants-=t,r.default.Assert(i._numArchivedDescendants>=0,"Must never have a negative number of archived descendants"),i=i.parent()}},_notifyDescendantsArchived:function(e,t){if(r.default.Assert(void 0===t||t>=0,"Must not specify a zero or negative number"),(t=void 0===t?1:t)>0){var i=0;e?this._numArchivedAncestors+=t:this._numArchivedAncestors-=t,r.default.Assert(this._numArchivedAncestors>=0,"Must never have a negative number of archived ancestors");for(var a=this.getItems(),n=0;n<a.length;++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;a[n]._notifyDescendantsArchived(e,t)}if(this.hasArchivedChildren()){var s=0,o=this.archivedItems(!0);for(n=0;n<o.length;++n){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;o[n]._notifyDescendantsArchived(e,t)}}}},isArchived:function(e,t){if(void 0!==e){r.default.Assert(r.default.isValidChangeType(t),"Must supply a valid changetype when completing an item: "+t);var i=this._isArchived;if(this._isArchived=e,e!==i){var a=0;void 0!==this._parsedText&&void 0!==this.els||this.parseText(!0,t);for(var n=this.getItems(),s=0;s<n.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;n[s]._notifyDescendantsArchived(this._isArchived)}if(this.hasArchivedChildren()){var o=0,l=this.archivedItems(!0);for(s=0;s<l.length;++s){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;l[s]._notifyDescendantsArchived(this._isArchived)}}this._notifyAncestorsArchived(this._isArchived);var d=this._isFlagHelper(VMLIFlag.Archived);this._isFlagHelper(VMLIFlag.Archived,!d),this.notifyItemPropertyChanged(t,"isArchived"),rn.a.itemSearchChanged(this)}}return this._isArchived},hasArchivedDescendant:function(){return this._numArchivedDescendants>0},hasArchivedAncestor:function(){return this._numArchivedAncestors>0},getArchivedAncestor:function(e){for(var t,i=0,a=e?this:this.parent();void 0!==a;){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(a.isArchived()&&(t=a,!e))break;a=a.parent()}return t},getLevelsToArchivedAncestor:function(e){var t=0;r.default.Assert(e||!this.isArchived(),"Should not be getting the archived ancestor for an archived item");for(var i=0,a=0,n=e?this:this.parent();void 0!==n;){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(a++,n.isArchived()&&(i=a,!e))break;n=n.parent()}return i},isHidden:function(e){return r.default.Assert(e,"Must specify the pane for the item being checked"),r.default.Assert(!e||e.search,"Pane search obj must exist: ",e.isDestroyed()),!(!e||!e.search)&&!e.search.isMatched(this)},getRawText:function(){return this._rawText},getParsedText:function(){return r.default.Assert(!1===this._needsParse,"Text should be parsed before calling get"),void 0!==this._parsedText?this._parsedText:this._rawText},getSearchText:function(e){if(e){var t=e.search.getItemSearchText(this);if(t)return t}return r.default.Assert(void 0!==this._searchText,"Item should always have search text"),this._searchText},setRawText:function(e){void 0!==e&&null!==e||(e=""),r.default.Assert(e.indexOf(window.AttachChar)<0,"Should never have an AttachChar present in raw text"),this._rawText=e,this._searchText=this.generateSearchText(),this._parsedText=void 0,this._notePreviewText=void 0,this._needsParse=!0},setParsedText:function(e){this._parsedText=e,this._needsParse=!1,this._searchText=this.generateSearchText()},generateSearchText:function(){var e=this.getParsedTextWithoutPrefix().toLowerCase();return this.hasAttachments()?this._generateUsableText(e,"getTitleString").replace(/[\*_]/g,"").toLowerCase():e},priority:function(e,t){if(void 0===e)return this._getPriority();r.default.Assert(r.default.isValidChangeType(t),"Must supply a valid changetype when completing an item: "+t),r.default.Assert(null===e||r.default.priorityMapOut[e],"Priority must be defined in globals");var i=this._getPriority();if(e!==i){var a=this.flags.get(),n=a&~r.default.PCMask|e;if(a&VMLIFlag.Complete&&(n&=~VMLIFlag.Complete),this.setFlags(n),this.shouldSave()){var s={priority:e};h.a.saveItem(this,s,t,SaveFlag.Text)}this.notifyItemPropertyChanged(t,"priority"),rn.a.itemSearchChanged(this),y.a.performAction(TrackerType.Update,{itemID:this.id,field:"priority",newValue:e,oldValue:i})}},isScheduled:function(){return!!this._date||!!this._repeatDate},getDuration:function(e,t){if(e){var i=e.search.getItemDuration(this);if(i)return i}var a=this._durationMS||0;return t&&(a=10*Math.round(a/10)),a},setDuration:function(e,t){this._durationMS!==e&&(this._durationMS=e,rn.a.itemDateChanged(this))},getDurationText:function(){return this._durationText||""},setDurationText:function(e){this._durationText=e},getDateText:function(e){if(e){var t=e.search.getItemDateText(this);if(t)return t}return this._dateText},setDateText:function(e){this._dateText=e},setDateDuration:function(e,t){var i=this.getRawText(),a=e||t?e.toLowerCase()+(t?" "+t:""):"";if(this.getDateText()){if(this.getDuration()){var n=this.getDurationText(),s=i.indexOf(l.a.DatePrefix),r=i.indexOf(n,s);i=i.substr(0,r-1)+i.substr(r+n.length)}i=i.replace(l.a.DatePrefix+this.getDateText(),a)}else i+=" "+a;this.setText(i,!0,ChangeType.Local)},getItemDateString:function(){var e=l.a.DatePrefix+this.getDateText();return this.getDurationText()&&(e+=" "+this.getDurationText()),e},getEndDate:function(e){r.default.Assert(this.date(),"Must have a valid date");var t=this.getDate(e);return t?t.clone().addMilliseconds(this.getDuration(e,!0)):void 0},isMultidayEvent:function(){var e=!1;if(this.date()&&this.getDuration()>0){var t=this.getEndDate();this.date().isSameDay(t)||(e=!0)}return e},getStickySearchInfo:function(){return{prefix:this.getPrefix(),date:this.date(),dateText:this._dateText,repeatDate:this.repeatDate(),duration:this.getDuration(),tagsLower:this.getTagsLower(),contacts:this.getContacts(),searchText:this.getSearchText(),priority:this.getPriority(),isComplete:this.isComplete(),isStarred:this.isStarred()}},date:function(e,t){return void 0!==e&&(r.default.Assert(null===e||r.default.isDateValid(e),"Must pass in a valid date object"),r.default.Assert(r.default.isValidChangeType(t),"Must have a valid changeType"),e!==this._date&&(null===e&&(e=void 0),r.default.Assert(void 0===e||!isNaN(e.getTime()),"Must be setting a valid date"),this._date=e,r.default.timeline.updateNotifications(this),r.default.isFlagSet(t,ChangeType.ItemLoad)||rn.a.itemDateChanged(this),r.default.isLocalChange(t)&&y.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ChangeDate,data:{itemID:this.id,date:e}}))),this.getDate()},getDate:function(e){if(e){var t=e.search.getItemDate(this);if(t)return t}return this._date},getDateFormat:function(){return this._dateFormat},setDateFormat:function(e){this._dateFormat=e},repeatDate:function(e){if(e){var t=e.search.getItemRepeatDate(this);if(t)return t}return this._repeatDate},setRepeatDate:function(e,t){void 0!==e&&(r.default.Assert(!e||e instanceof Gi,"Must pass in a valid repeat date object"),r.default.Assert(r.default.isValidChangeType(t),"Must have a valid changeType"),e!==this._repeatDate&&(null===e&&(e=void 0),this._repeatDate=e,!e&&this.dateCompleted&&this.dateCompleted.getTime()!==hn.getTime()&&this.isComplete(!1,t),r.default.timeline.updateNotifications(this),r.default.isFlagSet(t,ChangeType.ItemLoad)||rn.a.itemDateChanged(this),r.default.isLocalChange(t)&&y.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ChangeDate,data:{itemID:this.id,date:e}})))},allDayDate:function(){return this._date?!this._date.hasTimeOfDay():!!this.repeatDate()&&!this.repeatDate().hasTimeOfDay()},_isFlagHelper:function(e,t){if(void 0===t)return!!(this.flags.get()&e);var i=t?this.flags.get()|e:this.flags.get()&~e;this.setFlags(i)},isDeleted:function(e,t){if(void 0!==e){var i=0;r.default.Assert(r.default.isValidChangeType(t),"Must supply a valid changetype to delete an item: "+t),this._isDeleted=e;for(var a=0;this._favorites&&a<this._favorites.length;++a){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var n=this._favorites[a];e?vt.notifyRemove(this,n):vt.notifyAdd(this,n)}if(this._attachments){var s=0,o=this._attachments;for(a=0;a<o.length;++a){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;e?(o[a].unsubscribe(this),this.shouldSave()&&o[a].markUnused(t)):(o[a].subscribe(this),this.shouldSave()&&o[a].markInUse(t))}}}return this._isDeleted},isImportant:function(e){return this._getPriority(e)},forceComplete:function(e,t){return this.isComplete(e,t,!0)},isDisplayComplete:function(){return this._isFlagHelper(VMLIFlag.DisplayComplete)},computeDisplayComplete:function(){var e=this.parent(),t=e&&!this.isComplete()&&(e.isComplete()||e._isFlagHelper(VMLIFlag.DisplayComplete));this._isFlagHelper(VMLIFlag.DisplayComplete,t)},propagateDisplayComplete:function(e){var t=0;this.computeDisplayComplete();for(var i=0;i<this.numItems();i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=this.itemAtIndex(i);a.isComplete()||a.propagateDisplayComplete()}},isComplete:function(e,t,i){if(void 0===e)return this._isFlagHelper(VMLIFlag.Complete)&&(!this.repeatDate()||this.dateCompleted&&this.dateCompleted.getTime()===hn.getTime());var a={isComplete:e};if(r.default.Assert(r.default.isValidChangeType(t),"Must supply a valid changetype when completing an item: "+t),e!==this._isFlagHelper(VMLIFlag.Complete)||this.repeatDate()){if(e){if(this.repeatDate()){if(r.default.Assert(!this.dateCompleted||this.dateCompleted.getTime()!==hn.getTime(),"If the passed in value is true then the repeated date should never be forced"),i)this.dateCompleted=hn;else{var n=this.repeatDate().nextComplete(this.dateCompleted),o=this.repeatDate().nextActive(this.dateCompleted);if(o){if(r.default.isLocalChange(t)&&!r.default.isUndoRedoChange(t)){a.isComplete=!1,this.dateCompleted=o,y.a.beginAction(),r.default.focusedPane.setIgnoreRestoreScroll();var l=n.hasTimeOfDay()?DFormat.DayYearTime:DFormat.MonthDayYear,d=this.getRawText().replace(this.getDateText(),n.toString(H.a.getFormat(l))),u=s.default.createVMLI({text:d,isComplete:!0,dateCompleted:Date.now()},{parent:this.parent(),changeType:ChangeType.AllLocal});this.parent().insertItem(u,this.getIndex()),this.repeatDate().setStartDate(o),a.repeatDate=this.repeatDate().toString(),rn.a.itemTextChanged(this),r.default.vmMain.runSingleParse(this,t|ChangeType.Property),y.a.endAction()}}else this.dateCompleted=hn,r.default.isLocalChange(t)&&!r.default.isUndoRedoChange(t)&&r.default.vmMain.runSingleParse(this,t|ChangeType.Property),i=!0}a.dateCompleted=this.getDateCompletedTime()}else this.dateCompleted||(this.dateCompleted=new Date,a.dateCompleted=this.getDateCompletedTime());r.default.isLocalChange(t)&&r.default.aggregateEvent("ItemCompleted")}else this.dateCompleted=void 0,a.dateCompleted=void 0,i=!0;this.shouldSave()&&h.a.saveItem(this,a,t,SaveFlag.Text),this.notifyItemPropertyChanged(t,"isComplete"),y.a.performAction(TrackerType.Update,{itemID:this.id,field:"isComplete",newValue:e,oldValue:!e})}!i&&this.repeatDate()||(this._isFlagHelper(VMLIFlag.Complete,a.isComplete),this.propagateDisplayComplete(),r.default.timeline.updateNotifications(this),rn.a.itemSearchChanged(this))},isStarred:function(e,t){if(void 0===e)return this.getStarred();if(r.default.Assert(r.default.isValidChangeType(t),"Must supply a valid changetype when completing an item: "+t),e!==this._isFlagHelper(VMLIFlag.Starred)){var i=this.flags.get();e&&i&VMLIFlag.Complete&&(i&=~VMLIFlag.Complete);var a=e?i|VMLIFlag.Starred:i&~VMLIFlag.Starred;this.setFlags(a);var n={isStarred:e};this.shouldSave()&&h.a.saveItem(this,n,t,SaveFlag.Text),this.notifyItemPropertyChanged(t,"isStarred"),rn.a.itemSearchChanged(this),y.a.performAction(TrackerType.Update,{itemID:this.id,field:"isStarred",newValue:e,oldValue:!e})}},getStarred:function(e){if(e){var t=e.search.getItemStarred(this);if(void 0!==t)return t}return this._isFlagHelper(VMLIFlag.Starred)},isHeader:function(){return!this.isNote()&&(this.numItems()>0||this._demandLoadChildren&&!this._loadedOnDemandData)},getVisibleChildren:function(e){if(!this.isNote()){for(var t=0,i=this.getItems(),a=[],n=0;n<i.length;n++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;i[n].isHidden(e)||a.push(i[n])}return a}},hasVisibleChildren:function(e){if(this.isNote())return!1;for(var t=0,i=this.getItems(),a=0;a<i.length;a++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(!i[a].isHidden(e))return!0}return!1},hasHeaderChildren:function(){if(this.isNote())return!1;for(var e=0,t=this.getItems(),i=0;i<t.length;i++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;if(t[i].isHeader())return!0}return!1},getCollapsedField:function(e,t){return t?l.a.PerPaneStateField.CollapsedOverview:e.collapsedFieldName},isCollapsed:function(e,t,i){if(r.default.Assert(e,"Must specify the pane for the item being checked for collapsed"),!e||!t&&e.isSearchedFlat())return!1;var a=!i&&e.isSearchedText()?e.getPerPaneState(this.id,l.a.PerPaneStateField.CollapsedSearch):void 0;return void 0===a&&void 0===(a=e.getPerPaneState(this.id,this.getCollapsedField(e,t)))&&(a=this.isDemandLoad()?0===this.numItems()||!e.isSearched()&&!t:e.getCollapsedDefault(this,t)),!!a},setCollapsed:function(e,t,i,a){if(r.default.Assert(t,"Must specify the pane for the item being checked for collapsed"),!t)return!1;var n=this.isCollapsed(t,i);void 0!==e&&(e&&!this.isCollapsible()||(t.isSearchedText()&&t.setPerPaneState(this.id,l.a.PerPaneStateField.CollapsedSearch,void 0),t.setPerPaneState(this.id,this.getCollapsedField(t,i),e),!1!==a&&r.default.vmMain.paneManager.updatePaneStateForPane(t),y.a.performAction(TrackerType.Update,{itemID:this.id,field:"isCollapsed",pane:t,newValue:e,oldValue:n}),this.isDemandLoad()&&this.notifyDemandLoadUpdate(!e,r.default.focusedPane),e!==n&&t.updateItems())),this.itemChanged.notify()},setCollapsedQuiet:function(e,t){t.setPerPaneState(this.id,this.getCollapsedField(t,!1),e)},toggleCollapsed:function(e){r.default.Assert(e,"Must specify the pane that this item is being collapsed in"),V.default.clearCacheForItem(this.id),this.setCollapsed(!this.isCollapsed(e,!1),e,!1)},isCollapsible:function(){return!this.isNote()&&(this.numItems()>0||this._demandLoadChildren&&!this._loadedOnDemandData)},isDraggable:function(){return!this.isNote()},setTags:function(e,t){var i=this._activeTags&&!e&&this._activeTags||!this._activeTags&&e&&e||r.default.arrayDiff(this._activeTags,e);this._activeTags=e,this._activeTagsLower=e?e.map(function(e){return e.toLowerCase()}):void 0,i&&i.length>0&&!r.default.isFlagSet(t,ChangeType.ItemLoad)&&rn.a.itemTagsChanged(this,i)},getTags:function(){return this._activeTags},getTagsLower:function(e){if(e){var t=e.search.getItemTagsLower(this);if(t)return t}return this._activeTagsLower},setContacts:function(e,t){var i=!(this._activeContacts&&e&&this._activeContacts.equals(e));this._activeContacts=e,i&&!r.default.isFlagSet(t,ChangeType.ItemLoad)&&rn.a.itemSearchChanged(this,t)},getContacts:function(e){if(e){var t=e.search.getItemContacts(this);if(t)return t}return this._activeContacts},hasCompletedAncestor:function(){for(var e=0,t=this.parent();t;){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;if(t.isComplete())return!0;t=t.parent()}},hasTime:function(){return this.date()?this.date().hasTimeOfDay():this.repeatDate()?this.repeatDate().hasTimeOfDay():!!this.dateCompleted},getTimeOfDay:function(){return this.date()?this.date().getTimeOfDay():this.repeatDate()?this.repeatDate().getTimeOfDay():this.dateCompleted?this.dateCompleted.getTimeOfDay():0},_formatDateTime:function(e){return e.toString(H.a.getFormat(DFormat.ShortTime))},getDisplayDateWithDuration:function(e,t){var i=this.getDate(t);if(i){var a=this.getEndDate(t);i=i.clone().clearTime().equals(i)?i:a.clone().clearTime().equals(i)?a:i}else this.repeatDate(t)&&(i=this.repeatDate(t).getDateOnDay(e));return i},time:function(){var e="",t=this.date();if(this.dateCompleted&&this.isComplete())e=this._formatDateTime(this.dateCompleted);else if(t){if(t.hasTimeOfDay())if(this.getDuration()>0){var i=this.getDisplayDateWithDuration(this);i.equals(t)?e="<div>"+this._formatDateTime(t)+'</div><div class="c-foreground-very-faded">'+this._formatDateTime(this.getEndDate())+"</div>":i.equals(this.getEndDate())&&(e="Ends "+this._formatDateTime(this.getEndDate()))}else e=this._formatDateTime(this.date())}else this.repeatDate()&&this.repeatDate().hasTimeOfDay()&&(e=this.repeatDate().getTime(H.a.getFormat(DFormat.ShortTime)));return e},createDateString:function(e){return e.isBefore(Date.today().addWeeks(1))?e.toString(H.a.getFormat(DFormat.LongDayTime)):e.toString(H.a.getFormat(DFormat.ShortDayTime))},fullTime:function(){var e=this.date();if(!e)return"";this.createDateString(e)},isVersionUninitialized:function(e){var t;switch(e){case VersionType.Structure:t=this._version;break;case VersionType.Text:t=this._versionText;break;default:t=-2,r.default.Assert(!1,"Invalid version type")}return(t||0)===window.UninitializedVersion},setVersion:function(e,t){switch(r.default.Assert(r.default.isNumber(t),"Must always be setting a version to a number: ",t),e){case VersionType.Structure:this._version=t;break;case VersionType.Text:this._versionText=t;break;default:r.default.Assert(!1,"Invalid version type")}},getVersion:function(e){var t;switch(e){case VersionType.Structure:t=this._version;break;case VersionType.Text:t=this._versionText;break;default:t=-2,r.default.Assert(!1,"Invalid version type")}return t||0},setRemoteVersion:function(e,t){switch(r.default.Assert(void 0===t||r.default.isNumber(t),"Must always be setting a remote version to a number: ",t),e){case VersionType.Structure:this._versionRemote=t;break;case VersionType.Text:this._versionRemoteText=t;break;default:r.default.Assert(!1,"Invalid version type")}},getRemoteVersion:function(e,t){var i;switch(e){case VersionType.Structure:i=this._versionRemote;break;case VersionType.Text:i=this._versionRemoteText;break;default:i=-2,r.default.Assert(!1,"Invalid version type")}return i||t?i:0},isLocalVersionNewer:function(e){return this.getVersion(e)==this.getRemoteVersion(e)||void 0===this.getRemoteVersion(e,!0)},isRemoteVersionNewer:function(e){return!this.isLocalVersionNewer(e)},init:function(e,t){if(this._shouldSave=!(t&&t.noSave),r.default.Assert(!this._shouldSave||!this._demandLoadChildren,"Should never be saving results of demand loaded items"),e.data){r.default.Assert(this.shouldSave(),"Should never be loading from remote with item that doesnt save");var i=v.a.getVersion(e.data,VersionType.Structure),a=v.a.getVersion(e.data,VersionType.Text);this.setRemoteVersion(VersionType.Structure,i),this.setRemoteVersion(VersionType.Text,a),y.a.beginAction(),this.initFromGDrive(e.data),y.a.endAction(),this.setRemoteVersion(VersionType.Structure,void 0),this.setRemoteVersion(VersionType.Text,void 0)}else{if(void 0!==e.version&&this.setVersion(VersionType.Structure,e.version),void 0!==e.versionText&&this.setVersion(VersionType.Text,e.versionText),this.modifiedOffline=e.modifiedOffline,this.modifiedOfflineText=e.modifiedOfflineText,this.modifiedOffline,this.modifiedOfflineText,r.default.vmMain.isLoaded&&this.shouldSave()&&v.a.isConnected()&&e.id!==s.default.rootId?s.default.initializeItem(this):this.id=e.id||r.default.generateTempId(),e.date){var n=new Date(e.date);r.default.isDateValid(n)?this.date(n,t.changeType|ChangeType.ItemLoad):r.default.reportError(new Error("Initial invalid date: "+e.date))}if(e.repeatDate){var o=new Gi(e.repeatDate);o.isValid()?this.setRepeatDate(o,t.changeType):r.default.reportError(new Error("Initial invalid repeat date: "+e.repeatDate))}e.dateCompleted&&(this.dateCompleted=new Date(e.dateCompleted)),e.favorites&&this.setFavorites(e.favorites,t.changeType),this.computeDisplayComplete(),(e.items&&e.items.length>0||e.note)&&this.updateItems(e.items,e.note,t.changeType)}if(this.__TEMP_InitCalled=!0,!this.isArchived()||r.default.vmMain.hasDisplayedArchivedItems()){r.default.Assert(t,"Currently we have required properties in extraInfo");var l=t?t.changeType:ChangeType.Auto;r.default.Assert(r.default.isValidChangeType(l),"Must supply a valid changetype to VMLIs"),this.__TEMP_InitParseCalled=!0,this.parseText(!0,t.changeType|ChangeType.ItemLoad)}else this.__TEMP_SkippedInitParsed=!0;var d;this.shouldSave()&&!r.default.isAutoChange(t.changeType)?(r.default.isLocalChange(t.changeType)?(d=SaveFlag.All,(this.date()||this.repeatDate())&&h.a.saveItemRemote(this,this.getMetaTextSaveData()),this.isComplete()&&h.a.saveItemRemote(this,{isComplete:this.isComplete()}),this.priority()&&h.a.saveItemRemote(this,{priority:this.priority()}),this.isStarred()&&h.a.saveItemRemote(this,{isStarred:this.isStarred()})):d=SaveFlag.None,this.getItemStore().trackGlobally()&&s.default.setModel(this),h.a.saveItemLocal(this,void 0,d)):this.getItemStore().trackGlobally()&&s.default.setModel(this);r.default.isLocalChange(t.changeType)&&r.default.aggregateEvent("ItemCreated")},onLoad:function(e){this.isLoaded||(!this.isDemandLoad()||this.isCollapsed(e,!1)||e.isSearched()||this.notifyDemandLoadUpdate(!0,e),this.isLoaded=!0)},destroy:function(){r.default.Assert(this._canDestroy,"VMLI must be explicitly marked as destroyable"),r.default.Assert(!this.shouldSave()||r.default.isDemoMode(),"Should never destory a saveable VMLI");var e=this.getItemStore();if(this._destroyed=!0,this._attachments){for(var t=0,i=this._attachments,a=0;a<i.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;i[a].unsubscribe(this)}this._attachments=void 0}e.trackGlobally()&&s.default.clearModel(this.id),this.items.unlisten(this.itemsHasMutated),rn.a.itemSearchChanged(this),this._store=void 0,o.a.destroy(this)},isDestroyed:function(){return this._destroyed},getACText:function(){return this.getParsedText()},resetDriveData:function(){this._versionRemote=void 0,this._versionRemoteText=void 0,this.data&&this.data.removeAllEventListeners(),this.data=void 0},isFullscreen:function(){return r.default.focusedItem===this},findItem:function(e){var t=this.getIndexOf(e.id,!1);return t>=0?{index:t,arr:this.items,isArchived:!1}:this.hasArchivedChildren()&&(t=this.getIndexOf(e.id,!0))>=0?{index:t,arr:this.archivedItems(),isArchived:!0}:void 0},updateItems:function(e,t,i){var a=!1,n=!1;if(e&&e.length>0){var o,l,d=0;this.data&&(o=v.a.get(this.data,"items"),l=v.a.get(this.data,"archivedItems")),r.default.Assert(!this.hasChildren(),"Update items should only be called from initialize when there are no items already loaded"),r.default.Assert(!this.hasArchivedChildren(),"Update items should only be called from initialize when there are no items already loaded");for(var u=0;u<e.length;++u){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;var c=e[u],h=void 0;if(c instanceof fn?h=c:r.default.isString(c)&&(h=s.default.getModel(c)),h){var f=s.default.getItem(h.parent().id);if(f&&f.id!==this.id){var p=f.items.indexOf(h.id);r.default.Assert(-1===p,"Expect that the old parent has been notified");var g=h.getIndex();g>-1&&h.parent().removeChildAtIndex(g,i)}h.parent(this)}else if("object"!==(void 0===c?"undefined":cn(c))){var m=s.default.getItem(c);r.default.Assert(m,"Referenced item doesn't exist",c),m&&(h=s.default.createVMLI(m,{parent:this,changeType:i}))}else r.default.Assert(c,"Item must exist otherwise we arent creating anything"),c&&(h=s.default.createVMLI(c,{parent:this,changeType:i}));if(r.default.Assert(h,"There must be a model at this point"),h){if(h.isNote()){t=h.id;continue}h.isArchived()?(n=!0,this.archivedItems(!0).push(h),!l&&this.data&&(l=v.a.ensureItemList(this,!0)),l&&l.push(h.data)):(a=!0,this.items.push(h),!o&&this.data&&(o=v.a.ensureItemList(this,!1)),o&&o.push(h.data))}}}if(t){r.default.Assert(!this._note,"Must not already have a valid note set"),r.default.Assert(r.default.isString(t),"Note must be a valid ID");var _=s.default.getModel(t);if(!_){m=s.default.getItem(t);r.default.Assert(m,"Referenced note doesn't exist",t),m&&(m.isNote=!0,_=s.default.createVMLI(m,{parent:this,changeType:i}))}r.default.Assert(_,"Must have a valid note VM at this point"),this._note=_,a=!0}a&&this.itemsHasMutated(),n&&this.archivedItems().notify()},addItemAtIndex:function(e,t,i){r.default.Assert(i,"Must pass pane when adding item at index"),y.a.beginAction();var a=i.createVMLI({text:e},{parent:this,changeType:ChangeType.AllLocal,isEditable:!0});return this.insertItem(a,t),y.a.performAction(TrackerType.Create,{itemID:a.id,parent:this.id,position:isNaN(t)?this.numItems()-1:t,text:e}),this.isCollapsed(i,!1)&&this.setCollapsed(!1,i),y.a.endAction(),a},insertItem:function(e,t){r.default.Assert(!this.isNote(),"Notes cannot use this function"),r.default.Assert(e,"Must specify a valid item to be inserted"),r.default.Assert(this!==e,"Should not insert an item into itself"),r.default.Assert(!e.isArchived(),"Should not be inserting an archived item into the items array"),r.default.Assert(this.belongsToSameItemStore(e),"Items must belong to the same item store"),this!==e&&(isNaN(t)?this.items.push(e):this.items.splice(t,0,e),this.shouldSave()&&s.default.insertItem(this,e,t))},insertSorted:function(e,t,i){r.default.Assert(!this.isNote(),"Notes cannot use this function"),r.default.Assert(e,"Must specify a valid item to be inserted"),r.default.Assert(!e.isArchived(),"Should not be inserting an archived item into the items array"),r.default.Assert(t,"Must supply a valid comparator"),r.default.Assert(this.belongsToSameItemStore(e),"Items must belong to the same item store");var a=this.items.insertSorted(e,t,i);this.shouldSave()&&s.default.insertItem(this,e,a)},moveTo:function(e,t){var i=e.parent,a=e.index,n=e.shouldBeArchived,o=e.noVersion;e.underlying,e.fromTab;r.default.Assert(i instanceof fn,"New parent must be a valid VMLI"),void 0===a&&(a=-1),void 0===n&&(n=!1);var l=this.parent(),d=l.findItem(this);if(d){var u=a,c=a;if(l===i){if(d.index===u)return;d.index<u&&u--}r.default.vmMain.beginUpdateItems(),d.arr.splice(d.index,1),rn.a.itemSearchChanged(this);var h=n?i.archivedItems():i.items;if(u<0?h.push(this,!1):h.splice(u,0,this,!1),this.parent(i),h.notify(),this.hasNote()&&this.getNote().itemChanged.notify(),r.default.vmMain.commitUpdateItems(),this.shouldSave()){var f={index:c,isArchived:n};s.default.moveItem({item:this,newInfo:f,oldParent:l,oldInfo:d,noVersion:o},t)}n?r.default.Assert(this.isArchived(),"If moving to an archived array, the item should already be archived"):r.default.Assert(!this.isArchived(),"If moving to a non-archived array item should not already be archived"),l.propagateDisplayComplete(),i.propagateDisplayComplete()}},getItemsArrayForSave:function(){var e=0;r.default.Assert(!this.isNote(),"Notes cannot use this function");for(var t=[],i=this.getItems(),a=0;a<i.length;++a){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;t.push(i[a].id)}if(this.hasArchivedChildren()){var n=0,s=this.archivedItems(!0);for(a=0;a<s.length;++a){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;t.push(s[a].id)}}return t},getDateTime:function(){if(this.date())return this.date().getTime()},getRepeatDateString:function(e){if(this.repeatDate())return this.repeatDate().toString()},getDateCompletedTime:function(){if(this.dateCompleted)return this.dateCompleted.getTime()},isForceCompleted:function(){return!(!this.dateCompleted||!this.dateCompleted.equals(hn))},getMetaTextSaveData:function(){var e,t,i=this.getDate(),a=this.repeatDate();return void 0!==i&&(e=i.getTime()),void 0!==a&&(t=a.toString()),{date:e,dateFormat:this.getDateFormat(),repeatDate:t,dateCompleted:this.getDateCompletedTime()}},_generateNotificationEntry:function(e){var t,i=e.toJSON(),a=new Date(e);return r.default.Assert(r.default.isDateValid(a),"Must provide a valid alert date: "+e+" - "+this.getDateText()),t=e.hasTimeOfDay()?a.addMinutes(-r.default.settings.get(Settings.notificationDelay)).toJSON():a.addDays(-1).clearTime().addHours(17).toJSON(),{id:this.id,text:this.getParsedTextWithoutPrefix().replace("@"+this.getDateText(),"").replace(this.getDurationText(),""),date:i,alertDate:t}},getNotificationEntries:function(){if(r.default.Assert(this.date()||this.repeatDate(),"Must have a valid date"),r.default.Assert(!this.allDayDate(),"All day dates should not be scheduled"),!this.allDayDate())try{if(this.date())return this._generateNotificationEntry(this.date());if(this.repeatDate()){for(var e=0,t=[],i=this.repeatDate().getDates(!0),a=0;a<i.length;++a){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var n=this._generateNotificationEntry(i[a]);n.id=n.id+"_"+a,t.push(n)}return t}}catch(e){return void r.default.reportError(e)}},getDebugData:function(){return{id:this.id,parent:this._parent?this._parent.id:void 0,items:this.isNote()?void 0:this.getItemsArrayForSave(),text:this.getRawText(),note:this.hasNote()?this.getNote().id:void 0,isNote:this.isNote(),isArchived:this.isArchived(),isDeleted:this.isDeleted(),version:this.getVersion(VersionType.Structure),versionText:this.getVersion(VersionType.Text),modifiedOffline:this.modifiedOffline,modifiedOfflineText:this.modifiedOfflineText}},getFullSaveData:function(){r.default.Assert(this.shouldSave(),"Item must be marked as saveable");var e={id:this.id,text:this.getRawText(),date:this.getDateTime(),repeatDate:this.getRepeatDateString(),dateText:this.getDateText(),dateCreated:this.dateCreated.getTime(),dateCompleted:this.getDateCompletedTime(),duration:this.getDuration(),durationText:this.getDurationText(),dateFormat:this.getDateFormat(),favorites:this.getFavorites()||void 0,priority:this._getPriority()||void 0,isComplete:this.isComplete()||void 0,isStarred:this.isStarred()||void 0,note:this.hasNote()?this.getNote().id:void 0,isArchived:this.isArchived()||void 0,isNote:this.isNote()||void 0,isDeleted:void 0,version:this.getVersion(VersionType.Structure),versionText:this.getVersion(VersionType.Text),modifiedOffline:this.modifiedOffline,modifiedOfflineText:this.modifiedOfflineText};return this.isNote()||(e.items=this.getItemsArrayForSave()),e},save:function(e,t){(r.default.Assert(this.shouldSave(),"Item must be marked as saveable"),r.default.Assert(void 0!==t,"Must specify saveFlags for the changes that are being saved"),e)?s.default.getItem(this.id)||e.id?(e.items&&(e.items=this.getItemsArrayForSave(),r.default.isFlagSet(t,SaveFlag.Prop)||(this.modifiedOffline=!1,e.modifiedOffline=!1)),void 0!==e.text&&(r.default.isFlagSet(t,SaveFlag.Text)||(this.modifiedOfflineText=!1,e.modifiedOfflineText=!1),r.default.isLoadingRemote||rn.a.itemTextChanged(this))):e=this.getFullSaveData():e=this.getFullSaveData();s.default.saveChanges(this,e,t)},highlight:function(){var e=this;this.highlightTimeout?(this.isHighlighted.set(!1),clearTimeout(this.highlightTimeout),this.highlightTimeout=void 0,setTimeout(function(){e.isHighlighted.set(!0)},0)):this.isHighlighted.set(!0),this.highlightTimeout=setTimeout(function(){e.isHighlighted.set(!1)},2e3)},removeChild:function(e,t){var i;return r.default.Assert(!this.isNote(),"Notes cannot use this function"),r.default.Assert(!e.isNote(),"Do not use remove child to remove notes from items"),e.isArchived()?(r.default.Assert(this.hasArchivedChildren(),"For a child to be archived, this item must have valid archived children"),this.hasArchivedChildren()&&((i=this.archivedItems(!0).remove(e))>=0?this.shouldSave()&&s.default.removeItem(this,i,e,!0,t):(r.default.Assert(!1,"Archived child not found in parent"),r.default.Assert(this===e.parent(),"Parent of archived child is not set to this item, should not remove: "+e.parent())),this.archivedItems().notify())):(i=this.items.remove(e))>=0?this.shouldSave()&&s.default.removeItem(this,i,e,!1,t):(r.default.Assert(!1,"Child not found in parent"),r.default.Assert(this===e.parent(),"Parent of child is not set to this item, should not remove: "+e.parent())),i},removeChildAtIndex:function(e,t){r.default.Assert(!this.isNote(),"Notes cannot use this function"),r.default.Assert(!this.itemAtIndex(e).isArchived());var i=this.items.removeAt(e);return this.shouldSave()&&s.default.removeItem(this,e,i,!1,t),i},archiveChild:function(e,t){r.default.Assert(!this.isNote(),"Notes cannot use this function"),r.default.Assert(!e.isNote(),"Do not use archive child on notes");var i=!1;if(!e.isArchived()){y.a.beginAction(),e.isArchived(!0,t),this.archivedItems().push(e);var a=this.items.remove(e);r.default.Assert(a>=0,"Must be able to find child in items list"),this.shouldSave()&&s.default.archiveItem(this,a,e,t),y.a.endAction(),i=!0}return i},unarchiveChild:function(e,t){r.default.Assert(!this.isNote(),"Notes cannot use this function"),r.default.Assert(!e.isNote(),"Do not use unarchive child on notes");var i=!1;if(e.isArchived()){y.a.beginAction(),r.default.Assert(e.isArchived(),"Child must be archived to be unarchived"),r.default.Assert(this.hasArchivedChildren(),"Parent must have archived children to unarchive a child"),e.isArchived(!1,t);var a=this.archivedItems(!0).remove(e);this.items.push(e),this.shouldSave()&&s.default.unarchiveItem(this,a,e,t),this.archivedItems().notify(),y.a.endAction(),i=!0}return i},_moveChildrenHelper:function(e,t){var i=e.newParent,a=e.index,n=e.isArchived;r.default.Assert(void 0!==i&&void 0!==n,"_moveChildrenHelper is missing parameters");var s=n?this.archivedItems(!0):this.getItems();if(s.length>0){var o=0,l=n?i.archivedItems(!0):i.getItems();!n&&(isNaN(a)||a<0)&&(a=l.length);for(var d=0;s.length>0;){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;r.default.Assert(s[d]!==i,"Should never be reparenting to a child");var u=s[0].id;s[0].moveTo({parent:i,index:a+d,shouldBeArchived:n,underlying:!0},t),y.a.performAction(TrackerType.Move,{itemID:u,oldParent:this.id,oldPosition:d,newParent:i.id,newPosition:a+d}),d++}}},moveChildren:function(e,t,i){if(r.default.Assert(!this.isNote(),"Notes cannot use this function"),r.default.Assert(this.id!==e.id,"Do not use moveChildren to move a child to the same parent"),e.parent()===this){var a=this.removeChild(e,i);y.a.performAction(TrackerType.Delete,{itemID:e.id,parent:this.id,position:a})}r.default.vmMain.beginUpdateItems(),this._moveChildrenHelper({newParent:e,index:t,isArchived:!1},i),this._moveChildrenHelper({newParent:e,index:t,isArchived:!0},i),r.default.vmMain.commitUpdateItems()},deleteSelf:function(e){this.parent().deleteChild(this,void 0,void 0,e),this.parent(void 0)},deleteChild:function(e,t,i,a){if(r.default.Assert(e,"Must provide a valid child to delete"),r.default.Assert(!this.isNote(),"Notes cannot use this function"),y.a.beginAction(),r.default.vmMain.beginUpdateItems(),e.isNote())this.setNote(void 0,a);else if(e.hasChildren()||e.hasArchivedChildren())if(t)e.moveChildren(t,i,a);else for(var n=0,o=e.getItems(),l=o.length-1;l>=0;l--){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;e.deleteChild(o[l],void 0,void 0,a)}if(e.hasNote()&&e.setNote(void 0,a),!e.isDeleted()){if(!e.isNote()){var d=this.removeChild(e,a);y.a.performAction(TrackerType.Delete,{itemID:e.id,parent:this.id,position:d})}this.shouldSave()&&s.default.deleteItem(e,a)}e.notifyItemPropertyChanged(a,"isDeleted"),rn.a.itemItemsChanged(this),r.default.timeline.updateNotifications(e),r.default.vmMain.commitUpdateItems(),y.a.endAction()},replaceChild:function(e,t,i){r.default.Assert(!this.isNote(),"Notes cannot use this function"),r.default.Assert(!e.isNote(),"Old child should not be a note"),r.default.Assert(!t.isNote(),"New child should not be a note");var a=e.getIndex();this.items.removeAt(a),y.a.performAction(TrackerType.Delete,{itemID:e.id,parent:this.id,position:a}),s.default.deleteItem(e,i),t.moveTo({parent:this,index:a},i),s.default.removeItem(this,a+1,e,!1,i),e.moveChildren(t,t.numChildren(),i);var n=t.parent().id;if(n!==this.id){var o=t.parent().items.remove(t);y.a.performAction(TrackerType.Move,{itemID:t.id,oldParent:n,oldPosition:o,newParent:this.id,newPosition:a})}},getChildren:function(){if(!this.isNote())return this.hasNote()?[this.getNote()].concat(this.getItems()):this.getItems()},getChild:function(e){return r.default.Assert(!this.isNote(),"Notes cannot use this function"),r.default.Assert(e>=0,"Child index is out of range: ",e),r.default.Assert(e<this.numItems(),"Child index out of range: ",e,this.numItems()),this.itemAtIndex(e)},getFirstChild:function(){return r.default.Assert(!this.isNote(),"Notes cannot use this function"),this.hasChildren()?this.itemAtIndex(0):void 0},isFirstChild:function(){return r.default.Assert(!this.isNote(),"Notes cannot use this function"),!!this.parent()&&this.parent().getFirstChild()===this},getLastChild:function(){return r.default.Assert(!this.isNote(),"Notes cannot use this function"),this.hasChildren()?this.itemAtIndex(this.numItems()-1):void 0},isLastChild:function(){return r.default.Assert(!this.isNote(),"Notes cannot use this function"),!!this.parent()&&this.parent().getLastChild()===this},isDescendantOf:function(e){for(var t=0,i=this.parent();i&&i!==e;){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;i=i.parent()}return void 0!==i},getChildIndex:function(e){return r.default.Assert(!this.isNote(),"Notes cannot use this function"),r.default.Assert(!e.isNote(),"Should not get the index of an item note"),this.getIndexOf(e.id,e.isArchived())},getIndexOf:function(e,t){r.default.Assert(!this.isNote(),"Notes cannot use this function"),r.default.Assert(r.default.isString(e),"ID must be a valid string: "+r.default.getObjectInfo(e));var i,a=-1;if(t?this.hasArchivedChildren()&&(i=this.archivedItems(!0)):i=this.getItems(),i)for(var n=0,s=0;s<i.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;if(i[s].id===e){a=s;break}}return a},getRemoteIndexOf:function(e,t){r.default.Assert(!this.isNote(),"Notes cannot use this function"),r.default.Assert(!e.isNote(),"Should never be getting a remote child index of a note");var i=v.a.getItemList(this.data,t),a=-1;return i&&(a=i.indexOf(e)),a},getIndex:function(){return r.default.Assert(!this.isNote(),"Should never be getting a child index of a note"),this.parent().getChildIndex(this)},hasChildren:function(){return!this.isNote()&&this.numItems()>0},numChildren:function(){return r.default.Assert(!this.isNote(),"Notes cannot use this function"),this.numItems()},canZoom:function(){return!this.isNote()&&(this.numChildren()>0||this.getParsedText().length>0)},parents:function(e){for(var t=0,i=[],a=this.parent();a&&a!==e;){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;i.splice(0,0,a),a=a.parent()}return i},getArchivedTitle:function(){for(var e=0,t="",i=this.parent();i.parent();){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;t=i.getParsedText()+(t?" | "+t:""),i=i.parent()}return t||(t=s.default.getRootModel().getParsedText()),t},getSiblings:function(e){r.default.Assert(!this.isNote(),"Notes cannot use this function"),e=e||0;var t=[];if(this.parent())for(var i=0,a=this.parent().getItems(),n=e,s=a.length;n<s;n++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;a[n]!==this&&t.push(a[n])}return t},nextSibling:function(){var e=this.getIndex();return this.parent().getItems()[e+1]},isRootItem:function(){var e=this.getItemStore();return!!e&&e.isRoot(this)},clone:function(e,t){var i=0;r.default.Assert(!r.default.isAutoChange(t),"Cloning should always be a user action");var a=e.getItemStore().createItemRaw({text:this.getRawText(),isComplete:this.isComplete(),dateText:this.getDateText(),date:this.date(),dateFormat:this.getDateFormat(),duration:this.getDuration(),durationText:this.getDurationText(),priority:this.priority(),isStarred:this.isStarred(),isNote:this.isNote()},{parent:e,changeType:t});a.shouldSave()&&r.default.isLocalChange(t)&&h.a.saveItemLocal(a,void 0,SaveFlag.None);for(var n=0;n<this.numItems();++n){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=this.itemAtIndex(n).clone(a,t);a.insertItem(s)}if(this.hasNote()){var o=this.getNote().clone(a,t);a.setNote(o,t)}return a},getItems:function(){return this.items.get()},itemAtIndex:function(e){return this.items.get()[e]},numItems:function(){return this.items.length()},itemsHasMutated:function(){r.default.Assert(!this._destroyed,"Item should not fire mutation events once destroyed: ",this.id),!this._destroyed&&this.isInitialized&&rn.a.itemItemsChanged(this)},numChildrenRecursive:function(){var e=0,t={item:this,each:function(t){e++}};return r.default.searchVMLIs(t),e},isOnDate:function(e){var t=this.date(),i=this.repeatDate();if(t){if(e.hasTimeOfDay()){if(t.equals(e))return!0}else if(t.clone().clearTime().equals(e))return!0}else if(i&&i.includesDate(e))return!0},getCalendarColor:function(){var e;if(this.isComplete())return"#ddd";if(this.hasAttachmentType(l.a.PluginType.Calendar)){var t=this.getAttachmentByType(l.a.PluginType.Calendar);e=t.getPlugin().getCalendarBackgroundColor(t.getField("calendarID"))}else e="rgba(0, 153, 221, 0.85)";return e},getCalendarDisplayProps:function(){var e;if(this.hasAttachmentType(l.a.PluginType.Calendar)){var t=this.getAttachmentByType(l.a.PluginType.Calendar);e=t.getPlugin().getCalendarDisplayProps(t.getField("calendarID"))}return e},allowTextEditing:function(){var e=!0;return(p.a.android&&this.hasAttachments()||!r.default.vmMain.pluginManager.allowTextEditing(this))&&(e=!1),e},getPreviousItem:function(){var e=this.parent(),t=e.getChildIndex(this);if(t>0)return e.getChild(t-1)},getEls:function(){return this.els}},o.a.defineBase(fn),o.a.extend(fn.prototype,sn),o.a.extend(fn.prototype,on),o.a.extend(fn.prototype,ln(fn));var pn=fn;function gn(e,t,i,a,n,s,o,l,d){this.id=e,this.numItems=0,r.default.Assert(r.default.isFunction(l),"Must supply a valid parser"),this._readonly=!!t,this._isDestructible=!!i,this._enabledFilters=o,this._trackGlobally=!!a,this._requireStoredEls=!!n,this._parser=l,this._owner=d,this._root=void 0,this._data={},this._destroyed=!1,this.init()}gn.prototype={init:function(){o.a.forceBind("updateItems",this),o.a.forceBind("_markPaneDirty",this)},getParser:function(){return this._parser},areFiltersEnabled:function(e){return r.default.isAtLeastOneFlagSet(this._enabledFilters,e)},getEnabledFilters:function(){return this._enabledFilters},isOwner:function(e){return this._owner===e},destroy:function(){r.default.Assert(this._isDestructible,"Item store must be destructible to destroy"),this._destroyed=!0,this.clearStore(),this._root.destroy(),this._root=void 0,this._owner=void 0,o.a.destroy(this)},checkDestroyed:function(){r.default.Assert(!this._destroyed,"Should not be using a destroyed item store")},trackGlobally:function(){return this._trackGlobally},requireStoredEls:function(){return this._requireStoredEls},clearStore:function(){if(this._isDestructible){for(var e in r.default.vmMain.beginUpdateItems(),this._data)this._root&&e===this._root.id||this._data[e].destroy();r.default.vmMain.commitUpdateItems()}this._data={},this._root&&(this._root.items.set([]),this._data[this._root.id]=this._root)},createRoot:function(e,t){return this.checkDestroyed(),this._root=this.createItem(e,t,void 0,{isRoot:!0},ChangeType.None),this._root},setRoot:function(e){this.checkDestroyed(),r.default.Assert(e,"Must specify a valid root item"),r.default.Assert(e.belongsToItemStore(this),"Root item must belong to this item store"),this._root=e},createItem:function(e,t,i,a,n){var s;r.default.Assert(i||a&&a.isRoot,"Must always sepcify a valid parentID when creating a new item"),this.checkDestroyed(),r.default.Assert(!this._data[e],"Should never double-create for the same item, should use update instead"),void 0===n&&(n=ChangeType.None),i&&(s=this._data[i],r.default.Assert(s,"Parent must be valid if defined"));var o={id:e,text:t};if(a)for(var l in a)a.hasOwnProperty(l)&&(o[l]=a[l]);var d=new pn(o,{store:this,parent:s,changeType:n,canDestroy:this._isDestructible,noSave:this._readonly});return this.numItems++,this._data[d.id]=d,d},createItemRaw:function(e,t){r.default.Assert(t.parent||t&&(t.isRoot||t.noSave||t.noParentOkay),"Must always sepcify a valid parentID when creating a new item"),this.checkDestroyed(),r.default.Assert(!!t.canDestroy===this._isDestructible,"When creating raw items, canDestroy must match"),r.default.Assert(!!t.noSave===this._readonly,"When creating raw items, noSave must match"),t.store=this;var i=new pn(e,t);return r.default.Assert(!this._data[i.id],"Should not create an item that already exists in this store"),this._data[i.id]=i,this.numItems++,i},destroyItem:function(e){r.default.Assert(this._isDestructible,"ItemStore must be destructible to destroy items");var t=this._data[e];r.default.Assert(t,"Must always destroy a valid item"),r.default.Assert(!t.isDestroyed(),"Should never destroy an item twice"),t.parent()&&(t.parent().removeChild(t,ChangeType.Local),t.parent(void 0)),t.destroy(),delete this._data[e]},modifyItemID:function(e,t){r.default.Assert(e.belongsToItemStore(this),"Item must belong to this item store"),r.default.Assert(e.id!==t,"Must actually be modifying the item ID"),r.default.Assert(this._data[e.id],"Must have a valid item stored under the current ID: "+e.id+" - "+t+" - "+e.isDestroyed()),r.default.Assert(!this._data[t],"Must not be overwriting an existing item"+e.id+" - "+t+" - "+e.isDestroyed()),delete this._data[e.id],this._data[t]=e},manualModifyItemID:function(e,t){r.default.Assert(!this._data[t],"Must not be overwriting an existing item"+e+" - "+t);var i=this._data[e];r.default.Assert(i,"Must have valid item to change its ID"),i&&(delete this._data[e],this._data[t]=i)},getItem:function(e){return this.checkDestroyed(),this._data[e]},hasItem:function(e){return this.checkDestroyed(),!!this._data[e]},getRoot:function(){return this.checkDestroyed(),this._root},isRoot:function(e){return this.checkDestroyed(),this._root===e},getCount:function(){return this.checkDestroyed(),Object.keys(this._data).length},forEach:function(e){for(var t in this.checkDestroyed(),this._data)this._data[t]&&e(this._data[t])},_markPaneDirty:function(e){e.usesItemStore(this)&&(e===r.default.focusedPane?e.setItemsWillBeDirty():e.setItemsDirty())},updateItems:function(e){e&&!e.belongsToItemStore(this)||(r.default.vmMain.paneManager.runForEachPane(function(t){t.usesItemStore(this)&&(t.preventUpdateItemsForItem&&t.preventUpdateItemsForItem.item===e?t.setItemsWillBeDirty():t.setItemsDirty())}.bind(this)),r.default.vmMain.updateAllItems())},onItemChanged:function(e,t){var i,a=this;e&&!e.belongsToItemStore(this)||r.default.vmMain.paneManager.runForEachPane(function(n){if(n.usesItemStore(a)){var s=n.handleItemChanged(e,t);i=i||s}}),i&&r.default.vmMain.updateAllItems()}},o.a.defineBase(gn);var mn=gn;function vn(){this._itemStores={},this._iteratingStores=!1,this.Events={StoreAdded:"StoreAdded",StoreRemoved:"StoreRemoved"},this.init()}vn.prototype={init:function(){var e=l.a.ItemStoreFilter.Dates|l.a.ItemStoreFilter.Priority;this.registerItemStore("DefaultStore",void 0,{isReadonly:!1,isDestructible:!1,listenToItemStateChanged:!0,enabledFilters:e}),this._tempItemStore=this.registerItemStore("TempStore",void 0,{isReadonly:!0,isDestructible:!0,trackGlobally:!1,noRegister:!0})},registerItemStore:function(e,t,i){r.default.Assert(!this._itemStores[e],"Should only register a single item store per plugin: ",e),r.default.Assert(!this._iteratingStores,"Should never add a store while iterating");var a=!0,n=!0,s=!0,o=!0,d=!1,u=l.a.ItemStoreFilter.None,c=q.a.runParseText.bind(q.a);i&&(void 0!==i.isReadonly&&(a=i.isReadonly),void 0!==i.isDestructible&&(n=i.isDestructible),void 0!==i.enabledFilters&&(u=i.enabledFilters),void 0!==i.parserFn&&(c=i.parserFn),void 0!==i.trackGlobally&&(s=i.trackGlobally),void 0!==i.requireStoredEls&&(o=i.requireStoredEls),void 0!==i.listenToItemStateChanged&&(d=i.listenToItemStateChanged));var h=new mn(e,a,n,s,o,d,u,c,t);return i&&i.noRegister||(this._itemStores[e]=h,this.fireEvent(this.Events.StoreAdded,h.getEnabledFilters(),[h])),h},unregisterItemStore:function(e){r.default.Assert(this._itemStores[e],"Must register an item store before destroying it"),r.default.Assert(!this._iteratingStores,"Should never remove a store while iterating");var t=this._itemStores[e];delete this._itemStores[e],t.destroy(),this.fireEvent(this.Events.StoreRemoved,t.getEnabledFilters(),[t])},getItemStore:function(e){return r.default.Assert(this._itemStores[e],"Must register an item store before using it"),this._itemStores[e]},getDefaultItemStore:function(){return this._itemStores.DefaultStore},getTempItemStore:function(){return this._tempItemStore},runForEachStore:function(e,t){for(var i in t=t||l.a.ItemStoreFilter.None,this._iteratingStores=!0,this._itemStores){var a=this._itemStores[i];if(t===l.a.ItemStoreFilter.None||a.areFiltersEnabled(t))try{e(a)}catch(e){r.default.reportError(e)}}this._iteratingStores=!1}},o.a.defineBase(vn),o.a.extend(vn.prototype,d.a);var _n=vn;function yn(){this._items=new k.a,this._remoteItems=void 0,this._localLoaded=!1,this._cache=r.default.vmMain.cacheManager.registerLocalCache("QuickAdd","QuickAdd",StorageType.IndexedDB),this._itemStore=r.default.vmMain.itemStoreManager.registerItemStore("QuickAdd",this,{isReadonly:!0}),this._itemStore.createRoot("QuickAddRoot","Quick Add"),this._cache.onCacheReady(function(){this._cache.loadAll(function(e,t){e&&this._notifyLocalItems(t)}.bind(this))}.bind(this))}yn.prototype={notifyRemoteItems:function(e){r.default.settings.set(Settings.lastQuickAddSync,new Date),this._localLoaded?(this._remoteItems=void 0,this._cache.onCacheReady(function(){var t=0;r.default.vmMain.beginUpdateItems();for(var i=0;i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=e[i];if(a.dateConsumed)!!this.removeTextEntry(a.quickAddID)&&this._cache.removeEntry(a.quickAddID);else this.addTextEntry(a.quickAddID,a.text,a.note)&&this._cache.cacheEntry(a.quickAddID,{id:a.quickAddID,isPersisted:!0,text:a.text,note:a.note})}r.default.vmMain.commitUpdateItems()}.bind(this))):this._remoteItems=e},_notifyLocalItems:function(e){var t=0;r.default.vmMain.beginUpdateItems();for(var i=0;e&&i<e.length;++i){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=e[i];this.addTextEntry(a.id,a.text,a.note),a.isPersisted||this.persistTextEntry(a.id,!0)}this._localLoaded=!0,this._remoteItems&&this.notifyRemoteItems(this._remoteItems),r.default.vmMain.commitUpdateItems()},runQuickAddSync:function(e){r.default.XHR_PrivateAPI({type:"POST",path:"/quick/list",data:{lastQuickAddSync:this.getLastSyncDate()},requireAuth:!0,cb:function(t){if(t.status===l.a.HTTPStatusCode.Success)try{var i=JSON.parse(t.response).data;i.quickAddItems&&(r.default.Assert(r.default.isArray(i.quickAddItems),"Must be an array of items"),this.notifyRemoteItems(i.quickAddItems))}catch(e){r.default.reportError(e)}e&&e()}.bind(this)})},getLastSyncDate:function(){var e=r.default.settings.get(Settings.lastQuickAddSync);return r.default.Assert(!e||r.default.isString(e),"Must have a valid string sync date"),e},addItemEntry:function(e,t){this.hasItemEntry(e)||this._items.push({id:e.id,item:e,pane:t})},addTextEntry:function(e,t,i){var a=!1;if(!this.hasTextEntry(e)){var n=this._itemStore.getRoot(),s=this._itemStore.createItem(e,t,n.id,ChangeType.Local);n.insertItem(s,0),this._items.push({id:e,isText:!0,item:s,text:t,note:i}),a=!0}return a},removeItemEntry:function(e){var t=this._items.indexOfWithProperty("id",e.id);if(t>=0)return this._items.splice(t,1)[0]},removeTextEntry:function(e){var t=this._items.indexOfWithProperty("id",e);if(t>=0)return this._items.splice(t,1)[0]},hasItemEntry:function(e){var t=this.getItemEntry(e);return!(!t||t.isText)},hasTextEntry:function(e){var t=this.getTextEntry(e);return!(!t||!t.isText)},getItemEntry:function(e){var t=this._items.indexOfWithProperty("id",e.id);return this._items.get()[t]},getTextEntry:function(e){var t=this._items.indexOfWithProperty("id",e);return this._items.get()[t]},getItems:function(){return this._items},_notifyPersisted:function(e){var t=this.getTextEntry(e);t&&this._cache.onCacheReady(function(){this._cache.cacheEntry(e,{id:e,text:t.text,note:t.note,isPersisted:!0})}.bind(this))},_notifyConsumed:function(e){this._cache.onCacheReady(function(){this._cache.removeEntry(e)}.bind(this))},persistTextEntry:function(e,t){j.a.onUserAuthorized("me","DropBucket_persistTextEntry",function(){this._persistTextEntry(e,t)}.bind(this))},_persistTextEntry:function(e,t){r.default.Assert(this.hasTextEntry(e),"Must be persisting a valid text entry");var i=this.getTextEntry(e);if(i){t||this._cache.onCacheReady(function(){this._cache.cacheEntry(e,{id:e,text:i.text,note:i.note,isPersisted:!1})}.bind(this));var a={quickAddID:e,text:i.text};i.note&&(a.note=i.note),r.default.XHR_PrivateAPI({type:"POST",path:"/quick/add",data:a,requireAuth:!0,cb:function(t){if(t.status===l.a.HTTPStatusCode.Success)this._notifyPersisted(e);else if(t.status===l.a.HTTPStatusCode.BadRequest)try{JSON.parse(t.responseText).code===PrivateAPIErrorCodes.AlreadyExists&&this._notifyPersisted(e)}catch(e){r.default.reportError(e)}}.bind(this)})}},consumeTextEntry:function(e){r.default.Assert(this.hasTextEntry(e),"Must be persisting a valid text entry"),this.removeTextEntry(e),this._cache.onCacheReady(function(){this._cache.removeEntry(e)}.bind(this));var t={quickAddID:e};r.default.XHR_PrivateAPI({type:"POST",path:"/quick/consume",data:t,requireAuth:!0,cb:function(t){t.status===l.a.HTTPStatusCode.Success&&this._notifyConsumed(e)}.bind(this)})},hasItems:function(){return this._items.get().length>0}};var Sn=yn,wn=function(){ya.a.init();var e,t={_root:void 0,isLoaded:!1,isRendered:new w.a(!1),isInit:!1,_hasDisplayedArchivedItems:!1,gdriveStatusObs:new w.a(-1),isPhone:p.a.phone,help:void 0,lastActivity:Date.now(),cacheManager:m.a,recurringTaskManager:new Xa,deferredTaskManager:new $a,itemStoreManager:new _n,pluginManager:new va,paneManager:new ba,paneFactory:S.a,docManager:new tn,realtimeDocManager:new xa,vmPicker:new T,_itemAnimationMode:l.a.ItemAnimationMode.Normal,isDisplaySettingsOpen:new w.a(!1),failedInitialDocLoad:new w.a(!1),activeInput:new w.a(null),_isShowingTrashedDocumentError:new w.a(!1),cursor:new w.a,loadedImages:{}};r.default.vmMain=t,t.getUserEmail=function(){return j.a.getDefaultEmail()||r.default.getActiveUser()||void 0},Rollbar.configure({payload:{environment:p.a.getDeployVar(DeployVariable.Environment),person:{id:r.default.getUserIdentifier()},client:{javascript:{source_map_enabled:!0,code_version:__jsVersion,guess_uncaught_frames:!0}}},maxItems:__MAX_ERRORS_REPORTED,checkIgnore:r.default.rollbarIgnoreFn}),t.root=function(){return t._root},t.remoteAPI=function(){return t.pluginManager.getPlugin(PluginID.Moodo)},t.loadPlugins=function(){},t.getDefaultCalendarPlugin=function(){var e,i=t.pluginManager.getPlugin(PluginID.GCalendar);return(r.default.isDemoMode()||i.getSetting(i.Settings.IsEnabled))&&(e=i),e},t.showTrashedDocumentError=function(){t._isShowingTrashedDocumentError.set(!0),t.paneManager.clearLoadTimeout()},t.clearTrashedDocumentError=function(){t._isShowingTrashedDocumentError.set(!1)},t.notifyFailedLoad=function(){h||t.failedInitialDocLoad.set(!0)},t.notifySuccessfulLoad=function(){t.failedInitialDocLoad.set(!1),o.a.hasURLParam("sinfo")&&o.a.removeURLParam("sinfo")},t.getDefaultEmailPlugin=function(){return t.pluginManager.getPlugin(PluginID.Gmail)},t.isOnline=function(){return t.gdriveStatus()!==DriveStatus.Offline},t.isReconnecting=function(){return t.gdriveStatus()===DriveStatus.Reconnecting},t.isLocal=function(){return"localhost"===window.location.hostname},t.canRunUndoRedo=function(){return t.isOnline()||y.a.allowOfflineUndo},t.getUserName=function(){var e;if(t.isDemoMode())e="Demo";else{var i=v.a.authenticatedUser.get();e=i?i.displayName:r.default.settings.get(Settings.displayName)||void 0}return e},t.getUserDomain=function(){},t.getUserID=function(){return j.a.getDefaultGID()||r.default.settings.get(Settings.userId)||void 0},t.isDemoMode=function(){return r.default.isDemoMode()},t.onlineText=function(){var e=t.gdriveStatus();return(r.default.isDemoMode()?"DEMO":e===DriveStatus.Connecting&&"Syncing")||e===DriveStatus.Reconnecting&&"Syncing"||e===DriveStatus.Offline&&"OFFLINE"||e===DriveStatus.Saved&&v.a.isReadOnly()&&"READ ONLY"||e===DriveStatus.Saved&&!1||""},t.handleGapiLoadError=function(){t.setGDriveStatus(DriveStatus.Offline),setTimeout(f.default.goOnline,3e4)},t.connectFailed=function(){t.setGDriveStatus(DriveStatus.Offline),e=void 0,f.default.ensureDocConnection()},t.gdriveStatus=function(){return t.gdriveStatusObs.get()},t.setGDriveStatus=function(i){var a=t.gdriveStatus();i!==a&&i!==DriveStatus.Saving&&(t.gdriveStatusObs.set(i),i===DriveStatus.Connecting||i===DriveStatus.Reconnecting?v.a.loadedOnce&&(clearTimeout(e),e=setTimeout(t.connectFailed,v.a.offlineTimeoutMS)):(clearTimeout(e),e=void 0),i===DriveStatus.Offline?(r.default.goOffline(),r.default.toasts.clearMessage(MessageID.CalendarSync)):a===DriveStatus.Offline&&r.default.goOnline())},t.init=function(){r.default.Assert(!t.isInit,"Should never double init VMMain, may cause severe issues"),t.isInit=!0,r.default.settings._ensureRemoteSettings(),_.default.init(),G.a.init(),t.loadPlugins(),t.dropBucket=new Sn,g.a.fireEvent("VMMainLoaded",[]),g.a.listen("showArchived",function(){t._hasDisplayedArchivedItems||(t._hasDisplayedArchivedItems=!0,t.parseSubtreeArchive(t.root(),ChangeType.Auto))}),p.a.demo||(window.onbeforeunload=t.onUnload)},t.hasDisplayedArchivedItems=function(){return t._hasDisplayedArchivedItems},t.addModifiedItem=function(e,t,i){};var i={},a=!1,n=void 0;t.flushModifiedItems=function(){},t.addParseItem=function(e,t){r.default.Assert(a,"Must be marked as queueing items"),r.default.Assert(t===n,"ChangeType of queue must match"),i[e.id]=e},t.beginQueuedParseItems=function(e){r.default.Assert(!a,"Should not be already queueing parse items"),a||(a=!0,n=e)},t.flushParseItems=function(){if(r.default.Assert(a,"Must be marked as queueing items before flushing"),a){a=!1;try{for(var e in i){var s=i[e];t.runSingleParse(s,n)}}catch(e){r.default.reportError(e)}i={},n=void 0}},t.parseSubtree=function(e,i){var a=0;r.default.Assert(e,"Must supply a valid item to parse"),t.runSingleParse(e,i);for(var n=e.getItems(),s=0;s<n.length;s++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;t.parseSubtree(n[s],i)}},t.parseSubtreeArchive=function(e,i){var a=0;r.default.Assert(e,"Must supply a valid item to parse"),t.runSingleParse(e,i);for(var n=e.getItems(),s=0;s<n.length;s++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;t.parseSubtreeArchive(n[s],i)}if(e.hasArchivedChildren()){var o=0,l=e.archivedItems(!0);for(s=0;s<l.length;s++){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;t.parseSubtreeArchive(l[s],i)}}},t.runFnOnSubtree=function(e,i){var a=0;i(e);for(var n=e.getItems(),s=0;s<n.length;s++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;t.runFnOnSubtree(n[s],i)}if(e.hasArchivedChildren()){var r=0,o=e.archivedItems(!0);for(s=0;s<o.length;s++){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;t.runFnOnSubtree(o[s],i)}}},t.runSingleParse=function(e,t){r.default.Assert(e,"Must have a valid item to parse"),r.default.Assert(!a,"Should not run single parse while queueing item parses");var i={};e.parseText(!0,t,i)&&e.save(i,SaveFlag.None)},t.createWorkerFromObj=function(e,t,i){var a;try{(a=new Worker(e)).onmessage=t,a.onerror=i}catch(e){r.default.reportError(e)}return a},t.createWorkerFromFnList=function(e,i,a){r.default.Assert(!p.a.ie,"IE does not support creating workers from blob URLs");var n=[];try{for(var s=0,o=0;o<e.length;++o){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;n.push(window[e[o]].toString()),n.push(e[o]+"();")}}catch(e){r.default.reportError(e)}return t.createWorkerFromStrings(n,i,a)},t.createWorkerFromStrings=function(e,i,a){var n=p.a.URL.createObjectURL(new Blob(e,{type:"text/javascript"}));return t.createWorkerFromObj(n,i,a)};var d=0,u=0,c=void 0;t.runDateRollover=function(){r.default.Assert(t.isLoaded,"Expect that we have fully loaded the page before performing rollover");var e=d-new Date;function i(){t.root()&&t.parseSubtree(t.root(),ChangeType.Auto|ChangeType.Rollover),V.default.clearItemCache(),V.default.clearLineCache(),t.updateAllItems(!1,!0),r.default.timeline.updateNotifications(),log("-------------------------------")}if(log("---- Running Date Rollover: "+e+" ----"),u=new Date,d=0,clearTimeout(c),c=void 0,t.setupDateRollover(),Date.Parsing.Normalizer.buildReplaceData(),r.default.timeline.clearDailyCaches(),r.default.settings.get(Settings.syncContacts)){var a=setTimeout(function(){i()},1e4);f.default.loadedContacts=!1,f.default.loadContacts(function(){clearTimeout(a),a=void 0,i()})}else i();g.a.fireEvent("dateChanged",[])},t.setupDateRollover=function(){r.default.Assert(!c,"Should never reschedule a date rollover over another one");var e=new Date,i=e.clone().addDays(1).clearTime();r.default.Assert(i>e,"Rollover time must be in the future"),r.default.Assert(i>u,"Rollover time must be after the last rollover"),log("Rollover Run Time: ",e),log("Next Rollover Time: ",i),c=setTimeout(t.runDateRollover,i-e),d=i},t.ensureDateRollover=function(){setTimeout(function(){var e=new Date;d-e<0&&t.runDateRollover()},1e4)};var h=!1;t.notifyDriveDisconnect=function(){h=!1,y.a.resetAggregateActionCount()},t.notifyDriveOperationError=function(){y.a.resetAggregateActionCount()},t.loadGDriveData=function(){if(!h){r.default.Assert(s.default.localDataLoaded(),"Must have already loaded local data from db"),r.default.Assert(!0===r.default.vmMain.isLoaded,"Must have already loaded local data"),h=!0;var e,i=v.a.rootItem;try{if(!t.root()){s.default.createRootItem(i.id);var a=s.default.createVMLI(s.default.getRootItem(),{changeType:ChangeType.Auto,isRoot:!0});r.default.vmMain.itemStoreManager.getDefaultItemStore().setRoot(a),t._root=a}t.root().linkToGDrive(i)}catch(e){r.default.reportError(e),r.default.menus.alert({text:"There was a fatal error in the application. Please reload to try again.",actionText:"RELOAD",callback:r.default.reload})}try{v.a.checkRemoteIntegrity()}catch(e){r.default.reportError(e)}M.a.isValid()&&(e=M.a.save(),M.a.reset()),r.default.vmMain.beginUpdateItems(),function(e){r.default.isLoadingRemote=!0;try{s.default.beginTransaction(),r.default.settings.get(Settings.lastServerVersion)===v.a.getServerVersion()?r.default.sendEvent("PageLoad","VersionMatch"):(log("Client and Server versions do not match!"),r.default.sendEvent("PageLoad","VersionDiff")),y.a.beginAction(!0),!1===r.default.settings.get(Settings.localIntegrity)&&(ShouldLog(LogLevels.Warning)&&log("Previous remote sync had an issue!"),r.default.reportError(new Error("Previous remote sync had an issue!"))),v.a.loadSeen={},t.beginQueuedParseItems(ChangeType.Remote|ChangeType.DocLoad|ChangeType.All);try{t.root().initFromGDrive(e)}catch(e){r.default.settings.set(Settings.localIntegrity,!1)}v.a.loadSeen={},y.a.endAction(),ShouldLog(LogLevels.Timing)&&log("Drive done init",log.now()),t.flushParseItems(),t.flushModifiedItems(),log("Pending Updates: "+Object.keys(s.default.pendingRemoteUpdates).length),g.a.fireEvent("remoteDataLoaded",[]),setTimeout(function(){},5e3)}catch(e){r.default.reportError(e),r.default.toasts.pushMessage({text:"There was an error loading your data from the server. Please try again.",action:MessageAction.Reload})}finally{s.default.endTransaction(),r.default.isLoadingRemote=!1}}(i),r.default.vmMain.commitUpdateItems(),v.a.lastChangeTime.set(Date.now()),e&&M.a.restore(e),g.a.fireEvent("gdataLoaded",[]),t.vmPicker.refreshFiles()}};var I,b=!1;t.loadDemoContacts=function(e){for(var t,i,a=0,n=[],r=0,o=0;o<e.length;o++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;t=e[o],i="test-"+t.split(" ")[0].toLowerCase()+"@moo.do",n.push({id:"contact_"+r++,name:t,isDemo:!0,emails:[{address:i,primary:!0}],phoneNumbers:[{number:"(555) 123-4567",type:"mobile"}]})}s.default.contactManager.loadContacts(n,!0)},t.loadData=function(){if(!b){if(r.default.Assert(s.default.localDataLoaded(),"Must have already loaded local data"),ShouldLog(LogLevels.Timing))var e=log.now();if(b=!0,t.isDemoMode()&&t.loadDemoContacts(["Jay","Grant","Ramada","Canyon Ranch","Jim Joseph","Miller Harris","Bob Johnson","Bill Wilson","Emily Edwards","Jane Johnson","Mike Thomas","Joe Lewis","Steve","Melissa","Mikey","Bart","Dad","Mom","James Rhodes","Neptures","Pepper","President Ellis","Contacts","Jane"]),s.default.getRootItem()){r.default.vmMain.beginUpdateItems();var i=s.default.createVMLI(s.default.getRootItem(),{changeType:ChangeType.Auto,isRoot:!0});r.default.vmMain.itemStoreManager.getDefaultItemStore().setRoot(i),t._root=i,r.default.vmMain.commitUpdateItems()}r.default.checkpoint(Checkpoint.LocalDocLoad),t.isLoaded=!0,r.default.requireGDriveDataCallback&&t.loadGDriveData(),ShouldLog(LogLevels.Timing)&&log("Run loading/parseWorker",log.now()),r.default.vmSetup.initDemo(),setTimeout(function(){t.isDemoMode()&&(p.a.script&&r.default.vmSetup.runScript(o.a.getURLParam("script")),window.parent.postMessage("loaded","*"))},0),t.pluginManager.notifyDependencyLoad(PluginDependency.LocalLoaded),s.default.getRootItem()?t.afterLoaded():g.a.listen("gdataLoaded",function(){t.afterLoaded()}),t.isRendered.set(!0),t.isDemoMode()&&p.a.script&&r.default.setupClick(document.getElementById("container"),t,t.onTapMain),p.a.app&&r.default.nativeBridge.sendToApp("localLoaded"),ShouldLog(LogLevels.Timing)&&(log("DONE LOCALLY",log.now()),setTimeout(function(){var t=log.now();log("time react:",t-e,t)},0))}},t.changeRoot=function(e){r.default.Assert(e,"Cannot use to reset root to undefined");var i=s.default.getModel(e);i||(i=s.default.createVMLI(s.default.getItem(e),{changeType:ChangeType.Auto,isRoot:!0})),r.default.Assert(i,"Must have a new root VMLI at this point, otherwise failed creation"),i&&(t.itemStoreManager.getDefaultItemStore().setRoot(i),t._root=i,t.paneManager.runForEachPane(function(e){M.a.reset(),e.setItem(i)}))},t.resetScrollOffsets=function(){t.paneManager.runForEachPane(function(e){e.setScrollOffset(e.defaultOffset)})},t.onTapMain={onStart:function(){r.default.fireCustomEvent("tapMain")},onClick:function(){r.default.Assert(t.isDemoMode()&&p.a.script,"Tap handler should only be active on demo page"),window.parent.postMessage("click","*")}},t.afterLoaded=function(){t.paneManager.loadInitialState(),r.default.keyboardToolbar=L,p.a.app&&(document.onreadystatechange=function(){r.default.nativeBridge.sendToApp("kbsize"),r.default.nativeBridge.sendToApp("loaded")},document.onreadystatechange()),r.default.timeline.updateNotifications()},t.switchPaneMobile=function(e,i,a){an.default.clearSelection(),We.default.stop(),We.default.finish(),r.default.vmMain.beginUpdateItems();var n=t.paneManager.swapToPane(e,i,a);r.default.keyboardToolbar.hide(),M.a.setFocusedPane(n),r.default.vmMain.commitUpdateItems()},t.zoomin=function(e,i,a,n){r.default.Assert(e,"Must supply a valid item to zoom to");var s=r.default.focusedPane,o=s&&s.item.get();t._zoom(e,i),e.isDemandLoad()&&e.notifyDemandLoadUpdate(!0,s),i||r.default.sendEvent("Menu","ZoomIn"),s.isLoaded&&s.onZoom(),i||y.a.performAction(TrackerType.Zoom,{itemID:e.id,oldItemID:o.id,zoomIn:!0,time:r.default.zoomTime,pane:s}),a&&r.default.toasts.pushMessage({text:"Zoomed into "+e.getParsedTextWithoutPrefix(),actionText:"UNDO",hold:!1,action:function(){t.zoomin(o)}.bind(this)})},t.zoomout=function(e,i){r.default.Assert(e,"Must supply a valid item to zoom to");var a=r.default.focusedPane,n=a&&a.item.get();M.a.save()||M.a.getPreviousSelection(),t._zoom(e,!1),r.default.sendEvent("Menu","ZoomOut"),i||y.a.performAction(TrackerType.Zoom,{itemID:e.id,oldItemID:n.id,zoomOut:!0,time:r.default.zoomTime,pane:a})},t._zoom=function(e,i){r.default.Assert(e,"Must supply a valid item to zoom to");var a=r.default.focusedPane,n=a&&a.item.get();n&&n.id===e.id||(M.a.reset(),a.setItem(e,!0),r.default.focusedItem=e,i||t.paneManager.updatePaneStateForPane(r.default.focusedPane))},t.applyFormatToSelection=function(e){var i,a,n=!1;r.default.vmMain.setItemAnimationMode(l.a.ItemAnimationMode.None),t.applyToSelection(function(t,s,r){var o=0===s?M.a.getStartOffset():0,d=s===r-1?M.a.getEndOffset():t.getParsedText().length,u=t.applyFormatToSelection(e,o,d,0===s?l.a.SetMode.Toggle:n?l.a.SetMode.Yes:l.a.SetMode.No);0===s&&(n=u.didSet,i=u.selStart),s===r-1&&(a=u.selEnd)}),M.a.selectIndices(M.a.getStartIndex(),i,M.a.getEndIndex(),a),r.default.vmMain.resetItemAnimationMode()},t.applyPrefixToSelection=function(e,i){var a,n;if(M.a.isValid()&&(a=M.a.getStartItem().getPrefixLength(),n=M.a.getEndItem().getPrefixLength()),i)e=i.prefix===e?null:e,i.setPrefix(e);else{var s=!0;t.applyToSelection(function(t){if(t.prefix!==e)return s=!1,!1}),s&&(e=null),t.applyFnToSelection("setPrefix",{value:e,noRestoreSel:!0})}if(!isNaN(a)){var r=M.a.getStartItem().getPrefixLength()-a,o=M.a.getEndItem().getPrefixLength()-n;r||o?M.a.selectIndices(M.a.getStartIndex(),M.a.getStartOffset()+r,M.a.getEndIndex(),M.a.getEndOffset()+o):M.a.updateCaret()}},t.applyFnToSelection=function(e,i){var a=M.a.save(),n=i&&i.toggle,s=!i||void 0===i.value||i.value,o=i&&void 0!==i.value2?i.value2:void 0;if(t.applyToSelection(function(t){n&&t[e]()!==s&&(n=!1),n||t[e](s,o)}),n){var l=l=!(!i||void 0===i.emptyValue)&&i.emptyValue;t.applyToSelection(function(t){t[e](l,o)})}a&&!i.noRestoreSel&&r.default.focusedPane.restoreSelection(a)},t.applyToSelection=function(e,i){var a=0;r.default.Assert(!i||!i.restoreSelection,"restoreSelection is no longer a valid option"),y.a.beginAction();var n=M.a.getSelectedObjects();i&&i.resetSelection&&M.a.reset(),t.beginUpdateItems();for(var s=0;s<n.length;++s){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(!1===e(n[s].item,s,n.length,n[s]))break}return t.commitUpdateItems(),y.a.endAction(),n.length},t.updateCursorFromEvent=function(e){if(I){var i=I.target;if(i&&r.default.isAttachedToDoc(i)){var a=r.default.getPaneForElement(i);if(a){var n=r.default.elementFromPoint(I.clientX,I.clientY,I.target);if(n){var s=r.default.getItemForElement(n);t.updateCursor(e,a,n,s)}}}}},t.getCursorForClass=function(e,t,i){for(var a=0,n=e.classList,s=0;s<n.length;s++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;switch(n[s]){case"link":case"date":case"plugin":return p.a.mac&&t.metaKey||!p.a.mac&&t.ctrlKey?"cursor-pointer":null}}if(i)return"cursor-pointer"},t.updateCursor=function(e,i,a,n){var s;if(i&&a){if(n&&r.default.isVMLI(n)){var o=r.default.findParentInItem(a,"plugin");o&&(a=o)}var d=!!r.default.findParent(a,"paneOverviewScroller");if(!M.a.isMouseDown()&&!(s=t.getCursorForClass(a,e,d))){var u=r.default.findParent(a,"itemInCalendarResizable");if(u){var c=u.getBoundingClientRect(),h=Math.min(l.a.CalendarResizeHandleHeight,c.height/3);(e.clientY-c.top<h||c.bottom-e.clientY<h)&&(s="cursor-row-resize")}}}t.cursor.set(s)},p.a.touch||(t.redoLastMouseMove=function(){var e=I,i={target:document.elementFromPoint(e.clientX,e.clientY),clientX:e.clientX,clientY:e.clientY};t.mousemove(i,!0)},t.mousemove=function(e,i){if(t.notifyActivity(),!(r.default.disableMouseMove&&!e.target||t.paneManager.isResizingPane||!i&&I&&e.clientX===I.clientX&&e.clientY===I.clientY||We.default.isDragging)){var a,n,s,o=r.default.ensureDOMNode(e.target);o?((r.default.findParent(o,"paneRoot")||r.default.findParent(o,"paneOverviewScroller"))&&(s=r.default.getPaneForElement(o))&&(a=r.default.getItemForElement(o))&&(n=r.default.getListCellForElement(o)),t.updateCursor(e,s,o,a),M.a.setHovered(s,a,n),I&&I.target===o||(I&&I.target&&g.a.fireEvent("mouseout",[{target:I.target}]),o&&g.a.fireEvent("mouseover",[{clientX:e.clientX,clientY:e.clientY,target:o}])),I={clientX:e.clientX,clientY:e.clientY,target:o}):r.default.Assert(!o,"Target should be defined",r.default.getElementPath(e.target))}},r.default.element("outerWrapper").addEventListener("mousemove",t.mousemove)),t.showHelp=function(e){r.default.intro.show(e)},t.runAfterWelcome=function(){t.paneManager.createDefaultPane(),r.default.intro.runTooltipIntro()},t.runFirstRun=function(){},t.oldUserNewTrial=function(){r.default.toasts.pushMessage(MessageID.OldUserNewTrial)};var A=void 0;var D=void 0,C=r.default.seconds(5);t.notifyActivity=function(){t.lastActivity=Date.now(),D||(D=setTimeout(t.checkLowActivity,2*C)),t.whenLowImpactEnd()},t.checkLowActivity=function(){Date.now()-t.lastActivity>C&&t.whenLowImpactBegin(),D=void 0};var P=!1;if(t.whenLowImpactBegin=function(){P||(P=!0,g.a.fireEvent("lowImpactBegin",[]))},t.whenLowImpactEnd=function(){P&&(g.a.fireEvent("lowImpactEnd",[]),P=!1)},t.isLowImpact=function(){return P},t.isDemoMode()||(p.a.pageVisibilityChange&&document.addEventListener(p.a.pageVisibilityChange,function(){p.a.isPageVisible()?(A&&(clearTimeout(A),A=void 0),t.whenLowImpactEnd()):A=setTimeout(function(){r.default.AppCache.checkForUpdate(!1,!0),r.default.vmMain.pluginManager.writeCaches(),t.whenLowImpactBegin()},5e3)}),t.checkLowActivity()),t.paneManager.onResize(),r.default.shouldWriteLocal()){var E=+o.a.storage.getItem("versionMobile"),k=p.a.versionMobile;if(!r.default.isFirstRun&&!r.default.isDemoMode()&&(!E||k>E))for(var x=0,R=p.a.getUpdateMessages(E),O=0;O<R.length;++O){if(x++>5e3&&__infLoop&&__infLoop(x))throw new RangeError;if(r.default.isString(R[O]))r.default.toasts.pushMessage({text:R[O],hold:!0,action:MessageAction.Blog});else{r.default.Assert(r.default.isFunction(R[O]),"Must supply a valid getter fn for the message");var F=R[O]();F.isPremiumOnly&&!r.default.billingManager.hasPremium()||r.default.toasts.pushMessage({text:F.text,hold:!0,action:F.action||MessageAction.Blog,actionText:F.actionText})}}o.a.storage.setItem("versionMobile",k)}function N(){log("Last Update Items Stack: "+t._lastUpdateItemsStack),r.default.Assert(!1,"Update Watchdog Triggered - This should never happen.",t._isWaitingUpdateItems),t._isWaitingUpdateItems=1,t.commitUpdateItems()}return p.a.displayRepeatedOptionalUpdateMessage(),t._updateAllItems=function(){var e=t._forceNotify;t._forceNotify=!1;var i=t._updateSearch;t._updateSearch=!1,(t._itemsDirty||e)&&(t._itemsDirty=!1,t._isUpdating=!0,t.paneManager.runForEachPane(function(t){(e||t.isItemsDirty())&&t.updateItemsImmediate(i,e)}),t._isUpdating=!1)},t._isSearching=!1,t._isUpdating=!1,t._numFlushesInCommit=0,t._isWaitingUpdateItems=0,t._itemsDirty=!1,t._forceNotify=!1,t._updateSearch=!1,t._itemsUpdateWatchdog=void 0,t._lastUpdateItemsStack=void 0,t.isUpdatingItems=function(){return t._isWaitingUpdateItems>0&&t._itemsDirty},t.beginUpdateItems=function(){t._isWaitingUpdateItems++,1===t._isWaitingUpdateItems&&(t._lastUpdateItemsStack=r.default.getCurrentStack("Update Items Stack"),t._itemsUpdateWatchdog=setTimeout(N,0))},t.commitUpdateItems=function(e,i){r.default.Assert(t._isWaitingUpdateItems>0,"Missing a call to beginUpdateItems: ",t._isWaitingUpdateItems),t._isWaitingUpdateItems--,0===t._isWaitingUpdateItems&&(clearTimeout(t._itemsUpdateWatchdog),t._itemsUpdateWatchdog=void 0,t._lastUpdateItemsStack=void 0,t._numFlushesInCommit=0),t._itemsDirty&&t.updateAllItems(e,i)},t.flushItemsUpdate=function(e){t.isUpdatingItems()&&(e?e.isItemsDirty()&&(t._itemsDirty||t._forceNotify)&&(t._numFlushesInCommit++,e.updateItemsImmediate(t._updateSearch,t._forceNotify)):(t._numFlushesInCommit++,t._updateAllItems()))},t.updateAllItems=function(e,i){r.default.Assert(void 0===e||r.default.isBoolean(e),"Must supply a bool param for updateSearch"),r.default.Assert(void 0===i||r.default.isBoolean(i),"Must supply a bool param for forceNotify"),t._itemsDirty=!0,i&&(t._forceNotify=i),e&&(t._updateSearch=e),0===t._isWaitingUpdateItems&&t._updateAllItems()},t.notifySearchStart=function(){t._isSearching=!0},t.notifySearchEnd=function(){t._isSearching=!1},t.getItemAnimationMode=function(){return t._itemAnimationMode},t.setItemAnimationMode=function(e){t._itemAnimationMode=e},t.resetItemAnimationMode=function(){t._itemAnimationMode=l.a.ItemAnimationMode.Normal},t.getScrollOffset=function(){return t.panesContainer.scrollLeft},t.setScrollOffset=function(e,i){r.default.scrollTo(e,0,i||ScrollDuration.Default,t.panesContainer)},t.shouldShowHelp=function(e){var t=r.default.settings.get(Settings.closedHelps);return!t||!t[e]},t.closeHelp=function(e){var t=r.default.settings.get(Settings.closedHelps)||{};(t=r.default.clone(t))[e]=!0,r.default.settings.set(Settings.closedHelps,t)},t.uncloseHelp=function(e){var t=r.default.settings.get(Settings.closedHelps)||{};delete(t=r.default.clone(t))[e],r.default.settings.set(Settings.closedHelps,t)},t.beginCompleteAction=function(){t._isInCompleteAction=!0},t.isInCompleteAction=function(){return t._isInCompleteAction},t.endCompleteAction=function(){t._isInCompleteAction=!1},t.onUnload=function(){log("Unloading the page");try{var e,i=r.default.getAggregateEvents();for(var a in i)if(i.hasOwnProperty(a)){var n=i[a];r.default.sendEvent(n.category,n.action,n.count),n.count=0}if(r.default.failedGapiLoad?r.default.sendEvent("ScriptLoad","GapiFailed"):window.gapiCalled||r.default.sendEvent("ScriptLoad","GapiNotLoaded"),g.a.fireEvent("onUnload",[]),r.default.settings.get(Settings.gdocId)&&t.paneManager.savePaneState(),r.default.hasPageDataBeenCleared())t.pluginManager&&(e=t.pluginManager.onShutdown(!1));else{t&&t.pluginManager&&(e=t.pluginManager.onShutdown(!0));try{v.a&&r.default.settings&&r.default.settings.set(Settings.lastServerVersion,v.a.getServerVersion())}catch(e){}}if(r.default.UIAction("PageUnload"),r.default.isLoadingRemote)return"We are still syncing your changes. Do you still want to quit?";if(r.default.isSendingEmail)return"Some emails have not been sent. Closing Moo.do will stop them from sending. Do you still want to quit?";if(r.default.isSavingDrafts)return"Your drafts are still being saved. Do you still want to quit?";if(v.a&&v.a.hasPotentialUnsavedData()&&!r.default.hasPageDataBeenCleared())return"You have made changes that have not been saved to the server. Do you still want to quit?";if(e)return e[0]}catch(e){r.default.reportError(e)}},t.getAppInfo=function(e){var i="Loaded";r.default.failedGapiLoad?i="ErrorLoading":window.gapiCalled||(i="NotLoaded");var a=Date.now();e.gapiStatus=i,e.gapiTimeout=window.gapiTimeout,e.sessionID=window.__SESSION_ID,e.sessionStart=window.__SESSION_BEGIN,e.reportTime=a,e.runningTime=a-window.__SESSION_BEGIN,e.appCacheUpdated=r.default.wasAppCacheUpdated,e.realtimeLoadStatus=this.computeRealtimeLoadStatus(),p.a.getPlatformInfo(e),t.getRunningState(e),t.getAppStats(e),t.getPremiumInfo(e);try{v.a.getState(e)}catch(t){e.gState="ERROR"}try{f.default.getTokenStats(e)}catch(t){e.tokenStats="ERROR"}try{f.default.getOAuthData(e)}catch(t){e.oauthData="ERROR"}try{s.default.getDBState(e)}catch(t){e.dbState="ERROR"}try{if(window.gapi&&window.gapi.auth){var n=gapi.auth.getToken();n?(e.tokenScope=n.scope,e.hasIDToken=!!n.id_token):(e.tokenScope="NO TOKEN",e.hasIDToken="NO TOKEN")}else e.tokenScope="NOT LOADED"}catch(t){e.tokenScope="ERROR"}try{e.linkedAccounts=j.a.getInfo()}catch(t){e.linkedAccounts="ERROR"}try{e.cacheState=m.a.getInfo()}catch(t){e.cacheState="ERROR"}},t.getRunningState=function(e){var i;try{t.paneManager.hasLoadedPaneState()&&(i=t.paneManager.getPaneState())}catch(e){log("Failed to get paneState")}e.isDebug=!1,e.isDemo=r.default.isDemoMode(),e.localWrites=r.default.shouldWriteLocal(),e.authUserLoggedIn=r.default.authUserLoggedIn,e.currentLocalWrites=function(){try{o.a.storage.setItem("poke",Math.random())}catch(e){return!1}return!0},e.isReconnected=r.default.isReconnected,e.url=r.default.sanitizeURL(window.location.href),e.paneState=i?r.default.sanitizePaneState(i):"Missing Pane State",e.localSettings=r.default.settings?r.default.sanitizeLocalSettings(r.default.settings.getRawSettings()):"Not Initialized",e.remoteSettingsLoaded=!!r.default.settings&&r.default.settings.hasLoadedRemote(),e.loginState=r.default.getLoginState(),e.checkpoints=window.__checkpoints,e.gapiLoadError=window.gapiLoadError,e.gapiTimeout=window.gapiTimeout,e.gapiClientLoadError=window.gapiClientLoadError,e.gapiClientTimeout=window.gapiClientTimeout,e.DOMReadyState=document.readyState,e.isKeyboardOpen=r.default.isKeyboardOpen,e.localStorageQuotaError=o.a.localStorageQuotaError,e.jsVersion=window.__jsVersion,e.htmlVersion=document&&document.body?document.body.getAttribute("ver"):"UNKNOWN",e.windowWidth=window.innerWidth,e.windowHeight=window.innerHeight,e.eventStream=r.default.getEventStream(),e.trackerStream=y.a.stringifyGroups(),e.criticalErrorReported=r.default.criticalErrorReported(),r.default.getLoadedScripts(e);try{e.nativesel=r.default.parseExtra(window.getSelection())}catch(t){e.nativesel="Error: "+t.message}try{e.apiStats=r.default.getGoogleAPIStats()}catch(t){e.apiStats="Error: "+t.message}try{e.customsel=M.a.dumpState()}catch(t){e.customsel="Error: "+t.message}try{e.errorPlatformInfo=JSON.stringify(r.default.errorPlatformInfo)}catch(t){e.errorPlatformInfo="Error: "+t.message}try{e.validScreens=JSON.stringify(window.Screens)}catch(t){e.validScreens="Error: "+t.message}e.isBatchingUpdateItems=t.isUpdatingItems(),e.lastActivity=t.lastActivity,t.root()?e.rootId=t.root().id:e.rootId="Undefined Root"},t.getPremiumInfo=function(e){if(r.default.billingManager){var t={premiumStatus:r.default.billingManager.getPremiumStatus(),billingIdentifier:r.default.billingManager.getBillingIdentifier(),btRequested:r.default.billingManager._braintreeRequested,btLoaded:r.default.billingManager._braintreeLoaded,ctRequested:r.default.billingManager._clientTokenRequested,ctLoaded:r.default.billingManager._clientTokenLoaded,lastSignupError:r.default.billingManager._lastSignupError};e.premiumInfo=t}else e.premiumInfo="Billing Manager Not Loaded"},t.computeRealtimeLoadStatus=function(){return{gapi:!!window.gapi,auth:!(!window.gapi||!window.gapi.auth),client:!(!window.gapi||!window.gapi.client),drive:!(!window.gapi||!window.gapi.drive),realtime:!!(window.gapi&&window.gapi.drive&&window.gapi.drive.realtime),load:!!(window.gapi&&window.gapi.drive&&window.gapi.drive.realtime&&r.default.isFunction(window.gapi.drive.realtime.load))}},t.getAppStats=function(e){if(e.numPanes=window.__TOTAL_PANES,e.numItems=window.__TOTAL_ITEMS,e.numArchivedItems=window.__TOTAL_ARCHIVED_ITEMS,e.numArchiveParents=window.__TOTAL_ARCHIVE_PARENTS,e.parseTextCalls=window.__PARSE_STATS,e.textChangedUpdates=window.__TEXT_CHANGED_UPDATES,e.notificationUpdatesFull=window.__FULL_NOTIFICATION_UPDATES,e.notificationUpdatesSingle=window.__SINGLE_NOTIFICATION_UPDATES,e.XHRStats=r.default.getXHRStats(),t.pluginManager){try{e.pluginStats=t.pluginManager.getStats()}catch(t){e.pluginStats="Error: "+t.message}try{e.pluginState=t.pluginManager.getState()}catch(t){e.pluginState="Error: "+t.message}}if(t.recurringTaskManager)try{e.taskStats=t.recurringTaskManager.getStats()}catch(t){e.taskStats="Error: "+t.message}try{e.measureStats=V.default.getMeasureStats()}catch(t){e.measureStats="Error: "+t.message}},t.XHR_PrivateAPI=function(e){r.default.Assert(e.type,"Must supply a valid type"),r.default.Assert(e.path&&e.path.startsWith("/"),"Must supply a valid path"+e.path);var i=p.a.getDeployVar(DeployVariable.APIProtocol),a=p.a.getDeployVar(DeployVariable.APIHost);if(e.requireAuth){var n;if(j.a.isCurrentlyAuthorized("me")||(delete(n=r.default.clone(j.a._getAccountTokenRaw("me"))).login_hint,delete n.access_token,delete n.id_token,delete n.client_id),r.default.Assert(j.a.isCurrentlyAuthorized("me"),"Must have a valid auth token before making API calls",n),!j.a.isCurrentlyAuthorized("me"))return void j.a.onUserAuthorized("me","XHR_PrivateAPI",function(){t.XHR_PrivateAPI(e)});var s=j.a.getDefaultIDToken();r.default.Assert(s,"Must have a valid ID token");var o=j.a.getDefaultAccessToken();r.default.Assert(o,"If account is authorized it must have a valid token");var l=j.a.getAccountGID("me");r.default.Assert(l,"If account is authorized it must have a valid GID");var d=j.a.getAccountTokenSync("me");r.default.Assert(j.a.isTokenValid(d),"Must have a valid account token: ",d),e.headers||(e.headers={}),r.default.Assert(!e.headers.token,"Callers should not be setting access token themselves"),r.default.Assert(!e.headers.id_token,"Callers should not be setting id_token themselves"),r.default.Assert(!e.headers.gid,"Callers should not be setting user GID themselves"),s&&(e.headers.id_token=s),e.headers.token=o,e.headers.gid=l}var u={type:e.type,url:i+a+"/private/v1"+e.path,data:e.data,cb:e.cb,headers:e.headers,autoRetry:e.autoRetry,maxRetries:e.maxRetries};r.default.XHR(u)},t.reportData=function(e){s.default.reportData(e)},t.onImageLoaded=function(e,i,a){var n=e.id+r.default.hashCode(i);t.loadedImages[n]||(t.loadedImages[n]=!0,V.default.measureImage(a.target),rn.a.beginBatch(e),V.default.clearCacheForItem(e.id),g.a.fireEvent("imageLoaded",[e]))},t.checkDragForScroll=function(e){var t=r.default.element("panes"),i=t.scrollLeft,a=t.clientWidth,n=a-80,s=0;e.clientX<80&&i>0?s=r.default.computeScrollSpeed(0,80,e.clientX,4,-1):e.clientX>=n&&i<t.scrollWidth-t.clientWidth&&(s=r.default.computeScrollSpeed(n,a,e.clientX,4)),0!==s?r.default.repeatScroll("panes",s,void 0,!0):r.default.cancelRepeatScroll("panes")},t.pluginManager.registerPlugins(),t.init(),t};function In(){this.hasSelection=!1,this.isTyping=!1,this.isRunning=!1,this.isDisabled=!1,this.isPaused=!1,this.stoppedFromPause=!1,this.activeScript=void 0,this.index=0,this.repeat=!1,this.onScriptDone=void 0,this.selectedItem=void 0,this.lastLoadedData=void 0,this.savedItems={},this.typingSpeed=30,this._scriptQueue=[],this.startText={},this.demoCaption=new w.a,r.default.isDemoMode()&&window.addEventListener("message",function e(t){if(t.data&&r.default.isString(t.data)&&t.data.indexOf("{")<0)for(var i=0,a=t.data.split("&"),n=0;n<a.length;n++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var s=a[n].split("=");switch(r.default.Assert(s.length>=0,"Invalid number of params in message"),s[0]){case"script":this.runScript(s[1]);break;case"data":if(this.isRunning)return this.stop(),clearTimeout(this.timeoutMessage),void(this.timeoutMessage=setTimeout(e.bind(this),100,t));this.loadScriptData(s[1]);break;case"start":this.start();break;case"stop":this.stop();break;case"pause":this.pause();break;case"resume":this.resume();break;case"restart":this.restart();break;case"alertDemo":r.default.menus.alert({text:'Click anywhere to try this <b class="blue">live demo</b>',callback:r.default.emptyFn});break;case"help":"1"===s[1]?r.default.vmMain.showHelp(l.a.HelpMode.Normal):r.default.intro.close();break;case"panes":this.loadPanes(s[1])}}}.bind(this),!1),window.pauseScript=function(){this.isDisabled||(log("pause script"),this.isDisabled=!0)}.bind(this)}var bn=function(){this.queue.apply(this,arguments)},An=function(e,t,i,a){if(bn("createItemAfter",void 0,t),void 0!==i&&0!==i)for(var n=0,s=0;s<Math.abs(i);s++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;bn("indent",i<0)}bn(a?"setText":"typeString",void 0,e)},Dn=function(e){bn("delay",e)};In.prototype={runScript:function(e){if(!this.isDisabled){0;var t=this.createScript(e);switch(this.activeScript=t,e){case"wait":this.demoEmpty(t);break;case"introEmail":this.demoEmail(t);break;case"introStyle":this.demoStyle(t);break;case"press":this.demoPress(t);break;case"none":return void this.notify("demoReady")}0,t.runQueue.length>0?this._scriptQueue.push(t):r.default.Assert(!1,"Invalid script request: ",e),this.repeat=!1,this.activeScript=this._scriptQueue[0],!this.isRunning&&this.activeScript&&this.start()}},start:function(){r.default.toasts.clearMessage(MessageID.ThisIsDemo),this.onScriptStart(this.activeScript),this.run()},restart:function(){this.activeScript=this._scriptQueue[0],this.activeScript.index=0,this.start()},stop:function(){this._scriptQueue=[],this.isRunning=!1,this.activeScript=void 0,clearTimeout(this.timeoutDelay),this.timeoutDelay=void 0,clearTimeout(this.timeout),this.timeout=void 0,clearTimeout(this.timeoutMessage),this.timeoutMessage=void 0,oe.a.hide(),We.default.stop(),We.default.finish()},pause:function(){this.isPaused=!0},resume:function(){this.isPaused=!1,this.wasResumed=!0,this.stoppedFromPause&&(this.stoppedFromPause=!1,this.run())},demoReady:function(e){this.wasResumed||this.pause(),this.notify("demoReady"),e()},switchDemo:function(e){this.stop(),r.default.isDemoRunning=!0;var t=this[e]();this.resetData(function(){this._scriptQueue.push(t),this.activeScript=t,this.start()}.bind(this))},loadScriptData:function(e,t){log("Load Script Data: ",e),this._scriptQueue=[],this.repeat=!1,this.lastLoadedData=e,g.a.fireEvent("resetEverything",[]),r.default.vmMain.paneManager.clearPanes(!1),r.default.vmMain.beginUpdateItems(),s.default.loadDemoData(e,!0,function(e){r.default.vmMain.changeRoot(e),r.default.vmMain.commitUpdateItems(),t&&t()})},loadPanes:function(e){r.default.vmMain.loadDemoPanes(e.split(":"))},onScriptStart:function(e){e&&window.parent.postMessage(e.getName(),"*")},createScript:function(){var e={_nextId:0,owner:this,index:0,_repeat:!1,noDelay:!1,runQueue:[],_activeQueue:function(){return this.runQueue},queue:function(e){var t=Array.prototype.slice.call(arguments,1),i=this.runQueue;return i.push({id:this._nextId++,name:e,args:t}),i},repeat:function(e){this._repeat=e},nextStep:function(){return this.runQueue[this.index++]},getName:function(){return this._name}};return bn=bn.bind(e),An=An.bind(e),e},run:function(){if(!this.isDisabled&&this.activeScript)if(this.isPaused)this.stoppedFromPause=!0;else{r.default.Assert(this.activeScript,"Must have a script active to be running");var e=this.activeScript.nextStep();if(e){var t=e.args;t.push(this.run.bind(this)),this.isRunning=!0,clearTimeout(this.timeout),this.timeout=setTimeout(function(){try{this[e.name].apply(this,t)}catch(e){r.default.reportError(e),this.onDisable()}}.bind(this),0)}}},onDisable:function(){this.isDisabled=!0},setSelection:function(e,t,i,a,n){(r.default.Assert(e,"Must provide a valid item to select"),r.default.isNumber(e))&&(e=r.default.vmMain.paneManager.getPaneAtIndex(t).itemAtIndex(e));e=this.getItemIfString(e);var s=t>=0?r.default.vmMain.paneManager.getPaneAtIndex(t):r.default.focusedPane;r.default.focusedPane&&r.default.focusedPane.id===s.id||M.a.focusPane(s),void 0===i||null===i?i=0:i<0&&(i=e.getParsedText().length+i+1),M.a.selectItem(e,i,i+a),this.hasSelection=!0,this.selectedItem=e,n&&n()},clearSelection:function(e){M.a.reset(),this.hasSelection=!1,this.selectedItem=void 0,e&&e()},scrollTo:function(e,t,i){var a=r.default.vmMain.paneManager.getPaneAtIndex(e);r.default.Assert(a,"Must have selected a valid pane"),a.setScrollOffset(t),i&&i()},scrollMain:function(e,t,i){r.default.vmMain.setScrollOffset(e,t),setTimeout(i,t)},setText:function(e,t,i){(e=e||this.selectedItem).setText(t,!0,ChangeType.Local),i&&i()},appendText:function(e,t,i){e.setText(e.getParsedText()+t,!0),i&&i()},setPriority:function(e,t,i){(e=this.getItemIfString(e)||this.selectedItem).priority(t,ChangeType.Local),i&&i()},setStarred:function(e,t,i){(e=e||this.selectedItem).isStarred(t,ChangeType.Local),i&&i()},setComplete:function(e,t,i,a){(e=this.getItemIfString(e)||this.selectedItem).dateCompleted=i,e.isComplete(t,ChangeType.Local),a&&a()},removeItem:function(e,t){(e=this.getItemIfString(e)||this.selectedItem).deleteSelf(ChangeType.Local),t()},setStarredEmail:function(e,t,i){var a=r.default.vmMain.paneManager.getPaneAtIndex(e),n=a.itemAtIndex(t);a.toggleStar(n),i()},setPriorityEmail:function(e,t,i,a){var n=r.default.vmMain.paneManager.getPaneAtIndex(e).itemAtIndex(t),s=r.default.vmMain.pluginManager.getPlugin(PluginID.Gmail);n&&s.setAttachmentPriority(n.getAttachmentByPlugin(PluginID.Gmail),i),a()},indent:function(e,t){var i={normCode:KeyCode.Tab,shiftKey:e};M.a.fireKeyEvent(void 0,i),t&&t()},collapse:function(e,t,i){var a=r.default.vmMain.paneManager.getPaneAtIndex(t);(e=this.getItemIfString(e)||this.selectedItem).setCollapsed(!0,a),i&&i()},backspace:function(e,t,i,a){r.default.Assert(a,"typeString should always have a callback"),e=this.getItemIfString(e)||this.selectedItem,r.default.Assert(e,"Must be an item"),r.default.Assert(this.hasSelection,"Must set selection before typing"),r.default.Assert(!this.isTyping,"Must wait until previous typing is finished");var n=0,s=function(){this.intervalTyping&&(clearInterval(this.intervalTyping),this.intervalTyping=void 0),this.isTyping=!1}.bind(this),o=this.activeScript,l=e.getParsedText();function d(){this.isTyping=!0,this.activeScript===o?(l=l.substr(0,i-1)+l.substr(i,l.length-i),i--,e.setText(l,!0,ChangeType.Local),++n>=t&&(s(),a&&a())):s()}d.apply(this),t>1&&(clearInterval(this.intervalTyping),this.intervalTyping=setInterval(d.bind(this),this.typingSpeed))},typeString:function(e,t,i){r.default.Assert(i,"typeString should always have a callback"),e=this.getItemIfString(e)||this.selectedItem,r.default.Assert(e,"Must be an item"),r.default.Assert(this.hasSelection,"Must set selection before typing"),r.default.Assert(!this.isTyping,"Must wait until previous typing is finished"),r.default.Assert(void 0!==t,"Must supply a string to be typed");var a=0,n=function(){this.intervalTyping&&(clearInterval(this.intervalTyping),this.intervalTyping=void 0),this.isTyping=!1}.bind(this),s=this.activeScript;function o(){if(this.isTyping=!0,this.activeScript===s){var r=t.charCodeAt(a);if(r===KeyCode.Delete&&(r=KeyCode.Period),r===KeyCode.End){var o=M.a.getStartOffset(),l=e.getParsedText(),d=l.substr(0,o)+t.charAt(a)+l.substr(o);e.setText(d,!0,ChangeType.Local),M.a.selectItem(e,o+1)}else M.a.fireKeyEvent(void 0,{normCode:r});++a>=t.length&&(n(),i&&i())}else n()}t&&(o.apply(this),t.length>1&&(clearInterval(this.intervalTyping),this.intervalTyping=setInterval(o.bind(this),this.typingSpeed)))},typeIntoEmail:function(e,t,i){var a=r.default.reactEmailCompose.refs.body,n=0,s=function(){this.intervalTyping&&(clearInterval(this.intervalTyping),this.intervalTyping=void 0),this.isTyping=!1}.bind(this),o=this.activeScript;clearInterval(this.intervalTyping),this.intervalTyping=setInterval(function(){if(this.activeScript===o){var t=e[n];a.insertCharAtIndex(t,n),++n>=e.length&&(s(),i&&i())}else s()}.bind(this),t)},setSearch:function(e,t,i){r.default.vmMain.paneManager.getPaneAtIndex(t).search.setValue(e),i&&i()},createItemAfter:function(e,t,i){e=e||this.selectedItem,this.setSelection(e,void 0,e.getParsedText().length,0),M.a.fireKeyEvent(void 0,{normCode:KeyCode.Enter}),requestAnimationFrame(function(){this.clearSelection(function(){var a;a=e.isHeader()?e.getChild(0):e.parent().getChild(e.getIndex()+1),r.default.Assert(a,"Error getting new item: ",t),t&&(this.savedItems[t]=a),this.selectedItem=a,this.setSelection(a,void 0,-1,0,i)}.bind(this))}.bind(this))},zoomPane:function(e,t,i){var a=r.default.vmMain.paneManager.getPaneAtIndex(e);t=this.getItemIfString(t),a.setItem(t,!0),i&&i()},zoomGmailPane:function(e,t,i){var a=r.default.vmMain.paneManager.getPaneAtIndex(e),n=r.default.vmMain.pluginManager.getPlugin(PluginID.Gmail),s=n._getLabelByName("me",t);r.default.Assert(s,"Must be able to get a valid label if clicking a valid label");var o=n.getVMLIForLabel("me",s);a.setItem(o,!0),a.selectIndex(-1),i&&i()},delay:function(e,t){t&&(0===e?t&&t():(this.delayCb=t,clearTimeout(this.timeoutDelay),this.timeoutDelay=setTimeout(function(){this.delayCb=this.timeoutDelay=void 0,t()}.bind(this),e)))},addPane:function(e,t,i,a,n,o){var l={};l.item=i?this.getItemIfString(i):s.default.getRootModel(),a&&(l.search=a);r.default.vmMain.paneManager.createPaneAtIndex(e,t,l,n);o()},removePane:function(e,t,i){r.default.vmMain.paneManager.removePaneAtIndex(e,t),i&&i()},cullPanes:function(e,t){var i=r.default.vmMain.paneManager.paneCount();i>e?(this.removePane(i-1),setTimeout(this.cullPanes.bind(this,e,t),60)):t()},selectItemInPane:function(e,t,i){var a=r.default.vmMain.paneManager.getPaneAtIndex(e).itemAtIndex(t);this.selectedItem=a,i()},dragTo:function(e,t,i,a,n,s){var o=r.default.vmMain.paneManager.getPaneAtIndex(e),l=r.default.vmMain.paneManager.getPaneAtIndex(t),d=o.itemAtIndex(i),u=o.elementAtIndex(i),c=-1===a;c&&(a=l.numItems()-1);var h,f,p=l.elementAtIndex(a),g=l.itemAtIndex(a),m=l.objectAtIndex(a),v=u.getBoundingClientRect(),_=p.getBoundingClientRect(),y=o.dragMarginTop||0,S=v.top+(y||10),w=_.left-v.left,I=_.top-S+(c?V.default.lineItemHeight(m,g,1):0);M.a.focusPane(o);var b=null;var A=this,D=this.activeScript;We.default.startDragItem=d,d.dragStart({startSrc:u,eventX:v.left+10,eventY:S}),requestAnimationFrame(function e(t){if(A.activeScript===D){b||(b=t);var i,a=(i=(t-b)/n)<.5?4*i*i*i:(i-1)*(2*i-2)*(2*i-2)+1;if(h=w*a+v.left+10,f=I*a+S,a>=1){var o,l=document.getElementById("preventInteraction");l&&(o=l.parentElement).removeChild(l)}d.dragMove({eventX:h,eventY:f,diffY:I>v.top?1:-1,preventDefault:r.default.emptyFn,stopPropagation:r.default.emptyFn}),l&&o.appendChild(l),a>=1?(d.dragEnd({clientX:h,clientY:f,target:u}),s&&s()):requestAnimationFrame(e)}else M.a.fireMouseUp(u,ButtonCode.Left)})},getItemIfString:function(e){var t;return r.default.isString(e)?(t=s.default.getModel(e)||this.savedItems[e],r.default.Assert(t,"Item was not saved correctly")):e&&(r.default.Assert(r.default.isVMLI(e),"Must supply a valid VMLI: ",r.default.getObjectInfo(e)),t=e),t},pushMessage:function(e,t){if(this._currentToast)return r.default.toasts.clearMessage(this._currentToast),this._currentToast=void 0,void setTimeout(this.pushMessage.bind(this),100,e,t);var i;if(i=r.default.isString(e)?r.default.toasts.pushMessage({text:e,hold:!0}):r.default.toasts.pushMessage(e),this._currentToast=i,e===MessageID.ThisIsDemo){window.addEventListener("tapMain",function e(){r.default.toasts.clearMessage(i),window.removeEventListener("tapMain",e)})}t&&t()},notify:function(e,t){window.parent.postMessage(e,"*"),t&&t()},demoDone:function(e){M.a.reset(),this.notify("done"),r.default.isDemoRunning=!1,oe.a.isEnabled=!0;var t=document.getElementById("preventInteraction");t&&t.parentElement.removeChild(t),e()},addClass:function(e,t){r.default.addClass(document.documentElement||document.body,e),t&&t()},removeClass:function(e,t){r.default.removeClass(document.documentElement||document.body,e),t&&t()},switchClass:function(e,t,i){this.removeClass(e),this.addClass(t),i()},selectEmail:function(e,t,i){var a=r.default.vmMain.paneManager.getPaneAtIndex(e);r.default.Assert(a,"Must have selected a valid pane"),M.a.focusPane(a),a.selectIndex(t),i&&i()},openEmail:function(e,t,i){var a=r.default.vmMain.paneManager.getPaneAtIndex(e);r.default.Assert(a,"Must have selected a valid pane"),a.selectIndex(t);var n=a.itemAtIndex(t);a.openEmailByItem(n),i&&i()},closeEmail:function(e){ut.a.close(),e&&e()},sendEmail:function(e){r.default.reactEmailCompose.onClickSend(),e()},toggleMessageExpanded:function(e,t){r.default.reactEmailPreview.toggleExpanded(e),t()},replyToMessage:function(e){ut.a.setLastMessageResponseMode(l.a.EmailResponseMode.Reply),e()},archiveEmail:function(e,t,i){var a=r.default.vmMain.paneManager.getPaneAtIndex(e),n=a.itemAtIndex(t);a.archiveItem(!0,n),i()},addEmail:function(e,t){r.default.vmMain.pluginManager.getPlugin(PluginID.Gmail).refreshThreadCacheData("me",e,void 0,function(){},t)},waitPaneItems:function(e,t){var i=r.default.vmMain.paneManager.getPaneAtIndex(e);if(r.default.Assert(i,"Must have selected a valid pane"),i.items.length()>0)t();else{i.items.listen(function e(a){a.length>0&&(i.items.unlisten(e),t())})}},displaySetting:function(e,t){un.a.changeTheme(e),t()},caption:function(e,t,i){this.demoCaption.set({text:e,opacity:1,center:t,light:e.indexOf("<b>")>=0}),i()},captionFade:function(e){var t=this.demoCaption.get();this.demoCaption.set({text:t.text,opacity:0,center:t.center,light:t.light}),e()},resetData:function(e){if(this.isRunning)return this.stop(),clearTimeout(this.timeoutMessage),void(this.timeoutMessage=setTimeout(this.resetData.bind(this),100,e));this.loadScriptData(s.default.demoDataId,e)},waitAction:function(e,t){this._waitTracker={check:e,cb:t}},onTrackerAction:function(e){var t=this._waitTracker;t&&t.check(e)&&t.cb()},demoEmail:function(e){return r.default.isDemoRunning=!0,bn("waitPaneItems",0),bn("zoomGmailPane",1,"Needs Reply"),bn("zoomGmailPane",2,"Starred"),bn("removeClass","invisible"),bn("demoReady"),Dn(1e3),bn("dragTo",0,1,0,-1,1e3),Dn(200),bn("dragTo",0,1,0,-1,1e3),Dn(800),bn("setStarredEmail",0,1),Dn(500),bn("setStarredEmail",0,3),Dn(800),bn("setPriorityEmail",2,0,VMLIFlag.P0),Dn(500),bn("setPriorityEmail",2,2,VMLIFlag.P2),Dn(1200),bn("selectEmail",0,0),Dn(200),bn("openEmail",0,0),bn("pushMessage",MessageID.ThisIsDemo),bn("demoDone"),e},demoStyle:function(e){var t=0,i=0;r.default.isDemoRunning=!0,oe.a.isEnabled=!1,this.collapse("ideas",0),this.collapse("todo",0),this.collapse("testing",0),bn("removeClass","invisible"),bn("demoReady"),Dn(500),bn("dragTo",0,1,1,1,1e3),Dn(1e3),bn("setSelection","tracking",0,-1,0),bn("typeString",void 0," #Android"),Dn(800),bn("typeString",void 0," @tomorrow "),Dn(800),bn("setSelection","tracking",0,0,0),bn("typeString",void 0,"+Grant "),Dn(1500),bn("zoomPane",1,"release"),Dn(1500);for(var a="#Android",n=a.length;n>=0;n--){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;bn("setSearch",a.substr(0,n),2),Dn(40)}Dn(800),a="+Grant";for(n=0;n<=a.length;n++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;bn("setSearch",a.substr(0,n),2),Dn(40)}bn("pushMessage",MessageID.ThisIsDemo),bn("demoDone")},demoPress:function(e){y.a.addListener(this.onTrackerAction.bind(this)),bn("pushMessage",{text:"Try dragging an email onto the Outline.",hold:!0,big:!0}),bn("waitAction",function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.DropItem&&e.data.fromPane&&e.data.fromPane.type===PaneMode.Gmail}),bn("pushMessage",{text:"Schedule an item by typing @ then a date.<br><br>Or drag it right onto the Agenda.",hold:!0,big:!0}),bn("waitAction",function(e){return e.type===TrackerType.Misc&&e.misc===TrackerMisc.ChangeDate||e.type===TrackerType.Insert&&"@"===e.data[0].text}),bn("pushMessage",{text:"Learn more on our homepage.",hold:!0,action:MessageAction.OpenURL,actionText:"https://moo.do",data:{url:"https://www.moo.do"}})},demoEmpty:function(e){r.default.isDemoRunning=!0,bn("demoReady"),bn("pushMessage",MessageID.ThisIsDemo),bn("demoDone")}};var Tn=In,Mn={Normal:"Sign in with Google",Connecting:"Connecting...",LoggingIn:"Logging In...",Loading:"Loading...",Offline:"Offline"};function Cn(){var e,t=this;if(this.loginState=new w.a(LoginState.NONE),e=navigator.onLine?j.a.canRunAuthenticate()?Mn.Normal:Mn.Loading:Mn.Offline,this.loginStatus=new w.a(e),this.popupClosedError=new w.a(!1),this.gapiFailedToLoad=new w.a,this.loggedOutByAuthFailure=new w.a,this.downloadIcon=this.getDownloadIcon(),this.downloadText="Download "+this.getDownloadText()+" app",this.showDownload=p.a.mobile&&!p.a.app||p.a.canDownloadNativeApp()||p.a.canDownloadChromeApp(),this.showLogin=!p.a.mobile||p.a.app||p.a.isDevURL,this.textErrorConnecting="Error connecting to Google. Please check your connection or disable any privacy extensions.",!j.a.canRunAuthenticate()&&!r.default.isDemoMode()){var i=setTimeout(function(){t.gapiFailedToLoad.set(1),i=setTimeout(function(){t.gapiFailedToLoad.set(2);var e=document.getElementById("buttonOnlineStatus");if(navigator.onLine&&t.loginStatus.get()===Mn.Loading&&e){var i=ya.a.showSidebar.get(),a=i?"left":"top";r.default.tooltip.displayTipSticky({text:t.textErrorConnecting,element:e,sticky:!0,maxWidth:i?320:280,arrowDirection:a})}},1e4)},5e3);window.addEventListener("gapiLoaded",function(){clearTimeout(i),t.loginStatus.get()===Mn.Loading&&t.loginStatus.set(Mn.Normal)})}this.loginRequested=!1,this.loginRequestTimer=void 0}Cn.prototype={init:function(){if(r.default.isDemoMode())return this.setLoginState(LoginState.LOGGED_IN),LoginState.LOGGED_IN;var e=r.default.getLoginState();return this._pageLoadLoginState=e,this.setLoginState(e),window.addEventListener("gapiLoaded",function(){this.loginRequested&&(this.loginStatus.set(Mn.Normal),j.a.hasValidAccessToken("me")?this.userLogin():this.loginRequested=!1)}.bind(this)),window.addEventListener("offline",function(){log("Browser going offline."),r.default.vmMain.setGDriveStatus(DriveStatus.Offline),this.loginStatus.set(Mn.Offline)}.bind(this)),window.addEventListener("online",function(){if(log("Browser going online."),this.loginStatus.set(Mn.Normal),this.loginRequested&&(j.a.hasValidAccessToken("me")?this.userLogin():this.loginRequested=!1),r.default.getLoginState()==LoginState.LOGGED_IN&&!p.a.offline){var e=f.default.ensureDocConnection();log("Coming online. Already online:",e)}}.bind(this)),e},getDownloadIcon:function(){return p.a.getPlatformIcon()},getDownloadText:function(){return p.a.getPlatformName()},setLoginState:function(e,t){e!==this.loginState.get()&&(r.default.setLoginState(e),this.loginState.set(e))},userLogin:function(){var e=this;j.a.canRunAuthenticate()&&this.loginStatus.get()===Mn.Normal&&this.loginState.get()!=LoginState.LOGGED_IN?(r.default.authUserLoggedIn=!0,this.loginStatus.set(Mn.LoggingIn),this.loginRequested=!1,f.default.runAuthenticate(f.default.requiredScopes,!1,!0,function(e){if(this.loginStatus.set(Mn.Normal),e&&e.error)"popup_closed_by_user"===e.error&&this.popupClosedError.set(!0);else if(e&&!e.error){r.default.settings.set(Settings.localIntegrity,!0),this.popupClosedError.set(!1),this.setLoginState(LoginState.LOGGED_IN),r.default.vmMain.paneManager.setupInitialTimeout();var t=f.default.loadClientDefaultFile();t!==l.a.DocLoadSkipReason.None&&this._reportLoginTapSkip("Skipped loading default client file: "+t)}else this._reportLoginTapSkip("Invalid token returned when calling userLogin")}.bind(this))):(this._reportLoginTapSkip("Still in connecting login state"),this.loginStatus.set(Mn.Connecting),this.loginRequested=!0),clearTimeout(this.loginRequestTimer),this.loginRequestTimer=setTimeout(function(){e.loginStatus.set(navigator.onLine?Mn.Normal:Mn.Offline),e.loginRequested=!1},500)},shouldShowLogin:function(){return this.loginStatus.get()===Mn.Normal||this.loginStatus.get()===Mn.LoggingIn},openLogin:function(){this.loginState.set(LoginState.NONE)},logout:function(){this.loginState.get()===LoginState.LOGGED_IN&&(log("Logging out"),this.setLoginState(LoginState.LOGGED_OUT),s.default.clearData(function(){o.a.storage.clear(),c.a.signOut(function(){log("Logged out",p.a.app),setTimeout(function(){o.a.hasURLParam("login")?o.a.removeURLParam("login"):o.a.hasURLParam("user")&&o.a.removeURLParam("user"),p.a.app?(r.default.nativeBridge.sendToApp("logout"),p.a.isFeatureEnabled(l.a.Feature.OAuth)&&r.default.reload()):r.default.reload()},0)})}))},logoutClicked:function(){if(r.default.isDemoMode())o.a.removeURLParam("demo");else{var e=!0;for(var t in s.default.pendingRemoteUpdates)if(s.default.pendingRemoteUpdates.hasOwnProperty(t)){r.default.menus.confirm("You have unsaved changes which will be lost if you log out. Are you sure?",function(e){e&&this.logout()}.bind(this)),e=!1;break}e&&this.logout()}},isLocal:function(){return"localhost"==window.location.hostname},getPageLoadLoginState:function(){return this._pageLoadLoginState},initDemo:function(){r.default.AScript||(r.default.AScript=new Tn)},runScript:function(e){r.default.AScript.runScript(e)},onTapLogin:function(e){this.loginStatus.get()===Mn.Normal?this.userLogin():this._reportLoginTapSkip("Login Status not LoginStatus.Normal: "+this.loginStatus.get()),e&&(e.preventDefault(),e.stopPropagation(),r.default.preventClick())},isLoggedIn:function(){return this.loginState.get()===LoginState.LOGGED_IN},_reportLoginTapSkip:function(e){},closeConnectionError:function(){r.default.tooltip.hideSticky(this.textErrorConnecting)}};var Ln=Cn;function Pn(){this.scheduledItems=[],this.notifiedItems={},this.timeoutNextNotification=void 0,o.a.binder(this,"runNotifications")}Pn.prototype={scheduleItems:function(e){var t=this;this.scheduledItems=e,p.a.hasNotificationPermission()?this.runNotifications():Notification.requestPermission(function(){t.runNotifications()})},runNotifications:function(){for(var e=0,t=0;t<this.scheduledItems.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this.scheduledItems[t];this.notifiedItems[i.id]&&this.notifiedItems[i.id]===i.date||this.runNotification(i)}var a=new Date,n=Math.max(6e4-1e3*a.getSeconds()-a.getMilliseconds(),1e3);clearTimeout(this.timeoutNextNotification),this.timeoutNextNotification=setTimeout(this.runNotifications,n)},runNotification:function(e){var t=new Date,i=new Date(e.alertDate),a=new Date(e.date),n=Math.max(i.getTime()-t.getTime(),0),s=a.getTime()-t.getTime();if(s>=0&&n<=0){r.default.Assert(n<=s,"Alert must always be before actual event");var o=Math.ceil((a.getTime()-Date.now())/6e4);new Notification(e.text,{body:"in "+o+" minutes",icon:p.a.isNativeApp()?void 0:"/img/favicon-96x96.png",requireInteraction:!0});this.notifiedItems[e.id]=e.date}else this.notifiedItems[e.id]=e.date}};var En=new Pn;window.__FULL_NOTIFICATION_UPDATES=0,window.__SINGLE_NOTIFICATION_UPDATES=0;function kn(){this.notificationItems={},this.numNotificationItemsChanged=0,this.scheduleTimeout=void 0,this.oldSoftDates=["now","next","soon","later","someday"],this.agendaSort=new w.a(r.default.settings.get(Settings.agendaSort)||this.createDefaultAgendaSort()),o.a.binder(this,"setupNotifications")}kn.prototype={clearDailyCaches:function(){},addNotification:function(e){r.default.Assert(e,"Must provide a valid item to schedule notifications for"),this.notificationItems[e.id]=e,this.numNotificationItemsChanged++,clearTimeout(this.scheduleTimeout),this.scheduleTimeout=setTimeout(this.setupNotifications,5e3)},removeNotification:function(e){r.default.Assert(e,"Must provide a valid item to unschedule notifications for"),this.notificationItems[e.id]&&(this.notificationItems[e.id]=void 0,this.numNotificationItemsChanged++,clearTimeout(this.scheduleTimeout),this.scheduleTimeout=setTimeout(this.setupNotifications,5e3))},clearNotifications:function(){for(var e in this.notificationItems)this.notificationItems.hasOwnProperty(e)&&(this.notificationItems[e]=void 0,this.numNotificationItemsChanged++);clearTimeout(this.scheduleTimeout),this.scheduleTimeout=setTimeout(this.setupNotifications,5e3)},shouldNotify:function(e,t){t||(t=new Date);var i=e.date();return!r.default.isDateSoft(e.getDateText())&&!e.isDestroyed()&&!e.isDeleted()&&!e.isComplete()&&!e.hasCompletedAncestor()&&!e.allDayDate()&&!e.isArchived()&&(i&&i>t&&i-Date.now()<864e5||e.repeatDate())},updateNotifications:function(e){var t=this;if(p.a.supportsNotifications()&&G.a.isNotificationsEnabled()&&!r.default.isDemoMode()){var i=new Date;e?(window.__SINGLE_NOTIFICATION_UPDATES++,this.shouldNotify(e,i)?this.addNotification(e):this.removeNotification(e)):(window.__FULL_NOTIFICATION_UPDATES++,this.clearNotifications(),r.default.searchVMLIs({item:r.default.vmMain.root(),includeArchived:!1,each:function(e){t.shouldNotify(e,i)&&t.addNotification(e)}}))}},setupNotifications:function(){r.default.Assert(p.a.supportsNotifications(),"Platform must support notifications");var e=[];for(var t in this.notificationItems)if(this.notificationItems.hasOwnProperty(t)){var i=this.notificationItems[t];if(i&&i.getNotificationEntries){var a=i.getNotificationEntries();if(a)if(r.default.isArray(a))for(var n=0,s=0;s<a.length;++s){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;e.push(a[s])}else e.push(a)}else delete this.notificationItems[t]}p.a.usesHTML5Notifications()?En.scheduleItems(e):r.default.nativeBridge.isEnabled()?r.default.nativeBridge.sendToApp("scheduledItems",e):r.default.nativeBridge.hasEmbedBridge()&&r.default.nativeBridge.sendToEmbed("scheduledItems",e),this.numNotificationItemsChanged=0,this.scheduleTimeout=void 0},createDefaultAgendaSort:function(){return{overdue:-2,"#now":-1,starred:1,important:2,"#next":3,"#soon":101,"#later":301,"#someday":1401}},getDateForKey:function(e){return this.oldSoftDates.indexOf(e)>=0&&(e="#"+e),this.agendaSort.get()[e]},saveAgendaSort:function(e){this.agendaSort.set(e),r.default.settings.set(Settings.agendaSort,e),r.default.vmMain.paneManager.runForEachPane(function(e){e.isViewAgenda()&&e.setItemsDirty()}),r.default.vmMain.updateAllItems()}};var xn=kn;function Rn(){r.default.Assert(!r.default.menus,"Should only have a single instance of VMMenus"),this.billingManager=r.default.billingManager,this.modals=[Modals.Settings,Modals.Alert,Modals.Confirm,Modals.Prompt,Modals.ExportData,Modals.RevisionHistory,Modals.ImportData,Modals.ReportProblem,Modals.Billing,Modals.Welcome,Modals.EmailReply,Modals.EmailCompose,Modals.MobileSettings,Modals.DeleteAccount,Modals.Invoices,Modals.Options,Modals.Lightbox,Modals.EnterCode,Modals.ShareDoc,Modals.ReportBug],this.modalStack=new k.a,this.contextMenuStack=new k.a,this.emailComposeStack=new k.a,o.a.forceBind("onClosingSettings",this),this.init()}Rn.prototype={init:function(){},vmPicker:function(){return r.default.vmMain.vmPicker},toggleContextMenu:function(e,t){r.default.menus.isContextMenuOpen()?r.default.menus.closeContextMenu():this.openContextMenu(e,t)},openAddPaneMenu:function(e){e.componentName="ReactContextMenuAddPane",e.onSelected=function(t,i,a){r.default.vmMain.paneManager.addPaneByButton(t,i,a,e.element)},this.openContextMenu(e)},openContextMenu:function(e,t){e.element&&r.default.findParent(e.element,"desktopSidebar")&&(e.pos={left:ya.a.getSidebarWidth()+4},e.side="right",r.default.findParent(e.element,"desktopMenuBottom")&&(e.openFromBottom=!0)),this.contextMenuNoFade=t,this.contextMenuStack.push(e)},indexOfContextMenu:function(e){var t=this.contextMenuStack.get(),i=t.indexOfWithProperty("fn",e);return i<0&&(i=t.indexOfWithProperty("componentName",e)),i},closeContextMenu:function(e,t,i){if(e){var a=this.indexOfContextMenu(e);if(r.default.Assert(a>=0,"Tried to close a context menu that was not open"),a>=0){var n=this.contextMenuStack.get()[a];n.onClosed&&n.onClosed(t,i),this.contextMenuStack.removeAt(a)}}else{for(var s=0,o=this.contextMenuStack.get(),l=o.length-1;l>=0;l--){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;o[l].onClosed&&o[l].onClosed(!1,i)}this.contextMenuStack.clear()}},getTopContextMenu:function(){var e=this.contextMenuStack.get();if(e&&e.length){var t=e[e.length-1];return t.componentName||t.fn}},isAutocompleteOpen:function(){return this.indexOfContextMenu("ReactAutocomplete")>=0},isContextMenuOpen:function(e){return e?this.indexOfContextMenu(e)>=0:this.contextMenuStack.get().length>0},isModalOpen:function(e){var t=this.modalStack.get();if(!e)return t.length>0;for(var i=0,a=0;a<t.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(t[a].id===e)return!0}},openModalNew:function(e,t){r.default.Assert(void 0===t||r.default.isObject(t),"Must always pass in a valid object for params"),r.default.Assert(this.modals.indexOf(e)>=0,"Modal must be registered as a new modal to use this fn: ",e),this.isModalOpen(e)||(t=t||{},r.default.Assert(void 0===t.id,"Should not already have an ID defined with modal params"),t.id=e,M.a.reset(),this.modalStack.push(t))},closeModalNew:function(e,t){var i=this.modalStack.get().indexOfWithProperty("id",e);if(i>=0){var a=this.modalStack.get()[i],n=!0;a.onClosing&&(n=a.onClosing()),n&&(this.modalStack.removeAt(i),a.callback&&a.callback(t))}},confirm:function(e,t){r.default.Assert(t,"Confirm modals should have callbacks",e),this.openModalNew(Modals.Confirm,{text:e,callback:t})},prompt:function(e,t){r.default.Assert(t,"Prompt modals should have callbacks",e),this.openModalNew(Modals.Prompt,{text:e,callback:t})},alert:function(e){r.default.Assert(!e.action,"Still using an old style alert",e),e.action&&(e.callback=e.action),this.openModalNew(Modals.Alert,e)},options:function(e,t,i){r.default.Assert(r.default.isArray(t,"Must have valid options array")),r.default.Assert(i,"Options modal must have a callback"),this.openModalNew(Modals.Options,{text:e,options:t,callback:i})},openSettings:function(e){y.a.performAction(TrackerType.UIAction,{type:TrackerUIAction.OpenSettingsMenu}),this.openModalNew(Modals.Settings,{section:e,onClosing:this.onClosingSettings})},onClosingSettings:function(){var e=!G.a.isSaveEnabled.get();return e||this.confirm("You have unsaved changes. Are you sure you want to cancel your changes?",function(e){e&&(G.a.isSaveEnabled.set(!1),this.closeModalNew(Modals.Settings))}.bind(this)),e},openDisplaySettings:function(){M.a.reset(),r.default.vmMain.isDisplaySettingsOpen.set(!0),y.a.performAction(TrackerType.UIAction,{type:TrackerUIAction.OpenDisplaySettings})},getUserEmail:function(){return r.default.getUserIdentifier()},getUserName:function(){var e=v.a.authenticatedUser.get();return e?e.displayName:r.default.vmMain.gdriveStatus()===DriveStatus.Saved?"Connected":r.default.vmSetup.loginState()===LoginState.LOGGED_IN?"Connecting":"Demo"},openMenuExternalApp:function(e,t){this.openContextMenu({componentName:"ReactContextMenuMobileOpenLink",position:"bottom",html:e,onClick:t})},_indexOfCompose:function(e){for(var t=0,i=this.emailComposeStack.get(),a=0;a<i.length;++a){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(i[a].draftMsg.id===e)return a}return-1},isComposeOpenForEmail:function(e){return!1},openComposeEmail:function(e,t,i,a){if(r.default.Assert(e,"Must have a valid email plugin"),r.default.Assert(!t||r.default.isString(t),"Must have a string threadID"),r.default.Assert(!i||r.default.isString(i),"Must have a string messageID"),M.a.reset(),this.isComposeOpenForEmail());else{var n=e.getDraftByID(e.getDefaultAccount(),t,i,a);r.default.Assert(n,"Must always create a valid draft");var s={threadAttach:n.attach,message:n.draftMsg};this.openModalNew(Modals.EmailCompose,s)}y.a.miscAction({type:TrackerType.Misc,misc:TrackerMisc.ComposeEmail})},closeComposeEmail:function(e,t){var i=this._indexOfCompose(t.id);r.default.Assert(i>=0,"Must have found a valid composing email to remove"),this.emailComposeStack.removeAt(i)},openItemEditor:function(e){if(r.default.Assert(!e.item==!!e.addOnSave,"Must be adding item if no item prop"),!e.item){e.parent||(e.parent=s.default.getRootModel());var t=s.default.createTempVMLI({text:e.text||r.default.getDefaultItemText()},{changeType:ChangeType.AllLocal});e.item=t;var i=e.endSave;e.endSave=function(){setTimeout(function(){s.default.destroyTempVMLI(t.id)},0),i&&i.apply(this,arguments)}}e.componentName="ReactItemDetailsPopup",this.openContextMenu(e)},openLightbox:function(e,t,i){r.default.Assert(!1,"Should never open lightbox on mobile"),this.openModalNew(Modals.Lightbox,{src:e,buttonText:t,buttonAction:i})}};var On=Rn,Fn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Nn=l.a.TooltipDelay;function Bn(){this.tooltip=new w.a,this.tooltipsSticky=new k.a,this.displayElement=void 0,this.isSticky=!1,this.displayTimeout=void 0,this.init()}Bn.prototype={init:function(){p.a.touch||(g.a.listen("mouseover",this.handleEleOver.bind(this)),g.a.listen("mouseout",this.handleEleOut.bind(this)),window.addEventListener("mouseout",this.windowOut.bind(this)),document.addEventListener("mousedown",this.hideTip.bind(this),!0))},windowOut:function(e){(e.pageX>=p.a.windowWidth()||e.pageY>=p.a.windowHeight()||e.pageX<=0||e.pageY<=0)&&this.hideTip()},register:function(e,t){this.update(e,t)},update:function(e,t){e.setAttribute("tooltip",t)},displayTipSticky:function(e){e.sticky=!0,this.displayTip(e)},displayTip:function(e){r.default.Assert(e,"When display a tooltip, must pass in some info"),clearTimeout(this.displayTimeout),this.displayTimeout=void 0;var t=this.displayElement=e.element;if(e&&t&&t.offsetWidth>0&&t.offsetHeight>0){var i=e.text;if(this.isSticky=e.sticky,r.default.Assert(i,"When display a tooltip, elements should always have valid data set"),i){var a={text:i,hotkey:e.hotkey,element:t,blue:e.blue,sticky:e.sticky,maxWidth:e.maxWidth,onRight:e.onRight,arrowClass:e.arrowDirection||"hidden"};e.sticky?this.tooltipsSticky.push(a):this.tooltip.set(a)}}},tipOut:function(e){var t=!0;e.target&&(t=r.default.isAttachedToDoc(e.target)&&!r.default.findParent(e.target,"tooltip")),t&&this.hideTip()},getAttr:function(e){return e&&e.getAttribute&&(e.getAttribute("tooltip")||e.getAttribute("data-tooltip"))},getAttrHotkey:function(e){return e&&e.getAttribute&&(e.getAttribute("tooltipHotkey")||e.getAttribute("data-tooltiphotkey"))},getByClassName:function(e,t){var i,a=p.a.priModKey,n=e.parentElement,s=e.textContent;if(!r.default.findParent(e,"fancyInputInner"))if(r.default.hasClass(e,"linkImage"))i="<b>Click</b> to open image.<br><b>"+a+" + Click</b> to open in "+(p.a.app?"browser":"new tab")+".";else if(n&&r.default.hasClass(n,"appLink")){i="<b>"+a+" + Click</b> to open in "+((r.default.hasClass(n,"Evernote")?"Evernote":"")||(r.default.hasClass(n,"OneNote")?"OneNote":"")||(r.default.hasClass(n,"Bear")?"Bear":""))}else if(r.default.hasClass(e,"link")&&e.getAttribute("data-href")){var o=e.getAttribute("data-href");i=(o!==s?o+"<br>":"")+"<b>"+a+" + Click</b> to open"}else if(r.default.hasClass(e,"tag")||r.default.hasClass(e,"date")||r.default.hasClass(e,"duration")){i="<b>"+a+"+ Click</b> to show only "+s+"<br><b>"+a+" + Shift + Click</b> to hide "+s+"<br><b>"+(p.a.mac?"Option":"Alt")+" + Click</b> to remove "+s}else r.default.hasClass(e,"email")?i="<b>"+a+"+ Click</b> to email "+s:r.default.hasClass(e,"prefixHeader")||r.default.hasClass(e,"prefixBullet")?i="<b>Click</b> to zoom in":r.default.hasClass(e,"prefixTask")?i="<b>Click</b> to toggle complete.<br><b>"+p.a.priModKey+" + Click</b> to zoom in.":r.default.hasClass(e,"prefixNumList")?i="<b>"+p.a.priModKey+" + Click</b> to zoom in":r.default.hasClass(e,"plugin")&&(i=(t>0?"<b>"+p.a.priModKey+" + Click</b>":"<b>Click icon</b>")+" to open");return i},getTooltipText:function(e,t){return this.getAttr(e)||this.getByClassName(e,t)},handleEleOver:function(e){if(r.default.Assert(r.default.isDOMNode(e.target),"Must have a valid DOM node: ",Fn(e.target)),e.target){for(var t,i,a=0,n=e.target,s=0;!t&&n&&s<3;s++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;t=this.getTooltipText(n,s),i=this.getAttrHotkey(n),t||i||(n=n.parentElement)}if(n&&(!t&&i&&(t=i,i=void 0),t&&this.displayElement!==n&&!We.default.isDragging&&!M.a.isMouseDown())){clearTimeout(this.displayTimeout),this.displayTimeout=setTimeout(this.displayTip.bind(this),Nn,{element:n,offset:{y:5},text:t,hotkey:i})}}},handleEleOut:function(e){this.tipOut(e)},isOpenSticky:function(){return this.tooltipsSticky.get().length>0},hideSticky:function(e){for(var t=0,i=this.tooltipsSticky.get(),a=0;a<i.length;a++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;if(i[a].text===e){this.tooltipsSticky.removeAt(a);break}}},hideTip:function(){this.displayElement=void 0,clearTimeout(this.displayTimeout),this.displayTimeout=void 0,this.tooltip.set(void 0)}};var Un=Bn;function Vn(){this.useServiceWorker="serviceWorker"in navigator,this.updateWaitTime=r.default.minutes(120),this.notifiedOfNew=!1,this.isFinished=!1,this.downloadingTimeout=0,this.lastUpdate=0,this.startStatus=window.applicationCache?window.applicationCache.status:-2,this.continuedUpdate=!1,this.updateActionDone=!1,this.fnToRun=[],this.requiredUpdate=!1,this.appUpdatePending=!1,this.runUpdate=!1,this.init()}Vn.prototype={init:function(){this.startStatus===window.applicationCache.OBSOLETE&&this.onCacheObsolete(),this.useServiceWorker?(navigator.serviceWorker.addEventListener("message",function(e){"ServiceWorker_Activated"===e.data?this.onUpdateReady():"ServiceWorker_Installed"===e.data&&setTimeout(this.onUpdateReady.bind(this),2e3)}.bind(this)),o.a.hasURLParam("swupdate")&&setTimeout(function(){o.a.hasURLParam("swupdate")&&o.a.removeURLParam("swupdate",!0)},2e3)):log("Cache Status: "+this.startStatus),window.applicationCache?(window.applicationCache.addEventListener("noupdate",this.onCacheLoadFinished.bind(this)),window.applicationCache.addEventListener("cached",this.onFirstUpdateReady.bind(this)),window.applicationCache.addEventListener("downloading",this.onUpdateDownloading.bind(this)),window.applicationCache.addEventListener("updateready",this.onUpdateReady.bind(this)),window.applicationCache.addEventListener("obsolete",this.onCacheObsolete.bind(this)),window.applicationCache.addEventListener("error",this.onUpdateError.bind(this)),window.applicationCache.status>=window.applicationCache.UPDATEREADY||document.documentElement.attributes.getNamedItem("manifest")||this.onCacheLoadFinished()):this.onCacheLoadFinished()},update:function(){if(Date.now()-this.lastUpdate>this.updateWaitTime){this.lastUpdate=Date.now();try{this.useServiceWorker?window.__registeredServiceWorker&&window.__registeredServiceWorker.update():window.applicationCache&&window.applicationCache.status===window.applicationCache.IDLE&&window.applicationCache.update()}catch(e){}}},checkForUpdate:function(e,t){this.requiredUpdate=!!e,this.runUpdate=!!t,this.appUpdatePending?this.appUpdatePending&&this.runUpdate&&r.default.reload(!this.useServiceWorker):this.update()},endRunUpdate:function(){this.runUpdate=!1},runOnFinish:function(e){r.default.Assert(0===this.fnToRun.length,"Only a single callback is allowed to be run at this point."),this.isFinished?setTimeout(e,0):this.fnToRun.push(e)},onUpdateReady:function(){this.appUpdatePending||(log("Cache: New version available"),this.appUpdatePending=!0,o.a.hasURLParam("swupdate")||o.a.insertURLParam("swupdate",!0,!0),this.useServiceWorker?log("Service worker has update"):window.applicationCache&&this.startStatus===window.applicationCache.UNCACHED&&log("Cache Update from UNCACHED state. ERROR."),this.onCacheLoadFinished(),this.updateAction())},onFirstUpdateReady:function(){log("Cache: first update")},onUpdateError:function(e){p.a.demo||r.default.vmMain&&!r.default.vmMain.isOnline()||(log("Update Error: ",e),"quota"===e.reason&&r.default.toasts.pushMessage({text:"A new version of Moo.do is available but you do not have enough free disk space to update. You may want to clear up some disk space.",actionText:"OKAY"})),this.onCacheLoadFinished()},onUpdateDownloading:function(){log("Cache: New version downloading")},onCacheObsolete:function(){this.onUpdateReady()},onCacheLoadFinished:function(){if(!this.isFinished){var e=0;this.isFinished=!0;for(var t=0;t<this.fnToRun.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;this.fnToRun[t]()}}},notifyOfUpdate:function(){this.notifiedOfNew||(this.notifiedOfNew=!0,r.default.setAppCacheUpdateState(!0))},updateAction:function(){this.runUpdate||!p.a.isPageVisible()?r.default.reload(!this.useServiceWorker):this.requiredUpdate&&r.default.menus.alert({text:"A software update is required to continue. Please reload to update.",actionText:"RELOAD",callback:r.default.reload}),r.default.sendEvent("AppCache","Update")}};var Hn=Vn,qn=i(33);function zn(e){r.default.Assert(void 0===window.__MoodoBridge[e],"Registering an Inbound API that already exists on the window object",e),this._name=e,this._publicObj={},this._privateObj={},window.__MoodoBridge[e]=this._publicObj,this.init()}zn.prototype={init:function(){},_createWrapper:function(e){return function(){try{return e.apply(this,arguments)}catch(e){r.default.reportError(e)}}},registerFunction:function(e,t,i){r.default.Assert(e,"Name must be provided to register function"),r.default.Assert(t,"A valid function must be provided to register"),r.default.Assert(void 0===this._privateObj[e],"Re-registering an api function on private obj",e),r.default.Assert(void 0===this._publicObj[e],"Re-registering an api function on public obj",e),this._privateObj[e]=t.bind(this._privateObj),i&&(this._publicObj[e]=this._createWrapper(this._privateObj[e]))},registerVariable:function(e,t,i){r.default.Assert(e,"Name must be provided to register variable"),r.default.Assert(!i,"Public variables are not currently supported"),r.default.Assert(void 0===this._privateObj[e],"Re-registering an api variable on private obj"),r.default.Assert(void 0===this._publicObj[e],"Re-registering an api variable on public obj"),this._privateObj[e]=t}},o.a.defineBase(zn);var Wn=zn;function Gn(e){this._name=e,this._apiLoaded=!1,this._apiError=!1,this._listeners=void 0,this._requiredFns=[],this._missingFns=void 0,this.init()}Gn.prototype={init:function(){r.default.isObject(window[this._name])?this.onAPILoaded():(o.a.forceBind("_checkAPI",this),setTimeout(this._checkAPI,1e3))},_checkAPI:function(){r.default.Assert(!this._apiLoaded,"Should not be checking for API load if already loaded"),r.default.isObject(window[this._name])&&this.onAPILoaded(),this._apiLoaded||setTimeout(this._checkAPI,1e3)},onAPILoaded:function(){var e=0;this._apiLoaded=!0;for(var t=0;t<this._requiredFns.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;r.default.isFunction(window[this._name][name])||(this._apiError=!0,this._addMissingFn(name))}this.notifyListeners()},requestNotification:function(e){this._apiLoaded?setTimeout(e,0):this._listeners?this._listeners.push(e):this._listeners=[e]},notifyListeners:function(){if(r.default.Assert(this._apiLoaded,"API must be loaded to notify listeners"),this._listeners)for(var e=0,t=0;t<this._listeners.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;this._listeners[t]()}this._listeners=void 0},requireFunction:function(e,t){r.default.Assert(this._requiredFns.indexOf(e)<0,"Should not double require a single function"),this._requiredFns.push(e),this._apiLoaded&&(r.default.isFunction(window[this._name][e])||t||(this._apiError=!0,this._addMissingFn(e)))},_addMissingFn:function(e){this._missingFns?(r.default.Assert(this._missingFns.indexOf(e)<0,"Should not be missing the same function multiple times"),this._missingFns.push(e)):this._missingFns=[e]},hasOptionalFunction:function(e){return r.default.Assert(this._requiredFns.indexOf(e)>=0,"Must be querying for a registered function"),!!window[this._name]&&!!window[this._name][e]},call:function(e){if(r.default.Assert(this._apiLoaded,"Trying to call an API function before it is loaded",e),this._apiLoaded){var t=Array.prototype.slice.call(arguments,1);try{return window[this._name][e].apply(window[this._name],t)}catch(e){r.default.reportError(e)}}}},o.a.defineBase(Gn);var jn=Gn;function Kn(){if(p.a.app)try{this.backlog=[],this._iOS7Queue=[],this._iOS7QueueTimeout=void 0,this.flushingBacklog=!1,this.isPokingBackground=!1,this.setupFns=[],this.setupFns[AppPlatform.iOS]=this.setupiOS.bind(this),this.setupFns[AppPlatform.Android]=this.setupAndroid.bind(this),this.setupFns[AppPlatform.WinPhone]=void 0,this.setupFns[AppPlatform.Chrome]=this.setupChrome.bind(this),this.setupFns[AppPlatform.Electron]=this.setupElectron.bind(this),this.sendFns=[],this.sendFns[AppPlatform.iOS]=this.sendToAppiOS.bind(this),this.sendFns[AppPlatform.Android]=this.sendToAppAndroid.bind(this),this.sendFns[AppPlatform.WinPhone]=void 0,this.sendFns[AppPlatform.Chrome]=this.sendToAppChrome.bind(this),this.sendFns[AppPlatform.Electron]=this.sendToAppElectron.bind(this),this.setupFn=this.setupFns[p.a.appPlatform],this.sendFn=this.sendFns[p.a.appPlatform],this.init(),this._isEnabled=!0}catch(e){log("Native API Bridge Disabled"),r.default.reportError(e)}else this._isEnabled=!1;this._embedBridge=void 0,(p.a.app||p.a.embed)&&(r.default.Assert(void 0===window.__MoodoBridge,"Must not have a previous bridge in place"),window.__MoodoBridge={},this._canRegisterAPIs=!0,this._inboundAPIs={},this._outboundAPIs={})}Kn.prototype={init:function(){r.default.Assert(this.setupFn,"Must have a valid setup function"),r.default.Assert(this.sendFn,"Must have a valid send function"),this.setupFn&&this.sendFn&&(this.initAppEvents(),this.setupFn(),this.backlog=r.default.nativeBacklog,this.flushBacklog(),p.a.isFeatureEnabled(l.a.Feature.OAuth)&&f.default.addOAuthMethod(OAuthSchemeType.Native),window.__testNative=function(e,t){log("Sending To App: "+e),this.nativeBridge.sendToApp(e,t)}.bind(this))},isEnabled:function(){return this._isEnabled},flushBacklog:function(){var e=0;this.flushingBacklog=!0;for(var t=0;t<this.backlog.length;++t){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var i=this.backlog[t];this.sendToApp(i.method,i.data)}this.flushingBacklog=!1},addToBacklog:function(e,t){r.default.Assert(!this.flushingBacklog,"Should never be adding to backload while flushing it"),this.flushingBacklog||this.backlog.push({method:e,data:t})},registerEmbedBridge:function(e){r.default.Assert(e,"Must supply a valid embed bridge"),r.default.Assert(p.a.embed,"Must be embedded"),this._embedBridge=e},hasEmbedBridge:function(){return!!this._embedBridge},sendToEmbed:function(e,t){r.default.Assert(this.hasEmbedBridge(),"Must have a valid embed bridge to send message: ",e),this._embedBridge.handleEmbedMessage(e,t)},registerInboundAPI:function(e){if(r.default.Assert(!this._inboundAPIs[e],"Should not have already registered an outbound API with this name"),this._canRegisterAPIs){var t=new Wn(e);return this._inboundAPIs[e]=t,t}},registerOutboundAPI:function(e){if(r.default.Assert(!this._outboundAPIs[e],"Should not have already registered an outbound API with this name"),this._canRegisterAPIs){var t=new jn(e);return this._outboundAPIs[e]=t,t}},initAppEvents:function(){window.appEvents=this.appEvents,window.reportLowMemory=this.appEvents.reportLowMemory,window._SENDJSMESSAGE_=this.handleNativeMessage},setupChrome:function(){window.addEventListener("message",this.onChromeMessage.bind(this))},setupAndroid:function(){},setupiOS:function(){this.setupiOSUI(),v.a.registerSaveNotify(this.onSaveChange.bind(this))},setupiOSUI:function(){this.iframeApp=document.createElement("IFRAME"),this.iframeApp.setAttribute("height","1px"),this.iframeApp.setAttribute("width","1px"),this.iframeApp.id="appComm",document.documentElement.appendChild(this.iframeApp)},setupElectron:function(){window.electronRequire?(this.ipcBridge=window.electronRequire("electron").ipcRenderer,this.ipcBridge.on("appEvents",function(e,t){this.handleNativeMessage(t.action,t.data)}.bind(this))):(this.ipcBridge=window.___electronIPCBridge,this.ipcBridge&&(this.ipcBridge.handleMessage=this.handleNativeMessage.bind(this)))},onSaveChange:function(e){this.isPokingBackground&&(this.sendToApp("pokeChanged",e>0?"true":"false"),this.isPokingBakground=!1)},onChromeMessage:function(e){if(0===e.origin.indexOf("chrome"))if(this.appWindow&&this.appOrigin||(this.appWindow=event.source,this.appOrigin=event.origin,setTimeout(this.flushBacklog.bind(this),0)),e.data&&r.default.isString(e.data)){var t=e.data.indexOf(":"),i=e.data.substr(0,t),a=e.data.substr(t+1);switch(i){case"chrome":switch(log("Chrome Message: ",i,"->",a),a){case"start":this.sendToApp("loaded");break;default:log("Unhandled Chrome Message: ",a)}break;default:this.handleNativeMessage(i,a)}}else log("Invalid Chrome Message: ",e.data)},sendToApp:function(e,t){r.default.Assert(p.a.app,"Only use native bridge when creating an app"),r.default.Assert(this.sendFn,"Must have a valid send method for the native bridge");var i=!1;try{var a;t&&(a=r.default.isString(t)?t:JSON.stringify(t)),this.sendFn&&(this.sendFn(e,a),i=!0)}catch(e){r.default.reportError(e)}return i},sendToAppiOS:function(e,t){p.a.ioswk?this.sendToAppiOS8(e,t):this.sendToAppiOS7(e,t)},sendToAppiOS7:function(e,t){if(this.iframeApp){var i="duchess://"+e;void 0!==t&&(i+="//"+t),this._addiOS7Queue(i)}else this.addToBacklog(e,t)},_addiOS7Queue:function(e){this._iOS7Queue.push(e),this._iOS7QueueTimeout||(this._iOS7QueueTimeout=setTimeout(this._pumpiOS7Queue.bind(this),17))},_pumpiOS7Queue:function(){var e=this._iOS7Queue.shift();r.default.Assert(e,"Must have a valid href",e),this.iframeApp.src=e,this._iOS7Queue.length>0?this._iOS7QueueTimeout=setTimeout(this._pumpiOS7Queue.bind(this),17):this._iOS7QueueTimeout=void 0},sendToAppiOS8:function(e,t){if(window.webkit.messageHandlers&&window.webkit.messageHandlers.MoodoEvents){var i=e;void 0!==t&&(i+="//"+t),window.webkit.messageHandlers.MoodoEvents.postMessage(i)}else this.addToBacklog(e,t)},sendToAppAndroid:function(e,t){window.AppInterface&&void 0!==window.AppInterface.sendAppMessage&&null!==window.AppInterface.sendAppMessage?window.AppInterface.sendAppMessage(e,t):this.addToBacklog(e,t)},sendToAppChrome:function(e,t){if(this.appWindow){var i=e+":";void 0!==t&&(i+=t),this.appWindow.postMessage(i,"*")}else this.addToBacklog(e,t)},sendToAppElectron:function(e,t){if(this.ipcBridge){var i=e+":";void 0!==t&&(i+=t),this.ipcBridge.send("moodo-message",i)}else this.addToBacklog(e,t)},handleNativeMessage:function(e,t){try{window.appEvents[e]?window.appEvents[e](t):e.startsWith("-")||r.default.reportError(new Error("Calling invalid JS method from native: "+e))}catch(e){r.default.reportError(e)}},appEvents:{undo:function(){log("Native Undo"),r.default.sendEvent("Hotkey","ShakeUndo"),y.a.undoAction()},redo:function(){log("Native Redo"),r.default.sendEvent("Hotkey","ShakeRedo"),y.a.redoAction()},selectAll:function(){r.default.focusedPane&&qn.default.handleSelectAll(r.default.focusedPane)},kbsize:function(e){e>0&&+e!==p.a.getKBSize()&&(p.a.setKBSize(e),r.default.keyboardToolbar&&r.default.keyboardToolbar.updatePosition())},closeKeyboard:function(){r.default.menus&&r.default.menus.isModalOpen(Modals.EmailCompose)||(M.a.closeKeyboard(),ct.a.reset())},enterBackground:function(){r.default.AppCache&&r.default.AppCache.checkForUpdate(!1,!0),r.default.vmMain.onUnload()},enterForeground:function(){v.a.poke(),r.default.checkForRemoteChanges(),r.default.AppCache&&r.default.AppCache.endRunUpdate(),g.a.fireEvent("enterForeground",[])},backButtonPressed:function(){M.a.fireKeyEvent(document.documentElement,{normCode:KeyCode.Escape})},quickAddItems:function(e){try{for(var t=0,i=e.replace(/\r/g," ").replace(/\n/g," "),a=JSON.parse(i),n=0;n<a.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=a[n];log("Quick Add Item: ",s),r.default.vmMain.dropBucket.addTextEntry(s.key,s.value),r.default.vmMain.dropBucket.persistTextEntry(s.key)}r.default.nativeBridge.sendToApp("quickAddConsumed",[])}catch(t){r.default.reportError(t,e)}},pokeBackground:function(){r.default.nativeBridge.isPokingBackground=!0,v.a.poke()},reportLowMemory:function(e){r.default.handleLowMemory(e)},statusBarTap:function(){r.default.focusedPane&&r.default.focusedPane.setScrollOffset(0,ScrollDuration.Default)},features:function(e){try{var t=JSON.parse(e);t.oauth&&(p.a._enableFeature(l.a.Feature.OAuth),f.default.addOAuthMethod(OAuthSchemeType.Native)),t.version&&p.a.recordAppSubVersion(t.version),!1===t.notifications&&p.a.disallowNativeNotifications()}catch(e){r.default.reportError(e)}},notifyOAuth:function(e){try{r.default.isString(e)&&(e=JSON.parse(e)),f.default.handleNativeOAuthResponse(e)}catch(e){r.default.reportError(e)}},onMenuClick:function(e){if("NewMessage"===e||"NewEmail"===e){var t=r.default.vmMain.getDefaultEmailPlugin();t.isEnabled()?r.default.menus.openComposeEmail(t):r.default.toasts.pushMessage(MessageID.NeedGmailPermission)}else"NewPane"===e?ji.a.hotkeyAddPane():"NewItem"===e?ji.a.hotkeyNewItem():"Preferences"===e?r.default.menus.openSettings():"DisplaySettings"===e?r.default.menus.openDisplaySettings():"ToggleSidebar"===e?ya.a.toggleSidebar():r.default.reportError(new Error("Unknown Native Menu Click: "+e))},reportError:function(e){r.default.reportError(new Error("Native Error"),e)},downloadProgress:function(e){r.default.handleNativeDownloadProgress(e)}}};var Yn=Kn,Xn=["4.95","49.95","5","49"],Qn=p.a.demo;function Jn(){this._premiumStatus=new w.a(PremiumStatus.Unknown),Qn&&this._premiumStatus.set(PremiumStatus.Active),this.hasPremiumFeaturesObservable=new x.a([this._premiumStatus],function(){return this.hasPremiumFeatures()}.bind(this)),this._lastSignupError=-1,this._earlyAdopter=!1,this._inviteCode=void 0,this._referredBy=void 0,this._joinDate=void 0,this._premiumStartDate=void 0,this._premiumEndDate=void 0,this._premiumCode=void 0,this._premiumCodeExpired=!1,this._nextBillingDate=void 0,this._trialStart=void 0,this._trialDuration=void 0,this._trialExtended=void 0,this._pricingSelected=l.a.Pricing.None,this._billingIdentifier=void 0,this._hasValidBillingData=new w.a(!1),this.daysLeftInTrial=new w.a(-1),this.inviteCodeError=new w.a,this.inviteEmailError=new w.a,this.inviteEmailSuccess=new w.a,this.init()}Jn.prototype={init:function(){if(this._premiumStatus.listen(function(e,t){r.default.vmMain&&r.default.vmMain.pluginManager&&(this.hasPremiumFeatures()?(r.default.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.EarlyAccess),r.default.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.PremiumSub)):this.hasEarlyAccess()&&r.default.vmMain.pluginManager.notifyDependencyLoad(PluginDependency.EarlyAccess)),e!==t&&t&&un.a.onSettingChanged()}.bind(this)),Qn)setTimeout(function(){j.a.setConnected()},1500);else{var e=r.default.settings.get(Settings.premiumStatus),t=o.a.getURLParam("premium");if(void 0!==t&&o.a.removeURLParam("premium",!0),void 0!==e){0;var i=r.default.settings.get(Settings.trialStart)||Date.now(),a=r.default.settings.get(Settings.trialDuration)||0,n=r.default.settings.get(Settings.trialExtended)||!1;this._updateTrialDaysLeft(i,a,n);var s=r.default.settings.get(Settings.premiumEndDate)||Date.now();this._premiumEndDate=new Date(s),this.setPremiumStatus(e),t&&setTimeout(function(){r.default.menus.openSettings(l.a.SettingsSections.Account)},100)}this.checkRemotePremiumStatus()}},runServerPing:function(e){r.default.XHR_PrivateAPI({type:"POST",path:"/user/ping",data:{platformConfig:p.a.getUserPlatformConfig()},requireAuth:!0,cb:function(t){t.status!==l.a.HTTPStatusCode.Success&&log("Failed to notify server of lastSeen: ",t.status,t.response),e&&e()}})},checkRemotePremiumStatus:function(){r.default.Assert(!r.default.isDemoMode()||!1,"Should not be querying for premium status in demo mode"),j.a.setConnecting(),j.a.onUserAuthorized("me","checkRemotePremiumStatus",function(){var e=this.getBillingIdentifier(),t={email:e,gid:j.a.getDefaultGID(),lastTaskSync:r.default.settings.get(Settings.lastTaskSync),lastQuickAddSync:r.default.settings.get(Settings.lastQuickAddSync),clientVersion:window.__jsVersion,platformConfig:p.a.getUserPlatformConfig()};r.default.XHR_PrivateAPI({type:"POST",path:"/billing/getStatus",data:t,requireAuth:!0,autoRetry:!0,maxRetries:6,cb:function(t){var i=o.a.hasURLParam("invite"),a=!1;if(j.a.setNotConnecting(),t.status===l.a.HTTPStatusCode.Success&&t.response)try{j.a.setConnected();var n=JSON.parse(t.response).data;if(this.setBillingData(n),n.linkedAccounts)for(var s=0,d=0;d<n.linkedAccounts.length;++d){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;try{var u=n.linkedAccounts[d],c=PrivateAPIErrorCodes.Success;u.token||(c=PrivateAPIErrorCodes.TokenMissing),j.a.updateServerLinkedAccount(u.email,u.gid,u.name,u.scopes,u.token,c)}catch(e){r.default.reportError(e)}}if(j.a.isAccountValidLinked(e)?j.a.notifyRemoteAccountsLinked():(log("Missing account token: ",e),f.default.ensureScopeAccess(function(e){r.default.Assert(e,"Must always be able to receive permission for unknown scopes"),j.a.notifyRemoteAccountsLinked()})),n.tasks&&r.default.vmMain.deferredTaskManager.notifyRemoteTasks(n.tasks),n.quickAddItems&&r.default.vmMain.dropBucket.notifyRemoteItems(n.quickAddItems),window.__GLOBAL_CLOCK||r.default.vmMain.recurringTaskManager.hasRecurringTask("ServerPing")||r.default.vmMain.recurringTaskManager.createRecurringTask("ServerPing",{delay:r.default.hours(24),minDelay:r.default.hours(24),runOnCreate:!1,pauseWhileIdle:!1,minDelayOnResume:!1,async:!0,task:this.runServerPing.bind(this)}),i){a=!0,r.default.sendEvent("Billing","URLReferralCode");var h=o.a.getURLParam("invite");r.default.XHR_PrivateAPI({type:"POST",path:"/sharing/setReferral",data:{email:this.getBillingIdentifier(),refCode:h},requireAuth:!0,autoRetry:!0,cb:function(e){if(e.status===l.a.HTTPStatusCode.Success){switch(r.default.toasts.clearMessage(MessageID.InviteFailure),r.default.toasts.clearMessage(MessageID.InviteInvalid),h.toUpperCase()){case"PRODUCTHUNT":r.default.toasts.pushMessage({text:"You have successfully applied your ProductHunt promotion. Thanks for checking out Moo.do!"});break;default:r.default.toasts.pushMessage(MessageID.InviteSuccess)}o.a.removeURLParam("invite",!0),this.checkRemotePremiumStatus()}else try{var t=JSON.parse(e.response).data;["PRODUCTHUNT","UMICHEDU"].indexOf(h.toUpperCase())<0&&(t.code===PrivateAPIErrorCodes.InvalidReferralCode||t.code===PrivateAPIErrorCodes.InvalidParameter?r.default.toasts.pushMessage(MessageID.InviteInvalid):r.default.toasts.pushMessage(MessageID.InviteFailure))}catch(e){r.default.reportError(e)}}.bind(this)})}if(r.default.isFlagSet(n.loginFlags,l.a.LoginFlags.TrialAutoReset)&&r.default.toasts.pushMessage({text:"Your premium trial was reset. Please visit your account settings to learn more.",action:MessageAction.OpenSettings}),n.premiumStatus===PremiumStatus.Trial){if(r.default.Assert(void 0!==n.trialStart,"Must have a valid trialStart set"),r.default.Assert(void 0!==n.trialDuration,"Must have a valid trialDuration set"),n.trialStart&&n.trialDuration)try{var p=new Date(n.trialStart).getTime();r.default.settings.set(Settings.trialStart,p),r.default.settings.set(Settings.trialDuration,n.trialDuration),r.default.settings.set(Settings.trialExtended,n.trialExtended),this._updateTrialDaysLeft(p,n.trialDuration,n.trialExtended)}catch(e){r.default.reportError(e)}else this.setPremiumStatus(PremiumStatus.TrialOver),r.default.settings.set(Settings.trialStart,Date.now()),r.default.settings.set(Settings.trialDuration,0);r.default.isFlagSet(n.loginFlags,l.a.LoginFlags.OldUserNewTrial)&&r.default.vmMain.oldUserNewTrial()}else if(n.premiumStatus===PremiumStatus.CanceledUser||n.premiumStatus===PremiumStatus.CanceledPastDue)if(n.premiumEndDate)try{var g=new Date(n.premiumEndDate).getTime();r.default.settings.set(Settings.premiumEndDate,g)}catch(e){r.default.reportError(e)}else r.default.settings.set(Settings.premiumEndDate,Date.now());else n.premiumStatus===PremiumStatus.TrialOver?(this.daysLeftInTrial.set(-1),r.default.isFlagSet(n.loginFlags,l.a.LoginFlags.TrialOver)&&this.notifyTrialOver()):n.premiumStatus===PremiumStatus.Active?(r.default.toasts.clearMessage(MessageID.TrialOver),r.default.settings.get(Settings.notifiedTrialOver)&&r.default.settings.set(Settings.notifiedTrialOver,!1)):r.default.isFlagSet(n.loginFlags,l.a.LoginFlags.NewUser)&&j.a.getSignupUserData(function(e){r.default.reportSignup(e.email,e)})}catch(e){r.default.reportError(e)}else try{if(t.response)(n=JSON.parse(t.response)).code===PrivateAPIErrorCodes.NoSignupFound?(a=!0,j.a.getSignupUserData(function(e){r.default.reportSignup(e.email,e,function(e){e?this.checkRemotePremiumStatus():this._reportRemoteStatusFailure()}.bind(this))}.bind(this))):this._reportRemoteStatusFailure();else this._reportRemoteStatusFailure()}catch(e){this._reportRemoteStatusFailure(),r.default.reportError(e)}i&&!a&&r.default.toasts.pushMessage(MessageID.InviteFailure)}.bind(this)})}.bind(this))},setLastSignupError:function(e){this._lastSignupError=e},_reportRemoteStatusFailure:function(){r.default.sendEvent("Billing","RemoteStatusFailure")},_updateTrialDaysLeft:function(e,t,i){var a=t-Math.ceil((Date.now()-e)/864e5);r.default.Assert(a<=320,"Sanity check on trial length",a),this._trialStart=e,this._trialDuration=t,this._trialExtended=i,this.daysLeftInTrial.set(a),this._premiumStatus.get()===PremiumStatus.Trial&&a<0?(this.setPremiumStatus(PremiumStatus.TrialOver),this.notifyTrialOver()):this._premiumStatus.get()===PremiumStatus.Trial&&a<5&&this.notifyTrialEndSoon()},getBillingIdentifier:function(){var e;this._billingIdentifier||(e=j.a.isCurrentlyAuthorized("me")?j.a.getDefaultEmail():r.default.getActiveUser())&&(this._billingIdentifier=e);return this._billingIdentifier},onBillingIdentifierAvailable:function(e){this._billingIdentifier?setTimeout(e,0):j.a.onUserAuthorized("me","onBillingIdentifierAvailable",e)},onConnected:function(e){return j.a.onConnected(e)},hasPremium:function(){return this._premiumStatus.get()===PremiumStatus.Active||this._premiumStatus.get()===PremiumStatus.PastDue},isTrialState:function(){return this._premiumStatus.get()===PremiumStatus.Trial||this._premiumStatus.get()===PremiumStatus.TrialOver},isCanceledState:function(){return this._premiumStatus.get()===PremiumStatus.CanceledUser||this._premiumStatus.get()===PremiumStatus.CanceledPastDue},canceledUserHasPremiumAccess:function(){return this.isCanceledState()&&this.getPremiumEndDate().getTime()>Date.now()},isInFreeMonthAndPremium:function(){return(this.hasPremium()||this.canceledUserHasPremiumAccess())&&this._nonReferralDiscounts>=100},hasSubscription:function(){return!this._premiumCode},setBillingData:function(e){r.default.Assert(e,"Must have a valid data bundle"),this._earlyAdopter=e.earlyAdopter,this._loginFlags=e.loginFlags||l.a.LoginFlags.None,this._inviteCode=e.inviteCode,this._referredBy=e.referredBy,this._joinDate=e.joinDate?new Date(parseInt(e.joinDate)):new Date,this._premiumStartDate=e.premiumStartDate?new Date(parseInt(e.premiumStartDate)):new Date,this._premiumEndDate=e.premiumEndDate?new Date(parseInt(e.premiumEndDate)):new Date,this._premiumCode=e.premiumCode,this._premiumCodeExpired=e.premiumCodeExpired||!1,this._nextBillingDate=e.nextBillingDate?new Date(parseInt(e.nextBillingDate)):new Date,this._trialStart=e.trialStart?new Date(parseInt(e.trialStart)):new Date,this._trialDuration=e.trialDuration||0,this._trialExtended=e.trialExtended||!1,r.default.settings.set(Settings.isUnsubscribed,!!e.isUnsubscribed),r.default.settings.set(Settings.monthlyInvoice,!!e.monthlyInvoice),r.default.settings.set(Settings.invoiceEmail,e.invoiceEmail),r.default.settings.set(Settings.invoiceCompany,e.invoiceCompany),r.default.settings.set(Settings.invoiceAddress,e.invoiceAddress),this.setPremiumStatus(e.premiumStatus),this._hasValidBillingData.set(!0)},setPremiumStatus:function(e){r.default.Assert(r.default.isNumber(e),"Status must be a valid number",e),r.default.Assert(e>0&&e<8,"Should be a valid status identifier",e),e!==this._premiumStatus.get()&&(this._premiumStatus.set(e),r.default.settings.set(Settings.premiumStatus,e),r.default.fireCustomEvent("premiumStatusChanged"),r.default.setDimension(l.a.Analytics.Dimensions.PremiumStatus,e))},hasValidBillingData:function(){return this._hasValidBillingData.get()},getPremiumStatus:function(){return this._premiumStatus.get()},getInviteCode:function(){return this._inviteCode},getJoinDate:function(){return this._joinDate||new Date},getPremiumStartDate:function(){return this._premiumStartDate||new Date},getPremiumEndDate:function(){return this._premiumEndDate||new Date},hasTrialExtended:function(){return this._trialExtended||!1},isEligibleForTrialExtension:function(){return!1},getNextBillingDate:function(){return this._nextBillingDate||new Date},hasEarlyAccess:function(){return this.hasPremiumFeatures()||this.canceledUserHasPremiumAccess()},onTapCancelSubscription:function(e,t){r.default.sendEvent("Billing","SubCancelTapped");var i=function(){t&&r.default.isFunction(t)&&t()};return r.default.menus.confirm("Are you sure you want to cancel your subscription?",function(e){e?(r.default.sendEvent("Billing","SubCancelYES"),r.default.XHR_PrivateAPI({type:"POST",path:"/billing/cancel",data:{email:this.getBillingIdentifier()},requireAuth:!0,cb:function(e){var t;if(200===e.status&&e.response){var a;try{a=JSON.parse(e.response)}catch(e){r.default.reportError(e)}if(a){var n=a.data,s=new Date(n.premiumEndDate).getTime();this._premiumEndDate=new Date(s),r.default.settings.set(Settings.premiumEndDate,s),this.setPremiumStatus(PremiumStatus.CanceledUser),t="Your premium subscription has been canceled. Please contact support@moo.do if you need assistance."}else t="There was a server error, please try again in a few minutes or contact support@moo.do."}else t="There was a server error, please try again in a few minutes or contact support@moo.do.";r.default.menus.alert({text:t,actionText:"OKAY"}),i()}.bind(this)})):(i(),r.default.sendEvent("Billing","SubCancelNO"))}.bind(this)),!0},getCustomPurchaseURL:function(){var e=r.default.vmMain.getUserID(),t=r.default.vmMain.getUserEmail(),i=j.a.getDefaultAccessToken();return window.location.protocol+"//"+window.location.host+"/purchase/#gid="+encodeURIComponent(e)+"&email="+encodeURIComponent(t)+"&token="+encodeURIComponent(i)},_openPaymentWindow:function(e){if(p.a.requireCustomPurchase)r.default.openUrl(this.getCustomPurchaseURL());else if(p.a.requireCustomPaypal){var t="Credit Card";r.default.menus.options("If you are using PayPal, a new window will be opened to complete your purchase.",["PayPal",t],function(i){(i===t||"PayPal"===i)&&(i===t?r.default.menus.openModalNew(Modals.Billing,{isUpdate:e}):"PayPal"===i&&r.default.openUrl(this.getCustomPurchaseURL()))}.bind(this))}else r.default.menus.openModalNew(Modals.Billing,{isUpdate:e})},onTapUpdatePaymentMethod:function(){this._openPaymentWindow(!1)},onTapViewInvoices:function(){r.default.XHR_PrivateAPI({type:"GET",path:"/billing/listTransactions",requireAuth:!0,cb:function(e){var t;try{t=JSON.parse(e.response)}catch(e){r.default.reportError(e)}200===e.status&&t?r.default.menus.openModalNew(Modals.Invoices,t.data):r.default.menus.alert({text:"There was an error retreiving your invoice data. Please contact support@moo.do.",callback:r.default.emptyFn})}})},onTapDeleteAccount:function(e,t){r.default.Assert(t&&r.default.isFunction(t),"Delete account cannot be called without a callback"),r.default.sendEvent("Billing","DeleteAccountTapped");var i=function(){t&&r.default.isFunction(t)&&t()},a=function(e){e?(r.default.sendEvent("Billing","DeleteAccountYES"),f.default.deleteAccount(function(e,t){e||t===f.default.DeleteErrorCode.RootFolder?r.default.vmMain.docManager.deleteAllDocs(function(e){e?r.default.XHR_PrivateAPI({type:"POST",path:"/tracking/delete",data:{email:this.getBillingIdentifier()},requireAuth:!0,cb:function(e){200===e.status?r.default.menus.alert({text:"Your account has been successfully deleted.",actionText:"OKAY",callback:function(){r.default.vmSetup.logout()}}):r.default.menus.alert({text:"There was an error removing your email address from our server. Please contact support@moo.do for further assistance with code 3.",actionText:"OKAY"}),i()}}):(r.default.menus.alert({text:"There was an error deleting your Moo.do documents. Please contact support@moo.do for further assistance with code 2.",actionText:"OKAY"}),i())}.bind(this)):(r.default.menus.alert({text:"There was an error deleting your shared account data. Please contact support@moo.do for further assistance with code 1.",actionText:"OKAY"}),i())}.bind(this))):(i(),r.default.sendEvent("Billing","DeleteAccountNO"))}.bind(this);return r.default.menus.openModalNew(Modals.DeleteAccount,{callback:a}),!0},getInviteUrl:function(){return"https://www.moo.do/"},getSelectText:function(){return"Select and press "+p.a.cmdChar+" + C to copy to clipboard"},wasInvited:function(){return!!this._referredBy},submitInviteCode:function(e,t){if(e&&e.length>2)return r.default.sendEvent("Billing","EnterRefCode"),r.default.XHR_PrivateAPI({type:"POST",path:"/sharing/setReferral",data:{email:this.getBillingIdentifier(),refCode:e},requireAuth:!0,autoRetry:!0,cb:function(e){if(e.response){try{var i=JSON.parse(e.response)}catch(e){r.default.reportError(e)}if(200===e.status&&i){var a=i.data;this._referredBy=a.referredBy,this._premiumStatus.set(a.premiumStatus);var n=new Date(a.trialStart).getTime();this._updateTrialDaysLeft(n,a.trialDuration,a.trialExtended),this.inviteCodeError.set(""),r.default.sendEvent("Billing","EnterRefCodeSuccess")}else{if(i)switch(i.code){case PrivateAPIErrorCodes.AlreadyReferred:this.inviteCodeError.set(""),this.checkRemotePremiumStatus();break;case PrivateAPIErrorCodes.InvalidReferralCode:this.inviteCodeError.set("Referral code not found");break;default:this.inviteCodeError.set("Unable to use referral code")}else this.inviteCodeError.set("Unable to contact server");r.default.sendEvent("Billing","EnterRefCodeFailure")}}else this.inviteCodeError.set("Unable to contact server"),r.default.sendEvent("Billing","EnterRefCodeFailure");t&&t()}.bind(this)}),!0;this.inviteCodeError.set("Please enter a valid code")},sendInviteEmail:function(e,t){if(e&&e.length>0){for(var i=0,a=[],n=/.+@.+\..+/i,s=[],o=0;o<e.length;++o){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;n.lastIndex=0;var l=e[o];l&&(l=l.trim(),null===n.exec(l)?a.push(l):s.push(l))}if(0===a.length)return r.default.sendEvent("Billing","SendReferralEmail",s.length),r.default.XHR_PrivateAPI({type:"POST",path:"/sharing/sendReferral",data:{fromUser:this.getBillingIdentifier(),toEmailList:s},requireAuth:!0,autoRetry:!1,cb:function(e){if(t&&t(),200===e.status&&e.response){var i;try{i=JSON.parse(e.response).data}catch(e){r.default.reportError(e)}if(i&&0!==i.length){for(var a,n=0,s=[];o<i.length;++o){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;s.push(i[0].email),a||(a=i[0].reason)}"exists"===a?this.inviteEmailError.set("One or more of the users is already a Moo.do user."):this.inviteEmailError.set("One or more of your emails could not be sent.")}else this.inviteEmailSuccess.set("Invite emails sent!"),this.inviteEmailError.set(""),setTimeout(function(){this.inviteEmailSuccess.set("")}.bind(this),4e3)}else this.inviteEmailError.set("Sorry! There was an error sending emails, please try again later.")}.bind(this)}),!0;this.inviteEmailError.set("Please enter a valid email: "+a[0])}},joinDateText:function(){return this.getJoinDate().toString(H.a.getFormat(DFormat.LongStrDate))},premiumStartDateText:function(){return this.getPremiumStartDate().toString(H.a.getFormat(DFormat.LongStrDate))},premiumEndDateText:function(){return this.getPremiumEndDate().toString(H.a.getFormat(DFormat.LongStrDate))},nextBillingDateText:function(){return this.getNextBillingDate().toString(H.a.getFormat(DFormat.LongStrDate))},shareTwitter:function(){var e="https://twitter.com/share?url="+escape(this.getInviteUrl())+"&text=I love this new organization app!";this.showPopup(e,550,420),r.default.sendEvent("Billing","ShareTwitter")},shareFacebook:function(){var e="https://www.facebook.com/sharer/sharer.php?u="+escape(this.getInviteUrl());this.showPopup(e,600,303),r.default.sendEvent("Billing","ShareFacebook")},shareGoogle:function(){var e="https://plus.google.com/share?url="+this.getInviteUrl();this.showPopup(e,500,650),r.default.sendEvent("Billing","ShareGoogle")},showPopup:function(e,t,i){var a=t,n=i,s=window.screen.height,r=window.screen.width,o="scrollbars=yes,resizable=yes,toolbar=no,location=yes,width="+a+",height="+n+",left="+Math.round(r/2-a/2)+",top="+Math.round(s/2-n/2);window.open(e,null,o)},onTapSignupMonth:function(){this._pricingSelected=this.getMonthlyPricing(),this._openPaymentWindow(!1),r.default.sendEvent("Billing","OpenSignupModal")},onTapSignupYear:function(){this._pricingSelected=this.getYearlyPricing(),this._openPaymentWindow(!1),r.default.sendEvent("Billing","OpenSignupModal")},onTapCodeSignup:function(){r.default.menus.openModalNew(Modals.EnterCode,{}),r.default.sendEvent("Blling","OpenEnterCodeModal")},redeemCode:function(e){r.default.isString(e)&&e.length>10?r.default.XHR_PrivateAPI({type:"POST",path:"/billing/useCode",requireAuth:!0,autoRetry:!0,data:{code:e},cb:function(t){if(t.status===l.a.HTTPStatusCode.Success)try{var i=JSON.parse(t.response).data;this._premiumStartDate=new Date(r.default.parseInt(i.premiumStartDate)),this._premiumEndDate=new Date(r.default.parseInt(i.premiumEndDate)),this._nextBillingDate=new Date(r.default.parseInt(i.nextBillingDate)),this._premiumCode=e,this._premiumCodeExpired=!1,this.setPremiumStatus(i.premiumStatus),r.default.toasts.pushMessage({text:"Success! Thank you for going premium!",timeout:8e3})}catch(e){r.default.reportError(e)}else t.status===l.a.HTTPStatusCode.BadRequest?r.default.toasts.pushMessage({text:"The code that you entered was not valid or has already been used.",timeout:8e3}):r.default.toasts.pushMessage({text:"There was an error processing your request. Please contact support@moo.do for help.",timeout:8e3})}.bind(this)}):r.default.toasts.pushMessage({text:"The code that you entered was not valid.",timeout:8e3})},getMonthlyPricing:function(){return this._earlyAdopter?l.a.Pricing.EarlyMonthly:l.a.Pricing.RegMonthly},getYearlyPricing:function(){return this._earlyAdopter?l.a.Pricing.EarlyYearly:l.a.Pricing.RegYearly},getMonthlyPrice:function(){return Xn[this.getMonthlyPricing()]},getYearlyPrice:function(){return Xn[this.getYearlyPricing()]},getPlanPrice:function(e){return Xn[e]},notifyTrialOver:function(){if(!r.default.settings.get(Settings.notifiedTrialOver)){if(!r.default.toasts)return void setTimeout(this.notifyTrialOver.bind(this),0);r.default.toasts.pushMessage(MessageID.TrialOver),r.default.settings.set(Settings.notifiedTrialOver,!0)}},notifyTrialEndSoon:function(){if(!r.default.settings.get(Settings.notifiedTrialEndSoon)){if(!r.default.toasts)return void setTimeout(this.notifyTrialEndSoon.bind(this),0);r.default.toasts.pushMessage(MessageID.TrialEndSoon),r.default.settings.set(Settings.notifiedTrialEndSoon,!0)}},isTrialOver:function(){var e=!1;return this._premiumStatus.get()===PremiumStatus.TrialOver?e=!0:this._premiumStatus.get()!==PremiumStatus.CanceledUser&&this._premiumStatus.get()!==PremiumStatus.CanceledPastDue||this.canceledUserHasPremiumAccess()||(e=!0),e},startTrial:function(){r.default.Assert(!this.isTrialOver(),"Should never try to start a trial once it is over"),r.default.XHR_PrivateAPI({type:"POST",path:"/billing/startTrial",requireAuth:!0,autoRetry:!0,cb:function(e){if(e.status===l.a.HTTPStatusCode.Success){this._premiumStatus.set(PremiumStatus.Trial);try{var t=JSON.parse(e.response).data,i=new Date(t.trialStart).getTime();r.default.settings.set(Settings.trialStart,i),r.default.settings.set(Settings.trialDuration,t.trialDuration),r.default.settings.set(Settings.trialExtended,t.trialExtended),this._updateTrialDaysLeft(i,t.trialDuration,t.trialExtended)}catch(e){r.default.reportError(e)}}else if(e.status===l.a.HTTPStatusCode.BadRequest)try{(t=JSON.parse(e.response)).code===PrivateAPIErrorCodes.TrialOver&&(r.default.toasts.pushMessage({text:"Your free trial of Premium has ended. Please contact support@moo.do to extend.",actionText:"OKAY"}),this._premiumStatus.set(PremiumStatus.TrialOver))}catch(e){r.default.reportError(e)}else r.default.Assert(!1,"Failed to start trial for user"),r.default.toasts.pushMessage({text:"There was an error starting your trial. Please contact support@moo.do.",action:MessageAction.Contact})}.bind(this)})},extendTrial:function(){r.default.XHR_PrivateAPI({type:"POST",path:"/billing/extendTrial",requireAuth:!0,autoRetry:!0,cb:function(e){if(e.status===l.a.HTTPStatusCode.Success){this._premiumStatus.set(PremiumStatus.Trial);try{var t=JSON.parse(e.response).data,i=new Date(t.trialStart).getTime();r.default.settings.set(Settings.trialStart,i),r.default.settings.set(Settings.trialDuration,t.trialDuration),r.default.settings.set(Settings.trialExtended,t.trialExtended),this._updateTrialDaysLeft(i,t.trialDuration,t.trialExtended)}catch(e){r.default.reportError(e)}}else r.default.Assert(!1,"Failed to extend trial for user"),r.default.toasts.pushMessage({text:"There was an error restarting your trial. Please contact support@moo.do.",action:MessageAction.Contact})}.bind(this)})},hasPremiumFeatures:function(){return this.hasPremium()||this._premiumStatus.get()===PremiumStatus.Trial||this.canceledUserHasPremiumAccess()},getBillingPeriod:function(){return this._pricingSelected}};var Zn=Jn,$n=0;function es(e,t){if(r.default.Assert(e,"Must provide valid message info"),r.default.Assert(t,"Must provide a valid message owner"),o.a.binder(this,"hide","onTapIgnore"),this.info=e,this.id=e.id||"Message_"+$n++,this.owner=t,this.timeout=e.timeout||l.a.ToastTimeoutDefault,this.text=new w.a(e.text),this.action=e.action||MessageAction.Default,this.isBig=e.big,this.data=e.data,this.hold=!e.timeout&&!1!==e.hold&&(e.hold||this.action!==MessageAction.Default),this.noIgnore=e.noIgnore,this.onCloseFn=e.onClose,this.clearTimeout=void 0,this._isVisible=!1,this.actionText=e.actionText,!this.actionText)switch(this.action){case MessageAction.Default:this.actionText="";break;case MessageAction.Reload:case MessageAction.ResetClient:this.actionText="RELOAD";break;case MessageAction.Okay:this.actionText="OKAY";break;case MessageAction.Blog:this.actionText="BLOG";break;case MessageAction.Undo:this.actionText="UNDO";break;case MessageAction.LoginScreen:this.actionText="LOGIN";break;case MessageAction.Contact:this.actionText="CONTACT";break;case MessageAction.OpenSettings:case MessageAction.OpenAccountSettings:case MessageAction.OpenLinkedSettings:case MessageAction.OpenGeneralSettings:case MessageAction.OpenCalendarSettings:this.actionText="SETTINGS";break;case MessageAction.OpenGoogleDrive:this.actionText="GOOGLE DRIVE";break;case MessageAction.OpenDisplaySettings:this.actionText="DISPLAY SETTINGS";break;case MessageAction.StartDemo:this.actionText="START DEMO"}}es.prototype={show:function(){this._isVisible||(this._isVisible=!0,this.hold||(this.clearTimeout=setTimeout(this.hide,this.timeout)),this.owner.onMessageShow(this))},hide:function(e){this._isVisible&&(this._isVisible=!1,clearTimeout(this.clearTimeout),this.clearTimeout=void 0,this.onCloseFn&&this.onCloseFn(this),e||this.owner.onMessageHide(this))},isVisible:function(){return this._isVisible},doAction:function(e){if(this.isVisible()){if(r.default.isFunction(this.action))this.action();else switch(this.action){case MessageAction.None:case MessageAction.Okay:case MessageAction.Default:break;case MessageAction.Reload:r.default.reload();break;case MessageAction.Login:o.a.removeURLParam("demo");break;case MessageAction.Demo:o.a.insertURLParam("demo","true");break;case MessageAction.ResetClient:s.default.clearData(function(){r.default.reload()});break;case MessageAction.OpenURL:var t=this.data?this.data.url:void 0;r.default.Assert(t,"Should always have a valid URL to navigate"),t&&r.default.openUrl(t);break;case MessageAction.Blog:r.default.openUrl("https://www.moo.do/blog/updates");break;case MessageAction.Undo:y.a.undoAction();break;case MessageAction.LoginScreen:o.a.removeURLParam("demo",!0),o.a.removeURLParam("dmode");break;case MessageAction.Contact:r.default.menus.openModalNew(Modals.ReportBug);break;case MessageAction.OpenSettings:case MessageAction.OpenGeneralSettings:case MessageAction.OpenAccountSettings:r.default.menus.openModalNew(Modals.MobileSettings);break;case MessageAction.OpenLinkedSettings:0;break;case MessageAction.OpenCalendarSettings:r.default.menus.openModalNew(Modals.MobileSettings);break;case MessageAction.OpenGoogleDrive:r.default.openUrl("https://drive.google.com");break;case MessageAction.OpenDisplaySettings:0;break;case MessageAction.StartDemo:window.postMessage("resume","*");break;default:r.default.Assert(!1,"Invalid message action, add a new case here or pass in a function",this.action)}r.default.stopPropagation(e),this.info.holdOnAction||this.hide()}},onTapIgnore:function(e){this.isVisible()&&!this.noIgnore&&this.hide()},setText:function(e){this.text.set(e)}};var ts=es;function is(){this.queue=new k.a,this.remoteMessages={},this.defaultMessages=[],this.defaultMessages[MessageID.Undefined]=void 0,r.default.toasts=this}is.prototype={getMessageById:function(e){return void 0===this.defaultMessages[e]&&this.initMessageById(e),r.default.Assert(void 0!==this.defaultMessages[e],"After init message should always be defined"),this.defaultMessages[e]},testMessageById:function(e){return!!this.defaultMessages[e]},initMessageById:function(e){var t;switch(e){case MessageID.ConnectionError:t={text:"Connection error detected. Please reload to try again.",action:MessageAction.Reload};break;case MessageID.OfflineUndo:t={text:"Offline undo/redo has been disabled temporarily.",hold:!0};break;case MessageID.FatalError:t={text:"There was a fatal error in the application. "+p.a.actionVerbCaps()+" to restart.",action:MessageAction.Reload};break;case MessageID.MailbirdClick:t={text:"Sorry, emails can currently only be opened from inside Mailbird.",action:MessageAction.Okay};break;case MessageID.ExitDemo:t={text:"Changes are not saved in demo",action:MessageAction.LoginScreen,hold:!0,noIgnore:!0};break;case MessageID.ShareFailure:t={text:"There was an error sharing the file you attached.",action:MessageAction.OpenSettings,timeout:8e3};break;case MessageID.ThisIsDemo:t={text:"Click anywhere to try this live demo of <b>Moo.do</b>",onClose:function(){window.parent.postMessage("userInteracted","*")},hold:!0,big:!0};break;case MessageID.InviteFailure:t={text:"Failed to use referral code. Please try again in your account settings.",action:MessageAction.OpenAccountSettings};break;case MessageID.InviteSuccess:t={text:"You have successfully used your referral code. Enjoy your additional free trial of premium Moo.do!",action:MessageAction.Okay};break;case MessageID.PremiumRequired:t={text:"You must be a premium subscriber to use plugins.",action:MessageAction.OpenAccountSettings,actionText:"LEARN MORE"};break;case MessageID.TrialOver:t={text:"Your trial of Premium has come to an end. Please sign up to continue using Premium features.",action:MessageAction.OpenAccountSettings,actionText:"SETTINGS"};break;case MessageID.TrialEndSoon:t={text:"Your trial of Premium is ending soon. Please sign up to continue using Premium features after your trial ends.",action:MessageAction.OpenAccountSettings,actionText:"SETTINGS"};break;case MessageID.WarnLargeFile:t={text:"Warning: You are uploading a large file. If the upload is not successful, try uploading directly to Google Drive.",action:MessageAction.OpenGoogleDrive};break;case MessageID.InviteInvalid:t={text:"Invalid referral code. Please try again in your account settings.",action:MessageAction.OpenAccountSettings,actionText:"OKAY"};break;case MessageID.NoSharingWarning:t={text:"You have shared your document with someone else, however the files attached have not been shared due to your permissions settings.",action:MessageAction.OpenSettings,actionText:"SETTINGS"};break;case MessageID.LostPermission:t={text:"Moo.do has lost permissions for a plugin or option you enabled. Please update your plugin settings.",action:MessageAction.OpenSettings,actionText:"SETTINGS"};break;case MessageID.CalendarSync:t={text:"There was an error syncing your calendars.",action:MessageAction.OpenCalendarSettings,actionText:"SETTINGS"};break;case MessageID.EmailSendFail:t={text:"Your email was not sent, there was an error contacting the remote server."};break;case MessageID.EmailUpdateFail:t={text:"Unable to save draft to Gmail. Your draft is still saved locally."};break;case MessageID.EmailLabelFail:t={text:"Unable to sync you changes to Gmail. Your changes are still saved locally."};break;case MessageID.EmailSyncFail:t={text:"There was an error syncing your Gmail data.",action:function(){r.default.vmMain.pluginManager.getPlugin(PluginID.Gmail).runThreadSync()},actionText:"RETRY"};break;case MessageID.OldUserNewTrial:t={text:"You have been started on a premium free trial. Enable premium plugins for free!",action:MessageAction.OpenSettings,actionText:"SETTINGS"};break;case MessageID.DemoPluginClick:t={text:"Outside of demo mode this would show you more information about the plugin.",timeout:3e3};break;case MessageID.PromptScriptStart:t={text:"Start demo",hold:!0,big:!0,action:MessageAction.StartDemo};break;case MessageID.SnoozeOffline:t={text:"You must be online to Snooze. Please try again when Moo.do has connected.",action:MessageAction.Okay};break;case MessageID.NeedDrivePermission:t={text:"Attaching files already in Drive requires 'Shared Drive' to be enabled in settings.",action:MessageAction.OpenSettings};break;case MessageID.NeedGmailPermission:t={text:"Sending email requires the Gmail plugin to be enabled in settings.",action:MessageAction.OpenSettings};break;case MessageID.LostLinked:t={text:"Moo.do has lost access to one of your linked accounts.",action:MessageAction.OpenLinkedSettings};break;case MessageID.GmailDisabled:t={text:"Gmail may not be enabled on your Google account. Please contact your domain admin or reload app.",action:MessageAction.Okay};break;case MessageID.LocalWritesDisabled:t={text:"There was an error writing to the local cache. Please restart Moo.do.",action:MessageAction.Reload};break;case MessageID.MissingOffline:case MessageID.MissingOfflineMobile:t={text:"We are missing authorization for your account. Please reauthorize.",actionText:"REAUTHORIZE",action:function(){G.a.enableOfflineFeatures(!0)}};break;case MessageID.FlatSearchMultiSelect:t={text:"Editing multiple items in flat search results is not supported because it would have unpredictable results."};break;case MessageID.FlatSearchEnter:t={text:"Pressing Enter in flat search results is not supported because it would have unpredictable results."};break;case MessageID.FlatSearchTab:t={text:"Indenting search results while in flat search results is not supported because it would have unpredictable results."};break;case MessageID.ReadOnlyCalendar:t={text:"You do not have write permission for the calendar you are trying to modify."};break;case MessageID.CalendarSaveFail:t={text:"Some changes you made were not able to be saved properly. Please free up disk space and try again."};break;case MessageID.QuotaError:t={text:"You have run out of disk space. Moo.do will be unable to operate offline.",timeout:3e3};break;case MessageID.ReselectEmail:t={text:"Please re-select the email item and try again."};break;case MessageID.ReactError:t={text:"The application has encountered an error. The developers have been notified, but sending a bug report describing what happened would be very helpful!",actionText:"REPORT",action:function(){r.default.menus.openModalNew(Modals.ReportBug)}};break;default:r.default.Assert(!1,"Invalid MessageID: ",e)}t&&(this.defaultMessages[e]=new ts(t,this))},pushMessage:function(e){var t;return r.default.Assert(e,"Must supply a valid message to display"),e instanceof ts?t=e:r.default.isObject(e)?this.hasMsgWithText(e.text)||(t=new ts(e,this)):r.default.isString(e)?this.hasMsgWithText(e)||(t=new ts({text:e},this)):(t=this.getMessageById(e))||(r.default.Assert(!1,"Invalid data passed to message creation"),log("Message not created properly",e)),t&&t.show(),t},clearMessage:function(e){var t;return e instanceof ts?t=e:this.testMessageById(e)&&(t=this.getMessageById(e)),t&&t.hide(),t},isMessageVisible:function(e){var t=!1;e instanceof ts?t=e.isVisible():this.testMessageById(e)&&(t=this.getMessageById(e).isVisible());return t},onMessageShow:function(e){r.default.Assert(e,"Must pass in a valid message to add to the queue"),r.default.Assert(e&&e.doAction,"Message added to queue must have valid API exposed - doAction"),e instanceof ts?this.queue.push(e):r.default.reportError(new Error("Toast message must be an instance of Toast"),e)},onMessageHide:function(e){r.default.Assert(e,"Must pass in a valid message to be removed from the queue");var t=this.queue.indexOf(e);t<0?r.default.Assert(!1,"Trying to remove an invalid message from the queue"):this.queue.splice(t,1)},hasMsgWithText:function(e){return!!this.queue.get().find(function(t){return t.text.get()===e})}};var as=new is,ns=i(46),ss=i.n(ns),rs=i(52),os=i(12),ls=i(73),ds=i.n(ls),us=i(31),cs=i(43),hs=os.a.createClass({displayName:"ReactWrapper",componentDisplay:l.a.ComponentDisplay.Everywhere,getState:function(){return r.default.clone(this.props.observe)},render:function(){var e=this.props,t=this.state;if(e.render)return e.render(t,e);var i=e.component||"div";return e=r.default.extend({style:e.renderStyle(t,e)},e),E.a.createElement(i,e,e.children)}}),fs=(i(66),os.a.createClass({displayName:"ReactSearchButton",componentDisplay:l.a.ComponentDisplay.Desktop,init:function(){var e=this.props.filter;this.firstValue=this.props.filterValue||e.initialValue},onMouseDown:function(e){r.default.preventAndStop(e)},onClickIcon:function(e){var t=this.props.filter,i=this.props.filterValue;i=!1!==t.canBeNegated&&(!p.a.mac&&e.ctrlKey||p.a.mac&&e.metaKey)&&!isNaN(t.initialValue)&&i!==-t.initialValue?-t.initialValue:i?0:t.initialValue,this.props.search.setFilter(t.name,i,!0)},render:function(){var e=this.props,t=e.filter,i=e.filterValue,a=this.firstValue===i,n=e.noClick?void 0:this.props.search.getFilterTooltip(t),s=r.default.classNames("searchButton",{"c-border-super-light":e.hasBorder},{"c-button":!i},{selected:!!i},t.icon,t.isOption&&(1===i?"yes":-1===i?"only":""),!t.isOption&&((i?this.firstValue>0&&a||this.firstValue<0&&!a:this.firstValue>0)?"yes":"no"));return E.a.createElement("div",{className:s,"data-tooltip":n,onMouseDown:this.onMouseDown,onClick:e.noClick?void 0:this.onClickIcon})}})),ps=i(48),gs=os.a.createClass({displayName:"ReactSearch",componentDisplay:l.a.ComponentDisplay.Everywhere,componentDidMount:function(){this.props.pane.search.UI=this,this.listenTo(this.props.pane.search.onChanged),this.addTap("searchInnerWrap",this,this.onTapBox)},getState:function(){for(var e=0,t=this.props.pane,i=t.search,a={search:i.value,calendars:G.a.GCalendarsAvailable,displayCalendars:t.displayCalendars,displayLocalItems:t.displayLocalItems},n=0;n<i.filters.length;n++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var s=i.filters[n];a[s.name]=s.value,a[s.name+"Enabled"]=s.enabled}return a},onChange:function(e){this.props.pane.search.setValue(e)},onParsed:function(e){this.props.pane.search.onParsed(e)},setSearch:function(e,t){this.props.pane.search.setValue(e)},getSelectionOffset:function(){return this.refs.input.getSelectionOffset()},setSelectionOffset:function(e){this.refs.input.setSelectionOffset(e)},onFocus:function(){var e=this.props.pane.search;e&&(this._selectionBeforeBlur=M.a.save(),M.a.reset(),e.isFocused.set(!0),oe.a.hide(),r.default.keyboardToolbar.show(l.a.KeyboardToolbarMode.Search),r.default.sendEvent("SearchFocus","Mobile"))},onBlur:function(){var e=this.props.pane.search;e&&e.isFocused.set(!1),r.default.keyboardToolbar.hide()},focus:function(){this.refs.input.focus(),this.refs.input.selectEnd()},blur:function(){this.refs.input&&this.refs.input.blur()},onTapBox:function(e){r.default.keyboardToolbar.preShow(),this.focus(),r.default.keyboardToolbar.show(l.a.KeyboardToolbarMode.Search),e.preventDefault()},onTapX:function(e){this.props.pane;this.state.search.length>0?(this.setSearch("",!1),r.default.preventDefault(e),r.default.sendEvent("Menu","ClearSearch")):(this.onTapBox(e),r.default.sendEvent("Menu","FocusSearch"))},onKeyDown:function(e){this.saveScrollOfTop()},onAutocompleteSelected:function(e){if(e.item){var t=this.props.pane.search,i=t.getValue(),a=i.indexOf(l.a.PrefixItemAutocomplete);i=i.substr(0,a),t.setValue(i),r.default.vmMain.zoomin(e.item,!1,!1,!0),this.setSelectionOffset(i.length)}this.refs.input.updateAutocomplete(),this.focus()},onClickFilters:function(){this.focus()},onClickPriority:function(){this.props.pane.search.setFilter("priority",0)},onClickText:function(e){if(e.altKey){var t=void 0,i=void 0,a=void 0;if(r.default.hasClass(e.target,"fancyInputInput")){var n=an.default.getSelectionRange().getNativeRange();if(n){var s=(t=n.cloneRange()).startContainer.nodeValue;if(r.default.isString(s)){for(var o=0,l=0,d=0,u=s.length,c=t.startOffset;c>=0;c--){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;if(" "===s[c]||160===s.charCodeAt(c)){d=c+1;break}}for(c=t.endOffset;c<s.length;c++){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;if(" "===s[c]||160===s.charCodeAt(c)){u=c;break}}i=u-d,a=d}}}else(t=an.default.createSelectionRange()).selectNodeContents(e.target),a=t.startOffset,i=t.toString().length;if(t&&!isNaN(a)&&i){t.setEnd(t.startContainer,a),t.setStart(t.startContainer.parentNode,0);var h=t.toString().length,f=this.props.pane.search,p=f.getValue();r.default.vmMain.beginUpdateItems(),p=(p.substr(0,h)+p.substr(h+i)).replace(/  +/g," ").trim(),f.setValue(p),r.default.vmMain.commitUpdateItems(),this.setSelectionOffset(h)}}},saveScrollOfTop:function(){this.props.pane.getInfiniteList().saveScrollOfTop(!0)},renderSearchButton:function(e){var t=this.props.pane;return E.a.createElement(fs,{key:e.name,filter:e,filterValue:e.value.get(),search:t.search})},renderSearchPriority:function(){var e=this.props.pane.search.filter_priority.value.get(),t=e===VMLIFlag.P0?0:e===VMLIFlag.P1?1:e===VMLIFlag.P2&&2,i=r.default.classNames("searchPriority searchP"+t+" selected");return E.a.createElement("span",{key:"priority",className:i,onClick:this.onClickPriority})},render:function(){var e=this.props,t=this.state,i=e.pane,a=(i.search,t.search),n=a.length>0?"icon-close":"",s=E.a.createElement(F.a,{className:"searchX c-button noShrink",width:24,height:40,icon:n,onClick:this.onTapX}),r=E.a.createElement("div",{className:"searchInnerWrap",ref:"searchInnerWrap"},E.a.createElement(ps.a,{ref:"input",className:"search",id:"search",height:30,value:a,onClick:this.onClickText,onChange:this.onChange,onKeyDown:this.onKeyDown,onFocus:this.onFocus,onBlur:this.onBlur,onParsed:this.onParsed,parse:!0,placeholder:"Search",autocompleteMode:"all",border:!1,autocompleteElementDisplay:this.refs.searchBox,padding:{left:0,right:0},onAutocompleteSelected:this.onAutocompleteSelected,supportSearchItemAutocomplete:i.supportSearchItemAutocomplete,canAutocompleItems:i.type===PaneMode.Task,noShowAutocomplete:!0,isSearch:!0}));return E.a.createElement("div",{className:"searchWrap c-background flexbox f1"},r,s)}}),ms=i(56),vs=i(36),_s=i(29),ys=i(55),Ss=i(31).default,ws=os.a.createClass({displayName:"ReactTitle",componentDisplay:l.a.ComponentDisplay.Everywhere,getState:function(e){var t=e.item,i=e.pane,a={customName:i.name,rootText:i.titleOfFirstItem,viewState:i.viewState,viewMode:i.getViewMode(),siblingMode:i.showRootOnRow2};if(e.viewMode)if(i.name.get())a.text=i.name.get();else{a.text=l.a.TaskViewModeTextSimple[a.viewMode];var n=i.getSortModeBlocks(),s=i.getSortModeItems(),r=n&&n!==l.a.TaskSortMode.None;r&&(a.text+=": "+l.a.TaskSortModeText[n]),s&&s!==l.a.TaskSortMode.None&&(r&&(a.text+=", "),a.text+=l.a.TaskSortModeText[s])}else e.paneName?a.text=i.title:(a.text=this.getTextForItem(t),a.jsx=this.getJSXForItem(t),a.html=this.getHTMLForItem(t));return a},init:function(){this._onMount()},_onMount:function(e){(e=e||this.props).viewMode||this.listenTo(e.item.itemChanged)},componentWillReceiveProps:function(e){e.viewMode===this.props.viewMode&&this.props.item===e.item||(this.refreshListeners(),this._onMount(e),this.updateState(e))},onMouseDown:function(e){0},onMouseUp:function(){this.clearHoldTimeout()},onClick:function(e){Ss.toggleOverviewVisibility(this.props.pane)},onRightClick:function(e){e.preventDefault(),this.openContextMenu(e)},onDoubleClick:function(e){var t=this.props.pane;r.default.isString(this.props.item)||t.onDoubleClickTitle()},onClickMenuItem:function(e){this.props.pane.onClickTitle(e)},clearHoldTimeout:function(){clearTimeout(this._holdTimeout),this._holdTimeout=void 0},getTextForItem:function(e){return e.generateTitleText(this.props.pane)},getHTMLForItem:function(e){return e.getStyledTextAsOneLine(!1,!1)},getJSXForItem:function(e){var t=this.getTextForItem(e),i=r.default.vmMain.pluginManager.getPlugin(PluginID.Gmail);if(i.isLabelItem(e)){var a=i.getIconForLabel(e),n=r.default.classNames("labelText",{hasIcon:!!a});return E.a.createElement("span",{className:n},E.a.createElement("i",{className:a&&"c-foreground-light icon-"+a}),t)}return t},openContextMenu:function(e){var t=this.props,i=t.pane,a=t.item,n=this.state.siblingMode?a.parent()?a.parent().items.get():a.items.get():i.getTitleList();this.clearHoldTimeout(),r.default.menus.openContextMenu({fn:this.renderContextMenuHold,element:e.target,item:i.getItem(),pane:i,titles:n})},renderContextMenuHold:function(e){var t=this;return E.a.createElement(vs.a,{key:"contextMenuTitle",id:"contextMenuTitle",element:e.element,maxHeight:400},E.a.createElement(ms.a,{topHeader:!0},this.props.pane.titleContextMenuHeader),e.titles.map(function(i){var a=t.getJSXForItem(i);return E.a.createElement(_s.a,{key:i.id,active:i===e.item,onClick:t.onClickMenuItem.bind(t,i)},a)}))},render:function(){var e,t=this.props,i=this.state,a=t.item,n=(!t.viewMode&&a.parent(),i.text,r.default.classNames("titleWrapper",t.className,{"c-foreground":t.last},{"c-foreground-very-faded c-color-hover":!1},{last:t.last},{firstRow:t.viewMode||t.paneName},{viewMode:t.viewMode})),s=r.default.classNames("title");return e=t.viewMode?"<b>Click</b> to change view mode or name this pane":"<b>Click</b> to zoom to item\n<b>Press and hold</b> to zoom to select a "+(i.siblingMode?"sibling":"parent")+" to zoom to",E.a.createElement(ys.a,{className:n,"data-tooltip":e,onClick:this.onClick,onDoubleClick:this.onDoubleClick,onMouseDown:t.viewMode?t.pane.openViewMenu:this.onMouseDown,onMouseUp:this.onMouseUp,onContextMenu:this.onRightClick,ripple:!1},(i.jsx||!i.html)&&E.a.createElement("span",{className:s},i.jsx||i.text),!(i.jsx||!i.html)&&E.a.createElement("span",{className:s,dangerouslySetInnerHTML:{__html:i.html}}),t.row1&&E.a.createElement("span",{className:"icon-angle-down c-foreground-super-faded"}))}}),Is=i(31).default,bs=i(67).default,As=os.a.createClass({displayName:"ReactPaneHeader",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this.paneScrollOffset=0,this.createObservables({headerRow2Position:0})},getState:function(){var e=this.props.pane,t={isOverviewVisible:e.overview.isVisible,item:e.item,showingArchived:e.showArchived,isSearchFocused:e.search.isFocused,isFocused:e.isFocused,titles:e.getTitleList()};return t.topBarMode=Is.topBarMode,t.numSelected=ct.a.numSelected,t},componentDidMount:function(e){this.props.pane.addScrollListener(this.onPaneScroll),setTimeout(function(){var e=this.props.pane.getScrollOffset();this.paneScrollOffset=e}.bind(this),0)},onUnmount:function(e){this.props.pane.removeScrollListener(this.onPaneScroll)},onBeforeChanged:function(e,t){this.refs;e.item!==t.item&&(this.headerRow2Position.set(0,!1),e.headerRow2Position=0)},onPaneScroll:function(e){var t=this.props.pane.getScrollOffset();if(void 0===this.paneScrollOffset&&(this.paneScrollOffset=t),t!==this.paneScrollOffset&&t>0){var i=this.headerRow2Position.get()+this.paneScrollOffset-t;this.headerRow2Position.set(r.default.clamp(i,-l.a.PaneHeaderRow2Height,0))}this.paneScrollOffset=t},onMouseDown:function(e){0},onMouseDownMore:function(e){r.default.menus.openContextMenu({fn:this.renderContextMenu,element:e.target})},numComplete:function(){return this.props.pane.getItemsToArchive().length},cloneBoard:function(e){_a.a.cloneBoard(void 0,e)},_clonePane:function(e,t){var i=r.default.vmMain.paneManager.getPaneIndex(t),a=t.getSaveInfoForClone();r.default.vmMain.paneManager.createPaneAtIndex(e,i+1,a)},onClickClonePane:function(e){this._clonePane(e,this.props.pane)},onTapOverviewButtonMobile:function(){Is.toggleOverviewVisibility(this.props.pane)},onTapMoreButtonMobile:function(){r.default.menus.toggleContextMenu({fn:this.renderContextMenuMobile})},onTapMultiselectMobile:function(){Is.setMultiselectVisibility(!0)},onTapCloseTopStatus:function(){Is.resetTopBarMode()},onTapClearMultiselect:function(){ct.a.setSelected([])},onTapUndoMobile:function(){y.a.undoAction()},onClickStar:function(){this.cloneBoard(this.props.pane)},onClickArchiveCompleted:function(){var e=this.props.pane,t=this.numComplete();r.default.menus.confirm("Are you sure you want to archive "+t+" completed item"+(t>1?"s":"")+"?",function(t){t&&e.archiveCompleted()})},onDoubleClickHeader:function(e){r.default.hasClass(e.target,"paneDraggable")&&this.props.pane.scrollToTop(ScrollDuration.Default)},onClickCollapseAll:function(){var e=this.props.pane;e.collapseAll(void 0,!0),e.setScrollOffset(e.defaultOffset)},onClickExpandAll:function(){var e=this.props.pane;e.collapseAll(void 0,!1),e.setScrollOffset(e.defaultOffset)},renderContextMenuMobile:function(){this.state;var e=this.props.pane;return P.createElement(vs.a,{key:"contextMenuMobileOptions",position:"top-right",className:"contextMenuMobile"},e.supportMultiselect&&P.createElement(_s.a,{icon:"icon-done_all",onClick:this.onTapMultiselectMobile},"Multiselect"),P.createElement(_s.a,{icon:"icon-reply",onClick:this.onTapUndoMobile},"Undo"),e.supportCollapsing&&P.createElement(_s.a,{icon:"icon-minus",onClick:this.onClickCollapseAll},"Collapse All Items"),e.supportCollapsing&&P.createElement(_s.a,{icon:"icon-add",onClick:this.onClickExpandAll},"Expand All Items"),e.supportPerformArchive&&P.createElement(_s.a,{icon:"icon-task",disabled:0===this.numComplete(),onClick:e.onTapArchiveCompleted.onClick.bind(e)},"Archive Completed"),e.supportDataRefresh&&P.createElement(_s.a,{icon:"icon-spinner",onClick:e.onTapRefreshData.onClick.bind(e)},"Force refresh"))},renderContextMenu:function(e){var t=this.props.pane,i=t.supportDataRefresh||t.supportReportError;return P.createElement(vs.a,{key:"contextMenuPaneHeader",element:e.element},P.createElement(P.Fragment,null,P.createElement(_s.a,{icon:"icon-close",onClick:t.onTapClosePane.bind(t)},"Close"),P.createElement("hr",null)),P.createElement(_s.a,{icon:"icon-star_border",onClick:this.onClickStar},"Open pane in new board"),t.supportClone&&p.a.isFeatureEnabled(l.a.Feature.ClonePane)&&P.createElement(_s.a,{icon:"icon-align-left",onClick:this.onClickClonePane.bind(this,PaneMode.Task)},"Clone Pane"),t.supportPerformArchive&&P.createElement(_s.a,{icon:"icon-task",disabled:0===this.numComplete(),onClick:this.onClickArchiveCompleted},"Archive Completed Items"),i&&P.createElement("hr",null),t.supportDataRefresh&&P.createElement(_s.a,{icon:"icon-spinner",onClick:t.onTapRefreshData.onClick.bind(t)},"Force refresh"),t.supportReportError&&P.createElement(_s.a,{icon:"icon-warning",onClick:t.onTapReportError.onClick.bind(t)},"Report Error"),t.widthManual&&P.createElement("hr",null),t.widthManual&&P.createElement(_s.a,{icon:"icon-arrows-h",onClick:t.setWidthManual.bind(t,void 0)},"Auto-size pane"))},renderTopStatus:function(e,t){return P.createElement("div",{className:"paneHeader"},P.createElement(F.a,{className:"topLeftButton",icon:"icon-close",color:"#444",iconSize:24,width:r.default.topBarHeight,height:r.default.topBarHeight,onClick:this.onTapCloseTopStatus}),P.createElement("div",{className:"topStatus"},e),t)},render:function(){var e=this.state,t=this.props.pane,i=this.getChildByKey("headerButtons");if(e.topBarMode===l.a.TopBarMode.Normal){var a=r.default.classNames("titles f1",{multiline:e.titles.length>1}),n={};return n[p.a.transform.react]="translate3d(0,"+e.headerRow2Position+"px,0)",P.createElement("div",{className:"paneHeader"},P.createElement("div",{className:"paneHeaderRow paneHeaderRow1 flexbox"},P.createElement("div",{className:"leftButtons"},P.createElement(F.a,{icon:"icon-menu",iconSize:24,width:r.default.topBarHeight,height:r.default.topBarHeight,onClick:this.onTapOverviewButtonMobile})),P.createElement("span",{className:a},e.titles.length>1&&P.createElement("div",{className:"titlesParents"},e.titles.map(function(i,a){if(a<e.titles.length-1)return P.createElement(ws,{key:"title_"+a,isLast:!1,pane:t,item:i})})),P.createElement(ws,{className:"currentTitle",isLast:!0,pane:t,item:e.titles[e.titles.length-1]})),P.createElement("div",{className:"rightButtons"},P.createElement(F.a,{icon:"icon-more_horiz",color:"#666",iconSize:24,width:r.default.topBarHeight,height:r.default.topBarHeight,onClick:this.onTapMoreButtonMobile}))),P.createElement("div",{className:"paneHeaderRow paneHeaderRow2 flexbox",style:n},i&&P.Children.map(i.props.children,function(e){return e}),!e.isOverviewVisible&&P.createElement(gs,{pane:t}),!e.isOverviewVisible&&P.createElement(bs,{pane:t})))}return e.topBarMode===l.a.TopBarMode.Multiselect?this.renderTopStatus(e.numSelected+" Selected",P.createElement(F.a,{className:"abs",style:{right:0},enabled:e.numSelected>0,height:44,fontSize:16,primary:!0,fontWeight:"normal",onClick:this.onTapClearMultiselect},"Clear")):this.renderTopStatus(e.topBarMode)}}),Ds=(i(57),os.a.createClass({displayName:"ReactHiddenInput",componentDisplay:l.a.ComponentDisplay.Desktop,getState:function(){return{position:this.props.pane.caretPosition}},getElement:function(){return this.refs.hiddenInput},render:function(){this.state;var e=this.state.position,t={};return e&&(t.left=e.left,t.top=e.top),E.a.createElement("div",{style:t,contentEditable:"true",className:"paneHiddenInput",ref:"hiddenInput"},TextSpace)}})),Ts=os.a.createClass({displayName:"ReactInfiniteList",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this.props.pane.onInfiniteListLoaded(),this.props.owner.notifyInit(this)},componentDidMount:function(){this.props.hiddenInput&&(this.props.pane.hiddenInput=this.refs.hiddenInput.getElement())},onUnmount:function(){this.props.owner.notifyUnmounted()},getState:function(){var e=this.props,t=e.pane,i=e.owner,a=e.overview;return{cells:i.cellsObs,paddingBottom:i.paddingBottom,contentSize:i.contentSize,bottomListMessage:!a&&t.bottomListMessage(),isLoadingNewPage:t.isLoadingNewPage,isLoading:t.isLoading,statusMessage:t.getStatusMessage(this.props.overview),disablePointerEvents:i.disablePointerEvents,rect:this.props.pane.rect,items:i._itemsObs}},isIndexMounted:function(e){return e>=0&&!!this._getElementAtIndex(e)},_getElementAtIndex:function(e){for(var t,i=0,a=this.props,n=this.state,s=0;s<n.cells.length;s++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;if(n.cells[s].index===e){t=s;break}}var r=this.getChildByKey("topBox"),o=t+(a.hiddenInput?1:0)+(r?1:0);return this.refs.contentElement.children[o]},getElementAtIndex:function(e){var t=this._getElementAtIndex(e);return r.default.Assert(t,"Must have a valid mounted item at index",e),t},handleClick:function(){this.props.pane.isLoading.get()&&this.state.statusMessage&&this.props.pane.handleStatusClick()},renderItems:function(){for(var e=0,t=[],i=this.state.cells,a=0;a<i.length;a++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;t.push(this.props.renderCell(a,i[a]))}return t},render:function(){var e,t=this.state,i=this.props,a=i.pane,n=r.default.classNames(i.contentClass,{noClickItems:t.disablePointerEvents}),s=t.statusMessage,o=t.contentSize+t.paddingBottom;if(!i.isLoading)if(t.bottomListMessage&&t.bottomListMessage.text&&!i.overview){var d=t.bottomListMessage,u={};u[p.a.transform.react]="translateY("+t.contentSize+"px)",e=E.a.createElement("div",{className:"paneBottomMessage c-border-light",style:u},d.clickable?E.a.createElement(F.a,{className:"paneDataPageLoad"},d.text):E.a.createElement("div",{className:"paneDataPageLoad c-foreground-very-faded"},d.text)),o+=40}else i.owner.hasItems()||(n+=" noItems"+(s?" displayStatus":""));var c={};i.orientation===l.a.Orientation.Horizontal?(c.width=(o||200)+"px",c.height="100%"):(c.height=(o||200)+"px",c.width="100%");var h=null;return i.hiddenInput&&(h=E.a.createElement(Ds,{ref:"hiddenInput",pane:a})),E.a.createElement("ul",{className:n,style:c,onClick:this.handleClick,spellCheck:"false",draggable:"false",ref:"contentElement","data-pane-status":s},h,this.getChildByKey("topBox"),this.renderItems(),e)}}),Ms=(os.a.createClass({displayName:"ReactCaret",componentDisplay:l.a.ComponentDisplay.Desktop,init:function(){this.createObservables({isOn:!1})},componentDidMount:function(){document.addEventListener("mousedown",this.startAnim),document.addEventListener("mouseup",this.startAnim)},onUnmount:function(){document.removeEventListener("mouseup",this.startAnim),document.removeEventListener("mousedown",this.startAnim),clearTimeout(this.animTimeout)},getState:function(){var e=this.props.pane;return{info:e.caretPosition,isWindowFocused:M.a.isWindowFocused,activePane:M.a.pane,contextMenus:r.default.menus.contextMenuStack,isPaneActive:M.a.isWindowFocused.get()&&M.a.getPane()===e&&0===r.default.menus.contextMenuStack.get().length}},onAfterChanged:function(e,t){e.isPaneActive&&e.info&&(e.isPaneActive!==t.isPaneActive||e.info!==t.info)&&this.startAnim(e)},startAnim:function(e){this.animTick(!0,e)},animTick:function(e,t){(t=t||this.state).isPaneActive&&t.info&&(clearTimeout(this.animTimeout),this.isOn.set(e||!this.isOn.get()),this.animTimeout=setTimeout(this.animTick,500))},render:function(){var e=this.state,t=this.state.info,i=t&&t.item,a=t&&t.pane,n=t&&t.paneObject,s={height:"18px"};return t&&e.isPaneActive&&M.a.isValid()&&M.a.getStartItem()?(t.isVisible&&(s.height=i&&a&&un.a.lineHeightForItem(n,i,a)+"px",s.opacity=e.isOn?1:0),s[p.a.transform.react]="translate3d("+t.left+"px, "+t.top+"px, 0)"):s[p.a.transform.react]="translate3d(-1000px, -1000px, 0)",E.a.createElement("div",{className:"caret c-bg-caret",style:s})}}),i(62),os.a.createClass({displayName:"ReactInlineImage",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this.createObservables({draggedWidth:void 0})},onMouseDownResize:function(e){var t=this.props,i=t.line,a=this.refs.image.getBoundingClientRect(),n=V.default.getImageOriginalSize(i.src,i.srcDataUrl);this.maxWidth=Math.min(n.width,t.pane.maxWidthOfPaneObject(t.paneObject)+(t.item.hasPrefix()?l.a.PrefixWidth:0)),this.draggedWidth.set(t.line.maxWidth||a.width,!1),this.leftPos=a.left,this.rightOffset=a.right-e.clientX,t.onStartResize(),r.default.preventAndStop(e),r.default.isDraggingImage=!0},onMouseMoveResize:function(e){var t=e.clientX-this.leftPos+this.rightOffset;this.draggedWidth.set(r.default.clamp(t,40,this.maxWidth)),r.default.preventAndStop(e)},onMouseUpResize:function(){var e=this.draggedWidth.get();this.props.onEndResize(e),r.default.isDraggingImage=!1},render:function(){var e=this.props,t=e.line,i=e.style,a=e.isHovered,n=e.item,s=e.hasSelection,o=t.srcDataUrl&&t.src!==t.srcDataUrl,l=t.isDriveImage||!r.default.showMarkdown()||!s,d=r.default.classNames({mdImage:!t.isDriveImage},{driveImage:t.isDriveImage}),u=r.default.classNames(d,{none:o}),c=r.default.classNames("mdMarkup",{driveImageMarkup:t.isDriveImage}),h={maxWidth:!this.state.draggedWidth&&l&&t.maxWidth,width:this.state.draggedWidth};return E.a.createElement("span",{className:"line",style:i},t.previousText&&E.a.createElement("span",{dangerouslySetInnerHTML:{__html:t.previousText}}),E.a.createElement("span",{className:c},t.originalText),l&&E.a.createElement("div",{className:"mdImageWrapper rel ib",style:h},E.a.createElement("img",{key:r.default.hashCode(t.src),className:u,src:t.src,onLoad:r.default.vmMain.onImageLoaded.bind(r.default.vmMain,n,t.src),"data-original-text":t.originalText,ref:"image"}),o&&E.a.createElement("img",{key:r.default.hashCode(t.srcDataUrl),className:d,src:t.srcDataUrl,onLoad:r.default.vmMain.onImageLoaded.bind(r.default.vmMain,n,t.srcDataUrl),"data-original-text":t.originalText}),a&&E.a.createElement(cs.a,{className:"mdImageResizer flexbox flexvert",onMouseDown:this.onMouseDownResize,onMouseMove:this.onMouseMoveResize,onMouseUp:this.onMouseUpResize,globalEvents:!0})),t.nextText&&E.a.createElement("span",{dangerouslySetInnerHTML:{__html:t.nextText}}))}})),Cs=i(31).default,Ls=function(e,t,i){var a=t.overview,n=t.pane;return i.isHeader&&(n.supportCollapsing||a)&&(a||!n.isSearchedFlat())&&!e.isNote()&&!(a&&0===i.levelsDeep)},Ps=function(e,t,i,a){return e=e||TextSpace},Es=function(e,t){var i=e.item||e;return!t.isViewAgenda()&&i.isNote()&&i.parent().getPrefix()&&(!e.block||e.block.item!==i.parent())&&l.a.PrefixWidth+l.a.LineLeftPad},ks=function(){this.setState({draggingImage:!0})},xs=function(e,t,i){var a=this;if(e.isDriveImage){var n=e.attach;n.getPlugin().setAttachWidth(n,i)}else{var s,r=t.getRawText();l.a.Regexp.MDLink.lastIndex=0,null!==(s=l.a.Regexp.MDLink.exec(r))&&(r="!["+s[2]+"]("+s[3]+" ="+i+"x)"),t.setText(r,!0,ChangeType.Local)}setTimeout(function(){a.setState({draggingImage:!1})},l.a.ItemTransitionTime)},Rs=function(e,t,i,a,n){var s=[],o=i.pane,d=i.cell.paneObject,u=o.maxWidthOfPaneObject(d)+(t.hasPrefix()?l.a.PrefixWidth:0);if(a.selected||t.isNote()){var c={top:0,width:u,height:a.height};c[p.a.transform.react]="translateX("+n+"px)",s.push(E.a.createElement("span",{key:"selStart",className:"textSelected",style:c}))}else if(void 0!==a.selectedStart){var h,f=a.lines.reduce(function(e,t){return e+r.default.unescape(t).length},0),g=a.selectedStart,m=a.selectedEnd;g<0&&(g=0),m<0&&(m=f,h=!0);var v=V.default.getCaretOffset(d,o,g,!0),_=V.default.getCaretOffset(d,o,m,M.a.preferLineStart),y=un.a.paddingForItemTop(d,t,o),S=un.a.paddingForItemBottom(d,t,o),w=un.a.lineHeightForItem(d,t,o),I=!t.isNote()&&_.line>v.line,b=t.shouldShowParents(d,o)?l.a.HeightAgendaParents:0,A=w+(0===v.line?y:0)+(v.line===a.lines.length-1?S:0),D=function(e,t,i,a,n){var s=n.refs.li,r=0;if(s){for(var o=0,l=s.getElementsByClassName("line"),d=0;d<e&&d<l.length;d++){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;r+=l[d].getBoundingClientRect().height}0===r&&(r+=a)}return r}(v.line,0,0,b,e);if(v.lineOffset<v.lineLength||!I){var T=I||h?u-v.left:_.left-v.left,C=v.left<0?v.left:0,L={top:D,width:Math.min(T+C,u),height:A,marginLeft:Es(d,o)};D+=A,L[p.a.transform.react]="translateX("+(v.left-C+n)+"px)",s.push(E.a.createElement("span",{key:"selStart",className:"textSelected textSelectedStart",style:L}))}if(I){var P=_.line-v.line,k=w+(_.line===a.lines.length-1?S:0),x=h?u:_.left;if(P>1){var R=w*(P-1),O={top:D,width:u,height:R};D+=R,O[p.a.transform.react]="translateX("+n+"px)",s.push(E.a.createElement("span",{key:"selMid",className:"textSelected textSelectedMid",style:O}))}var F={top:D,width:x,height:k};F[p.a.transform.react]="translateX("+n+"px)",s.push(E.a.createElement("span",{key:"selEnd",className:"textSelected textSelectedEnd",style:F}))}}return s},Os=function(e,t,i){return un.a.paddingForItemTop(t,e,i)+(e.shouldShowParents(t,i)?l.a.HeightAgendaParents:0)},Fs=function(e){return e.overview||e.cell.paneObject.levelsDeep>0?un.a.itemIndentSize()-1:20},Ns={onMount:function(e,t,i,a,n){var s=a.pane,r=a.overview;e.listenTo(t.itemChanged),e.listenToDispatcher("numListChanged"),e.listenToDispatcher("EmailPreview","onClosed"),e.listenToDispatcher("EmailPreview","openThreadChanged"),s&&!r&&t.onLoad(s)},onUnmount:function(e){e.disposeDispatcherListeners()},onUpdate:function(e,t,i,a,n,s){if(a.isEditable&&s.lines!==a.lines)if(p.a.android)e.refs.androidInput.value=t.getParsedText();else for(var r=0,o=e.state.lines,l=e.refs.li.getElementsByClassName("line"),d=0;d<l.length;d++){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;l[d].innerHTML=Ps(o[d])}},getState:function(e,t,i,a){var n=a.pane,s=a.cell.paneObject,o=a.overview;if(n.isDestroyed())return{};var l=M.a.isSelected(i,n),d={flags:t.flags,levelsDeep:t.levelsDeep,styleProps:t.styleProps(s,n),isHovered:M.a.isReactCellHovered(e),showVerticalLines:!1,isSelected:!o&&n===r.default.focusedPane&&ct.a.isSelected(i,n),hasSelection:!!l,hasNote:t.hasNote(),isCollapsed:n.isPaneObjectCollapsed(s,o),isHighlighted:t.isHighlighted,dropBucketItems:!a.isInDragDrop&&n===r.default.focusedPane&&r.default.vmMain.dropBucket.getItems(),numListNumber:t.isPrefixNumList()&&t.numListNumber(),draggedInPane:t.draggedInPane,isSearchFocused:n.search.isFocused,isBeingDragged:t.draggedInPane.get()===n||n===r.default.focusedPane&&r.default.vmMain.dropBucket.hasItemEntry(t),isMatchStuckHiding:n.search.isMatchStuckHiding(t)};if(o){if(d.paneItem=n.item,d.lines=[t.getStyledTextAsOneLine(!1,!1)],n.type===PaneMode.Gmail){var u=r.default.vmMain.pluginManager.getPlugin(PluginID.Gmail),c=t.getParsedText(),h=u.getIconForLabel(t);h&&(d.lines[0]='<span class="labelText hasIcon"><i class="c-foreground-light icon-'+h+'"></i>'+c+"</span>")}0,d.isOverviewVisibleInPane=n.type===PaneMode.Task?n.getItem()!==n.getRootItem()&&n.isOverviewVisibleInPane(t):t===n.getItem(),d.isOverviewFocused=n.getItem()===t,d.isOverviewRoot=n.getRootItem()===t}else{var f=t.getAttachmentByPlugin(PluginID.Gmail);if(d.isEmailOpen=f&&(n.type===PaneMode.Gmail&&d.isSelected||f===ut.a.getThreadAttach()&&ut.a.isOpenOnPane(n)),t.isNote())d.lines=n.getStyledLinesForPaneObject(s,o,d.hasSelection);else{var p=n.getMetricsForPaneObject(s,o,d.hasSelection);d.lines=n.search.shouldHighlightSearch()&&p.searchHighlightedLines||p.styledLines}0,d.isEditable=t.isEditable,d.isMultiselected=d.isSelected&&Cs.isInMultiselect(),t.isNote()&&(d.parentFlags=t.parent().flags,d.parentStyleProps=t.parent().styleProps(s,n))}return d.isHeader=n.isItemHeader(t,o),d},render:function(e,t,i,a,n,s,o,l,d){var u=n.pane,c=n.cell.paneObject,h=n.overview,f=!(!u.isWriteable||!s.isEditable)||null,g=u.getPaddingForPaneObject(c,h),m=r.default.classNames("item c-foreground",l,s.styleProps,{"c-border-light ":!h},{"c-background":!h&&!i.isNote()},{"overviewItem c-button-overview":h},{overviewAncestor:h&&s.isOverviewAncestor},{overviewFocused:h&&s.isOverviewFocused},{"c-background-overview-selected":h&&s.isOverviewVisibleInPane},{overviewRoot:h&&s.isOverviewRoot},{overviewAtTop:h&&s.isOverviewAtTop},{overviewDragHover:h&&s.isOverviewDragHover},{collapsed:s.isCollapsed},{itemBeingDragged:s.isBeingDragged},{faded:s.faded},{selected:s.isSelected&&s.isMultiselected},{"c-background-item-selected":!1},{editable:f},{highlighted:s.isHighlighted&&u!==r.default.focusedPane},{"c-bg-faded":!h&&s.isHovered},{firstItem:0===a},{hasSelection:s.hasSelection},{hasNote:s.hasNote},{hasPrefix:!!i.getPrefixLength()},{blockHeader:c.isBlockHeader},{"c-foreground-very-faded":c.isBlockHeader&&s.isCollapsed},{stuckMatch:s.isMatchStuckHiding},{checked:i.isComplete()},{swiping:!!d});if(h||(o=r.default.extend({fontSize:un.a.fontSizeForItem(c,i,u),lineHeight:un.a.lineHeightForItem(c,i,u)+"px",zIndex:s.draggingImage?1:void 0},o)),p.a.android&&f){var v={paddingLeft:g,height:o.height,paddingTop:un.a.paddingForItemTop(c,i,u),paddingRight:p.a.windowWidth()-u.maxWidthOfPaneObject(c)-g};return E.a.createElement("li",{"data-moo-id":t,className:m,style:o,ref:"li",contentEditable:f},E.a.createElement("textarea",{className:"androidInput",ref:"androidInput",style:v,defaultValue:i.getParsedText(),onInput:u.onInputAndroid,onChange:r.default.emptyFn}))}return E.a.createElement("li",{"data-moo-id":t,className:m,style:o,ref:"li",contentEditable:f},function(e,t,i,a,n){var s=a.lines,o=i.pane,l=i.overview,d=i.cell.paneObject,u=!l&&o.maxWidthOfPaneObject(d),c=[];if(r.default.Assert(s,"If an item is being rendered it must have styled lines"),s){var h=0;r.default.Assert(!isNaN(n),"Should always have a valid number for padding");var f={width:u};p.a.isFirefox||i.padInsteadOfTransformLines?f.marginLeft=n:l?f.paddingLeft=n:f[p.a.transform.react]="translateX("+n+"px)",l||t.isNote()?s=[s[0]||TextSpace]:u<r.default.MinItemWidth&&(s=["..."]);for(var g=0;g<s.length;++g){if(h++>5e3&&__infLoop&&__infLoop(h))throw new RangeError;var m=s[g];if(m.isImage){var v=r.default.extend({paddingTop:!l&&(0===g?Os(t,d,o):un.a.paddingForItemTop(d,t,o)),paddingBottom:!l&&un.a.paddingForItemBottom(d,t,o)},f);l?c.push(E.a.createElement("span",{className:"line",style:v,key:"line_"+g},m.originalText)):c.push(E.a.createElement(Ms,{line:m,item:t,paneObject:d,pane:o,key:"line_"+g,style:v,isHovered:a.isHovered,hasSelection:a.hasSelection,onStartResize:ks.bind(e),onEndResize:xs.bind(e,m,t)}))}else{var _=r.default.classNames("line",{"c-bg-light":a.isBeingDragged},{first:0===g},{blockHeaderText:g===s.length-1&&d.isBlockHeader},{last:g===s.length-1}),y=r.default.extend({paddingTop:!l&&0===g&&Os(t,d,o),paddingBottom:!l&&g===s.length-1&&un.a.paddingForItemBottom(d,t,o),height:!l&&un.a.lineHeightForItem(d,t,o)+"px",paddingLeft:Es(d,o)},f);m=Ps(m),c.push(E.a.createElement("span",{className:_,key:"line_"+g,style:y,dangerouslySetInnerHTML:{__html:m}}))}}}return c}(e,i,n,s,g),function(e,t,i,a,n){if(t.hasPrefix()){var s=t.els[0],r=i.cell.paneObject,o=n-5,l={paddingTop:Os(t,r,i.pane)};return p.a.isFirefox||i.padInsteadOfTransformLines||i.overview?l.marginLeft=o:l[p.a.transform.react]="translateX("+o+"px)",E.a.createElement("div",{className:s.getClassString(),style:l,"data-listnum":t.isPrefixNumList()?a.numListNumber:void 0})}}(0,i,n,s,g),function(e,t,i,a,n){var s=i.pane;if(!i.overview&&t.shouldShowParents(i.cell.paneObject,s)){var r=t.parents(s.getItem()),o=i.cell.paneObject,l=r.map(function(e,t){return e.generateTitleText()}).join(" > "),d={paddingTop:un.a.paddingForItemTop(o,t,s),marginLeft:n};return l&&E.a.createElement("div",{className:"itemParents c-foreground-very-faded",style:d,"data-tooltip":l},l)}}(0,i,n,0,g),function(e,t,i,a,n){if(a.showVerticalLines&&n>un.a.itemIndentStart(i.pane)){var s=i.pane.extraPaddingForPaneObject(i.cell.paneObject),r=un.a.itemIndentStart(i.pane)+s+6,o=n-r;if(o>0){var l={left:r,width:o};return E.a.createElement("div",{className:"vertLines",style:l})}}}(0,0,n,s,g),function(e,t,i,a,n){var s=i.pane,o=i.cell.paneObject,l=Fs(i);if(!i.overview&&s.supportMenuIcon&&a.isHovered&&!t.isNote()&&""!==t.getParsedText()&&(!s.isViewAgenda()||!s.shouldShowTime(i.cell.paneObject))){var d={width:n-5-(Ls(t,i,a)?l:0),paddingRight:l-20,height:un.a.lineHeightForItem(o,t,s)+"px",marginTop:Os(t,o,s)+"px"},u=r.default.classNames("itemMenuIcon",{"c-foreground-super-faded c-color-hover":!0},{"c-background-item-selected":!1}),c="<b>Drag</b> to move.<br><b>Click</b> to open menu.<br><b>"+p.a.priModKey+" + Click</b> to zoom in.";return E.a.createElement("div",{className:u,style:d,"data-tooltip":c},E.a.createElement("i",{className:"icon-drag-handle"}))}}(0,i,n,s,g),function(e,t,i,a,n){var s=i.overview,o=i.cell.paneObject,l=i.pane;if(a.isHovered&&""===t.getParsedText()&&!t.hasChildren()){var d=r.default.classNames("emptyItemAddButton icon-add c-background c-shadow-light"),u={marginLeft:1===a.levelsDeep?-4:-12};return u[p.a.transform.react]="translateX("+(n-24)+"px)",E.a.createElement("div",{className:d,style:u})}if(Ls(t,i,a)){var c=r.default.classNames("collapser c-foreground-super-faded c-color-hover",{"collapsed icon-angle-right":a.isCollapsed},{"icon-angle-down":!a.isCollapsed}),h={left:Math.max(n-5-Fs(i),0),lineHeight:!s&&un.a.lineHeightForItem(o,t,l)+"px",paddingTop:!s&&Os(t,o,l)+"px"},f=(p.a.secModKey,"<b>Click</b> to "+(a.isCollapsed?"expand":"collapse")+" item.<br><b>Shift + Click</b> to "+(a.isCollapsed?"expand":"collapse")+" item recursively.<br><b>"+p.a.priModKey+" + Click</b> to zoom in.");return E.a.createElement("div",{className:c,style:h,"data-tooltip":f})}}(0,i,n,s,g),function(e,t,i,a){i.overview,i.cell.paneObject,i.pane}(0,0,n),h&&s.isHovered&&void 0,!h&&u.isViewAgenda()&&function(e,t,i){var a=i.pane,n=i.cell.paneObject;if(a.shouldShowTime(n)){var s=a.getItemDisplayTime(n),o=s.indexOf("<div")>=0,l=r.default.classNames("agendaTime cursor-grab",{twoLines:o},{allDay:"All day"===s},{hasParents:t.shouldShowParents(i.cell.paneObject,a)}),d={paddingTop:Os(t,n,a)+"px"};return E.a.createElement("div",{className:l,style:d,dangerouslySetInnerHTML:{__html:s}})}}(0,i,n),!h&&(s.selected||void 0!==s.selectedStart)&&Rs(e,i,n,s,g),d)}},Bs={onMount:function(e,t,i,a){e.listenTo(a.pane.dragHoveredBlock)},getState:function(e,t,i,a){return{isHovered:a.cell.paneObject.block===a.pane.dragHoveredBlock.get()}},onClickNewProject:function(e,t){var i=t.pane,a=i.getItem().numItems(),n=i.addItemToPane(l.a.Prefix.Header+" ",a),s=i.indexOfItem(n);M.a.selectIndex(s,0)},render:function(e,t,i,a,n,s,o,l){var d,u=i.block,c=u.isCollapsed(),h=r.default.classNames(l,"blockHeader noItem c-border-light flexbox",{blockHeaderDate:u.isDate},{"c-tag":n.pane.isViewTag()},{"c-contact":n.pane.isViewContact()},{agendaBlockRed:!c&&u.isOverdue},{dragHovered:s.isHovered},{"collapsed c-foreground-very-faded":c},{firstBlock:0===a}),f=r.default.classNames("blockCollapser c-foreground-super-faded",{"icon-angle-down":!c&&!u.isNewProject},{"icon-angle-right":c&&!u.isNewProject}),p={paddingBottom:un.a.paddingForBlockHeader()},g=E.a.createElement("span",{className:"blockHeaderNumItems c-foreground-faded"},u.numItems());if(u.isDate){var m,v=u.date,_=Date.today(),y=v.isToday()?"Today":v.isSameDay((new Date).clearTime().addDays(1))?"Tomorrow":v.toString("dddd"),S=r.default.classNames("blockHeaderText blockHeaderDayName f1 ib",{"c-foreground-light":!c});v.getMonth()===_.getMonth()&&v.getYear()===_.getYear()||(m=v.toString("MMMM"),S+=" diffMonth"),v.getYear()!==_.getYear()&&(m+=", "+v.toString("yyyy")),d=E.a.createElement(E.a.Fragment,null,E.a.createElement("span",{className:"blockHeaderDateNum"},v.getDate()),E.a.createElement("span",{className:S,style:p},y&&E.a.createElement("div",null,y,g),m&&E.a.createElement("div",{className:"blockHeaderMonth"},m)))}else if(u.isNewProject)d=E.a.createElement("span",{className:"blockHeaderText pointer f1 c-foreground-very-faded",style:p,onClick:this.onClickNewProject.bind(this,e,n)},"New project");else{var w=u.isStarred&&E.a.createElement("i",{className:"icon-star"})||u.isImportant&&E.a.createElement("i",null,"!");d=E.a.createElement("span",{className:"blockHeaderText f1",style:p},w,u.text,g)}return E.a.createElement(cs.a,{ref:"li","data-moo-id":t,className:h,style:o,onClick:u.toggleCollapsed},E.a.createElement("span",{className:f}),d)}},Us={render:function(e,t,i,a,n,s,o){var l=r.default.classNames("hr c-border-heavy",n.className);return E.a.createElement("li",{"data-moo-id":t,className:l,style:o},i.text)}},Vs={onClick:function(e,t){var i=t.block;i.addFn(i)},render:function(e,t,i,a,n,s,o,l){l=r.default.classNames(l,"taskAddButton");var d=i.block,u=r.default.classNames("c-foreground-faded");return E.a.createElement("li",{ref:"li","data-moo-id":t,className:l,style:o},!d.noAddButton&&E.a.createElement(cs.a,{className:u,onClick:this.onClick.bind(this,e,i,a)},E.a.createElement("i",{className:"icon-add"}),"Add item"))}},Hs=i(53),qs=os.a.createClass({displayName:"ReactMonthDay",componentDisplay:l.a.ComponentDisplay.Desktop,init:function(){g.a.listen("endDrag",this.onDragEnd),this.createObservables({isHovered:!1}),this.listenToDispatcher("dateChanged")},arePropsEqual:function(e,t,i){return"items"===e?t===i||t&&i&&t.length===i.length:"date"===e?t===i||t&&i&&t.equals(i):void 0},areStatesEqual:function(e,t,i){if("items"===e){var a=0;if(!t||!i||t.length!==i.length)return!1;for(var n=0;n<t.length;n++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(t[n].time!==i[n].time||t[n].item!==i[n].item)return!1}return!0}},componentWillReceiveProps:function(e){e.items!==this.props.items&&this.updateState(e)},getState:function(e){var t={};if(e.items){for(var i=0,a=[],n=[],s=0;s<e.items.length;s++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;var r=e.items[s];if(!r.isNote()){var o=r.date()||r.repeatDate()&&r.repeatDate().getStartDate(),l=o.hasTimeOfDay()&&o.toString(H.a.getFormat(DFormat.ShortTime));l?n.push({time:l,item:r}):a.push({item:r})}}t.items=a.concat(n)}return t},onMouseDown:function(e){e.preventDefault()},onMouseEnter:function(){if(We.default.isDragging){this.isHovered.set(!0);var e=We.default.dragItem.date();We.default.setBlockTarget({date:this.props.date,dateTime:e&&e.hasTimeOfDay()&&e,isDate:!0})}},onDragEnd:function(){this.isHovered.set(!1)},onMouseLeave:function(){this.isHovered.set(!1)},onDoubleClick:function(e){var t=this.props,i=t.pane,a=t.date,n=i.item.get(),s=H.a.getAppendDateText(a);i.openItemEditor({element:e.target,text:" @"+s,parent:n,selectIndex:0,pos:{top:e.clientY},showCalendarButtons:!0,addOnSave:!0})},render:function(){var e,t=this.props,i=this.state,a=t.date,n=0===a.getDay()||6===a.getDay(),s=a.getDate(),o=Date.getDaysInMonth(a.getFullYear(),a.getMonth()),d=r.default.classNames("dateBlock c-border",{firstDay:1===a.getDate()},{lastDay:a.getDate()===o},{"weekend c-bg-faded":n},{"c-background":!n},{hoveredInDrag:i.isHovered},{today:a.isToday()}),u={left:t.left-1,width:t.width+1},c=r.default.classNames("dateBlockDay");if(i.items){for(var h=0,f=0,p=[],g=!1,m=0;m<i.items.length;m++){if(h++>5e3&&__infLoop&&__infLoop(h))throw new RangeError;var v=i.items[m];v.time&&v.item.hasAttachmentType(l.a.PluginType.Calendar)&&(g=!0)}for(var _=0;_<i.items.length;_++){if(f++>5e3&&__infLoop&&__infLoop(f))throw new RangeError;var y=i.items[_],S=y.time,w=y.item,I=g&&S,b=r.default.classNames("dateBlockItem flexbox",{hasCircle:I}),A=null;if(I){var D={background:w.hasAttachmentType(l.a.PluginType.Calendar)&&w.getCalendarColor()};A=E.a.createElement("div",{className:"monthItemColorCircle",style:D})}p.push(E.a.createElement("div",{className:b,key:w.id},A,E.a.createElement(Hs.a,{className:"itemInCalendar",item:w,pane:t.pane,coloredInCalendar:!S&&w.getCalendarColor(),showPriority:!0,allowDrag:!0,editOnClick:!0}),S&&t.width>100&&E.a.createElement("span",{className:"itemTime"},S)))}e=(t.items||i.isHovered)&&E.a.createElement("div",{className:"dateBlockItems"},p)}return E.a.createElement("div",{className:d,style:u,onMouseDown:this.onMouseDown,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,onDoubleClick:this.onDoubleClick},E.a.createElement("div",{className:c},s),e)}}),zs={getState:function(e,t,i,a){return{paneRect:a.pane.rect}},render:function(e,t,i,a,n,s,o){var l,d=0,u=n.pane,c=r.default.classNames("calendarWeek c-bg-app","flexbox",n.className),h=u.getWidth()+1,f=Math.floor(h/7),p=h-7*f,g=0,m=0;p>0&&(g=Math.ceil(p/2),m=p-g),o.height+=1;for(var v=0;v<i.dates.length;v++){if(d++>5e3&&__infLoop&&__infLoop(d))throw new RangeError;var _=i.dates[v];_&&1===(_=_.date).getDate()&&(l=_.toString("MMMM"),_.getYear()!==Date.today().getYear()&&(l+=_.toString(" yyyy")))}return E.a.createElement("li",{"data-moo-id":t,className:c,style:o},i.dates.map(function(e,t){var i=f+(0===t?g:0)+(6===t?m:0);return E.a.createElement(qs,{key:e.date.getTime(),pane:u,date:e.date,items:e.items,index:t,left:t*f+(t>0?g:0),width:i})}),l&&E.a.createElement("div",{className:"calendarMonthTitle c-bg-app"},l))}},Ws=(os.a.createClass({displayName:"ReactCalendarTimes",componentDisplay:l.a.ComponentDisplay.Desktop,init:function(){this.scrollTop=void 0},getState:function(){var e=this.props.pane;return{numAllDay:e.numAllDay,heightAllDay:e.getHeightAllDay()}},componentDidMount:function(){this.props.trackPane&&setTimeout(function(){var e=this.props.pane.paneContent;e&&e.addEventListener("scroll",this.onPaneScroll)}.bind(this),0)},onUnmount:function(){var e=this.props.pane.paneContent;e&&e.removeEventListener("scroll",this.onPaneScroll)},onPaneScroll:function(e){var t=e.target.scrollTop;t!==this.scrollTop&&this.refs.scroller&&(this.scrollTop=this.refs.scroller.scrollTop=t)},render:function(){for(var e=0,t=this.props,i=this.state,a={height:t.height},n={height:i.heightAllDay+2},s={top:i.heightAllDay+30+2},r=[],o=0;o<24;o++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var l;12===o?l="Noon":(l=0===o?12:o%12,l+=" "+(o>=12?"pm":"am")),r.push(E.a.createElement("div",{key:o,className:"time"},l))}return E.a.createElement("div",{className:"calendarTimes belowHeader c-background",style:a},E.a.createElement("div",{className:"calendarTimesInner hideScrollbar c-border-heavy",style:s,ref:"scroller"},r),t.showAllDay&&E.a.createElement("div",{className:"calendarTimesAllDay c-border-heavy",style:n},"All day"))}}),i(44)),Gs=os.a.createClass({displayName:"ReactCalendarDay",componentDisplay:l.a.ComponentDisplay.Desktop,init:function(){this.createObservables({hoveredTime:void 0,hoveredDuration:void 0,isResizing:!1}),this.listenToDispatcher("dateChanged"),this.listenToDispatcher("endDrag")},arePropsEqual:function(e,t,i){return"items"===e?t===i||t&&i&&t.length===i.length:"date"===e?t===i||t&&i&&t.equals(i):void 0},areStatesEqual:function(e,t,i){if("items"===e){var a=0;if(!t||!i||t.length!==i.length)return!1;for(var n=0;n<t.length;n++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;if(!t[n].date.equals(i[n].date)||t[n].item!==i[n].item||t[n].duration!==i[n].duration)return!1}return!0}},componentWillReceiveProps:function(e){e.date.equals(this.props.date)&&e.items===this.props.items||this.updateState(e)},getState:function(e){var t=e.date.isToday(),i={isToday:t,todayTime:t&&new Date,numAllDay:e.pane.numAllDay};if(i.heightHeader=e.pane.getHeightAllDay(),e.items){var a=0;i.items=[];for(var n=0;n<e.items.length;n++){if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;var s=e.items[n];if(!s.isNote()){var r=s.date()||s.repeatDate()&&s.repeatDate().getStartDate();i.items.push({date:r,duration:s.getDuration(),item:s})}}}return i},componentDidMount:function(){this.state.isToday&&this.runTimeTimer()},onUnmount:function(){clearTimeout(this.timeTimeout)},componentDidUpdate:function(e){this.props.date.equals(e.date)||(this.hoveredDuration.set(void 0,!1),this.hoveredTime.set(void 0))},onBeforeChanged:function(e,t){return e.isToday?this.runTimeTimer():t.isToday&&!e.isToday&&clearTimeout(this.timeTimeout),!t.hoveredTime||We.default.isDragging||this.resizing||(this.hoveredTime.set(void 0,!1),this.hoveredDuration.set(void 0,!1),e.hoveredTime=void 0,e.hoveredDuration=void 0),e},runTimeTimer:function(){clearTimeout(this.timeTimeout),this.timeTimeout=setTimeout(this.updateState,3e5)},resetHovered:function(){this.resizing&&(this.resizing.component&&this.resizing.component.stopResizing(),this.resizing=void 0,this.isResizing.set(!1)),this.mouseDownAtTime=void 0,this.hoveredDuration.set(void 0,!1),this.hoveredTime.set(void 0)},onMouseUp:function(e){document.removeEventListener("mouseup",this.onMouseUp),this.resizing&&this.resizing.placeholder?this.addTime(this.hoveredTime.get(),this.hoveredDuration.get(),e):this.resetHovered()},onMouseLeave:function(){this.resizing||this.resetHovered()},getTimeFromMouseEvent:function(e){var t=e.clientY;return We.default.isDragging&&We.default.startPane&&We.default.startPane.isViewDates()&&We.default.startInfo&&(t+=12-(We.default.startInfo.y-We.default.position.top)),t-=r.default.findParent(e.target,"calendarDayTimes").getBoundingClientRect().top,Math.floor(t/(l.a.CalendarDayViewBlockHeight+1)*4)/4},onMouseDown:function(e){document.addEventListener("mouseup",this.onMouseUp),r.default.hasClass(e.target,"calendarDayTimes")&&(this.mouseDownAtTime=this.getTimeFromMouseEvent(e)),e.preventDefault()},onMouseMove:function(e){if(void 0!==this.mouseDownAtTime&&(this.resizing={placeholder:!0,pivot:this.mouseDownAtTime},this.mouseDownAtTime=void 0),We.default.isDragging){var t=this.getTimeFromMouseEvent(e);if(!isNaN(t)){var i=1,a=We.default.dragItem;a&&a.getDuration()&&(i=a.getDuration()/l.a.MSPerHour),this.hoveredDuration.set(i,!1),this.hoveredTime.set(t),(u=this.props.date.clone()).setHours(Math.floor(t)),u.setMinutes(60*(t-Math.floor(t))),We.default.setBlockTarget({date:u,dateTime:u,duration:1!==i?i:null,isDate:!0})}}else if(this.resizing){t=this.getTimeFromMouseEvent(e);if(!isNaN(t)){var n=this.resizing,s=n.pivot,o=t>=s?s:t,d=Math.floor(4*(t>=s?t-s+.5:s-t))/4;if(!isNaN(o)&&d>=.25)if(n.item){var u,c={isDate:!0};(u=this.props.date.clone()).setHours(Math.floor(o)),u.setMinutes(Math.round(60*(o-Math.floor(o)))),c.duration=d,c.date=c.dateTime=u,r.default.vmMain.beginUpdateItems();var h=this.props.pane;h.applyDropOnBlock(c,n.item,h),r.default.vmMain.commitUpdateItems()}else n.placeholder&&(d===this.hoveredDuration.get()&&o===this.hoveredTime.get()||(this.hoveredDuration.set(d,!1),this.hoveredTime.set(o,!0)))}}},onMouseEnterAllDay:function(){if(We.default.isDragging){var e=this.props.date;this.hoveredDuration.set(1,!1),this.hoveredTime.set(-1),We.default.setBlockTarget({date:e,isDate:!0,allDay:!0})}},onDoubleClickTimes:function(e){var t=this.getTimeFromMouseEvent(e);this.addTime(t,1,e)},addTime:function(e,t,i){var a=this.props,n=a.pane,s=a.date,r=n.item.get(),o=H.a.getAppendDateText(s,e,t);n.openItemEditor({element:i.target,text:" @"+o,parent:r,selectIndex:0,pos:{left:i.clientX,top:i.clientY},addOnSave:!0,showCalendarButtons:!0,onClosed:this.resetHovered})},onItemResizeStart:function(e,t,i){if(e.hasTime()){var a=e.getTimeOfDay(),n=e.getDuration()/l.a.MSPerHour||1,s=r.default.round(a/l.a.MSPerHour,4),o=i?s:s+n;return this.resizing={item:e,component:t,pivot:o},this.isResizing.set(!0),!0}},addToDay:function(e,t,i,a){e.push({t:t,dur:i,item:a,top:t,bottom:t+i,obj:a})},packItems:function(e){var t=0;e=e.sort(function(e,t){return e.top<t.top?-1:e.top>t.top?1:e.bottom<t.bottom?-1:e.bottom>t.bottom?1:0});for(var i=[],a=[],n=null,s=0;s<e.length;s++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var r=e[s];if(r.isPlaceholder)a=a.concat.apply(a,this.packEvents([[r]]));else{var o=0;null!==n&&r.top>=n&&(this.packEvents(i),a=a.concat.apply(a,i),i=[],n=null);for(var l=!1,d=0;d<i.length;d++){if(o++>5e3&&__infLoop&&__infLoop(o))throw new RangeError;var u=i[d];if(!this.collidesWith(u[u.length-1],r)){u.push(r),l=!0;break}}l||i.push([r]),(null===n||r.bottom>n)&&(n=r.bottom)}}return i.length>0&&(this.packEvents(i),a=a.concat.apply(a,i)),a},packEvents:function(e){for(var t=0,i=e.length,a=0;a<i;a++){var n=0;if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;for(var s=e[a],r=0;r<s.length;r++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var o=s[r],l=this.expandEvent(o,a,e);o.pos=a/i*100,o.width=100*l/i}}return e},collidesWith:function(e,t){return e.bottom>t.top&&e.top<t.bottom},expandEvent:function(e,t,i){for(var a=0,n=1,s=t+1;s<i.length;s++){var r=0;if(a++>5e3&&__infLoop&&__infLoop(a))throw new RangeError;for(var o=i[s],l=0;l<o.length;l++){if(r++>5e3&&__infLoop&&__infLoop(r))throw new RangeError;var d=o[l];if(this.collidesWith(e,d))return n}n++}return n},renderItems:function(){var e,t=0,i=this.props,a=this.state,n=a.items,s=[],o=a.hoveredTime,d=a.hoveredDuration;for(e=0;e<n.length;e++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var u=n[e].item,c=i.pane.getItemPlacementOnDate(u,i.date);c&&this.addToDay(s,c.time,c.duration,u)}isNaN(o)||isNaN(d)||s.push({t:o,dur:d,top:o,bottom:o+d,isPlaceholder:!0});var h,f=this.packItems(s);if(f.length){var p=0;for(h=[],e=0;e<f.length;e++){if(p++>5e3&&__infLoop&&__infLoop(p))throw new RangeError;var g=f[e],m=g.isPlaceholder,v=this.props.pane,_={height:g.dur*l.a.CalendarDayViewBlockHeight+Math.ceil(g.dur)-1,left:m?0:g.pos+"%",width:m?"95%":g.width+"%",top:Math.floor(g.t*(l.a.CalendarDayViewBlockHeight+1))},y=r.default.classNames("dayTimeBlock abs",{placeholder:m});h.push(E.a.createElement("div",{className:y,key:m?"placeholder":g.item.id,style:_},g.item&&E.a.createElement(Hs.a,{className:"itemInCalendar itemInCalendarResizabl",item:g.item,pane:v,coloredInCalendar:!0,showPriority:!0,resizable:!0,allowDrag:!0,onItemResizeStart:this.onItemResizeStart,editOnClick:!0})))}}return h},renderItemsAllDay:function(){for(var e=0,t=this.props,i=this.state,a=i.items,n=t.pane,s=[],r=i.hoveredTime,o={},l=0;l<a.length;l++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var d=a[l].item;t.pane.getItemPlacementOnDate(d,t.date)||s.push(E.a.createElement("div",{className:"dayTimeBlock",key:d.id,style:o},E.a.createElement(Hs.a,{className:"itemInCalendar",item:d,pane:n,coloredInCalendar:!0,showPriority:!0,resizable:!0,allowDrag:!0,onItemResizeStart:this.onItemResizeStart,editOnClick:!0})))}return!isNaN(r)&&r<0&&s.push(E.a.createElement("div",{className:"dayTimeBlock placeholder",key:"placeholder"})),s},render:function(){var e,t,i,a,n,s,o=this.props,d=this.state,u=(o.pane,o.date),c=0===u.getDay()||6===u.getDay(),h=this.renderItemsAllDay();if(d.isToday){var f=d.todayTime,g={top:Math.floor((f.getHours()+f.getMinutes()/60)*(l.a.CalendarDayViewBlockHeight+1))};s=E.a.createElement("div",{className:"calendarDayTimeLine",style:g})}e={width:o.width},t={top:d.heightHeader+30+3,height:o.height-d.heightHeader,width:o.width},i={height:d.heightHeader,minHeight:d.heightHeader},e[p.a.transform.react]=t[p.a.transform.react]=o.transform;var m=r.default.classNames("allDay c-border-heavy f1 preventScrollPropagate",{"c-bg-faded weekend":c}),v=r.default.classNames("calendarDayTimes c-border-heavy",{"c-bg-faded":c});a=E.a.createElement("ul",{className:m,style:i,onMouseEnter:this.onMouseEnterAllDay,onDoubleClick:this.addTime.bind(this,void 0,void 0),onMouseLeave:this.onMouseLeave},h),n=E.a.createElement("div",{className:v,style:t,onMouseDown:this.onMouseDown,onMouseMove:this.onMouseMove,onDoubleClick:this.onDoubleClickTimes,onMouseLeave:this.onMouseLeave},E.a.createElement("div",{className:"calendarDayGradient"}),E.a.createElement("div",{className:"calendarDayItems"},this.renderItems()),s);var _,y={className:r.default.classNames("calendarDay",{"weekend c-bg-faded":c},{today:d.isToday},{resizing:d.isResizing},o.className),"data-moo-id":o["data-moo-id"]};return u.getYear()!==Date.today().getYear()&&(_=u.toString(", yyyy")),E.a.createElement(o.component,y,E.a.createElement("div",{className:"calendarDayHeader c-background c-border-heavy flexbox flexvert",style:e},E.a.createElement("div",{className:"dayTitle"},E.a.createElement("span",null,u.toString("ddd MMM ")),E.a.createElement("span",{className:"dayTitleDay"},u.getDate()),_&&E.a.createElement("span",null,_)),a),n)}}),js={getState:function(e,t,i,a){return{numAllDay:a.pane.numAllDay}},render:function(e,t,i,a,n,s,o){var l=n.pane,d=r.default.classNames("calendarDay",n.className);return E.a.createElement(Gs,{"data-moo-id":t,component:"li",className:d,date:i.date,items:i.items,pane:l,height:o.height,transform:o[p.a.transform.react],width:l.getDayWidth()})}},Ks=os.a.createClass({displayName:"ReactCell",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this.DISABLE_LISTENER_ASSERT=!0,this.allowTransition=this.props.pane.supportCellTransition&&this.props.cell.isLive,this.createObservables({isHoveredLong:!1}),this.props.list.listen("reMount",this.reMount)},areStatesEqual:function(e,t,i){var a=this.props.cell.isLive&&this._getRenderer();if(a&&a.areStatesEqual)return a.areStatesEqual(e,t,i)},getState:function(e){var t=e.cell,i=t.paneObject,a=i,n=void 0;t.isLive&&(n=this._getRenderer(),a=this._getRenderObj());var s={isLive:t.isLive,item:a,id:i&&i.id,index:t.index,height:t.height,offset:t.offset,prevOffset:t.prevOffset,renderer:n,offsetX:t.offsetX,isAnimatingOffsetX:t.isAnimatingOffsetX,faded:!1};return t.isLive&&n&&n.getState&&(s=r.default.extend(s,n.getState(this,a,t.index,this.props))),s},componentDidMount:function(){this.listenTo(this.props.cell.cellChanged,!1),this.props.cell.offsetChanged.listen(this.onOffsetChanged),this._onMount()},onBeforeChanged:function(e,t){this.allowTransition=this.props.pane.supportCellTransition&&e.isLive&&this.props.cell.wasLive},componentDidUpdate:function(e,t){var i=this.state.item,a=t.item,n=this.state.renderer;n!==t.renderer&&t.renderer&&t.renderer.onUnmount&&t.renderer.onUnmount(this,a),i!==a&&(this.needsRefresh={prevState:t},this.props.list.isDelayingMounts||this.reMount()),n&&n.onUpdate&&n.onUpdate(this,i,this.props,this.state,e,t)},_onMount:function(){var e=this.state.item,t=this.state.renderer;e&&t&&t.onMount&&t.onMount(this,e,this.state.index,this.props,this.state)},onUnmount:function(){var e=this.state.item,t=this.state.renderer;this.props.cell.offsetChanged.unlisten(this.onOffsetChanged),e&&t&&t.onUnmount&&t.onUnmount(this,e,this.state.index,this.props,this.state)},reMount:function(){if(this.needsRefresh){var e=this.needsRefresh.prevState,t=e.item;this.refreshListeners(),t&&e.renderer&&e.renderer.onUnmount&&e.renderer.onUnmount(this,t),this._onMount(),this.needsRefresh=void 0}},onOffsetChanged:function(){this.refs.li.style[p.a.transform.style]=this.getTranslate(this.props.cell.offset)},_getRenderer:function(){var e,t=this.props.cell.paneObject;return r.default.isVMLI(t)?e=Ns:"blockItem"===t.type?e=Ns:"blockHeader"===t.type?e=Bs:"hr"===t.type?e=Us:"calendarWeek"===t.type?e=zs:"calendarDay"===t.type?e=js:"blockAddItem"===t.type&&(e=Vs),e},_getRenderObj:function(){var e=this.props.cell.paneObject;return"blockItem"===e.type?e.item:e},_getCellState:function(){var e=this.state,t={cell:this.props.cell.getState(),reactCell:{item:e.item.id,index:e.index,height:e.height,offset:e.offset,prevOffset:e.prevOffset,isLive:e.isLive}};return this.refs.li&&(t.element=r.default.getElementPath(this.refs.li)),t},getIndex:function(){return r.default.Assert(this.state.isLive,"Should never get the index of a dead cell",this.state.isLive?void 0:this._getCellState()),this.state.index},getItem:function(){return r.default.Assert(this.state.isLive,"Should never get the index of a dead cell",this.state.isLive?void 0:this._getCellState()),this.state.item},getCell:function(){return this.props.cell},getPaneObject:function(){return this.props.cell.paneObject},renderSwipeMenu:function(e,t,i){var a=this.props.pane,n={left:(i>0?"-":"")+"100%"},s={},o=a.sizeOfItem(e,t),l=a.getSwipeMenuItem(e,i);if(l){s[i>0?"right":"left"]=16;var d=r.default.isFunction(l.icon)?l.icon(e):l.icon,u=r.default.isFunction(l.color)?l.color(e):l.color,c=r.default.isFunction(l.text)?l.text(e):l.text;n.background=u,o<44&&(n.height=44,n.marginTop=-(44-o)/2);var h={float:i<0?"right":"left",padding:i<0?"0 0 0 16px":"0 16px 0 0"};return E.a.createElement("div",{className:"itemSwipeMenu",style:n},d&&E.a.createElement("div",{className:"itemSwipeIcon",style:s},E.a.createElement("i",{className:d}),E.a.createElement("span",{style:h},c)))}},getTransition:function(){var e=this.state;if(!e.offsetX&&e.isAnimatingOffsetX)return p.a.transform.style+" 0.15s"},getTranslate:function(e){var t=this.state,i=this.props;return e=t.isLive?e:-1e3,t.offsetX?"translate3d("+t.offsetX+"px,"+e+"px,0)":i.orientation===l.a.Orientation.Horizontal?"translate("+e+"px,0)":"translate(0,"+e+"px)"},render:function(){var e=this.props,t=this.state,i=this.getUniqueID(),a=t.renderer,n=r.default.vmMain.getItemAnimationMode(),s={height:t.height},o=r.default.classNames("cell",{transition:this.allowTransition&&n!==l.a.ItemAnimationMode.None}),d=this.getTransition();if(d&&(s[p.a.transition.react]=d),s[p.a.transform.react]=this.getTranslate(this.props.cell.offset),a&&t.isLive){var u=!!t.offsetX;return a.render(this,i,t.item,t.index,e,t,s,o,u&&this.renderSwipeMenu(t.item,t.index,t.offsetX))}return E.a.createElement("li",{"data-moo-id":i,className:"itemdead",style:s})}}),Ys=os.a.createClass({displayName:"ReactToast",componentDisplay:l.a.ComponentDisplay.Everywhere,getState:function(e){return{text:e.toast.text}},componentWillReceiveProps:function(e){this.updateState(e)},render:function(){var e=this.props.toast,t=this.state.text,i=r.default.classNames("toast noSelect",{hasAction:!!e.actionText},{big:e.isBig});return E.a.createElement("div",{className:i,onClick:e.onTapIgnore},E.a.createElement(F.a,{width:40,height:40,icon:"icon-close",className:"messageClose",onClick:e.onTapIgnore&&e.onTapIgnore}),E.a.createElement("span",{className:"messageText f1",dangerouslySetInnerHTML:{__html:t}}),E.a.createElement(F.a,{primary:!0,className:"messageAction",onClick:e.doAction.bind(e)},e.actionText))}}),Xs=(os.a.createClass({displayName:"ReactFormattingToolbar",componentDisplay:l.a.ComponentDisplay.Desktop,init:function(){this.listenToSetting(Settings.showFormattingToolbar)},getState:function(){return{position:M.a.itemHighlightPosition,pane:M.a.getPane(),numSelected:M.a.getSelectedItems().length,isCollapsed:0===r.default.settings.get(Settings.showFormattingToolbar)}},onClickFormat:function(e){r.default.vmMain.applyFormatToSelection(e)},onClickPrefix:function(e){r.default.vmMain.applyPrefixToSelection(e)},onClickNote:function(){var e=M.a.getStartItem();e&&e.editNote()},onClickLink:function(){M.a.getStartItem().insertLinkAtSelection()},onClickToggleShow:function(){var e=r.default.settings.get(Settings.showFormattingToolbar);e=0===e?1:0,r.default.settings.set(Settings.showFormattingToolbar,e)},render:function(){var e=this.state,t=this.props,i=e.position,a=e.position&&e.pane===t.pane,n=e.isCollapsed;if(a){var s=n?24:32,r=n?24:36,o=n?24:329,d=Math.min(Math.max(Math.floor(i.x),o/2+4),e.pane.getWidth()-o/2-4),u={height:r,width:o,marginLeft:-o/2,marginTop:-r-4};return u[p.a.transform.react]="translate3d("+d+"px,"+Math.floor(i.y)+"px,0)",n?E.a.createElement("div",{className:"formattingToolbar collapsed c-popup c-bg-sidebar c-shadow-popup",style:u},E.a.createElement(F.a,{icon:"icon-more_horiz",width:o,height:o,iconSize:14,tooltip:"Show formatting toolbar",onClick:this.onClickToggleShow})):E.a.createElement("div",{className:"formattingToolbar c-popup c-bg-sidebar c-shadow-popup",style:u},E.a.createElement(F.a,{icon:"icon-format_bold",width:s,height:r,iconSize:19,onClick:this.onClickFormat.bind(this,"**"),tooltip:"Bold",tooltipHotkey:{name:"Bold"}}),E.a.createElement(F.a,{icon:"icon-format_italic",width:s,height:r,iconSize:19,onClick:this.onClickFormat.bind(this,"*"),tooltip:"Italic",tooltipHotkey:{name:"Italic"}}),E.a.createElement(F.a,{icon:"icon-format_underlined",width:s,height:r,iconSize:18,onClick:this.onClickFormat.bind(this,"__"),tooltip:"Underline",tooltipHotkey:{name:"Underline"}}),E.a.createElement("div",{className:"divider"}),E.a.createElement(F.a,{icon:"icon-project",width:s,height:r,iconSize:18,onClick:this.onClickPrefix.bind(this,l.a.Prefix.Header),tooltip:"Project",tooltipHotkey:l.a.Prefix.Header+"&nbsp;&nbsp; Space"}),E.a.createElement(F.a,{icon:"prefixTask",width:s,height:r,iconSize:20,onClick:this.onClickPrefix.bind(this,l.a.Prefix.Task),tooltip:"Task",tooltipHotkey:l.a.Prefix.Task+"&nbsp;&nbsp; Space"}),E.a.createElement(F.a,{icon:"icon-bullet",width:s,height:r,iconSize:22,onClick:this.onClickPrefix.bind(this,l.a.Prefix.Bullet),tooltip:"Bulleted list",tooltipHotkey:l.a.Prefix.Bullet+"&nbsp;&nbsp; Space"}),E.a.createElement(F.a,{icon:"icon-numlist",width:s,height:r,iconSize:14,onClick:this.onClickPrefix.bind(this,l.a.Prefix.NumList),tooltip:"Numbered list",tooltipHotkey:l.a.Prefix.NumList+"&nbsp;&nbsp; Space"}),E.a.createElement("div",{className:"divider"}),E.a.createElement(F.a,{icon:"icon-link",enabled:1===e.numSelected,width:s,height:r,iconSize:18,onClick:this.onClickLink,tooltip:"Create link",tooltipHotkey:{name:"InsertLink"}}),E.a.createElement(F.a,{icon:"icon-sticky-note-o",enabled:1===e.numSelected,width:s,height:r,iconSize:14,onClick:this.onClickNote,tooltip:"Add note",tooltipHotkey:{name:"EditNote"}}),E.a.createElement("div",{className:"divider"}),E.a.createElement(F.a,{icon:"icon-minus",width:s,height:r,iconSize:10,tooltip:"Hide formatting toolbar",onClick:this.onClickToggleShow}))}return null}}),i(31).default),Qs=os.a.createClass({displayName:"ReactPane",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this.listenToSetting(Settings.showFormattingToolbar),this.createObservables({dragOffset:0,isDragging:!1})},componentDidMount:function(){var e=this.props.pane,t=e.scrollElement=this.refs.scroller.getScrollElement(),i=e.rootElement=this.refElement("rootElement"),a=e.paneContent=this.refElement("contentElement"),n=e.getInfiniteList(!1);e.element=this.refs.pane,n.setupScroller(t,a),i.addEventListener("compositionstart",e.compositionStart),i.addEventListener("compositionend",e.compositionEnd),p.a.android||i.addEventListener("input",e.onInput),r.default.setupClick(this.refs.scroller.getElement(),e,e.onTap),e.onLoad(),e.getOverview().onPaneLoad(),g.a.fireEvent("paneAdded",[e])},getState:function(){var e,t=this.props.pane;return t.isDestroyed()?e={}:(e={rect:t.rect,left:t.getLeft(),isExpanded:!1,isActive:t.isActive,isOverviewVisible:t.overview.isVisible,isHelpVisible:!!r.default.intro&&r.default.intro.isVisible,item:t.item,paneTopText:t.paneTopText,orientation:t.orientation,titles:t.getTitleList(),showScrollbars:t.showScrollbars,toast:t.toast,showFormattingToolbar:r.default.settings.get(Settings.showFormattingToolbar)>=0}).bottomBarHeight=Xs.bottomBarHeight,e},getPane:function(){return this.props.pane},itemsObs:function(){return this.props.pane.items},getScrollSize:function(){return this.props.pane.getInfiniteList(!1).getScrollSize()},getClientHeight:function(){return this.props.pane.getHeight()},getScrollTop:function(){return this.props.pane.getInfiniteList(!1).getScrollTop()},onScroll:function(){this.refs.scroller&&this.refs.scroller.handleScroll()},startDragging:function(e){r.default.hasClass(e.target,"paneDraggable")&&r.default.vmMain.paneManager.paneCount()>1&&(this.hasMovedDrag=!1,this.dragStartX=e.clientX-this.props.pane.rect.get().left,document.addEventListener("mousemove",this.onDragMove),document.addEventListener("mouseup",this.onDragUp))},onDragMove:function(e){this.hasMovedDrag||(this.hasMovedDrag=!0,We.default.isDraggingPane.set(!0),this.isDragging.set(!0));var t=this.props.pane.rect.get(),i=e.clientX-this.dragStartX-t.left;this.updateDragOffset(i),r.default.vmMain.paneManager.dragPaneTo(this.props.pane,t.left+i,t.right+i)&&this.updateDragOffset(e.clientX-this.dragStartX-this.props.pane.rect.get().left)},onDragUp:function(){this.isDragging.set(!1),We.default.isDraggingPane.set(!1),document.removeEventListener("mousemove",this.onDragMove),document.removeEventListener("mouseup",this.onDragUp),this.updateDragOffset(0)},updateDragOffset:function(e){this.dragOffset.set(e)},renderScrollerWrapper:function(e,t){var i={position:"relative"},a=e.offsetX;return a&&(i[p.a.transform.react]="translate3d("+a+"px,0,0)"),this.props.pane.isAnimatingOffset&&(i[p.a.transition.react]=p.a.transform.style+" 0.15s"),E.a.createElement("div",{className:"paneScrollerWrapper f1 flexbox flexvert",style:i},t.children)},onTouchMove:function(e){},onMouseMovePaneBlocker:function(e){Xs.update(e)},onMouseUpPaneBlocker:function(e){Xs.end(e)},onClickPaneBlocker:function(e){Xs.onClickPane(e)},onMouseDownDrag:function(e){this._onMouseDownDrag(e,!1)},onMouseDownDragExpanded:function(e){this._onMouseDownDrag(e,!0)},_onMouseDownDrag:function(e,t){var i=this.state.rect;this.resizingInfo={startPos:e.clientX,startOffset:e.clientX-r.default.offset(this.refs.pane).left-i.width-(t?i.widthExpanded:0),startWidth:this.state.rect.width,isExpanded:t},document.addEventListener("mousemove",this.onMouseMoveResize),document.addEventListener("mouseup",this.onMouseUpResize),r.default.preventDefault(e)},onMouseMoveResize:function(e){var t=this.resizingInfo;if(t){var i=r.default.offset(this.refs.pane),a=e.clientX-i.left-t.startOffset;t.isExpanded&&(a-=this.state.rect.width),this.props.pane.setWidthManual(a,t.isExpanded)}},onMouseUpResize:function(){this.resizingInfo=void 0,r.default.vmMain.paneManager.updatePaneRects(),document.removeEventListener("mousemove",this.onMouseMoveResize),document.removeEventListener("mouseup",this.onMouseUpResize)},onDoubleClickDrag:function(e,t){this.props.pane.widthManual&&this.props.pane.setWidthManual(void 0,t)},onDoubleClickDragExpanded:function(e){this.onDoubleClickDrag(e,!0)},renderCell:function(e,t){var i=this.props.pane;return E.a.createElement(Ks,{key:e,list:i.getInfiniteList(!1),pane:i,orientation:this.state.orientation,cell:t})},render:function(){var e,t=this.props,i=this.state,a=t.pane,n=r.default.classNames("pane c-border",a.paneClass,t.className,{overviewOpen:i.isOverviewVisible},{expanded:i.isExpanded},{none:!i.isActive},{hasTitles:!1},{horizontal:i.orientation===l.a.Orientation.Horizontal},{vertical:i.orientation!==l.a.Orientation.Horizontal},{oneRow:1===i.titles.length&&!a.showRootOnRow2},{"flexbox flexvert":!0},{firstPane:i.rect.isFirst},{transition:!r.default.vmMain.paneManager.isResizingPane&&!i.isDragging},{dragging:i.isDragging}),s=r.default.classNames("paneScroller belowHeader c-background",{overviewOpen:i.isOverviewVisible},{customScroller:a.useCustomScroller},"f1"),o=r.default.classNames("paneRoot"),d=r.default.classNames("paneContent",{editable:a.isWriteable});a.topBoxHeight.get()>0&&(e=i.paneTopText?E.a.createElement("span",{className:"loadingText"},i.paneTopText):this.getChildByKey("topBox"));var u,c=E.a.createElement(Ts,{owner:a.getInfiniteList(!1),pane:a,overview:!1,renderCell:this.renderCell,itemsObs:t.itemsObs,hiddenInput:!1,contentClass:d,orientation:i.orientation,ref:"contentElement"},a.topBoxHeight.get()>0&&E.a.createElement("div",{key:"topBox",className:"paneTopBox c-background"},e)),h=i.rect,f={width:h.width};h.width,h.width,h.widthExpanded;f.left=i.left,u={marginBottom:i.bottomBarHeight};var p={};return p.offsetX=a.offsetX,E.a.createElement(E.a.Fragment,null,E.a.createElement("div",{key:"pane","data-moo-id":this.getUniqueID(),ref:"pane",className:n,style:f},E.a.createElement(hs,{observe:p,render:this.renderScrollerWrapper},E.a.createElement(As,{pane:a,startDragging:this.startDragging},this.getChildByKey("headerButtons")),E.a.createElement(Ws.a,{className:s,style:u,getScrollSize:this.getScrollSize,getClientHeight:this.getClientHeight,getScrollTop:this.getScrollTop,noOwnScroll:!0,orientation:i.orientation,showScrollbars:i.showScrollbars,ref:"scroller"},E.a.createElement("div",{className:o,ref:"rootElement",onTouchMove:this.onTouchMove},c,null,!1)),i.isOverviewVisible&&E.a.createElement(cs.a,{className:"paneClickBlocker",onMouseMove:this.onMouseMovePaneBlocker,onClick:this.onClickPaneBlocker,onMouseUp:this.onMouseUpPaneBlocker})),this.getChildByKey("overlay"),i.toast&&E.a.createElement("div",{className:"paneToasts"},E.a.createElement(Ys,{toast:i.toast}))),!1,!1)}}),Js=os.a.createClass({displayName:"ReactPaneList",componentDisplay:l.a.ComponentDisplay.Everywhere,getState:function(){var e=this.props.pane;return{rect:e.rect,hasCollapsed:e.hasCollapsedObs,_allowCollapsingObs:e.search.getFilterObs("showOnlyMatches"),allowCollapsing:!e.search.getFilterValue("showOnlyMatches")}},render:function(){var e=this.state,t=this.props.pane;e.hasCollapsed,l.a.PaneHeaderButtonHeight;return E.a.createElement(Qs,{pane:t},E.a.createElement("div",{className:"f1",key:"headerButtons"},t.supportCollapsing&&!1))}}),Zs=Object.assign||function(e){for(var t=0,i=1;i<arguments.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=arguments[i];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},$s=(os.a.createClass({displayName:"FancyCalendarDayButton",componentDisplay:l.a.ComponentDisplay.Desktop,render:function(){return E.a.createElement(F.a,Zs({},this.props,{className:"fancyCalendarDayButton",iconSize:16,padding:0,tooltip:"Jump to Today",icon:"icon-calendar-o",center:!0}),this.props.day)}}),l.a.TaskViewMode,os.a.createClass({displayName:"ReactPaneTask",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this.listenToDispatcher("dateChanged");var e=r.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar);e.onSettingChanged(e.Settings.IsEnabled,this.onSettingChanged),this.listenToSetting(Settings.dayWeekStart),this.listenToSetting(Settings.calendarCustomDays)},getState:function(){var e=this.props.pane,t=r.default.vmMain.pluginManager.getPlugin(PluginID.GCalendar);return{item:e.item,rect:e.rect,hasCollapsed:e.hasCollapsedObs,_allowCollapsingObs:e.search.getFilterObs("showOnlyMatches"),allowCollapsing:!e.search.getFilterValue("showOnlyMatches"),viewState:e.viewState,viewMode:e.getViewMode(),isCalendarView:e.isViewCalendar(),hasPremiumFeatures:r.default.billingManager.hasPremiumFeaturesObservable,date:(new Date).getDate(),isGCalEnabled:t.isEnabled(),calendarCustomDays:r.default.settings.get("calendarCustomDays"),dayWeekStart:r.default.settings.get(Settings.dayWeekStart)}},onSettingChanged:function(){this._isMounted&&this.updateState()},onClickToday:function(){this.props.pane.scrollToToday(ScrollDuration.Default)},onClickJumpBack:function(){this.props.pane.scrollJump(-1,ScrollDuration.Default)},onClickJumpForward:function(){this.props.pane.scrollJump(1,ScrollDuration.Default)},onClickAddItem:function(e){this.props.pane.addItemWithPrefix(0,e)},onClickAddFile:function(e,t){var i=this.props,a=i.pane,n=i.paneObject;r.default.menus.openContextMenu({componentName:"ReactContextMenuDropZone",element:t.target,pane:a,itemParent:a.getItem(),insertIndex:0,image:e,paneObject:n})},onClickAddItemPopup:function(e){this.props.pane.openItemEditor({element:e.target,addOnSave:!0})},onClickViewMode:function(e){this.props.pane.setViewMode(e)},renderPaneBox:function(){var e=this.props.pane,t=e.isViewOutline()||e.isViewProjectNoBlocks();return E.a.createElement("div",{className:"flexbox flex-center addItemButton c-foreground-faded"},E.a.createElement(F.a,{icon:"icon-project",iconSize:16,width:44,onClick:this.onClickAddItem.bind(this,l.a.Prefix.Header),tooltip:"Add project"}),t&&E.a.createElement(F.a,{icon:"icon-edit",iconSize:12,width:44,onClick:this.onClickAddItem.bind(this,""),tooltip:"Add item"}),t&&E.a.createElement(F.a,{icon:"icon-check",iconSize:14,width:44,onClick:this.onClickAddItem.bind(this,l.a.Prefix.Task),tooltip:"Add task"}),t&&E.a.createElement(F.a,{icon:"icon-bullet",iconSize:22,width:44,onClick:this.onClickAddItem.bind(this,l.a.Prefix.Bullet),tooltip:"Add bullet"}),t&&E.a.createElement(F.a,{icon:"icon-numlist",iconSize:12,width:44,onClick:this.onClickAddItem.bind(this,l.a.Prefix.NumList),tooltip:"Add numbered list"}),t&&E.a.createElement(F.a,{icon:"icon-drive-file",iconSize:14,width:44,onClick:this.onClickAddFile.bind(this,!1),tooltip:"Add file"}),t&&E.a.createElement(F.a,{icon:"icon-image",iconSize:14,width:44,onClick:this.onClickAddFile.bind(this,!0),tooltip:"Add image"}))},render:function(){var e=this.state,t=this.props.pane,i=this.state.viewMode,a=(l.a.TaskViewModeText[i],e.rect.width,l.a.PaneHeaderButtonWidth,l.a.PaneHeaderButtonHeight,r.default.classNames(e.isCalendarView?"calendar"+l.a.TaskViewModeText[i]+"View c-background":"",{showingButtons:e.isCalendarView},{premiumBlocked:t.isViewPremiumBlocked()}));return E.a.createElement(Qs,{pane:t,itemsObs:this.itemsObs,className:a},void 0,void 0,void 0)}})),er=os.a.createClass({displayName:"ReactPaneGmail",componentDisplay:l.a.ComponentDisplay.Everywhere,componentDidMount:function(){this.listenTo(this.props.pane.search.onChanged)},getState:function(){var e=this.props.pane;return e.isDestroyed()?{}:{rootItem:e.item,messages:ut.a.messages,isActivePane:ut.a.activePane===e,viewState:e.viewState,viewMode:e.getViewMode()}},onHoldViewButton:function(e){r.default.menus.openContextMenu({fn:this.renderContextMenuSort,element:e.target})},onClickViewButton:function(){var e=this.state.viewMode===l.a.GmailViewMode.Priority?l.a.GmailViewMode.Date:l.a.GmailViewMode.Priority;this.setViewMode(e),r.default.menus.closeContextMenu()},renderContextMenuSort:function(e){return E.a.createElement(vs.a,{key:"contextMenuGmailSort",id:"contextMenuGmailSort",element:e.element},E.a.createElement(ms.a,null,"Sort by"),E.a.createElement(_s.a,{icon:"icon-access_time",onClick:this.setViewMode.bind(this,l.a.GmailViewMode.Date)},l.a.GmailViewMode.Date),E.a.createElement(_s.a,{icon:"icon-exclamation",onClick:this.setViewMode.bind(this,l.a.GmailViewMode.Priority)},l.a.GmailViewMode.Priority))},setViewMode:function(e){this.props.pane.setViewMode(e)},renderViewButton:function(){var e=this.state.viewMode===l.a.GmailViewMode.Date?"icon-access_time":"icon-exclamation";return E.a.createElement(F.a,{key:"sort",className:"emailViewButton",tooltip:"Sort Order",icon:e,iconSize:14,width:l.a.PaneHeaderButtonWidth,height:l.a.PaneHeaderButtonHeight,onClick:this.onClickViewButton,onHold:this.onHoldViewButton})},render:function(){this.props.pane;return E.a.createElement(Qs,{key:"pane",pane:this.props.pane},E.a.createElement("div",{key:"headerButtons"},this.renderViewButton()))}}),tr=os.a.createClass({displayName:"ReactDragDrop",componentDisplay:l.a.ComponentDisplay.Everywhere,getState:function(){var e=We.default,t=r.default.vmMain.paneManager,i={items:e.draggingItems,activePane:e.activePane,pane:e.startPane,position:e.position,transform:e.transform,isDragging:e.isInDrag,linePosition:e.linePosition,fromOverview:e.fromOverview,dropBucketItems:r.default.vmMain.dropBucket.getItems(),onlineText:r.default.vmMain.onlineText(),contextMenus:r.default.menus.contextMenuStack};i.draggingToOutline=e.draggingToOutline,i.dragTargetHovered=e.dragTargetHovered,i.mobilePaneSelected=t.mobilePaneSelected;var a=20;return e.draggingItems&&e.draggingItems.length>0&&!isNaN(e.draggingItems[0].index)&&(a=e.startPane&&e.dragItem&&e.startPane.sizeOfItem(e.dragItem,e.draggingItems[0].index)),i.dropBucketTop=!r.default.menus.isContextMenuOpen()&&e.position&&e.position.top+a/2,i},onBeforeChanged:function(e,t){if(e.items!==t.items){var i=0;this.paddings=[];for(var a=0;a<e.items.length;a++){if(i++>5e3&&__infLoop&&__infLoop(i))throw new RangeError;this.paddings[a]=e.pane.getPaddingForPaneObject(e.items[a])-8}}},onClickDropBucket:function(){this.state.dropBucketItems.length>0&&r.default.menus.toggleContextMenu({componentName:"ReactContextMenuDropBucket",position:"bottom",pane:r.default.focusedPane})},onClickCancelDragToOutline:function(){We.default.stopDraggingToOutline()},render:function(){var e,t,i,a,n=this.state,s=n.pane,o=n.items;if(s&&n.isDragging){if(o&&o.length>0&&n.position&&n.transform){for(var l=0,d=[],u=Math.min(o.length,10),c=0;c<u;++c){if(l++>5e3&&__infLoop&&__infLoop(l))throw new RangeError;var h=this.paddings[c];d.push(E.a.createElement(Hs.a,{key:"drag_"+c,pane:s,item:o[c].item,paneObject:o[c],renderLikePane:!0,noNotes:n.fromOverview,padding:h}))}var f=o.length-u;f>0&&d.push(E.a.createElement("div",{className:"dotdotdot",key:"dotdotdot"},"... plus "+f+" more ..."));var g={left:0,top:n.position.top,width:s.widthOfDrag(o[0]),maxWidth:s.getWidth()},m=n.transform;g[p.a.transform.react]="translate3d("+m.left+"px, "+m.top+"px, 0)",e=E.a.createElement("ul",{id:"dragUL",style:g,className:"popup c-shadow-popup c-background"},d)}if(n.linePosition&&n.activePane){var v=n.linePosition,_={width:v.width,height:v.height},y=r.default.classNames({isLine:!v.height});_[p.a.transform.react]="translate("+v.left+"px, "+v.top+"px)",t=E.a.createElement("div",{id:"dragLine",style:_,className:y})}a=r.default.classNames("from_"+s.type,n.activePane.paneClass)}var S,w,I=n.isDragging&&!r.default.menus.isContextMenuOpen(),b=n.pane===r.default.focusedPane,A=n.dropBucketItems,D=n.onlineText?60:44,T={top:n.dropBucketTop,bottom:!n.dropBucketTop&&D+24},M=r.default.classNames("dragTarget mobileDropBucket",{showIcon:!I},{hovered:"dragToSave"===n.dragTargetHovered}),C=r.default.classNames("dragTarget mobileDragToOutline",{hovered:"dragToOutline"===n.dragTargetHovered});I?b&&(S=E.a.createElement(F.a,{id:"dragToSave",width:50,height:50,color:"white",iconSize:20,style:T,key:"bucket",className:M,onClick:this.onClickDropBucket},E.a.createElement("span",{className:"buttonText"},"Drag",E.a.createElement("br",null),"here",E.a.createElement("br",null),"to",E.a.createElement("br",null),"save")),s.type===PaneMode.Gmail&&(w=E.a.createElement("div",{id:"dragToOutline",className:C,style:T},"Drag",E.a.createElement("br",null),"to",E.a.createElement("br",null),"outline"))):A.length>0&&!r.default.menus.isContextMenuOpen()&&(S=E.a.createElement(F.a,{width:50,height:50,color:"white",iconSize:20,style:T,key:"bucket",className:M,onClick:this.onClickDropBucket,enabled:r.default.focusedPane&&r.default.focusedPane.type===PaneMode.Task},E.a.createElement("span",{className:"bucketIcon"},E.a.createElement("i",{className:"icon-content_paste"}),A.length>0&&E.a.createElement("div",null,A.length)))),i=E.a.createElement("div",{className:"dragTargets"},S,w);var L=n.draggingToOutline&&E.a.createElement("div",{className:"draggingToOutlineArea flexbox"},E.a.createElement("div",{className:"f1"},"Tap a destination for this email"),E.a.createElement(F.a,{color:"white",height:60,onClick:this.onClickCancelDragToOutline},"CANCEL"));return E.a.createElement("div",{id:"dragdrop",className:a},e,t,L,i)}}),ir=i(59),ar=Object.assign||function(e){for(var t=0,i=1;i<arguments.length;i++){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var a=arguments[i];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};var nr,sr,rr=os.a.createClass({displayName:"FancyOverlayPopup",componentDisplay:l.a.ComponentDisplay.Desktop,render:function(){var e=this.props,t=e.className,i=e.minimized,a=e.minimize,n=e.close,s=e.title,o=e.children,l=function(e,t){var i={};for(var a in e)t.indexOf(a)>=0||Object.prototype.hasOwnProperty.call(e,a)&&(i[a]=e[a]);return i}(e,["className","minimized","minimize","close","title","children"]),d=r.default.classNames(t,"fancyOverlayPopup popup c-shadow-popup c-background",{minimized:i}),u=a&&r.default.classNames("popupMinimize",{minimized:i});return E.a.createElement("div",ar({},l,{className:d}),E.a.createElement("div",{className:"overlayTitleBar c-foreground c-border-heavy c-bg-popup-title flexbox"},E.a.createElement("div",{className:"displayTitle f1"},s),a&&E.a.createElement(F.a,{className:u,icon:"icon-minus",iconSize:14,width:36,height:36,onClick:a,tooltip:i?"Restore":"Minimize"}),E.a.createElement(F.a,{icon:"icon-close",width:36,height:36,onClick:n,tooltip:"Close"})),o)}}),or=os.a.createClass({displayName:"ReactEmailComposeWindow",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this.listenToDispatcher("windowResize"),this.createObservables({minimized:!1})},getState:function(){var e=p.a.windowWidth(),t=p.a.windowHeight();return{width:Math.min(Math.max(Math.min(.4*e,800),500),e-20),height:Math.min(Math.max(Math.min(.4*t,800),500),t)}},minimize:function(){this.minimized.set(!this.minimized.get())},close:function(){this.refs.compose.close(!0,!1,!0)},onClose:function(){g.a.fireEvent("EmailCompose","onClosed",[]),r.default.menus.closeComposeEmail(this.props.threadAttach,this.props.message)},onMouseDown:function(){M.a.reset()},openCc:function(){this.cc.set(!0)},openBcc:function(){this.bcc.set(!0)},componentDidMount:function(){var e=this.refs.compose;e.focusTo(),requestAnimationFrame(function(){e.focusTo()})},render:function(){var e=this.state,t={height:e.minimized?36:e.height,width:e.width};return E.a.createElement(rr,{title:"New Message",minimized:e.minimized,minimize:this.minimize,close:this.close,className:"composeEmail flexbox flexvert",ref:"element",style:t,onMouseDown:this.onMouseDown},E.a.createElement(ir.a,{className:"f1",threadAttach:this.props.threadAttach,message:this.props.message,showSubject:!0,onClose:this.onClose,ref:"compose",focus:"to",hidden:e.minimized}))}}),lr=os.a.createClass({displayName:"ReactEmailComposes",componentDisplay:l.a.ComponentDisplay.Everywhere,getState:function(){return{emailComposes:r.default.menus.emailComposeStack}},render:function(){for(var e=0,t=this.state,i=[],a=0;a<t.emailComposes.length;a++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var n=t.emailComposes[a];i.push(E.a.createElement(or,{key:n.draftMsg.id,threadAttach:n.attach,message:n.draftMsg}))}return E.a.createElement("div",{className:"emailComposes flexbox"},i)}}),dr=i(67),ur=os.a.createClass({displayName:"ReactOverview",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this.createObservables({addingItem:void 0})},componentDidMount:function(){var e=this.props.pane,t=e.getOverview(),i=t.scrollElement=this.refs.overviewScroller.getScrollElement(),a=t.contentElement=this.refElement("overviewContentElement");e.getInfiniteList(!0).setupScroller(i,a),r.default.setupClick(i,e.getOverview(),e.getOverview().onTap)},getState:function(){var e=this.props.pane,t={isVisible:e.getOverview().isVisible,zoomed:e.item};return t.offsetX=e.offsetX,t},getPane:function(){return this.props.pane},renderCell:function(e,t){var i=this.props.pane;return E.a.createElement(Ks,{key:e,list:i.getInfiniteList(!0),pane:i,cell:t,overview:!0})},sizeAtIndex:function(e){var t=this.props.pane;return t.headers.get()[e].sizeInPane(t,!0)},itemsObs:function(){return this.props.pane.headers},onClickAddTop:function(){this.addingItem.set("top")},onClickAddBottom:function(){this.addingItem.set("bottom"),this.refs.overviewScroller.scrollToBottom()},onClickAll:function(){var e=this.props.pane;r.default.vmMain.zoomout(e.getRootItem()),us.default.setOverviewVisibility(e,!1)},onAddItem:function(e){var t=this.refs.inputAddItem.getValue();this.addingItem.set(void 0);var i=this.props.pane,a=i.getRootItem(),n="top"===e?0:a.numItems(),s=i.addProject(n,t,!0);setTimeout(function(){i.getItem()!==a&&r.default.vmMain.zoomout(a),i.scrollItemToTop(s,ScrollDuration.Default)},0),us.default.setOverviewVisibility(i,!1)},onClickCancel:function(){this.addingItem.set(void 0)},onClickGmailAccount:function(e){var t=this.props.pane;t.setOverviewAccount(e),r.default.vmMain.zoomin(t.getDefaultDisplayItem(e))},renderAddProjectInput:function(e){var t=this.onAddItem.bind(this,e),i=this.onClickCancel.bind(this,e);return E.a.createElement("div",{className:"addProjectInput"},E.a.createElement(ps.a,{ref:"inputAddItem",focused:!0,height:32,placeholder:"Name project",onEscape:i,onEnter:t}),E.a.createElement("div",{className:"addProjectButtons"},E.a.createElement(F.a,{primary:!0,onClick:t},"Add Project"),E.a.createElement(F.a,{onClick:i},"Cancel")))},renderShowAllButton:function(e){return E.a.createElement(F.a,{className:"overviewHeaderButton",icon:"icon-visibility",height:30,iconSize:15,onClick:this.onClickAll,enabled:!this.state.isAtRoot},"Show all "+e)},renderHeader:function(){var e=this.state,t=this.props.pane;switch(t.type){case PaneMode.Task:var i=t.isViewOutline()||t.isViewProject();return E.a.createElement("div",{className:"overviewHeader"},this.renderShowAllButton("projects"),i&&"top"!==e.addingItem&&E.a.createElement(F.a,{className:"overviewHeaderButton",icon:"icon-project",iconSize:15,height:30,onClick:this.onClickAddTop},"Add project"),i&&"top"===e.addingItem&&this.renderAddProjectInput("top"),E.a.createElement("hr",null));case PaneMode.Archived:return E.a.createElement("div",{className:"overviewHeader"},this.renderShowAllButton("projects"),E.a.createElement("hr",null));case PaneMode.Drive:return E.a.createElement("div",{className:"overviewHeader"},E.a.createElement("div",{className:"overviewHeaderTitle"}),this.renderShowAllButton("folders"),E.a.createElement("hr",null));case PaneMode.Gmail:var a=r.default.vmMain.pluginManager.getPlugin(PluginID.Gmail),n=e.overviewAccount,s=a.getSyncAccounts(),o=r.default.classNames("overviewHeader",{"c-border":s.length>1});return E.a.createElement("div",{className:o},s.length>1&&s.map(function(e){return E.a.createElement(F.a,{className:"overviewHeaderButton",key:e,selected:e===n,height:30,onClick:this.onClickGmailAccount.bind(this,e)},e)}.bind(this)))}},renderFooter:function(){var e=this.state,t=this.props.pane;switch(t.type){case PaneMode.Task:return(t.isViewOutline()||t.isViewProject())&&t.numHeaders()>0?E.a.createElement("div",{className:"overviewFooter"},E.a.createElement("hr",null),"bottom"===e.addingItem&&this.renderAddProjectInput("bottom"),"bottom"!==e.addingItem&&E.a.createElement(F.a,{className:"overviewHeaderButton",icon:"icon-project",iconSize:15,height:30,onClick:this.onClickAddBottom},"Add project")):null}},render:function(){this.state;var e=this.props.pane;var t=r.default.classNames("paneOverview",e.type+"Overview"),i=r.default.classNames(this.props.className,"paneOverviewScroller","scroller",{customScroller:e.useCustomScroller},{transition:!r.default.vmMain.paneManager.isResizingPane}),a=this.renderHeader(),n=this.renderFooter();return E.a.createElement("div",{className:"paneOverviewWrapper","data-moo-id":this.getUniqueID()},E.a.createElement(Ws.a,{className:i,ref:"overviewScroller",style:{},showScrollbars:!0},E.a.createElement("div",{className:t,ref:"overview"},a,E.a.createElement(Ts,{owner:e.getInfiniteList(!0),pane:e,overview:!0,renderCell:this.renderCell,itemsObs:this.itemsObs,contentClass:"overviewList noSelect mat-list",ref:"overviewContentElement"}),n)))}}),cr=i(70),hr=os.a.createClass({displayName:"ReactMobileOverview",componentDisplay:l.a.ComponentDisplay.Mobile,getState:function(){var e=this.props.pane,t={documentName:r.default.settings.get(Settings.gdocTitle)||r.default.isDemoMode()&&"DEMO",mounted:this._isMounted};return t.rect=e.rect,t.left=e.rect.get().left,t.overviewWidth=us.default.overviewWidth(),t},onTapFiles:function(){r.default.menus.openContextMenu({fn:this.renderContextMenuDocuments})},onTapSettings:function(){r.default.menus.openModalNew(Modals.MobileSettings)},renderContextMenuDocuments:function(){return E.a.createElement(cr.default,{key:"contextMenuDocuments",position:"bottom"})},render:function(){var e=this.state,t=this.props.pane,i=l.a.MobileBottomHeight,a={left:e.left,width:Math.floor(e.overviewWidth)},n={height:i,lineHeight:i+"px"};return E.a.createElement("div",{className:"mobileOverview flexbox flexvert",style:a},E.a.createElement("div",{className:"mobileOverviewSearchBar flexbox"},E.a.createElement(gs,{pane:t}),E.a.createElement(dr.default,{pane:t})),E.a.createElement(ur,{pane:t,className:"f1"}),E.a.createElement("div",{className:"mobileOverviewBottom flexbox",style:n},E.a.createElement(F.a,{icon:"icon-folder",color:"#777",iconSize:20,width:i,height:i,onClick:this.onTapFiles}),E.a.createElement("div",{className:"mobileDocumentName f1",onClick:this.onTapFiles},e.documentName),E.a.createElement(F.a,{icon:"icon-settings",color:"#777",iconSize:24,width:i,height:i,onClick:this.onTapSettings})))}}),fr=i(63),pr=os.a.createClass({displayName:"ReactMessagePreview",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this._initializedFrame=!1,this.createObservables({hovered:!1})},componentDidMount:function(){this.props.isLastMessage&&this.props.index>0&&(this.needsScrollIntoView=!0),this.checkIsHovered(),this._initializeFrame()},_initializeFrame:function(){if(!this._initializedFrame&&this.refs.frame){this._initializedFrame=!0;var e=this.refs.frame.contentWindow.document;p.a.supportBlobURLIFrame||(e.open(),e.write(this.props.message.blob),e.close())}},getState:function(){var e=this.props.message;return{responseMode:e.responseMode,height:e.height,width:e.width}},onAfterChanged:function(e,t){this._initializeFrame(),e.height!==t.height&&e.height>0&&(this.checkIsHovered(),this.needsScrollIntoView&&(this.needsScrollIntoView=!1,this.scrollIntoView()))},checkIsHovered:function(){},scrollIntoView:function(){var e=this.refs.message,t=r.default.findParent(e,"fancyScroller"),i=0;i=e.clientHeight>t.clientHeight?e.offsetTop:t.scrollHeight-t.clientHeight,r.default.scrollTo(0,i,ScrollDuration.Snap,t)},onClickHeader:function(){this.props.toggleExpanded()},onMouseEnterMessage:function(){this.hovered.set(!0)},onMouseLeaveMessage:function(){this.hovered.set(!1)},onClickReply:function(e){ut.a.setMessageResponseMode(this.props.message.id,l.a.EmailResponseMode.Reply),e.stopPropagation()},onClickReplyAll:function(e){ut.a.setMessageResponseMode(this.props.message.id,l.a.EmailResponseMode.ReplyAll),e.stopPropagation()},onClickForward:function(e){ut.a.setMessageResponseMode(this.props.message.id,l.a.EmailResponseMode.Forward),e.stopPropagation()},onClickReport:function(){r.default.menus.openModalNew(Modals.ReportProblem,{accountID:this.props.threadAttach.getField("accountID"),threadID:this.props.threadAttach.id,msgID:this.props.message.id})},_generateParticipantText:function(e){return e.text?e.text:e.email},isExpanded:function(){return this.props.expanded||this.props.isLastMessage||this.state.responseMode!==l.a.EmailResponseMode.None},openEmailDetails:function(e){var t=this.refs.messageHeaderText;r.default.menus.openContextMenu({componentName:"ReactContextMenuEmailDetails",element:t,message:this.props.message,accountID:this.props.threadAttach.getField("accountID")}),e.stopPropagation()},render:function(){var e,t=this.props,i=this.state,a=t.message,n=this.isExpanded(),s={height:i.height},o=H.a.formatDate(a.date,DFormat.MonthDay),d=H.a.formatDate(a.date,DFormat.ShortTime),u=n,c=p.a.windowWidth()>1080&&!1,h={},f={};if(c&&(h.opacity=i.hovered?"1":"0"),p.a.ios){var g=Math.max(l.a.MinEmailScale,(p.a.windowWidth()-32)/i.width);g<1&&(s[p.a.transform.react]="scale("+g+")",f.height=i.height*g,f.overflow="hidden")}var m,v,_={cursor:n?"pointer":null};if(m=E.a.createElement("span",{className:"from",onClick:void 0,style:_},this._generateParticipantText(a.from)),n){var y=(a.to?a.to:[]).concat(a.cc?a.cc:[]).map(this._generateParticipantText).join(", ");v=E.a.createElement("span",{className:"to c-foreground-faded",onClick:void 0,style:{cursor:"pointer"}},"To ",!1,E.a.createElement("span",null,y))}else v=E.a.createElement("span",{className:"snippet",dangerouslySetInnerHTML:{__html:a.snippet}});var S,w=E.a.createElement("span",{className:"emailDate c-foreground-faded"},E.a.createElement("div",{className:"emailDateDate"},o),E.a.createElement("div",{className:"emailDateTime"},d));e=E.a.createElement(cs.a,{className:"messageHeader flexbox",onClick:this.onClickHeader},E.a.createElement("span",{className:"messageHeaderText f1",ref:"messageHeaderText"},m,v,n&&w),u&&E.a.createElement("span",{className:"headerButtons",style:{}},c&&E.a.createElement(F.a,{height:40,className:"reportEmail",style:h,onClick:this.onClickReport},"Report Problem"),E.a.createElement(F.a,{iconSize:22,width:50,height:50,icon:"icon-reply",tooltip:"Reply",onClick:this.onClickReply}),E.a.createElement(F.a,{iconSize:22,width:50,height:50,icon:"icon-reply-all",tooltip:"Reply All",onClick:this.onClickReplyAll}),E.a.createElement(F.a,{iconSize:22,width:50,height:50,icon:"icon-forward",tooltip:"Forward",onClick:this.onClickForward})),!1),S=p.a.supportBlobURLIFrame?E.a.createElement("iframe",{key:"ep_"+this.props.message.id,ref:"frame",sandbox:"allow-scripts allow-same-origin",seamless:!0,id:"emailPreview_"+this.props.message.id,className:"emailPreviewFrame",src:a.blobURL,style:s,scrolling:"no"}):E.a.createElement("iframe",{key:"ep_"+this.props.message.id,ref:"frame",sandbox:"allow-scripts allow-same-origin",seamless:!0,id:"emailPreview_"+this.props.message.id,className:"emailPreviewFrame",style:s,scrolling:p.a.ios?"no":void 0});var I=r.default.classNames("emailMessage emailBox c-border",{collapsed:!n},{prevCollapsed:!t.prevExpanded},{nextCollapsed:!t.nextExpanded}),b=r.default.classNames("emailMessageWrapper",{replying:i.responseMode!==l.a.EmailResponseMode.None});return E.a.createElement("div",{className:b,onMouseEnter:this.onMouseEnterMessage,onMouseLeave:this.onMouseLeaveMessage,ref:"message"},E.a.createElement("div",{className:I},e,n&&E.a.createElement("div",{className:"messageContent",style:f},S,E.a.createElement(fr.a,{threadAttach:t.threadAttach,message:t.message,editable:!1}))),!1)}}),gr=(os.a.createClass({displayName:"ReactEmailReplyBox",componentDisplay:l.a.ComponentDisplay.Everywhere,componentDidUpdate:function(){this._updateFocus()},componentDidMount:function(){this.refs.message&&(this.scrollIntoView(),this._updateFocus())},getState:function(){var e=this.props.inReplyToMessage;return{responseMode:e.responseMode,replytoMessageHeight:e.height}},onAfterChanged:function(e,t){e.replytoMessageHeight!==t.replytoMessageHeight&&this.scrollIntoView()},scrollIntoView:function(){var e=this.refs.message;if(e){var t=r.default.findParent(e,"fancyScroller"),i=e.offsetTop+e.offsetHeight-t.clientHeight+16;r.default.scrollTo(0,i,ScrollDuration.Default,t)}},_updateFocus:function(){var e=this.state.responseMode;switch(e){case l.a.EmailResponseMode.None:break;case l.a.EmailResponseMode.Reply:case l.a.EmailResponseMode.ReplyAll:case l.a.EmailResponseMode.Other:this.focusBody();break;case l.a.EmailResponseMode.Forward:this.focusTo();break;default:r.default.Assert(!1,"Unknown response mode for reply box",e)}},focusTo:function(){this.refs.compose.focusTo()},focusBody:function(){this.refs.compose.focusBody()},onClose:function(){ut.a.setMessageResponseMode(this.props.inReplyToMessage.id,l.a.EmailResponseMode.None)},render:function(){return this.state.responseMode!==l.a.EmailResponseMode.None?E.a.createElement("div",{className:"emailReplyBox emailBox c-shadow-popup",ref:"message"},E.a.createElement(ir.a,{threadAttach:this.props.threadAttach,message:this.props.message,ref:"compose",onClose:this.onClose,responseMode:this.state.responseMode,closeOnEscape:!0})):null}}),function(e){var t={},i=e.size||20,a=e.size||20,n={fontSize:i,height:a,width:a,lineHeight:a+"px"};(e.top||e.left)&&(t.position="absolute",t.left=e.left||"50%",t.top=e.top||"50%",n.marginLeft=-i/2,n.marginTop=-i/2+20);var s=r.default.classNames("fancyLoader",{center:e.center},{inline:e.inline});return E.a.createElement("div",{className:s,style:t},E.a.createElement("div",{className:"icon-spinner",style:n}),e.children&&E.a.createElement("div",{className:"fancyLoaderText"},e.children))}),mr=i(31).default,vr=os.a.createClass({displayName:"ReactEmailPreview",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this.listenToDispatcher("windowResize"),this.createObservables({expandedMessages:[]}),r.default.isDemoMode()&&(r.default.reactEmailPreview=this)},onBeforeChanged:function(e,t){if(e.thread!==t.thread){var i=e.messages,a=[];if(i.length>0)for(var n=0,s=this.getLastMessage(e),r=0;r<i.length;r++){if(n++>5e3&&__infLoop&&__infLoop(n))throw new RangeError;var o=i[r];(o===s||this.isMessageUnread(o))&&a.push(o.id)}this.expandedMessages.set(a,!1),e.expandedMessages=a}},getState:function(){return{rect:this.props.pane.rect,pane:ut.a.openOnPane,isLoading:ut.a.isLoading,thread:ut.a.threadAttach,threadItem:ut.a.threadItem,messages:ut.a.messages,errorMessage:ut.a.errorMessage,messagesLoaded:ut.a.messagesLoaded,bottomBarHeight:mr.bottomBarHeight}},getLastMessage:function(e){var t=(e=e||this.state).messages,i=e.thread,a=t.length-1;return this.isMessageDraft(t[a])&&!i.getPlugin().getAttachField(i,"pendingSend")&&a--,t[a]},onEscapeKey:function(){ut.a.close()},isMessageDraft:function(e){return e.labelIds.indexOf("DRAFT")>=0},isMessageUnread:function(e){return e.labelIds.indexOf("UNREAD")>=0},onClickClose:function(){ut.a.close()},onClickArchive:function(){this.state.pane.archiveItem(!0,this.state.threadItem)},onClickLabel:function(e){this.state.pane.autocompleteLabel({elementDisplay:e.target,item:this.state.threadItem})},onClickMove:function(e){this.state.pane.autocompleteMove({elementDisplay:e.target,item:this.state.threadItem})},onClickSchedule:function(e){this.state.pane.autocompleteSchedule({elementDisplay:e.target,item:this.state.threadItem})},onClickSnooze:function(e){var t=this.state.thread.getField("accountID");this.state.pane.autocompleteSnooze({elementDisplay:e.target,item:this.state.threadItem},t)},onClickUnread:function(){this.state.pane.markItemRead(!1,this.state.threadItem)},onClickDelete:function(){var e,t=this.state,i=t.pane,a=r.default.vmMain.getDefaultEmailPlugin();if(i.type===PaneMode.Gmail)this.state.pane.deleteSelected(a.isGmailItem,!0);else if(M.a.getStartItem()===t.threadItem&&(e=i.indexOfPrevVMLI(M.a.getStartIndex(),!0,!0)),t.threadItem.deleteSelf(ChangeType.Local),ut.a.reset(),e){var n=i.itemAtIndex(e);if(n){var s=n.getParsedText().length;M.a.selectIndex(e,s)}}},onClickPrint:function(){var e=r.default.vmMain.getDefaultEmailPlugin().createPrintURLForThread(this.state.thread);r.default.printPage(e)},onClickViewInGmail:function(){var e=r.default.vmMain.getDefaultEmailPlugin().createURLForThread(this.state.thread);r.default.openUrl(e)},onClickReply:function(e){var t=this.getLastMessage();ut.a.setMessageResponseMode(t.id,l.a.EmailResponseMode.Reply)},onClickReplyAll:function(e){var t=this.getLastMessage();ut.a.setMessageResponseMode(t.id,l.a.EmailResponseMode.ReplyAll)},onClickForward:function(e){var t=this.getLastMessage();ut.a.setMessageResponseMode(t.id,l.a.EmailResponseMode.Forward)},toggleExpanded:function(e){var t=this.state.messages,i=t[e];this.expandedMessages.indexOf(i.id)>=0?!(t.length>1&&e<t.length-1)||t[e+1]&&this.isMessageDraft(t[e+1])||this.expandedMessages.remove(i.id):this.expandedMessages.push(i.id)},onClickDown:function(){this.props.pane.keyMoveDown()},onClickUp:function(){this.props.pane.keyMoveUp()},onClickMobileReply:function(){r.default.menus.openContextMenu({fn:this.renderContextMenuReply})},renderContextMenuReply:function(e){return E.a.createElement(vs.a,{key:"contextMenuGmailReply",id:"contextMenuGmailReply",className:"contextMenuMobile",element:e.element,position:"bottom"},E.a.createElement(_s.a,{icon:"icon-reply",onClick:this.onClickReply},"Reply"),E.a.createElement(_s.a,{icon:"icon-reply-all",onClick:this.onClickReplyAll},"Reply All"),E.a.createElement(_s.a,{icon:"icon-forward",onClick:this.onClickForward},"Forward"))},render:function(){var e=this.state,t=this.props.pane.type===PaneMode.Gmail,i=e.thread,a=e.messages||[],n=[];if(a.length>0){for(var s=0,o=a[0],d=(i.getPlugin().getDisplayParticipants(i),o.subject||"(no subject)"),u=[],c=this.expandedMessages.get(),h=this.getLastMessage(),f=0;f<a.length;++f){if(s++>5e3&&__infLoop&&__infLoop(s))throw new RangeError;var p,g=a[f];if(this.isMessageDraft(g)){r.default.Assert(f>0,"Should never have a draft as the first message in the list");a[f-1];p=null}else{var m=c.indexOf(g.id)>=0,v=a[f-1],_=a[f+1],y=0===f||c.indexOf(v.id)>=0||this.isMessageDraft(v),S=f>=a.length-2||c.indexOf(_.id)>=0||this.isMessageDraft(_);p=E.a.createElement(pr,{key:g.id,index:f,threadAttach:i,message:g,toggleExpanded:this.toggleExpanded.bind(this,f),expanded:m,isLastMessage:g===h,prevExpanded:y,nextExpanded:S})}u.push(p)}n=E.a.createElement("div",{className:"emailMessages c-background c-border c-foreground",style:{opacity:e.messagesLoaded?1:0}},u)}else n=e.isLoading?E.a.createElement(gr,{center:!0},"Loading messages..."):e.errorMessage?E.a.createElement("div",{className:"noMessages center"},e.errorMessage):E.a.createElement("div",{className:"noMessages center"},"No conversation selected");var w=r.default.classNames("emailPreview c-background c-border",{noClick:r.default.vmMain.paneManager.isResizingPane},{transition:!r.default.vmMain.paneManager.isResizingPane}),I={};I.left=e.rect.left;r.default.classNames("emailPreviewTop c-foreground c-background c-border-light",{hasBorder:a.length>0});return E.a.createElement("div",{className:w,style:I},E.a.createElement("div",{className:"emailPreviewTop c-border c-foreground"},E.a.createElement(F.a,{className:"closeButton",icon:"icon-angle-left",iconSize:24,width:r.default.topBarHeight,height:r.default.topBarHeight,color:"#444",onClick:this.onClickClose,tooltip:"Close"}),t&&E.a.createElement(F.a,{icon:"icon-angle-up",iconSize:24,width:r.default.topBarHeight,height:r.default.topBarHeight,onClick:this.onClickUp}),t&&E.a.createElement(F.a,{icon:"icon-angle-down",iconSize:24,width:r.default.topBarHeight,height:r.default.topBarHeight,onClick:this.onClickDown})),E.a.createElement(Ws.a,{className:"emailMessagesScroller"},E.a.createElement("div",{className:"emailHeaderMobile"},E.a.createElement("div",{className:"emailSubject bold"},d)),n),E.a.createElement("div",{className:"emailPreviewBottom flexbox",style:{height:l.a.MobileBottomHeight}},E.a.createElement(F.a,{icon:"icon-tag",iconSize:19,width:36,height:l.a.MobileBottomHeight,onClick:this.onClickLabel}),E.a.createElement(F.a,{icon:"icon-align-left",iconSize:19,width:36,height:l.a.MobileBottomHeight,onClick:this.onClickMove}),E.a.createElement(F.a,{icon:"icon-access_time",iconSize:21,width:36,height:l.a.MobileBottomHeight,onClick:this.onClickSnooze}),E.a.createElement(F.a,{icon:"icon-check",iconSize:24,width:36,height:l.a.MobileBottomHeight,onClick:this.onClickArchive}),E.a.createElement(F.a,{icon:"icon-delete",iconSize:24,width:36,height:l.a.MobileBottomHeight,onClick:this.onClickDelete})),E.a.createElement(F.a,{className:"mobileAddButton emailReply",icon:"icon-reply",iconSize:24,width:50,height:50,style:{bottom:e.bottomBarHeight+24},onClick:this.onClickMobileReply}))}}),_r=os.a.createClass({displayName:"ReactToasts",componentDisplay:l.a.ComponentDisplay.Everywhere,getState:function(){return{toasts:as.queue}},render:function(){for(var e=0,t=this.state,i=[],a=0;a<t.toasts.length;a++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var n=t.toasts[a];r.default.classNames("toast noSelect",{hasAction:!!n.actionText},{big:n.isBig});i.push(E.a.createElement(Ys,{key:n.id,toast:n}))}return E.a.createElement(rs.CSSTransitionGroup,{id:"toasts",transitionName:"reactFade",transitionEnterTimeout:800,transitionLeaveTimeout:100},i)}}),yr=os.a.createClass({displayName:"ReactMobileKeyboardToolbar",componentDisplay:l.a.ComponentDisplay.Mobile,init:function(){this.createObservables({isPriorityVisible:!1})},getState:function(){var e=L;return{panes:r.default.vmMain.paneManager.displayPanes,position:e.bottomPosition,mode:e.mode,pane:r.default.focusedPane}},componentDidMount:function(){this.refs.toolbarButtons&&(this.refs.toolbarButtons.scrollLeft=L.getScroll())},onUnmount:function(){this.refs.toolbarButtons&&L.setScroll(this.refs.toolbarButtons.scrollLeft)},openAutocomplete:function(e){M.a.isValid()&&oe.a.startMobileAutocomplete({owner:M.a.getStartItem(),pane:M.a.getPane(),index:M.a.getStartIndex(),start:M.a.getStartOffset(),element:M.a.getStartElement(),mode:e})},insertCharacter:function(e,t){r.default.menus.isContextMenuOpen()||M.a.isValid()&&M.a.insertTextAtCaret(e,t)},onClickOutdent:function(){r.default.menus.isContextMenuOpen()||M.a.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!0})},onClickIndent:function(){r.default.menus.isContextMenuOpen()||M.a.fireKeyEvent(void 0,{normCode:KeyCode.Tab,shiftKey:!1})},onClickOpenPriority:function(){this.state.mode===l.a.KeyboardToolbarMode.Search?r.default.getActiveSearch().addToValue("!"):this.isPriorityVisible.set(!this.isPriorityVisible.get())},onClickNote:function(){if(M.a.isValid()){var e=M.a.getStartItem();p.a.ios&&r.default.menus.isContextMenuOpen()&&r.default.focusedPane.closeNoteContextMenu(),e&&(y.a.beginAction(),(e.hasNote()||e.isNote())&&r.default.menus.isContextMenuOpen()&&r.default.menus.closeContextMenu(),e.editNote(),y.a.endAction())}},onClickDate:function(){this.state.mode===l.a.KeyboardToolbarMode.Search?r.default.getActiveSearch().addToValue(l.a.DatePrefix):(this.openAutocomplete("date"),y.a.miscAction({type:TrackerType.Mobile,misc:TrackerMiscMobile.AtButton}))},onClickContact:function(){this.state.mode===l.a.KeyboardToolbarMode.Search?r.default.getActiveSearch().addToValue(l.a.ContactPrefix):this.openAutocomplete("contact")},onClickTag:function(){this.state.mode===l.a.KeyboardToolbarMode.Search?r.default.getActiveSearch().addToValue(l.a.TagPrefix):this.openAutocomplete("tag")},onClickPrefix:function(e){if(!r.default.menus.isContextMenuOpen()&&M.a.isValid()){var t=M.a.getStartItem();e=t.prefix===e?null:e,t.setPrefix(e)}},onClickClose:function(){M.a.closeKeyboard()},onClickMove:function(){this.state.pane.autocompleteMove({position:"autocomplete"})},onClickClosePriority:function(){this.isPriorityVisible.set(!1)},onClickP0:function(){this.state.pane.applyPriorityToSelection(VMLIFlag.P0,!0)},onClickP1:function(){this.state.pane.applyPriorityToSelection(VMLIFlag.P1,!0)},onClickP2:function(){this.state.pane.applyPriorityToSelection(VMLIFlag.P2,!0)},onClickStar:function(){r.default.vmMain.applyFnToSelection("isStarred",{toggle:!0,value2:ChangeType.Local})},openMobileFilterMenu:function(){r.default.menus.openContextMenu({componentName:"ReactContextMenuMobileFilter",position:"top-right",pane:r.default.focusedPane})},render:function(){var e=this.state,t=e.mode,i=l.a.KeyboardToolbarMode,a=this.state.pane,n=l.a.KeyboardToolbarHeight,s={bottom:e.position},o=p.a.windowWidth()-n,d=Math.floor(o/n),u=o-d*n,c=d<12?n-Math.round((n/2-u)/d):n,h=t!==i.Modal?E.a.createElement("div",{id:"mobileToolbarButtons",className:"flexbox"},E.a.createElement("div",{className:"f1"}),E.a.createElement("div",{className:"toolbarButtonsLeft",ref:"toolbarButtons"},t===i.Item&&a.type===PaneMode.Task&&a.isViewOutline()&&E.a.createElement(F.a,{icon:"icon-format_indent_decrease",width:c,height:n,iconSize:18,onClick:this.onClickOutdent}),t===i.Item&&a.type===PaneMode.Task&&a.isViewOutline()&&E.a.createElement(F.a,{icon:"icon-format_indent_increase",width:c,height:n,iconSize:18,onClick:this.onClickIndent}),t!==i.Search&&E.a.createElement(F.a,{id:"keyboardButtonHeader",icon:"icon-project",width:c,height:n,iconSize:20,onClick:this.onClickPrefix.bind(this,l.a.Prefix.Header)}),t!==i.Search&&E.a.createElement(F.a,{icon:"prefixTask",width:c,height:n,iconSize:24,onClick:this.onClickPrefix.bind(this,l.a.Prefix.Task)}),t!==i.Search&&E.a.createElement(F.a,{icon:"icon-bullet",width:c,height:n,iconSize:30,onClick:this.onClickPrefix.bind(this,l.a.Prefix.Bullet)}),t!==i.Search&&E.a.createElement(F.a,{icon:"icon-numlist",width:c,height:n,iconSize:16,onClick:this.onClickPrefix.bind(this,l.a.Prefix.NumList)}),t!==i.Search&&E.a.createElement(F.a,{icon:"icon-align-left",color:r.default.colorBlue,width:c,height:n,iconSize:18,onClick:this.onClickMove}),t!==i.Search&&E.a.createElement(F.a,{icon:"icon-sticky-note-o",width:c,height:n,iconSize:18,onClick:this.onClickNote}),E.a.createElement(F.a,{icon:"icon-calendar",color:un.a.dateColor(),width:c,height:n,iconSize:20,onClick:this.onClickDate}),E.a.createElement(F.a,{icon:"icon-user",color:un.a.contactColor(),width:c,height:n,iconSize:24,onClick:this.onClickContact}),E.a.createElement(F.a,{className:"tagIcon",color:un.a.tagColor(),width:c,height:n,fontSize:22,onClick:this.onClickTag},"#"),t!==i.Search&&E.a.createElement(F.a,{className:"exclamationIcon",width:c,height:n,fontSize:22,onClick:this.onClickOpenPriority},"!")),E.a.createElement("div",{className:"toolbarButtonsRight"},E.a.createElement("div",{className:"keyboardButtonSkew"}),(p.a.iphone||p.a.android)&&E.a.createElement(F.a,{id:"closeKeyboardButton",icon:"icon-angle-down",width:n,height:n,iconSize:24,onClick:this.onClickClose}))):E.a.createElement("div",{id:"mobileToolbarButtons",className:"flexbox"},E.a.createElement("div",{className:"f1"}),E.a.createElement(F.a,{icon:"icon-angle-down",width:n,height:n,iconSize:26,onClick:this.onClickClose}));return!(t===i.Modal&&p.a.ipad)&&E.a.createElement("div",{id:"mobileKeyboardToolbar",style:s},e.isPriorityVisible&&E.a.createElement("div",{id:"priorityMenu"},E.a.createElement(F.a,{className:"priorityButton",width:n,height:n,onClick:this.onClickP2},E.a.createElement("div",{className:"p2Button"})),E.a.createElement(F.a,{className:"priorityButton",width:n,height:n,onClick:this.onClickP1},E.a.createElement("div",{className:"p1Button"})),E.a.createElement(F.a,{className:"priorityButton",width:n,height:n,onClick:this.onClickP0},E.a.createElement("div",{className:"p0Button"})),E.a.createElement(F.a,{icon:"icon-star",width:n,height:n,iconSize:22,onClick:this.onClickStar}),E.a.createElement(F.a,{icon:"icon-angle-down",width:n,height:n,iconSize:24,onClick:this.onClickClosePriority})),h)}}),Sr=os.a.createClass({displayName:"ReactMobileMultiselect",componentDisplay:l.a.ComponentDisplay.Mobile,init:function(){this.createObservables({inc:0})},getState:function(){var e=us.default;return{offset:e.multiselectOffset,isAnimating:e.multiselectAnimate,isOpen:e.isInMultiselect(),numSelected:ct.a.numSelected}},applyFn:function(e,t,i){var a=this.props.pane;"gmailDelete"===t?a.deleteSelected(a.plugin.isGmailItem,!0):"gmailUndelete"===t?a.deleteSelected(a.plugin.isGmailItem,!1):"gmailArchive"===t?a.archiveSelected(!0):"gmailUnarchive"===t?a.archiveSelected(!1):"markRead"===t?a.markReadSelected(!0):"markUnread"===t?a.markReadSelected(!1):"gmailStar"===t?a.toggleStarSelected():"move"===t?a.autocompleteMove({position:"autocomplete"},ct.a.reset):"snooze"===t?a.autocompleteSnooze({position:"autocomplete"}):"label"===t?a.autocompleteLabel({position:"autocomplete"}):(r.default.vmMain.beginUpdateItems(),y.a.beginAction(),ct.a.applyFnToSelected(function(e){e.isNote()||(void 0!==i?e[t](i,ChangeType.Local):e[t](ChangeType.Local))},this.props.pane),y.a.endAction(),r.default.vmMain.commitUpdateItems(),"deleteSelf"===t&&ct.a.reset())},checkComplete:function(e){return!e.isComplete()},checkStarred:function(e){return!e.isStarred()},checkP0:function(e){return e.priority()===VMLIFlag.P0?VMLIFlag.None:VMLIFlag.P0},checkP1:function(e){return e.priority()===VMLIFlag.P1?VMLIFlag.None:VMLIFlag.P1},checkP2:function(e){return e.priority()===VMLIFlag.P2?VMLIFlag.None:VMLIFlag.P2},onClick:function(e,t){var i=this.props.pane;if(ct.a.getSelected(i).length>0){var a,n=ct.a.getFirstSelectedItem(i);if(n)e&&this[e]&&(a=this[e](n)),this.applyFn(n,t,a),this.inc.set(this.inc.get()+1)}},renderButton:function(e,t,i,a,n){return E.a.createElement("div",{key:t,className:"f1 multiselectButton flexbox"},E.a.createElement(F.a,{icon:t,width:l.a.RightMenuWidth,enabled:this.state.numSelected>0&&!1!==n,iconSize:24,onClick:this.onClick.bind(this,a,i)},e))},renderPriorityButton:function(){var e=r.default.classNames("f1 priorityButtons flexbox flexvert",{disabled:this.state.numSelected<1});return E.a.createElement("div",{key:"priority",className:e,style:{justifyContent:"center"}},E.a.createElement("div",null,E.a.createElement(F.a,{icon:"priorityButton p0Button",width:30,height:30,iconSize:24,onClick:this.onClick.bind(this,"checkP0","priority")}),E.a.createElement(F.a,{icon:"priorityButton p1Button",width:30,height:30,iconSize:24,onClick:this.onClick.bind(this,"checkP1","priority")}),E.a.createElement(F.a,{icon:"priorityButton p2Button",width:30,height:30,iconSize:24,onClick:this.onClick.bind(this,"checkP2","priority")})),E.a.createElement("div",{className:"fancyButtonText"},"Priority"))},render:function(){var e,t=this.state,i=this.props.pane,a=t.numSelected,n=r.default.classNames("flexbox flexvert",{open:t.isOpen}),s={top:r.default.topBarHeight,bottom:this.props.bottom},o=[];if(t.isAnimating||(s[p.a.transform.react]="translate3d("+(t.offset+100)+"px,0,0)"),a&&(e=ct.a.getFirstSelectedItem(i)),i.type===PaneMode.Gmail){var l=i.plugin,d=e&&l.isItemUnread(e),u=e&&l.isItemStarred(e),c=e&&l.isItemArchived(e),h=e&&l.isItemFullTrashed(e),f=e&&e.getAttachmentByPlugin(l.id),g=e&&f&&j.a.isLinkedAccountAuthorized(f.getField("accountID"),GScope.GmailModify);o=[this.renderButton(c?"Unarchive":"Archive","icon-check",c?"gmailUnarchive":"gmailArchive"),this.renderButton("Mark "+(d?"Read":"Unread"),"icon-unread",d?"markRead":"markUnread"),this.renderButton(u?"Unstar":"Star","icon-star","gmailStar"),this.renderPriorityButton(),this.renderButton("Label","icon-tag","label"),this.renderButton("Move","icon-align-left","move"),this.renderButton("Snooze","icon-access_time","snooze",null,g),this.renderButton(h?"Undelete":"Delete","icon-delete",h?"gmailUndelete":"gmailDelete")]}else{var m=e&&e.isComplete();u=e&&e.isStarred();o=[this.renderButton(m?"Uncomplete":"Complete","icon-check","isComplete","checkComplete"),this.renderButton(u?"Unstar":"Star","icon-star","isStarred","checkStarred"),this.renderPriorityButton(),this.renderButton("Move","icon-align-left","move"),this.renderButton("Delete","icon-delete","deleteSelf")]}return E.a.createElement(rs.CSSTransitionGroup,{id:"mobileUIMultiselectWrapper",transitionName:"reactAnimMultiselect",transitionEnterTimeout:150,transitionLeaveTimeout:150},t.isOpen&&E.a.createElement("div",{id:"mobileUIMultiselect",className:n,style:s},o))}}),wr=os.a.createClass({displayName:"ReactMobileUI",componentDisplay:l.a.ComponentDisplay.Mobile,init:function(){this.DISABLE_LISTENER_ASSERT=!0,this.listenToDispatcher(r.default.vmMain.pluginManager,"pluginActiveChanged");var e=r.default.vmMain.pluginManager.getPlugin(PluginID.Gmail);e.onSettingChanged(e.Settings.IsEnabled,this.updateState)},getState:function(){var e=r.default.vmMain,t=M.a.pane.get(),i={pane:M.a.pane,paneExpanded:t.isExpanded,hasPremiumFeatures:r.default.billingManager.hasPremiumFeaturesObservable,gdriveStatus:e.gdriveStatusObs,canAddItem:t.canAddItem,multiselectOffset:us.default.multiselectOffset,isGmailPaneEnabled:r.default.vmMain.pluginManager.isGmailPaneEnabled(),isDragging:We.default.isVisible,bottomBarHeight:us.default.bottomBarHeight};return i.showAddButton=t.canAddItem&&!us.default.isInMultiselect()&&!We.default.isVisible.get()&&!r.default.menus.isContextMenuOpen()&&!t.isExpanded.get(),i.onlineText=e.onlineText(),i},switchPane:function(e,t){var i=this.state.pane;i.type===e&&i.getViewMode()===t||(r.default.vmMain.switchPaneMobile(e,t),r.default.menus.closeContextMenu(),us.default.setMultiselectVisibility(!1)),this.refreshListeners()},onClickAdd:function(e){this.state.pane.onTapAddItem(e)},renderButton:function(e,t,i,a,n){var s=this.state.pane;return E.a.createElement(F.a,{className:"f1",icon:a,primary:s.type===e&&(e!==PaneMode.Task||s.getViewMode()===t),iconSize:n,width:l.a.MobileBottomHeight,height:l.a.MobileBottomHeight,ripple:!1,onClick:this.switchPane.bind(this,e,t)},i)},render:function(){var e=this.state,t=this.state.pane,i=e.bottomBarHeight,a={bottom:i+24},n=r.default.classNames("mobileAddButton",{outline:t.type===PaneMode.Task},{email:t.type===PaneMode.Gmail}),s={height:i,display:e.paneExpanded?"none":void 0};return E.a.createElement("div",{id:"mobileUI"},E.a.createElement(Sr,{pane:t,bottom:i}),E.a.createElement("div",{id:"mobileUIBottom",className:"mobileUIBottom",style:s},e.onlineText&&E.a.createElement("div",{className:"mobileOnlineStatus"},e.onlineText),E.a.createElement("div",{id:"mobileBottomBar",className:"flexbox"},e.isGmailPaneEnabled&&this.renderButton(PaneMode.Gmail,void 0,"Gmail","icon-mail_outline",18),this.renderButton(PaneMode.Task,l.a.TaskViewMode.Outline,"Tasks","icon-align-left",19),this.renderButton(PaneMode.Task,l.a.TaskViewMode.Agenda_All,"Agenda","icon-calendar",20))),e.showAddButton&&E.a.createElement(F.a,{icon:"icon-add",className:n,width:50,height:50,color:"white",iconSize:24,style:a,onClick:this.onClickAdd}))}}),Ir=os.a.createClass({displayName:"ReactTrashError",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this.createObservables({failedRestoring:!1,isRestoring:!1,isRedirecting:!1})},getState:function(){return{filesTrashed:r.default.vmMain.docManager._docListTrashed}},getTrashUrl:function(){r.default.vmMain.getUserEmail();return"https://drive.google.com/drive/"},reload:function(){r.default.reload()},onClickRestore:function(){var e=0,t=this.state,i=t.filesTrashed.length,a=0,n=function(){++a===i&&(this.isRestoring.set(!1),this.isRedirecting.set(!0),setTimeout(this.reload,1e3))}.bind(this),s=function(e){r.default.reportError(new Error("Failed to untrash doc: "+e.error.code),e),this.isRestoring.set(!1),this.failedRestoring.set(!0)}.bind(this);this.isRestoring.set(!0);for(var o=0;o<i;o++){if(e++>5e3&&__infLoop&&__infLoop(e))throw new RangeError;var l=t.filesTrashed[o];r.default.vmMain.remoteAPI().driveFilesUntrash(l.id,n,s)}},onClickNew:function(){f.default.createDefaultRealtimeFile(),r.default.vmMain.clearTrashedDocumentError()},render:function(){var e=this.state,t=e.filesTrashed.length;return e.isRedirecting?E.a.createElement(gr,{center:!0},"Loading Moo.do..."):e.isRestoring?E.a.createElement(gr,{center:!0},"Restoring files..."):e.failedRestoring?E.a.createElement("div",{className:"centerVH trashedFiles"},E.a.createElement("div",null,"There was an error restoring your files. Please manually restore them from your Trash, which you can access ",E.a.createElement("a",{href:this.getTrashUrl(),target:"_blank"},"here"),", then click Retry."),E.a.createElement(F.a,{marginTop:32,raised:!0,primary:!0,onClick:this.reload},"Retry")):E.a.createElement("div",{className:"centerVH trashedFiles c-foreground",style:{textAlign:"left"}},E.a.createElement("div",{style:{textAlign:"left"}},1===t?"It looks like your document is in the Trash in Google Drive. Would you like to restore it or create a new document?":"It looks like your documents are in the Trash in Google Drive. Would you like to restore them or create a new document?"),E.a.createElement("div",{style:{marginTop:32,textAlign:"center"}},E.a.createElement(F.a,{raised:!0,primary:!0,onClick:this.onClickRestore},"Restore Document"+(t>1?"s":"")),E.a.createElement(F.a,{raised:!0,marginLeft:32,onClick:this.onClickNew},"New Document")),t>1&&E.a.createElement("div",null,E.a.createElement("div",{style:{margin:"32px 0 8px 8px"}},"Documents in the Trash:"),E.a.createElement(Ws.a,{className:"trashedFilesList c-background c-border-heavy",style:{maxHeight:300}},E.a.createElement("ul",null,e.filesTrashed.map(function(e,t){return E.a.createElement("li",{key:t,className:"c-border"},e.getTitle())}))),E.a.createElement("div",{style:{marginTop:32}},"If you'd prefer to restore the files from your Trash manually, you can access your Trash ",E.a.createElement("a",{href:this.getTrashUrl(),target:"_blank"},"here"),". Then reload the ",p.a.app?"app":"page",".")))}}),br=os.a.createClass({displayName:"ReactTooltip",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this.listenToDispatcher("windowResize")},getState:function(){var e=this.updatePosition();return{left:e.left,top:e.top}},componentDidMount:function(){0},updatePosition:function(){var e,t=this.props.tip,i=document.documentElement.getBoundingClientRect(),a=this.refs.element;if(t.element?e=t.element.getBoundingClientRect():r.default.Assert(!1,"Adjust bounds had no valid tip for determining an offset",t),e){if(a){var n,s,o=r.default.width(a),l=r.default.height(a),d=e.left+e.width/2-o/2,u=t&&t.offset;return t&&(t.onRight||r.default.findParentID(t.element,"desktopMenu",8))&&(s=!0,u={left:8+ya.a.getSidebarWidth()+((u?u.left:0)||0)}),n=s?e.top+(e.height-l)/2:t&&t.above||e.bottom+l>i.bottom?e.top-l:e.bottom,u?(u.x?d+=u.x:u.right?d=i.right-o-u.right:u.left&&(d=u.left),u.y?n+=u.y:u.top&&(n+=u.top)):t&&t.above?n-=5:n+=5,d+o>i.right?d=i.right-o-4:d<0&&(d=4),n<0&&(n=4),{left:d=Math.round(d),top:n=Math.round(n)}}return{left:e.left,top:e.top}}},onClick:function(){r.default.tooltip.hideSticky(this.props.tip.text)},render:function(){var e=this.state,t=this.props.tip,i=t.text+(t.hotkey?'<div class="tooltipHotkey">'+t.hotkey+"</div>":""),a=r.default.classNames("tooltip flexbox flexvert",{blue:t.blue},{sticky:t.sticky},{hasHotkey:t.hotkey},{noFormat:i.indexOf("<b>")<0},{arrowDirection:t.arrowDirection}),n=r.default.classNames("tooltipArrow c-tooltip c-shadow-popup",t.arrowClass),s={maxWidth:t.maxWidth};return s[p.a.transform.react]="translate3d("+e.left+"px,"+e.top+"px,0)",E.a.createElement("div",{className:a,style:s,onClick:this.onClick,ref:"element"},E.a.createElement("div",{className:n}),E.a.createElement("div",{className:"tooltipText c-tooltip c-shadow-popup",dangerouslySetInnerHTML:{__html:i}}))}}),Ar=os.a.createClass({displayName:"ReactTooltips",componentDisplay:l.a.ComponentDisplay.Everywhere,getState:function(){return{tooltip:r.default.tooltip.tooltip,tooltipsSticky:r.default.tooltip.tooltipsSticky}},render:function(){var e=this.state,t=e.tooltip?e.tooltipsSticky.concat(e.tooltip):e.tooltipsSticky;return t.length>0?E.a.createElement("div",{className:"tooltips"},t.map(function(e){return E.a.createElement(br,{key:e.text,tip:e})})):null}}),Dr=os.a.createClass({displayName:"ReactSetup",componentDisplay:l.a.ComponentDisplay.Everywhere,init:function(){this.useFirebaseLogin=!1},getState:function(){var e=r.default.vmSetup;return{loginState:e.loginState,loginStatus:e.loginStatus,popupClosedError:e.popupClosedError,shouldShowLogin:e.shouldShowLogin(),gapiFailedToLoad:e.gapiFailedToLoad,loggedOutByAuthFailure:e.loggedOutByAuthFailure}},onClickLogin:function(){this.useFirebaseLogin?c.a.signIn():r.default.vmSetup.onTapLogin()},onClickLanding:function(e){r.default.openUrl("https://www.moo.do",e)},onClickDownloadApp:function(){r.default.openUrl(p.a.getAppDownloadURL())},onClickPrivacy:function(e){r.default.openUrl("https://www.moo.do/privacy/",e)},render:function(){var e=this.state,t=r.default.vmSetup;r.default.classNames("signInText",{errorConnecting:e.gapiFailedToLoad&&e.loggedOutByAuthFailure});return E.a.createElement("div",{id:"setupWrapper",className:"flexbox flexvert"},E.a.createElement("div",{id:"setupInner"},E.a.createElement("div",{id:"loginInfo"},E.a.createElement("div",{id:"setupLogo"})),E.a.createElement("div",{id:"setupBox"},E.a.createElement("div",{id:"login"},t.showLogin&&E.a.createElement("div",{id:"loginArea"},E.a.createElement("div",{className:"loginButton google",onClick:this.onClickLogin}),!p.a.ios&&E.a.createElement("div",{id:"learnButton",onClick:this.onClickLanding},"Learn more at ",E.a.createElement("b",{className:"link"},"https://moo.do"))),e.popupClosedError&&E.a.createElement("div",{className:"popupClosedError red"},"Error signing in. Please try again."),e.loggedOutByAuthFailure&&E.a.createElement("div",{className:"popupClosedError"},"Logged out due to an error connecting to Google. If you are using a privacy plugin such as Ghostery or Privacy Badger, please disable them or download the app below."),t.showLogin&&t.showDownload&&E.a.createElement("div",{className:"textInLine"},E.a.createElement("div",null,"or")),t.showDownload&&E.a.createElement("div",{id:"setupDownloadArea"},E.a.createElement("div",{className:"loginButton black",onClick:this.onClickDownloadApp},E.a.createElement("span",{className:p.a.getPlatformIcon()}),E.a.createElement("span",{className:"signInText"},t.downloadText))))),E.a.createElement("div",{className:"whyGoogle",onClick:this.onClickPrivacy},"Moo.do uses Google Drive to store and synchronize your data. Moo.do only has access to files it creates and never sends your data to any other server. See our ",E.a.createElement("span",{className:"link"},"Privacy Policy")," for more information.")))}}),Tr=os.a.createClass({displayName:"ReactMainMobile",componentDisplay:l.a.ComponentDisplay.Mobile,init:function(){var e=this;this.createObservables({modulesLoaded:!1,disablePointerEvents:!1}),setTimeout(function(){var t=2;i.e(1).then(i.bind(null,90)).then(function(i){nr=i.default,0===--t&&e.modulesLoaded.set(!0)}),i.e(1).then(i.bind(null,89)).then(function(i){sr=i.default,0===--t&&e.modulesLoaded.set(!0)})},100);var t=p.a.blockClient();if(void 0!==t){r.default.errorPlatformInfo=t;var a,n=t.platform;n?t.update?"iOS App"===n?a="Please update your iOS app to the latest version in the App Store.":"Android App"===n?a="Please update your Android app to the latest version in the Play Store.":"Native Android"===n?a="Please update your Android device to use Moo.do. Moo.do requires at least Android 2.1.":"Internet Explorer"===n?a='Please update your Internet Explorer browser to use Moo.do. Moo.do requires at least Internet Explorer 10. See <a href="http://windows.microsoft.com/en-us/internet-explorer/download-ie">http://windows.microsoft.com/en-us/internet-explorer/download-ie</a> for more information.':"Safari"===n&&(a="Please update your "+p.a.OSName+" to use Moo.do. Moo.do requires at least iOS 6."):a="Sorry, we don't support "+n+" yet. Please let us know that you're interested in using "+n+" and we will make it a higher priority. Thanks!":!t.needsApp||r.default.isDemoMode()||p.a.isDevURL?t.version?a="Please update your app to the latest version of Moo.do.":t.cacheUpdate&&(a="There was an issue while updating the app, "+p.a.actionVerb()+" to try again.",r.default.AppCache.update()):a="Moo.do cannot be run inside the browser. Please download the Moo.do app from the "+(p.a.ios?"App":"Play")+" store.",p.a.app&&r.default.nativeBridge.sendToApp("localLoaded"),a&&(this.platformError=a)}},componentDidMount:function(){us.default.init(),this.setPanesContainer(),document.addEventListener("keydown",this.keydown),document.addEventListener("keypress",this.keypress),document.addEventListener("keyup",this.keyup),this.listenToDispatcher("panesChanged"),this.listenToSetting(Settings.showMarkdown),r.default.createCustomScroller=function(e){return new ds.a(e,{scrollbars:!0,shrinkScrollbars:"clip",bindToWrapper:!0,preventDefault:!1,scrollX:!1,scrollY:!0,deceleratopn:.005,probeType:3,useTransition:!1})}},componentDidUpdate:function(){this.setPanesContainer()},setPanesContainer:function(){var e=this.props.main;e.panesContainer||(e.panesContainer=this.refs.panes)},_isOkToSendKey:function(e){return!e.defaultPrevented&&M.a.getPane()&&!(r.default.menus.isContextMenuOpen()&&!r.default.menus.isAutocompleteOpen())&&!r.default.menus.isModalOpen()&&!this.props.main.activeInput.get()},keydown:function(e){if(this._isOkToSendKey(e)&&M.a.getPane().keydown(e),e.target===document.body&&e.normCode===KeyCode.Backspace)return e.handled=!0,e.preventDefault(),!1},keypress:function(e){this._isOkToSendKey(e)&&M.a.getPane().keypress(e)},keyup:function(e){this._isOkToSendKey(e)&&M.a.getPane().keyup(e)},onMouseDownPanes:function(e){"panes"===e.target.id&&M.a.reset()},getState:function(){var e=this.props.main,t=e.paneManager,i={panes:t.displayPanes,failedInitialDocLoad:e.failedInitialDocLoad,showTrashedDocumentError:e._isShowingTrashedDocumentError,isDragging:We.default.isVisible,isDraggingPane:We.default.isDraggingPane,isLoading:t.isLoading,isKeyboardOpen:L.isVisible,loginState:r.default.vmSetup.loginState,isLoggedIn:r.default.vmSetup.isLoggedIn(),isMainRendered:e.isRendered,showMarkdown:r.default.showMarkdown()},a=t.mobilePaneSelected;r.default.Assert(a.get(),"Mobile pane selected should be set. Is handled but should fix this.");var n=a.get()||{type:PaneMode.Task,viewMode:l.a.TaskViewMode.Outline},s=t.indexOfPaneType(n.type,n.viewMode);return i.mobilePaneSelected=a,i.mobilePaneOffset=s*p.a.windowWidth(),i},onClickErrorRefresh:function(){r.default.AppCache.runOnFinish(function(){r.default.reload(!r.default.AppCache.useServiceWorker)},!0)},onClickErrorDownload:function(){r.default.openUrl(p.a.getAppDownloadURL())},render:function(){for(var e,t=0,i=this.state,a=[],n=0;n<i.panes.length;++n){if(t++>5e3&&__infLoop&&__infLoop(t))throw new RangeError;var s=i.panes[n],o=s.type,d=s.pane;if(d.hasBeenActive)if("overview"===o)a.push(E.a.createElement(hr,{key:"overview"+d.id,pane:d})),d.isActive.get()&&(e=!0);else if("pane"===o)switch(d.type){case PaneMode.Task:a.push(E.a.createElement($s,{key:"pane"+d.id,pane:d}));break;case PaneMode.Archived:case PaneMode.Drive:a.push(E.a.createElement(Js,{key:"pane"+d.id,pane:d}));break;case PaneMode.Gmail:a.push(E.a.createElement(er,{key:"pane"+d.id,pane:d}));break;default:r.default.Assert(!1,"Invalid pane mode requested"+d.type)}else"emailPreview"===o&&a.push(E.a.createElement(vr,{key:"emailPreview"+d.id,pane:d}))}var u,c,h,f=r.default.classNames("renderedContent c-foreground",{draggingItems:!!i.isDragging||i.isDraggingPane},{draggingPane:i.isDraggingPane},{overviewOpen:e},{hideMDMarkup:!i.showMarkdown});if(i.showTrashedDocumentError)u=E.a.createElement(Ir,{key:"trashError"});else if(i.isLoggedIn){if(this.platformError)c=E.a.createElement("div",{className:"centerVHFlex",style:{width:"100%",lineHeight:1.5}},E.a.createElement("div",null,E.a.createElement("div",{dangerouslySetInnerHTML:{__html:this.platformError}}),E.a.createElement("br",null),E.a.createElement("br",null),E.a.createElement(F.a,{display:"block",onClick:this.onClickErrorRefresh},"Reload"),E.a.createElement("br",null),E.a.createElement(F.a,{display:"block",onClick:this.onClickErrorDownload},"Download app")));else if(i.isMainRendered)if(!i.isLoading||r.default.isDemoMode()||i.failedInitialDocLoad){var g={},m=r.default.classNames("panes",{transition:i.animatePaneSwap});g[p.a.transform.react]="translate("+-i.mobilePaneOffset+"px,0)",h=E.a.createElement(rs.CSSTransitionGroup,{className:m,id:"panes",ref:"panes","data-moo-id":"panes",transitionName:"reactMobilePaneAnim",transitionEnterTimeout:l.a.EmailOpenTimeMobile,transitionLeaveTimeout:l.a.EmailOpenTimeMobile,style:g},a),c=E.a.createElement("div",{id:"container",key:"renderedContent",className:f},h,this.props.main.getDefaultEmailPlugin()&&E.a.createElement(lr,null),nr&&E.a.createElement(nr,null),sr&&E.a.createElement(sr,null),E.a.createElement(tr,null),E.a.createElement(_r,null),E.a.createElement(Ar,null),i.panes.length>0&&E.a.createElement(wr,null),i.isKeyboardOpen&&E.a.createElement(yr,null))}else u=E.a.createElement("div",{key:"loadingRemote",id:"loadingRemote",className:"centerVH"},E.a.createElement("div",{className:"loading loading20"}),E.a.createElement("div",{className:"loadingText"},"Loading file"))}else c=E.a.createElement(Dr,null);return E.a.createElement(rs.CSSTransitionGroup,{transitionName:"reactFadeMain",transitionEnterTimeout:800,transitionLeaveTimeout:100},c,u)}});r.default.checkpoint(Checkpoint.RequireLoaded),r.default.vmSetup=new Ln,r.default.isDemoMode()||(c.a.init(),h.a.init()),window.__ERRORINMAINHEADER&&r.default.reportError(window.__ERRORINMAINHEADER),r.default.nativeBridge=new Yn,r.default.billingManager=new Zn,r.default.runOnLoad(function(){try{var e=function(){p.a.updateOrientation(),r.default.keyboardToolbar&&r.default.keyboardToolbar.isVisible.get()&&r.default.keyboardToolbar.updatePosition(!0),document.body.scrollTop=0,r.default.keyboardToolbar&&r.default.keyboardToolbar.hideTopBarIfLandscape()},t=function(){try{if(h||!c||!s.default.localDataLoaded())return;h=!0,r.default.checkpoint(Checkpoint.OnInitializedData),f.default.loadClientDefaultFile(),r.default.isDemoMode()||(r.default.vmMain.setupDateRollover(),window.addEventListener("focus",r.default.vmMain.ensureDateRollover)),r.default.vmMain.loadData(),ShouldLog(LogLevels.Timing)&&log("Data done loading: ",log.now())}catch(e){r.default.reportError(e)}},i=function(){c||(c=!0,r.default.checkpoint(Checkpoint.InitializeMain),r.default.openMainPage(),r.default.registerEvent("ItemCreated","ItemAction","Create"),r.default.registerEvent("ItemCompleted","ItemAction","Complete"),s.default.initData(t),t())};if(r.default.Assert(-1===navigator.userAgent.indexOf("Electron")||p.a.appPlatform===AppPlatform.Electron,"Electron app missing app platform set"),r.default.checkpoint(Checkpoint.PageLoad),r.default.Assert("loading"!==document.readyState,"Should only be calling mainjs after document is loaded"+document.readyState),"loading"===document.readyState){var a="ERROR: MainJS running before document load! "+document.readyState;ShouldLog(LogLevels.Error)&&log(a),r.default.reportError(new Error(a))}for(var n in window.scriptErrors)window.scriptErrors.hasOwnProperty(n)&&r.default.fireCustomEvent("scriptLoadError",{src:n,id:window.scriptErrors[n],firstChance:!0});if(window.scriptErrors=window.scriptErrors||{},window.handleLoadError=function(e){try{window.scriptErrors[e.target.src]=e.target.id,r.default.fireCustomEvent("scriptLoadError",{src:e.target.src,id:e.target.id,firstChance:!1})}catch(e){r.default.reportError(e)}},window.oncontextmenu=function(e){r.default.isKeyboardInputElement(e.target)||e.preventDefault()},r.default.isDemoMode()||p.a.offline);else m=window,v=document,_="script",y="ga",m.GoogleAnalyticsObject=y,m.ga=m.ga||function(){(m.ga.q=m.ga.q||[]).push(arguments)},m.ga.l=1*new Date,S=v.createElement(_),w=v.getElementsByTagName(_)[0],S.async=1,S.src="//www.google-analytics.com/analytics.js",w.parentNode.insertBefore(S,w),ga("create","UA-37740918-2",{cookieDomain:"auto"}),ga("send","pageview");p.a.updateBodyClass();var l=function(e){document.documentElement.addEventListener(e,function(e){r.default.reportEvent(e)},!0)};if(l("keydown"),l("keyup"),l("keypress"),l("MSPointerDown"),l("MSPointerUp"),l("MSPointerHover"),l("MSPointerCancel"),l("mousedown"),l("mouseup"),l("touchstart"),l("touchend"),r.default.tooltip=new Un,r.default.AppCache=new Hn,r.default.localDocChangeRequested=!1,!r.default.isDemoMode()){var d=!1;r.default.settings.registerForChangeNotification(Settings.gdocId,void 0,function(e,t){!r.default.localDocChangeRequested&&e&&e!==t&&(d||(d=!0,r.default.menus.alert({text:"The document was changed in another tab. Please close this tab or reload.",actionText:"RELOAD",callback:r.default.reload})))})}r.default.menus=new On,g.a.listen("remoteDataLoaded",function(){var e=o.a.getURLParam("file"),t=o.a.getURLParam("state");if(e||t){if(!e)try{var i=JSON.parse(t);"open"===i.action&&i.ids&&i.ids.length>=0&&(e=i.ids[0])}catch(e){r.default.reportError(e)}var a=f.default.getDocId();if(e&&a!==e){var n,s,l=function(){r.default.Assert(r.default.vmMain&&r.default.vmMain.vmPicker,"VMMain must be initialized before loading another doc"),r.default.vmMain.vmPicker.requestOpenDocument(e)},d=r.default.decodeURLObject(o.a.getURLParam("sinfo")),u=!1;if(d){var c=r.default.getUserIdentifier();d.fromUser&&(n=d.fromUser,d.fromUser===c&&(u=!0)),d.toUser&&(s=d.toUser,d.toUser===c&&(u=!0))}else u=!0;u?r.default.menus.alert({text:"You have requested to view another document.",actionText:"OPEN IT",callback:l}):s?r.default.menus.alert({text:"You have requested to view another document meant for "+s+".",actionText:"OPEN IT",callback:l}):n&&r.default.menus.alert({text:"You have requested to view another document shared by "+n+".",actionText:"OPEN IT",callback:l})}}});var u=function e(t){var i=p.a.getActualWindowWidth(),a=p.a.getActualWindowHeight();r.default.Assert(0!==i&&!isNaN(i)&&0!==a&&!isNaN(a),"Window size is 0",i,a);var n=p.a.windowWidth(!0),s=p.a.windowHeight(!0);if(p.a.ipad&&!p.a.app&&!0!==t&&!1!==t&&setTimeout(e,0,!0),(i!==n||a!==s)&&(p.a.setWindowSize(i,a),p.a.onResize.notify(),r.default.documentHeight=a,r.default.vmSetup.isLoggedIn())){var o=a-s,l=(p.a.android||p.a.mobileie)&&a>s&&(!p.a.app||o<=p.a.getKBSize())&&r.default.vmMain&&r.default.vmMain.isLoaded;l&&r.default.blurActiveElement(),l&&oe.a.hide(),n!==i&&t&&r.default.focusedPane&&(r.default.focusedPane&&r.default.focusedPane.updatePositionMobile(),r.default.isKeyboardOpen&&r.default.focusedPane.addPadding())}};u(!1),e(),ShouldLog(LogLevels.Timing)&&log("Running main.js: ",log.now()),window.onblur=function(){r.default.hasFocus=!1},window.onfocus=function(){r.default.hasFocus=!0,f.default.onFocusHandler()};new wn;if(r.default.timeline=new xn,p.a.android)window.addEventListener("resize",u);else{window.addEventListener("resize",function(){r.default.animFrameOnce("windowResize",u)})}window.addEventListener("orientationchange",e),window.addEventListener("dragstart",function(e){return e.preventDefault(),!1}),window.addEventListener("dragover",function(e){return e.preventDefault(),!1});var c=!1,h=!1;r.default.vmSetup.loginState.listen(function(e){e===LoginState.LOGGED_IN?(i(),r.default.openMainPage()):e===LoginState.LOGGED_OUT&&(r.default.isSetupPageOpen||(r.default.isSetupPageOpen=!0,o.a.hasURLParam("login","true")||r.default.openSetupPage(),r.default.vmSetup.openLogin())),p.a.offline||!navigator.onLine?r.default.vmMain.setGDriveStatus(DriveStatus.Offline):r.default.vmMain.setGDriveStatus(DriveStatus.Connecting)}),r.default.vmSetup.init(),r.default.isDemoMode()&&i(),r.default.getLoginState()!==LoginState.LOGGED_OUT?s.default.initData(i):!r.default.isDemoMode()&&p.a.app&&r.default.nativeBridge.sendToApp("loaded"),ss.a.render(E.a.createElement(Tr,{main:r.default.vmMain}),document.getElementById("outerWrapper"))}catch(e){console.log(e),r.default.handleCriticalError(),r.default.reportError(e,"Critical Error")}var m,v,_,y,S,w})}]);
